#! /bin/sh

EMBARGO_FILE=embargoed-patches
if ! test -e "$EMBARGO_FILE"; then
    cat
    exit 0
fi

tsdir=$(mktemp -td ${0##*/}.XXXXXX) || exit 1
trap "rm -rf $tsdir" EXIT

sed -r -e 's/(^|[ \t])#.*/\1/' -e '/^$/d' < $EMBARGO_FILE \
| while read line; do
    set -- $line
    date=$1
    while [ $# -gt 2 ]; do
	shift
	date="$date $1"
    done
    patch=$2

    if [ -e "$tsdir/$patch" ]; then
	echo "Patch $patch listed in $EMBARGO_FILE more than once" >&2
	exit 1
    fi

    mkdir -p "$(dirname "$tsdir/$patch")"
    touch --date "$date" "$tsdir/$patch" || exit 1
done

series_conf="$(cat)"

embargoed=$(find $tsdir -type f -printf "%P\n")
if [ -n "$embargoed" ]; then
    echo "$series_conf" | sed -e '/^[^#]/Q'

    IFS=$'\n' lines=( $(echo "$series_conf" | \
			scripts/guards --list))
    for line in "${lines[@]}"; do
	set -- $line
	patch=${!#}
	if [ -e $tsdir/$patch ]; then
	    touch $tsdir/$patch.seen
	    if [ $tsdir/$patch -nt $tsdir ]; then
		echo "Patch $patch is embargoed until" \
		     "$(date -r $tsdir/$patch). Excluding." >&2
		continue
	    else
		echo "Embargoed patch $patch is already public. Including." >&2
	    fi
	fi
	echo "$line"
    done
else
    echo "$series_conf"
fi

for patch in $(find $tsdir -type f -not -name "*.seen" -printf "%P\n"); do
    if [ ! -e "$tsdir/$patch.seen" ]; then
	echo "Patch $patch is listed in $EMBARGO_FILE but not in series.conf" >&2
	exit 1
    fi
done

# vim:softtabstop=4 shiftwidth=4
