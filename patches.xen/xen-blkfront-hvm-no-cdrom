From: K. Y. Srinivasan <ksrinivasan@novell.com>
Subject: In HVM guests do not take over the CDROM device
References: bnc#645893, bnc#688483
Patch-mainline: n/a

Signed-off-by: K. Y. Srinivasan <ksrinivasan@novell.com> 

ohering@novell.com: return -ENXIO instead of 0 when ignoring (bnc#672004)

--- sle10sp4-2010-11-08.orig/drivers/xen/blkfront/blkfront.c	2010-08-10 12:10:17.000000000 +0200
+++ sle10sp4-2010-11-08/drivers/xen/blkfront/blkfront.c	2011-02-22 16:58:42.000000000 +0100
@@ -89,6 +89,26 @@ static int blkfront_probe(struct xenbus_
 	int err, vdevice, i;
 	struct blkfront_info *info;
 
+#ifndef CONFIG_XEN /* For HVM guests, do not take over CDROM devices. */
+	char *type;
+
+	type = xenbus_read(XBT_NIL, dev->nodename, "device-type", NULL);
+	if (IS_ERR(type)) {
+		xenbus_dev_fatal(dev, PTR_ERR(type), "reading dev type");
+		return PTR_ERR(type);
+	}
+	if (!strncmp(type, "cdrom", 5)) {
+		/*
+		 * We are handed a cdrom device in a hvm guest; let the
+		 * native cdrom driver handle this device.
+		 */
+		kfree(type);
+		pr_notice("blkfront: ignoring CDROM %s\n", dev->nodename);
+		return -ENXIO;
+	}
+	kfree(type);
+#endif
+
 	/* FIXME: Use dynamic device id if this is not set. */
 	err = xenbus_scanf(XBT_NIL, dev->nodename,
 			   "virtual-device", "%i", &vdevice);
