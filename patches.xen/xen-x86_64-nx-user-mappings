From: jbeulich@novell.com
Subject: set NX bit in kernel version of top level user mode page table entries
Patch-mainline: n/a

.., making arbitrary-code-execution exploits more difficult.

--- head-2009-12-07.orig/arch/x86/include/mach-xen/asm/pgtable.h	2009-11-20 11:18:13.000000000 +0100
+++ head-2009-12-07/arch/x86/include/mach-xen/asm/pgtable.h	2009-11-20 11:20:32.000000000 +0100
@@ -481,7 +481,7 @@ static inline pud_t *pud_offset(pgd_t *p
 
 static inline int pgd_bad(pgd_t pgd)
 {
-	return (pgd_flags(pgd) & ~_PAGE_USER) != _KERNPG_TABLE;
+	return (pgd_flags(pgd) & ~(_PAGE_USER|_PAGE_NX)) != _KERNPG_TABLE;
 }
 
 static inline int pgd_none(pgd_t pgd)
--- head-2009-12-07.orig/arch/x86/mm/hypervisor.c	2009-12-04 12:11:43.000000000 +0100
+++ head-2009-12-07/arch/x86/mm/hypervisor.c	2009-12-11 15:28:58.000000000 +0100
@@ -526,6 +526,8 @@ void xen_l4_entry_update(pgd_t *ptr, pgd
 	u[0].val = __pgd_val(val);
 	if (((unsigned long)ptr & ~PAGE_MASK)
 	    <= pgd_index(TASK_SIZE_MAX) * sizeof(*ptr)) {
+		if (!pgd_none(val))
+			u[0].val |= _PAGE_NX & __supported_pte_mask;
 		ptr = __user_pgd(ptr);
 		BUG_ON(!ptr);
 		u[1].ptr = virt_to_machine(ptr);
