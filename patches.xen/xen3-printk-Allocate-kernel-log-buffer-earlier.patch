From: Mike Travis <travis@sgi.com>
Subject: printk: Allocate kernel log buffer earlier v1
Patch-mainline: Not yet
References: bnc#700445

On larger systems, because of the numerous ACPI, Bootmem and EFI
messages, the static log buffer overflows before the larger one
specified by the log_buf_len param is allocated.  Minimize the
overflow by allocating the new log buffer as soon as possible.

All arch's are covered by the "setup_log_buf" in start_kernel().
The x86 arch allocates it right after bootmem is created.

Signed-off-by: Mike Travis <travis@sgi.com>
Reviewed-by: Jack Steiner <steiner@sgi.com>
Reviewed-by: Robin Holt <holt@sgi.com>
Signed-off-by: Rafael J. Wysocki <rjw@suse.de>
Automatically created from "patches.arch/printk-Allocate-kernel-log-buffer-earlier.patch" by xen-port-patches.py

--- sle11sp2-2011-06-20.orig/arch/x86/kernel/setup-xen.c	2010-08-06 17:06:51.000000000 +0200
+++ sle11sp2-2011-06-20/arch/x86/kernel/setup-xen.c	2011-06-20 10:48:14.000000000 +0200
@@ -340,6 +340,20 @@ static void __init reserve_brk(void)
 	_brk_start = 0;
 }
 
+static unsigned long __init reserve_log_buf(unsigned long len)
+{
+	unsigned long end_of_lowmem = max_low_pfn_mapped << PAGE_SHIFT;
+	unsigned long addr = end_of_lowmem - len;
+	unsigned long mem;
+
+	mem = find_e820_area(addr, end_of_lowmem, len, PAGE_SIZE);
+	if (mem == -1UL)
+		return 0UL;
+
+	reserve_early(mem, mem + len, "LOG BUF");
+	return mem;
+}
+
 #ifdef CONFIG_BLK_DEV_INITRD
 
 #define MAX_MAP_CHUNK	(NR_FIX_BTMAPS << PAGE_SHIFT)
@@ -1067,6 +1081,8 @@ void __init setup_arch(char **cmdline_p)
 	if (init_ohci1394_dma_early)
 		init_ohci1394_dma_on_all_controllers();
 #endif
+	/* Allocate bigger log buffer as early as possible */
+	setup_log_buf(reserve_log_buf);
 
 	reserve_initrd();
 
