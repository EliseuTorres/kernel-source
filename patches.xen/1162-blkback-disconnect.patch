From http://xenbits.xen.org/hg/linux-2.6.18-xen.hg/rev/4c2b7dcbfd8b
From: xen-devel@lists.xen.org
Patch-mainline: n/a
Subject: blkback: also call blkif_disconnect() when frontend switched to closed

blkfront doesn't normally set its state to XenbusStateClosing, yet
blkback should not hang on to resources when there's no connection. As
frontend_changed() already makes use of blkif_disconnect() being
idempotent, we're fine to utilize this here too.

Signed-off-by: Jan Beulich <jbeulich@suse.com>

--- sle11sp2.orig/drivers/xen/blkback/xenbus.c	2012-03-19 11:24:18.000000000 +0100
+++ sle11sp2/drivers/xen/blkback/xenbus.c	2012-03-19 11:28:02.000000000 +0100
@@ -392,13 +392,11 @@ static void frontend_changed(struct xenb
 		break;
 
 	case XenbusStateClosing:
-		blkif_disconnect(be->blkif);
-		xenbus_switch_state(dev, XenbusStateClosing);
-		break;
-
 	case XenbusStateClosed:
-		xenbus_switch_state(dev, XenbusStateClosed);
-		if (xenbus_dev_is_online(dev))
+		blkif_disconnect(be->blkif);
+		xenbus_switch_state(dev, frontend_state);
+		if (frontend_state != XenbusStateClosed ||
+		    xenbus_dev_is_online(dev))
 			break;
 		/* fall through if not online */
 	case XenbusStateUnknown:
