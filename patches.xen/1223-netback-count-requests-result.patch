From http://xenbits.xen.org/hg/linux-2.6.18-xen.hg/rev/a56b12b91c25
From: xen-devel@lists.xen.org
Patch-mainline: n/a
Subject: netback: fix netbk_count_requests()

There are two paths in the original code, a) test against work_to_do, b) test
against first->size, could return 0 even when error happens.

Simply return -1 in error paths should work. Modify all error paths to return
-1 to be consistent.

Reported-by: Christopher S. Aker <caker@theshore.net>
Signed-off-by: Wei Liu <wei.liu2@citrix.com>

Use distinct -E... values instead.

Signed-off-by: Jan Beulich <jbeulich@suse.com>
Acked-by: Ian Campbell <ian.campbell@citrix.com>
Committed-by: Jan Beulich <jbeulich@suse.com>

--- sle11sp2.orig/drivers/xen/netback/netback.c	2013-01-24 12:10:21.000000000 +0100
+++ sle11sp2/drivers/xen/netback/netback.c	2013-02-18 09:53:25.000000000 +0100
@@ -1052,14 +1052,14 @@ static int netbk_count_requests(netif_t 
 			printk(KERN_ERR "%s: Need more frags\n",
 			       netif->dev->name);
 			netbk_fatal_tx_err(netif);
-			return -frags;
+			return -ENODATA;
 		}
 
 		if (unlikely(frags >= MAX_SKB_FRAGS)) {
 			printk(KERN_ERR "%s: Too many frags\n",
 			       netif->dev->name);
 			netbk_fatal_tx_err(netif);
-			return -frags;
+			return -E2BIG;
 		}
 
 		memcpy(txp, RING_GET_REQUEST(&netif->tx, cons + frags),
@@ -1068,7 +1068,7 @@ static int netbk_count_requests(netif_t 
 			printk(KERN_ERR "%s: Frag is bigger than frame.\n",
 			       netif->dev->name);
 			netbk_fatal_tx_err(netif);
-			return -frags;
+			return -EIO;
 		}
 
 		first->size -= txp->size;
@@ -1078,7 +1078,7 @@ static int netbk_count_requests(netif_t 
 			printk(KERN_ERR "%s: txp->offset: %x, size: %u\n",
 			       netif->dev->name, txp->offset, txp->size);
 			netbk_fatal_tx_err(netif);
-			return -frags;
+			return -EINVAL;
 		}
 	} while ((txp++)->flags & NETTXF_more_data);
 
