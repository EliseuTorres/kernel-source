From: Thomas Renninger <trenn@suse.de>
Subject: xen ioremap: Adjust unxlate_dev_mem_ptr
Patch-Mainline: no
References: FATE#310031

Signed-off-by: Thomas Renninger <trenn@suse.de>

The function was changed by this commit:
xlate_dev_mem_ptr-use-phys_addr_t.patch


---
 arch/x86/include/mach-xen/asm/io.h |    2 +-
 arch/x86/mm/ioremap-xen.c          |    9 +++++++--
 2 files changed, 8 insertions(+), 3 deletions(-)

Index: linux-2.6.32-SLE11-SP2/arch/x86/mm/ioremap-xen.c
===================================================================
--- linux-2.6.32-SLE11-SP2.orig/arch/x86/mm/ioremap-xen.c
+++ linux-2.6.32-SLE11-SP2/arch/x86/mm/ioremap-xen.c
@@ -546,10 +546,15 @@ void *xlate_dev_mem_ptr(unsigned long ph
 	return addr;
 }
 
-void unxlate_dev_mem_ptr(unsigned long phys, void *addr)
+void unxlate_dev_mem_ptr(phys_addr_t phys, void *addr)
 {
-	if (page_is_ram(phys >> PAGE_SHIFT))
+	unsigned long pfn = phys >> PAGE_SHIFT;
+
+	if (page_is_ram(pfn)) {
+		if (phys >= __pa(high_memory))
+			kunmap(pfn_to_page(pfn));
 		return;
+	}
 
 	iounmap((void __iomem *)((unsigned long)addr & PAGE_MASK));
 	return;
Index: linux-2.6.32-SLE11-SP2/arch/x86/include/mach-xen/asm/io.h
===================================================================
--- linux-2.6.32-SLE11-SP2.orig/arch/x86/include/mach-xen/asm/io.h
+++ linux-2.6.32-SLE11-SP2/arch/x86/include/mach-xen/asm/io.h
@@ -206,7 +206,7 @@ extern void set_iounmap_nonlazy(void);
 #endif
 
 extern void *xlate_dev_mem_ptr(unsigned long phys);
-extern void unxlate_dev_mem_ptr(unsigned long phys, void *addr);
+extern void unxlate_dev_mem_ptr(phys_addr_t phys, void *addr);
 
 extern int ioremap_check_change_attr(unsigned long mfn, unsigned long size,
 				     unsigned long prot_val);
