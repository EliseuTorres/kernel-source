From http://xenbits.xen.org/hg/linux-2.6.18-xen.hg/rev/52cb9a45cf3d
From: xen-devel@lists.xenproject.org
Patch-mainline: n/a
Subject: pciback: fix memory leak in __xen_pcibk_add_pci_dev()

It needs to free dev_entry when it failed to assign to a new slot on
the virtual PCI bus.

smatch says:
 drivers/xen/xen-pciback/vpci.c:142 __xen_pcibk_add_pci_dev() warn:
possible memory leak of 'dev_entry'

Signed-off-by: Daeseok Youn <daeseok.youn@gmail.com>

Moved kfree() invocation out of locked region.

Signed-off-by: Jan Beulich <jbeulich@suse.com>
Committed-by: Jan Beulich <jbeulich@suse.com>

--- sle11sp3.orig/drivers/xen/pciback/vpci.c	2014-04-03 14:53:23.000000000 +0200
+++ sle11sp3/drivers/xen/pciback/vpci.c	2014-04-03 14:53:53.000000000 +0200
@@ -134,9 +134,11 @@ int pciback_add_pci_dev(struct pciback_d
       unlock:
 	spin_unlock_irqrestore(&vpci_dev->lock, flags);
 
-	/* Publish this device. */
-	if(!err)
+	if (!err) {
+		/* Publish this device. */
 		err = publish_cb(pdev, 0, 0, PCI_DEVFN(slot, func), devid);
+	} else
+		kfree(dev_entry);
 
       out:
 	return err;
