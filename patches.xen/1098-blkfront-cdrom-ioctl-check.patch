From: http://xenbits.xen.org/hg/linux-2.6.18-xen.hg/rev/73e47d0fdb10
# HG changeset patch
# User Jan Beulich <jbeulich@novell.com>
# Date 1310127827 -3600
# Node ID 73e47d0fdb100e92233ee9142964c54fa2084795
# Parent  d1a48f331c67d2667c91bc24f314abbdaba40e72
Subject: blkfront: avoid NULL de-reference in CDROM ioctl handling
References: bnc#701355
Patch-mainline: n/a

Just like already done in the default case, for CDROM_GET_CAPABILITY
info->gd should not be blindly de-referenced, as the ioctl can be
called prior to full device setup having completed.

Signed-off-by: Jan Beulich <jbeulich@novell.com>

--- sle11sp1-2011-07-18.orig/drivers/xen/blkfront/blkfront.c	2011-05-20 13:45:03.000000000 +0200
+++ sle11sp1-2011-07-18/drivers/xen/blkfront/blkfront.c	2011-07-18 11:03:23.000000000 +0200
@@ -567,12 +567,11 @@ int blkif_ioctl(struct inode *inode, str
 				return -EFAULT;
 		return 0;
 
-	case CDROM_GET_CAPABILITY: {
-		struct gendisk *gd = info->gd;
-		if (gd->flags & GENHD_FL_CD)
+	case CDROM_GET_CAPABILITY:
+		if (info->gd && (info->gd->flags & GENHD_FL_CD))
 			return 0;
 		return -EINVAL;
-	}
+
 	default:
 		if (info->mi && info->gd) {
 			switch (info->mi->major) {
