From: jbeulich@suse.com
Subject: add symbols to hypercall stubs
Patch-mainline: Never, SUSE-Xen specific

--- a/arch/x86/syscalls/Makefile
+++ b/arch/x86/syscalls/Makefile
@@ -19,6 +19,9 @@ quiet_cmd_syshdr = SYSHDR  $@
 quiet_cmd_systbl = SYSTBL  $@
       cmd_systbl = $(CONFIG_SHELL) '$(systbl)' $< $@
 
+quiet_cmd_hypercalls = HYPERCALLS $@
+      cmd_hypercalls = $(CONFIG_SHELL) '$<' $@ $(filter-out $<,$^)
+
 syshdr_abi_unistd_32 := i386
 $(uapi)/unistd_32.h: $(syscall32) $(syshdr)
 	$(call if_changed,syshdr)
@@ -47,10 +50,17 @@ $(out)/syscalls_32.h: $(syscall32) $(sys
 $(out)/syscalls_64.h: $(syscall64) $(systbl)
 	$(call if_changed,systbl)
 
+$(out)/%-hypercalls.h: $(srctree)/scripts/%-hypercalls.sh
+	$(call if_changed,hypercalls)
+
+$(out)/xen-hypercalls.h: $(srctree)/include/xen/interface/xen.h
+$(out)/xen-hypercalls.h: $(srctree)/include/xen/interface/arch-$(SRCARCH)/xen*.h
+
 uapisyshdr-y			+= unistd_32.h unistd_64.h unistd_x32.h
 syshdr-y			+= syscalls_32.h
 syshdr-$(CONFIG_X86_64)		+= unistd_32_ia32.h unistd_64_x32.h
 syshdr-$(CONFIG_X86_64)		+= syscalls_64.h
+syshdr-$(CONFIG_XEN)		+= xen-hypercalls.h
 
 targets	+= $(uapisyshdr-y) $(syshdr-y)
 
--- a/arch/x86/kernel/head_64-xen.S
+++ b/arch/x86/kernel/head_64-xen.S
@@ -22,6 +22,7 @@
 #include <asm/dwarf2.h>
 #include <asm/percpu.h>
 #include <xen/interface/xen.h>
+#include <xen/interface/arch-x86/xen-mca.h>
 #include <xen/interface/elfnote.h>
 #include <xen/interface/features.h>
 
@@ -83,9 +84,15 @@ NEXT_PAGE(level2_fixmap_pgt)
 NEXT_PAGE(level1_fixmap_pgt)
 	.fill	512,8,0
 
+#if CONFIG_XEN_COMPAT <= 0x030002
 	.previous
+#else
+	.text
+#endif
 NEXT_PAGE(hypercall_page)
+#if CONFIG_XEN_COMPAT <= 0x030002
 	phys_hypercall_page = . - .head.text
+#endif
 	CFI_STARTPROC
 	i = 0
 	.rept 0x1000 / 0x20
@@ -120,6 +127,12 @@ NEXT_PAGE(hypercall_page)
 	.endr
 	CFI_ENDPROC
 
+#define HYPERCALL(n) \
+	.equ HYPERVISOR_##n, hypercall_page + __HYPERVISOR_##n * 32; \
+	.type HYPERVISOR_##n, function; .size HYPERVISOR_##n, 32
+#include <asm/xen-hypercalls.h>
+#undef HYPERCALL
+
 	__PAGE_ALIGNED_BSS
 NEXT_PAGE(empty_zero_page)
 	.skip PAGE_SIZE
--- /dev/null
+++ b/scripts/xen-hypercalls.sh
@@ -0,0 +1,9 @@
+#!/bin/sh
+out="$1"
+shift
+in="$@"
+
+for i in $in; do
+	eval $CPP -dD -imacros "$i" -x c /dev/null
+done | sed -n 's,#define __HYPERVISOR_\([a-z0-9_]*\)[[:space:]]\+\(__HYPERVISOR_arch_\)\?[0-9].*,HYPERCALL(\1),p' \
+     | grep -v '(arch_[0-9]\+)' | sort | uniq >$out
