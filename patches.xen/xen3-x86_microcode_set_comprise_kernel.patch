From: Thomas Renninger <trenn@suse.de>
Subject: Do not allow access to /dev/cpu/microcode in secure boot mode
References: bnc#813166
Patch-Mainline: no

Automatically created from "patches.suse/x86_microcode_set_comprise_kernel.patch" by xen-port-patches.py

--- sle11sp3.orig/arch/x86/kernel/microcode_core-xen.c	2012-02-28 10:55:26.000000000 +0100
+++ sle11sp3/arch/x86/kernel/microcode_core-xen.c	2013-04-15 14:29:54.000000000 +0200
@@ -90,7 +90,8 @@ static int do_microcode_update(const voi
 
 static int microcode_open(struct inode *inode, struct file *file)
 {
-	return capable(CAP_SYS_RAWIO) ? nonseekable_open(inode, file) : -EPERM;
+	return (capable(CAP_SYS_RAWIO) && capable(CAP_COMPROMISE_KERNEL))
+		? nonseekable_open(inode, file) : -EPERM;
 }
 
 static ssize_t microcode_write(struct file *file, const char __user *buf,
