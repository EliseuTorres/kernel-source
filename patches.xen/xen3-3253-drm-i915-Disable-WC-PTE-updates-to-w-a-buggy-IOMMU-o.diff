From da88a5f7f7d434e2cde1b3e19d952e6d84533662 Mon Sep 17 00:00:00 2001
From: Chris Wilson <chris@chris-wilson.co.uk>
Date: Wed, 13 Feb 2013 09:31:53 +0000
Subject: [PATCH] drm/i915: Disable WC PTE updates to w/a buggy IOMMU on ILK
Patch-mainline: 3.9-rc1
References: bnc#806406

Whilst IOMMU is enabled for the Intel GPU on Ironlake, it appears that
using WC writes to update the PTE on the GPU fails miserably. The
result looks like the majority of the writes do not land leading to
lots of screen corruption and a hard system hang.

V2: s/</<=/ to preserve the current exclusion of Sandybridge

Reported-by: Nathan Myers <ncm@cantrip.org>
Bugzilla: https://bugzilla.freedesktop.org/show_bug.cgi?id=60391
Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
Tested-by: Nathan Myers <ncm@cantrip.org>
[danvet: Remove cc: stable and add tested-by.]
Signed-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
Acked-by: Takashi Iwai <tiwai@suse.de>

Automatically created from "patches.drm/3253-drm-i915-Disable-WC-PTE-updates-to-w-a-buggy-IOMMU-o.diff" by xen-port-patches.py

--- sle11sp3.orig/drivers/char/agp/intel-gtt.c	2013-05-17 13:56:28.000000000 +0200
+++ sle11sp3/drivers/char/agp/intel-gtt.c	2013-05-17 13:56:57.000000000 +0200
@@ -587,7 +587,7 @@ static void intel_gtt_cleanup(void)
  */
 static inline int needs_ilk_vtd_wa(void)
 {
-#ifdef CONFIG_DMAR
+#if defined(CONFIG_DMAR) || defined(CONFIG_XEN)
 	const unsigned short gpu_devid = intel_private.pcidev->device;
 
 	/* Query intel_iommu to see if we need the workaround. Presumably that
