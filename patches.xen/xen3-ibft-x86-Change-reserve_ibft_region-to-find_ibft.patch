From: Yinghai Lu <yinghai@kernel.org>
Date: Thu, 1 Apr 2010 14:32:43 -0700
Subject: [PATCH] ibft, x86: Change reserve_ibft_region() to find_ibft_region()
Git-commit: 042be38e6106ed70b42d096ab4a1ed4187e510e6
References: FATE#311488
Patch-Mainline: 2.6.36

This allows arch code could decide the way to reserve the ibft.

And we should reserve ibft as early as possible, instead of BOOTMEM
stage, in case the table is in RAM range and is not reserved by BIOS
(this will often be the case.)

Move to just after find_smp_config().

Also when CONFIG_NO_BOOTMEM=y, We will not have reserve_bootmem() anymore.

-v2: fix typo about ibft pointed by Konrad Rzeszutek Wilk <konrad@darnok.org>

Signed-off-by: Yinghai Lu <yinghai@kernel.org>
LKML-Reference: <4BB510FB.80601@kernel.org>
Cc: Pekka Enberg <penberg@cs.helsinki.fi>
Cc: Peter Jones <pjones@redhat.com>
Cc: Konrad Rzeszutek Wilk <konrad@kernel.org>
CC: Jan Beulich <jbeulich@novell.com>
Signed-off-by: H. Peter Anvin <hpa@zytor.com>
Signed-off-by: Hannes Reinecke <hare@suse.de>
Automatically created from "patches.suse/ibft-x86-Change-reserve_ibft_region-to-find_ibft.patch" by xen-port-patches.py

--- sle11sp2-2011-06-14.orig/arch/x86/kernel/setup-xen.c	2010-08-06 17:06:51.000000000 +0200
+++ sle11sp2-2011-06-14/arch/x86/kernel/setup-xen.c	2011-06-14 14:03:13.000000000 +0200
@@ -698,6 +698,18 @@ static int __init setup_elfcorehdr(char 
 early_param("elfcorehdr", setup_elfcorehdr);
 #endif
 
+static __init void reserve_ibft_region(void)
+{
+	unsigned long addr, size = 0;
+
+	addr = find_ibft_region(&size);
+
+#ifndef CONFIG_XEN
+	if (size)
+		reserve_early_overlap_ok(addr, addr + size, "ibft");
+#endif
+}
+
 #ifdef CONFIG_X86_RESERVE_LOW_64K
 static int __init dmi_low_memory_corruption(const struct dmi_system_id *d)
 {
@@ -1044,6 +1056,8 @@ void __init setup_arch(char **cmdline_p)
 
 	reserve_brk();
 
+	reserve_ibft_region();
+
 	init_gbpages();
 
 	/* max_pfn_mapped is updated here */
@@ -1121,8 +1135,6 @@ void __init setup_arch(char **cmdline_p)
 	dma32_reserve_bootmem();
 #endif
 
-	reserve_ibft_region();
-
 #ifdef CONFIG_KVM_CLOCK
 	kvmclock_init();
 #endif

