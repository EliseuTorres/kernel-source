From: Jiri Slaby <jslaby@suse.cz>
Subject: Linux 2.6.32.25
Patch-mainline: 2.6.32.25

Signed-off-by: Jiri Slaby <jslaby@suse.cz>
Automatically created from "patches.kernel.org/patch-2.6.32.24-25" by xen-port-patches.py

--- sle11sp2-2011-05-25.orig/arch/x86/kernel/apic/io_apic-xen.c	2011-05-05 15:53:05.000000000 +0200
+++ sle11sp2-2011-05-25/arch/x86/kernel/apic/io_apic-xen.c	2011-05-05 15:53:55.000000000 +0200
@@ -342,14 +342,19 @@ void arch_init_copy_chip_data(struct irq
 
 	old_cfg = old_desc->chip_data;
 
-	memcpy(cfg, old_cfg, sizeof(struct irq_cfg));
+	cfg->vector = old_cfg->vector;
+	cfg->move_in_progress = old_cfg->move_in_progress;
+	cpumask_copy(cfg->domain, old_cfg->domain);
+	cpumask_copy(cfg->old_domain, old_cfg->old_domain);
 
 	init_copy_irq_2_pin(old_cfg, cfg, node);
 }
 
-static void free_irq_cfg(struct irq_cfg *old_cfg)
+static void free_irq_cfg(struct irq_cfg *cfg)
 {
-	kfree(old_cfg);
+	free_cpumask_var(cfg->domain);
+	free_cpumask_var(cfg->old_domain);
+	kfree(cfg);
 }
 
 void arch_free_chip_data(struct irq_desc *old_desc, struct irq_desc *desc)
--- sle11sp2-2011-05-25.orig/arch/x86/kernel/cpu/common-xen.c	2011-05-25 15:43:29.000000000 +0200
+++ sle11sp2-2011-05-25/arch/x86/kernel/cpu/common-xen.c	2011-05-25 15:44:18.000000000 +0200
@@ -571,7 +571,7 @@ void __cpuinit cpu_detect(struct cpuinfo
 	}
 }
 
-static void __cpuinit get_cpu_cap(struct cpuinfo_x86 *c)
+void __cpuinit get_cpu_cap(struct cpuinfo_x86 *c)
 {
 	u32 tfms, xlvl;
 	u32 ebx;
@@ -610,6 +610,7 @@ static void __cpuinit get_cpu_cap(struct
 	if (c->extended_cpuid_level >= 0x80000007)
 		c->x86_power = cpuid_edx(0x80000007);
 
+	init_scattered_cpuid_features(c);
 }
 
 static void __cpuinit identify_cpu_without_cpuid(struct cpuinfo_x86 *c)
@@ -764,7 +765,6 @@ static void __cpuinit generic_identify(s
 
 	get_model_name(c); /* Default name */
 
-	init_scattered_cpuid_features(c);
 	detect_nopl(c);
 }
 
