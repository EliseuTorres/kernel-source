From: Petr Tesarik <ptesarik@suse.cz>
Subject: Return EOF on out-of-bounds read from /dev/mem
Patch-Mainline: no
References: FATE#310031

The off parameter (type loff_t) may specify an offset that cannot
be represented by a long. Currently, /dev/mem wraps around, which
may to cause applications to read/write incorrect regions of memory
by accident.

Follow the usual file semantics here and return 0 when reading or
-EFBIG when writing beyond the accessible range.

Signed-off-by: Petr Tesarik <ptesarik@suse.cz>
Automatically created from "patches.fixes/dev_mem-read-write-beyond-EOF.patch" by xen-port-patches.py

--- sle11sp2-2011-06-20.orig/drivers/xen/char/mem.c	2009-11-06 10:52:02.000000000 +0100
+++ sle11sp2-2011-06-20/drivers/xen/char/mem.c	2011-06-20 11:05:34.000000000 +0200
@@ -65,6 +65,9 @@ static ssize_t read_mem(struct file * fi
 	ssize_t read = 0, sz;
 	void __iomem *v;
 
+	if (p != *ppos)
+		return 0;
+
 	while (count > 0) {
 		/*
 		 * Handle first page in case it's not aligned
@@ -116,6 +119,9 @@ static ssize_t write_mem(struct file * f
 	ssize_t written = 0, sz;
 	void __iomem *v;
 
+	if (p != *ppos)
+		return -EFBIG;
+
 	while (count > 0) {
 		/*
 		 * Handle first page in case it's not aligned
