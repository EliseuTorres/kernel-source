From: Petr Tesarik <ptesarik@suse.cz>
Subject: Return EOF on out-of-bounds read from /dev/mem
Patch-Mainline: no
References: FATE#310031

The off parameter (type loff_t) may specify an offset that cannot
be represented by a long. Currently, /dev/mem wraps around, which
may to cause applications to read/write incorrect regions of memory
by accident.

Follow the usual file semantics here and return 0 when reading or
-EFBIG when writing beyond the accessible range.

Signed-off-by: Petr Tesarik <ptesarik@suse.cz>
Automatically created from "patches.fixes/dev_mem-read-write-beyond-EOF.patch" by xen-port-patches.py

--- sle11sp3.orig/drivers/xen/char/mem.c	2012-10-19 08:39:29.000000000 +0200
+++ sle11sp3/drivers/xen/char/mem.c	2012-10-19 14:06:35.000000000 +0200
@@ -67,6 +67,9 @@ static ssize_t read_mem(struct file *fil
 	ssize_t read = 0, sz;
 	void __iomem *v;
 
+	if (p != *ppos)
+		return 0;
+
 	while (count > 0) {
 		unsigned long remaining;
 
@@ -113,6 +116,9 @@ static ssize_t write_mem(struct file *fi
 	ssize_t written = 0, sz;
 	void __iomem *v;
 
+	if (p != *ppos)
+		return -EFBIG;
+
 	while (count > 0) {
 		sz = size_inside_page(p, count);
 
