From: http://xenbits.xensource.com/linux-2.6.18-xen.hg?rev/2994d2997f9d
# HG changeset patch
# User Jan Beulich <jbeulich@novell.com>
# Date 1297346342 0
# Node ID 2994d2997f9d035092f6cc3544ebe66d797b983a
# Parent  1128f2a18acfd4e8d0a7aad38afd107894399822
Subject: pciback: disable MSI/MSI-X when resetting device
References: bnc#670615
Patch-mainline: n/a

In cases where the guest is abruptly killed and has not disabled
MSI/MSI-X interrupts we want to do that.

Otherwise when the guest is started up and enables MSI, we would
get a WARN() that the device already had been enabled.

Signed-off-by: Jan Beulich <jbeulich@novell.com>

--- sle11sp1-2011-02-25.orig/drivers/xen/pciback/pciback_ops.c	2011-02-25 11:22:26.000000000 +0100
+++ sle11sp1-2011-02-25/drivers/xen/pciback/pciback_ops.c	2011-02-18 12:57:14.000000000 +0100
@@ -22,6 +22,14 @@ void pciback_reset_device(struct pci_dev
 
 	/* Disable devices (but not bridges) */
 	if (dev->hdr_type == PCI_HEADER_TYPE_NORMAL) {
+#ifdef CONFIG_PCI_MSI
+		/* The guest could have been abruptly killed without
+		 * disabling MSI/MSI-X interrupts.*/
+		if (dev->msix_enabled)
+			pci_disable_msix(dev);
+		if (dev->msi_enabled)
+			pci_disable_msi(dev);
+#endif
 		pci_disable_device(dev);
 
 		pci_write_config_word(dev, PCI_COMMAND, 0);
