Subject: x86: report ACPI-reserved state of PCI MMCONFIG region to hypervisor
From: jbeulich@novell.com
Patch-mainline: n/a

To be merged into xen3-patch-2.6.27.

--- sle11sp2-2011-08-08.orig/include/xen/interface/physdev.h	2011-05-04 10:01:11.000000000 +0200
+++ sle11sp2-2011-08-08/include/xen/interface/physdev.h	2011-08-08 14:20:44.000000000 +0200
@@ -255,6 +255,19 @@ struct physdev_get_free_pirq {
 typedef struct physdev_get_free_pirq physdev_get_free_pirq_t;
 DEFINE_XEN_GUEST_HANDLE(physdev_get_free_pirq_t);
 
+#define XEN_PCI_MMCFG_RESERVED         0x1
+
+#define PHYSDEVOP_pci_mmcfg_reserved    24
+struct physdev_pci_mmcfg_reserved {
+    uint64_t address;
+    uint16_t segment;
+    uint8_t start_bus;
+    uint8_t end_bus;
+    uint32_t flags;
+};
+typedef struct physdev_pci_mmcfg_reserved physdev_pci_mmcfg_reserved_t;
+DEFINE_XEN_GUEST_HANDLE(physdev_pci_mmcfg_reserved_t);
+
 /*
  * Notify that some PIRQ-bound event channels have been unmasked.
  * ** This command is obsolete since interface version 0x00030202 and is **
--- sle11sp2-2011-08-08.orig/arch/x86/pci/mmconfig-shared.c	2011-06-20 09:46:49.000000000 +0200
+++ sle11sp2-2011-08-08/arch/x86/pci/mmconfig-shared.c	2011-08-08 14:20:55.000000000 +0200
@@ -20,6 +20,10 @@
 #include <asm/pci_x86.h>
 #include <asm/acpi.h>
 
+#ifdef CONFIG_XEN
+#include <xen/interface/physdev.h>
+#endif
+
 #define PREFIX "PCI: "
 
 /* aperture is up to 256MB but BIOS may reserve less */
@@ -466,6 +470,31 @@ static int __init is_mmconf_reserved(che
 		}
 	}
 
+#ifdef CONFIG_XEN
+	if (!with_e820)	{
+		struct physdev_pci_mmcfg_reserved r = {
+			.address = cfg->address,
+			.segment = cfg->pci_segment,
+			.start_bus = cfg->start_bus_number,
+			.end_bus = cfg->end_bus_number,
+			.flags = valid ? XEN_PCI_MMCFG_RESERVED : 0
+		};
+		int rc;
+
+		rc = HYPERVISOR_physdev_op(PHYSDEVOP_pci_mmcfg_reserved, &r);
+		switch (rc) {
+		case 0: case -ENOSYS:
+			break;
+		default:
+			pr_warn(PREFIX "Failed to report MMCONFIG reservation"
+				" state for %04x [bus%02x-%02x] to hypervisor"
+				" (%d)\n",
+				cfg->pci_segment, cfg->start_bus_number,
+				cfg->end_bus_number, rc);
+		}
+	}
+#endif
+
 	return valid;
 }
 
