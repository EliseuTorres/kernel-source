From: Mel Gorman <mgorman@suse.de>
Date: Wed, 18 May 2011 13:59:05 +0100
Subject: [PATCH] mm: introduce free_pages_prepare()
References: Page allocator enhancements suitable for THP(fate #311931)
Git-commit: ec95f53aa6ed62ba68660cb19c8474ebe9025cce
Patch.name: patches.suse/mm-pagealloc-free_pages_prepare.patch
Patch-mainline: v2.6.35-rc1

free_hot_cold_page() and __free_pages_ok() have very similar freeing
preparation.  Consolidate them.

[akpm@linux-foundation.org: fix busted coding style]
Signed-off-by: KOSAKI Motohiro <kosaki.motohiro@jp.fujitsu.com>
Acked-by: Mel Gorman <mgorman@suse.de>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Mel Gorman <mgorman@suse.de>

Automatically created from "patches.suse/mm-pagealloc-free_pages_prepare.patch" by xen-port-patches.py

 mm/page_alloc.c |    9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

--- sle11sp2-2011-05-31.orig/mm/page_alloc.c	2011-05-31 10:51:18.000000000 +0200
+++ sle11sp2-2011-05-31/mm/page_alloc.c	2011-05-31 11:18:34.000000000 +0200
@@ -651,9 +651,8 @@ static bool free_pages_prepare(struct pa
 
 #ifdef CONFIG_XEN
 	if (PageForeign(page)) {
-		WARN_ON(wasMlocked);
 		PageForeignDestructor(page, order);
-		return;
+		return false;
 	}
 #endif
 
@@ -683,6 +682,9 @@ static void __free_pages_ok(struct page 
 	unsigned long flags;
 	int wasMlocked = __TestClearPageMlocked(page);
 
+#ifdef CONFIG_XEN
+	WARN_ON(PageForeign(page) && wasMlocked);
+#endif
 	if (!free_pages_prepare(page, order))
 		return;
 
@@ -1173,6 +1175,9 @@ void free_hot_cold_page(struct page *pag
 	int migratetype;
 	int wasMlocked = __TestClearPageMlocked(page);
 
+#ifdef CONFIG_XEN
+	WARN_ON(PageForeign(page) && wasMlocked);
+#endif
 	if (!free_pages_prepare(page, 0))
 		return;
 

