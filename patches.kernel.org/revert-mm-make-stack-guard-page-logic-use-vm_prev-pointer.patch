From e75d1d106513b54f9ddb46207e2264146f227943 Mon Sep 17 00:00:00 2001
From: Jiri Slaby <jslaby@suse.cz>
Date: Mon, 27 Sep 2010 23:59:03 +0200
Subject: Revert "mm: make stack guard page logic use vm_prev pointer"

This reverts commit 42fd8fdce2d33d0d84ce850b4d63a2385b8d889a.

Signed-off-by: Jiri Slaby <jslaby@suse.cz>
---
 mm/memory.c |   15 ++++-----------
 1 files changed, 4 insertions(+), 11 deletions(-)

diff --git a/mm/memory.c b/mm/memory.c
index 194dc17..babb991 100644
--- a/mm/memory.c
+++ b/mm/memory.c
@@ -2640,18 +2640,11 @@ static inline int check_stack_guard_page(struct vm_area_struct *vma, unsigned lo
 {
 	address &= PAGE_MASK;
 	if ((vma->vm_flags & VM_GROWSDOWN) && address == vma->vm_start) {
-		struct vm_area_struct *prev = vma->vm_prev;
-
-		/*
-		 * Is there a mapping abutting this one below?
-		 *
-		 * That's only ok if it's the same stack mapping
-		 * that has gotten split..
-		 */
-		if (prev && prev->vm_end == address)
-			return prev->vm_flags & VM_GROWSDOWN ? 0 : -ENOMEM;
+		address -= PAGE_SIZE;
+		if (find_vma(vma->vm_mm, address) != vma)
+			return -ENOMEM;
 
-		expand_stack(vma, address - PAGE_SIZE);
+		expand_stack(vma, address);
 	}
 	return 0;
 }
-- 
1.7.2.2

