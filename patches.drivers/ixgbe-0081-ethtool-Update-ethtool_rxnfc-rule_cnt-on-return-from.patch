From: Ben Hutchings <bhutchings@solarflare.com>
Date: Tue, 6 Sep 2011 13:52:47 +0000
Subject: ethtool: Update ethtool_rxnfc::rule_cnt on return from
 ETHTOOL_GRXCLSRLALL
Patch-mainline: v3.2-rc1
Git-commit: 473e64ee4603671efa1e0785418e56e9ffdfc47b (partial)
References: bnc#795303 FATE#313662

A user-space process must use ETHTOOL_GRXCLSRLCNT to find the number
of classification rules, then allocate a buffer of the right size,
then use ETHTOOL_GRXCLSRLALL to fill the buffer.  If some other
process inserts or deletes a rule between those two operations,
the user buffer might turn out to be the wrong size.

If it's too small, the return value will be -EMSGSIZE.  But if it's
too large, there is no indication of this.  Fix this by updating
the rule_cnt field on return.

Signed-off-by: Ben Hutchings <bhutchings@solarflare.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Acked-by: Benjamin Poirier <bpoirier@suse.de>
---
 drivers/net/ethernet/intel/ixgbe/ixgbe_ethtool.c |    2 ++
 1 file changed, 2 insertions(+)
--- a/drivers/net/ethernet/intel/ixgbe/ixgbe_ethtool.c
+++ b/drivers/net/ethernet/intel/ixgbe/ixgbe_ethtool.c
@@ -2283,6 +2283,8 @@ static int ixgbe_get_ethtool_fdir_all(st
 		cnt++;
 	}
 
+	cmd->rule_cnt = cnt;
+
 	return 0;
 }
 
