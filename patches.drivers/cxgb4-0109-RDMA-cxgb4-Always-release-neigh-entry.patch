From: Steve Wise <swise@opengridcomputing.com>
Date: Wed, 19 Mar 2014 17:44:40 +0530
Subject: [PATCH 109/223] RDMA/cxgb4: Always release neigh entry
Patch-mainline: v3.15-rc1
Git-commit: ebf00060c33b9d0946384fa6f440df7ea35a569e
References: bsc#909577 FATE#317550

Always release the neigh entry in rx_pkt().

Based on original work by Santosh Rastapur <santosh@chelsio.com>.

Signed-off-by: Steve Wise <swise@opengridcomputing.com>
Signed-off-by: Roland Dreier <roland@purestorage.com>
Acked-by: David Chang <dchang@suse.com>
Signed-off-by: John Jolly <jjolly@suse.de>
---
 drivers/infiniband/hw/cxgb4/cm.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

--- a/drivers/infiniband/hw/cxgb4/cm.c
+++ b/drivers/infiniband/hw/cxgb4/cm.c
@@ -3104,13 +3104,13 @@ static int rx_pkt(struct c4iw_dev *dev,
 		pi = (struct port_info *)netdev_priv(neigh->dev);
 		tx_chan = cxgb4_port_chan(neigh->dev);
 	}
+	neigh_release(neigh);
 	if (!e) {
 		pr_err("%s - failed to allocate l2t entry!\n",
 		       __func__);
 		goto free_dst;
 	}
 
-	neigh_release(neigh);
 	step = dev->rdev.lldi.nrxq / dev->rdev.lldi.nchan;
 	rss_qid = dev->rdev.lldi.rxq_ids[pi->port_id * step];
 	window = (__force u16) htons((__force u16)tcph->window);
