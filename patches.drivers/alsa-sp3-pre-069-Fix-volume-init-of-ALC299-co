From 050ea75317f33e376cc413359c0319ad5cc86e2a Mon Sep 17 00:00:00 2001
From: Takashi Iwai <tiwai@suse.de>
Date: Mon, 27 Jun 2011 15:48:17 +0200
Subject: [PATCH] ALSA: hda - Fix volume-init of ALC299 & co
Git-commit: 050ea75317f33e376cc413359c0319ad5cc86e2a
Patch-mainline: 3.1-rc2
Refernces: FATE#314106,FATE#314311,FATE#313695

ALC269 and compatible codecs have the output volume in DACs, thus we
can't use the ALC880's code as is.  Fixed by checking the amp caps and
picking up the right widget for initialization.

Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
 sound/pci/hda/patch_realtek.c |   29 ++++++++++++++++++++---------
 1 file changed, 20 insertions(+), 9 deletions(-)

--- a/sound/pci/hda/patch_realtek.c
+++ b/sound/pci/hda/patch_realtek.c
@@ -5628,17 +5628,28 @@ static int get_pin_type(int line_out_typ
 		return PIN_OUT;
 }
 
-static void alc880_auto_init_dac(struct hda_codec *codec, hda_nid_t nid)
+static void alc880_auto_init_dac(struct hda_codec *codec, hda_nid_t dac)
 {
-	if (!nid)
+	hda_nid_t nid, mix;
+
+	if (!dac)
 		return;
-	nid = alc880_idx_to_mixer(alc880_dac_to_idx(nid));
-	snd_hda_codec_write(codec, nid, 0, AC_VERB_SET_AMP_GAIN_MUTE,
-			    AMP_OUT_ZERO);
-	snd_hda_codec_write(codec, nid, 0, AC_VERB_SET_AMP_GAIN_MUTE,
-			    AMP_IN_UNMUTE(0));
-	snd_hda_codec_write(codec, nid, 0, AC_VERB_SET_AMP_GAIN_MUTE,
-			    AMP_IN_UNMUTE(1));
+	mix = alc880_idx_to_mixer(alc880_dac_to_idx(dac));
+	if (query_amp_caps(codec, dac, HDA_OUTPUT) & AC_AMPCAP_NUM_STEPS)
+		nid = dac;
+	else if (query_amp_caps(codec, mix, HDA_OUTPUT) & AC_AMPCAP_NUM_STEPS)
+		nid = mix;
+	else
+		nid = 0;
+	if (nid)
+		snd_hda_codec_write(codec, nid, 0, AC_VERB_SET_AMP_GAIN_MUTE,
+				    AMP_OUT_ZERO);
+	if (query_amp_caps(codec, mix, HDA_INPUT) & AC_AMPCAP_MUTE) {
+		snd_hda_codec_write(codec, mix, 0, AC_VERB_SET_AMP_GAIN_MUTE,
+				    AMP_IN_UNMUTE(0));
+		snd_hda_codec_write(codec, mix, 0, AC_VERB_SET_AMP_GAIN_MUTE,
+				    AMP_IN_UNMUTE(1));
+	}
 }
 
 static void alc880_auto_init_multi_out(struct hda_codec *codec)
