From: Michal Schmidt <mschmidt@redhat.com>
Date: Mon, 1 Jul 2013 17:23:06 +0200
Subject: [PATCH 102/242] bnx2x: fix dump flag handling
Patch-mainline: v3.11-rc1

Git-commit: 5bb680d6cbe36de9d7ba12b05f845c91a8692318
References: bsc#908684 FATE#317539


bnx2x interprets the dump flag as an index of a register preset.
It is important to validate the index to avoid out of bounds
memory accesses.

Signed-off-by: Michal Schmidt <mschmidt@redhat.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Acked-by: Cho, Yu-Chen <acho@suse.com>
---
 drivers/net/ethernet/broadcom/bnx2x/bnx2x_ethtool.c |    3 +++
 drivers/net/ethernet/broadcom/bnx2x/bnx2x_main.c    |    2 ++
 2 files changed, 5 insertions(+)

--- a/drivers/net/ethernet/broadcom/bnx2x/bnx2x_ethtool.c
+++ b/drivers/net/ethernet/broadcom/bnx2x/bnx2x_ethtool.c
@@ -958,6 +958,9 @@ static int bnx2x_set_dump(struct net_dev
 	struct bnx2x *bp = netdev_priv(dev);
 
 	/* Use the ethtool_dump "flag" field as the dump preset index */
+	if (val->flag < 1 || val->flag > DUMP_MAX_PRESETS)
+		return -EINVAL;
+
 	bp->dump_preset_idx = val->flag;
 	return 0;
 }
--- a/drivers/net/ethernet/broadcom/bnx2x/bnx2x_main.c
+++ b/drivers/net/ethernet/broadcom/bnx2x/bnx2x_main.c
@@ -11640,6 +11640,8 @@ static int bnx2x_init_bp(struct bnx2x *b
 		bp->min_msix_vec_cnt = 2;
 	BNX2X_DEV_INFO("bp->min_msix_vec_cnt %d", bp->min_msix_vec_cnt);
 
+	bp->dump_preset_idx = 1;
+
 	return rc;
 }
 
