From: Steve Wise <swise@opengridcomputing.com>
Date: Wed, 9 Apr 2014 09:40:37 -0500
Subject: [PATCH 136/223] RDMA/cxgb4: Fix over-dereference when terminating
Patch-mainline: v3.15-rc2
Git-commit: 1d1ca9b4fdde07325d263f7a75379527b1281f52
References: bsc#909577 FATE#317550

Need to get the endpoint reference before calling rdma_fini(), which
might fail causing us to not get the reference.

Signed-off-by: Steve Wise <swise@opengridcomputing.com>
Signed-off-by: Roland Dreier <roland@purestorage.com>
Acked-by: David Chang <dchang@suse.com>
Signed-off-by: John Jolly <jjolly@suse.de>
---
 drivers/infiniband/hw/cxgb4/qp.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

--- a/drivers/infiniband/hw/cxgb4/qp.c
+++ b/drivers/infiniband/hw/cxgb4/qp.c
@@ -1395,6 +1395,7 @@ int c4iw_modify_qp(struct c4iw_dev *rhp,
 			qhp->attr.ecode = attrs->ecode;
 			ep = qhp->ep;
 			disconnect = 1;
+			c4iw_get_ep(&qhp->ep->com);
 			if (!internal)
 				terminate = 1;
 			else {
@@ -1402,7 +1403,6 @@ int c4iw_modify_qp(struct c4iw_dev *rhp,
 				if (ret)
 					goto err;
 			}
-			c4iw_get_ep(&qhp->ep->com);
 			break;
 		case C4IW_QP_STATE_ERROR:
 			t4_set_wq_in_error(&qhp->wq);
