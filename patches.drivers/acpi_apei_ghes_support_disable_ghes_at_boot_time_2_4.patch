From nobody Mon Aug  8 13:24:57 2011
From: Huang Ying <ying.huang@intel.com>
Subject: ACPI, APEI, GHES, Support disable GHES at boot time
References: bnc#697859
Patch-Mainline: v3.1-rc1
Git-commit: b6a9501658530d8b8374e37f1edb549039a8a260

Signed-off-by: Thomas Renninger <trenn@suse.de>

Some machine may have broken firmware so that GHES and firmware first
mode should be disabled.  This patch adds support to that.

Signed-off-by: Huang Ying <ying.huang@intel.com>
---
 drivers/acpi/apei/ghes.c |    8 ++++++++
 drivers/acpi/apei/hest.c |   17 +++++++++--------
 include/acpi/apei.h      |    1 +
 3 files changed, 18 insertions(+), 8 deletions(-)

Index: linux-2.6.32-SLE11-SP2/drivers/acpi/apei/ghes.c
===================================================================
--- linux-2.6.32-SLE11-SP2.orig/drivers/acpi/apei/ghes.c
+++ linux-2.6.32-SLE11-SP2/drivers/acpi/apei/ghes.c
@@ -77,6 +77,9 @@ struct ghes {
 	};
 };
 
+int ghes_disable;
+module_param_named(disable, ghes_disable, bool, 0);
+
 static int ghes_panic_timeout	__read_mostly = 30;
 
 /*
@@ -663,6 +666,11 @@ static int __init ghes_init(void)
 		return -EINVAL;
 	}
 
+	if (ghes_disable) {
+		pr_info(GHES_PFX "GHES is not enabled!\n");
+		return -EINVAL;
+	}
+
 	rc = ghes_ioremap_init();
 	if (rc)
 		goto err;
Index: linux-2.6.32-SLE11-SP2/drivers/acpi/apei/hest.c
===================================================================
--- linux-2.6.32-SLE11-SP2.orig/drivers/acpi/apei/hest.c
+++ linux-2.6.32-SLE11-SP2/drivers/acpi/apei/hest.c
@@ -231,16 +231,17 @@ void __init acpi_hest_init(void)
 		goto err;
 	}
 
-	rc = apei_hest_parse(hest_parse_ghes_count, &ghes_count);
-	if (rc)
-		goto err;
-
-	rc = hest_ghes_dev_register(ghes_count);
-	if (!rc) {
-		pr_info(HEST_PFX "Table parsing has been initialized.\n");
-		return;
+	if (!ghes_disable) {
+		rc = apei_hest_parse(hest_parse_ghes_count, &ghes_count);
+		if (rc)
+			goto err;
+		rc = hest_ghes_dev_register(ghes_count);
+		if (rc)
+			goto err;
 	}
 
+	pr_info(HEST_PFX "Table parsing has been initialized.\n");
+	return;
 err:
 	hest_disable = 1;
 }
Index: linux-2.6.32-SLE11-SP2/include/acpi/apei.h
===================================================================
--- linux-2.6.32-SLE11-SP2.orig/include/acpi/apei.h
+++ linux-2.6.32-SLE11-SP2/include/acpi/apei.h
@@ -18,6 +18,7 @@
 
 extern int hest_disable;
 extern int erst_disable;
+extern int ghes_disable;
 
 #ifdef CONFIG_ACPI_APEI
 void __init acpi_hest_init(void);

