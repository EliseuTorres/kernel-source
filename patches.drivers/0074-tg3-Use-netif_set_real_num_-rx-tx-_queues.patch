From mcarlson@broadcom.com  Thu Jun 23 22:01:21 2011
From: Matt Carlson <mcarlson@broadcom.com>
Date: Wed, 22 Jun 2011 18:56:56 -0700
Subject: [PATCH 074/194] tg3: Use netif_set_real_num_{rx,tx}_queues()
Git-commit: 2ddaad397c47de012dfb956b0c05540da1a0dde5
Patch-mainline: v2.6.37-rc1
References: bnc#697783, FATE#311457

Signed-off-by: Ben Hutchings <bhutchings@solarflare.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Acked-by: Jeff Mahoney <jeffm@suse.com>
---
 drivers/net/tg3.c        |    9 +++++++--
 drivers/net/tg3_compat.h |    2 ++
 2 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/drivers/net/tg3.c b/drivers/net/tg3.c
index a43a3f3..2c1b6ff 100644
--- a/drivers/net/tg3.c
+++ b/drivers/net/tg3.c
@@ -8903,7 +8903,12 @@ static bool tg3_enable_msix(struct tg3 *tp)
 	for (i = 0; i < tp->irq_max; i++)
 		tp->napi[i].irq_vec = msix_ent[i].vector;
 
-	tp->dev->real_num_tx_queues = 1;
+	netif_set_real_num_tx_queues(tp->dev, 1);
+	rc = tp->irq_cnt > 1 ? tp->irq_cnt - 1 : 1;
+	if (netif_set_real_num_rx_queues(tp->dev, rc)) {
+		pci_disable_msix(tp->pdev);
+		return false;
+	}
 	if (tp->irq_cnt > 1)
 		tp->tg3_flags3 |= TG3_FLG3_ENABLE_RSS;
 
@@ -8938,7 +8943,7 @@ defcfg:
 	if (!(tp->tg3_flags2 & TG3_FLG2_USING_MSIX)) {
 		tp->irq_cnt = 1;
 		tp->napi[0].irq_vec = tp->pdev->irq;
-		tp->dev->real_num_tx_queues = 1;
+		netif_set_real_num_tx_queues(tp->dev, 1);
 	}
 }
 
diff --git a/drivers/net/tg3_compat.h b/drivers/net/tg3_compat.h
index 1ae1373..afa8100 100644
--- a/drivers/net/tg3_compat.h
+++ b/drivers/net/tg3_compat.h
@@ -73,6 +73,11 @@ do {								\
 
 #define rtnl_link_stats64	net_device_stats
 
+static inline int netif_set_real_num_rx_queues(struct net_device *dev, int num)
+{
+	return 0;
+}
+
 #ifndef PHY_ID_BCM50610
 #define PHY_ID_BCM50610		0xbc050d60
 #endif
-- 
1.7.3.4

