From 2d655a3879bdec3642e2c8e817e7affb087be773 Mon Sep 17 00:00:00 2001
From: Wolfram Sang <wsa@the-dreams.de>
Date: Sun, 12 Jan 2014 10:07:50 +0100
Subject: [PATCH 17/68] usb: core: bail out if user gives an unknown RefId when
 using new_id
References: FATE#315518
Git-Commit: 52a6966c350624db89addc3e6a825f5e797a73e4
Patch-Mainline: v3.14

If users use the new RefId feature of new_id, give them an error message
if they provided an unknown reference. That helps detecting typos.

Signed-off-by: Wolfram Sang <wsa@the-dreams.de>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Oliver Neukum <oneukum@suse.de>
---
 drivers/usb/core/driver.c | 9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

diff --git a/drivers/usb/core/driver.c b/drivers/usb/core/driver.c
index e3bbd7c..971b955 100644
--- a/drivers/usb/core/driver.c
+++ b/drivers/usb/core/driver.c
@@ -74,10 +74,13 @@ ssize_t usb_store_new_id(struct usb_dynids *dynids,
 		const struct usb_device_id *id = id_table;
 
 		for (; id->match_flags; id++)
-			if (id->idVendor == refVendor && id->idProduct == refProduct) {
-				dynid->id.driver_info = id->driver_info;
+			if (id->idVendor == refVendor && id->idProduct == refProduct)
 				break;
-			}
+
+		if (id->match_flags)
+			dynid->id.driver_info = id->driver_info;
+		else
+			return -ENODEV;
 	}
 
 	spin_lock(&dynids->lock);
-- 
1.8.4.5

