From: Kashyap Desai <kashyap.desai@lsi.com>
Subject: fusion/mpt: Fix races with deleted targets
References: bnc#609506
Patch-mainline: Not yet

TM and Target Reset in parallel need to be avoided. Added extra check
in task abort.

Also check additonal "deleted" flag when error handling kicked off.

Acked-by: Jean Delvare <jdelvare@suse.de>
---
 drivers/message/fusion/mptsas.c   |    3 ++-
 drivers/message/fusion/mptscsih.c |    2 +-
 2 files changed, 3 insertions(+), 2 deletions(-)

--- a/drivers/message/fusion/mptsas.c
+++ b/drivers/message/fusion/mptsas.c
@@ -2359,7 +2359,8 @@ static enum blk_eh_timer_return mptsas_e
 	}
 
 	vdevice = sc->device->hostdata;
-	if (vdevice && vdevice->vtarget && vdevice->vtarget->inDMD) {
+	if ((vdevice && vdevice->vtarget) &&
+	    (vdevice->vtarget->inDMD || vdevice->vtarget->deleted)) {
 		dtmprintk(ioc, printk(MYIOC_s_WARN_FMT ": %s: target removed "
 		    "or in device removal delay (sc=%p)\n",
 		    ioc->name, __func__, sc ));
--- a/drivers/message/fusion/mptscsih.c
+++ b/drivers/message/fusion/mptscsih.c
@@ -2043,7 +2043,7 @@ mptscsih_abort(struct scsi_cmnd * SCpnt)
 	scsi_print_command(SCpnt);
 
 	vdevice = SCpnt->device->hostdata;
-	if (!vdevice || !vdevice->vtarget) {
+	if (!vdevice || !vdevice->vtarget || vdevice->vtarget->deleted) {
 		dtmprintk(ioc, printk(MYIOC_s_DEBUG_FMT
 		    "task abort: device has been deleted (sc=%p)\n",
 		    ioc->name, SCpnt));
