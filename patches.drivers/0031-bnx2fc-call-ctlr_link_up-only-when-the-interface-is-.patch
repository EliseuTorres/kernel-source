From ecf1fc9932470b2f3bb4d65816558485d75356e7 Mon Sep 17 00:00:00 2001
From: Bhanu Prakash Gollapudi <bprakash@broadcom.com>
Date: Thu, 29 Sep 2011 22:10:41 -0700
Subject: [PATCH 31/36] bnx2fc: call ctlr_link_up only when the interface is
 enabled
Patch-mainline: v3.2-rc1~125^2~51
Git-commit: fd8fa9071e49a56cc91f739813ea88f16b7c1240

Submitted upstream - http://marc.info/?l=linux-scsi&m=131805712806700&w=2

Link may not be up when the driver receives ulp_start event, and hence
fcoe_ctlr_link_up is not called. Call fcoe_ctlr_link_up during
indicate_netevent only when the interface is enabled. (It has to be called when
enabled because that is an indication that the vlan discovery is completed).

Signed-off-by: Bhanu Prakash Gollapudi <bprakash@broadcom.com>

Acked-by: Ankit Jain <jankit@suse.de>
---
 drivers/scsi/bnx2fc/bnx2fc_fcoe.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/scsi/bnx2fc/bnx2fc_fcoe.c b/drivers/scsi/bnx2fc/bnx2fc_fcoe.c
index 422a6f1..3f4d7d7 100644
--- a/drivers/scsi/bnx2fc/bnx2fc_fcoe.c
+++ b/drivers/scsi/bnx2fc/bnx2fc_fcoe.c
@@ -865,6 +865,8 @@ static void bnx2fc_indicate_netevent(void *context, unsigned long event,
 			 * enable to avoid sending discovery solicitation
 			 * on a stale vlan
 			 */
+			if (interface->enabled)
+				fcoe_ctlr_link_up(&interface->ctlr);
 		} else if (fcoe_ctlr_link_down(&interface->ctlr)) {
 			mutex_lock(&lport->lp_mutex);
 			list_for_each_entry(vport, &lport->vports, list)
-- 
1.7.6.178.g55272

