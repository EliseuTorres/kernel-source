From: Martin Wilck <martin.wilck@ts.fujitsu.com>
Subject: Fix kdump for MFI based controllers
References: bnc#809220
Patch-Mainline: not yet

By trenn:
This code gets only active for specific megasas drivers and only in kdump
environment -> low risk.
The patch is from LSI, but they did not submit it mainline yet, but we can or
do not want to wait until SP3 GA is out.
I will update the metadata (git commit id, comment, ...) as soon as the patch
shows up mainline.

Signed-off-by: Thomas Renninger <trenn@suse.de>

Index: linux-3.0-SLE11-SP3/drivers/scsi/megaraid/megaraid_sas_base.c
===================================================================
--- linux-3.0-SLE11-SP3.orig/drivers/scsi/megaraid/megaraid_sas_base.c
+++ linux-3.0-SLE11-SP3/drivers/scsi/megaraid/megaraid_sas_base.c
@@ -3517,8 +3517,20 @@ static int megasas_init_fw(struct megasa
 	}
 
 	/*
-	 * We expect the FW state to be READY
+ 	 * Below code change isr required for MFI based controllers
+ 	 * It will not do anything for MPT based controller, since adp_reset
+	 * does not have any logical code for fusion controller
 	 */
+	if(reset_devices) {
+		atomic_set(&instance->fw_reset_no_pci_access, 1);
+		instance->instancet->adp_reset(instance, instance->reg_set);
+		atomic_set(&instance->fw_reset_no_pci_access, 0 );
+		printk("megaraid_sas: FW was restarted successfully from Kdump..!\n");
+
+		/*waitting for about 30 second before start the second init*/
+		ssleep(30);
+	}
+
 	if (megasas_transition_to_ready(instance, 0))
 		goto fail_ready_state;
 
