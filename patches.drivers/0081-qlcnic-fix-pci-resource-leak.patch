From: Amit Kumar Salecha <amit.salecha@qlogic.com>
Date: Sun, 18 Jul 2010 14:51:59 -0700
Subject: [PATCH 081/187] qlcnic: fix pci resource leak
Git-commit: bfc978fa5f3005e5dfb39c52393c3339f4f00233
Patch-mainline: v2.6.36-rc1

pci_get_domain_bus_and_slot: caller must decrement the
reference count by calling pci_dev_put().

Signed-off-by: Amit Kumar Salecha <amit.salecha@qlogic.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Acked-by: Jeff Mahoney <jeffm@suse.com>
---
 drivers/net/qlcnic/qlcnic_main.c |    7 ++++++-
 1 files changed, 6 insertions(+), 1 deletions(-)

diff --git a/drivers/net/qlcnic/qlcnic_main.c b/drivers/net/qlcnic/qlcnic_main.c
index f0106b5..951c0ff 100644
--- a/drivers/net/qlcnic/qlcnic_main.c
+++ b/drivers/net/qlcnic/qlcnic_main.c
@@ -2707,9 +2707,14 @@ static int qlcnic_is_first_func(struct pci_dev *pdev)
 		oth_pdev = pci_get_domain_bus_and_slot(pci_domain_nr
 			(pdev->bus), pdev->bus->number,
 			PCI_DEVFN(PCI_SLOT(pdev->devfn), val));
+		if (!oth_pdev)
+			continue;
 
-		if (oth_pdev && (oth_pdev->current_state != PCI_D3cold))
+		if (oth_pdev->current_state != PCI_D3cold) {
+			pci_dev_put(oth_pdev);
 			return 0;
+		}
+		pci_dev_put(oth_pdev);
 	}
 	return 1;
 }
-- 
1.6.3.3

