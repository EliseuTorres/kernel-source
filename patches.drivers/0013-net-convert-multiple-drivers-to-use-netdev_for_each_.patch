From mcarlson@broadcom.com  Thu Jun 23 22:01:21 2011
From: Matt Carlson <mcarlson@broadcom.com>
Date: Wed, 22 Jun 2011 18:56:53 -0700
Subject: [PATCH 013/194] net: convert multiple drivers to use
 netdev_for_each_mc_addr, part6
Git-commit: 567ec874d15b478c8eda7e9a5d2dcb05f13f1fb5
Patch-mainline: v2.6.34-rc1
References: bnc#697783, FATE#311457

Signed-off-by: Jiri Pirko <jpirko@redhat.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Acked-by: Jeff Mahoney <jeffm@suse.com>
---
 drivers/net/tg3.c        |    5 +----
 drivers/net/tg3_compat.h |    8 ++++++++
 2 files changed, 9 insertions(+), 4 deletions(-)

diff --git a/drivers/net/tg3.c b/drivers/net/tg3.c
index 9ac5070..6c37ef5 100644
--- a/drivers/net/tg3.c
+++ b/drivers/net/tg3.c
@@ -9592,15 +9592,12 @@ static void __tg3_set_rx_mode(struct net_device *dev)
 	} else {
 		/* Accept one or more multicast(s). */
 		struct dev_mc_list *mclist;
-		unsigned int i;
 		u32 mc_filter[4] = { 0, };
 		u32 regidx;
 		u32 bit;
 		u32 crc;
 
-		for (i = 0, mclist = dev->mc_list; mclist && i < netdev_mc_count(dev);
-		     i++, mclist = mclist->next) {
-
+		netdev_for_each_mc_addr(mclist, dev) {
 			crc = calc_crc (mclist->dmi_addr, ETH_ALEN);
 			bit = ~crc & 0x7f;
 			regidx = (bit & 0x60) >> 5;
diff --git a/drivers/net/tg3_compat.h b/drivers/net/tg3_compat.h
index 80c8458..c266edf 100644
--- a/drivers/net/tg3_compat.h
+++ b/drivers/net/tg3_compat.h
@@ -48,6 +48,14 @@ do {								\
 #define netdev_mc_empty(dev) (netdev_mc_count(dev) == 0)
 #endif
 
+#ifndef netdev_for_each_mc_addr
+#define netdev_for_each_mc_addr(ha, dev) \
+        struct dev_mc_list * oldmclist; \
+        struct dev_mc_list foo; \
+        ha = &foo; \
+    for (oldmclist = dev->mc_list; oldmclist && memcpy(foo.dmi_addr, oldmclist->dmi_addr, 6); oldmclist = oldmclist->next)
+#endif
+
 #ifndef PHY_ID_BCM50610
 #define PHY_ID_BCM50610		0xbc050d60
 #endif
-- 
1.7.3.4

