From: Kleber Sacilotto de Souza <klebers@linux.vnet.ibm.com>
Subject: mlx4_en: fix allocation of device tx_cq
Patch-mainline: 427a96252d8eee7b9bbafce15bd37fa3387ede55
Git-commit: v3.9-rc1
References: bnc#810655, LTC#90417

The memory to hold the network device tx_cq is not being allocated with
the correct size in mlx4_en_init_netdev(). It should use MAX_TX_RINGS
instead of MAX_RX_RINGS. This can cause problems if the number of tx
rings being used is greater than MAX_RX_RINGS.

Signed-off-by: Kleber Sacilotto de Souza <klebers@linux.vnet.ibm.com>
Acked-by: Amir Vadai <amirv@mellanox.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Acked-by: John Jolly <jjolly@suse.de>
---
 drivers/net/ethernet/mellanox/mlx4/en_netdev.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)


diff -up linux-3.0-orig/drivers/net/ethernet/mellanox/mlx4/en_netdev.c linux-3.0/drivers/net/ethernet/mellanox/mlx4/en_netdev.c
--- linux-3.0-orig/drivers/net/ethernet/mellanox/mlx4/en_netdev.c	2013-03-20 15:30:28.000000000 -0400
+++ linux-3.0/drivers/net/ethernet/mellanox/mlx4/en_netdev.c	2013-03-20 15:32:10.000000000 -0400
@@ -1599,7 +1599,7 @@ int mlx4_en_init_netdev(struct mlx4_en_d
 		err = -ENOMEM;
 		goto out;
 	}
-	priv->tx_cq = kzalloc(sizeof(struct mlx4_en_cq) * MAX_RX_RINGS,
+	priv->tx_cq = kzalloc(sizeof(struct mlx4_en_cq) * MAX_TX_RINGS,
 			      GFP_KERNEL);
 	if (!priv->tx_cq) {
 		err = -ENOMEM;
