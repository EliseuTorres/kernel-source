From: Takashi Iwai <tiwai@suse.de>
Subject: drm/i915: Fix lock-up during hotplug detection
Patch-mainline: Possibly
References: bnc#575047

Fix the lock-up in i915 during the detection of VGA monitor.

Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
 drivers/gpu/drm/i915/intel_crt.c |   11 +++++++++--
 1 file changed, 9 insertions(+), 2 deletions(-)

--- a/drivers/gpu/drm/i915/intel_crt.c
+++ b/drivers/gpu/drm/i915/intel_crt.c
@@ -181,6 +181,7 @@ static bool intel_igdng_crt_detect_hotpl
 	struct drm_i915_private *dev_priv = dev->dev_private;
 	u32 adpa;
 	bool ret;
+	unsigned long timeout;
 
 	adpa = I915_READ(PCH_ADPA);
 
@@ -200,8 +201,14 @@ static bool intel_igdng_crt_detect_hotpl
 	DRM_DEBUG("pch crt adpa 0x%x", adpa);
 	I915_WRITE(PCH_ADPA, adpa);
 
-	while ((I915_READ(PCH_ADPA) & ADPA_CRT_HOTPLUG_FORCE_TRIGGER) != 0)
-		;
+	timeout = jiffies + msecs_to_jiffies(500);
+	while ((I915_READ(PCH_ADPA) & ADPA_CRT_HOTPLUG_FORCE_TRIGGER) != 0) {
+		if (time_after_eq(jiffies, timeout)) {
+			DRM_DEBUG_KMS("crt_detect_hotplug timeout");
+			break;
+		}
+		msleep(1);
+	}
 
 	/* Check the status to see if both blue and green are on now */
 	adpa = I915_READ(PCH_ADPA);
