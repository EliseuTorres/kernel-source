From bhutchings@solarflare.com  Thu Jun 23 16:09:53 2011
From: Ben Hutchings <bhutchings@solarflare.com>
Date: Mon, 27 Sep 2010 08:25:27 +0000
Subject: [PATCH 114/151] bnx2x: Use netif_set_real_num_{rx,tx}_queues()
Git-commit: 31b600b5fcd101acffb261f87f60f27085ca6509
Patch-mainline: v2.6.37-rc1
References: FATE#311458 FATE#311459 FATE#311460 FATE#311461 FATE#311462 bnc#698050

Upstream commit: 31b600b5fcd101acffb261f87f60f27085ca6509

Signed-off-by: Ben Hutchings <bhutchings@solarflare.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Acked-by: Jeff Mahoney <jeffm@suse.com>
---
 drivers/net/bnx2x/bnx2x_cmn.c    |    6 ++++--
 drivers/net/bnx2x/bnx2x_compat.h |    6 ++++++
 2 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/drivers/net/bnx2x/bnx2x_cmn.c b/drivers/net/bnx2x/bnx2x_cmn.c
index c2efbd0..72418e5 100644
--- a/drivers/net/bnx2x/bnx2x_cmn.c
+++ b/drivers/net/bnx2x/bnx2x_cmn.c
@@ -1187,8 +1187,8 @@ static int bnx2x_set_num_queues(struct bnx2x *bp)
 			bp->num_queues = 1;
 		break;
 	}
-	bp->dev->real_num_tx_queues = bp->num_queues;
-	return rc;
+	netif_set_real_num_tx_queues(bp->dev, bp->num_queues);
+	return netif_set_real_num_rx_queues(bp->dev, bp->num_queues);
 }
 
 static void bnx2x_release_firmware(struct bnx2x *bp)
@@ -1220,6 +1220,8 @@ int bnx2x_nic_load(struct bnx2x *bp, int load_mode)
 	bp->state = BNX2X_STATE_OPENING_WAIT4_LOAD;
 
 	rc = bnx2x_set_num_queues(bp);
+	if (rc)
+		return rc;
 
 	if (bnx2x_alloc_mem(bp)) {
 		bnx2x_free_irq(bp, true);
diff --git a/drivers/net/bnx2x/bnx2x_compat.h b/drivers/net/bnx2x/bnx2x_compat.h
index 759f02e..4ee11bc 100644
--- a/drivers/net/bnx2x/bnx2x_compat.h
+++ b/drivers/net/bnx2x/bnx2x_compat.h
@@ -743,4 +743,10 @@ static inline const char *netdev_name(const struct net_device *dev)
 	for (mclist = (dev)->mc_list; mclist; mclist = mclist->next)
 #endif
 
+#if (LINUX_VERSION_CODE < 0x020625)
+static inline int netif_set_real_num_rx_queues(struct net_device *dev, int num)
+{
+	return 0;
+}
+#endif
 #endif /* __BNX2X_COMPAT_H__ */
-- 
1.6.4.GIT

