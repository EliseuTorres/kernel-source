From: John Jolly <jjolly@suse.de>
Subject: kernel: rds-ping triggering a BUG_ON()
Patch-Mainline: Submitted
References: bnc#767610,CVE-2012-2372

 Attempting an rds connection from the IP address of an IPoIB interface to
 itself causes a kernel panic due to a BUG_ON() being triggered. Making the
 test less strict allows rds-ping to work without crashing the machine.

 A local unprivileged user could use this flaw to crash the system.

 Patch originally found at:
 http://people.canonical.com/~apw/misc/cves/CVE-2012-2372-1.diff
---
 net/rds/ib_send.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

--- a/net/rds/ib_send.c
+++ b/net/rds/ib_send.c
@@ -544,7 +544,7 @@ int rds_ib_xmit(struct rds_connection *c
 	int flow_controlled = 0;
 	int nr_sig = 0;
 
-	BUG_ON(off % RDS_FRAG_SIZE);
+	BUG_ON(!conn->c_loopback && off % RDS_FRAG_SIZE);
 	BUG_ON(hdr_off != 0 && hdr_off != sizeof(struct rds_header));
 
 	/* Do not send cong updates to IB loopback */
