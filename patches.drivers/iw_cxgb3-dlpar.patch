From: Steve Wise <swise@opengridcomputing.com>
Subject: RDMA/cxgb3: Mark rdma device with CXIO_ERROR_FATAL when removing.
References: bnc#584958,LTC#61264
Patch-mainline: v2.6.34-rc1
Git-commit: 68baf495d8e559a82787f595fecc30a43bb89bb7

If cxgb3 calls the iw_cxgb3 t3cclient remove function due to a device
removal event, then the iwch device must be marked with CXIO_ERROR_FATAL
since the device below us is going away.  Otherwise, we can get stuck in
a deadlock as rdma ULPs try and deallocate objects (like MRs, QPs, etc).
So always mark the device with CXIO_ERROR_FATAL when removing.

Signed-off-by: Steve Wise <swise@opengridcomputing.com>
Acked-by: John Jolly <jjolly@suse.de>

 ---
diff -Nuarp sp1.beta5.iw_cxgb3/drivers/infiniband/hw/cxgb3/iwch.c sp1.beta5.iw_cxgb3.dlpar/drivers/infiniband/hw/cxgb3/iwch.c
--- sp1.beta5.iw_cxgb3/drivers/infiniband/hw/cxgb3/iwch.c	2010-03-03 00:46:59.000000000 -0600
+++ sp1.beta5.iw_cxgb3.dlpar/drivers/infiniband/hw/cxgb3/iwch.c	2010-03-03 00:46:19.000000000 -0600
@@ -147,6 +147,7 @@ static void close_rnic_dev(struct t3cdev
 	mutex_lock(&dev_mutex);
 	list_for_each_entry_safe(dev, tmp, &dev_list, entry) {
 		if (dev->rdev.t3cdev_p == tdev) {
+			dev->rdev.flags = CXIO_ERROR_FATAL;
 			list_del(&dev->entry);
 			iwch_unregister_device(dev);
 			cxio_rdev_close(&dev->rdev);


