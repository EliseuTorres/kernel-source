From: Hannes Reinecke <hare@suse.de>
Date: Wed, 17 Jul 2013 15:53:53 +0200
Subject: lpfc: Return correct error code on bsg_timeout
References: bnc#816043
Patch-Mainline: n/a

When the bsg timeout and the completion race we need to return
'-EAGAIN' from lpfc_bsg_timeout() to avoid a double completion.

Signed-off-by: Hannes Reinecke <hare@suse.de>
Acked-by: Dick Kennedy <dick.kennedy@emulex.com>

diff --git a/drivers/scsi/lpfc/lpfc_bsg.c b/drivers/scsi/lpfc/lpfc_bsg.c
index b59ed46..1e74f46 100644
--- a/drivers/scsi/lpfc/lpfc_bsg.c
+++ b/drivers/scsi/lpfc/lpfc_bsg.c
@@ -4912,7 +4912,7 @@ lpfc_bsg_timeout(struct fc_bsg_job *job)
 	/* timeout and completion crossed paths if no dd_data */
 	if (!dd_data) {
 		spin_unlock_irqrestore(&phba->ct_ev_lock, flags);
-		return 0;
+		return -EAGAIN;
 	}
 
 	switch (dd_data->type) {
