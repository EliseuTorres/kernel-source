From: Eli Cohen <eli@dev.mellanox.co.il>
Date: Thu, 2 Apr 2015 17:07:19 +0300
Subject: [PATCH 040/117] net/mlx5_core: Allocate firmware pages from device's
 NUMA node
Patch-mainline: v4.1-rc1
Git-commit: ad1891062adcdacb5818e104707dca8c193c33d8
References: bsc#923036 FATE#318772

Allocate firmware pages from the NUMA node which is close to the device.

Signed-off-by: Eli Cohen <eli@mellanox.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Hadar Hen Zion <hadarh@mellanox.com>
Acked-by: Cho, Yu-Chen <acho@suse.com>
---
 drivers/net/ethernet/mellanox/mlx5/core/pagealloc.c |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

--- a/drivers/net/ethernet/mellanox/mlx5/core/pagealloc.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/pagealloc.c
@@ -243,8 +243,9 @@ static int alloc_system_page(struct mlx5
 	struct page *page;
 	u64 addr;
 	int err;
+	int nid = dev_to_node(&dev->pdev->dev);
 
-	page = alloc_page(GFP_HIGHUSER);
+	page = alloc_pages_node(nid, GFP_HIGHUSER, 0);
 	if (!page) {
 		mlx5_core_warn(dev, "failed to allocate page\n");
 		return -ENOMEM;
