From: Dan Carpenter <error27@gmail.com>
Date: Mon, 20 Dec 2010 03:03:15 +0000
Subject: [PATCH 32/46] vmxnet3: locking problems in xmit
References: bnc#674189, fate#311981
Patch-mainline: v2.6.38-rc1
Git-commit:  f955e1415f381c7fa6ebe8630cd1fe5a694e8f4a

There were several paths that didn't release their locks.

Signed-off-by: Dan Carpenter <error27@gmail.com>
Signed-off-by: Bhavesh Davda <bhavesh@vmware.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Acked-by: Chen, Chien-Chia <machen@suse.com>
---
 drivers/net/vmxnet3/vmxnet3_drv.c |    4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

--- a/drivers/net/vmxnet3/vmxnet3_drv.c
+++ b/drivers/net/vmxnet3/vmxnet3_drv.c
@@ -978,7 +978,7 @@ vmxnet3_tq_xmit(struct sk_buff *skb, str
 		}
 	} else {
 		tq->stats.drop_hdr_inspect_err++;
-		goto drop_pkt;
+		goto unlock_drop_pkt;
 	}
 
 	/* fill tx descs related to addr & len */
@@ -1050,6 +1050,8 @@ vmxnet3_tq_xmit(struct sk_buff *skb, str
 
 hdr_too_big:
 	tq->stats.drop_oversized_hdr++;
+unlock_drop_pkt:
+	spin_unlock_irqrestore(&tq->tx_lock, flags);
 drop_pkt:
 	tq->stats.drop_total++;
 	dev_kfree_skb(skb);
