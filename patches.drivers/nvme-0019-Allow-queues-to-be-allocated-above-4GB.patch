From: Matthew Wilcox <matthew.r.wilcox@intel.com>
Date: Tue, 1 Feb 2011 16:23:39 -0500
Subject: NVMe: Allow queues to be allocated above 4GB
Git-commit: 2930353f9f2b9e4629e935acd970cb73c1171229
References: FATE#313627
Patch-Mainline: v3.7-rc1

Need to call dma_set_coherent_mask() to allow queues to be allocated
above 4GB.

Signed-off-by: Matthew Wilcox <matthew.r.wilcox@intel.com>
Acked-by: Hannes Reinecke <hare@suse.de>
---
 drivers/block/nvme.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/drivers/block/nvme.c b/drivers/block/nvme.c
index 128fd70..46f8720 100644
--- a/drivers/block/nvme.c
+++ b/drivers/block/nvme.c
@@ -1110,7 +1110,8 @@ static int __devinit nvme_probe(struct pci_dev *pdev,
 	INIT_LIST_HEAD(&dev->namespaces);
 	dev->pci_dev = pdev;
 	pci_set_drvdata(pdev, dev);
-	dma_set_mask(&dev->pci_dev->dev, DMA_BIT_MASK(64));
+	dma_set_mask(&pdev->dev, DMA_BIT_MASK(64));
+	dma_set_coherent_mask(&pdev->dev, DMA_BIT_MASK(64));
 	nvme_set_instance(dev);
 	dev->entry[0].vector = pdev->irq;
 
-- 
1.7.4.2

