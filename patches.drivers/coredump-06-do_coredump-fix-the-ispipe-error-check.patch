From 99b64567486716d18b2156cad188d86478816e4f Mon Sep 17 00:00:00 2001
From: Oleg Nesterov <oleg@redhat.com>
Date: Tue, 26 Jul 2011 16:08:34 -0700
Subject: do_coredump: fix the "ispipe" error check
Git-commit: 99b64567486716d18b2156cad188d86478816e4f
Patch-mainline: v3.1-rc1
References: bnc#710868 fate#309473

do_coredump() assumes that if format_corename() fails it should return
-ENOMEM.  This is not true, for example cn_print_exe_file() can propagate
the error from d_path.  Even if it was true, this is too fragile.  Change
the code to check "ispipe < 0".

Signed-off-by: Oleg Nesterov <oleg@redhat.com>
Signed-off-by: Jiri Slaby <jslaby@suse.cz>
Reviewed-by: Neil Horman <nhorman@tuxdriver.com>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
---
 fs/exec.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

--- a/fs/exec.c
+++ b/fs/exec.c
@@ -1961,7 +1961,7 @@ void do_coredump(long signr, int exit_co
 	ispipe = format_corename(&cn, signr);
 	unlock_kernel();
 
-	if (ispipe == -ENOMEM) {
+	if (ispipe < 0) {
 		printk(KERN_WARNING "format_corename failed\n");
 		printk(KERN_WARNING "Aborting core\n");
 		goto fail_corename;
