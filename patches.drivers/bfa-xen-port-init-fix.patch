From: Rasesh Mody <rmody@brocade.com>
Date: Thu, 21 Mar 2013 15:45:39 -0700
Subject: bfa: xen port init fix
Patch-mainline: not yet
References: bnc#755944,FATE#313822

The very first PCIe DMA Read done by LPU fails with a fatal error, if the
Address Translation Cache (ATC) has been enabled by system BIOS.

The fix is to disable Invalidated Tag Match Enable capability by setting the
bit 26 of CHIP_MISC_PRG to 0, by default it is set to 1.

Signed-off-by: Anil Gurumurthy <agurumur@brocade.com>
Signed-off-by: Rasesh Mody <rmody@brocade.com>
Acked-by: Hannes Reinecke <hare@suse.de>
---
 drivers/scsi/bfa/bfa_ioc_ct.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/drivers/scsi/bfa/bfa_ioc_ct.c b/drivers/scsi/bfa/bfa_ioc_ct.c
index de4e726..1da6e9a 100644
--- a/drivers/scsi/bfa/bfa_ioc_ct.c
+++ b/drivers/scsi/bfa/bfa_ioc_ct.c
@@ -919,6 +919,9 @@ bfa_ioc_ct2_pll_init(void __iomem *rb, enum bfi_asic_mode mode)
 		}
 	}
 
+	r32 = readl(rb + CT2_CHIP_MISC_PRG);
+	writel((r32 & 0xfbffffff), (rb + CT2_CHIP_MISC_PRG));
+
 	/*
 	 * Mask the interrupts and clear any
 	 * pending interrupts left by BIOS/EFI
-- 
1.7.1

