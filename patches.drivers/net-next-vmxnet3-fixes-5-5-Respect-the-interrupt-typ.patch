From 0bdc0d70c535d59c10add461b96340425f0aac7d Mon Sep 17 00:00:00 2001
From: Shreyas Bhatewara <sbhatewara@vmware.com>
Date: Thu, 15 Jul 2010 15:21:27 +0000
Subject: [PATCH] net-next: vmxnet3 fixes [5/5] Respect the interrupt type in VM configuration
References: bnc#624020
Patch-mainline: 2.6.36-rc2

Respect the interrupt type set in VM configuration.

When interrupt type is not auto, do not ignore the interrupt type set from
VM configuration.

Signed-off-by: Shreyas Bhatewara <sbhatewara@vmware.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Brandon Philips <bphilips@suse.de>

---
 drivers/net/vmxnet3/vmxnet3_drv.c |   13 ++++++++++---
 drivers/net/vmxnet3/vmxnet3_int.h |    4 ++--
 2 files changed, 12 insertions(+), 5 deletions(-)

Index: linux-2.6.32-SLE11-SP1/drivers/net/vmxnet3/vmxnet3_drv.c
===================================================================
--- linux-2.6.32-SLE11-SP1.orig/drivers/net/vmxnet3/vmxnet3_drv.c
+++ linux-2.6.32-SLE11-SP1/drivers/net/vmxnet3/vmxnet3_drv.c
@@ -2155,9 +2155,13 @@ vmxnet3_alloc_intr_resources(struct vmxn
 	adapter->intr.mask_mode = (cfg >> 2) & 0x3;
 
 	if (adapter->intr.type == VMXNET3_IT_AUTO) {
-		int err;
+		adapter->intr.type = VMXNET3_IT_MSIX;
+	}
 
 #ifdef CONFIG_PCI_MSI
+	if (adapter->intr.type == VMXNET3_IT_MSIX) {
+		int err;
+
 		adapter->intr.msix_entries[0].entry = 0;
 		err = pci_enable_msix(adapter->pdev, adapter->intr.msix_entries,
 				      VMXNET3_LINUX_MAX_MSIX_VECT);
@@ -2166,15 +2170,18 @@ vmxnet3_alloc_intr_resources(struct vmxn
 			adapter->intr.type = VMXNET3_IT_MSIX;
 			return;
 		}
-#endif
+		adapter->intr.type = VMXNET3_IT_MSI;
+	}
 
+	if (adapter->intr.type == VMXNET3_IT_MSI) {
+		int err;
 		err = pci_enable_msi(adapter->pdev);
 		if (!err) {
 			adapter->intr.num_intrs = 1;
-			adapter->intr.type = VMXNET3_IT_MSI;
 			return;
 		}
 	}
+#endif /* CONFIG_PCI_MSI */
 
 	adapter->intr.type = VMXNET3_IT_INTX;
 
Index: linux-2.6.32-SLE11-SP1/drivers/net/vmxnet3/vmxnet3_int.h
===================================================================
--- linux-2.6.32-SLE11-SP1.orig/drivers/net/vmxnet3/vmxnet3_int.h
+++ linux-2.6.32-SLE11-SP1/drivers/net/vmxnet3/vmxnet3_int.h
@@ -73,10 +73,10 @@
 /*
  * Version numbers
  */
-#define VMXNET3_DRIVER_VERSION_STRING   "1.0.5.0-k"
+#define VMXNET3_DRIVER_VERSION_STRING   "1.0.13.0-k"
 
 /* a 32-bit int, each byte encode a verion number in VMXNET3_DRIVER_VERSION */
-#define VMXNET3_DRIVER_VERSION_NUM      0x01000500
+#define VMXNET3_DRIVER_VERSION_NUM      0x01000B00
 
 
 /*
