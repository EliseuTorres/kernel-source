From: John Soni Jose <sony.john-n@emulex.com>
Date: Thu, 30 Aug 2012 17:15:57 +0530
Subject: [PATCH 04/27] be2iscsi: cleanup a min_t() call
Git-commit: 4053a4be525d3441cad6cd1ae207177f03eb9ce7
References: FATE#313820
Patch-mainline: v3.3-rc1

 "sense_len" was declared as int type but actually it only stores a
 u16 value that comes from hardware.  The cast to u16 in min_t()
 confuses static analysis because it truncates the int to u16 so I've
 fixed the declaration to reflect that "sense_len" is just a u16.

 Also there was a call to cpu_to_be16() which I've changed to
 be16_to_cpu().  The functions are equivalent, but obviously the
 hardware is big endian and we're doing the min_t() comparison on CPU
 endian values.

 This whole patch is just a cleanup and doesn't affect how the code
 works.

 Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com>
 Reviewed-by: Mike Christie <michaelc@cs.wisc.edu>
 Acked-by: Jayamohan Kallickal <Jayamohan.kallickal@emulex.com>
 Signed-off-by: James Bottomley <JBottomley@Parallels.com>
 ---
Signed-off-by: John Soni Jose <sony.john-n@emulex.com>
Signed-off-by: Jayamohan Kallickal <jayamohan.kallickal@emulex.com>
Acked-by: Lee Duncan <lduncan@suse.com>
---
 drivers/scsi/be2iscsi/be_main.c |    5 +++--
 1 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/drivers/scsi/be2iscsi/be_main.c b/drivers/scsi/be2iscsi/be_main.c
index cdc8ed4..5553003 100644
--- a/drivers/scsi/be2iscsi/be_main.c
+++ b/drivers/scsi/be2iscsi/be_main.c
@@ -1103,7 +1103,6 @@ be_complete_io(struct beiscsi_conn *beiscsi_conn,
 	struct be_status_bhs *sts_bhs =
 				(struct be_status_bhs *)io_task->cmd_bhs;
 	struct iscsi_conn *conn = beiscsi_conn->conn;
-	unsigned int sense_len;
 	unsigned char *sense;
 	u32 resid = 0, exp_cmdsn, max_cmdsn;
 	u8 rsp, status, flags;
@@ -1151,9 +1150,11 @@ be_complete_io(struct beiscsi_conn *beiscsi_conn,
 	}
 
 	if (status == SAM_STAT_CHECK_CONDITION) {
+		u16 sense_len;
 		unsigned short *slen = (unsigned short *)sts_bhs->sense_info;
+
 		sense = sts_bhs->sense_info + sizeof(unsigned short);
-		sense_len =  cpu_to_be16(*slen);
+		sense_len = be16_to_cpu(*slen);
 		memcpy(task->sc->sense_buffer, sense,
 		       min_t(u16, sense_len, SCSI_SENSE_BUFFERSIZE));
 	}
-- 
1.7.2



