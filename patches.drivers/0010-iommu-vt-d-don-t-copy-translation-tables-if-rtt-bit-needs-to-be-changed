From: Joerg Roedel <jroedel@suse.de>
Date: Fri, 12 Jun 2015 12:39:25 +0200
Subject: iommu/vt-d: Don't copy translation tables if RTT bit needs to be
 changed
Git-commit: c3361f2f6e1d64bc7e7b8148bbd1c66b8007a898
Patch-mainline: v4.2-rc1
References: bsc#856382

We can't change the RTT bit when translation is enabled, so
don't copy translation tables when we would change the bit
with our new root entry.

Signed-off-by: Joerg Roedel <jroedel@suse.de>
---
 drivers/iommu/intel-iommu.c | 12 +++++++++++-
 1 file changed, 11 insertions(+), 1 deletion(-)

--- a/drivers/iommu/intel-iommu.c
+++ b/drivers/iommu/intel-iommu.c
@@ -2883,10 +2883,20 @@
 	unsigned long flags;
 	u64 rtaddr_reg;
 	int bus, ret;
-	bool ext;
+	bool new_ext, ext;
 
 	rtaddr_reg = dmar_readq(iommu->reg + DMAR_RTADDR_REG);
 	ext        = !!(rtaddr_reg & DMA_RTADDR_RTT);
+	new_ext    = 0;
+
+	/*
+	 * The RTT bit can only be changed when translation is disabled,
+	 * but disabling translation means to open a window for data
+	 * corruption. So bail out and don't copy anything if we would
+	 * have to change the bit.
+	 */
+	if (new_ext != ext)
+		return -EINVAL;
 
 	old_rt_phys = rtaddr_reg & VTD_PAGE_MASK;
 	if (!old_rt_phys)
