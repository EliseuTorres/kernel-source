From: Huang Ying <ying.huang@intel.com>
Subject: ACPI, APEI, ERST, Prevent erst_dbg from loading if ERST is disabled
References: bnc#697859
Patch-Mainline: v3.1-rc1
Git-commit: ca7cc5110a313a609da40ae948978a585352564b


Signed-off-by: Thomas Renninger <trenn@suse.de>

erst_dbg module can not work when ERST is disabled.  So disable module
loading to provide clearer information to user.

Signed-off-by: Huang Ying <ying.huang@intel.com>
Signed-off-by: Len Brown <len.brown@intel.com>

diff --git a/drivers/acpi/apei/erst-dbg.c b/drivers/acpi/apei/erst-dbg.c
index a4cfb64..cb04aa4 100644
--- a/drivers/acpi/apei/erst-dbg.c
+++ b/drivers/acpi/apei/erst-dbg.c
@@ -213,6 +213,10 @@ static struct miscdevice erst_dbg_dev = {
 
 static __init int erst_dbg_init(void)
 {
+	if (erst_disable) {
+		pr_info(ERST_DBG_PFX "ERST support is disabled.\n");
+		return -ENODEV;
+	}
 	return misc_register(&erst_dbg_dev);
 }
 
