From: Lalit Chandivade <lalit.chandivade@qlogic.com>
Date: Wed, 1 Feb 2012 12:45:11 +0530
Subject: qla4xxx: Fix huge delay for ISP4022
References: bnc#744253
Patch-Mainline: v3.3
Git-commit: c28eaaca7acea214937fb9b3ae45e001d49947bf

The default timeout value is large (2560) in case of ISP4022
so ensure its within limits to reduce initialization time.

Signed-off-by: Lalit Chandivade <lalit.chandivade@qlogic.com>
Acked-by: Hannes Reinecke <hare@suse.de>

---
 drivers/scsi/qla4xxx/ql4_os.c |    7 ++++++-
 1 files changed, 6 insertions(+), 1 deletions(-)

diff --git a/drivers/scsi/qla4xxx/ql4_os.c b/drivers/scsi/qla4xxx/ql4_os.c
index 9c14a8f..849580f 100644
--- a/drivers/scsi/qla4xxx/ql4_os.c
+++ b/drivers/scsi/qla4xxx/ql4_os.c
@@ -4287,12 +4287,17 @@ void qla4xxx_build_ddb_list(struct scsi_qla_host *ha, int is_reset)
 	}
 
 	/* Wait to ensure all sendtargets are done for min 12 sec wait */
-	tmo = ((ha->def_timeout < LOGIN_TOV) ? LOGIN_TOV : ha->def_timeout);
+	tmo = ((ha->def_timeout > LOGIN_TOV) &&
+	      (ha->def_timeout < LOGIN_TOV * 10) ?
+	      ha->def_timeout : LOGIN_TOV);
+
 	DEBUG2(ql4_printk(KERN_INFO, ha,
 			  "Default time to wait for build ddb %d\n", tmo));
 
 	wtime = jiffies + (HZ * tmo);
 	do {
+		if (list_empty(&list_st))
+			break;
 		qla4xxx_remove_failed_ddb(ha, &list_st);
 		schedule_timeout_uninterruptible(HZ / 10);
 	} while (time_after(wtime, jiffies));
-- 
1.7.1

