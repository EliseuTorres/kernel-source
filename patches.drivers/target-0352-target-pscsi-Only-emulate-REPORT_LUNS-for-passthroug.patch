From: Nicholas Bellinger <nab@linux-iscsi.org>
Date: Wed, 30 May 2012 14:47:18 -0700
Subject: [PATCH] target/pscsi: Only emulate REPORT_LUNS for passthrough
Git-commit: a3785c8740c5b56b49ec336b59be996393d83332
References: FATE#313550
Patch-Mainline: v3.6

This patch changes back the pSCSI backend to follow pre 3.6-queue code to
passthrough SPC-3 persistent reservations + SPC-2 legacy reservation
handling to the underlying LLD / physical hardware.

For folks who really need this for their own SPC-3 emulation logic, avoid
changing the functionality of this beyond what is exported for REPORT_LUNS
for existing code, and to avoid problems with SPC-3 PR/ALUA as INQUIRY
EVPD=0x83 emulation needs to be in place in order for this to work as
expected with spc_parse_cdb() code..

Cc: Christoph Hellwig <hch@lst.de>
Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
Acked-by: Hannes Reinecke <hare@suse.de>
---
 drivers/target/target_core_pscsi.c |   12 +++---------
 1 files changed, 3 insertions(+), 9 deletions(-)

diff --git a/drivers/target/target_core_pscsi.c b/drivers/target/target_core_pscsi.c
index 9a776cc..cb4c6b1 100644
--- a/drivers/target/target_core_pscsi.c
+++ b/drivers/target/target_core_pscsi.c
@@ -1061,18 +1061,12 @@ static int pscsi_parse_cdb(struct se_cmd *cmd)
 	pscsi_clear_cdb_lun(cdb);
 
 	/*
-	 * For REPORT LUNS we always need to emulate the respone, and for everything
-	 * related to persistent reservations and ALUA we might optionally use our
-	 * handlers before passing on the command to the physical hardware.
+	 * For REPORT LUNS we always need to emulate the response, for everything
+	 * else the default for pSCSI is to pass the command to the underlying
+	 * LLD / physical hardware.
 	 */
 	switch (cdb[0]) {
 	case REPORT_LUNS:
-	case PERSISTENT_RESERVE_IN:
-	case PERSISTENT_RESERVE_OUT:
-	case RELEASE:
-	case RELEASE_10:
-	case RESERVE:
-	case RESERVE_10:
 		ret = spc_parse_cdb(cmd, &dummy_size);
 		if (ret)
 			return ret;
-- 
1.7.4.2

