From: Alexander Guller <alexg@mellanox.com>
Date: Mon, 19 Dec 2011 04:02:58 +0000
Subject: mlx4_en: nullify cached multicast address list after cleanup
Patch-mainline: v3.3-rc1
Git-commit: 0e03567a2c2542e142d5ab6c8bcbf6373a241afe
References: bnc#786036 FATE#314304

Solves an issue where we tried to free the same page twice after
the port has been opened and closed.

Signed-off-by: Alexander Guller <alexg@mellanox.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Amir Vadai <amirv@mellanox.com>
Acked-by: Benjamin Poirier <bpoirier@suse.de>
---
 drivers/net/ethernet/mellanox/mlx4/en_netdev.c |    2 ++
 1 file changed, 2 insertions(+)
--- a/drivers/net/ethernet/mellanox/mlx4/en_netdev.c
+++ b/drivers/net/ethernet/mellanox/mlx4/en_netdev.c
@@ -148,6 +148,7 @@ static void mlx4_en_clear_list(struct ne
 	struct mlx4_en_priv *priv = netdev_priv(dev);
 
 	kfree(priv->mc_addrs);
+	priv->mc_addrs = NULL;
 	priv->mc_addrs_cnt = 0;
 }
 
@@ -167,6 +168,7 @@ static void mlx4_en_cache_mclist(struct
 	i = 0;
 	netdev_for_each_mc_addr(ha, dev)
 		memcpy(mc_addrs + i++ * ETH_ALEN, ha->addr, ETH_ALEN);
+	mlx4_en_clear_list(dev);
 	priv->mc_addrs = mc_addrs;
 	priv->mc_addrs_cnt = mc_addrs_cnt;
 }
