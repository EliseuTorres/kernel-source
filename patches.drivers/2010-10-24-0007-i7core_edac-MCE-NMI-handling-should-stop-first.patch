From: Mauro Carvalho Chehab <mchehab@redhat.com>
Subject: i7core_edac: MCE NMI handling should stop first
References: fate#311968
Git-commit: 41ba6c10586dfab632725cd532677ae5ae460e3e
Patch-mainline: v2.6.37-rc1


Signed-off-by: Thomas Renninger <trenn@suse.de>

Otherwise, a NMI may happen causing a race condition and a panic.

Signed-off-by: Mauro Carvalho Chehab <mchehab@redhat.com>

---
 drivers/edac/i7core_edac.c |    9 ++++++++-
 1 file changed, 8 insertions(+), 1 deletion(-)

Index: linux-2.6.32-SLE11-SP1/drivers/edac/i7core_edac.c
===================================================================
--- linux-2.6.32-SLE11-SP1.orig/drivers/edac/i7core_edac.c
+++ linux-2.6.32-SLE11-SP1/drivers/edac/i7core_edac.c
@@ -2071,6 +2071,10 @@ static void __devexit i7core_remove(stru
 			debugf0("MC: " __FILE__ ": %s(): mci = %p, dev = %p\n",
 				__func__, mci, &i7core_dev->pdev[0]->dev);
 
+			/* Disable MCE NMI handler */
+			edac_mce_unregister(&pvt->edac_mce);
+
+			/* Disable EDAC polling */
 			if (likely(pvt->i7core_pci))
 				edac_pci_release_generic_ctl(pvt->i7core_pci);
 			else
@@ -2079,11 +2083,14 @@ static void __devexit i7core_remove(stru
 					      i7core_dev->socket);
 			pvt->i7core_pci = NULL;
 
+			/* Remove MC sysfs nodes */
 			edac_mc_del_mc(&i7core_dev->pdev[0]->dev);
 
-			edac_mce_unregister(&pvt->edac_mce);
+			/* Free data */
 			kfree(mci->ctl_name);
 			edac_mc_free(mci);
+
+			/* Release PCI resources */
 			i7core_put_devices(i7core_dev);
 		}
 	}
