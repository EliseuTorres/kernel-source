From: Armen Baloyan <armen.baloyan@qlogic.com>
Date: Tue, 27 Aug 2013 01:37:43 -0400
Subject: [SCSI] qla2xxx: Send all AENs for ISPFx00 to above layers.
References: bnc#909372,FATE#317544
Patch-Mainline: v3.13
Git-commit: c18b8e9e9de178cc18428b7e52fb39c90ecfc4d3

Signed-off-by: Armen Baloyan <armen.baloyan@qlogic.com>
Signed-off-by: Saurav Kashyap <saurav.kashyap@qlogic.com>
Signed-off-by: James Bottomley <JBottomley@Parallels.com>
Acked-by: Hannes Reinecke <hare@suse.de>
---
 drivers/scsi/qla2xxx/qla_mr.c | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/scsi/qla2xxx/qla_mr.c b/drivers/scsi/qla2xxx/qla_mr.c
index 8f5c556..176f307 100644
--- a/drivers/scsi/qla2xxx/qla_mr.c
+++ b/drivers/scsi/qla2xxx/qla_mr.c
@@ -1737,6 +1737,10 @@ qlafx00_process_aen(struct scsi_qla_host *vha, struct qla_work_evt *evt)
 	aen_data = evt->u.aenfx.evtcode;
 
 	switch (evt->u.aenfx.evtcode) {
+	case QLAFX00_MBA_SHUTDOWN_RQSTD: /* FW shutdown pending */
+		set_bit(ISP_ABORT_NEEDED, &vha->dpc_flags);
+		rval = qlafx00_driver_shutdown(vha, 10);
+		break;
 	case QLAFX00_MBA_PORT_UPDATE:		/* Port database update */
 		if (evt->u.aenfx.mbx[1] == 0) {
 			if (evt->u.aenfx.mbx[2] == 1) {
@@ -2926,8 +2930,6 @@ qlafx00_async_event(scsi_qla_host_t *vha)
 		    "Asynchronous critical temperature event received "
 		    "aenmb[0]: %x\n",
 		ha->aenmb[0]);
-		qlafx00_post_aenfx_work(vha, ha->aenmb[0],
-		    (uint32_t *)ha->aenmb, 1);
 		break;
 
 	default:
-- 
1.8.5.2

