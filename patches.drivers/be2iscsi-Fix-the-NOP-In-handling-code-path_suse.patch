From 7833afc2889e1a6690205d3f6ee302332db89c07 Mon Sep 17 00:00:00 2001
From: "Jayamohan.Kallickal" <jayamohan.kallickal@emulex.com>
Date: Sat, 9 Mar 2013 05:58:23 -0800
Patch-mainline:  Submitted 11 Mar 2013 linux-scsi@vger.kernel.org
Reference: bnc#809503
Subject: be2iscsi: Fix the NOP-In handling code path

 When target send a NOP-IN with valid TTT, driver issues a NOP-OUT
 and the task was not freed from driver. The task list available for
 the session used to run out, and as no more task list were available
 no more iSCSI commands were able to be exchanged for that session.
 This patches fixed the issue, by calling iscsi_put_task.

Signed-off-by: John Soni Jose <sony.john-n@emulex.com>
Signed-off-by: Lee Duncan <lduncan@suse.com>
---
 drivers/scsi/be2iscsi/be_main.c |   12 ++++--------
 1 files changed, 4 insertions(+), 8 deletions(-)

diff --git a/drivers/scsi/be2iscsi/be_main.c b/drivers/scsi/be2iscsi/be_main.c
index 04c6b1f..654ea05 100644
--- a/drivers/scsi/be2iscsi/be_main.c
+++ b/drivers/scsi/be2iscsi/be_main.c
@@ -1347,8 +1347,6 @@ hwi_complete_drvr_msgs(struct beiscsi_conn *beiscsi_conn,
 	struct hwi_controller *phwi_ctrlr;
 	struct iscsi_task *task;
 	struct beiscsi_io_task *io_task;
-	struct iscsi_conn *conn = beiscsi_conn->conn;
-	struct iscsi_session *session = conn->session;
 
 	phwi_ctrlr = phba->phwi_ctrlr;
 	pwrb_context = &phwi_ctrlr->wrb_context[((psol->
@@ -1361,12 +1359,8 @@ hwi_complete_drvr_msgs(struct beiscsi_conn *beiscsi_conn,
 	task = pwrb_handle->pio_handle;
 
 	io_task = task->dd_data;
-	spin_lock_bh(&phba->mgmt_sgl_lock);
-	free_mgmt_sgl_handle(phba, io_task->psgl_handle);
-	spin_unlock_bh(&phba->mgmt_sgl_lock);
-	spin_lock_bh(&session->lock);
-	free_wrb_handle(phba, pwrb_context, pwrb_handle);
-	spin_unlock_bh(&session->lock);
+	memset(io_task->pwrb_handle->pwrb, 0, sizeof(struct iscsi_wrb));
+	iscsi_put_task(task);
 }
 
 static void
@@ -3888,6 +3882,8 @@ static void beiscsi_cleanup_task(struct iscsi_task *task)
 			if (io_task->pwrb_handle) {
 				free_wrb_handle(phba, pwrb_context,
 						io_task->pwrb_handle);
+				memset(io_task->pwrb_handle->pwrb, 0,
+					sizeof(struct iscsi_wrb));
 				io_task->pwrb_handle = NULL;
 			}
 			if (io_task->psgl_handle) {
-- 
1.7.1

