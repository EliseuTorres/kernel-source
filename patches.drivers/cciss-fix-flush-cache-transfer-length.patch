From: Stephen M. Cameron <scameron@beardog.cce.hp.com>
Date: Mon, 28 Nov 2011 20:12:05 +0100
Subject: cciss: fix flush cache transfer length
Git-commit: 59bd71a81b66990564eac69aedd28ad87a2c81f4
References: FATE#313833
Patch-Mainline: v3.2

We weren't filling in the transfer length of the
flush cache command (it transfers 4 bytes of zeroes).
Firmware didn't seem to be bothered by this, but it
should be fixed.

Signed-off-by: Stephen M. Cameron <scameron@beardog.cce.hp.com>
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Acked-by: Hannes Reinecke <hare@suse.de>
---
 drivers/block/cciss.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/block/cciss.c b/drivers/block/cciss.c
index 5180ed2..92392aa 100644
--- a/drivers/block/cciss.c
+++ b/drivers/block/cciss.c
@@ -2623,6 +2623,8 @@ static int fill_cmd(ctlr_info_t *h, CommandList_struct *c, __u8 cmd, void *buff,
 			c->Request.Timeout = 0;
 			c->Request.CDB[0] = BMIC_WRITE;
 			c->Request.CDB[6] = BMIC_CACHE_FLUSH;
+			c->Request.CDB[7] = (size >> 8) & 0xFF;
+			c->Request.CDB[8] = size & 0xFF;
 			break;
 		case TEST_UNIT_READY:
 			c->Request.CDBLen = 6;
-- 
1.7.4.2

