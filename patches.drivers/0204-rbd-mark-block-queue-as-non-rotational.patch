From 160a8fca9f8d1cb3d7c0288cfef49d5248e8ebdc Mon Sep 17 00:00:00 2001
From: Ilya Dryomov <idryomov@gmail.com>
Date: Tue, 24 Mar 2015 16:15:17 +0300
Subject: [PATCH 204/213] rbd: mark block queue as non-rotational
References: fate#318918
Git-commit: d8a2c89c8636405ad0b234f111d22c00c37e452b
Patch-mainline: v4.1-rc1

Set QUEUE_FLAG_NONROT.  Following commit b277da0a8a59 ("block: disable
entropy contributions for nonrot devices") we should also clear
QUEUE_FLAG_ADD_RANDOM, but it's off by default for blk-mq drivers, so
just note it in the comment.

Also remove physical block size assignment - no sense in repeating
defaults that are not going to change.

Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
[ddiss@suse.de: explicitly clear QUEUE_FLAG_ADD_RANDOM without blk-mq]
Signed-off-by: David Disseldorp <ddiss@suse.de>

---
 drivers/block/rbd.c | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/drivers/block/rbd.c b/drivers/block/rbd.c
index 298573a..e283890 100644
--- a/drivers/block/rbd.c
+++ b/drivers/block/rbd.c
@@ -3795,8 +3795,9 @@ static int rbd_init_disk(struct rbd_device *rbd_dev)
 	if (!q)
 		goto out_disk;
 
-	/* We use the default size, but let's be explicit about it. */
-	blk_queue_physical_block_size(q, SECTOR_SIZE);
+	queue_flag_set_unlocked(QUEUE_FLAG_NONROT, q);
+	queue_flag_clear_unlocked(QUEUE_FLAG_ADD_RANDOM, q);
+	/* QUEUE_FLAG_ADD_RANDOM is off by default for blk-mq */
 
 	/* set io sizes to object size */
 	segment_size = rbd_obj_bytes(&rbd_dev->header);
-- 
2.1.4

