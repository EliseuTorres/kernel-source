From: Christoph Hellwig <hch@infradead.org>
Date: Wed, 23 Nov 2011 06:54:15 -0500
Subject: [PATCH] target: remove the se_task task_error_status field
Git-commit: 41e16e981679124c78c30f046d4f0b71d86ff1b2
References: FATE#313550
Patch-Mainline: v3.3

We only reach transport_complete_task once per task, so the test and set on
task_error_status is never going to have an effect.

Signed-off-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
Acked-by: Hannes Reinecke <hare@suse.de>
---
 drivers/target/target_core_transport.c |    8 +-------
 include/target/target_core_base.h      |    1 -
 2 files changed, 1 insertions(+), 8 deletions(-)

diff --git a/drivers/target/target_core_transport.c b/drivers/target/target_core_transport.c
index a03a19e..c4a04ac 100644
--- a/drivers/target/target_core_transport.c
+++ b/drivers/target/target_core_transport.c
@@ -738,13 +738,7 @@ void transport_complete_task(struct se_task *task, int success)
 	}
 
 	if (cmd->t_tasks_failed) {
-		if (!task->task_error_status) {
-			task->task_error_status =
-				TCM_LOGICAL_UNIT_COMMUNICATION_FAILURE;
-			cmd->scsi_sense_reason =
-				TCM_LOGICAL_UNIT_COMMUNICATION_FAILURE;
-		}
-
+		cmd->scsi_sense_reason = TCM_LOGICAL_UNIT_COMMUNICATION_FAILURE;
 		INIT_WORK(&cmd->work, target_complete_failure_work);
 	} else {
 		atomic_set(&cmd->t_transport_complete, 1);
diff --git a/include/target/target_core_base.h b/include/target/target_core_base.h
index 6e5d50b..745eccf 100644
--- a/include/target/target_core_base.h
+++ b/include/target/target_core_base.h
@@ -491,7 +491,6 @@ struct se_task {
 	u32			task_sg_nents;
 	u16			task_flags;
 	u8			task_scsi_status;
-	int			task_error_status;
 	enum dma_data_direction	task_data_direction;
 	atomic_t		task_state_active;
 	struct list_head	t_list;
-- 
1.7.4.2

