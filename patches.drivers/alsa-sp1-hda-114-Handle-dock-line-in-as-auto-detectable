From 1f83ac5ac9fb3e8b2e053de380f55ba412228577 Mon Sep 17 00:00:00 2001
From: Takashi Iwai <tiwai@suse.de>
Date: Tue, 17 May 2011 12:29:09 +0200
Subject: [PATCH] ALSA: hda - Handle dock line-in as auto-detectable for IDT codecs
Git-commit: 1f83ac5ac9fb3e8b2e053de380f55ba412228577
Git-repo: git://git.kernel.org/pub/scm/linux/kernel/git/tiwai/sound-2.6.git
Patch-mainline: 2.6.40-rc1
References: bnc#691829

When a docking-station has a line-in jack, we can handle it also as
a detectable jack just like mic-in.  This will improve the usability
of HP laptops with a docking-station.

Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
 sound/pci/hda/patch_sigmatel.c |   14 ++++++++------
 1 file changed, 8 insertions(+), 6 deletions(-)

--- a/sound/pci/hda/patch_sigmatel.c
+++ b/sound/pci/hda/patch_sigmatel.c
@@ -3515,25 +3515,33 @@
 			 hda_nid_t *fixed, hda_nid_t *ext, hda_nid_t *dock)
 {
 	unsigned int cfg;
+	unsigned int type;
 
 	if (!nid)
 		return 0;
 	cfg = snd_hda_codec_get_pincfg(codec, nid);
+	type = get_defcfg_device(cfg);
 	switch (get_defcfg_connect(cfg)) {
 	case AC_JACK_PORT_BOTH:
 	case AC_JACK_PORT_FIXED:
 		if (*fixed)
 			return 1; /* already occupied */
+		if (type != AC_JACK_MIC_IN)
+			return 1; /* invalid type */
 		*fixed = nid;
 		break;
 	case AC_JACK_PORT_COMPLEX:
 		if ((get_defcfg_location(cfg) & 0xF0) == AC_JACK_LOC_SEPARATE) {
 			if (*dock)
 				return 1; /* already occupied */
+			if (type != AC_JACK_MIC_IN && type != AC_JACK_LINE_IN)
+				return 1; /* invalid type */
 			*dock = nid;
 		} else {
 			if (*ext)
 				return 1; /* already occupied */
+			if (type != AC_JACK_MIC_IN)
+				return 1; /* invalid type */
 			*ext = nid;
 		}
 		break;
@@ -3584,15 +3592,9 @@
 static int stac_check_auto_mic(struct hda_codec *codec)
 {
 	struct sigmatel_spec *spec = codec->spec;
-	struct auto_pin_cfg *cfg = &spec->autocfg;
 	hda_nid_t fixed, ext, dock;
 	hda_nid_t nid, end_nid;
-	int i;
 
-	for (i = AUTO_PIN_LINE; i < AUTO_PIN_LAST; i++) {
-		if (cfg->input_pins[i])
-			return 0; /* must be exclusively mics */
-	}
 	fixed = ext = dock = 0;
 	/* read all default configuration for pin complex */
 	end_nid = codec->start_nid + codec->num_nodes;
