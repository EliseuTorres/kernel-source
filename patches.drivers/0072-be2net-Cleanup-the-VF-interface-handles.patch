From ajit.khaparde@emulex.com  Thu Jun 23 15:40:25 2011
From: Ajit Khaparde <ajit.khaparde@emulex.com>
Date: Fri, 11 Feb 2011 13:35:56 +0000
Subject: [PATCH] be2net: Cleanup the VF interface handles
Git-commit: 7ab8b0b432cf5110624858e23ef264982e542f17
Patch-mainline: v2.6.39-rc1
References: FATE#311448, bnc#697255

The PF needs to cleanup all the interface handles that it created for the VFs.

Signed-off-by: Ajit Khaparde <ajit.khaparde@emulex.com>
Signed-off-by: David S. Miller <davem@davemloft.net>

Acked-by: Jeff Mahoney <jeffm@suse.com>
---
 drivers/net/benet/be_main.c |    9 +++++++++
 1 file changed, 9 insertions(+)
--- a/drivers/net/benet/be_main.c
+++ b/drivers/net/benet/be_main.c
@@ -2261,6 +2261,8 @@ do_none:
 
 static int be_clear(struct be_adapter *adapter)
 {
+	int vf;
+
 	if (be_physfn(adapter) && adapter->sriov_enabled)
 		be_vf_eth_addr_rem(adapter);
 
@@ -2268,6 +2270,13 @@ static int be_clear(struct be_adapter *a
 	be_rx_queues_destroy(adapter);
 	be_tx_queues_destroy(adapter);
 
+	if (be_physfn(adapter) && adapter->sriov_enabled)
+		for (vf = 0; vf < num_vfs; vf++)
+			if (adapter->vf_cfg[vf].vf_if_handle)
+				be_cmd_if_destroy(adapter,
+					adapter->vf_cfg[vf].vf_if_handle,
+					vf + 1);
+
 	be_cmd_if_destroy(adapter, adapter->if_handle,  0);
 
 	/* tell fw we're done with firing cmds */
