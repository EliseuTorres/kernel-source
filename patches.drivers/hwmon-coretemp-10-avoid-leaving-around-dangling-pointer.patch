From: Guenter Roeck <guenter.roeck@ericsson.com>
Date: Sat, 24 Sep 2011 15:27:04 -0700
Subject: [PATCH] hwmon: (coretemp) Avoid leaving around dangling pointer
References: bnc#698797, FATE#311941
Patch-mainline: 3.1
Git-commit: 20ecb499f64a7e8e7fe03f6098ab25c71b7a6481

Storing the struct temp_data pointer allocated from create_core_data()
when returning an error has the potential of leaving around a pointer
to freed memory. Reset it to NULL for error returns.

Reported-by: Jan Beulich <jbeulich@suse.com>
Signed-off-by: Guenter Roeck <guenter.roeck@ericsson.com>
Acked-by: Jean Delvare <khali@linux-fr.org>
Acked-by: Jean Delvare <jdelvare@suse.de>

diff --git a/drivers/hwmon/coretemp.c b/drivers/hwmon/coretemp.c
index cf5b1de..9323837 100644
--- a/drivers/hwmon/coretemp.c
+++ b/drivers/hwmon/coretemp.c
@@ -506,6 +506,7 @@ static int create_core_data(struct platform_device *pdev,
 
 	return 0;
 exit_free:
+	pdata->core_data[attr_no] = NULL;
 	kfree(tdata);
 	return err;
 }
