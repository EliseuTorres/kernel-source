From bhutchings@solarflare.com  Thu Jun 23 16:09:53 2011
From: Ben Hutchings <bhutchings@solarflare.com>
Date: Mon, 27 Sep 2010 08:25:16 +0000
Subject: [PATCH 113/151] bnx2: Use netif_set_real_num_{rx,tx}_queues()
Git-commit: 657d92fe6d693b9674264bc7546e664714955425
Patch-mainline: v2.6.37-rc1
References: FATE#311458 FATE#311459 FATE#311460 FATE#311461 FATE#311462 bnc#698050

Upstream commit: 657d92fe6d693b9674264bc7546e664714955425

Signed-off-by: Ben Hutchings <bhutchings@solarflare.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Acked-by: Jeff Mahoney <jeffm@suse.com>
---
 drivers/net/bnx2.c |    9 ++++++---
 drivers/net/bnx2.h |    5 +++++
 2 files changed, 11 insertions(+), 3 deletions(-)

diff --git a/drivers/net/bnx2.c b/drivers/net/bnx2.c
index aa20a88..5ef3be2 100644
--- a/drivers/net/bnx2.c
+++ b/drivers/net/bnx2.c
@@ -6206,7 +6206,7 @@ bnx2_enable_msix(struct bnx2 *bp, int msix_vecs)
 	}
 }
 
-static void
+static int
 bnx2_setup_int_mode(struct bnx2 *bp, int dis_msi)
 {
 	int cpus = num_online_cpus();
@@ -6235,9 +6235,10 @@ bnx2_setup_int_mode(struct bnx2 *bp, int dis_msi)
 	}
 
 	bp->num_tx_rings = rounddown_pow_of_two(bp->irq_nvecs);
-	bp->dev->real_num_tx_queues = bp->num_tx_rings;
+	netif_set_real_num_tx_queues(bp->dev, bp->num_tx_rings);
 
 	bp->num_rx_rings = bp->irq_nvecs;
+	return netif_set_real_num_rx_queues(bp->dev, bp->num_rx_rings);
 }
 
 /* Called with rtnl_lock */
@@ -6252,7 +6253,9 @@ bnx2_open(struct net_device *dev)
 	bnx2_set_power_state(bp, PCI_D0);
 	bnx2_disable_int(bp);
 
-	bnx2_setup_int_mode(bp, disable_msi);
+	rc = bnx2_setup_int_mode(bp, disable_msi);
+	if (rc)
+		goto open_err;
 	bnx2_init_napi(bp);
 	bnx2_napi_enable(bp);
 	rc = bnx2_alloc_mem(bp);
diff --git a/drivers/net/bnx2.h b/drivers/net/bnx2.h
index 47b5e51..a5eae2c 100644
--- a/drivers/net/bnx2.h
+++ b/drivers/net/bnx2.h
@@ -44,6 +44,11 @@ static inline const char *netdev_name(const struct net_device *dev)
 	netdev_printk(KERN_ERR, dev, format, ##args)
 #endif
 
+static inline int netif_set_real_num_rx_queues(struct net_device *dev, int num)
+{
+	return 0;
+}
+
 /* Hardware data structures and register definitions automatically
  * generated from RTL code. Do not modify.
  */
-- 
1.6.4.GIT

