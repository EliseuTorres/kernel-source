From: Keith Busch <keith.busch@intel.com>
Date: Wed, 25 Jul 2012 16:05:18 -0600
Subject: NVMe: Fix nvme module init when nvme_major is set
Git-commit: 5c42ea1643a630060f9e71e06d3933d244970967
References: FATE#313627
Patch-Mainline: v3.7-rc1

register_blkdev returns 0 when given a valid major number.

Reported-by:Ross Zwisler <ross.zwisler@intel.com>
Signed-off-by: Keith Busch <keith.busch@intel.com>
Signed-off-by: Matthew Wilcox <matthew.r.wilcox@intel.com>
Acked-by: Hannes Reinecke <hare@suse.de>
---
 drivers/block/nvme.c |    6 ++++--
 1 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/block/nvme.c b/drivers/block/nvme.c
index b6014e7..344f1c8 100644
--- a/drivers/block/nvme.c
+++ b/drivers/block/nvme.c
@@ -1715,9 +1715,11 @@ static int __init nvme_init(void)
 	if (IS_ERR(nvme_thread))
 		return PTR_ERR(nvme_thread);
 
-	nvme_major = register_blkdev(nvme_major, "nvme");
-	if (nvme_major <= 0)
+	result = register_blkdev(nvme_major, "nvme");
+	if (result < 0)
 		goto kill_kthread;
+	else if (result > 0)
+	    nvme_major = result;
 
 	result = pci_register_driver(&nvme_driver);
 	if (result)
-- 
1.7.4.2

