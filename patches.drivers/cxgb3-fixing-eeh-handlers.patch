From ccdddf500f2b1b8e88ac8e3d4dfc15cce9f73886 Mon Sep 17 00:00:00 2001
From: Breno Leitao <leitao@linux.vnet.ibm.com>
Date: Thu, 10 Dec 2009 09:03:37 +0000
Subject: [PATCH] cxgb3: Fixing EEH handlers
References: bnc#578980
Patch-mainline: v2.6.33-rc2
    
After commit 4b77b0a2ba27d64f58f16d8d4d48d8319dda36ff ("PCI: Clear
saved_state after the state has been restored"), the EEH is not
working proplery on cxgb3.

This patch fixes it, always saving the PCI state after a recovery,
in order to allow further reoveries.

Signed-off-by: Breno Leitao <leitao@linux.vnet.ibm.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Brandon Philips <bphilips@suse.de>

---
 drivers/net/cxgb3/cxgb3_main.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

---

Backported to SLES11 SP1 (just line offset) by Andre Detsch <adetsch@br.ibm.com>
Orinal patch upstream commit id: ccdddf500f2b1b8e88ac8e3d4dfc15cce9f73886

Index: linux-2.6.32.8-0.0.0.3.1f53358/drivers/net/cxgb3/cxgb3_main.c
===================================================================
--- linux-2.6.32.8-0.0.0.3.1f53358.orig/drivers/net/cxgb3/cxgb3_main.c	2009-12-02 22:51:21.000000000 -0500
+++ linux-2.6.32.8-0.0.0.3.1f53358/drivers/net/cxgb3/cxgb3_main.c	2010-02-10 08:55:07.000000000 -0500
@@ -2850,6 +2850,7 @@
 	}
 	pci_set_master(adapter->pdev);
 	pci_restore_state(adapter->pdev);
+	pci_save_state(adapter->pdev);
 
 	/* Free sge resources */
 	t3_free_sge_resources(adapter);
