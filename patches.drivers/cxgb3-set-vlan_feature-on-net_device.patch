From: brenohl@br.ibm.com <brenohl@br.ibm.com>
Date: Wed Jul 18 09:29:08 2012 +0000
Subject: cxgb3: Set vlan_feature on net_device
Patch-mainline: Yes, v3.6-rc1
Git-commit: 1d962ecf1e8d42c09abac2f715239a592c9415de
References: bnc#776127, LTC#84260

cxgb3 interface has a bad performance when VLAN is set. On my current
setup, a PowerLinux 7R2, I am able to get around 7 Gbps on a TCP_STREAM
(8 instances, 4k message).
With this patch, I am able to reach 9.5 Gbps.

Signed-off-by: Breno Leitao <brenohl@br.ibm.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Acked-by: John L. Jolly <jjolly@suse.de>
---
 drivers/net/ethernet/chelsio/cxgb3/cxgb3_main.c |    4 ++++
 1 file changed, 4 insertions(+)

--- a/drivers/net/ethernet/chelsio/cxgb3/cxgb3_main.c
+++ b/drivers/net/ethernet/chelsio/cxgb3/cxgb3_main.c
@@ -3167,6 +3167,9 @@ static void cxgb3_init_iscsi_mac(struct
 	pi->iscsic.mac_addr[3] |= 0x80;
 }
 
+#define TSO_FLAGS (NETIF_F_TSO | NETIF_F_TSO6 | NETIF_F_TSO_ECN)
+#define VLAN_FEAT (NETIF_F_SG | NETIF_F_IP_CSUM | TSO_FLAGS | \
+			NETIF_F_IPV6_CSUM | NETIF_F_HIGHDMA)
 static int init_one(struct pci_dev *pdev, const struct pci_device_id *ent)
 {
 	int i, err, pci_using_dac = 0;
@@ -3280,6 +3283,7 @@ static int init_one(struct pci_dev *pdev
 		netdev->hw_features = NETIF_F_SG | NETIF_F_IP_CSUM |
 			NETIF_F_TSO | NETIF_F_RXCSUM | NETIF_F_HW_VLAN_RX;
 		netdev->features |= netdev->hw_features | NETIF_F_HW_VLAN_TX;
+		netdev->vlan_features |= netdev->features & VLAN_FEAT;
 		if (pci_using_dac)
 			netdev->features |= NETIF_F_HIGHDMA;
 
