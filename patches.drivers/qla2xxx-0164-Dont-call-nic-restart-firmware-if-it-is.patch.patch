From: Saurav Kashyap <saurav.kashyap@qlogic.com>
Date: Wed, 22 Aug 2012 14:21:15 -0400
Subject: [PATCH] [SCSI] qla2xxx: Dont call nic restart firmware if it is already active and running.
Git-commit: 711aa7f722821405125b2a3c6a3e6a3f275952bd
References: FATE#313901
Patch-Mainline: v3.7

Signed-off-by: Saurav Kashyap <saurav.kashyap@qlogic.com>
Signed-off-by: Chad Dupuis <chad.dupuis@qlogic.com>
Signed-off-by: James Bottomley <JBottomley@Parallels.com>
Acked-by: Hannes Reinecke <hare@suse.de>
---
 drivers/scsi/qla2xxx/qla_init.c |    8 ++++++++
 1 files changed, 8 insertions(+), 0 deletions(-)

diff --git a/drivers/scsi/qla2xxx/qla_init.c b/drivers/scsi/qla2xxx/qla_init.c
index 117338d..9b5e392 100644
--- a/drivers/scsi/qla2xxx/qla_init.c
+++ b/drivers/scsi/qla2xxx/qla_init.c
@@ -435,6 +435,7 @@ qla83xx_nic_core_fw_load(scsi_qla_host_t *vha)
 	int rval = QLA_SUCCESS;
 	struct qla_hw_data *ha = vha->hw;
 	uint32_t idc_major_ver, idc_minor_ver;
+	uint16_t config[4];
 
 	qla83xx_idc_lock(vha, 0);
 
@@ -486,6 +487,13 @@ qla83xx_nic_core_fw_load(scsi_qla_host_t *vha)
 	idc_minor_ver |= (QLA83XX_SUPP_IDC_MINOR_VERSION << (ha->portnum * 2));
 	qla83xx_wr_reg(vha, QLA83XX_IDC_MINOR_VERSION, idc_minor_ver);
 
+	if (ha->flags.nic_core_reset_owner) {
+		memset(config, 0, sizeof(config));
+		if (!qla81xx_get_port_config(vha, config))
+			qla83xx_wr_reg(vha, QLA83XX_IDC_DEV_STATE,
+			    QLA8XXX_DEV_READY);
+	}
+
 	rval = qla83xx_idc_state_handler(vha);
 
 exit:
-- 
1.7.4.2

