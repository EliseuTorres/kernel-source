From 9499473463628a1af4be5aea1ad8d35d3fd341b0 Mon Sep 17 00:00:00 2001
From: Takashi Iwai <tiwai@suse.de>
Date: Mon, 11 Jul 2011 11:36:44 +0200
Subject: [PATCH] ALSA: hda - Preserve input pin-ctl bits in HP-automute for VIA codec
Git-commit: 9499473463628a1af4be5aea1ad8d35d3fd341b0
Patch-mainline: 3.1-rc2
References: FATE#314310

For smart51 pins, we need to preserve the input pin-control bits at
auto-mute controls instead of overwriting zero or pin-out-only.
Otherwise the VREF won't be set properly when smart51 is disabled
again.

Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
 sound/pci/hda/patch_via.c |   14 +++++++++++---
 1 file changed, 11 insertions(+), 3 deletions(-)

--- a/sound/pci/hda/patch_via.c
+++ b/sound/pci/hda/patch_via.c
@@ -1509,10 +1509,18 @@ static void toggle_output_mutes(struct h
 				hda_nid_t *pins, bool mute)
 {
 	int i;
-	for (i = 0; i < num_pins; i++)
+	for (i = 0; i < num_pins; i++) {
+		unsigned int parm = snd_hda_codec_read(codec, pins[i], 0,
+					  AC_VERB_GET_PIN_WIDGET_CONTROL, 0);
+		if (parm & AC_PINCTL_IN_EN)
+			continue;
+		if (mute)
+			parm &= ~AC_PINCTL_OUT_EN;
+		else
+			parm |= AC_PINCTL_OUT_EN;
 		snd_hda_codec_write(codec, pins[i], 0,
-				    AC_VERB_SET_PIN_WIDGET_CONTROL,
-				    mute ? 0 : PIN_OUT);
+				    AC_VERB_SET_PIN_WIDGET_CONTROL, parm);
+	}
 }
 
 /* mute internal speaker if line-out is plugged */
