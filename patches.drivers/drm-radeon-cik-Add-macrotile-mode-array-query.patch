From: Michel Dänzer <michel.daenzer@amd.com>
Date: Mon Nov 18 18:26:00 2013 +0900
Subject: drm/radeon/cik: Add macrotile mode array query
Patch-mainline: Upstream/v3.13-rc1
Git-commit: 32f79a8a82b2ff6f1828b258da214869adc2a28c

References: bnc#927285
Signed-off-by: Egbert Eich <eich@suse.com>

This is required to properly calculate the tiling parameters
in userspace.

Signed-off-by: Michel Dänzer <michel.daenzer@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
---
 drivers/gpu/drm/radeon/cik.c    |    3 +++
 drivers/gpu/drm/radeon/radeon.h |    1 +
 2 files changed, 4 insertions(+)

--- linux-3.12-SLE12.orig/drivers/gpu/drm/radeon/cik.c
+++ linux-3.12-SLE12/drivers/gpu/drm/radeon/cik.c
@@ -1981,6 +1981,7 @@ static void cik_tiling_mode_table_init(s
 				gb_tile_moden = 0;
 				break;
 			}
+			rdev->config.cik.macrotile_mode_array[reg_offset] = gb_tile_moden;
 			WREG32(GB_MACROTILE_MODE0 + (reg_offset * 4), gb_tile_moden);
 		}
 	} else if (num_pipe_configs == 4) {
@@ -2327,6 +2328,7 @@ static void cik_tiling_mode_table_init(s
 				gb_tile_moden = 0;
 				break;
 			}
+			rdev->config.cik.macrotile_mode_array[reg_offset] = gb_tile_moden;
 			WREG32(GB_MACROTILE_MODE0 + (reg_offset * 4), gb_tile_moden);
 		}
 	} else if (num_pipe_configs == 2) {
@@ -2544,6 +2546,7 @@ static void cik_tiling_mode_table_init(s
 				gb_tile_moden = 0;
 				break;
 			}
+			rdev->config.cik.macrotile_mode_array[reg_offset] = gb_tile_moden;
 			WREG32(GB_MACROTILE_MODE0 + (reg_offset * 4), gb_tile_moden);
 		}
 	} else
--- linux-3.12-SLE12.orig/drivers/gpu/drm/radeon/radeon.h
+++ linux-3.12-SLE12/drivers/gpu/drm/radeon/radeon.h
@@ -1976,6 +1976,7 @@ struct cik_asic {
 
 	unsigned tile_config;
 	uint32_t tile_mode_array[32];
+	uint32_t macrotile_mode_array[16];
 };
 
 union radeon_asic_config {
