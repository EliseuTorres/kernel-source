From acbec814a27f233b5ddb88a1bcaa2ac20daf64e0 Mon Sep 17 00:00:00 2001
From: Jesse Barnes <jbarnes@virtuousgeek.org>
Date: Fri, 20 Sep 2013 11:29:32 -0700
Subject: [PATCH] drm/i915/vlv: add VLV specific clock_get function v3
Mime-version: 1.0
Content-type: text/plain; charset=UTF-8
Content-transfer-encoding: 8bit
Git-commit: acbec814a27f233b5ddb88a1bcaa2ac20daf64e0
Patch-mainline: 3.13-rc1
References: FATE#318416

Calculation is a little different than other platforms.

V2: update to use port_clock instead    rebase on top of Ville's changes
V3: update to new port_clock semantics - don't divide by    pixel_multiplier (Ville)

Reference: https://bugs.freedesktop.org/show_bug.cgi?id=67345
Signed-off-by: Jesse Barnes <jbarnes@virtuousgeek.org>
Reviewed-by: Ville Syrjälä <ville.syrjala@linux.intel.com>
Signed-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>

[this patch contains the diff between 3.12.6 stable fix to align the
 contents with the upstream code -- tiwai]

Acked-by: Takashi Iwai <tiwai@suse.de>

---
 drivers/gpu/drm/i915/intel_display.c |    7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

--- a/drivers/gpu/drm/i915/intel_display.c
+++ b/drivers/gpu/drm/i915/intel_display.c
@@ -5077,7 +5077,7 @@ static void vlv_crtc_clock_get(struct in
 	clock.vco = refclk * clock.m1 * clock.m2 / clock.n;
 	clock.dot = 2 * clock.vco / (clock.p1 * clock.p2);
 
-	pipe_config->adjusted_mode.clock = clock.dot / 10;
+	pipe_config->port_clock = clock.dot / 10;
 }
 
 static bool i9xx_get_pipe_config(struct intel_crtc *crtc,
@@ -5142,6 +5142,11 @@ static bool i9xx_get_pipe_config(struct
 						     DPLL_PORTB_READY_MASK);
 	}
 
+	if (IS_VALLEYVIEW(dev))
+		vlv_crtc_clock_get(crtc, pipe_config);
+	else
+		i9xx_crtc_clock_get(crtc, pipe_config);
+
 	return true;
 }
 
