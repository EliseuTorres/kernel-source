From c68efe21b420ab47cbc3d5bf247b04ae872f9a86 Mon Sep 17 00:00:00 2001
From: Oliver Neukum <oneukum@suse.de>
Patch-Mainline: v3.15
References: FATE#315595
Git-Commit: 14aec589327a6fc4035f5327d90ac5548f501c4c
Date: Tue, 11 Feb 2014 20:36:04 +0100
Subject: [PATCH 3/3] storage: accept some UAS devices if streams are
 unavailable

On some older XHCIs streams are not supported and the UAS driver
will fail at probe time. For those devices storage should try
to bind to UAS devices.
This patch adds a flag for stream support to HCDs and evaluates
it.

[Note: Sarah fixed a bug where the USB 2.0 root hub, not USB 3.0 root
hub would get marked as being able to support streams.]

Signed-off-by: Oliver Neukum <oliver@neukum.org>
Signed-off-by: Sarah Sharp <sarah.a.sharp@linux.intel.com>
Signed-off-by: Oliver Neukum <oneukum@suse.de>
Acked-by: Hans de Goede <hdegoede@redhat.com>
---
 drivers/usb/host/xhci-pci.c  | 2 +-
 drivers/usb/host/xhci-plat.c | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/usb/host/xhci-pci.c b/drivers/usb/host/xhci-pci.c
index 189ea77..52f2ad2 100644
--- a/drivers/usb/host/xhci-pci.c
+++ b/drivers/usb/host/xhci-pci.c
@@ -233,7 +233,7 @@ static int xhci_pci_probe(struct pci_dev *dev, const struct pci_device_id *id)
 		hcd_to_bus(xhci->shared_hcd)->root_hub->lpm_capable = 1;
 
 	if (HCC_MAX_PSA(xhci->hcc_params) >= 4)
-		hcd->can_do_streams = 1;
+		hcd->shared_hcd->can_do_streams = 1;
 
 	/* USB-2 and USB-3 roothubs initialized, allow runtime pm suspend */
 	pm_runtime_put_noidle(&dev->dev);
diff --git a/drivers/usb/host/xhci-plat.c b/drivers/usb/host/xhci-plat.c
index 6e328ec..ba35e0c 100644
--- a/drivers/usb/host/xhci-plat.c
+++ b/drivers/usb/host/xhci-plat.c
@@ -157,7 +157,7 @@ static int xhci_plat_probe(struct platform_device *pdev)
 	*((struct xhci_hcd **) xhci->shared_hcd->hcd_priv) = xhci;
 
 	if (HCC_MAX_PSA(xhci->hcc_params) >=4)
-		hcd->can_do_streams = 1;
+		hcd->shared_hcd->can_do_streams = 1;
 
 	ret = usb_add_hcd(xhci->shared_hcd, irq, IRQF_SHARED);
 	if (ret)
-- 
1.8.4.5

