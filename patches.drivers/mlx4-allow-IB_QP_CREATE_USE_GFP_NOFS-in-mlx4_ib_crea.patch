From: Michal Kubecek <mkubecek@suse.cz>
Date: Fri, 2 Aug 2013 11:48:44 +0200
Subject: mlx4: allow IB_QP_CREATE_USE_GFP_NOFS in mlx4_ib_create_qp()
Patch-mainline: Never, follow-up to a SLE specific fix
References: bnc#822433

SLE11-SP3 commit 5da7302e (mlx4: Use all GFP_NOFS calls during
the ipoib TX path when creating the QP) introduces new flag
IB_QP_CREATE_USE_GFP_NOFS but mlx4_ib_create_qp() checks create
flags against a fixed list not containing it.

Add IB_QP_CREATE_USE_GFP_NOFS into the list of allowed flags.

Signed-off-by: Michal Kubecek <mkubecek@suse.cz>
---
 drivers/infiniband/hw/mlx4/qp.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/drivers/infiniband/hw/mlx4/qp.c b/drivers/infiniband/hw/mlx4/qp.c
index ea59fc8..4166b8c 100644
--- a/drivers/infiniband/hw/mlx4/qp.c
+++ b/drivers/infiniband/hw/mlx4/qp.c
@@ -978,7 +978,8 @@ struct ib_qp *mlx4_ib_create_qp(struct ib_pd *pd,
 	 */
 	if (init_attr->create_flags & ~(MLX4_IB_QP_LSO |
 					MLX4_IB_QP_BLOCK_MULTICAST_LOOPBACK |
-					MLX4_IB_SRIOV_TUNNEL_QP | MLX4_IB_SRIOV_SQP))
+					MLX4_IB_SRIOV_TUNNEL_QP | MLX4_IB_SRIOV_SQP |
+					IB_QP_CREATE_USE_GFP_NOFS))
 		return ERR_PTR(-EINVAL);
 
 	if ((init_attr->create_flags & ~IB_QP_CREATE_USE_GFP_NOFS) &&
-- 
1.8.1.4

