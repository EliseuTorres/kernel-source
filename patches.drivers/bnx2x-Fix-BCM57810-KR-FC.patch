From: Yaniv Rosner <yanivr@broadcom.com>
Date: Wed, 4 Apr 2012 01:28:55 +0000
Subject: [PATCH 03/11] bnx2x: Fix BCM57810-KR FC
Patch-mainline: v3.4-rc2
Git-commit: ca05f29cf515ac4a8e162c8e0eee886727f5dcc7
References: bnc#769035

Fix 57810-KR flow-control handling link is achieved via CL37 AN.

Signed-off-by: Yaniv Rosner <yanivr@broadcom.com>
Signed-off-by: Eilon Greenstein <eilong@broadcom.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Yuval Mintz <yuvalmin@broadcom.com>
Acked-by: Benjamin Poirier <bpoirier@suse.de>
---
 drivers/net/bnx2x/bnx2x_link.c |   34 ++++++++++++++++++++++++++++++----
 drivers/net/bnx2x/bnx2x_reg.h  |    4 ++++
 2 files changed, 34 insertions(+), 4 deletions(-)

--- a/drivers/net/bnx2x/bnx2x_link.c
+++ b/drivers/net/bnx2x/bnx2x_link.c
@@ -3560,10 +3560,36 @@ static u8 bnx2x_ext_phy_resolve_fc(struc
 	else if (vars->link_status & LINK_STATUS_AUTO_NEGOTIATE_COMPLETE) {
 		ret = 1;
 		if (phy->type == PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM54618SE) {
-			bnx2x_cl22_read(bp, phy,
-					0x4, &ld_pause);
-			bnx2x_cl22_read(bp, phy,
-					0x5, &lp_pause);
+			bnx2x_cl22_read(bp, phy, 0x4, &ld_pause);
+			bnx2x_cl22_read(bp, phy, 0x5, &lp_pause);
+		} else if (CHIP_IS_E3(bp) && SINGLE_MEDIA_DIRECT(params)) {
+			u8 lane = bnx2x_get_warpcore_lane(phy, params);
+			u16 gp_status, gp_mask;
+			u32 val = MDIO_WC_REG_GP2_STATUS_GP_2_4;
+			bnx2x_cl45_read(bp, phy, MDIO_AN_DEVAD, val,
+					&gp_status);
+			gp_mask = (MDIO_WC_REG_GP2_STATUS_GP_2_4_CL73_AN_CMPL |
+				   MDIO_WC_REG_GP2_STATUS_GP_2_4_CL37_LP_AN_CAP)
+				   << lane;
+			if ((gp_status & gp_mask) == gp_mask) {
+				bnx2x_cl45_read(bp, phy, MDIO_AN_DEVAD,
+						MDIO_AN_REG_ADV_PAUSE,
+						&ld_pause);
+				bnx2x_cl45_read(bp, phy, MDIO_AN_DEVAD,
+						MDIO_AN_REG_LP_AUTO_NEG,
+						&lp_pause);
+			} else {
+				bnx2x_cl45_read(bp, phy, MDIO_AN_DEVAD,
+						MDIO_AN_REG_CL37_FC_LD,
+						&ld_pause);
+				bnx2x_cl45_read(bp, phy, MDIO_AN_DEVAD,
+						MDIO_AN_REG_CL37_FC_LP,
+						&lp_pause);
+				val = MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_BOTH;
+				ld_pause = ((ld_pause & val) << 3);
+				lp_pause = ((lp_pause & val) << 3);
+			}
+
 		} else {
 			bnx2x_cl45_read(bp, phy,
 					MDIO_AN_DEVAD,
--- a/drivers/net/bnx2x/bnx2x_reg.h
+++ b/drivers/net/bnx2x/bnx2x_reg.h
@@ -6908,6 +6908,10 @@ Theotherbitsarereservedandshouldbezero*/
 #define MDIO_WC_REG_GP2_STATUS_GP_2_2			0x81d2
 #define MDIO_WC_REG_GP2_STATUS_GP_2_3			0x81d3
 #define MDIO_WC_REG_GP2_STATUS_GP_2_4			0x81d4
+#define MDIO_WC_REG_GP2_STATUS_GP_2_4_CL73_AN_CMPL 0x1000
+#define MDIO_WC_REG_GP2_STATUS_GP_2_4_CL37_AN_CMPL 0x0100
+#define MDIO_WC_REG_GP2_STATUS_GP_2_4_CL37_LP_AN_CAP 0x0010
+#define MDIO_WC_REG_GP2_STATUS_GP_2_4_CL37_AN_CAP 0x1
 #define MDIO_WC_REG_UC_INFO_B0_DEAD_TRAP		0x81EE
 #define MDIO_WC_REG_UC_INFO_B1_VERSION			0x81F0
 #define MDIO_WC_REG_UC_INFO_B1_FIRMWARE_MODE		0x81F2
