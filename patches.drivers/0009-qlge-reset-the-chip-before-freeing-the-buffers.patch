From: Jitendra Kalsaria <jitendra.kalsaria@qlogic.com>
Date: Fri, 15 Oct 2010 23:01:59 -0700
Subject: [PATCH 09/14] qlge: reset the chip before freeing the buffers.
Git-commit: fe5f098055ed7f701bfb16f8f87378cf67de9a0e
Patch-mainline: v2.6.36-rc3

	Qlge is freeing the buffers before stopping the card DMA, and
	this can cause some severe error, as a EEH event on PPC.

	This patch just stop the card and then free the resources.

Signed-off-by: Jitendra Kalsaria <jitendra.kalsaria@qlogic.com>
Acked-by: Jeff Mahoney <jeffm@suse.com>
---
 drivers/net/qlge/qlge_main.c |    3 +--
 1 files changed, 1 insertions(+), 2 deletions(-)

diff --git a/drivers/net/qlge/qlge_main.c b/drivers/net/qlge/qlge_main.c
index 6052b65..5e05b85 100644
--- a/drivers/net/qlge/qlge_main.c
+++ b/drivers/net/qlge/qlge_main.c
@@ -3893,12 +3893,11 @@ static int ql_adapter_down(struct ql_adapter *qdev)
 	for (i = 0; i < qdev->rss_ring_count; i++)
 		netif_napi_del(&qdev->rx_ring[i].napi);
 
-	ql_free_rx_buffers(qdev);
-
 	status = ql_adapter_reset(qdev);
 	if (status)
 		QPRINTK(qdev, IFDOWN, ERR, "reset(func #%d) FAILED!\n",
 			qdev->func);
+	ql_free_rx_buffers(qdev);
 	return status;
 }
 
-- 
1.7.6.rc0.12.g2c6b5

