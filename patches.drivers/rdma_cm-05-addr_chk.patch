From: Sean Hefty <sean.hefty@intel.com>
Subject: ib/addr: verify source and destination address families match
References: FATE#311652,bnc#695605
Patch-mainline: torvalds/linux-2.6.git;a=commitdiff;h=d2e0886245aa9eebc1a4710c861d263b09eac493

Signed-of-by: Sean Hefty <sean.hefty@intel.com>
Acked-by: John Jolly <jjolly@suse.de>
---

 drivers/infiniband/core/addr.c |    6 ++++--
 1 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/infiniband/core/addr.c b/drivers/infiniband/core/addr.c
index ccc0f91..f5baf0b 100644
--- a/drivers/infiniband/core/addr.c
+++ b/drivers/infiniband/core/addr.c
@@ -461,8 +461,10 @@ int rdma_resolve_ip(struct rdma_addr_client *client,
 	if (!req)
 		return -ENOMEM;
 
-	if (src_addr)
-		memcpy(&req->src_addr, src_addr, ip_addr_size(src_addr));
+	if (src_addr->sa_family != dst_addr->sa_family)
+		return -EINVAL;
+
+	memcpy(&req->src_addr, src_addr, ip_addr_size(src_addr));
 	memcpy(&req->dst_addr, dst_addr, ip_addr_size(dst_addr));
 	req->addr = addr;
 	req->callback = callback;
