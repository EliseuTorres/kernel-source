From 50a5f70cee11636908711abd339f5c5933375a7d Mon Sep 17 00:00:00 2001
From: Johan Hovold <jhovold@gmail.com>
Date: Wed, 17 Mar 2010 23:06:02 +0100
Subject: USB: serial: clean up generic write start busy test
Patch-mainline: v2.6.35
Git-commit: 50a5f70cee11636908711abd339f5c5933375a7d

Submit write urb if it is not already in use and we have buffered data.

Signed-off-by: Johan Hovold <jhovold@gmail.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

---
 drivers/usb/serial/generic.c |   15 ++++-----------
 1 file changed, 4 insertions(+), 11 deletions(-)

--- a/drivers/usb/serial/generic.c
+++ b/drivers/usb/serial/generic.c
@@ -258,22 +258,15 @@ static int usb_serial_generic_write_star
 	int result;
 	int count;
 	unsigned long flags;
-	bool start_io;
 
-	/* Atomically determine whether we can and need to start a USB
-	 * operation. */
 	spin_lock_irqsave(&port->lock, flags);
-	if (port->write_urb_busy)
-		start_io = false;
-	else {
-		start_io = (kfifo_len(port->write_fifo) != 0);
-		port->write_urb_busy = start_io;
+	if (port->write_urb_busy || !kfifo_len(port->write_fifo)) {
+		spin_unlock_irqrestore(&port->lock, flags);
+		return 0;
 	}
+	port->write_urb_busy = 1;
 	spin_unlock_irqrestore(&port->lock, flags);
 
-	if (!start_io)
-		return 0;
-
 	data = port->write_urb->transfer_buffer;
 	count = kfifo_out_locked(port->write_fifo, data, port->bulk_out_size, &port->lock);
 	usb_serial_debug_data(debug, &port->dev, __func__, count, data);
