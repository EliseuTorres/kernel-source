From: Michael S. Tsirkin <mst@redhat.com>
Subject: [PATCH] vhost: apply cgroup to vhost workers
References: FATE#311977
Git-commit: 9e3d195720d1c8b1e09013185ab8c3b749180fc2
Patch-mainline: v2.6.35

Apply the cgroup of the owner task to the created vhost worker.

Based on patches from Sridhar Samudrala's and Tejun Heo.
Later we'll need to also apply cpumask and probably priority
of the owner process.

Discussion on the best way to do this is still ongoing.

Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
Cc: Tejun Heo <tj@kernel.org>
Cc: Sridhar Samudrala <samudrala.sridhar@gmail.com>
Cc: Li Zefan <lizf@cn.fujitsu.com>
Acked-by: Bruce Rogers <brogers@suse.com>
---
 drivers/vhost/vhost.c |    6 ++++++
 1 file changed, 6 insertions(+)

Index: b/drivers/vhost/vhost.c
===================================================================
--- a/drivers/vhost/vhost.c
+++ b/drivers/vhost/vhost.c
@@ -23,6 +23,7 @@
 #include <linux/highmem.h>
 #include <linux/slab.h>
 #include <linux/kthread.h>
+#include <linux/cgroup.h>
 
 #include <linux/net.h>
 #include <linux/if_packet.h>
@@ -253,9 +254,14 @@ static long vhost_dev_set_owner(struct v
 	}
 
 	dev->worker = worker;
+	err = cgroup_attach_task_current_cg(worker);
+	if (err)
+		goto err_cgroup;
 	wake_up_process(worker);	/* avoid contributing to loadavg */
 
 	return 0;
+err_cgroup:
+	kthread_stop(worker);
 err_worker:
 	if (dev->mm)
 		mmput(dev->mm);
