From d3f1cbe8d5a870dc1fc9d4672b702c07e44bb2c7 Mon Sep 17 00:00:00 2001
From: Ron Mercer <ron.mercer@qlogic.com>
Date: Thu, 18 Feb 2010 12:35:20 -0800
Subject: [PATCH] qlge: Fix bonding mac address bug.
References: bnc#581188
Patch-mainline: Submitted Feb 17 2010 - net-next-2.6
Git-commit: 801e9096c566d40d2e7c9903dc902fa01a5a0b36
Git-repo: git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next-2.6.git

Use local copy of current mac address when initializing.  In bonding
testing we saw cases where dev_addr was out of data causing failover
errors.

Signed-off-by: Brandon Philips <bphilips@suse.de>

---
 drivers/net/qlge/qlge.h      |    2 ++
 drivers/net/qlge/qlge_main.c |    6 +++++-
 2 files changed, 7 insertions(+), 1 deletion(-)

Index: linux-2.6.32-SLE11-SP1/drivers/net/qlge/qlge.h
===================================================================
--- linux-2.6.32-SLE11-SP1.orig/drivers/net/qlge/qlge.h
+++ linux-2.6.32-SLE11-SP1/drivers/net/qlge/qlge.h
@@ -2145,6 +2145,8 @@ struct ql_adapter {
 	struct nic_operations *nic_ops;
 	u16 device_id;
 	atomic_t lb_count;
+	/* Keep local copy of current mac address. */
+	char current_mac_addr[6];
 };
 
 /*
Index: linux-2.6.32-SLE11-SP1/drivers/net/qlge/qlge_main.c
===================================================================
--- linux-2.6.32-SLE11-SP1.orig/drivers/net/qlge/qlge_main.c
+++ linux-2.6.32-SLE11-SP1/drivers/net/qlge/qlge_main.c
@@ -462,7 +462,7 @@ static int ql_set_mac_addr(struct ql_ada
 	char *addr;
 
 	if (set) {
-		addr = &qdev->ndev->dev_addr[0];
+		addr = &qdev->current_mac_addr[0];
 		QPRINTK(qdev, IFUP, DEBUG,
 			"Set Mac addr %pM\n", addr);
 	} else {
@@ -4258,6 +4258,8 @@ static int qlge_set_mac_address(struct n
 	if (!is_valid_ether_addr(addr->sa_data))
 		return -EADDRNOTAVAIL;
 	memcpy(ndev->dev_addr, addr->sa_data, ndev->addr_len);
+	/* Update local copy of current mac address. */
+	memcpy(qdev->current_mac_addr, ndev->dev_addr, ndev->addr_len);
 
 	status = ql_sem_spinlock(qdev, SEM_MAC_ADDR_MASK);
 	if (status)
@@ -4499,6 +4501,8 @@ static int __devinit ql_init_device(stru
 	}
 
 	memcpy(ndev->perm_addr, ndev->dev_addr, ndev->addr_len);
+	/* Keep local copy of current mac address. */
+	memcpy(qdev->current_mac_addr, ndev->dev_addr, ndev->addr_len);
 
 	/* Set up the default ring sizes. */
 	qdev->tx_ring_size = NUM_TX_RING_ENTRIES;
