From: James Smart <james.smart@emulex.com>
Date:   Tue Aug 14 14:26:28 2012 -0400
Subject: [SCSI] lpfc 8.3.34: Correct lock handling to eliminate reset escalation on I/O abort
Git-commit: 92e3af663ab6ef7db888f3d3ffb7568fab870127
Patch-mainline: v3.6-rc2-64-g92e3af6
References: bnc#793593

[SCSI] lpfc 8.3.34: Correct lock handling to eliminate reset escalation on I/O abort

Acked-by: Ankit Jain <jankit@suse.de>
Signed-off-by: James Smart <james.smart@emulex.com>
Signed-off-by: James Bottomley <JBottomley@Parallels.com>


---
 drivers/scsi/lpfc/lpfc_scsi.c |   12 +++++++++---
 1 file changed, 9 insertions(+), 3 deletions(-)

Index: b/drivers/scsi/lpfc/lpfc_scsi.c
===================================================================
--- a/drivers/scsi/lpfc/lpfc_scsi.c
+++ b/drivers/scsi/lpfc/lpfc_scsi.c
@@ -2636,12 +2636,15 @@ lpfc_scsi_cmd_iocb_cmpl(struct lpfc_hba
 	cmd->scsi_done(cmd);
 
 	if (phba->cfg_poll & ENABLE_FCP_RING_POLLING) {
+		spin_lock_irq(&phba->hbalock);
+		lpfc_cmd->pCmd = NULL;
+		spin_unlock_irq(&phba->hbalock);
+
 		/*
 		 * If there is a thread waiting for command completion
 		 * wake up the thread.
 		 */
 		spin_lock_irqsave(shost->host_lock, flags);
-		lpfc_cmd->pCmd = NULL;
 		if (lpfc_cmd->waitq)
 			wake_up(lpfc_cmd->waitq);
 		spin_unlock_irqrestore(shost->host_lock, flags);
@@ -2675,12 +2678,15 @@ lpfc_scsi_cmd_iocb_cmpl(struct lpfc_hba
 		}
 	}
 
+	spin_lock_irq(&phba->hbalock);
+	lpfc_cmd->pCmd = NULL;
+	spin_unlock_irq(&phba->hbalock);
+
 	/*
 	 * If there is a thread waiting for command completion
 	 * wake up the thread.
 	 */
 	spin_lock_irqsave(shost->host_lock, flags);
-	lpfc_cmd->pCmd = NULL;
 	if (lpfc_cmd->waitq)
 		wake_up(lpfc_cmd->waitq);
 	spin_unlock_irqrestore(shost->host_lock, flags);
@@ -3241,7 +3247,7 @@ lpfc_abort_handler(struct scsi_cmnd *cmn
 		return status;
 
 	lpfc_cmd = (struct lpfc_scsi_buf *)cmnd->host_scribble;
-	if (!lpfc_cmd) {
+	if (!lpfc_cmd || !lpfc_cmd->pCmd) {
 		lpfc_printf_vlog(vport, KERN_WARNING, LOG_FCP,
 			 "2873 SCSI Layer I/O Abort Request IO CMPL Status "
 			 "x%x ID %d "
