From: Anton Blanchard <anton@samba.org>
Subject: powerpc/eeh: Fix oops when probing in early boot
Patch-mainline: ce47c1c45b2b17ad07af82c775f27cc5196080f8
References: bnc#677391

We called rtas_set_slot_reset while scanning the bus and before the pci_dn
to pcidev mapping has been created. Since we only need the pcidev to work
out the type of reset and that only gets set after the module for the
device loads, lets just do a hot reset if the pcidev is NULL.

Signed-off-by: Anton Blanchard <anton@samba.org>
Acked-by: Linas Vepstas <linasvepstas@gmail.com>
Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
Acked-by: Torsten Duwe <duwe@suse.de>

--- linux/arch/powerpc/platforms/pseries/eeh.c	2011-02-24 18:54:16.000000000 -0600
+++ linux/arch/powerpc/platforms/pseries/eeh.c	2011-02-16 18:54:42.000000000 -0600
@@ -749,7 +749,7 @@ static void __rtas_set_slot_reset(struct
 	/* Determine type of EEH reset required by device,
 	 * default hot reset or fundamental reset
 	 */
-	if (dev->needs_freset)
+	if (dev && dev->needs_freset)
 		rtas_pci_slot_reset(pdn, 3);
 	else
 		rtas_pci_slot_reset(pdn, 1);
