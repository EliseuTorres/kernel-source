From: Nicholas Bellinger <nab@linux-iscsi.org>
Date: Fri, 14 Nov 2014 17:27:19 -0600
Subject: hpsa: Convert SCSI LLD ->queuecommand() for host_lock less operation
Git-commit: 763aadbf5015e86e93d209f10e34fd4daacc459b
Patch-mainline: v3.19-rc1
References: bsc#942743

There isn't anything in hpsa that requires the host lock to be held
during queuecommand.

Signed-off-by: Don Brace <don.brace@pmcs.com>
Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
Reviewed-by: Stephen M. Cameron <stephenmcameron@gmail.com>
Signed-off-by: Christoph Hellwig <hch@lst.de>
Acked-by: Johannes Thumshirn <jthumshirn@suse.com>
---
 drivers/scsi/hpsa.c |   16 +++++++---------
 1 file changed, 7 insertions(+), 9 deletions(-)

--- a/drivers/scsi/hpsa.c
+++ b/drivers/scsi/hpsa.c
@@ -3901,8 +3901,11 @@ static int hpsa_scsi_ioaccel_raid_map(st
 						dev->scsi3addr);
 }
 
-static int hpsa_scsi_queue_command_lck(struct scsi_cmnd *cmd,
-	void (*done)(struct scsi_cmnd *))
+/*
+ * Running in struct Scsi_Host->host_lock less mode using LLD internal
+ * struct ctlr_info *h->lock w/ spin_lock_irqsave() protection.
+ */
+static int hpsa_scsi_queue_command(struct Scsi_Host *sh, struct scsi_cmnd *cmd)
 {
 	struct ctlr_info *h;
 	struct hpsa_scsi_dev_t *dev;
@@ -3916,7 +3919,7 @@ static int hpsa_scsi_queue_command_lck(s
 	dev = cmd->device->hostdata;
 	if (!dev) {
 		cmd->result = DID_NO_CONNECT << 16;
-		done(cmd);
+		cmd->scsi_done(cmd);
 		return 0;
 	}
 	memcpy(scsi3addr, dev->scsi3addr, sizeof(scsi3addr));
@@ -3925,7 +3928,7 @@ static int hpsa_scsi_queue_command_lck(s
 	if (unlikely(h->lockup_detected)) {
 		spin_unlock_irqrestore(&h->lock, flags);
 		cmd->result = DID_ERROR << 16;
-		done(cmd);
+		cmd->scsi_done(cmd);
 		return 0;
 	}
 	spin_unlock_irqrestore(&h->lock, flags);
@@ -3936,9 +3939,6 @@ static int hpsa_scsi_queue_command_lck(s
 	}
 
 	/* Fill in the command list header */
-
-	cmd->scsi_done = done;    /* save this for use by completion code */
-
 	/* save c in case we have to abort it  */
 	cmd->host_scribble = (unsigned char *) c;
 
@@ -4029,8 +4029,6 @@ static int hpsa_scsi_queue_command_lck(s
 	return 0;
 }
 
-static DEF_SCSI_QCMD(hpsa_scsi_queue_command)
-
 static int do_not_scan_if_controller_locked_up(struct ctlr_info *h)
 {
 	unsigned long flags;
