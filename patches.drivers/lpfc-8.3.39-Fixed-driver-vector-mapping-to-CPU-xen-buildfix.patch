From: Jiri Kosina <jkosina@suse.cz>
Subject: x86: lpfc: fix Xen build due to different struct cpuinfo_x86
Patch-mainline: never

patches.drivers/lpfc-8.3.39-Fixed-driver-vector-mapping-to-CPU-.patch breaks
Xen build, as Xen's struct cpuinfo_x86 doesn't have core ID and physical ID
fields.

Signed-off-by: Jiri Kosina <jkosina@suse.cz>

Index: linux-3.0-SLE11-SP4/drivers/scsi/lpfc/lpfc_init.c
===================================================================
--- linux-3.0-SLE11-SP4.orig/drivers/scsi/lpfc/lpfc_init.c	2015-01-16 14:51:18.264233986 +0100
+++ linux-3.0-SLE11-SP4/drivers/scsi/lpfc/lpfc_init.c	2015-01-16 14:51:46.461606267 +0100
@@ -8407,9 +8407,6 @@
 	int i, idx, saved_chann, used_chann, cpu, phys_id;
 	int max_phys_id, num_io_channel, first_cpu;
 	struct lpfc_vector_map_info *cpup;
-#ifdef CONFIG_X86
-	struct cpuinfo_x86 *cpuinfo;
-#endif
 	struct cpumask *mask;
 	uint8_t chann[LPFC_FCP_IO_CHAN_MAX+1];
 
@@ -8430,7 +8427,8 @@
 	/* Update CPU map with physical id and core id of each CPU */
 	cpup = phba->sli4_hba.cpu_map;
 	for (cpu = 0; cpu < phba->sli4_hba.num_present_cpu; cpu++) {
-#ifdef CONFIG_X86
+#if defined(CONFIG_X86) && !defined(CONFIG_XEN)
+		const struct cpuinfo_x86 *cpuinfo = &cpu_data(cpu);
 		cpuinfo = &cpu_data(cpu);
 		cpup->phys_id = cpuinfo->phys_proc_id;
 		cpup->core_id = cpuinfo->cpu_core_id;
