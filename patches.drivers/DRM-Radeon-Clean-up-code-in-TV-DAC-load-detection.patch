From: Egbert Eich <eich@suse.de>
Date: Tue Oct 30 17:42:26 2012 +0100
Subject: DRM/Radeon: Clean up code in TV DAC load detection.
Patch-Mainline: Upstream
Git-commit: d038db86984977646815fff54c1be11bff6b9f5b
Git-repo: git://people.freedesktop.org/~airlied/linux/
References: bnc #725152
Signed-off-by: Egbert Eich <eich@suse.de>

Signed-off-by: Egbert Eich <eich@suse.de>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
---
 drivers/gpu/drm/radeon/radeon_legacy_encoders.c |   18 ++++++++++--------
 1 file changed, 10 insertions(+), 8 deletions(-)

--- a.orig/drivers/gpu/drm/radeon/radeon_legacy_encoders.c
+++ b/drivers/gpu/drm/radeon/radeon_legacy_encoders.c
@@ -1404,7 +1404,8 @@ static enum drm_connector_status radeon_
 	struct drm_device *dev = encoder->dev;
 	struct radeon_device *rdev = dev->dev_private;
 	uint32_t crtc2_gen_cntl, tv_dac_cntl, dac_cntl2, dac_ext_cntl;
-	uint32_t disp_hw_debug, disp_output_cntl, gpiopad_a, pixclks_cntl, tmp;
+	uint32_t gpiopad_a = 0, pixclks_cntl, tmp;
+	uint32_t disp_output_cntl = 0, disp_hw_debug = 0;
 	enum drm_connector_status found = connector_status_disconnected;
 	struct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);
 	struct radeon_encoder_tv_dac *tv_dac = radeon_encoder->enc_priv;
@@ -1443,9 +1444,12 @@ static enum drm_connector_status radeon_
 
 	/* save the regs we need */
 	pixclks_cntl = RREG32_PLL(RADEON_PIXCLKS_CNTL);
-	gpiopad_a = ASIC_IS_R300(rdev) ? RREG32(RADEON_GPIOPAD_A) : 0;
-	disp_output_cntl = ASIC_IS_R300(rdev) ? RREG32(RADEON_DISP_OUTPUT_CNTL) : 0;
-	disp_hw_debug = ASIC_IS_R300(rdev) ? 0 : RREG32(RADEON_DISP_HW_DEBUG);
+	if (ASIC_IS_R300(rdev)) {
+		gpiopad_a = RREG32(RADEON_GPIOPAD_A);
+		disp_output_cntl = RREG32(RADEON_DISP_OUTPUT_CNTL);
+	} else {
+		disp_hw_debug = RREG32(RADEON_DISP_HW_DEBUG);
+	}
 	crtc2_gen_cntl = RREG32(RADEON_CRTC2_GEN_CNTL);
 	tv_dac_cntl = RREG32(RADEON_TV_DAC_CNTL);
 	dac_ext_cntl = RREG32(RADEON_DAC_EXT_CNTL);
@@ -1455,16 +1459,13 @@ static enum drm_connector_status radeon_
 			       | RADEON_PIX2CLK_DAC_ALWAYS_ONb);
 	WREG32_PLL(RADEON_PIXCLKS_CNTL, tmp);
 
-	if (ASIC_IS_R300(rdev))
-		WREG32_P(RADEON_GPIOPAD_A, 1, ~1);
-
 	tmp = crtc2_gen_cntl & ~RADEON_CRTC2_PIX_WIDTH_MASK;
 	tmp |= RADEON_CRTC2_CRT2_ON |
 		(2 << RADEON_CRTC2_PIX_WIDTH_SHIFT);
-
 	WREG32(RADEON_CRTC2_GEN_CNTL, tmp);
 
 	if (ASIC_IS_R300(rdev)) {
+		WREG32_P(RADEON_GPIOPAD_A, 1, ~1);
 		tmp = disp_output_cntl & ~RADEON_DISP_TVDAC_SOURCE_MASK;
 		tmp |= RADEON_DISP_TVDAC_SOURCE_CRTC2;
 		WREG32(RADEON_DISP_OUTPUT_CNTL, tmp);
@@ -1520,6 +1521,7 @@ static enum drm_connector_status radeon_
 	} else {
 		WREG32(RADEON_DISP_HW_DEBUG, disp_hw_debug);
 	}
+
 	WREG32_PLL(RADEON_PIXCLKS_CNTL, pixclks_cntl);
 
 	return found;
