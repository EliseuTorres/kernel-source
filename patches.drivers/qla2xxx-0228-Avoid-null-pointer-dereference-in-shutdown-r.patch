From: Masanari Iida <standby24x7@gmail.com>
Date: Wed, 21 Nov 2012 09:15:03 +0530
Subject: qla2xxx: Avoid null pointer dereference in shutdown routine.
References: FATE#313901,bnc#801745
Patch-Mainline: submitted to linux-scsi


Acked-by: Hannes Reinecke <hare@suse.de>
---
 drivers/scsi/qla2xxx/qla_os.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/drivers/scsi/qla2xxx/qla_os.c b/drivers/scsi/qla2xxx/qla_os.c
index ad3b00e..4585a86 100644
--- a/drivers/scsi/qla2xxx/qla_os.c
+++ b/drivers/scsi/qla2xxx/qla_os.c
@@ -2803,6 +2803,9 @@ qla2x00_shutdown(struct pci_dev *pdev)
 	scsi_qla_host_t *vha;
 	struct qla_hw_data  *ha;
 
+	if (!atomic_read(&pdev->enable_cnt))
+		return;
+
 	vha = pci_get_drvdata(pdev);
 	ha = vha->hw;
 
-- 
1.7.4.2

