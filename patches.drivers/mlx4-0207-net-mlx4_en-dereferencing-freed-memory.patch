From: Dan Carpenter <dan.carpenter@oracle.com>
Date: Tue, 10 Jul 2012 20:34:07 +0000
Subject: net/mlx4_en: dereferencing freed memory
Patch-mainline: v3.6-rc1
Git-commit: 9c64508af2c171f57a198729c59a7a6f6998b3a1
References: bnc#786036 FATE#314304

We dereferenced "mclist" after the kfree().

Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Amir Vadai <amirv@mellanox.com>
Acked-by: Benjamin Poirier <bpoirier@suse.de>
---
 drivers/net/ethernet/mellanox/mlx4/en_netdev.c |    4 +---
 1 file changed, 1 insertion(+), 3 deletions(-)
--- a/drivers/net/ethernet/mellanox/mlx4/en_netdev.c
+++ b/drivers/net/ethernet/mellanox/mlx4/en_netdev.c
@@ -500,9 +500,7 @@ static void mlx4_en_do_set_multicast(str
 				/* remove from list */
 				list_del(&mclist->list);
 				kfree(mclist);
-			}
-
-			if (mclist->action == MCLIST_ADD) {
+			} else if (mclist->action == MCLIST_ADD) {
 				/* attach the address */
 				memcpy(&mc_list[10], mclist->addr, ETH_ALEN);
 				/* needed for B0 steering support */
