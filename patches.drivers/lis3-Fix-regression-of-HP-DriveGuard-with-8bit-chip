From: Takashi Iwai <tiwai@suse.de>
Subject: [PATCH] lis3: Fix regression of HP DriveGuard with 8bit chip
Patch-mainline: Submitted
References: bnc#721212

The commit 2a7fade7e03a7c773f91e2e5ff26ad6fafda5a9f
    hwmon: lis3: Power on corrections
caused a regression on HP laptops with 8bit chip.
Writing CTRL2_BOOT_8B bit seems clearing the BIOS setup, and no proper
interrupt for DriveGuard will be triggered any more.

Since the init code there is basically only for embedded devices,
put pdata check so that the problematic initialization will be
skipped for hp_accel stuff.

Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
 drivers/misc/lis3lv02d/lis3lv02d.c |   14 ++++++++------
 1 files changed, 8 insertions(+), 6 deletions(-)

diff --git a/drivers/misc/lis3lv02d/lis3lv02d.c b/drivers/misc/lis3lv02d/lis3lv02d.c
index b928bc1..8b51cd6 100644
--- a/drivers/misc/lis3lv02d/lis3lv02d.c
+++ b/drivers/misc/lis3lv02d/lis3lv02d.c
@@ -375,12 +375,14 @@ void lis3lv02d_poweron(struct lis3lv02d *lis3)
 	 *      both have been read. So the value read will always be correct.
 	 * Set BOOT bit to refresh factory tuning values.
 	 */
-	lis3->read(lis3, CTRL_REG2, &reg);
-	if (lis3->whoami ==  WAI_12B)
-		reg |= CTRL2_BDU | CTRL2_BOOT;
-	else
-		reg |= CTRL2_BOOT_8B;
-	lis3->write(lis3, CTRL_REG2, reg);
+	if (lis3->pdata) {
+		lis3->read(lis3, CTRL_REG2, &reg);
+		if (lis3->whoami ==  WAI_12B)
+			reg |= CTRL2_BDU | CTRL2_BOOT;
+		else
+			reg |= CTRL2_BOOT_8B;
+		lis3->write(lis3, CTRL_REG2, reg);
+	}
 
 	/* LIS3 power on delay is quite long */
 	msleep(lis3->pwron_delay / lis3lv02d_get_odr());
-- 
1.7.6.4

