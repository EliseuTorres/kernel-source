From 70fb1d314b9575c6a522b77887ce059a226e777d Mon Sep 17 00:00:00 2001
From: Vladislav Zolotarov <vladz@broadcom.com>
Date: Sun, 24 Jul 2011 19:34:23 +0300
Subject: [PATCH 6/6] bnx2x: configure silent stripping for a VID0 VLAN tag
References: bnc#698050
Patch-mainline: Never, backport


Signed-off-by: Vladislav Zolotarov <vladz@broadcom.com>
Signed-off-by: Eilon Greenstein <eilong@broadcom.com>
Acked-by: Jeff Mahoney <jeffm@suse.com>
---
 drivers/net/bnx2x/bnx2x_main.c |   11 +++++++++++
 1 files changed, 11 insertions(+), 0 deletions(-)

diff --git a/drivers/net/bnx2x/bnx2x_main.c b/drivers/net/bnx2x/bnx2x_main.c
index a57e1ca..b268b29 100644
--- a/drivers/net/bnx2x/bnx2x_main.c
+++ b/drivers/net/bnx2x/bnx2x_main.c
@@ -2663,6 +2663,9 @@ static inline unsigned long bnx2x_get_q_flags(struct bnx2x *bp,
 	if (bp->vlgrp)
 		__set_bit(BNX2X_Q_FLG_VLAN, &flags);
 
+	/* configure silent vlan removal */
+	__set_bit(BNX2X_Q_FLG_SILENT_VLAN_REM, &flags);
+
 	return flags;
 }
 
@@ -2745,6 +2748,14 @@ static void bnx2x_pf_rx_q_prep(struct bnx2x *bp,
 		rxq_init->sb_cq_index = HC_SP_INDEX_ETH_FCOE_RX_CQ_CONS;
 	else
 		rxq_init->sb_cq_index = U_SB_ETH_RX_CQ_INDEX;
+
+	if (IS_FCOE_FP(fp)) {
+		rxq_init->silent_removal_value = 0;
+		rxq_init->silent_removal_mask = VLAN_VID_MASK;
+	} else {
+		rxq_init->silent_removal_value = 0;
+		rxq_init->silent_removal_mask = VLAN_PRIO_MASK | VLAN_VID_MASK;
+	}
 }
 
 static void bnx2x_pf_tx_q_prep(struct bnx2x *bp,
-- 
1.7.4.1


