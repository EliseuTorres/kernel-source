From 1be6caff07caef68b476b596b87c048b2481e441 Mon Sep 17 00:00:00 2001
From: "Yan, Zheng" <zheng.z.yan@intel.com>
Date: Sun, 23 Mar 2014 06:50:39 +0800
Subject: [PATCH 070/213] libceph: fix oops in
 ceph_msg_data_{pages,pagelist}_advance()
References: fate#318918
Git-commit: d90deda69cb82411ba7d990e97218e0f8b2d07bb
Patch-mainline: v3.15-rc5

When there is no more data, ceph_msg_data_{pages,pagelist}_advance()
should not move on to the next page.

Signed-off-by: Yan, Zheng <zheng.z.yan@intel.com>
Acked-by: David Disseldorp <ddiss@suse.de>

---
 net/ceph/messenger.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/net/ceph/messenger.c b/net/ceph/messenger.c
index 45f28e7..3d581fc 100644
--- a/net/ceph/messenger.c
+++ b/net/ceph/messenger.c
@@ -946,6 +946,9 @@ static bool ceph_msg_data_pages_advance(struct ceph_msg_data_cursor *cursor,
 	if (!bytes || cursor->page_offset)
 		return false;	/* more bytes to process in the current page */
 
+	if (!cursor->resid)
+		return false;   /* no more data */
+
 	/* Move on to the next page; offset is already at 0 */
 
 	BUG_ON(cursor->page_index >= cursor->page_count);
@@ -1031,6 +1034,9 @@ static bool ceph_msg_data_pagelist_advance(struct ceph_msg_data_cursor *cursor,
 	if (!bytes || cursor->offset & ~PAGE_MASK)
 		return false;	/* more bytes to process in the current page */
 
+	if (!cursor->resid)
+		return false;   /* no more data */
+
 	/* Move on to the next page */
 
 	BUG_ON(list_is_last(&cursor->page->lru, &pagelist->head));
-- 
2.1.4

