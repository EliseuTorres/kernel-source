From: Majd Dibbiny <majd@mellanox.com>
Date: Tue, 6 Jan 2015 13:56:01 +0200
Subject: [PATCH 112/117] IB/mlx5: Update the dev in reg_create
Patch-mainline: v4.0-rc1
Git-commit: 7eae20db6adf721d0c14ad2a37208278ce4f11dc
References: bsc#923036 FATE#318772

When we create an MR using reg_create, the mlx5_ib_dev pointer is not
updated on the new MR. This results in a kernel panics for ODP MRs
while handling page faults, when the mlx5_ib_update_mtt function uses
the invalid device pointer.

Signed-off-by: Majd Dibbiny <majd@mellanox.com>
Signed-off-by: Haggai Eran <haggaie@mellanox.com>
Signed-off-by: Roland Dreier <roland@purestorage.com>
Signed-off-by: Hadar Hen Zion <hadarh@mellanox.com>
Acked-by: Cho, Yu-Chen <acho@suse.com>
---
 drivers/infiniband/hw/mlx5/mr.c |    1 +
 1 file changed, 1 insertion(+)

--- a/drivers/infiniband/hw/mlx5/mr.c
+++ b/drivers/infiniband/hw/mlx5/mr.c
@@ -858,6 +858,7 @@ static struct mlx5_ib_mr *reg_create(str
 		goto err_2;
 	}
 	mr->umem = umem;
+	mr->dev = dev;
 	kvfree(in);
 
 	mlx5_ib_dbg(dev, "mkey = 0x%x\n", mr->mmr.key);
