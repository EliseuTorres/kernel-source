From: Ben Hutchings <bhutchings@solarflare.com>
Date: Tue, 6 Sep 2011 13:52:47 +0000
Subject: ethtool: Update ethtool_rxnfc::rule_cnt on return from
 ETHTOOL_GRXCLSRLALL
Patch-mainline: v3.2-rc1
Git-commit: 473e64ee4603671efa1e0785418e56e9ffdfc47b (partial)
References: bnc#786035 FATE#314299

A user-space process must use ETHTOOL_GRXCLSRLCNT to find the number
of classification rules, then allocate a buffer of the right size,
then use ETHTOOL_GRXCLSRLALL to fill the buffer.  If some other
process inserts or deletes a rule between those two operations,
the user buffer might turn out to be the wrong size.

If it's too small, the return value will be -EMSGSIZE.  But if it's
too large, there is no indication of this.  Fix this by updating
the rule_cnt field on return.

Signed-off-by: Ben Hutchings <bhutchings@solarflare.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[bwh: Backported to SLE11 SP3:
 - Adjust filenames
 - Drop change to gianfar, which doesn't implement RX NFC
 - Include the comment change from commit 815c7db5c809
   ('ethtool: Clean up definitions of rule location arrays in RX NFC')]
Acked-by: Benjamin Poirier <bpoirier@suse.de>
---
 drivers/net/niu.c       |    2 ++
 include/linux/ethtool.h |    5 +++--
 2 files changed, 5 insertions(+), 2 deletions(-)

--- a/drivers/net/niu.c
+++ b/drivers/net/niu.c
@@ -7296,6 +7296,8 @@ static int niu_get_ethtool_tcam_all(stru
 	}
 	niu_unlock_parent(np, flags);
 
+	nfc->rule_cnt = cnt;
+
 	return ret;
 }
 
--- a/include/linux/ethtool.h
+++ b/include/linux/ethtool.h
@@ -496,8 +496,9 @@ struct ethtool_rx_flow_spec {
  *
  * For %ETHTOOL_GRXCLSRLALL, @rule_cnt specifies the array size of the
  * user buffer for @rule_locs on entry.  On return, @data is the size
- * of the rule table and @rule_locs contains the locations of the
- * defined rules.
+ * of the rule table, @rule_cnt is the number of defined rules, and
+ * @rule_locs contains the locations of the defined rules.  Drivers
+ * must use the second parameter to get_rxnfc() instead of @rule_locs.
  *
  * For %ETHTOOL_SRXCLSRLINS, @fs specifies the rule to add or update.
  * @fs.@location specifies the location to use and must not be ignored.
