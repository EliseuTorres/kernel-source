From: Hiral Patel <hiral.patel@qlogic.com>
Date: Mon, 10 Mar 2014 11:47:17 -0700
Subject: [PATCH] qla2xxx: Revert "Only enable link up on the correct interrupt event."
References: bnc#866608
Patch-mainline: v3.18-rc1
Git-commit: 8e5a9484aee8d48f7dd3739c139ac684b30e6201 (partial)

Reverting commit 79cc785fc7dc16c4f7d7b475cd64695789c48eda, which is causing
a regression with older HBAs.

Signed-off-by: Hiral Patel <hiral.patel@qlogic.com>
Acked-by: Hannes Reinecke <hare@suse.de>
---
 drivers/scsi/qla2xxx/qla_isr.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/drivers/scsi/qla2xxx/qla_isr.c b/drivers/scsi/qla2xxx/qla_isr.c
index 2939643..ee5f3af 100644
--- a/drivers/scsi/qla2xxx/qla_isr.c
+++ b/drivers/scsi/qla2xxx/qla_isr.c
@@ -859,7 +859,8 @@ skip_rio:
 		 * it.  Otherwise ignore it and Wait for RSCN to come in.
 		 */
 		atomic_set(&vha->loop_down_timer, 0);
-		if (mb[1] != 0xffff || (mb[2] != 0x6 && mb[2] != 0x4)) {
+		if (atomic_read(&vha->loop_state) != LOOP_DOWN &&
+		    atomic_read(&vha->loop_state) != LOOP_DEAD) {
 			ql_dbg(ql_dbg_async, vha, 0x5011,
 			    "Asynchronous PORT UPDATE ignored %04x/%04x/%04x.\n",
 			    mb[1], mb[2], mb[3]);
-- 
1.7.7.5

