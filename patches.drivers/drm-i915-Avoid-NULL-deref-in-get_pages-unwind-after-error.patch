From: Chris Wilson <chris@chris-wilson.co.uk>
Subject: Fix Null dereference in i915_gem_object_save_bit_17_swizzle
References: http://bugzilla.kernel.org/show_bug.cgi?id=15158
	    http://bugzilla.kernel.org/show_bug.cgi?id=15527
	    https://bugzilla.novell.com/show_bug.cgi?id=591377
Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
Reported-by: maciej.rutecki@gmail.com
Acked-by: Alexey Starikovskiy <astarikovskiy@suse.de>

Index: linux-2.6.32-SLE11-SP1/drivers/gpu/drm/i915/i915_gem.c
===================================================================
--- linux-2.6.32-SLE11-SP1.orig/drivers/gpu/drm/i915/i915_gem.c	2010-03-27 01:01:40.868353966 +0300
+++ linux-2.6.32-SLE11-SP1/drivers/gpu/drm/i915/i915_gem.c	2010-03-27 01:06:00.073352796 +0300
@@ -1470,9 +1470,6 @@
 		obj_priv->dirty = 0;
 
 	for (i = 0; i < page_count; i++) {
-		if (obj_priv->pages[i] == NULL)
-			break;
-
 		if (obj_priv->dirty)
 			set_page_dirty(obj_priv->pages[i]);
 
@@ -2269,11 +2266,8 @@
 					   mapping_gfp_mask (mapping) |
 					   __GFP_COLD |
 					   gfpmask);
-		if (IS_ERR(page)) {
-			ret = PTR_ERR(page);
-			i915_gem_object_put_pages(obj);
-			return ret;
-		}
+		if (IS_ERR(page))
+			goto err_pages;
 		obj_priv->pages[i] = page;
 	}
 
@@ -2281,6 +2275,15 @@
 		i915_gem_object_do_bit_17_swizzle(obj);
 
 	return 0;
+
+err_pages:
+	while (i--)
+		page_cache_release(obj_priv->pages[i]);
+
+	drm_free_large(obj_priv->pages);
+	obj_priv->pages = NULL;
+	obj_priv->pages_refcount--;
+	return PTR_ERR(page);
 }
 
 static void i965_write_fence_reg(struct drm_i915_fence_reg *reg)
