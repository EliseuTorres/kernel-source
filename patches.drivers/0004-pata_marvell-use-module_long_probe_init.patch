From: "Luis R. Rodriguez" <mcgrof@suse.com>
Date: Fri, 15 Aug 2014 23:03:04 -0400
Subject: [PATCH 4/4] pata_marvell: use module_long_probe_init()
References: bnc#893454
Patch-mainline: Never, will be replaced with asynch probe

Alexander reported that on his Sony VAIO VPCZ23A4R laptop
experiences long delays on boot when connected to its dock
station on pre 3.9 kernels but anything after 3.9 will cause
the device to not be detected at all ending with:

[   38.065673] pata_marvell 0000:1a:00.0: no available native port
[   38.065769] pata_acpi 0000:1a:00.0: no available native port

This laptop has a Marvell 88SE6121 SATA II Controller [11ab:6121]
and a BluRay writer attached. The reason for the delays are
caused by SRST errors and the link being slow to respond.
The pata_marvell driver is a simple libata wrapper so the
real required changes need to be made on libata however not
many folks are around and available anymore with intimate
knowledge and experience with these devices. Alexander notes
that it may be that *any* ATA BMDMA controller that fails to
respond to an identify command until a reset or other device
poking might suffer from similar fate, this needs to be
investigated further. In the meantime using a kthread for
probe is reported to fix the unability to see the device at
probe, in fact since its handled as a kthread boot is not
delayed and the probing happens behind the scenes so booting
the machine is much faster.

Use the new module_long_probe_init() for the probe delay
issues, this annotates the driver also as needing some work.

We will not be providing bus wrappers for a la module_driver()
so provide a full init / exit sequence to use the new helper.

[0] https://bugzilla.kernel.org/show_bug.cgi?id=59581

Cc: Tejun Heo <tj@kernel.org>
Cc: linux-ide@vger.kernel.org
Cc: linux-kernel@vger.kernel.org
Cc: One Thousand Gnomes <gnomes@lxorguk.ukuu.org.uk>
Cc: Oleg Nesterov <oleg@redhat.com>
Cc: Benjamin Poirier <bpoirier@suse.de>
Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Reported-by: "Alexander E. Patrakov" <patrakov@gmail.com>
Signed-off-by: Luis R. Rodriguez <mcgrof@suse.com>
---
 drivers/ata/pata_marvell.c | 13 ++++++++++++-
 1 file changed, 12 insertions(+), 1 deletion(-)

diff --git a/drivers/ata/pata_marvell.c b/drivers/ata/pata_marvell.c
index a4f5e78..7c92071 100644
--- a/drivers/ata/pata_marvell.c
+++ b/drivers/ata/pata_marvell.c
@@ -178,7 +178,18 @@ static struct pci_driver marvell_pci_driver = {
 #endif
 };
 
-module_pci_driver(marvell_pci_driver);
+/* Once asynch probe gets added use that instead of this */
+static int __init marvell_pci_init(void)
+{
+	return pci_register_driver(&marvell_pci_driver);
+}
+module_long_probe_init(marvell_pci_init);
+
+static void __exit marvell_pci_exit(void)
+{
+	pci_unregister_driver(&marvell_pci_driver);
+}
+module_long_probe_exit(marvell_pci_exit);
 
 MODULE_AUTHOR("Alan Cox");
 MODULE_DESCRIPTION("SCSI low-level driver for Marvell ATA in legacy mode");
-- 
2.0.3

