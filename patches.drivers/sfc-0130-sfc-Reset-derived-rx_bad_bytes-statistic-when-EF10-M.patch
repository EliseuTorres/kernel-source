From: Ben Hutchings <bhutchings@solarflare.com>
Date: Thu, 5 Sep 2013 22:46:10 +0100
Subject: [PATCH v2 130/244] sfc: Reset derived rx_bad_bytes statistic when
 EF10 MC is rebooted
Patch-mainline: v3.12-rc2
Git-commit: 869070c5300d1b6f0f72f5444e69fe65e34c6bde
References: bsc#909618 FATE#317521

If the MC reboots then the stats it reports to us will have been
reset.  We need to reset ours to get efx_update_diff_stat() working
properly.

(This is a re-run of commit 876be083b669 'sfc: Reset driver's
MAC stats after MC reboot seen'.)

Signed-off-by: Ben Hutchings <bhutchings@solarflare.com>
Acked-by: David Chang <dchang@suse.com>
---
 drivers/net/ethernet/sfc/ef10.c |    5 +++++
 1 file changed, 5 insertions(+)

--- a/drivers/net/ethernet/sfc/ef10.c
+++ b/drivers/net/ethernet/sfc/ef10.c
@@ -708,6 +708,11 @@ static int efx_ef10_mcdi_poll_reboot(str
 	nic_data->must_restore_filters = true;
 	nic_data->rx_rss_context = EFX_EF10_RSS_CONTEXT_INVALID;
 
+	/* MAC statistics have been cleared on the NIC; clear the local
+	 * statistic that we update with efx_update_diff_stat().
+	 */
+	nic_data->stats[EF10_STAT_rx_bad_bytes] = 0;
+
 	return -EIO;
 }
 
