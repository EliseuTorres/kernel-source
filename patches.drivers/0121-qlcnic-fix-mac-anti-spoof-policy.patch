From rajesh.borundia@qlogic.com  Thu Jun 23 22:49:05 2011
From: Rajesh Borundia <rajesh.borundia@qlogic.com>
Date: Tue, 31 Aug 2010 17:17:48 +0000
Subject: [PATCH 121/187] qlcnic: fix mac anti spoof policy
Git-commit: 7613c87b2d805acf7c882935d47aa84d1947656f
Patch-mainline: v2.6.37-rc1
References: bnc#698272, FATE#311468

o Allow enabling/disabling mac anti spoof policy only for
  Non privilege functions.

Signed-off-by: Rajesh Borundia <rajesh.borundia@qlogic.com>
Signed-off-by: Amit Kumar Salecha <amit.salecha@qlogic.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Acked-by: Jeff Mahoney <jeffm@suse.com>
---
 drivers/net/qlcnic/qlcnic_main.c |   13 ++++++++++---
 1 files changed, 10 insertions(+), 3 deletions(-)

diff --git a/drivers/net/qlcnic/qlcnic_main.c b/drivers/net/qlcnic/qlcnic_main.c
index 1922c3d..a0a405b 100644
--- a/drivers/net/qlcnic/qlcnic_main.c
+++ b/drivers/net/qlcnic/qlcnic_main.c
@@ -745,9 +745,9 @@ qlcnic_set_eswitch_port_features(struct qlcnic_adapter *adapter,
 		struct qlcnic_esw_func_cfg *esw_cfg)
 {
 	adapter->flags &= ~QLCNIC_MACSPOOF;
-	if (adapter->op_mode == QLCNIC_NON_PRIV_FUNC)
-		if (esw_cfg->mac_anti_spoof)
-			adapter->flags |= QLCNIC_MACSPOOF;
+
+	if (esw_cfg->mac_anti_spoof)
+		adapter->flags |= QLCNIC_MACSPOOF;
 
 	qlcnic_set_netdev_features(adapter, esw_cfg);
 }
@@ -3399,8 +3399,12 @@ static int
 validate_esw_config(struct qlcnic_adapter *adapter,
 	struct qlcnic_esw_func_cfg *esw_cfg, int count)
 {
+	u32 op_mode;
 	u8 pci_func;
 	int i;
+
+	op_mode = readl(adapter->ahw.pci_base0 + QLCNIC_DRV_OP_MODE);
+
 	for (i = 0; i < count; i++) {
 		pci_func = esw_cfg[i].pci_func;
 		if (pci_func >= QLCNIC_MAX_PCI_FUNC)
@@ -3412,6 +3416,9 @@ validate_esw_config(struct qlcnic_adapter *adapter,
 
 		switch (esw_cfg[i].op_mode) {
 		case QLCNIC_PORT_DEFAULTS:
+			if (QLC_DEV_GET_DRV(op_mode, pci_func) !=
+						QLCNIC_NON_PRIV_FUNC)
+				esw_cfg[i].mac_anti_spoof = 0;
 			break;
 		case QLCNIC_ADD_VLAN:
 			if (!IS_VALID_VLAN(esw_cfg[i].vlan_id))
-- 
1.6.3.3

