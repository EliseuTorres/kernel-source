From: Vivek Goyal<vgoyal@redhat.com>
Subject: floppy: Fix a crash during rmmmod
References: bnc#739381
Patch-mainline: Queued for v3.3-fixes

floppy driver does not call add_disk() on all the drives hence we don't take
gendisk reference on request queue for these drives. Don't call put_disk()
with disk->queue set, otherwise we try to put the reference we never took.

Reported-by: Dirk Gouders <gouders@et.bocholt.fh-gelsenkirchen.de>
Acked-by: Tejun Heo <tj@kernel.org>
Signed-off-by: Vivek Goyal<vgoyal@redhat.com>
Acked-by: Suresh Jayaraman <sjayaraman@suse.com>
---
 drivers/block/floppy.c |    9 +++++++++
 1 file changed, 9 insertions(+)

Index: linux-3.0-SLE11-SP2/drivers/block/floppy.c
===================================================================
--- linux-3.0-SLE11-SP2.orig/drivers/block/floppy.c
+++ linux-3.0-SLE11-SP2/drivers/block/floppy.c
@@ -4586,6 +4586,15 @@ static void __exit floppy_module_exit(vo
 			platform_device_unregister(&floppy_device[drive]);
 		}
 		blk_cleanup_queue(disks[drive]->queue);
+
+		/*
+		 * These disks have not called add_disk().  Don't put down
+		 * queue reference in put_disk().
+		 */
+		if (!(allowed_drive_mask & (1 << drive)) ||
+		    fdc_state[FDC(drive)].version == FDC_NONE)
+			disks[drive]->queue = NULL;
+
 		put_disk(disks[drive]);
 	}
 
