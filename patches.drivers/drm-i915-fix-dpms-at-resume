From: Takashi Iwai <tiwai@suse.de>
Subject: drm/i915: Fix DPMS setups at resume
Patch-mainline: To be submitted
References: bnc#664149

The patch 
  From 032d2a0d068b0368296a56469761394ef03207c3 Mon Sep 17 00:00:00 2001
  From: Chris Wilson <chris@chris-wilson.co.uk>
  Date: Mon, 6 Sep 2010 16:17:22 +0100
  Subject: drm/i915: Prevent double dpms on
in 2.6.32.22 stable queue causes a regression in S4 resume on PineView
machines.  It's because DPMS isn't reset properly in the power transition.

This band-aid patch fixes the DPMS setup by introducing is_resume flag
so that dpms-callbacks can forcibly set the state at resume.

Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
 drivers/gpu/drm/i915/i915_drv.c      |    2 ++
 drivers/gpu/drm/i915/i915_drv.h      |    1 +
 drivers/gpu/drm/i915/intel_display.c |    2 +-
 3 files changed, 4 insertions(+), 1 deletion(-)

--- a/drivers/gpu/drm/i915/intel_display.c
+++ b/drivers/gpu/drm/i915/intel_display.c
@@ -1971,7 +1971,7 @@
 	int pipe = intel_crtc->pipe;
 	bool enabled;
 
-	if (intel_crtc->dpms_mode == mode)
+	if (intel_crtc->dpms_mode == mode && !dev_priv->in_resume)
 		return;
 
 	dev_priv->display.dpms(crtc, mode);
--- a/drivers/gpu/drm/i915/i915_drv.c
+++ b/drivers/gpu/drm/i915/i915_drv.c
@@ -102,6 +102,7 @@
 
 	if (pci_enable_device(dev->pdev))
 		return -1;
+	dev_priv->in_resume = true;
 	pci_set_master(dev->pdev);
 
 	i915_restore_state(dev);
@@ -128,6 +129,7 @@
 	}
 
 	dev_priv->modeset_on_lid = 0;
+	dev_priv->in_resume = false;
 
 	return ret;
 }
--- a/drivers/gpu/drm/i915/i915_drv.h
+++ b/drivers/gpu/drm/i915/i915_drv.h
@@ -566,6 +566,7 @@
 	int child_dev_num;
 	struct child_device_config *child_dev;
 	struct drm_connector *int_lvds_connector;
+	bool in_resume;
 } drm_i915_private_t;
 
 /** driver private structure attached to each drm_gem_object */
