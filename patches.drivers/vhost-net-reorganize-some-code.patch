From: Bruce Rogers <brogers@suse.com>
Subject: vhost net: reorganize some code
References: FATE#311977
Git-commit: 11fe883936980fe242869d671092a466cf1db3e3
Patch-mainline: v2.6.35
    
This is a conglomeration of git id 11fe883936980fe242869d671092a466cf1db3e3
along with changes before and after that. This patch simplifies it all.

Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Bruce Rogers <brogers@suse.com>
---
 drivers/vhost/net.c |   11 +++++------
 1 file changed, 5 insertions(+), 6 deletions(-)

Index: b/drivers/vhost/net.c
===================================================================
--- a/drivers/vhost/net.c
+++ b/drivers/vhost/net.c
@@ -733,13 +733,12 @@ static long vhost_net_set_backend(struct
 
 	/* start polling new socket */
 	oldsock = vq->private_data;
-	if (sock == oldsock)
-		goto done;
+	if (sock != oldsock) {
+                vhost_net_disable_vq(n, vq);
+                rcu_assign_pointer(vq->private_data, sock);
+                vhost_net_enable_vq(n, vq);
+	}
 
-	vhost_net_disable_vq(n, vq);
-	rcu_assign_pointer(vq->private_data, sock);
-	vhost_net_enable_vq(n, vq);
-done:
 	mutex_unlock(&vq->mutex);
 
 	if (oldsock) {
