From: Suresh Reddy <suresh.reddy@emulex.com>
Date: Thu, 25 Apr 2013 23:03:22 +0000
Subject: be2net: Avoid diagnostic test in certain versions of firmware to
 avoid NIC freeze.
Patch-mainline: v3.10-rc1
Git-commit: 78d0b11dcedb21ee432d19eed1a3fa03e8f95353
References: bnc#908322 FATE#317535

Signed-off-by: Suresh Reddy <suresh.reddy@emulex.com>
Signed-off-by: Sarveshwar Bandi <sarveshwar.bandi@emulex.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Acked-by: Benjamin Poirier <bpoirier@suse.de>
---
 drivers/net/ethernet/emulex/benet/be_ethtool.c |    6 ++++++
 1 file changed, 6 insertions(+)

--- a/drivers/net/ethernet/emulex/benet/be_ethtool.c
+++ b/drivers/net/ethernet/emulex/benet/be_ethtool.c
@@ -755,6 +755,12 @@ be_self_test(struct net_device *netdev,
 	int status;
 	u8 link_status = 0;
 
+	if (adapter->function_caps & BE_FUNCTION_CAPS_SUPER_NIC) {
+		dev_err(&adapter->pdev->dev, "Self test not supported\n");
+		test->flags |= ETH_TEST_FL_FAILED;
+		return;
+	}
+
 	memset(data, 0, sizeof(u64) * ETHTOOL_TESTS_NUM);
 
 	if (test->flags & ETH_TEST_FL_OFFLINE) {
