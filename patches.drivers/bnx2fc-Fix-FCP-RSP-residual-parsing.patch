From: Santosh Vernekar <santosh.vernekar@qlogic.com>
Date: Tue, 23 Sep 2014 08:27:26 -0400
Subject: bnx2fc: Fix FCP RSP residual parsing.
Patch-Mainline: Not yet
References: bnc#909367,FATE#317542

Problem:
AIG Issue (CQ75785): LUNs are not visible for EMC V-PLEX storage.

Cause:
Driver is incorrectly parsing invalid data and passing on the information
to the upper levels in the host stack. This is causing the host to not discover
VPLEX storage. For some of the SCSI commands (not the cmd with SCSI opcode 0xef
but following the cmd with SCSI opcode 0xef) when the status frame is sent from
VPLEX target, the SCSI status is Good and the FCP Resid flags are not set
(which is correct since the requested data length is transferred) but the
FCP_RESID is non zero. However, since the underrun and overrun bits are NOT set,
the value in FCP_RESID is invalid and should not be used by the
initiator/host driver.

Signed-off-by: Santosh Vernekar <santosh.vernekar@qlogic.com>
Acked-by: Hannes Reinecke <hare@suse.de>
---
 drivers/scsi/bnx2fc/bnx2fc_io.c | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/drivers/scsi/bnx2fc/bnx2fc_io.c b/drivers/scsi/bnx2fc/bnx2fc_io.c
index c79f792..a69a85b9 100644
--- a/drivers/scsi/bnx2fc/bnx2fc_io.c
+++ b/drivers/scsi/bnx2fc/bnx2fc_io.c
@@ -1774,7 +1774,10 @@ static void bnx2fc_parse_fcp_rsp(struct bnx2fc_cmd *io_req,
 	int fcp_rsp_len = 0;
 
 	io_req->fcp_status = FC_GOOD;
-	io_req->fcp_resid = fcp_rsp->fcp_resid;
+	io_req->fcp_resid = 0;
+	if (rsp_flags & (FCOE_FCP_RSP_FLAGS_FCP_RESID_OVER ||
+	    FCOE_FCP_RSP_FLAGS_FCP_RESID_UNDER))
+		io_req->fcp_resid = fcp_rsp->fcp_resid;
 
 	io_req->scsi_comp_flags = rsp_flags;
 	CMD_SCSI_STATUS(sc_cmd) = io_req->cdb_status =
-- 
1.8.5.2

