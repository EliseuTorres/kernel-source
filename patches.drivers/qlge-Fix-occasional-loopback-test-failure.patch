From dbdaede3b4b738d368412410b03efb4117882184 Mon Sep 17 00:00:00 2001
From: Ron Mercer <ron.mercer@qlogic.com>
Date: Tue, 16 Feb 2010 10:57:45 -0800
Subject: [PATCH] qlge: Fix occasional loopback test failure.
References: bnc#581188
Patch-mainline: Submitted Feb 17 - net-next-2.6
Git-commit: aa13bd6ef4ddd81080f972220fae30eb28f65b17
Git-repo: git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next-2.6.git

On some servers we see the cleaning of the RX queue finish before all
the loopback packets are sent out.  This delay allows the queues to
settle before checking for successful completion.
Also, delay completion so link has time to come back up.

Signed-off-by: Brandon Philips <bphilips@suse.de>

---
 drivers/net/qlge/qlge_ethtool.c |    7 ++++++-
 1 files changed, 6 insertions(+), 1 deletions(-)

diff --git a/drivers/net/qlge/qlge_ethtool.c b/drivers/net/qlge/qlge_ethtool.c
index 058fa0a..989d723 100644
--- a/drivers/net/qlge/qlge_ethtool.c
+++ b/drivers/net/qlge/qlge_ethtool.c
@@ -500,7 +500,8 @@ static int ql_run_loopback_test(struct ql_adapter *qdev)
 			return -EPIPE;
 		atomic_inc(&qdev->lb_count);
 	}
-
+	/* Give queue time to settle before testing results. */
+	msleep(2);
 	ql_clean_lb_rx_ring(&qdev->rx_ring[0], 128);
 	return atomic_read(&qdev->lb_count) ? -EIO : 0;
 }
@@ -533,6 +534,10 @@ static void ql_self_test(struct net_device *ndev,
 			data[0] = 0;
 		}
 		clear_bit(QL_SELFTEST, &qdev->flags);
+		/* Give link time to come up after
+		 * port configuration changes.
+		 */
+		msleep_interruptible(4 * 1000);
 	} else {
 		QPRINTK(qdev, DRV, ERR,
 			"%s: is down, Loopback test will fail.\n", ndev->name);
-- 
1.6.0.2

