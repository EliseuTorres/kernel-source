From: Takashi Iwai <tiwai@suse.de>
Subject: lis3: Add support for new LIS3DC / HP3DC chip
Patch-mainline: v2.6.37-rc1
References: bnc#639197
Git-commit: 78537c3b6ffcb69bf4fd43a74ba57928fcefce95

A new version of LIS3 chip has slight incompatibilities from former
versions.  This patch adds the minimal support for it.

Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
 drivers/hwmon/lis3lv02d.c |   19 ++++++++++++++++---
 drivers/hwmon/lis3lv02d.h |    2 ++
 2 files changed, 18 insertions(+), 3 deletions(-)

--- a/drivers/hwmon/lis3lv02d.c
+++ b/drivers/hwmon/lis3lv02d.c
@@ -365,6 +365,8 @@
 /* conversion btw sampling rate and the register values */
 static int lis3_12_rates[4] = {40, 160, 640, 2560};
 static int lis3_8_rates[2] = {100, 400};
+static int lis3_3dc_rates[16] = {0, 1, 10, 25, 50, 100, 200, 400, 1600, 5000};
+
 static ssize_t lis3lv02d_rate_show(struct device *dev,
 			struct device_attribute *attr, char *buf)
 {
@@ -373,11 +375,17 @@
 
 	lis3_dev.read(&lis3_dev, CTRL_REG1, &ctrl);
 
-	if (lis3_dev.whoami == LIS_DOUBLE_ID)
+	switch (lis3_dev.whoami) {
+	case LIS_3DC_ID:
+		val = lis3_3dc_rates[(ctrl & 0xf0) >> 4];
+		break;
+	case LIS_DOUBLE_ID:
 		val = lis3_12_rates[(ctrl & (CTRL1_DF0 | CTRL1_DF1)) >> 4];
-	else
+		break;
+	default:
 		val = lis3_8_rates[(ctrl & CTRL1_DR) >> 7];
-
+		break;
+	}
 	return sprintf(buf, "%d\n", val);
 }
 
@@ -434,6 +442,11 @@
 		dev->read_data = lis3lv02d_read_8;
 		dev->mdps_max_val = 128;
 		break;
+	case LIS_3DC_ID:
+		printk(KERN_INFO DRIVER_NAME ": 1-byte 3dc sensor found\n");
+		dev->read_data = lis3lv02d_read_8;
+		dev->mdps_max_val = 128;
+		break;
 	default:
 		printk(KERN_ERR DRIVER_NAME
 			": unknown sensor type 0x%X\n", dev->whoami);
--- a/drivers/hwmon/lis3lv02d.h
+++ b/drivers/hwmon/lis3lv02d.h
@@ -35,6 +35,8 @@
 #define LIS_DOUBLE_ID	0x3A /* LIS3LV02D[LQ] */
 /* 1-byte registers */
 #define LIS_SINGLE_ID	0x3B /* LIS[32]02DL and others */
+/* 1-byte */
+#define LIS_3DC_ID	0x33 /* LIS3DC, HP3DC */
 
 enum lis3_reg {
 	WHO_AM_I	= 0x0F,


