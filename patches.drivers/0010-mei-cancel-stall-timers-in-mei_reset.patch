From 23698a82b3cbf626459944b86c0be5f3f6e97807 Mon Sep 17 00:00:00 2001
From: Alexander Usyskin <alexander.usyskin@intel.com>
Date: Mon, 2 Sep 2013 13:29:47 +0300
Subject: [char-misc 10/11] mei: cancel stall timers in mei_reset
Git-commit: 4a704575cc1afb3b848f096778fa9b8d7b3d5813
Patch-mainline: 3.12-rc3
References: bnc#876086

commit 4a704575cc1afb3b848f096778fa9b8d7b3d5813 upstream.

Unset init_clients_timer and amthif_stall_timers
in mei_reset in order to cancel timer ticking and hence
avoid recursive reset calls.

[Backport to v3.7: adjust after refactoring]

Signed-off-by: Alexander Usyskin <alexander.usyskin@intel.com>
Signed-off-by: Tomas Winkler <tomas.winkler@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Acked-by: Takashi Iwai <tiwai@suse.de>

---
 drivers/misc/mei/init.c |    4 ++++
 1 file changed, 4 insertions(+)

--- a/drivers/misc/mei/init.c
+++ b/drivers/misc/mei/init.c
@@ -118,6 +118,7 @@ static void mei_reset_iamthif_params(str
 	dev->iamthif_ioctl = false;
 	dev->iamthif_state = MEI_IAMTHIF_IDLE;
 	dev->iamthif_timer = 0;
+	dev->iamthif_stall_timer = 0;
 }
 
 /**
@@ -389,6 +390,9 @@ void mei_reset(struct mei_device *dev, i
 		dev->extra_write_index = 0;
 	}
 
+	/* we're already in reset, cancel the init timer */
+	dev->init_clients_timer = 0;
+
 	dev->me_clients_num = 0;
 	dev->rd_msg_hdr = 0;
 	dev->wd_pending = false;
