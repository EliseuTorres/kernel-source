From b391e60d83b42f13eba86c7368d5fb81a4489dfb Mon Sep 17 00:00:00 2001
From: Michal Marek <mmarek@suse.cz>
Date: Wed, 16 May 2012 11:29:20 +0200
Subject: [PATCH] kabi: Really preserve nf_{conntract,expect}_event_cb exports
Patch-mainline: never
References: bnc#758540

It is not possible to fool genksyms into creating fake exports, the
symbols have to exist in the object file. Also, remove the unnecessary
extern declaration.

Signed-off-by: Michal Marek <mmarek@suse.cz>

diff --git a/include/net/netfilter/nf_conntrack_ecache.h b/include/net/netfilter/nf_conntrack_ecache.h
index a3ae6ea..2e1f0aa 100644
--- a/include/net/netfilter/nf_conntrack_ecache.h
+++ b/include/net/netfilter/nf_conntrack_ecache.h
@@ -71,7 +71,6 @@ struct nf_ct_event_notifier {
 };
 
 #ifdef __GENKSYMS__
-extern struct nf_ct_event_notifier __rcu *nf_conntrack_event_cb;
 extern int nf_conntrack_register_notifier(struct nf_ct_event_notifier *nb);
 extern void nf_conntrack_unregister_notifier(struct nf_ct_event_notifier *nb);
 #else
@@ -177,7 +176,6 @@ struct nf_exp_event_notifier {
 };
 
 #ifdef __GENKSYMS__
-extern struct nf_exp_event_notifier __rcu *nf_expect_event_cb;
 extern int nf_ct_expect_register_notifier(struct nf_exp_event_notifier *nb);
 extern void nf_ct_expect_unregister_notifier(struct nf_exp_event_notifier *nb);
 #else
diff --git a/net/netfilter/nf_conntrack_ecache.c b/net/netfilter/nf_conntrack_ecache.c
index 1e89d59..fb68fae 100644
--- a/net/netfilter/nf_conntrack_ecache.c
+++ b/net/netfilter/nf_conntrack_ecache.c
@@ -26,13 +26,12 @@
 
 static DEFINE_MUTEX(nf_ct_ecache_mutex);
 
-#ifdef __GENKSYMS__
+/* Preserved only for the sake of kABI stability */
 struct nf_ct_event_notifier __rcu *nf_conntrack_event_cb __read_mostly;
 EXPORT_SYMBOL_GPL(nf_conntrack_event_cb);
 
 struct nf_exp_event_notifier __rcu *nf_expect_event_cb __read_mostly;
 EXPORT_SYMBOL_GPL(nf_expect_event_cb);
-#endif
 
 /* deliver cached events and clear cache entry - must be called with locally
  * disabled softirqs */
