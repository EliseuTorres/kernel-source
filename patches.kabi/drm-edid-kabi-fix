From: Takashi Iwai <tiwai@suse.de>
Subject: Fix kABI for drm EDID improvement patches
Patch-mainline: Never
References: bnc#753172

Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
 drivers/gpu/drm/drm_edid.c |    9 +++++++++
 include/drm/drm_crtc.h     |    4 +++-
 include/drm/drm_edid.h     |    9 +++++++++
 3 files changed, 21 insertions(+), 1 deletion(-)

--- a/drivers/gpu/drm/drm_edid.c
+++ b/drivers/gpu/drm/drm_edid.c
@@ -1882,3 +1882,12 @@ int drm_add_modes_noedid(struct drm_conn
 	return num_modes;
 }
 EXPORT_SYMBOL(drm_add_modes_noedid);
+
+/* define the old function just for kABI compatibility */
+#undef drm_mode_find_dmt
+struct drm_display_mode *drm_mode_find_dmt(struct drm_device *dev,
+					   int hsize, int vsize, int fresh)
+{
+	return __drm_mode_find_dmt(dev, hsize, vsize, fresh, false);
+}
+EXPORT_SYMBOL(drm_mode_find_dmt);
--- a/include/drm/drm_crtc.h
+++ b/include/drm/drm_crtc.h
@@ -813,9 +813,11 @@ extern int drm_add_modes_noedid(struct d
 
 extern int drm_edid_header_is_valid(const u8 *raw_edid);
 extern bool drm_edid_is_valid(struct edid *edid);
-struct drm_display_mode *drm_mode_find_dmt(struct drm_device *dev,
+/* rename for kABI compatibility */
+struct drm_display_mode *__drm_mode_find_dmt(struct drm_device *dev,
 					   int hsize, int vsize, int fresh,
 					   bool rb);
+#define drm_mode_find_dmt	__drm_mode_find_dmt
 
 extern int drm_mode_create_dumb_ioctl(struct drm_device *dev,
 				      void *data, struct drm_file *file_priv);
--- a/include/drm/drm_edid.h
+++ b/include/drm/drm_edid.h
@@ -90,6 +90,14 @@ struct detailed_data_monitor_range {
 	u8 min_hfreq_khz;
 	u8 max_hfreq_khz;
 	u8 pixel_clock_mhz; /* need to multiply by 10 */
+#ifdef __GENKSYMS__
+	__le16 sec_gtf_toggle; /* A000=use above, 20=use below */
+	u8 hfreq_start_khz; /* need to multiply by 2 */
+	u8 c; /* need to divide by 2 */
+	__le16 m;
+	u8 k;
+	u8 j; /* need to divide by 2 */
+#else
 	u8 flags;
 	union {
 		struct {
@@ -110,6 +118,7 @@ struct detailed_data_monitor_range {
 			u8 preferred_refresh;
 		} __attribute__((packed)) cvt;
 	} formula;
+#endif
 } __attribute__((packed));
 
 struct detailed_data_wpindex {
