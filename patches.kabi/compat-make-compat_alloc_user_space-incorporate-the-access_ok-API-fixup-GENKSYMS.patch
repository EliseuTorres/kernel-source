From: Jiri Kosina <jkosina@suse.cz>
Subject: hide kABI checker false positive coming from compat_alloc_userspace() fix
References: CVE-2010-3081 bnc#639709
Patch-mainline: never

We are now including uaccess.h in each and every arch-specific compat.h,
which makes struct exception_table_entry be defined in places where it used
not to be. This is causing the following kABI checker false positive:

/usr/src/packages/BUILD/kernel-default-2.6.32.23/linux-2.6.32/kernel/ksysfs.c:137: warning: kernel_kobj: modversion changed because of changes in struct exception_table_entry (became defined)
[ ... ]
KABI: symbol kernel_kobj(kernel/ksysfs/built-in) changed crc from 0x77d8bc28 to 0x556d4bf4

Guard the inclusion to keep the checksum for the checker the same.

Signed-off-by: Jiri Kosina <jkosina@suse.cz>

Index: linux-2.6.32-SLE11-SP1/arch/mips/include/asm/compat.h
===================================================================
--- linux-2.6.32-SLE11-SP1.orig/arch/mips/include/asm/compat.h
+++ linux-2.6.32-SLE11-SP1/arch/mips/include/asm/compat.h
@@ -7,7 +7,9 @@
 #include <linux/types.h>
 #include <asm/page.h>
 #include <asm/ptrace.h>
+#ifndef __GENKSYMS__
 #include <asm/uaccess.h>
+#endif
 
 #define COMPAT_USER_HZ	100
 
Index: linux-2.6.32-SLE11-SP1/arch/parisc/include/asm/compat.h
===================================================================
--- linux-2.6.32-SLE11-SP1.orig/arch/parisc/include/asm/compat.h
+++ linux-2.6.32-SLE11-SP1/arch/parisc/include/asm/compat.h
@@ -6,7 +6,9 @@
 #include <linux/types.h>
 #include <linux/sched.h>
 #include <linux/thread_info.h>
+#ifndef __GENKSYMS__
 #include <asm/uaccess.h>
+#endif
 
 #define COMPAT_USER_HZ 100
 
Index: linux-2.6.32-SLE11-SP1/arch/powerpc/include/asm/compat.h
===================================================================
--- linux-2.6.32-SLE11-SP1.orig/arch/powerpc/include/asm/compat.h
+++ linux-2.6.32-SLE11-SP1/arch/powerpc/include/asm/compat.h
@@ -6,7 +6,9 @@
  */
 #include <linux/types.h>
 #include <linux/sched.h>
+#ifndef __GENKSYMS__
 #include <asm/uaccess.h>
+#endif
 
 #define COMPAT_USER_HZ	100
 
Index: linux-2.6.32-SLE11-SP1/arch/s390/include/asm/compat.h
===================================================================
--- linux-2.6.32-SLE11-SP1.orig/arch/s390/include/asm/compat.h
+++ linux-2.6.32-SLE11-SP1/arch/s390/include/asm/compat.h
@@ -6,7 +6,9 @@
 #include <linux/types.h>
 #include <linux/sched.h>
 #include <linux/thread_info.h>
+#ifndef __GENKSYMS__
 #include <asm/uaccess.h>
+#endif
 
 #define PSW32_MASK_PER		0x40000000UL
 #define PSW32_MASK_DAT		0x04000000UL
Index: linux-2.6.32-SLE11-SP1/arch/sparc/include/asm/compat.h
===================================================================
--- linux-2.6.32-SLE11-SP1.orig/arch/sparc/include/asm/compat.h
+++ linux-2.6.32-SLE11-SP1/arch/sparc/include/asm/compat.h
@@ -4,7 +4,9 @@
  * Architecture specific compatibility types
  */
 #include <linux/types.h>
+#ifndef __GENKSYMS__
 #include <asm/uaccess.h>
+#endif
 
 #define COMPAT_USER_HZ	100
 
Index: linux-2.6.32-SLE11-SP1/arch/x86/include/asm/compat.h
===================================================================
--- linux-2.6.32-SLE11-SP1.orig/arch/x86/include/asm/compat.h
+++ linux-2.6.32-SLE11-SP1/arch/x86/include/asm/compat.h
@@ -7,7 +7,9 @@
 #include <linux/types.h>
 #include <linux/sched.h>
 #include <asm/user32.h>
+#ifndef __GENKSYMS__
 #include <asm/uaccess.h>
+#endif
 
 #define COMPAT_USER_HZ	100
 
Index: linux-2.6.32-SLE11-SP1/arch/ia64/include/asm/compat.h
===================================================================
--- linux-2.6.32-SLE11-SP1.orig/arch/ia64/include/asm/compat.h
+++ linux-2.6.32-SLE11-SP1/arch/ia64/include/asm/compat.h
@@ -4,7 +4,9 @@
  * Architecture specific compatibility types
  */
 #include <linux/types.h>
+#ifndef __GENKSYMS__
 #include <asm/uaccess.h>
+#endif
 
 #define COMPAT_USER_HZ	100
 
