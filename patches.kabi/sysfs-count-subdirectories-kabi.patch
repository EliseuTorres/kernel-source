From: Jiri Kosina <jkosina@suse.cz>
Subject: [PATCH] kABI fix for sysfs-count-subdirectories
References: bnc#766027
Patch-mainline: never

Work around the kABI change by moving 'subdirs' field from sysfs_elem_dir
to the end of sysfs_dirent.

Signed-off-by: Jiri Kosina <jkosina@suse.cz>

Index: linux-3.0-SLE11-SP2/fs/sysfs/dir.c
===================================================================
--- linux-3.0-SLE11-SP2.orig/fs/sysfs/dir.c
+++ linux-3.0-SLE11-SP2/fs/sysfs/dir.c
@@ -48,7 +48,7 @@ static void sysfs_link_sibling(struct sy
 	BUG_ON(sd->s_sibling);
 
 	if (sysfs_type(sd) == SYSFS_DIR)
-		parent_sd->s_dir.subdirs++;
+		parent_sd->subdirs++;
 
 	/* Store directory entries in order by ino.  This allows
 	 * readdir to properly restart without having to add a
@@ -77,7 +77,7 @@ static void sysfs_unlink_sibling(struct
 	struct sysfs_dirent **pos;
 
 	if (sysfs_type(sd) == SYSFS_DIR)
-		sd->s_parent->s_dir.subdirs--;
+		sd->s_parent->subdirs--;
 
 	for (pos = &sd->s_parent->s_dir.children; *pos;
 	     pos = &(*pos)->s_sibling) {
Index: linux-3.0-SLE11-SP2/fs/sysfs/inode.c
===================================================================
--- linux-3.0-SLE11-SP2.orig/fs/sysfs/inode.c
+++ linux-3.0-SLE11-SP2/fs/sysfs/inode.c
@@ -219,7 +219,7 @@ static void sysfs_refresh_inode(struct s
 	}
 
 	if (sysfs_type(sd) == SYSFS_DIR)
-		inode->i_nlink = sd->s_dir.subdirs + 2;
+		inode->i_nlink = sd->subdirs + 2;
 }
 
 int sysfs_getattr(struct vfsmount *mnt, struct dentry *dentry, struct kstat *stat)
Index: linux-3.0-SLE11-SP2/fs/sysfs/sysfs.h
===================================================================
--- linux-3.0-SLE11-SP2.orig/fs/sysfs/sysfs.h
+++ linux-3.0-SLE11-SP2/fs/sysfs/sysfs.h
@@ -19,8 +19,6 @@ struct sysfs_elem_dir {
 	struct kobject		*kobj;
 	/* children list starts here and goes through sd->s_sibling */
 	struct sysfs_dirent	*children;
-
-	unsigned long		subdirs;
 };
 
 struct sysfs_elem_symlink {
@@ -73,6 +71,9 @@ struct sysfs_dirent {
 	unsigned short		s_mode;
 	ino_t			s_ino;
 	struct sysfs_inode_attrs *s_iattr;
+#ifndef __GENKSYMS__
+	unsigned long		subdirs;
+#endif
 };
 
 #define SD_DEACTIVATED_BIAS		INT_MIN
