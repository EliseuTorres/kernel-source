From: Michal Kubecek <mkubecek@suse.cz>
Date: Mon, 12 May 2014 14:46:03 +0200
Subject: kabi: protect struct net from bnc#877013 changes
Patch-mainline: Never, kabi workaround
References: bnc#877013

Mainline commit f3c1a44a2  ("netfilter: make /proc/net/netfilter
pernet") needed for bnc#877013 fix adds embedded struct netns_nf
into struct net. Use net_generic() mechanism to work around this.

Signed-off-by: Michal Kubecek <mkubecek@suse.cz>
---
 include/net/net_namespace.h     |  3 ++-
 include/net/netns/netfilter.h   |  2 ++
 net/netfilter/core.c            | 25 ++++++++++++++++++++-----
 net/netfilter/nfnetlink_queue.c |  4 ++--
 4 files changed, 26 insertions(+), 8 deletions(-)

diff --git a/include/net/net_namespace.h b/include/net/net_namespace.h
index 0a7d62e..a298d10 100644
--- a/include/net/net_namespace.h
+++ b/include/net/net_namespace.h
@@ -16,7 +16,9 @@
 #include <net/netns/ipv4.h>
 #include <net/netns/ipv6.h>
 #include <net/netns/dccp.h>
+#ifndef __GENKSYMS__
 #include <net/netns/netfilter.h>
+#endif
 #include <net/netns/x_tables.h>
 #if defined(CONFIG_NF_CONNTRACK) || defined(CONFIG_NF_CONNTRACK_MODULE)
 #include <net/netns/conntrack.h>
@@ -84,7 +86,6 @@ struct net {
 	struct netns_dccp	dccp;
 #endif
 #ifdef CONFIG_NETFILTER
-	struct netns_nf		nf;
 	struct netns_xt		xt;
 #if defined(CONFIG_NF_CONNTRACK) || defined(CONFIG_NF_CONNTRACK_MODULE)
 	struct netns_ct		ct;
diff --git a/include/net/netns/netfilter.h b/include/net/netns/netfilter.h
index 248ca1c..17636b0 100644
--- a/include/net/netns/netfilter.h
+++ b/include/net/netns/netfilter.h
@@ -8,4 +8,6 @@ struct netns_nf {
 	struct proc_dir_entry *proc_netfilter;
 #endif
 };
+
+struct netns_nf *net_nf(struct net *net);
 #endif
diff --git a/net/netfilter/core.c b/net/netfilter/core.c
index d41a07a..427ee94 100644
--- a/net/netfilter/core.c
+++ b/net/netfilter/core.c
@@ -21,6 +21,9 @@
 #include <linux/mutex.h>
 #include <linux/slab.h>
 #include <net/net_namespace.h>
+#ifndef __GENKSYMS__
+#include <net/netns/generic.h>
+#endif
 #include <net/sock.h>
 
 #include "nf_internals.h"
@@ -261,17 +264,21 @@ struct proc_dir_entry *proc_net_netfilter;
 EXPORT_SYMBOL(proc_net_netfilter);
 #endif
 
+static int netfilter_net_id;
+
 static int __net_init netfilter_net_init(struct net *net)
 {
 #ifdef CONFIG_PROC_FS
-	net->nf.proc_netfilter = proc_net_mkdir(net, "netfilter",
-						net->proc_net);
+	struct netns_nf *net_nfp = net_nf(net);
+
+	net_nfp->proc_netfilter = proc_net_mkdir(net, "netfilter",
+						 net->proc_net);
 	if (net_eq(net, &init_net)) {
-		if (!net->nf.proc_netfilter)
+		if (!net_nfp->proc_netfilter)
 			return -ENOMEM;
 		else
-			proc_net_netfilter = net->nf.proc_netfilter;
-	} else if (!net->nf.proc_netfilter) {
+			proc_net_netfilter = net_nfp->proc_netfilter;
+	} else if (!net_nfp->proc_netfilter) {
 		pr_err("cannot create netfilter proc entry");
 		return -ENOMEM;
 	}
@@ -287,8 +294,16 @@ static void __net_exit netfilter_net_exit(struct net *net)
 static struct pernet_operations netfilter_net_ops = {
 	.init = netfilter_net_init,
 	.exit = netfilter_net_exit,
+	.id   = &netfilter_net_id,
+	.size = sizeof(struct netns_nf),
 };
 
+struct netns_nf *net_nf(struct net *net)
+{
+	return net_generic(net, netfilter_net_id);
+}
+EXPORT_SYMBOL(net_nf);
+
 void __init netfilter_init(void)
 {
 	int i, h;
diff --git a/net/netfilter/nfnetlink_queue.c b/net/netfilter/nfnetlink_queue.c
index 4ac882b..d118a80 100644
--- a/net/netfilter/nfnetlink_queue.c
+++ b/net/netfilter/nfnetlink_queue.c
@@ -972,7 +972,7 @@ static int __net_init nfnl_queue_net_init(struct net *net)
 
 #ifdef CONFIG_PROC_FS
 	if (!proc_create("nfnetlink_queue", 0440,
-			 net->nf.proc_netfilter, &nfqnl_file_ops))
+			 net_nf(net)->proc_netfilter, &nfqnl_file_ops))
 		return -ENOMEM;
 #endif
 	return 0;
@@ -980,7 +980,7 @@ static int __net_init nfnl_queue_net_init(struct net *net)
 
 static void __net_exit nfnl_queue_net_exit(struct net *net)
 {
-	remove_proc_entry("nfnetlink_queue", net->nf.proc_netfilter);
+	remove_proc_entry("nfnetlink_queue", net_nf(net)->proc_netfilter);
 }
 
 static struct pernet_operations nfnl_queue_net_ops = {
-- 
1.8.1.4

