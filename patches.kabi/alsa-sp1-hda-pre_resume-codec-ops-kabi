From: Takashi Iwai <tiwai@suse.de>
Subject: Fix kABI breakage with pre_resume codec_ops
Patch-mainline: Never
References: bnc#708376

Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
 sound/pci/hda/hda_codec.c      |    4 ++--
 sound/pci/hda/hda_codec.h      |    7 ++++---
 sound/pci/hda/patch_sigmatel.c |   28 +++++++++++++++++++++++++++-
 3 files changed, 33 insertions(+), 6 deletions(-)

--- a/sound/pci/hda/hda_codec.c
+++ b/sound/pci/hda/hda_codec.c
@@ -4007,8 +4007,8 @@
 	struct hda_codec *codec;
 
 	list_for_each_entry(codec, &bus->codec_list, list) {
-		if (codec->patch_ops.pre_resume)
-			codec->patch_ops.pre_resume(codec);
+		if (codec->pre_resume)
+			codec->pre_resume(codec);
 		if (snd_hda_codec_needs_resume(codec))
 			hda_call_codec_resume(codec);
 	}
--- a/sound/pci/hda/hda_codec.h
+++ b/sound/pci/hda/hda_codec.h
@@ -684,9 +684,6 @@
 	int (*check_power_status)(struct hda_codec *codec, hda_nid_t nid);
 #endif
 	void (*reboot_notify)(struct hda_codec *codec);
-#ifdef SND_HDA_NEEDS_RESUME
-	int (*pre_resume)(struct hda_codec *codec);
-#endif
 };
 
 /* record for amp information cache */
@@ -832,6 +829,10 @@
 	/* codec-specific additional proc output */
 	void (*proc_widget_hook)(struct snd_info_buffer *buffer,
 				 struct hda_codec *codec, hda_nid_t nid);
+#ifndef __GEN_KSYMS__
+	/* this was originally in codec_ops */
+	int (*pre_resume)(struct hda_codec *codec);
+#endif
 };
 
 /* direction */
--- a/sound/pci/hda/patch_sigmatel.c
+++ b/sound/pci/hda/patch_sigmatel.c
@@ -5152,7 +5152,6 @@
 #ifdef SND_HDA_NEEDS_RESUME
 	.suspend = stac92xx_suspend,
 	.resume = stac92xx_resume,
-	.pre_resume = stac92xx_pre_resume,
 #endif
 	.reboot_notify = stac92xx_shutup,
 };
@@ -5216,6 +5215,9 @@
 		spec->hp_detect = 0;
 
 	codec->patch_ops = stac92xx_patch_ops;
+#ifdef SND_HDA_NEEDS_RESUME
+	codec->pre_resume = stac92xx_pre_resume;
+#endif
 
 	return 0;
 }
@@ -5299,6 +5301,9 @@
 	}
 
 	codec->patch_ops = stac92xx_patch_ops;
+#ifdef SND_HDA_NEEDS_RESUME
+	codec->pre_resume = stac92xx_pre_resume;
+#endif
 
 	return 0;
 }
@@ -5444,6 +5449,9 @@
 		spec->hp_detect = 0;
 
 	codec->patch_ops = stac92xx_patch_ops;
+#ifdef SND_HDA_NEEDS_RESUME
+	codec->pre_resume = stac92xx_pre_resume;
+#endif
 
 	codec->proc_widget_hook = stac92hd7x_proc_hook;
 
@@ -5580,6 +5588,9 @@
 	}
 
 	codec->patch_ops = stac92xx_patch_ops;
+#ifdef SND_HDA_NEEDS_RESUME
+	codec->pre_resume = stac92xx_pre_resume;
+#endif
 
 	if (find_mute_led_gpio(codec, 0))
 		snd_printd("mute LED gpio %d polarity %d\n",
@@ -5676,6 +5687,9 @@
 	codec->spec = spec;
 	spec->linear_tone_beep = 0;
 	codec->patch_ops = stac92xx_patch_ops;
+#ifdef SND_HDA_NEEDS_RESUME
+	codec->pre_resume = stac92xx_pre_resume;
+#endif
 	spec->num_pins = STAC92HD71BXX_NUM_PINS;
 	switch (codec->vendor_id) {
 	case 0x111d76b6:
@@ -5991,6 +6005,9 @@
 	}
 
 	codec->patch_ops = stac92xx_patch_ops;
+#ifdef SND_HDA_NEEDS_RESUME
+	codec->pre_resume = stac92xx_pre_resume;
+#endif
 
 	/* Fix Mux capture level; max to 2 */
 	snd_hda_override_amp_caps(codec, 0x12, HDA_OUTPUT,
@@ -6115,6 +6132,9 @@
 	}
 
 	codec->patch_ops = stac92xx_patch_ops;
+#ifdef SND_HDA_NEEDS_RESUME
+	codec->pre_resume = stac92xx_pre_resume;
+#endif
 
 	codec->proc_widget_hook = stac927x_proc_hook;
 
@@ -6239,6 +6259,9 @@
 	}
 
 	codec->patch_ops = stac92xx_patch_ops;
+#ifdef SND_HDA_NEEDS_RESUME
+	codec->pre_resume = stac92xx_pre_resume;
+#endif
 
 	codec->proc_widget_hook = stac9205_proc_hook;
 
@@ -6334,6 +6357,9 @@
 	}
 	spec->input_mux = &spec->private_imux;
 	codec->patch_ops = stac92xx_patch_ops;
+#ifdef SND_HDA_NEEDS_RESUME
+	codec->pre_resume = stac92xx_pre_resume;
+#endif
 	return 0;
 }
 
