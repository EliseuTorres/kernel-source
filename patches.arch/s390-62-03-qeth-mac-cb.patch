Subject: qeth: set new mac even if old mac is gone (2)
From: Ursula Braun <ursula.braun@de.ibm.com>
Patch-mainline: v3.7-rc6
Git-commit: 7702745b15128e5f0659693736a864e35be1c807
Git-commit: e0a8114c034cf8012565c5d56dd90967023cc724
References: bnc#792656,LTC#87138

Symptom:      qeth slaves of bonding in active_backup mode and
              fail_over_mac=2 show same mac address after failover.
Problem:      If the set_mac_address() function of qeth is invoked,
              qeth deletes the old mac address first on OSA. Only 
              if deletion returns successfully the new mac address
              is set on OSA. Deletion may return with a return value
              "MAC not found on OSA". In this case qeth should 
              continue setting the new mac address.
              When the OSA cable is pulled, OSA forgets any set 
              mac address. If the OSA network interface acts as a 
              slave to a bonding master interface, bonding can
              invoke the set_mac_address function for failover
              purposes and depends on successful setting of the new
              mac address even though the old mac address could no
              longer be deleted.
Solution:     Continue setting the new mac address even if deletion
              of old mac address fails with "MAC not found on OSA".
              Backport of the upstream solution does not work due to
              differences in qeth_l2_send_delmac_cb(). Backport of
              the corresponding upstream patch has been given up
              since the upstream patch touches more code lines than
              necessary to solve the bonding failover problem. The
              chosen solution allows to keep the patches for old and
              new distros common.
Reproduction: Setup bonding interface in active_backup mode and
              fail_over_mac=2 with 2 OSA-cards as slaves and enforce
              failover by pulling the cable of the active OSA slave.

Signed-off-by: Ursula Braun <ursula.braun@de.ibm.com>
Acked-by: John Jolly <jjolly@suse.de>
---
 drivers/s390/net/qeth_l2_main.c |    8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

--- a/drivers/s390/net/qeth_l2_main.c
+++ b/drivers/s390/net/qeth_l2_main.c
@@ -598,7 +598,11 @@ static int qeth_l2_send_delmac_cb(struct
 	cmd = (struct qeth_ipa_cmd *) data;
 	if (cmd->hdr.return_code) {
 		QETH_CARD_TEXT_(card, 2, "err%d", cmd->hdr.return_code);
-		cmd->hdr.return_code = -EIO;
+		if (cmd->hdr.return_code == IPA_RC_L2_MAC_NOT_FOUND) {
+			card->info.mac_bits &= ~QETH_LAYER2_MAC_REGISTERED;
+			cmd->hdr.return_code = 0;
+		} else
+			cmd->hdr.return_code = -EIO;
 		return 0;
 	}
 	card->info.mac_bits &= ~QETH_LAYER2_MAC_REGISTERED;
@@ -676,7 +680,7 @@ static int qeth_l2_set_mac_address(struc
 		return -ERESTARTSYS;
 	}
 	rc = qeth_l2_send_delmac(card, &card->dev->dev_addr[0]);
-	if (!rc || (rc == IPA_RC_L2_MAC_NOT_FOUND))
+	if (!rc)
 		rc = qeth_l2_send_setmac(card, addr->sa_data);
 	return rc;
 }
