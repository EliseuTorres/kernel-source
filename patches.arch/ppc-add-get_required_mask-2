From: Milton Miller <miltonm@bga.com>
Subject: dma-mapping: Add get_required_mask if arch overrides default
Git-commit: 3a8f7558e475b68254d8bc3a2211f3f89bf67a71
Patch-mainline: yes
References: bnc#807082 

    If an architecture sets ARCH_HAS_DMA_GET_REQUIRED_MASK and has settable
    dma_map_ops, the required mask may change by the ops implementation.
    For example, a system that always has an mmu inline may only require 32
    bits while a swiotlb would desire bits to cover all of memory.
    
    Therefore add the field if the architecture does not use the generic
    definition of dma_get_required_mask. The first use will by by powerpc.
    Note that this does add some dependency on the order in which files are
    visible here.
    
Signed-off-by: Milton Miller <miltonm@bga.com>
Signed-off-by: Nishanth Aravamudan <nacc@us.ibm.com>
Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
Acked-by: FUJITA Tomonori <fujita.tomonori@lab.ntt.co.jp>
Acked-by: Torsten Duwe <duwe@suse.de>

diff --git a/include/linux/dma-mapping.h b/include/linux/dma-mapping.h
index 347fdc3..aa32fec 100644
--- a/include/linux/dma-mapping.h
+++ b/include/linux/dma-mapping.h
@@ -41,6 +41,9 @@ struct dma_map_ops {
 	int (*mapping_error)(struct device *dev, dma_addr_t dma_addr);
 	int (*dma_supported)(struct device *dev, u64 mask);
 	int (*set_dma_mask)(struct device *dev, u64 mask);
+#ifdef ARCH_HAS_DMA_GET_REQUIRED_MASK
+	u64 (*get_required_mask)(struct device *dev);
+#endif
 	int is_phys;
 };
 
