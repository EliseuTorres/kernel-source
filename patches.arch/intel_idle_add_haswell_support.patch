From: Len Brown <len.brown@intel.com>
Subject: intel_idle: support Haswell
References: fate#313720
Patch-Mainline: pm+acpi-3.9-rc1^2
Git-commit: 85a4d2d41dc6d1c0296326204a857a9fab864a31
Git-repo: git.kernel.org/pub/scm/linux/kernel/git/rafael/linux-pm.git

Signed-off-by: Thomas Renninger <trenn@suse.de>

This patch enables intel_idle to run on the
next-generation Intel(R) Microarchitecture code named "Haswell".

Signed-off-by: Len Brown <len.brown@intel.com>

Index: linux-3.0-SLE11-SP3/drivers/idle/intel_idle.c
===================================================================
--- linux-3.0-SLE11-SP3.orig/drivers/idle/intel_idle.c
+++ linux-3.0-SLE11-SP3/drivers/idle/intel_idle.c
@@ -204,6 +204,42 @@ static struct cpuidle_state ivb_cstates[
 		.enter = &intel_idle },
 };
 
+static struct cpuidle_state hsw_cstates[MWAIT_MAX_NUM_CSTATES] = {
+	{ /* MWAIT C0 */ },
+	{ /* MWAIT C1 */
+		.name = "C1-HSW",
+		.desc = "MWAIT 0x00",
+		.driver_data = (void *) 0x00,
+		.flags = CPUIDLE_FLAG_TIME_VALID,
+		.exit_latency = 2,
+		.target_residency = 2,
+		.enter = &intel_idle },
+	{ /* MWAIT C2 */
+		.name = "C3-HSW",
+		.desc = "MWAIT 0x10",
+		.driver_data = (void *) 0x10,
+		.flags = CPUIDLE_FLAG_TIME_VALID | CPUIDLE_FLAG_TLB_FLUSHED,
+		.exit_latency = 33,
+		.target_residency = 100,
+		.enter = &intel_idle },
+	{ /* MWAIT C3 */
+		.name = "C6-HSW",
+		.desc = "MWAIT 0x20",
+		.driver_data = (void *) 0x20,
+		.flags = CPUIDLE_FLAG_TIME_VALID | CPUIDLE_FLAG_TLB_FLUSHED,
+		.exit_latency = 133,
+		.target_residency = 400,
+		.enter = &intel_idle },
+	{ /* MWAIT C4 */
+		.name = "C7s-HSW",
+		.desc = "MWAIT 0x32",
+		.driver_data = (void *) 0x32,
+		.flags = CPUIDLE_FLAG_TIME_VALID | CPUIDLE_FLAG_TLB_FLUSHED,
+		.exit_latency = 166,
+		.target_residency = 500,
+		.enter = &intel_idle },
+};
+
 static struct cpuidle_state atom_cstates[MWAIT_MAX_NUM_CSTATES] = {
 	{ /* MWAIT C0 */ },
 	{ /* MWAIT C1 */
@@ -400,6 +436,12 @@ static int intel_idle_probe(void)
 		cpuidle_state_table = ivb_cstates;
 		break;
 
+	case 0x3C:      /* HSW */
+	case 0x3F:      /* HSW */
+	case 0x45:      /* HSW */
+		cpuidle_state_table = hsw_cstates;
+		break;
+
 	default:
 		pr_debug(PREFIX "does not run on family %d model %d\n",
 			boot_cpu_data.x86, boot_cpu_data.x86_model);
