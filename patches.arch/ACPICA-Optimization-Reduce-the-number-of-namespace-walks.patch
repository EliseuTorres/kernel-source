From: Alexey Starikovskiy <astarikovskiy@suse.de>
Subject: ACPICA: Optimization: Reduce the number of namespace walks
Git-commit: a9fc03125ea0001ff18bc29da9539b587fdbd1d7
References: bnc#601520, FATE#306952
 
Patch-mainline: v2.6.36-rc1

On control method exit, only walk the namespace if the method is
known to have created namespace objects outside of its local scope.

Signed-off-by: Alexey Starikovskiy <astarikovskiy@suse.de>
Signed-off-by: Bob Moore <robert.moore@intel.com>
Signed-off-by: Lin Ming <ming.m.lin@intel.com>
Signed-off-by: Len Brown <len.brown@intel.com>
Signed-off-by: Rafael J. Wysocki <rjw@suse.de>
---
 drivers/acpi/acpica/acobject.h |    1 +
 drivers/acpi/acpica/dsmethod.c |   17 +++++++++++++++--
 drivers/acpi/acpica/nsalloc.c  |   19 +++++++++++++++----
 3 files changed, 31 insertions(+), 6 deletions(-)

Index: linux-2.6.32-SLE11-SP1/drivers/acpi/acpica/dsmethod.c
===================================================================
--- linux-2.6.32-SLE11-SP1.orig/drivers/acpi/acpica/dsmethod.c
+++ linux-2.6.32-SLE11-SP1/drivers/acpi/acpica/dsmethod.c
@@ -584,8 +584,21 @@ acpi_ds_terminate_control_method(union a
 		 * want make the objects permanent.
 		 */
 		if (!(method_desc->method.flags & AOPOBJ_MODULE_LEVEL)) {
-			acpi_ns_delete_namespace_by_owner(method_desc->method.
-							  owner_id);
+
+			/* Delete any direct children of (created by) this method */
+
+			acpi_ns_delete_namespace_subtree(walk_state->
+							 method_node);
+
+			/*
+			 * Delete any objects that were created by this method
+			 * elsewhere in the namespace (if any were created).
+			 */
+			if (method_desc->method.modifies_namespace) {
+				acpi_ns_delete_namespace_by_owner(method_desc->
+								  method.
+								  owner_id);
+			}
 		}
 	}
 
Index: linux-2.6.32-SLE11-SP1/drivers/acpi/acpica/nsalloc.c
===================================================================
--- linux-2.6.32-SLE11-SP1.orig/drivers/acpi/acpica/nsalloc.c
+++ linux-2.6.32-SLE11-SP1/drivers/acpi/acpica/nsalloc.c
@@ -228,12 +228,23 @@ void acpi_ns_install_node(struct acpi_wa
 
 	ACPI_FUNCTION_TRACE(ns_install_node);
 
-	/*
-	 * Get the owner ID from the Walk state. The owner ID is used to track
-	 * table deletion and deletion of objects created by methods.
-	 */
 	if (walk_state) {
+		/*
+		 * Get the owner ID from the Walk state. The owner ID is used to
+		 * track table deletion and deletion of objects created by methods.
+		 */
 		owner_id = walk_state->owner_id;
+
+		if ((walk_state->method_desc) &&
+		    (parent_node != walk_state->method_node)) {
+			/*
+			 * A method is creating a new node that is not a child of the
+			 * method (it is non-local). Mark the executing method as having
+			 * modified the namespace. This is used for cleanup when the
+			 * method exits.
+			 */
+			walk_state->method_desc->method.modifies_namespace = TRUE;
+		}
 	}
 
 	/* Link the new entry into the parent and existing children */
Index: linux-2.6.32-SLE11-SP1/drivers/acpi/acpica/acobject.h
===================================================================
--- linux-2.6.32-SLE11-SP1.orig/drivers/acpi/acpica/acobject.h
+++ linux-2.6.32-SLE11-SP1/drivers/acpi/acpica/acobject.h
@@ -184,6 +184,7 @@ struct acpi_object_method {
 	u32 aml_length;
 	u8 thread_count;
 	acpi_owner_id owner_id;
+	u8 modifies_namespace;
 };
 
 /******************************************************************************
