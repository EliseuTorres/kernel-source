From: Haicheng Li <haicheng.li@linux.intel.com>
Subject: x86: map hotadded cpu to correct node
Patch-Mainline: yes
References: bnc#567283

Git-commit: 0271f91003d3703675be13b8865618359a6caa1f

http://lkml.org/lkml/2010/2/4/126

When hotadd new cpu to system, if its affinitive node is online, should map the cpu to its own node. 
otherwise, let kernel select one online node for the new cpu later.

Signed-off-by: Haicheng Li <haicheng.li@linux.intel.com>
Signed-off-by: Thomas Renninger <trenn@suse.de>
---
 arch/x86/kernel/acpi/boot.c |   21 +++++++++++++++++++++
 1 file changed, 21 insertions(+)

Index: linux-2.6.32-SLE11-SP1/arch/x86/kernel/acpi/boot.c
===================================================================
--- linux-2.6.32-SLE11-SP1.orig/arch/x86/kernel/acpi/boot.c
+++ linux-2.6.32-SLE11-SP1/arch/x86/kernel/acpi/boot.c
@@ -49,6 +49,7 @@ EXPORT_SYMBOL(acpi_disabled);
 
 #ifdef	CONFIG_X86_64
 # include <asm/proto.h>
+# include <asm/numa_64.h>
 #endif				/* X86 */
 
 #define BAD_MADT_ENTRY(entry, end) (					    \
@@ -489,6 +490,25 @@ int acpi_register_gsi(struct device *dev
  */
 #ifdef CONFIG_ACPI_HOTPLUG_CPU
 
+static void acpi_map_cpu2node(acpi_handle handle, int cpu, int physid)
+{
+#ifdef CONFIG_ACPI_NUMA
+	int nid;
+
+	nid = acpi_get_node(handle);
+	if (nid == -1 || !node_online(nid))
+		return;
+#ifdef CONFIG_X86_64
+	apicid_to_node[physid] = nid;
+	numa_set_node(cpu, nid);
+#else /* CONFIG_X86_32 */
+	apicid_2_node[physid] = nid;
+	cpu_to_node_map[cpu] = nid;
+#endif
+
+#endif
+}
+
 static int __cpuinit _acpi_map_lsapic(acpi_handle handle, int *pcpu)
 {
 	struct acpi_buffer buffer = { ACPI_ALLOCATE_BUFFER, NULL };
@@ -547,6 +567,7 @@ static int __cpuinit _acpi_map_lsapic(ac
 	}
 
 	cpu = cpumask_first(new_map);
+	acpi_map_cpu2node(handle, cpu, physid);
 
 	*pcpu = cpu;
 	retval = 0;
