From: Martin Schwidefsky <schwidefsky@de.ibm.com>
Subject: s390/mm: limit STACK_RND_MASK for compat tasks
Patch-mainline: v4.0-rc6
Git-commit: e143fa93c28669a7f0851e6850b1da5b1945fd53
References: bnc#929879, LTC#KRN1514

Summary:     s390: z13 base performance
Description: Provide the backport of a minimum set of upstream patches
             to optimize the base performance of the IBM z13 machine.

Upstream-Description:

             s390/mm: limit STACK_RND_MASK for compat tasks

             For compat tasks the mmap randomization does not use the maximum
             randomization value from mmap_rnd_mask but the fixed value of 0x7ff.
             This needs to be respected in the definition of STACK_RND_MASK as
             well.

             Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>


Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
Acked-by: John Jolly <jjolly@suse.de>
---
 arch/s390/include/asm/elf.h |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

--- a/arch/s390/include/asm/elf.h
+++ b/arch/s390/include/asm/elf.h
@@ -210,7 +210,7 @@ do {								\
 
 extern unsigned long mmap_rnd_mask;
 
-#define STACK_RND_MASK	(mmap_rnd_mask)
+#define STACK_RND_MASK	(test_thread_flag(TIF_31BIT) ? 0x7ff : mmap_rnd_mask)
 
 #define ARCH_DLINFO							    \
 do {									    \
