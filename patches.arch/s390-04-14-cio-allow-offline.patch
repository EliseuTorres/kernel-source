Subject: cio: not operational devices cannot be deactivated
References: BNC#563999
From: Gerald Schaefer <geraldsc@de.ibm.com>
Patch-mainline: 2.6.33-rc1
Git-commit: 350e91207bc9c6a464c22b9e0e30d21dfc07efe3

Symptom: Attempts to set a device offline which has become not operational
             are rejected with message "Resource temporarily unavailable".
Problem: A check in the device offline function rejects the offline
             request in case the device is in not operational state.
Solution: Remove the check for not operational so that users can deactivate
             and remove devices from Linux which, at some point, appeared
             not operational.
Acked-by: John Jolly <jjolly@suse.de>

---
 drivers/s390/cio/device.c |    9 ++++-----
 1 file changed, 4 insertions(+), 5 deletions(-)

Index: linux-sles11sp1/drivers/s390/cio/device.c
===================================================================
--- linux-sles11sp1.orig/drivers/s390/cio/device.c
+++ linux-sles11sp1/drivers/s390/cio/device.c
@@ -529,11 +529,10 @@ static ssize_t online_store (struct devi
 	int force, ret;
 	unsigned long i;
 
-	if ((cdev->private->state != DEV_STATE_OFFLINE &&
-	     cdev->private->state != DEV_STATE_ONLINE &&
-	     cdev->private->state != DEV_STATE_BOXED &&
-	     cdev->private->state != DEV_STATE_DISCONNECTED) ||
-	    atomic_cmpxchg(&cdev->private->onoff, 0, 1) != 0)
+	if (!dev_fsm_final_state(cdev) &&
+	    cdev->private->state != DEV_STATE_DISCONNECTED)
+		return -EAGAIN;
+	if (atomic_cmpxchg(&cdev->private->onoff, 0, 1) != 0)
 		return -EAGAIN;
 
 	if (cdev->drv && !try_module_get(cdev->drv->owner)) {
