From: Petr Tesarik <ptesarik@suse.cz>
Subject: x86: fix the initialization of physnode_map
References: bnc#748112
Patch-mainline: no

With DISCONTIGMEM, the mapping between a pfn and its owning node is
initialized using data provided by the BIOS. However, the initialization
may fail if the extents are not aligned to element boundary (64M).

While the bug is always present, it is more likely to be hit in kdump
kernels on large machines, because:

1. The memory map is specified as exactmap.
2. The reserved memory spans more than one 64M element.

Signed-off-by: Petr Tesarik <ptesarik@suse.cz>

---
 arch/x86/mm/numa_32.c |    9 +++++----
 1 file changed, 5 insertions(+), 4 deletions(-)

--- a/arch/x86/mm/numa_32.c
+++ b/arch/x86/mm/numa_32.c
@@ -47,15 +47,16 @@ EXPORT_SYMBOL(physnode_map);
 
 void memory_present(int nid, unsigned long start, unsigned long end)
 {
-	unsigned long pfn;
+	unsigned long elem, endelem;
 
 	printk(KERN_INFO "Node: %d, start_pfn: %lx, end_pfn: %lx\n",
 			nid, start, end);
 	printk(KERN_DEBUG "  Setting physnode_map array to node %d for pfns:\n", nid);
 	printk(KERN_DEBUG "  ");
-	for (pfn = start; pfn < end; pfn += PAGES_PER_ELEMENT) {
-		physnode_map[pfn / PAGES_PER_ELEMENT] = nid;
-		printk(KERN_CONT "%lx ", pfn);
+	endelem = (end-1) / PAGES_PER_ELEMENT;
+	for (elem = start / PAGES_PER_ELEMENT; elem <= endelem; ++elem) {
+		physnode_map[elem] = nid;
+		printk(KERN_CONT "%lx ", elem * PAGES_PER_ELEMENT);
 	}
 	printk(KERN_CONT "\n");
 }
