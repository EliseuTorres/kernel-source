From: Gerald Schaefer <geraldsc@de.ibm.com>
Subject: zfcp: cancel all pending work for a to be removed zfcp_port.
References: bnc#579111
Patch-mainline: Handled differently (ecf0c772)

Symptom:     Stalled queues and processes, leading to an unusable adapter.
Problem:     In some cases an invalid port cannot be detached because
             a pending work is already queued which is holding a reference
             to this port.
Solution:    To avoid this situation ensure no work is pending on the same
             queue on which a port_dequeue is currently running.

Acked-by: John Jolly <jjolly@suse.de>
---
 drivers/s390/scsi/zfcp_aux.c |    5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

--- a/drivers/s390/scsi/zfcp_aux.c
+++ b/drivers/s390/scsi/zfcp_aux.c
@@ -725,8 +725,11 @@ void zfcp_port_dequeue(struct zfcp_port 
 	write_lock_irq(&zfcp_data.config_lock);
 	list_del(&port->list);
 	write_unlock_irq(&zfcp_data.config_lock);
+	if (cancel_work_sync(&port->rport_work))
+		zfcp_port_put(port);
+	if (cancel_work_sync(&port->test_link_work))
+		zfcp_port_put(port);
 	wait_event(port->remove_wq, atomic_read(&port->refcount) == 0);
-	cancel_work_sync(&port->rport_work); /* usually not necessary */
 	zfcp_adapter_put(port->adapter);
 	sysfs_remove_group(&port->sysfs_device.kobj, &zfcp_sysfs_port_attrs);
 	device_unregister(&port->sysfs_device);
