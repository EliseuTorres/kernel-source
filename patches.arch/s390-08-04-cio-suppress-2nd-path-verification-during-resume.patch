From: Stefan Haberland <stefan.haberland@de.ibm.com>
Subject: cio: Suppress 2nd path verification during resume
Patch-mainline: v3.7-rc5
Git-commit: 31370f75de4b641f47204899549d2a533cd42738
References: bnc#825037, LTC#94554

Description:  cio: Suppress 2nd path verification during resume
Symptom:      While resuming a device several messages are displayed
              that the last path has gone and that a new path appeared.
              Sometimes the resume process stuck with unavailable
              paths for a device.
Problem:      The cio resume callback triggers a second round of path
              verification by setting all paths as unavailable and
              available again. This causes the driver to do
              unnecessarily path verification.
Solution:     Do not trigger a path verification in the subchannel
              event function during resume from hibernate. This will
              be started by the pm_restore callback later.
Reproduction: Do suspend/resume with DASD devices attached.

Signed-off-by: Stefan Haberland <stefan.haberland@de.ibm.com>
Acked-by: John Jolly <jjolly@suse.de>
---
 drivers/s390/cio/device.c |    8 +-------
 1 file changed, 1 insertion(+), 7 deletions(-)

--- a/drivers/s390/cio/device.c
+++ b/drivers/s390/cio/device.c
@@ -1425,7 +1425,7 @@ static enum io_sch_action sch_get_action
 	}
 	if (device_is_disconnected(cdev))
 		return IO_SCH_REPROBE;
-	if (cdev->online)
+	if (cdev->online && !cdev->private->flags.resuming)
 		return IO_SCH_VERIFY;
 	return IO_SCH_NOP;
 }
@@ -1468,12 +1468,6 @@ static int io_subchannel_sch_event(struc
 		rc = 0;
 		goto out_unlock;
 	case IO_SCH_VERIFY:
-		if (cdev->private->flags.resuming == 1) {
-			if (cio_enable_subchannel(sch, (u32)(addr_t)sch)) {
-				ccw_device_set_notoper(cdev);
-				break;
-			}
-		}
 		/* Trigger path verification. */
 		io_subchannel_verify(sch);
 		rc = 0;
