From: Gerald Schaefer <geraldsc@de.ibm.com>
Subject: cio: disallow driver io for known to be broken paths
Patch-mainline: yes
References: bnc#735369,LTC#77108

Symptom:     Device driver reports IO error.
Problem:     Drivers trying to do IO solely on paths which are online
	     but some way defective may lack the information to do
	     proper error handling.
Solution:    There is no reason to allow the usage of known to be
	     broken paths. Thus restrict the paths a ccw driver can
	     use for IO to a subset of the paths cio found usable.

Acked-by: John Jolly <jjolly@suse.de>
---
 drivers/s390/cio/device_ops.c |    8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

--- a/drivers/s390/cio/device_ops.c
+++ b/drivers/s390/cio/device_ops.c
@@ -213,9 +213,9 @@ int ccw_device_start_key(struct ccw_devi
 	ret = cio_set_options (sch, flags);
 	if (ret)
 		return ret;
-	/* Adjust requested path mask to excluded varied off paths. */
+	/* Adjust requested path mask to exclude unusable paths. */
 	if (lpm) {
-		lpm &= sch->opm;
+		lpm &= sch->lpm;
 		if (lpm == 0)
 			return -EACCES;
 	}
@@ -607,9 +607,9 @@ int ccw_device_tm_start_key(struct ccw_d
 		return -EINVAL;
 	if (cdev->private->state != DEV_STATE_ONLINE)
 		return -EIO;
-	/* Adjust requested path mask to excluded varied off paths. */
+	/* Adjust requested path mask to exclude unusable paths. */
 	if (lpm) {
-		lpm &= sch->opm;
+		lpm &= sch->lpm;
 		if (lpm == 0)
 			return -EACCES;
 	}
