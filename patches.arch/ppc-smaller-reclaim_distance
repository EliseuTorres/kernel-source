From: Anton Blanchard <anton@samba.org>
Date: Sun May 16 20:19:56 2010 +0000
Subject: powerpc/numa: Set a smaller value for RECLAIM_DISTANCE to enable zone
 reclaim
Git-commit: 56608209d34b8add40af54031d4e420afbcde9f6
References: FATE#311725, bnc#695067
Patch-mainline: v2.6.35-rc1

    I noticed /proc/sys/vm/zone_reclaim_mode was 0 on a ppc64 NUMA box. It gets
    enabled via this:
    
            /*
             * If another node is sufficiently far away then it is better
             * to reclaim pages in a zone before going off node.
             */
            if (distance > RECLAIM_DISTANCE)
                    zone_reclaim_mode = 1;
    
    Since we use the default value of 20 for REMOTE_DISTANCE and 20 for
    RECLAIM_DISTANCE it never kicks in.
    
    The local to remote bandwidth ratios can be quite large on System p
    machines so it makes sense for us to reclaim clean pagecache locally before
    going off node.
    
    The patch below sets a smaller value for RECLAIM_DISTANCE and thus enables
    zone reclaim.
    
Signed-off-by: Anton Blanchard <anton@samba.org>
Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
Acked-by: Torsten Duwe <duwe@suse.de>
---
 arch/powerpc/include/asm/topology.h |   10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/arch/powerpc/include/asm/topology.h b/arch/powerpc/include/asm/topology.h
index 22f738d..34045ac 100644
--- a/arch/powerpc/include/asm/topology.h
+++ b/arch/powerpc/include/asm/topology.h
@@ -8,6 +8,16 @@ struct device_node;
 
 #ifdef CONFIG_NUMA
 
+/*
+ * Before going off node we want the VM to try and reclaim from the local
+ * node. It does this if the remote distance is larger than RECLAIM_DISTANCE.
+ * With the default REMOTE_DISTANCE of 20 and the default RECLAIM_DISTANCE of
+ * 20, we never reclaim and go off node straight away.
+ *
+ * To fix this we choose a smaller value of RECLAIM_DISTANCE.
+ */
+#define RECLAIM_DISTANCE 10
+
 #include <asm/mmzone.h>
 
 static inline int cpu_to_node(int cpu)

