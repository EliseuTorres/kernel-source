From: Sebastian Ott <sebott@linux.vnet.ibm.com>
Subject: s390/scm: reorder scm_remove
Patch-mainline: v3.7-rc1
Git-commit: 24996edce547fd981c089db9a12717fd76a51160
References: bnc#792703,FATE#314095

s390/scm: reorder scm_remove

Do not reset drvdata before the block device is cleaned up. With a
non-empty block queue drvdata could be accessed.

Signed-off-by: Sebastian Ott <sebott@linux.vnet.ibm.com>
Acked-by: John Jolly <jjolly@suse.de>
---
 drivers/s390/block/scm_drv.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

--- a/drivers/s390/block/scm_drv.c
+++ b/drivers/s390/block/scm_drv.c
@@ -52,8 +52,8 @@ static int scm_remove(struct scm_device
 {
 	struct scm_blk_dev *bdev = dev_get_drvdata(&scmdev->dev);
 
-	dev_set_drvdata(&scmdev->dev, NULL);
 	scm_blk_dev_cleanup(bdev);
+	dev_set_drvdata(&scmdev->dev, NULL);
 	kfree(bdev);
 
 	return 0;
