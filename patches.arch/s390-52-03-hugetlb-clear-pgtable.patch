From: Gerald Schaefer <gerald.schaefer@de.ibm.com>
Subject: kernel: clear page table for sw large page emulation
Patch-mainline: yes
References: bnc#764091,LTC#81933

Symptom:      Application fails with "WARNING: at mm/vmalloc.c:106"
Problem:      The software large page emulation on s390 did not clear the the
              pre-allocated page table in arch_release_hugepage() before freeing
              it. This could trigger the WARN_ON(!pte_none(*pte) in
              mm/vmalloc.c:106 and make vmap_pte_range() fail, because the page
              table could be reused in page_table_alloc().
Solution:     This is fixed now by calling clear_table() before
              page_table_free().
Reproduction: On a system with software large pages, use and free hugetlbfs
              memory, then start an application that triggers vmalloc() usage
              in the kernel, like e.g. hyptop. Needs memory pressure also, and
              is not easy to reproduce.

Acked-by: John Jolly <jjolly@suse.de>
---
 arch/s390/mm/hugetlbpage.c |    2 ++
 1 file changed, 2 insertions(+)

--- a/arch/s390/mm/hugetlbpage.c
+++ b/arch/s390/mm/hugetlbpage.c
@@ -58,6 +58,8 @@ void arch_release_hugepage(struct page *
 	ptep = (pte_t *) page[1].index;
 	if (!ptep)
 		return;
+	clear_table((unsigned long *) ptep, _PAGE_TYPE_EMPTY,
+		    PTRS_PER_PTE * sizeof(pte_t));
 	page_table_free(&init_mm, (unsigned long *) ptep);
 	page[1].index = 0;
 }
