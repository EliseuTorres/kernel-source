From: Gerald Schaefer <geraldsc@de.ibm.com>
Subject: zfcp: Do not unblock rport from REOPEN_PORT_FORCED
References: bnc#617464,LTC#65807
Patch-mainline: Yes

Symptom:     The fc_remote_port is online, although the port is not
             available in the SAN.
Problem:     The zfcp erp triggers the call to fc_remote_port_add
             after the successful completion of the "reopen port" and
             "reopen port forced actions", although the "reopen port
             forced" action only results in a boxed port.
Solution:    Do not call fc_remote_port_add after completing the
             "reopen port forced", only after completing the "port
             reopen".

Acked-by: John Jolly <jjolly@suse.de>
---
 drivers/s390/scsi/zfcp_erp.c |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

--- a/drivers/s390/scsi/zfcp_erp.c	2010-07-06 13:25:46.000000000 +0200
+++ b/drivers/s390/scsi/zfcp_erp.c	2010-07-06 13:33:32.000000000 +0200
@@ -1171,10 +1171,11 @@ static void zfcp_erp_action_cleanup(stru
 		zfcp_unit_put(unit);
 		break;
 
-	case ZFCP_ERP_ACTION_REOPEN_PORT_FORCED:
 	case ZFCP_ERP_ACTION_REOPEN_PORT:
 		if (result == ZFCP_ERP_SUCCEEDED)
 			zfcp_scsi_schedule_rport_register(port);
+		/* fall through */
+	case ZFCP_ERP_ACTION_REOPEN_PORT_FORCED:
 		zfcp_port_put(port);
 		break;
 
