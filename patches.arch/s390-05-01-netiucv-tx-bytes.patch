Subject: netiucv: displayed TX bytes value much too high
References: BNC#565612
From: Gerald Schaefer <geraldsc@de.ibm.com>
Patch-mainline: 2.6.33-rc1
Git-commit: 998221c26b86a7edd621e66b437628c5ec0f8e9b

Symptom: wrong TX bytes value displayed with "ifconfig iucv0"
Problem: The netiucv driver updates the statistics value
             tx_bytes after the skb has been freed.
Solution: Move freeing of skb behind the update of the
             tx_bytes statistic value.
Acked-by: John Jolly <jjolly@suse.de>

---
 drivers/s390/net/netiucv.c |    4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

Index: linux-sles11sp1/drivers/s390/net/netiucv.c
===================================================================
--- linux-sles11sp1.orig/drivers/s390/net/netiucv.c
+++ linux-sles11sp1/drivers/s390/net/netiucv.c
@@ -741,13 +741,13 @@ static void conn_action_txdone(fsm_insta
 	if (single_flag) {
 		if ((skb = skb_dequeue(&conn->commit_queue))) {
 			atomic_dec(&skb->users);
-			dev_kfree_skb_any(skb);
 			if (privptr) {
 				privptr->stats.tx_packets++;
 				privptr->stats.tx_bytes +=
 					(skb->len - NETIUCV_HDRLEN
-					 	  - NETIUCV_HDRLEN);
+						  - NETIUCV_HDRLEN);
 			}
+			dev_kfree_skb_any(skb);
 		}
 	}
 	conn->tx_buff->data = conn->tx_buff->head;
