From: Gerald Schaefer <geraldsc@de.ibm.com>
Subject: cio: fix drvdata usage for the console subchannel
References: bnc#589679
Patch-mainline: Upstream submission made

Symptom:     Lockdep warning while ipl.
Problem:     For the console subchannel we use dev_set_drvdata prior
             to device_register while holding the subchannels spinlock.
             Due to driver core changes this will force the driver
             core to kmalloc its private data.
Solution:    For the console subchannel, set the drvdata before taking
             the subchannels spinlock.

Acked-by: John Jolly <jjolly@suse.de>
---
 drivers/s390/cio/device.c |    1 +
 1 file changed, 1 insertion(+)

--- a/drivers/s390/cio/device.c
+++ b/drivers/s390/cio/device.c
@@ -1520,6 +1520,7 @@ static int ccw_device_console_enable(str
 	sch->driver = &io_subchannel_driver;
 	/* Initialize the ccw_device structure. */
 	cdev->dev.parent= &sch->dev;
+	sch_set_cdev(sch, cdev);
 	io_subchannel_recog(cdev, sch);
 	/* Now wait for the async. recognition to come to an end. */
 	spin_lock_irq(cdev->ccwlock);
