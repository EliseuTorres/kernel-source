Subject: tape: incomplete device removal
References: BNC#565612
From: Gerald Schaefer <geraldsc@de.ibm.com>
Patch-mainline: 2.6.33-rc1
Git-commit: 1b52fff059d660d4bf83d97c389dd80f1e6aad9a

Symptom: After the removal of a tape device its sysfs attributes
             medium_state, first_minor, state, operation and blocksize
             are left behind and some memory is leaked.
Problem: The check for the driver data pointer in tape_generic_remove
             is incorrect, it checks for a NULL pointer instead of a
             non-NULL pointer.
Solution: Fix the check for drvdata in tape_generic_remove.
Acked-by: John Jolly <jjolly@suse.de>

---

 drivers/s390/char/tape_core.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

--- a/drivers/s390/char/tape_core.c
+++ b/drivers/s390/char/tape_core.c
@@ -665,7 +665,7 @@ tape_generic_remove(struct ccw_device *c
 			tape_cleanup_device(device);
 	}
 
-	if (!dev_get_drvdata(&cdev->dev)) {
+	if (dev_get_drvdata(&cdev->dev)) {
 		sysfs_remove_group(&cdev->dev.kobj, &tape_attr_group);
 		dev_set_drvdata(&cdev->dev, tape_put_device(dev_get_drvdata(&cdev->dev)));
 	}
