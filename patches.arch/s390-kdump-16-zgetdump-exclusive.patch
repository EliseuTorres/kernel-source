From: Michael Holzheu <holzheu@linux.vnet.ibm.com>
Subject: [S390] zfcpdump: Do not initialize zfcpdump in kdump mode
Date:   Mon Nov 14 11:19:05 2011 +0100
Patch-mainline: v3.2-rc3
Git-commit: 3f25dc4fcbc371f86a61a6af759003ebd4965908
References: bnc#786472,ltc#82694,fate#314077
    
When the kernel is started in kdump mode, zfcpdump should not be
initialized because both dump methods can't be used at the same time.

Signed-off-by: Michael Holzheu <holzheu@linux.vnet.ibm.com>
Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
Acked-by: John L. Jolly <jjolly@suse.de>

---
 arch/s390/kernel/setup.c  |    4 +++-
 drivers/s390/char/zcore.c |    2 ++
 2 files changed, 5 insertions(+), 1 deletion(-)

--- a/arch/s390/kernel/setup.c
+++ b/arch/s390/kernel/setup.c
@@ -212,6 +212,8 @@ static void __init setup_zfcpdump(unsign
 
 	if (ipl_info.type != IPL_TYPE_FCP_DUMP)
 		return;
+	if (OLDMEM_BASE)
+		return;
 	if (console_devno != -1)
 		sprintf(str, " cio_ignore=all,!0.0.%04x,!0.0.%04x",
 			ipl_info.data.fcp.dev_id.devno, console_devno);
@@ -490,7 +492,7 @@ static void __init setup_memory_end(void
 
 
 #ifdef CONFIG_ZFCPDUMP
-	if (ipl_info.type == IPL_TYPE_FCP_DUMP) {
+	if (ipl_info.type == IPL_TYPE_FCP_DUMP && !OLDMEM_BASE) {
 		memory_end = ZFCPDUMP_HSA_SIZE;
 		memory_end_set = 1;
 	}
--- a/drivers/s390/char/zcore.c
+++ b/drivers/s390/char/zcore.c
@@ -640,6 +640,8 @@ static int __init zcore_init(void)
 
 	if (ipl_info.type != IPL_TYPE_FCP_DUMP)
 		return -ENODATA;
+	if (OLDMEM_BASE)
+		return -ENODATA;
 
 	zcore_dbf = debug_register("zcore", 4, 1, 4 * sizeof(long));
 	debug_register_view(zcore_dbf, &debug_sprintf_view);
