From: Vasant Hegde <hegdevasant@linux.vnet.ibm.com>
Subject: [PATCH] powerpc: Make chip-id information available to userspace
Git-commit: 15863ff3b8dae4cacd831ce10aa34992e9ababb0
Patch-mainline: v3.12-rc1
References: bsc#919682

So far "/sys/devices/system/cpu/cpuX/topology/physical_package_id"
was always default (-1) on ppc64 architecture.

Now, some systems have an ibm,chip-id property in the cpu nodes in
the device tree. On these systems, we now use this information to
display physical_package_id.

Signed-off-by: Vasant Hegde <hegdevasant@linux.vnet.ibm.com>
Signed-off-by: Shivaprasad G Bhat <sbhat@linux.vnet.ibm.com>
Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
Acked-by: Dinar Valeev <dvaleev@suse.com>
---
 arch/powerpc/include/asm/smp.h      |  1 +
 arch/powerpc/include/asm/topology.h |  1 +
 arch/powerpc/kernel/smp.c           | 15 +++++++++++++++
 3 files changed, 17 insertions(+)

Index: linux-3.0-SLE11-SP3/arch/powerpc/include/asm/smp.h
===================================================================
--- linux-3.0-SLE11-SP3.orig/arch/powerpc/include/asm/smp.h
+++ linux-3.0-SLE11-SP3/arch/powerpc/include/asm/smp.h
@@ -102,6 +102,7 @@ static inline struct cpumask *cpu_core_m
 }
 
 extern int cpu_to_core_id(int cpu);
+extern int cpu_to_chip_id(int cpu);
 
 /* Since OpenPIC has only 4 IPIs, we use slightly different message numbers.
  *
Index: linux-3.0-SLE11-SP3/arch/powerpc/include/asm/topology.h
===================================================================
--- linux-3.0-SLE11-SP3.orig/arch/powerpc/include/asm/topology.h
+++ linux-3.0-SLE11-SP3/arch/powerpc/include/asm/topology.h
@@ -131,6 +131,7 @@ static inline int stop_topology_update(v
 #ifdef CONFIG_PPC64
 #include <asm/smp.h>
 
+#define topology_physical_package_id(cpu)	(cpu_to_chip_id(cpu))
 #define topology_thread_cpumask(cpu)	(per_cpu(cpu_sibling_map, cpu))
 #define topology_core_cpumask(cpu)	(per_cpu(cpu_core_map, cpu))
 #define topology_core_id(cpu)		(cpu_to_core_id(cpu))
Index: linux-3.0-SLE11-SP3/arch/powerpc/kernel/smp.c
===================================================================
--- linux-3.0-SLE11-SP3.orig/arch/powerpc/kernel/smp.c
+++ linux-3.0-SLE11-SP3/arch/powerpc/kernel/smp.c
@@ -547,6 +547,21 @@ out:
 	return id;
 }
 
+/* Return the value of the chip-id property corresponding
+ * to the given logical cpu.
+ */
+int cpu_to_chip_id(int cpu)
+{
+	struct device_node *np;
+
+	np = of_get_cpu_node(cpu, NULL);
+	if (!np)
+		return -1;
+
+	of_node_put(np);
+	return of_get_ibm_chip_id(np);
+}
+
 /* Helper routines for cpu to core mapping */
 int cpu_core_index_of_thread(int cpu)
 {
Index: linux-3.0-SLE11-SP3/arch/powerpc/include/asm/prom.h
===================================================================
--- linux-3.0-SLE11-SP3.orig/arch/powerpc/include/asm/prom.h
+++ linux-3.0-SLE11-SP3/arch/powerpc/include/asm/prom.h
@@ -72,6 +72,8 @@ static inline int of_node_to_nid(struct
 
 extern void of_instantiate_rtc(void);
 
+extern int of_get_ibm_chip_id(struct device_node *np);
+
 /* These includes are put at the bottom because they may contain things
  * that are overridden by this file.  Ideally they shouldn't be included
  * by this file, but there are a bunch of .c files that currently depend
Index: linux-3.0-SLE11-SP3/arch/powerpc/kernel/prom.c
===================================================================
--- linux-3.0-SLE11-SP3.orig/arch/powerpc/kernel/prom.c
+++ linux-3.0-SLE11-SP3/arch/powerpc/kernel/prom.c
@@ -740,6 +740,33 @@ struct device_node *of_find_next_cache_n
 	return NULL;
 }
 
+/**
+ * of_get_ibm_chip_id - Returns the IBM "chip-id" of a device
+ * @np: device node of the device
+ *
+ * This looks for a property "ibm,chip-id" in the node or any
+ * of its parents and returns its content, or -1 if it cannot
+ * be found.
+ */
+int of_get_ibm_chip_id(struct device_node *np)
+{
+	of_node_get(np);
+	while(np) {
+		struct device_node *old = np;
+		const __be32 *prop;
+
+		prop = of_get_property(np, "ibm,chip-id", NULL);
+		if (prop) {
+			of_node_put(np);
+			return be32_to_cpup(prop);
+		}
+		np = of_get_parent(np);
+		of_node_put(old);
+	}
+	return -1;
+}
+EXPORT_SYMBOL(cpu_to_chip_id);
+
 #ifdef CONFIG_PPC_PSERIES
 /*
  * Fix up the uninitialized fields in a new device node:
