From: Greg Pearson <greg.pearson@hp.com>
Subject: x86/apic: Use x2apic physical mode based on FADT setting
References: bnc#768052
Patch-Mainline: v3.4-rc6
Git-commit: ea0dcf903e7d76aa5d483d876215fedcfdfe140f


Signed-off-by: Thomas Renninger <trenn@suse.de>

Comment by trenn:
-----------------------------
Possible breakage/regression can only happen if:
Use APIC Physical Destination Mode (V4)
FADT flag is set to 1:

acpidump >acpidump
acpixtract -a acpidump
iasl -d FACP*.dat
grep "Use APIC Physical Destination Mode" FACP*.dsl

I grepped through 64 servers in our server room and only
1 (IBM x3950_M3) had the flag set.
And in the end it's still a fix and things should work
better on these.
-----------------------------

Provide systems that do not support x2apic cluster mode
a mechanism to select x2apic physical mode using the
FADT FORCE_APIC_PHYSICAL_DESTINATION_MODE bit.

Changes from v1: (based on Suresh's comments)
 - removed #ifdef CONFIG_ACPI
 - removed #include <linux/acpi.h>

Signed-off-by: Greg Pearson <greg.pearson@hp.com>
Acked-by: Suresh Siddha <suresh.b.siddha@intel.com>
Link: http://lkml.kernel.org/r/1335313436-32020-1-git-send-email-greg.pearson@hp.com
Signed-off-by: Ingo Molnar <mingo@kernel.org>

diff --git a/arch/x86/kernel/apic/x2apic_phys.c b/arch/x86/kernel/apic/x2apic_phys.c
index 8a778db..991e315 100644
--- a/arch/x86/kernel/apic/x2apic_phys.c
+++ b/arch/x86/kernel/apic/x2apic_phys.c
@@ -24,6 +24,12 @@ static int x2apic_acpi_madt_oem_check(char *oem_id, char *oem_table_id)
 {
 	if (x2apic_phys)
 		return x2apic_enabled();
+	else if ((acpi_gbl_FADT.header.revision >= FADT2_REVISION_ID) &&
+		(acpi_gbl_FADT.flags & ACPI_FADT_APIC_PHYSICAL) &&
+		x2apic_enabled()) {
+		printk(KERN_DEBUG "System requires x2apic physical mode\n");
+		return 1;
+	}
 	else
 		return 0;
 }
