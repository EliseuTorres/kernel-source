From: Gerald Schaefer <geraldsc@de.ibm.com>
Subject: zfcp: Fail erp after timeout
References: bnc#617464,LTC#65801
Patch-mainline: Yes

Symptom:     The erp does not recover from temporary interruptions at
             the remote port.
Problem:     The main erp strategy routine does not check for the
             TIMEDOUT flag. Instead, it tries the next erp step as if
             the timeout did not happen.
Solution:    Check for the TIMEDOUT flag and fail the erp action after
             a timeout. The fail will trigger appropriate followups.

Acked-by: John Jolly <jjolly@suse.de>
---
 drivers/s390/scsi/zfcp_erp.c |    6 ++++++
 1 file changed, 6 insertions(+)

--- a/drivers/s390/scsi/zfcp_erp.c	2010-07-06 10:25:54.000000000 +0200
+++ b/drivers/s390/scsi/zfcp_erp.c	2010-07-06 11:19:30.000000000 +0200
@@ -1222,6 +1222,11 @@ static int zfcp_erp_strategy(struct zfcp
 		goto unlock;
 	}
 
+	if (erp_action->status & ZFCP_STATUS_ERP_TIMEDOUT) {
+		retval = ZFCP_ERP_FAILED;
+		goto check_target;
+	}
+
 	zfcp_erp_action_to_running(erp_action);
 
 	/* no lock to allow for blocking operations */
@@ -1256,6 +1261,7 @@ static int zfcp_erp_strategy(struct zfcp
 		goto unlock;
 	}
 
+check_target:
 	retval = zfcp_erp_strategy_check_target(erp_action, retval);
 	zfcp_erp_action_dequeue(erp_action);
 	retval = zfcp_erp_strategy_statechange(erp_action, retval);
