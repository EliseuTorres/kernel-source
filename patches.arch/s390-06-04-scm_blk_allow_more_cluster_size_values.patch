From: Sebastian Ott <sebott@linux.vnet.ibm.com>
Subject: scm_block: Cannot specify optimal parameter for exclusive usecase
Patch-mainline: v3.10-rc1
Git-commit: bd86055fc938493259a15dc00ee77435b4d2e83f
References: bnc#817401, LTC#92891

Description:  scm_block: Cannot specify optimal parameter for exclusive usecase
Symptom:      Suboptimal performance when writing to FlashExpress storage
              in case of exclusive access to all SCM increments.
Problem:      A value of 64 for the write_cluster_size module parameter is
              required in a shared use scenario, that is when more than one
              operating system is accessing the FlashExpress storage. For an
              exclusive use case where all SCM increments of a FlashExpress
              adapter are assigned to a Linux instance, the recommended
              parameter value for write_cluster_size can be lower (for
              example 2). Due to a too strict parameter parser, the module
              won't accept non-zero parameters other than 32, 64 and 128.
Solution:     Allow values down to 2 for the write_cluster_size parameter.
Reproduction: # modprobe scm_block write_cluster_size=2
              ERROR: could not insert 'scm_block': Invalid argument

Signed-off-by: Sebastian Ott <sebott@linux.vnet.ibm.com>
Acked-by: John Jolly <jjolly@suse.de>
--- a/drivers/s390/block/scm_blk_cluster.c
+++ b/drivers/s390/block/scm_blk_cluster.c
@@ -223,6 +223,8 @@ void scm_cluster_request_irq(struct scm_
 
 bool scm_cluster_size_valid(void)
 {
-	return write_cluster_size == 0 || write_cluster_size == 32 ||
-		write_cluster_size == 64 || write_cluster_size == 128;
+	if (write_cluster_size == 1 || write_cluster_size > 128)
+		return false;
+
+	return !(write_cluster_size & (write_cluster_size - 1));
 }
