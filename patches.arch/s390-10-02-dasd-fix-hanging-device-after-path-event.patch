From: Stefan Haberland <stefan.haberland@de.ibm.com>
Subject: dasd: fix hanging devices after path events
Patch-mainline: not yet
Git-commit: -
References: bnc#831623, LTC#96336

Description:  dasd: fix hanging devices after path events
Symptom:      The DASD device seems to be operational but
              no I/O operation is processed after paths disappeared
              and appeared.
Problem:      The sleep_on_immediately function is used during path
              verification. It kills running I/O operation to perform
              a higher priorized task. The block tasklet is not
              scheduled again and so no blocklayer requests are caught
              from the block queue.
Solution:     Schedule the DASD tasklets again at the end of
              sleep_on_immediately.
Reproduction: Do I/O and trigger path events.

Signed-off-by: Stefan Haberland <stefan.haberland@de.ibm.com>
Acked-by: John Jolly <jjolly@suse.de>
---
 drivers/s390/block/dasd.c |    6 ++++++
 1 file changed, 6 insertions(+)

--- a/drivers/s390/block/dasd.c
+++ b/drivers/s390/block/dasd.c
@@ -2308,6 +2308,12 @@ int dasd_sleep_on_immediatly(struct dasd
 		rc = cqr->intrc;
 	else
 		rc = -EIO;
+
+	/* kick tasklets */
+	dasd_schedule_device_bh(device);
+	if (device->block)
+		dasd_schedule_block_bh(device->block);
+
 	return rc;
 }
 
