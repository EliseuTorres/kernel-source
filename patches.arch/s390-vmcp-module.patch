From: John Jolly <jjolly@suse.de>
Subject: Revert vmcp in-kernel only change
Reference: bnc#721007
Patch-mainline: no, SUSE only

This patch is to revert the following change made to put the vmcp
module as an in-kernel only module.

Certain customer scripts test on the presense of the vmcp module.
With the vmcp module compiled in-kernel, these scripts fail to work -
even though the driver is available.

Signed-off-by: John Jolly <jjolly@suse.de>

original mainline commit f73a2b03c59b95a3ee8eebcc127350c77c950e87
Author: Heiko Carstens <heiko.carstens@de.ibm.com>
Date:   Mon May 17 10:00:06 2010 +0200

    [S390] vmcp: disallow modular build
    
    Change the tristate Kbuild option into a bool option so that the module
    is either builtin or not available at all.
    There have been too many cases where people were missing the 'vmcp'
    device node and unable to send z/VM CP commands. So let's make sure
    that on distros it will always be present.
    
    Signed-off-by: Heiko Carstens <heiko.carstens@de.ibm.com>
    Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
---
 drivers/s390/char/Kconfig |    2 +-
 drivers/s390/char/vmcp.c  |   32 +++++++++++++++++++++++++++-----
 2 files changed, 28 insertions(+), 6 deletions(-)

--- a/drivers/s390/char/Kconfig
+++ b/drivers/s390/char/Kconfig
@@ -151,7 +151,7 @@ config VMLOGRDR
 	  This driver depends on the IUCV support driver.
 
 config VMCP
-	def_bool y
+	def_tristate m
 	prompt "Support for the z/VM CP interface"
 	depends on S390
 	help
--- a/drivers/s390/char/vmcp.c
+++ b/drivers/s390/char/vmcp.c
@@ -11,11 +11,15 @@
  * The idea of this driver is based on cpint from Neale Ferguson and #CP in CMS
  */
 
+#define KMSG_COMPONENT "vmcp"
+#define pr_fmt(fmt) KMSG_COMPONENT ": " fmt
+
 #include <linux/fs.h>
 #include <linux/init.h>
 #include <linux/compat.h>
 #include <linux/kernel.h>
 #include <linux/miscdevice.h>
+#include <linux/module.h>
 #include <linux/slab.h>
 #include <asm/compat.h>
 #include <asm/cpcmd.h>
@@ -23,6 +27,10 @@
 #include <asm/uaccess.h>
 #include "vmcp.h"
 
+MODULE_LICENSE("GPL");
+MODULE_AUTHOR("Christian Borntraeger <borntraeger@de.ibm.com>");
+MODULE_DESCRIPTION("z/VM CP interface");
+
 static debug_info_t *vmcp_debug;
 
 static int vmcp_open(struct inode *inode, struct file *file)
@@ -191,8 +199,11 @@ static int __init vmcp_init(void)
 {
 	int ret;
 
-	if (!MACHINE_IS_VM)
-		return 0;
+	if (!MACHINE_IS_VM) {
+		pr_warning("The z/VM CP interface device driver cannot be "
+			   "loaded without z/VM\n");
+		return -ENODEV;
+	}
 
 	vmcp_debug = debug_register("vmcp", 1, 1, 240);
 	if (!vmcp_debug)
@@ -205,8 +216,19 @@ static int __init vmcp_init(void)
 	}
 
 	ret = misc_register(&vmcp_dev);
-	if (ret)
+	if (ret) {
 		debug_unregister(vmcp_debug);
-	return ret;
+		return ret;
+	}
+
+	return 0;
 }
-device_initcall(vmcp_init);
+
+static void __exit vmcp_exit(void)
+{
+	misc_deregister(&vmcp_dev);
+	debug_unregister(vmcp_debug);
+}
+
+module_init(vmcp_init);
+module_exit(vmcp_exit);
