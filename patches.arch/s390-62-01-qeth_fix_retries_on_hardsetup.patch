Subject: qeth: Fix retry logic in hardsetup
From: Stefan Raspl <raspl@linux.vnet.ibm.com>
Patch-mainline: Submitted
References: bnc#792656,LTC#87080

Symptom:      Failures during IDX do not result in retries
Problem:      Logic was faulty and only allowed retries in corner cases
Solution:     Fix logic
Reproduction: Use faulty hardware that produces IDX setup failures

Signed-off-by: Stefan Raspl <raspl@linux.vnet.ibm.com>
Acked-by: John Jolly <jjolly@suse.de>
--- a/drivers/s390/net/qeth_core_main.c
+++ b/drivers/s390/net/qeth_core_main.c
@@ -4669,14 +4669,14 @@ static int qeth_core_driver_group(const
 
 int qeth_core_hardsetup_card(struct qeth_card *card)
 {
-	int retries = 0;
+	int retries = 3;
 	int rc;
 
 	QETH_DBF_TEXT(SETUP, 2, "hrdsetup");
 	atomic_set(&card->force_alloc_skb, 0);
 	qeth_get_channel_path_desc(card);
 retry:
-	if (retries)
+	if (retries < 3)
 		QETH_DBF_MESSAGE(2, "%s Retrying to do IDX activates.\n",
 			dev_name(&card->gdev->dev));
 	ccw_device_set_offline(CARD_DDEV(card));
@@ -4698,7 +4698,7 @@ retriable:
 		return rc;
 	} else if (rc) {
 		QETH_DBF_TEXT_(SETUP, 2, "1err%d", rc);
-		if (++retries > 3)
+		if (--retries < 0)
 			goto out;
 		else
 			goto retry;
