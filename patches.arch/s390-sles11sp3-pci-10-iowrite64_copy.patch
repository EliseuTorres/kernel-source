From: Jan Glauber <jang@linux.vnet.ibm.com>
Subject: s390/pci: speed up __iowrite64_copy by using pci store block insn
Patch-mainline: v3.8-rc1
Git-commit: 87bc359b9822a73f264f24f3c1b3e4e7e5ed7d72
References: bnc#848335,FATE#83037,LTC#94737

Benefit from pci store block instruction by writing up to 128 bytes
with a single instruction to MMIO space. Depending on the workload
this can result in a huge performance increase due to the reduced
number of instructions. The ordering guarantees of single stores
vs. one store block are identical.

Signed-off-by: Jan Glauber <jang@linux.vnet.ibm.com>
Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
Acked-by: John Jolly <jjolly@suse.de>
---
 arch/s390/pci/pci.c |    6 ++++++
 1 file changed, 6 insertions(+)

--- a/arch/s390/pci/pci.c
+++ b/arch/s390/pci/pci.c
@@ -353,6 +353,12 @@ resource_size_t pcibios_align_resource(v
 	return 0;
 }
 
+/* combine single writes by using store-block insn */
+void __iowrite64_copy(void __iomem *to, const void *from, size_t count)
+{
+       zpci_memcpy_toio(to, from, count);
+}
+
 /* Create a virtual mapping cookie for a PCI BAR */
 void __iomem *pci_iomap(struct pci_dev *pdev, int bar, unsigned long max)
 {
