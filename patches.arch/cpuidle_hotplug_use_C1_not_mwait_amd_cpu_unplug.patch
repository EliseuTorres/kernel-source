From: Borislav Petkov <borislav.petkov@amd.com>
Subject: x86, hotplug: Fix powersavings with offlined cores on AMD
References: fate#311958
Git-commit: 93789b32dbf355e70f18b17a82e8661677a7f7fb
Patch-mainline: v2.6.38-rc3


Signed-off-by: Thomas Renninger <trenn@suse.de>

ea53069231f9317062910d6e772cca4ce93de8c8 made a CPU use monitor/mwait
when offline. This is not the optimal choice for AMD wrt to powersavings
and we'd prefer our cores to halt (i.e. enter C1) instead. For this, the
same selection whether to use monitor/mwait has to be used as when we
select the idle routine for the machine.

With this patch, offlining cores 1-5 on a X6 machine allows core0 to
boost again.

[ hpa: putting this in urgent since it is a (power) regression fix ]

Reported-by: Andreas Herrmann <andreas.herrmann3@amd.com>
Cc: stable@kernel.org # 37.x
Cc: H. Peter Anvin <hpa@linux.intel.com>
Cc: Arjan van de Ven <arjan@linux.intel.com>
Cc: Len Brown <lenb@kernel.org>
Cc: Venkatesh Pallipadi <venki@google.com>
Cc: Peter Zijlstra <a.p.zijlstra@chello.hl>
Signed-off-by: Borislav Petkov <borislav.petkov@amd.com>
LKML-Reference: <1295534572-10730-1-git-send-email-bp@amd64.org>
Signed-off-by: H. Peter Anvin <hpa@linux.intel.com>

---
 arch/x86/include/asm/cpu.h |    2 ++
 arch/x86/kernel/process.c  |    3 ++-
 arch/x86/kernel/smpboot.c  |    5 +++--
 3 files changed, 7 insertions(+), 3 deletions(-)

Index: linux-2.6.32-SLE11-SP2/arch/x86/include/asm/cpu.h
===================================================================
--- linux-2.6.32-SLE11-SP2.orig/arch/x86/include/asm/cpu.h
+++ linux-2.6.32-SLE11-SP2/arch/x86/include/asm/cpu.h
@@ -30,6 +30,8 @@ extern int arch_register_cpu(int num);
 extern void arch_unregister_cpu(int);
 #endif
 
+int __cpuinit mwait_usable(const struct cpuinfo_x86 *);
+
 DECLARE_PER_CPU(int, cpu_state);
 
 extern unsigned int boot_cpu_id;
Index: linux-2.6.32-SLE11-SP2/arch/x86/kernel/process.c
===================================================================
--- linux-2.6.32-SLE11-SP2.orig/arch/x86/kernel/process.c
+++ linux-2.6.32-SLE11-SP2/arch/x86/kernel/process.c
@@ -14,6 +14,7 @@
 #include <asm/system.h>
 #include <asm/apic.h>
 #include <asm/syscalls.h>
+#include <asm/cpu.h>
 #include <asm/idle.h>
 #include <asm/uaccess.h>
 #include <asm/i387.h>
@@ -403,7 +404,7 @@ static int __cpuinitdata force_mwait;
 #define MWAIT_ECX_EXTENDED_INFO		0x01
 #define MWAIT_EDX_C1			0xf0
 
-static int __cpuinit mwait_usable(const struct cpuinfo_x86 *c)
+int __cpuinit mwait_usable(const struct cpuinfo_x86 *c)
 {
 	u32 eax, ebx, ecx, edx;
 
Index: linux-2.6.32-SLE11-SP2/arch/x86/kernel/smpboot.c
===================================================================
--- linux-2.6.32-SLE11-SP2.orig/arch/x86/kernel/smpboot.c
+++ linux-2.6.32-SLE11-SP2/arch/x86/kernel/smpboot.c
@@ -1367,10 +1367,11 @@ static inline void mwait_play_dead(void)
 	unsigned int highest_subcstate = 0;
 	int i;
 	void *mwait_ptr;
+	struct cpuinfo_x86 *c = &current_cpu_data;
 
-	if (!cpu_has(&current_cpu_data, X86_FEATURE_MWAIT))
+	if (!(cpu_has(c, X86_FEATURE_MWAIT) && mwait_usable(c)))
 		return;
-	if (!cpu_has(&current_cpu_data, X86_FEATURE_CLFLSH))
+	if (!cpu_has(c, X86_FEATURE_CLFLSH))
 		return;
 	if (current_cpu_data.cpuid_level < CPUID_MWAIT_LEAF)
 		return;
