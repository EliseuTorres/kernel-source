From: Gerald Schaefer <geraldsc@de.ibm.com>
Subject: dasd: wait for terminated request
Patch-mainline: yes
References: bnc#724227,LTC#75904

Symptom:     CCW requests may get mixed up and fail.
Problem:     After clearing a running CQR a new request may be started
	     before the clear interrupt is received.
Solution:    After terminating a request in the dasd_sleep_on_immediatly
	     function, wait for the clear interrupt to be received before
	     starting the new request.

Acked-by: John Jolly <jjolly@suse.de>
---
 drivers/s390/block/dasd.c |    6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

--- a/drivers/s390/block/dasd.c
+++ b/drivers/s390/block/dasd.c
@@ -1777,7 +1777,11 @@ int dasd_sleep_on_immediatly(struct dasd
 	cqr->callback = dasd_wakeup_cb;
 	cqr->callback_data = DASD_SLEEPON_START_TAG;
 	cqr->status = DASD_CQR_QUEUED;
-	list_add(&cqr->devlist, &device->ccw_queue);
+	/*
+	 * add new request as second
+	 * first the terminated cqr needs to be finished
+	 */
+	list_add(&cqr->devlist, device->ccw_queue.next);
 
 	/* let the bh start the request to keep them in order */
 	dasd_schedule_device_bh(device);
