From 249135d1a2ea3c1719c48d31351413d55d2fdef4 Mon Sep 17 00:00:00 2001
From: Dmitry Torokhov <dmitry.torokhov@gmail.com>
Date: Sun, 15 Dec 2013 04:10:11 -0800
Subject: [PATCH] PNPACPI: check return value of pnp_add_device()

Git-commit: 249135d1a2ea3c1719c48d31351413d55d2fdef4
Patch-mainline: v3.14-rc1
Reference: fate#316836
Target: sle12

pnp_add_device() may fail so we need to handle errors and avoid leaking
memory. Also, do not use ACPI-specific return codes (AE_OK) but rather
standard one (0).

Signed-off-by: Dmitry Torokhov <dmitry.torokhov@gmail.com>
Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
Acked-by: Lee, Chun-Yi <jlee@suse.com>
---
 drivers/pnp/pnpacpi/core.c | 11 +++++++++--
 1 file changed, 9 insertions(+), 2 deletions(-)

Index: linux-3.12-SLE12/drivers/pnp/pnpacpi/core.c
===================================================================
--- linux-3.12-SLE12.orig/drivers/pnp/pnpacpi/core.c
+++ linux-3.12-SLE12/drivers/pnp/pnpacpi/core.c
@@ -252,6 +252,7 @@ static int __init pnpacpi_add_device(str
 	struct pnp_dev *dev;
 	char *pnpid;
 	struct acpi_hardware_id *id;
+	int error;
 
 	/* Skip devices that are already bound */
 	if (device->physical_node_count)
@@ -313,10 +314,16 @@ static int __init pnpacpi_add_device(str
 	/* clear out the damaged flags */
 	if (!dev->active)
 		pnp_init_resources(dev);
-	pnp_add_device(dev);
+
+	error = pnp_add_device(dev);
+	if (error) {
+		put_device(&dev->dev);
+		return error;
+	}
+
 	num++;
 
-	return AE_OK;
+	return 0;
 }
 
 static acpi_status __init pnpacpi_add_device_handler(acpi_handle handle,
