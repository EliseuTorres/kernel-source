From: Gerald Schaefer <geraldsc@de.ibm.com>
Subject: dasd: Correct offline processing.
References: bnc#583296
Patch-mainline: Upstream submission made

Symptom:     Setting a dasd with outstanding requests offline may hang.
Problem:     Flushing the dasd ccw request queue may stop the processing
	     of the block device request queue. Destroy partitions may
	     wait for outstanding requests and thus hang.
Solution:    Swapping dasd_destroy_partitions and
	     dasd_flush_request_queue so that the request queue is
	     empty before dasd_destroy_partitions is called.

Acked-by: John Jolly <jjolly@suse.de>

---
 drivers/s390/block/dasd.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

--- a/drivers/s390/block/dasd.c
+++ b/drivers/s390/block/dasd.c
@@ -323,8 +323,8 @@ static int dasd_state_ready_to_basic(str
 			device->state = DASD_STATE_READY;
 			return rc;
 		}
-		dasd_destroy_partitions(block);
 		dasd_flush_request_queue(block);
+		dasd_destroy_partitions(block);
 		block->blocks = 0;
 		block->bp_block = 0;
 		block->s2b_shift = 0;
