From: Matthew Garrett <mjg@redhat.com>
Subject: x86, efi: Ensure that the entirity of a region is mapped
Date: Thu May 5 15:19:46 2011 -0400
Patch-mainline: 3.0-rc1
References: bnc#568848, bnc#655434, bnc#681242

commit 935a638241b0658b9749edd060f972575f9d4a78

    x86, efi: Ensure that the entirity of a region is mapped
    
    It's possible for init_memory_mapping() to fail to map the entire region
    if it crosses a boundary, so ensure that we complete the mapping.
    
    Signed-off-by: Matthew Garrett <mjg@redhat.com>
    Link: http://lkml.kernel.org/r/1304623186-18261-5-git-send-email-mjg@redhat.com
    Signed-off-by: H. Peter Anvin <hpa@linux.intel.com>

--

Acked-by: Raymund Will <rw@suse.de>

---
 arch/x86/kernel/efi_64.c |    6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

--- a/arch/x86/kernel/efi_64.c
+++ b/arch/x86/kernel/efi_64.c
@@ -89,8 +89,10 @@ void __iomem *__init efi_ioremap(unsigne
 		return ioremap(phys_addr, size);
 
 	last_map_pfn = init_memory_mapping(phys_addr, phys_addr + size);
-	if ((last_map_pfn << PAGE_SHIFT) < phys_addr + size)
-		return NULL;
+	if ((last_map_pfn << PAGE_SHIFT) < phys_addr + size) {
+		unsigned long top = last_map_pfn << PAGE_SHIFT;
+		efi_ioremap(top, size - (top - phys_addr), type);
+	}
 
 	return (void __iomem *)__va(phys_addr);
 }
