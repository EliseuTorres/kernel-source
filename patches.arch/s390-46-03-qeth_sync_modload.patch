From: Gerald Schaefer <geraldsc@de.ibm.com>
Subject: qeth: synchronize discipline module loading
Patch-mainline: Yes
References: bnc#748629,LTC#78788

Symptom:     At system startup udev is not able to bring qeth devices
             online. Syslog shows following message: "There is no kernel
             module to support discipline 0".
Problem:     Udev may try to configure devices in parallel. Symbol lookup
             and module loading is not atomic.
Solution:    Synchronize discipline module loading.

Acked-by: John Jolly <jjolly@suse.de>
---
 drivers/s390/net/qeth_core_main.c |    4 ++++
 1 file changed, 4 insertions(+)

--- a/drivers/s390/net/qeth_core_main.c
+++ b/drivers/s390/net/qeth_core_main.c
@@ -50,6 +50,7 @@ static struct kmem_cache *qeth_qdio_outb
 static struct device *qeth_core_root_dev;
 static unsigned int known_devices[][6] = QETH_MODELLIST_ARRAY;
 static struct lock_class_key qdio_out_skb_queue_key;
+static struct mutex qeth_mod_mutex;
 
 static void qeth_send_control_data_cb(struct qeth_channel *,
 			struct qeth_cmd_buffer *);
@@ -4940,6 +4941,7 @@ int qeth_core_load_discipline(struct qet
 		enum qeth_discipline_id discipline)
 {
 	int rc = 0;
+	mutex_lock(&qeth_mod_mutex);
 	switch (discipline) {
 	case QETH_DISCIPLINE_LAYER3:
 		card->discipline.ccwgdriver = try_then_request_module(
@@ -4957,6 +4959,7 @@ int qeth_core_load_discipline(struct qet
 			"support discipline %d\n", discipline);
 		rc = -EINVAL;
 	}
+	mutex_unlock(&qeth_mod_mutex);
 	return rc;
 }
 
@@ -5440,6 +5443,7 @@ static int __init qeth_core_init(void)
 	pr_info("loading core functions\n");
 	INIT_LIST_HEAD(&qeth_core_card_list.list);
 	rwlock_init(&qeth_core_card_list.rwlock);
+	mutex_init(&qeth_mod_mutex);
 
 	rc = qeth_register_dbf_views();
 	if (rc)
