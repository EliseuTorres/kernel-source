From: Stefan Haberland <stefan.haberland@de.ibm.com>
Subject: dasd: validate request size before building CCW/TCW
Patch-mainline: v3.13-rc2
Git-commit: 26a35f373fbe6f21e8ad5ca4de1c01021e38fe2f
References: bnc#891087, LTC#114068

Description:  dasd: validate request size before building CCW/TCW
Symptom:      zHPF I/O errors with sense data reporting not the 
              expected number of data transferred.
Problem:      An I/O request that does not read or write full blocks
              cannot be translated into a correct CCW or TCW program 
              and should be rejected right away.
Solution:     Check the data size before building CCW or TCW programs
              and reject I/O requests that do not meet the correct 
              block size.
Reproduction: -

Signed-off-by: Stefan Haberland <stefan.haberland@de.ibm.com>
Acked-by: John Jolly <jjolly@suse.de>
---
 drivers/s390/block/dasd_eckd.c |    2 ++
 1 file changed, 2 insertions(+)

--- a/drivers/s390/block/dasd_eckd.c
+++ b/drivers/s390/block/dasd_eckd.c
@@ -3050,6 +3050,8 @@ static struct dasd_ccw_req *dasd_eckd_bu
 
 	fcx_multitrack = private->features.feature[40] & 0x20;
 	data_size = blk_rq_bytes(req);
+	if (data_size % blksize)
+		return ERR_PTR(-EINVAL);
 	/* tpm write request add CBC data on each track boundary */
 	if (rq_data_dir(req) == WRITE)
 		data_size += (last_trk - first_trk) * 4;
