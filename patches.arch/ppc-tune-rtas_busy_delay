From: Anton Blanchard <anton@samba.org>
Subject: powerpc/rtas: Only sleep in rtas_busy_delay if we have useful work to do
Patch-mainline: eca590f402332ab873d13f2d8d00fa0b91cfff36
References: FATE#311558, bnc#695066

    RTAS returns extended error codes as a hint of how long the
    OS might want to wait before retrying a call. If we have nothing
    else useful to do we may as well call back straight away.
    
    This was found when testing the new dynamic dma window feature.
    Firmware split the zeroing of the TCE table into 32k chunks but
    returned 9901 (which is a suggested wait of 10ms). All up this took
    about 10 minutes to complete since msleep is jiffies based and will
    round 10ms up to 20ms.
    
    With the patch below we take 3 seconds to complete the same test.
    The hint firmware is returning in the RTAS call should definitely
    be decreased, but even if we slept 1ms each iteration this would
    take 32s.
    
Signed-off-by: Anton Blanchard <anton@samba.org>
Acked-by: Nishanth Aravamudan <nacc@us.ibm.com>
Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
Acked-by: Torsten Duwe <duwe@suse.de>

diff --git a/arch/powerpc/kernel/rtas.c b/arch/powerpc/kernel/rtas.c
index bf90361..c4230ad 100644
--- a/arch/powerpc/kernel/rtas.c
+++ b/arch/powerpc/kernel/rtas.c
@@ -500,7 +500,7 @@ unsigned int rtas_busy_delay(int status)
 
 	might_sleep();
 	ms = rtas_busy_delay_time(status);
-	if (ms)
+	if (ms && need_resched())
 		msleep(ms);
 
 	return ms;
