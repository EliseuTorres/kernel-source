From: Sebastian Ott <sebott@linux.vnet.ibm.com>
Subject: ccwgroup: fix uevent vs dev attrs race
Patch-mainline: never, the cio developers need to fix this properly there instead of this hack
References: bnc#717797

Symptom:     network device is not made available automatically
Problem:     race condition between udev rules and kernel while accessing
             a sysfs attribute
Solution:    Suppress uevents until after the creating driver had a chance
             to bind to the ccwgroup device (ccwgroup_create_from_string()
             is called by the driver that will bind to it).

Signed-off-by: Sebastian Ott <sebott@linux.vnet.ibm.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
---
 drivers/s390/cio/ccwgroup.c |    3 +++
 1 file changed, 3 insertions(+)

--- a/drivers/s390/cio/ccwgroup.c
+++ b/drivers/s390/cio/ccwgroup.c
@@ -314,12 +314,15 @@ int ccwgroup_create_from_string(struct d
 
 	dev_set_name(&gdev->dev, "%s", dev_name(&gdev->cdev[0]->dev));
 	gdev->dev.groups = ccwgroup_attr_groups;
+	dev_set_uevent_suppress(&gdev->dev, 1);
 	rc = device_add(&gdev->dev);
 	if (rc)
 		goto error;
 	get_device(&gdev->dev);
 	rc = __ccwgroup_create_symlinks(gdev);
 	if (!rc) {
+		dev_set_uevent_suppress(&gdev->dev, 0);
+		kobject_uevent(&gdev->dev.kobj, KOBJ_ADD);
 		mutex_unlock(&gdev->reg_mutex);
 		put_device(&gdev->dev);
 		return 0;
