From f922d88854081d8f894f8c1767b0bded2be04342 Mon Sep 17 00:00:00 2001
From: Suman Tripathi <stripathi@apm.com>
Date: Thu, 28 Aug 2014 14:51:21 +0530
Subject: [PATCH 12/38] ahci_xgene: Skip the PHY and clock initialization if
 already configured by the firmware.
Git-commit: 0bed13bebd6c99d097796d2ca6c4f10fb5b2eabc
Patch-mainline: v3.17-rc5
References: bnc#902632

This patch implements the feature to skip the PHY and clock
initialization if it is already configured by the firmware.

Signed-off-by: Loc Ho <lho@apm.com>
Signed-off-by: Suman Tripathi <stripathi@apm.com>
Signed-off-by: Tejun Heo <tj@kernel.org>
Signed-off-by: Alexander Graf <agraf@suse.de>

---
 drivers/ata/ahci_xgene.c | 14 ++++++++++++++
 1 file changed, 14 insertions(+)

diff --git a/drivers/ata/ahci_xgene.c b/drivers/ata/ahci_xgene.c
index 10d5246..db2fa11 100644
--- a/drivers/ata/ahci_xgene.c
+++ b/drivers/ata/ahci_xgene.c
@@ -142,6 +142,14 @@ static unsigned int xgene_ahci_qc_issue(struct ata_queued_cmd *qc)
	return rc;
 }

+static bool xgene_ahci_is_memram_inited(struct xgene_ahci_context *ctx)
+{
+	void __iomem *diagcsr = ctx->csr_diag;
+
+	return (readl(diagcsr + CFG_MEM_RAM_SHUTDOWN) == 0 &&
+	        readl(diagcsr + BLOCK_MEM_RDY) == 0xFFFFFFFF);
+}
+
 /**
  * xgene_ahci_read_id - Read ID data from the specified device
  * @dev: device
@@ -461,6 +469,11 @@ static int xgene_ahci_probe(struct platform_device *pdev)
		return -ENODEV;
	}

+	if (xgene_ahci_is_memram_inited(ctx)) {
+		dev_info(dev, "skip clock and PHY initialization\n");
+		goto skip_clk_phy;
+	}
+
	/* Due to errata, HW requires full toggle transition */
	rc = ahci_platform_enable_clks(hpriv);
	if (rc)
@@ -484,6 +497,7 @@ static int xgene_ahci_probe(struct platform_device *pdev)
		goto disable_resources;
	}

+skip_clk_phy:
	hflags = AHCI_HFLAG_NO_PMP | AHCI_HFLAG_NO_NCQ;

	rc = ahci_platform_init_host(pdev, hpriv, &xgene_ahci_port_info,
--
2.1.0
