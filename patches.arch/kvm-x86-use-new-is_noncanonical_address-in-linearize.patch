From f4b9f0b8af6dc6753f4ade985fa33d2abfecbdd1 Mon Sep 17 00:00:00 2001
From: Nadav Amit <namit@cs.technion.ac.il>
Date: Thu, 18 Sep 2014 22:39:40 +0300
Subject: KVM: x86: Use new is_noncanonical_address in _linearize
Patch-mainline: not yet
References: CVE-2014-3647 bnc#899192

Replace the current canonical address check with the new function which is
identical.

Signed-off-by: Nadav Amit <namit@cs.technion.ac.il>
Signed-off-by: Bruce Rogers <brogers@suse.com>
---
 arch/x86/kvm/emulate.c | 24 +++++++++++++++++++++++-
 1 file changed, 23 insertions(+), 1 deletion(-)

diff --git a/arch/x86/kvm/emulate.c b/arch/x86/kvm/emulate.c
index cb00ec1..0231981 100644
--- a/arch/x86/kvm/emulate.c
+++ b/arch/x86/kvm/emulate.c
@@ -647,7 +647,7 @@ static int __linearize(struct x86_emulate_ctxt *ctxt,
 	case X86EMUL_MODE_REAL:
 		break;
 	case X86EMUL_MODE_PROT64:
-		if (((signed long)la << 16) >> 16 != la)
+		if (is_noncanonical_address(la))
 			return emulate_gp(ctxt, 0);
 		break;
 	default:
@@ -1853,6 +1853,28 @@ static int em_grp3(struct x86_emulate_ctxt *ctxt)
 	return X86EMUL_CONTINUE;
 }
 
+static int em_jmp_abs(struct x86_emulate_ctxt *ctxt)
+ {
+	struct decode_cache *c = &ctxt->decode;
+
+	return assign_eip_near(ctxt, c->src.val);
+}
+
+static int em_call_near_abs(struct x86_emulate_ctxt *ctxt)
+{
+	int rc;
+	long int old_eip;
+	struct decode_cache *c = &ctxt->decode;
+
+	old_eip = c->eip;
+	rc = assign_eip_near(ctxt, c->src.val);
+	if (rc != X86EMUL_CONTINUE)
+		return rc;
+	c->src.val = old_eip;
+	rc = em_push(ctxt);
+	return rc;
+ }
+
 static int em_grp45(struct x86_emulate_ctxt *ctxt)
 {
 	struct decode_cache *c = &ctxt->decode;

