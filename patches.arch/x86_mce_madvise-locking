From: Andi Kleen <ak@linux.intel.com>
Subject: HWPOISON: Use get_user_page_fast in hwpoison madvise
Patch-Mainline: 2.6.33-rc1
Git-commit: d15f107d97bd74c74d8f5144843d372666ddbdac
References: fate#307738

The previous version didn't take the mmap_sem before calling gup(),
which is racy.

Use get_user_pages_fast() instead which doesn't need any locks.
This is also faster of course, but then it doesn't really matter
because this is just a testing path.

Based on report from Nick Piggin.
Cc: npiggin@suse.de

Signed-off-by: Andi Kleen <ak@linux.intel.com>
Signed-off-by: Thomas Renninger <trenn@suse.de>

---
 mm/madvise.c |    3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

Index: linux-2.6.32/mm/madvise.c
===================================================================
--- linux-2.6.32.orig/mm/madvise.c
+++ linux-2.6.32/mm/madvise.c
@@ -231,8 +231,7 @@ static int madvise_hwpoison(int bhv, uns
 		return -EPERM;
 	for (; start < end; start += PAGE_SIZE) {
 		struct page *p;
-		int ret = get_user_pages(current, current->mm, start, 1,
-						0, 0, &p, NULL);
+		int ret = get_user_pages_fast(start, 1, 0, &p);
 		if (ret != 1)
 			return ret;
 		if (bhv == MADV_SOFT_OFFLINE) {
