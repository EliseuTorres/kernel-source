From: Stefan Haberland <stefan.haberland@de.ibm.com>
Subject: dasd: Fix unresponsive device after all channel paths were lost.
Patch-mainline: not yet
Git-commit: -
References: bnc#805052, LTC#88850

Description:  dasd: Fix unresponsive device after all channel paths were lost.
Symptom:      Disks may not respond after all channel paths were lost.
Problem:      The failfast bit is set incorrectly.
Solution:     Use set_bit() to enable failfast.
Reproduction: Disconnect and reconnect all channel paths from a device
              will trigger the race condition.

Signed-off-by: Stefan Haberland <stefan.haberland@de.ibm.com>
Acked-by: John Jolly <jjolly@suse.de>
---
 drivers/s390/block/dasd_eckd.c |   10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

--- a/drivers/s390/block/dasd_eckd.c
+++ b/drivers/s390/block/dasd_eckd.c
@@ -1574,7 +1574,10 @@ static void dasd_eckd_do_validate_server
 {
 	struct dasd_device *device = container_of(work, struct dasd_device,
 						  kick_validate);
-	if (dasd_eckd_validate_server(device, DASD_CQR_FLAGS_FAILFAST)
+	unsigned long flags = 0;
+
+	set_bit(DASD_CQR_FLAGS_FAILFAST, &flags);
+	if (dasd_eckd_validate_server(device, flags)
 	    == -EAGAIN) {
 		/* schedule worker again if failed */
 		schedule_work(&device->kick_validate);
@@ -4170,6 +4173,7 @@ static int dasd_eckd_restore_device(stru
 	int rc;
 	struct dasd_uid temp_uid;
 	unsigned long flags;
+	unsigned long cqr_flags = 0;
 
 	private = (struct dasd_eckd_private *) device->private;
 
@@ -4191,7 +4195,9 @@ static int dasd_eckd_restore_device(stru
 	rc = dasd_alias_make_device_known_to_lcu(device);
 	if (rc)
 		return rc;
-	dasd_eckd_validate_server(device, DASD_CQR_FLAGS_FAILFAST);
+
+	set_bit(DASD_CQR_FLAGS_FAILFAST, &cqr_flags);
+	dasd_eckd_validate_server(device, cqr_flags);
 
 	/* RE-Read Configuration Data */
 	dasd_eckd_read_conf(device);
