From: Ingo Tuchscherer <ingo.tuchscherer@linux.vnet.ibm.com>
Subject: zcrypt: ap bus rescan problem when toggle crypto adapters on/off
Patch-mainline: not yet
Git-commit: -
References: bnc#815926, LTC#91798

Description: zcrypt: ap bus rescan problem when toggle crypto adapters on/off
Symptom:     Kernel is throwing oops error messages.
Problem:     The bus rescan process was called simultaneously 
             on every device failure. This finally leads into 
             race conditions (double device add/remove actions).
Solution:    Mutual exclusion
Reproduction: On the SE navigate to crypto > crypto service operation
              select the particular PCHID, set offline by selecting LPAR
              After 1 minute then do online with same procedure
              Observe the operating system messages
Upstream-ID:  -
Problem-ID:   91798

Signed-off-by: Ingo Tuchscherer <ingo.tuchscherer@linux.vnet.ibm.com>
Acked-by: John Jolly <jjolly@suse.de>
---
 drivers/s390/crypto/ap_bus.c |   14 +++++---------
 1 file changed, 5 insertions(+), 9 deletions(-)

--- a/drivers/s390/crypto/ap_bus.c
+++ b/drivers/s390/crypto/ap_bus.c
@@ -955,15 +955,11 @@ EXPORT_SYMBOL(ap_driver_unregister);
 
 void ap_bus_force_rescan(void)
 {
-	/* Delete the AP bus rescan timer. */
-	del_timer(&ap_config_timer);
-
-	/* processing a synchonuous bus rescan */
-	ap_scan_bus(NULL);
-
-	/* Setup the AP bus rescan timer again. */
-	ap_config_timer.expires = jiffies + ap_config_time * HZ;
-	add_timer(&ap_config_timer);
+	/* reconfigure the AP bus rescan timer. */
+	mod_timer(&ap_config_timer, jiffies + ap_config_time * HZ);
+	/* processing a asynchronous bus rescan */
+	queue_work(ap_work_queue, &ap_config_work);
+	flush_work(&ap_config_work);
 }
 EXPORT_SYMBOL(ap_bus_force_rescan);
 
