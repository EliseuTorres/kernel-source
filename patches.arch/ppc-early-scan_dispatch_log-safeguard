From: Anton Blanchard <anton@samba.org>
Subject: powerpc: Fix oops if scan_dispatch_log is called too early
Patch-mainline: 84ffae55af79d7b8834fd0c08d0d1ebf2c77f91e
References: bnc#707988

    We currently enable interrupts before the dispatch log for the boot
    cpu is setup. If a timer interrupt comes in early enough we oops in
    scan_dispatch_log:
    
    Unable to handle kernel paging request for data at address 0x00000010
    
    ...
    
    .scan_dispatch_log+0xb0/0x170
    .account_system_vtime+0xa0/0x220
    .irq_enter+0x88/0xc0
    .do_IRQ+0x48/0x230
    
    The patch below adds a check to scan_dispatch_log to ensure the
    dispatch log has been allocated.

Signed-off-by: Anton Blanchard <anton@samba.org>
Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
Acked-by: Torsten Duwe <duwe@suse.de>

--- linux-2.6.32.43-0.4.99.522.bd92a97/arch/powerpc/kernel/time.c	2011-07-25 11:13:25.000000000 -0400
+++ bz73351/arch/powerpc/kernel/time.c	2011-07-26 15:07:41.000000000 -0400
@@ -241,6 +241,9 @@ static u64 scan_dispatch_log(u64 stop_tb
 	u64 stolen = 0;
 	u64 dtb;
 
+       if (!dtl)
+               return 0;
+
 	if (i == vpa->dtl_idx)
 		return 0;
 	while (i < vpa->dtl_idx) {
