From 6f80a9ded2b3b048ab9ba3bcc1a4d734065643ca Mon Sep 17 00:00:00 2001
From: Narinder <ndhillon@caviumnetworks.com>
Date: Thu, 11 Jun 2015 14:53:00 -0700
Subject: [PATCH 128/131] Fixes to get ACPI based kernel booting. Temporary
 fix to get going.
Git-commit: 942603a48cc1f8e7d689baa0e55a012c100081f2
Patch-mainline: Queued in subsystem maintainer repository
Git-repo: git://git.kernel.org/pub/scm/linux/kernel/git/rric/linux.git thunder/master-v4.1

Signed-off-by: Matthias Brugger <mbrugger@suse.com>

---
 arch/arm64/kernel/topology.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/arch/arm64/kernel/topology.c b/arch/arm64/kernel/topology.c
index fcb8f7b..8ca4ab2 100644
--- a/arch/arm64/kernel/topology.c
+++ b/arch/arm64/kernel/topology.c
@@ -258,12 +258,19 @@ void store_cpu_topology(unsigned int cpuid)
 		cpuid_topo->cluster_id = MPIDR_AFFINITY_LEVEL(mpidr, 2) |
 					 MPIDR_AFFINITY_LEVEL(mpidr, 3) << 8;
 	} else {
+#ifdef CONFIG_ACPI
+		/* Multiprocessor system : Single-thread per core */
+		cpuid_topo->thread_id  = -1;
+		cpuid_topo->core_id    = (((mpidr >> 8) & 0xff) * 16) + (mpidr & 0xff);
+		cpuid_topo->cluster_id = (cpuid_topo->core_id) > 47 ? 1:0;
+#else
 		/* Multiprocessor system : Single-thread per core */
 		cpuid_topo->thread_id  = -1;
 		cpuid_topo->core_id    = MPIDR_AFFINITY_LEVEL(mpidr, 0);
 		cpuid_topo->cluster_id = MPIDR_AFFINITY_LEVEL(mpidr, 1) |
 					 MPIDR_AFFINITY_LEVEL(mpidr, 2) << 8 |
 					 MPIDR_AFFINITY_LEVEL(mpidr, 3) << 16;
+#endif
 	}
 
 	pr_debug("CPU%u: cluster %d core %d thread %d mpidr %#016llx\n",
-- 
1.7.12.4

