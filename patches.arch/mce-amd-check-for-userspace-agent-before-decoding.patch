From 61c43829dfeb41f8a849108b23688d25cd9014c8 Mon Sep 17 00:00:00 2001
From: Borislav Petkov <bp@suse.de>
Date: Mon, 19 May 2014 20:38:03 +0200
Subject: [PATCH] MCE, AMD: Check for userspace agent before decoding
Patch-mainline: never
References: bnc#871881

Now that mcelog supports AMD, we want to check whether it is running in
userspace, and, if so, to not decode to dmesg. The moment mcelog gets
unloaded or killed or b0rked, we fallback to decoding to dmesg.

Signed-off-by: Borislav Petkov <bp@suse.de>
---
 arch/x86/include/asm/mce.h       | 1 +
 arch/x86/kernel/cpu/mcheck/mce.c | 6 ++++++
 drivers/edac/mce_amd.c           | 3 +++
 3 files changed, 10 insertions(+)

Index: kernel/arch/x86/include/asm/mce.h
===================================================================
--- kernel.orig/arch/x86/include/asm/mce.h	2014-05-19 20:36:27.812394577 +0200
+++ kernel/arch/x86/include/asm/mce.h	2014-05-19 20:42:30.964395832 +0200
@@ -248,4 +248,5 @@
 extern void apei_mce_report_mem_error(int corrected,
 				      struct cper_sec_mem_err *mem_err);
 
+int mce_get_userspace_consumers_count(void);
 #endif /* _ASM_X86_MCE_H */
Index: kernel/arch/x86/kernel/cpu/mcheck/mce.c
===================================================================
--- kernel.orig/arch/x86/kernel/cpu/mcheck/mce.c	2014-05-19 20:41:08.344395546 +0200
+++ kernel/arch/x86/kernel/cpu/mcheck/mce.c	2014-05-19 20:42:30.964395832 +0200
@@ -1770,6 +1770,12 @@
 	return 0;
 }
 
+int mce_get_userspace_consumers_count(void)
+{
+	return mce_chrdev_open_count;
+}
+EXPORT_SYMBOL_GPL(mce_get_userspace_consumers_count);
+
 static void collect_tscs(void *data)
 {
 	unsigned long *cpu_tsc = (unsigned long *)data;
Index: kernel/drivers/edac/mce_amd.c
===================================================================
--- kernel.orig/drivers/edac/mce_amd.c	2014-05-19 20:36:28.768394580 +0200
+++ kernel/drivers/edac/mce_amd.c	2014-05-19 20:42:30.968395832 +0200
@@ -738,6 +738,9 @@
 	struct cpuinfo_x86 *c = &cpu_data(m->extcpu);
 	int ecc;
 
+	if (mce_get_userspace_consumers_count())
+		return NOTIFY_STOP;
+
 	if (amd_filter_mce(m))
 		return NOTIFY_STOP;
 
