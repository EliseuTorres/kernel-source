From 41e639dab8a940deabae00d6cc54b071dd94a33a Mon Sep 17 00:00:00 2001
From: Tomasz Nowicki <tomasz.nowicki@linaro.org>
Date: Wed, 10 Dec 2014 08:54:08 +0100
Subject: [PATCH 117/131] ARM64, ACPI, MSI: Use IORT while it comes to MSI
 chip: PCI RC <-> ITS map.
Git-commit: 944a39669b8e2e5a86b655f3d73ad122b86b1bcb
Patch-mainline: Queued in subsystem maintainer repository
Git-repo: git://git.kernel.org/pub/scm/linux/kernel/git/rric/linux.git thunder/master-v4.1

This patch shows how IORT should be used to:
1. register MSI chip
2. figure out MSI chip for PCI host bridge

Signed-off-by: Tomasz Nowicki <tomasz.nowicki@linaro.org>
Signed-off-by: Robert Richter <rrichter@cavium.com>

Signed-off-by: Matthias Brugger <mbrugger@suse.com>

---
 arch/arm64/kernel/pci-acpi.c     |  2 ++
 drivers/irqchip/Kconfig          |  1 +
 drivers/irqchip/irq-gic-v3-its.c | 13 +++++++++----
 3 files changed, 12 insertions(+), 4 deletions(-)

diff --git a/arch/arm64/kernel/pci-acpi.c b/arch/arm64/kernel/pci-acpi.c
index 1826b10..322e497 100644
--- a/arch/arm64/kernel/pci-acpi.c
+++ b/arch/arm64/kernel/pci-acpi.c
@@ -17,6 +17,7 @@
 #include <linux/acpi.h>
 #include <linux/init.h>
 #include <linux/io.h>
+#include <linux/iort.h>
 #include <linux/kernel.h>
 #include <linux/mm.h>
 #include <linux/mmconfig.h>
@@ -340,6 +341,7 @@ struct pci_bus *pci_acpi_scan_root(struct acpi_pci_root *root)
 		__release_pci_root_info(info);
 		return NULL;
 	}
+	pbus->msi = iort_find_pci_msi_chip(domain, 0);
 
 	pci_set_host_bridge_release(to_pci_host_bridge(pbus->bridge),
 			release_pci_root_info, info);
diff --git a/drivers/irqchip/Kconfig b/drivers/irqchip/Kconfig
index 6de62a9..d4225f6 100644
--- a/drivers/irqchip/Kconfig
+++ b/drivers/irqchip/Kconfig
@@ -26,6 +26,7 @@ config ARM_GIC_V3
 config ARM_GIC_V3_ITS
 	bool
 	select PCI_MSI_IRQ_DOMAIN
+	select IORT_TABLE if (ACPI && PCI_MSI)
 
 config ARM_NVIC
 	bool
diff --git a/drivers/irqchip/irq-gic-v3-its.c b/drivers/irqchip/irq-gic-v3-its.c
index baa3795..d0b79fd 100644
--- a/drivers/irqchip/irq-gic-v3-its.c
+++ b/drivers/irqchip/irq-gic-v3-its.c
@@ -19,6 +19,7 @@
 #include <linux/cpu.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
+#include <linux/iort.h>
 #include <linux/log2.h>
 #include <linux/mm.h>
 #include <linux/msi.h>
@@ -1610,15 +1611,19 @@ static int __init
 gic_acpi_parse_madt_its(struct acpi_subtable_header *header,
 			const unsigned long end)
 {
-	struct acpi_madt_generic_its *its;
+	struct acpi_madt_generic_its *its_table;
+	struct its_node *its;
 
 	if (BAD_MADT_ENTRY(header, end))
 		return -EINVAL;
 
-	its = (struct acpi_madt_generic_its *)header;
+	its_table = (struct acpi_madt_generic_its *)header;
+
+	pr_info("ITS: ID: 0x%x\n", its_table->its_id);
+	its = its_probe(its_table->base_address, 2 * SZ_64K);
+	if (!its_init_domain(NULL, its))
+		iort_pci_msi_chip_add(&its->msi_chip, its_table->its_id);
 
-	pr_info("ITS: ID: 0x%x\n", its->its_id);
-	its_probe(its->base_address, 2 * SZ_64K);
 	return 0;
 }
 
-- 
1.7.12.4

