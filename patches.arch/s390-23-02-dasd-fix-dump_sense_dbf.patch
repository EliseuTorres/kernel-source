From: Gerald Schaefer <geraldsc@de.ibm.com>
Subject: dasd: fix dump_sense_dbf
References: bnc#643173,LTC#67610
Patch-mainline: Yes

Symptom:     The sense data written to the s390 debug feature in case of an 	     
	     error is incomplete. The last 16 byte are missing.
Problem:     The DASD device driver is registering a s390 debug feature area
	     with enough space for up to 8 parameter. The dump_sense_dbf 
	     function tries to write 10 parameter to the debugfeature.
Solution:    Join three parameters into one so the overall number of parameters
	     fits into the DASD s390 debug feature area.

Acked-by: John Jolly <jjolly@suse.de>

---
 drivers/s390/block/dasd_eckd.c |   16 ++++++++++------
 1 file changed, 10 insertions(+), 6 deletions(-)

--- a/drivers/s390/block/dasd_eckd.c
+++ b/drivers/s390/block/dasd_eckd.c
@@ -2996,16 +2996,20 @@ dasd_eckd_dump_sense_dbf(struct dasd_dev
 			 char *reason)
 {
 	u64 *sense;
+	u32 stat;
 
 	sense = (u64 *) dasd_get_sense(irb);
+	stat = scsw_cstat(&irb->scsw);
+	stat <<= 8;
+	stat |=	scsw_dstat(&irb->scsw);
+	stat <<= 8;
+	stat |= scsw_cc(&irb->scsw);
+
 	if (sense) {
 		DBF_DEV_EVENT(DBF_EMERG, device,
-			      "%s: %s %02x%02x%02x %016llx %016llx %016llx "
-			      "%016llx", reason,
-			      scsw_is_tm(&irb->scsw) ? "t" : "c",
-			      scsw_cc(&irb->scsw), scsw_cstat(&irb->scsw),
-			      scsw_dstat(&irb->scsw), sense[0], sense[1],
-			      sense[2], sense[3]);
+			      "%s: %s %06x %016llx %016llx %016llx %016llx",
+			      reason, scsw_is_tm(&irb->scsw) ? "t" : "c", stat,
+			      sense[0], sense[1], sense[2], sense[3]);
 	} else {
 		DBF_DEV_EVENT(DBF_EMERG, device, "%s",
 			      "SORRY - NO VALID SENSE AVAILABLE\n");
