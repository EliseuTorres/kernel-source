From: Nathan D. Fontenot <nfont@austin.ibm.com>
Subject: Mark preferred offline state as CPU_STATE_OFFLINE before removing cpus
Patch-Mainline: Not yet
References: bnc#590154

The preferred offline state needs to be marked as CPU_STATE_OFFLINE before
online cpus are hotplug removed.
The existing behavior can cause the dlpar operation to fail if the preferred
offline state is set to CPU_STATE_INACTIVE when hotplug removing the cpu
since this causes the cpu to not be completely removed from the system.

Signed-off-by: Thomas Renninger <trenn@suse.de>

---
 arch/powerpc/platforms/pseries/dlpar.c |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

Index: powerpc/arch/powerpc/platforms/pseries/dlpar.c
===================================================================
--- powerpc.orig/arch/powerpc/platforms/pseries/dlpar.c	2010-03-19 15:51:08.000000000 -0500
+++ powerpc/arch/powerpc/platforms/pseries/dlpar.c	2010-03-19 15:52:10.000000000 -0500
@@ -463,6 +463,8 @@
 			if (get_cpu_current_state(cpu) == CPU_STATE_OFFLINE)
 				break;
 
+			set_preferred_offline_state(cpu, CPU_STATE_OFFLINE);
+
 			if (get_cpu_current_state(cpu) == CPU_STATE_ONLINE) {
 				cpu_maps_update_done();
 				rc = cpu_down(cpu);
@@ -477,7 +479,6 @@
 			 * The cpu is in CPU_STATE_INACTIVE.
 			 * Upgrade it's state to CPU_STATE_OFFLINE.
 			 */
-			set_preferred_offline_state(cpu, CPU_STATE_OFFLINE);
 			BUG_ON(plpar_hcall_norets(H_PROD, intserv[i])
 								!= H_SUCCESS);
 			__cpu_die(cpu);
