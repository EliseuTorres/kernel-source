From: Peter Oberparleiter <oberpar@linux.vnet.ibm.com>
Subject: s390/cio: fix unlocked access of global bitmap
Patch-mainline: v3.12-rc1
Git-commit: eb072a7996467937a1582d0188ed082768902a5a
References: bnc#874145, LTC#109378

Description:  cio: Stop STSCH loop after CC 3
Symptom:      Unnecessarily high management time spent for Linux systems
              during subchannel scan, for example after path events.
Problem:      Linux always scans the full range of possible subchannels
              instead of aborting when the last subchannel in a subchannel
              set has been scanned.
Solution:     Abort subchannel scan loop when the STSCH instruction indicates
              last subchannel found.
Reproduction: Trigger a subchannel scan loop and observe the management time
              spent, for example using the hyptop tool.

Upstream-Description:

              s390/cio: fix unlocked access of global bitmap

              Access to the slow_subchannel_set has to be secured via the
              slow_subchannel_lock.

              Signed-off-by: Sebastian Ott <sebott@linux.vnet.ibm.com>
              Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>


Signed-off-by: Peter Oberparleiter <oberpar@linux.vnet.ibm.com>
Acked-by: John Jolly <jjolly@suse.de>
---
 drivers/s390/cio/css.c |    2 ++
 1 file changed, 2 insertions(+)

--- a/drivers/s390/cio/css.c
+++ b/drivers/s390/cio/css.c
@@ -548,7 +548,9 @@ static int slow_eval_unknown_fn(struct s
 		case -ENOMEM:
 		case -EIO:
 			/* These should abort looping */
+			spin_lock_irq(&slow_subchannel_lock);
 			idset_sch_del_subseq(slow_subchannel_set, schid);
+			spin_unlock_irq(&slow_subchannel_lock);
 			break;
 		default:
 			rc = 0;
