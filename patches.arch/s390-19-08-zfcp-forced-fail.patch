From: Gerald Schaefer <geraldsc@de.ibm.com>
Subject: zfcp: Do not try "forced close" when port is already closed
References: bnc#617464,LTC#65810
Patch-mainline: Yes

Symptom:     After a remote port failure, the erp action fails.
Problem:     The requested "reopen port forced" erp action tries to
             issue a "physical port closed", although the port is not
             open, thus failing the erp action.
Solution:    When a "reopen port forced" is requested for a closed
             port, try a "port reopen" instead.

Acked-by: John Jolly <jjolly@suse.de>
---
 drivers/s390/scsi/zfcp_erp.c |    6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

--- a/drivers/s390/scsi/zfcp_erp.c	2010-06-28 13:41:03.000000000 +0200
+++ b/drivers/s390/scsi/zfcp_erp.c	2010-06-28 13:46:33.000000000 +0200
@@ -134,9 +134,13 @@ static int zfcp_erp_required_act(int wan
 		if (!(p_status & ZFCP_STATUS_COMMON_UNBLOCKED))
 			need = ZFCP_ERP_ACTION_REOPEN_PORT;
 		/* fall through */
-	case ZFCP_ERP_ACTION_REOPEN_PORT:
 	case ZFCP_ERP_ACTION_REOPEN_PORT_FORCED:
 		p_status = atomic_read(&port->status);
+		if (!(p_status & ZFCP_STATUS_COMMON_OPEN))
+			need = ZFCP_ERP_ACTION_REOPEN_PORT;
+		/* fall through */
+	case ZFCP_ERP_ACTION_REOPEN_PORT:
+		p_status = atomic_read(&port->status);
 		if (p_status & ZFCP_STATUS_COMMON_ERP_INUSE)
 			return 0;
 		a_status = atomic_read(&adapter->status);
