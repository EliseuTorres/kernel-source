From: Gerald Schaefer <geraldsc@de.ibm.com>
Subject: ap: Setup timer for sending messages after reset.
Patch-mainline: yes
References: bnc#735369,LTC#76969

Symptom:     AP messages, which are sent to a busy AP bus device just
             before a device timeout, will not be processed after the
             device recovery.
Problem:     Pending requests on an AP bus device aren't re-sent to
             the device after the device reset.
Solution:    Setup timer for processing messages in request queue
             after a successful AP bus device reset.

Acked-by: John Jolly <jjolly@suse.de>
---
 drivers/s390/crypto/ap_bus.c |    2 ++
 1 file changed, 2 insertions(+)

--- a/drivers/s390/crypto/ap_bus.c
+++ b/drivers/s390/crypto/ap_bus.c
@@ -1552,6 +1552,8 @@ static void ap_reset(struct ap_device *a
 	rc = ap_init_queue(ap_dev->qid);
 	if (rc == -ENODEV)
 		ap_dev->unregistered = 1;
+	else
+		__ap_schedule_poll_timer();
 }
 
 static int __ap_poll_device(struct ap_device *ap_dev, unsigned long *flags)
