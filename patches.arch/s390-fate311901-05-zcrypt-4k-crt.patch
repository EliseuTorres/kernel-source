From: Gerald Schaefer <geraldsc@de.ibm.com>
Subject: zcrypt: handling of 4096 bit RSA keys in CRT format.
References: bnc#700080,LTC#69502,FATE#311901
Patch-mainline: Yes

Description: Also process 4096 bit RSA keys in CRT format. Handle them like
             the smaller keys and take care of the zero padding.

Acked-by: John Jolly <jjolly@suse.de>
---

 drivers/s390/crypto/zcrypt_api.c |   14 ++++++++++++--
 1 file changed, 12 insertions(+), 2 deletions(-)

--- a/drivers/s390/crypto/zcrypt_api.c
+++ b/drivers/s390/crypto/zcrypt_api.c
@@ -397,13 +397,23 @@ static long zcrypt_rsa_crt(struct ica_rs
 			if (copied == 0) {
 				int len;
 				spin_unlock_bh(&zcrypt_device_lock);
-				/* len is max 256 / 2 - 120 = 8 */
-				len = crt->inputdatalength / 2 - 120;
+				/* len is max 256 / 2 - 120 = 8
+				 * For bigger device just assume len of leading
+				 * 0s is 8 as stated in the requirements for
+				 * ica_rsa_modexpo_crt struct in zcrypt.h.
+				 */
+				if (crt->inputdatalength <= 256)
+					len = crt->inputdatalength / 2 - 120;
+				else
+					len = 8;
+				if (len > sizeof(z1))
+					return -EFAULT;
 				z1 = z2 = z3 = 0;
 				if (copy_from_user(&z1, crt->np_prime, len) ||
 				    copy_from_user(&z2, crt->bp_key, len) ||
 				    copy_from_user(&z3, crt->u_mult_inv, len))
 					return -EFAULT;
+				z1 = z2 = z3 = 0;
 				copied = 1;
 				/*
 				 * We have to restart device lookup -
