From: Martin Schwidefsky <schwidefsky@de.ibm.com>
Subject: mm: crash after transaction abort due protection exception
Patch-mainline: not yet
Git-commit: -
References: bnc#817401, LTC#92089

Description:  mm: crash after transaction abort due protection exception
Symptom:      User space code crashes when using transactional execution
Problem:      If a transaction is aborted due to a protection exception
              the PSW will be set to the transaction abort PSW. This is
              either the address of the TBEGINC instruction for contrained
              transactions, or the address of the instruction following
              the TBEGIN instruction for non-contrained transactions.
              In either case the PSW address is already correct, but the
              protection exception handler incorrectly subtracts the
              lenght of the instruction that caused the fault.
Solution:     Do not subtract the instruction length from the PSW address
              for a protection exception if the transaction abort bit is
              set in the program interruption code.
Reproduction: Use transactions in an application that uses the fork()
              system call. The kernel will set the anonymous pages to
              read-only for the copy-on-write mechanism. If a transaction
              tries to modify a write-protected page which is subject
              to copy-on-write the PSW will be incorrect after the
              completion of the protection exception.

Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
Acked-by: John Jolly <jjolly@suse.de>
---
 arch/s390/mm/fault.c |    9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

--- a/arch/s390/mm/fault.c
+++ b/arch/s390/mm/fault.c
@@ -375,8 +375,13 @@ void __kprobes do_protection_exception(s
 {
 	int fault;
 
-	/* Protection exception is suppressing, decrement psw address. */
-	regs->psw.addr -= (pgm_int_code >> 16);
+	/*
+	 * Protection exceptions are suppressing, decrement psw address.
+	 * The exception to this rule are aborted transactions, for these
+	 * the PSW already points to the correct location.
+	 */
+	if (!(pgm_int_code & 0x200))
+		regs->psw.addr -= (pgm_int_code >> 16);
 	/*
 	 * Check for low-address protection.  This needs to be treated
 	 * as a special case because the translation exception code
