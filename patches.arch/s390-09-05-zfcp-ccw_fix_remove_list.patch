From: Gerald Schaefer <geraldsc@de.ibm.com>
Subject: zfcp: Remove attached ports and units correctly.
References: bnc#583296
Patch-mainline: Upstream submission made

Symptom:     Panic on invalid pointer dereference.
Problem:     An attached unit is removed from the systems environment
             multiple times, depending on the number of configured rports.
Solution:    Remove each unit only once.

Acked-by: John Jolly <jjolly@suse.de>

---
 drivers/s390/scsi/zfcp_ccw.c |    9 +++++----
 1 file changed, 5 insertions(+), 4 deletions(-)

--- a/drivers/s390/scsi/zfcp_ccw.c
+++ b/drivers/s390/scsi/zfcp_ccw.c
@@ -124,11 +124,12 @@ static void zfcp_ccw_remove(struct ccw_d
 	atomic_set_mask(ZFCP_STATUS_COMMON_REMOVE, &adapter->status);
 	write_unlock_irq(&zfcp_data.config_lock);
 
-	list_for_each_entry_safe(port, p, &port_remove_lh, list) {
-		list_for_each_entry_safe(unit, u, &unit_remove_lh, list)
-			zfcp_unit_dequeue(unit);
+	list_for_each_entry_safe(unit, u, &unit_remove_lh, list)
+		zfcp_unit_dequeue(unit);
+
+	list_for_each_entry_safe(port, p, &port_remove_lh, list)
 		zfcp_port_dequeue(port);
-	}
+
 	wait_event(adapter->remove_wq, atomic_read(&adapter->refcount) == 0);
 	zfcp_adapter_dequeue(adapter);
 
