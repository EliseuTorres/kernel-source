From: Hugh Dickins <hughd@google.com>
Date: Tue, 17 Aug 2010 15:23:56 -0700
Subject: shmem: put_super must percpu_counter_destroy
Patch-mainline: 2.6.36
References: FATE#311806

commit 602586a83b719df0fbd94196a1359ed35aeb2df3

list_add() corruption messages reported from shmem_fill_super()'s recently
introduced percpu_counter_init(): shmem_put_super() needs to remember to
percpu_counter_destroy().  And also check error from percpu_counter_init().

Reported-bisected-and-tested-by: Tetsuo Handa <penguin-kernel@i-love.sakura.ne.jp>
Signed-off-by: Hugh Dickins <hughd@google.com>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Acked-by: Miklos Szeredi <mszeredi@suse.cz>
---
 mm/shmem.c |    8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

Index: linux-2.6.32-SLE11-SP2/mm/shmem.c
===================================================================
--- linux-2.6.32-SLE11-SP2.orig/mm/shmem.c	2011-06-16 15:54:00.000000000 +0200
+++ linux-2.6.32-SLE11-SP2/mm/shmem.c	2011-06-16 15:54:02.000000000 +0200
@@ -2297,7 +2297,10 @@ static int shmem_show_options(struct seq
 
 static void shmem_put_super(struct super_block *sb)
 {
-	kfree(sb->s_fs_info);
+	struct shmem_sb_info *sbinfo = SHMEM_SB(sb);
+
+	percpu_counter_destroy(&sbinfo->used_blocks);
+	kfree(sbinfo);
 	sb->s_fs_info = NULL;
 }
 
@@ -2339,7 +2342,8 @@ int shmem_fill_super(struct super_block
 #endif
 
 	spin_lock_init(&sbinfo->stat_lock);
-	percpu_counter_init(&sbinfo->used_blocks, 0);
+	if (percpu_counter_init(&sbinfo->used_blocks, 0))
+		goto failed;
 	sbinfo->free_inodes = sbinfo->max_inodes;
 
 	sb->s_maxbytes = SHMEM_MAX_BYTES;
