From: Jens Axboe <jens.axboe@oracle.com>
Date: Mon, 30 Nov 2009 09:38:13 +0100
Subject: [PATCH] Revert "cfq: Make use of service count to estimate the rb_key offset"
Git-commit: 464191c65b85a8ec68a6e1a6293af625287c807e
References: FATE#311054
Patch-Mainline: 2.6.33

This reverts commit 3586e917f2c7df769d173c4ec99554cb40a911e5.

Corrado Zoccolo <czoccolo@gmail.com> correctly points out, that we need
consistency of rb_key offset across groups. This means we cannot properly
use the per-service_tree service count. Revert this change.

Signed-off-by: Jens Axboe <jens.axboe@oracle.com>
Signed-off-by: Hannes Reinecke <hare@suse.de>
---
 block/cfq-iosched.c |    8 ++------
 1 files changed, 2 insertions(+), 6 deletions(-)

diff --git a/block/cfq-iosched.c b/block/cfq-iosched.c
index ec39927..ed7f2c5 100644
--- a/block/cfq-iosched.c
+++ b/block/cfq-iosched.c
@@ -611,15 +611,11 @@ cfq_find_next_rq(struct cfq_data *cfqd, struct cfq_queue *cfqq,
 static unsigned long cfq_slice_offset(struct cfq_data *cfqd,
 				      struct cfq_queue *cfqq)
 {
-	struct cfq_rb_root *service_tree;
-
-	service_tree = service_tree_for(cfqq_prio(cfqq), cfqq_type(cfqq), cfqd);
-
 	/*
 	 * just an approximation, should be ok.
 	 */
-	return  service_tree->count * (cfq_prio_slice(cfqd, 1, 0) -
-		   cfq_prio_slice(cfqd, cfq_cfqq_sync(cfqq), cfqq->ioprio));
+	return (cfqd->busy_queues - 1) * (cfq_prio_slice(cfqd, 1, 0) -
+		       cfq_prio_slice(cfqd, cfq_cfqq_sync(cfqq), cfqq->ioprio));
 }
 
 /*
-- 
1.6.0.2

