From: Josef Bacik <jbacik@fusionio.com>
Date: Thu, 6 Sep 2012 16:47:00 -0400
Patch-mainline: pending
References: FATE#306586
Subject: [PATCH] Btrfs: wait on async pages when shrinking delalloc

Mitch reported a problem where you could get an ENOSPC error when untarring
a kernel git tree onto a 16gb file system with compress-force=zlib.  This is
because compression is a huge pain, it will return from ->writepages()
without having actually created any ordered extents.  To get around this we
check to see if the async submit counter is up, and if it is wait until it
drops to 0 before doing our normal ordered wait dance.  With this patch I
can now untar a kernel git tree onto a 16gb file system without getting
ENOSPC errors.  Thanks,

Signed-off-by: Josef Bacik <jbacik@fusionio.com>
Signed-off-by: David Sterba <dsterba@suse.cz>
---
 fs/btrfs/extent-tree.c |    7 +++++++
 1 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/fs/btrfs/extent-tree.c b/fs/btrfs/extent-tree.c
index f180b20..48dac9a 100644
--- a/fs/btrfs/extent-tree.c
+++ b/fs/btrfs/extent-tree.c
@@ -3664,6 +3664,13 @@ static int shrink_delalloc(struct btrfs_root *root, u64 to_reclaim,
 		       root->fs_info->delalloc_bytes >> PAGE_CACHE_SHIFT);
 		btrfs_writeback_inodes_sb_nr(root, nr_pages);
 
+		/*
+		 * We need to wait for the async pages to actually start before
+		 * we do anything.
+		 */
+		wait_event(root->fs_info->async_submit_wait,
+				!atomic_read(&root->fs_info->async_delalloc_pages));
+
 		spin_lock(&space_info->lock);
 		if (reserved > space_info->bytes_may_use)
 			reclaimed += reserved - space_info->bytes_may_use;
-- 
1.7.6.233.gd79bc

