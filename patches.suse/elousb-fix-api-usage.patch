From c5ef3769a05e42833c99b66280d163d2ec13b96e Mon Sep 17 00:00:00 2001
From: Libor Pechacek <lpechacek@suse.cz>
Date: Fri, 2 Dec 2011 14:48:07 +0100
Subject: [PATCH] Fixed bug in USB core API usage, code cleanup
Patch-Mainline: Never
References: bnc#733863

Use the pipe parameter correctly in smartset_send_get().  Incorrect use of
usb_sndtrlpipe(...) for USB_DIR_IN led to silent USB protocol violation.

Also the second USB_GET_SMARTSET_RESPONSE was superfluous as the Elo Diagnostics
command does not return any extra data, at least according to Elo documentation
and the traces we've seen so far.

oneukum: edited for maximum conservativism

Signed-off-by: Libor Pechacek <lpechacek@suse.cz>
Signed-off-by: Oliver Neukum <oneukum@suse.de>
---
 drivers/input/touchscreen/elousb.c |   16 +++++-----------
 1 files changed, 5 insertions(+), 11 deletions(-)

diff --git a/drivers/input/touchscreen/elousb.c b/drivers/input/touchscreen/elousb.c
index 3a1361d..b4766a3 100644
--- a/drivers/input/touchscreen/elousb.c
+++ b/drivers/input/touchscreen/elousb.c
@@ -166,10 +166,13 @@ static int flush_smartset_responses(struct usb_device *dev)
 
 static int smartset_send_get(struct usb_device *dev, __u8 command, void *data)
 {
+	int pipe;
+
 	if (command != USB_SEND_SMARTSET_COMMAND && command != USB_GET_SMARTSET_RESPONSE)
 		return -1;
 
-	return usb_control_msg(dev, usb_sndctrlpipe(dev, 0), command,
+	pipe = (command == USB_GET_SMARTSET_RESPONSE ? usb_rcvctrlpipe(dev, 0) : usb_sndctrlpipe(dev, 0));
+	return usb_control_msg(dev, pipe, command,
 				(command == USB_GET_SMARTSET_RESPONSE ? USB_DIR_IN : USB_DIR_OUT)
 				| USB_TYPE_VENDOR | USB_RECIP_DEVICE,
 				0, 0, data, ELO_SMARTSET_PACKET_SIZE, SMARTSET_CMD_TIMEOUT);
-- 
1.6.0.2

