From 010928cb1501602e181df4fbe0b91aa822d86592 Mon Sep 17 00:00:00 2001
From: Ales Novak <alnovak@suse.cz>
Date: Thu, 4 Sep 2014 15:33:32 +0200
Subject: [PATCH] fix: use after free of xfs workqueues
Patch-mainline: Never (mainline does not have this bug)
References: bnc#894895

In xfs_fs_put_super the workqueues of xfs_mount are freed using
xfs_destroy_mount_workqueues() before calling xfs_close_devices(), which
can lead through
xfs_free_buftarg->xfs_flush_buftarg->xfs_buf_runall_queues->flush_workqueue
to accessing freed memory.

The same change of order must be done in xfs_fs_fill_super().

Signed-off-by: Mark Fasheh <mfasheh@suse.de>
---
 fs/xfs/linux-2.6/xfs_super.c | 14 +++++++-------
 1 file changed, 7 insertions(+), 7 deletions(-)

diff --git a/fs/xfs/linux-2.6/xfs_super.c b/fs/xfs/linux-2.6/xfs_super.c
index c9b4133..36da8b2 100644
--- a/fs/xfs/linux-2.6/xfs_super.c
+++ b/fs/xfs/linux-2.6/xfs_super.c
@@ -1111,8 +1111,8 @@ xfs_fs_put_super(
 	xfs_unmountfs(mp);
 	xfs_freesb(mp);
 	xfs_icsb_destroy_counters(mp);
-	xfs_destroy_mount_workqueues(mp);
 	xfs_close_devices(mp);
+	xfs_destroy_mount_workqueues(mp);
 	xfs_dmops_put(mp);
 	xfs_free_fsname(mp);
 	kfree(mp->m_mtpt);
@@ -1450,17 +1450,17 @@ xfs_fs_fill_super(
 	if (silent)
 		flags |= XFS_MFSI_QUIET;
 
-	error = xfs_open_devices(mp);
+	error = xfs_init_mount_workqueues(mp);
 	if (error)
 		goto out_put_dmops;
 
-	error = xfs_init_mount_workqueues(mp);
+	error = xfs_open_devices(mp);
 	if (error)
-		goto out_close_devices;
+		goto out_destroy_workqueues;
 
 	error = xfs_icsb_init_counters(mp);
 	if (error)
-		goto out_destroy_workqueues;
+		goto out_close_devices;
 
 	error = xfs_readsb(mp, flags);
 	if (error)
@@ -1531,10 +1531,10 @@ xfs_fs_fill_super(
 	xfs_freesb(mp);
  out_destroy_counters:
 	xfs_icsb_destroy_counters(mp);
-out_destroy_workqueues:
-	xfs_destroy_mount_workqueues(mp);
  out_close_devices:
 	xfs_close_devices(mp);
+ out_destroy_workqueues:
+	xfs_destroy_mount_workqueues(mp);
  out_put_dmops:
 	xfs_dmops_put(mp);
  out_free_fsname:
-- 
1.8.1.4

