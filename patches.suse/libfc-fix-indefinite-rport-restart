Subject: libfc: fix indefinite rport restart
From: Joe Eykholt <jeykholt@cisco.com>
References: bnc#626880
Patch-Mainline: 2.6.26

Remote ports were restarting indefinitely after getting
rejects in PRLI.

Fix by adding a counter of restarts and limiting that with
the port login retry limit as well.

Modified to not break kABI for SLES11 SP1.

Signed-off-by: Joe Eykholt <jeykholt@cisco.com>
Signed-off-by: Robert Love <robert.w.love@intel.com>
Signed-off-by: James Bottomley <James.Bottomley@suse.de>
Acked-by: Hannes Reinecke <hare@suse.de>

---
 drivers/scsi/libfc/fc_rport.c |    6 +++++-
 include/scsi/libfc.h          |    2 ++
 2 files changed, 7 insertions(+), 1 deletion(-)

Index: linux-2.6.32-SLE11-SP2/drivers/scsi/libfc/fc_rport.c
===================================================================
--- linux-2.6.32-SLE11-SP2.orig/drivers/scsi/libfc/fc_rport.c
+++ linux-2.6.32-SLE11-SP2/drivers/scsi/libfc/fc_rport.c
@@ -257,6 +257,7 @@ static void fc_rport_work(struct work_st
 	case RPORT_EV_READY:
 		ids = rdata->ids;
 		rdata->event = RPORT_EV_NONE;
+		rdata->major_retries = 0;
 		kref_get(&rdata->kref);
 		mutex_unlock(&rdata->rp_mutex);
 
@@ -323,7 +324,10 @@ static void fc_rport_work(struct work_st
 			if (port_id == FC_FID_DIR_SERV) {
 				rdata->event = RPORT_EV_NONE;
 				mutex_unlock(&rdata->rp_mutex);
-			} else if (rdata->flags & FC_RP_STARTED) {
+			} else if ((rdata->flags & FC_RP_STARTED) &&
+				   rdata->major_retries <
+				   lport->max_rport_retry_count) {
+				rdata->major_retries++;
 				rdata->event = RPORT_EV_NONE;
 				FC_RPORT_DBG(rdata, "work restart\n");
 				fc_rport_enter_plogi(rdata);
Index: linux-2.6.32-SLE11-SP2/include/scsi/libfc.h
===================================================================
--- linux-2.6.32-SLE11-SP2.orig/include/scsi/libfc.h
+++ linux-2.6.32-SLE11-SP2/include/scsi/libfc.h
@@ -191,6 +191,7 @@ struct fc_rport_libfc_priv {
  * @rp_mutex:       The mutex that protects the remote port
  * @retry_work:     Handle for retries
  * @event_callback: Callback when READY, FAILED or LOGO states complete
+ * @major_retries:  The retry count for the entire PLOGI/PRLI state machine
  */
 struct fc_rport_priv {
 	struct fc_lport		    *local_port;
@@ -212,6 +213,7 @@ struct fc_rport_priv {
 	struct list_head            peers;
 	struct work_struct          event_work;
 	u32			    supported_classes;
+	unsigned int	            major_retries;
 };
 
 /**
