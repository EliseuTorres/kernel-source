From: Andre Przywara <andre.przywara@amd.com>
Subject: [PATCH 08/12] KVM: SVM: Add clean-bit for DR6 and DR7
References: FATE#309760
Git-commit: 72214b9601f2b6c8343ea57b0e405f9da7a92d29
Patch-mainline: v2.6.38

This patch implements the clean-bit for the dr6 and dr7
debug registers in the vmcb.

Backport of 72214b9601f2b6c8343ea57b0e405f9da7a92d29
(done by: Joerg Roedel <joerg.roedel@amd.com>)

Signed-off-by: Andre Przywara <andre.przywara@amd.com>
Acked-by: Bruce Rogers <brogers@suse.com>
---
 arch/x86/kvm/svm.c |    3 +++
 1 file changed, 3 insertions(+)

Index: b/arch/x86/kvm/svm.c
===================================================================
--- a/arch/x86/kvm/svm.c
+++ b/arch/x86/kvm/svm.c
@@ -149,6 +149,7 @@ enum {
 	VMCB_INTR,       /* int_ctl, int_vector */
 	VMCB_NPT,        /* npt_en, nCR3, gPAT */
 	VMCB_CR,         /* CR0, CR3, CR4, EFER */
+	VMCB_DR,         /* DR6, DR7 */
 	VMCB_DIRTY_MAX,
 };
 
@@ -1184,6 +1185,7 @@ static int svm_guest_debug(struct kvm_vc
 		svm->vmcb->save.dr7 = dbg->arch.debugreg[7];
 	else
 		svm->vmcb->save.dr7 = vcpu->arch.dr7;
+	mark_dirty(svm->vmcb, VMCB_DR);
 
 	if (vcpu->guest_debug & KVM_GUESTDBG_SINGLESTEP)
 		svm->vmcb->save.rflags |= X86_EFLAGS_TF | X86_EFLAGS_RF;
@@ -1283,6 +1285,7 @@ static void svm_set_dr(struct kvm_vcpu *
 			svm->vmcb->save.dr7 = vcpu->arch.dr7;
 			vcpu->arch.switch_db_regs = (value & DR7_BP_EN_MASK);
 		}
+		mark_dirty(svm->vmcb, VMCB_DR);
 		return;
 	default:
 		/* FIXME: Possible case? */
