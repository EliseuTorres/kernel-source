From: Christoph Hellwig <hch@infradead.org>
Date: Mon, 21 Apr 2014 10:29:17 -0700
Subject: [PATCH] nfs: commit layouts in fdatasync
Git-commit: 1b33809ea8c671ccbceeaaa8d842631b441bed54
Patch-mainline: v3.16
References: bnc#898675

 "fdatasync() is similar to fsync(), but does not flush modified metadata
  unless that metadata is needed in order  to  allow  a  subsequent  data
  retrieval to be correctly handled."

We absolutely need to commit the layouts to be able to retrieve the data
in case either the client, the server or the storage subsystem go down.

Signed-off-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Trond Myklebust <trond.myklebust@primarydata.com>
Acked-by: NeilBrown <neilb@suse.de>

---
 fs/nfs/nfs4file.c |    3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

--- linux-3.12-SLE12.orig/fs/nfs/nfs4file.c
+++ linux-3.12-SLE12/fs/nfs/nfs4file.c
@@ -102,8 +102,7 @@ nfs4_file_fsync(struct file *file, loff_
 			break;
 		mutex_lock(&inode->i_mutex);
 		ret = nfs_file_fsync_commit(file, start, end, datasync);
-		if (!ret && !datasync)
-			/* application has asked for meta-data sync */
+		if (!ret)
 			ret = pnfs_layoutcommit_inode(inode, true);
 		mutex_unlock(&inode->i_mutex);
 		/*
