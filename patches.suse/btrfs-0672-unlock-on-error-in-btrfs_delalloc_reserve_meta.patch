From: Dan Carpenter <dan.carpenter@oracle.com>
Date: Mon, 30 Jul 2012 02:15:15 -0600
Patch-mainline: 3.6
Git-commit: 55e591ffde38e0088b022129e035e18a8d04c7e6
References: FATE#312888
Subject: [PATCH] Btrfs: unlock on error in
 btrfs_delalloc_reserve_metadata()

We should release this mutex before returning the error code.

Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com>
Signed-off-by: David Sterba <dsterba@suse.cz>
---
 fs/btrfs/extent-tree.c |    4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

--- a/fs/btrfs/extent-tree.c
+++ b/fs/btrfs/extent-tree.c
@@ -4575,8 +4575,10 @@ int btrfs_delalloc_reserve_metadata(stru
 	if (root->fs_info->quota_enabled) {
 		ret = btrfs_qgroup_reserve(root, num_bytes +
 					   nr_extents * root->leafsize);
-		if (ret)
+		if (ret) {
+			mutex_unlock(&BTRFS_I(inode)->delalloc_mutex);
 			return ret;
+		}
 	}
 
 	ret = reserve_metadata_bytes(root, block_rsv, to_reserve, flush);
