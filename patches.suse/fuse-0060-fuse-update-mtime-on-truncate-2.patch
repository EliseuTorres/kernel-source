From: Maxim Patlasov <MPatlasov@parallels.com>
Date: Mon, 28 Apr 2014 14:19:22 +0200
Subject: fuse: update mtime on truncate(2)
Git-commit: 009dd694e82098a703b8b5c8dd9f54c131dbb9b3
Patch-mainline: v3.15-rc5
References: FATE#317677

Handling truncate(2), VFS doesn't set ATTR_MTIME bit in iattr structure;
only ATTR_SIZE bit is set. In-kernel fuse must handle the case by setting
mtime fields of struct fuse_setattr_in to "now" and set FATTR_MTIME bit
even though ATTR_MTIME was not set.

Signed-off-by: Maxim Patlasov <MPatlasov@parallels.com>
Signed-off-by: Miklos Szeredi <mszeredi@suse.cz>
---
 fs/fuse/dir.c |    2 ++
 1 file changed, 2 insertions(+)

--- a/fs/fuse/dir.c
+++ b/fs/fuse/dir.c
@@ -1409,6 +1409,8 @@ int fuse_do_setattr(struct inode *inode,
 	if (is_truncate) {
 		fuse_set_nowrite(inode);
 		set_bit(FUSE_I_SIZE_UNSTABLE, &fi->state);
+		if (trust_local_mtime && attr->ia_size != inode->i_size)
+			attr->ia_valid |= ATTR_MTIME;
 	}
 
 	memset(&inarg, 0, sizeof(inarg));
