From: Russ Anderson <rja@sgi.com>
Subject: x86: Add KDB support to unknown_nmi_error handler.
References: bnc#579647, FATE#306952
Patch-mainline: no

Signed-off-by: Rafael J. Wysocki <rjw@suse.de>
---
 arch/x86/kernel/traps.c |   19 +++++++++++++++++--
 1 file changed, 17 insertions(+), 2 deletions(-)

Index: linux-2.6.32-SLE11-SP1/arch/x86/kernel/traps.c
===================================================================
--- linux-2.6.32-SLE11-SP1.orig/arch/x86/kernel/traps.c
+++ linux-2.6.32-SLE11-SP1/arch/x86/kernel/traps.c
@@ -366,8 +366,22 @@ static notrace __kprobes void
 unknown_nmi_error(unsigned char reason, struct pt_regs *regs)
 {
 #ifdef CONFIG_KDB
-	(void)kdb(KDB_REASON_NMI, reason, regs);
-#endif /* CONFIG_KDB */
+	static int controlling_cpu = -1;
+	static DEFINE_SPINLOCK(kdb_nmi_lock);
+	unsigned long flags;
+
+	spin_lock_irqsave(&kdb_nmi_lock, flags);
+	if (controlling_cpu == -1) {
+		controlling_cpu = smp_processor_id();
+		spin_unlock_irqrestore(&kdb_nmi_lock, flags);
+		(void)kdb(KDB_REASON_NMI, reason, regs);
+		controlling_cpu = -1;
+	} else {
+		spin_unlock_irqrestore(&kdb_nmi_lock, flags);
+		(void)kdb(KDB_REASON_ENTER_SLAVE, reason, regs);
+	}
+	return;
+#else
 
 	if (notify_die(DIE_NMIUNKNOWN, "nmi", regs, reason, 2, SIGINT) ==
 			NOTIFY_STOP)
@@ -391,6 +405,7 @@ unknown_nmi_error(unsigned char reason, 
 		panic("NMI: Not continuing");
 
 	printk(KERN_EMERG "Dazed and confused, but trying to continue\n");
+#endif /* CONFIG_KDB */
 }
 
 static notrace __kprobes void default_do_nmi(struct pt_regs *regs)
