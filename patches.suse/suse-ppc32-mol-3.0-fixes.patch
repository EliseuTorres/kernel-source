From: Jiri Slaby <jslaby@suse.cz>
Subject: MOL: fix build on newer kernels
Patch-mainline: never (as the patch which is causing this)

- dev_mc_* changed prototypes
- locked ioctl vanished (we assume that the ioctl does not rely on BKL)
- linux/{autoconf,utsrelease}.h moved to generated/

Signed-off-by: Jiri Slaby <jslaby@suse.cz>
---
 drivers/macintosh/mol/include/archinclude.h |    8 ++++++--
 drivers/macintosh/mol/sheep.c               |   10 +++++-----
 2 files changed, 11 insertions(+), 7 deletions(-)

--- a/drivers/macintosh/mol/include/archinclude.h
+++ b/drivers/macintosh/mol/include/archinclude.h
@@ -26,11 +26,15 @@
 
 #include <linux/version.h>
 
-#if LINUX_VERSION_CODE >= KERNEL_VERSION(2,6,18)
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(3,0,0)
+#include <generated/utsrelease.h>
+#elif LINUX_VERSION_CODE >= KERNEL_VERSION(2,6,18)
 #include <linux/utsrelease.h>
 #endif
 
-#if LINUX_VERSION_CODE <= KERNEL_VERSION(2,6,18)
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(3,0,0)
+#include <generated/autoconf.h>
+#elif LINUX_VERSION_CODE <= KERNEL_VERSION(2,6,18)
 #include <linux/config.h>
 #else
 #include <linux/autoconf.h>
--- a/drivers/macintosh/mol/sheep.c
+++ b/drivers/macintosh/mol/sheep.c
@@ -535,8 +535,8 @@ sheep_net_poll( struct file *f, struct p
 	return 0;
 }
 
-static int
-sheep_net_ioctl( struct inode *inode, struct file *f, unsigned int code, unsigned long arg )
+static long
+sheep_net_ioctl(struct file *f, unsigned int code, unsigned long arg)
 {
 	struct SheepVars *v = (struct SheepVars *)f->private_data;
 	D(bug("sheep_net: ioctl %04x\n", code));
@@ -610,7 +610,7 @@ error:
 			return -ENODEV;
 		if( copy_from_user(addr, (void *)arg, 6))
 			return -EFAULT;
-		ret = dev_mc_add(v->ether, addr, 6, 0);
+		ret = dev_mc_add(v->ether, addr);
 		return ret;
 	}
 
@@ -622,7 +622,7 @@ error:
 			return -ENODEV;
 		if( copy_from_user(addr, (void *)arg, 6))
 			return -EFAULT;
-		return dev_mc_delete(v->ether, addr, 6, 0);
+		return dev_mc_del(v->ether, addr);
 	}
 
 #if 0
@@ -664,7 +664,7 @@ static struct file_operations sheep_net_
 	.write		= do_sync_write,
 	.aio_write	= sheep_net_aio_write,
 	.poll		= sheep_net_poll,
-	.ioctl		= sheep_net_ioctl,
+	.unlocked_ioctl	= sheep_net_ioctl,
 	.open		= sheep_net_open,
 	.release	= sheep_net_release,
 };
