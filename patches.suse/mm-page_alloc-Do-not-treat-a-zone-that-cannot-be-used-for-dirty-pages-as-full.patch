From a1ac1cf4db15365067f4208712dbaa49581a3de5 Mon Sep 17 00:00:00 2001
From: Mel Gorman <mgorman@suse.de>
Date: Thu, 3 Apr 2014 19:49:41 +0100
Subject: [PATCH] mm: page_alloc: Do not treat a zone that cannot be used for
 dirty pages as "full"

References: VM/FS Performance
Patch-mainline: v3.16
Git-commit: 800a1e750c7b04c2aa2459afca77e936e01c0029

If a zone cannot be used for a dirty page then it gets marked "full"
which is cached in the zlc and later potentially skipped by allocation
requests that have nothing to do with dirty zones.

Signed-off-by: Mel Gorman <mgorman@suse.de>
Acked-by: Johannes Weiner <hannes@cmpxchg.org>
---
 mm/page_alloc.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/mm/page_alloc.c b/mm/page_alloc.c
index 27d2eb3..3013d28 100644
--- a/mm/page_alloc.c
+++ b/mm/page_alloc.c
@@ -1958,7 +1958,7 @@ zonelist_scan:
 		 */
 		if ((alloc_flags & ALLOC_WMARK_LOW) &&
 		    (gfp_mask & __GFP_WRITE) && !zone_dirty_ok(zone))
-			goto this_zone_full;
+			continue;
 
 		mark = zone->watermark[alloc_flags & ALLOC_WMARK_MASK];
 		if (!zone_watermark_ok(zone, order, mark,
