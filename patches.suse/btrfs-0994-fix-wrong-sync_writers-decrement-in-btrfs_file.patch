From: Miao Xie <miaox@cn.fujitsu.com>
Date: Mon, 28 Jan 2013 12:34:55 +0000
Patch-mainline: 3.8
Git-commit: 0a3404dcff29a7589e8d6ce8c36f97c5411f85b4
References: FATE#312888
Subject: [PATCH] Btrfs: fix wrong sync_writers decrement in
 btrfs_file_aio_write()

If the checks at the beginning of btrfs_file_aio_write() fail, we needn't
decrease ->sync_writers, because we have not increased it. Fix it.

Signed-off-by: Miao Xie <miaox@cn.fujitsu.com>
Signed-off-by: Josef Bacik <jbacik@fusionio.com>
Signed-off-by: David Sterba <dsterba@suse.cz>
---
 fs/btrfs/file.c |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

--- a/fs/btrfs/file.c
+++ b/fs/btrfs/file.c
@@ -1595,9 +1595,10 @@ static ssize_t btrfs_file_aio_write(stru
 		if (err < 0 && num_written > 0)
 			num_written = err;
 	}
-out:
+
 	if (sync)
 		atomic_dec(&BTRFS_I(inode)->sync_writers);
+out:
 	current->backing_dev_info = NULL;
 	return num_written ? num_written : err;
 }
