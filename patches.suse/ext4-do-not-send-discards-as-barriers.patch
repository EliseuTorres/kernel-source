From: Christoph Hellwig <hch@infradead.org>
Date: Wed, 18 Aug 2010 05:29:18 -0400
Subject: [PATCH] ext4: do not send discards as barriers
Git-commit: 61002f7db33c7d064cddcdab680fb750fa43d8fd
References: FATE#311692
Patch-Mainline: 2.6.34

ext4 already uses synchronous discards, no need to add I/O barriers.

Signed-off-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Tejun Heo <tj@kernel.org>
Signed-off-by: Jens Axboe <jaxboe@fusionio.com>
Signed-off-by: Hannes Reinecke <hare@suse.de>
---
 fs/ext4/mballoc.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/fs/ext4/mballoc.c b/fs/ext4/mballoc.c
index 8bae398..3bcc791 100644
--- a/fs/ext4/mballoc.c
+++ b/fs/ext4/mballoc.c
@@ -2589,7 +2589,8 @@ static void release_blocks_on_commit(journal_t *journal, transaction_t *txn)
 			trace_ext4_discard_blocks(sb,
 					(unsigned long long)discard_block,
 					entry->count);
-			ret = sb_issue_discard(sb, discard_block, entry->count);
+			ret = sb_issue_discard(sb, discard_block, entry->count,
+					       GFP_NOFS, BLKDEV_IFL_WAIT);
 			if (ret == EOPNOTSUPP) {
 				ext4_warning(sb, __func__,
 					"discard not supported, disabling");
-- 
1.6.0.2

