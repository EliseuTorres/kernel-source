From: Sheng Yang <sheng@linux.intel.com>
Subject: [PATCH] x86: Export FPU API for KVM use
Patch-mainline: yes
References: FATE#311768
Git-commit: 5ee481da7b62a992b91f958bf26aaaa92354c170

Also add some constants.

Signed-off-by: Sheng Yang <sheng@linux.intel.com>
Signed-off-by: Avi Kivity <avi@redhat.com>
Acked-by: Bruce Rogers <brogers@suse.com>
---
 arch/x86/include/asm/i387.h  |    2 ++
 arch/x86/include/asm/xsave.h |    3 +++
 arch/x86/kernel/i387.c       |    3 ++-
 arch/x86/kernel/process.c    |    1 +
 4 files changed, 8 insertions(+), 1 deletions(-)

Index: linux-2.6.32-SLE11-SP2/arch/x86/include/asm/i387.h
===================================================================
--- linux-2.6.32-SLE11-SP2.orig/arch/x86/include/asm/i387.h
+++ linux-2.6.32-SLE11-SP2/arch/x86/include/asm/i387.h
@@ -488,6 +488,8 @@ static inline void fpu_copy(struct fpu *
 	memcpy(dst->state, src->state, xstate_size);
 }
 
+extern void fpu_finit(struct fpu *fpu);
+
 #endif /* __ASSEMBLY__ */
 
 #define PSHUFB_XMM5_XMM0 .byte 0x66, 0x0f, 0x38, 0x00, 0xc5
Index: linux-2.6.32-SLE11-SP2/arch/x86/include/asm/xsave.h
===================================================================
--- linux-2.6.32-SLE11-SP2.orig/arch/x86/include/asm/xsave.h
+++ linux-2.6.32-SLE11-SP2/arch/x86/include/asm/xsave.h
@@ -13,6 +13,9 @@
 
 #define FXSAVE_SIZE	512
 
+#define XSTATE_YMM_SIZE 256
+#define XSTATE_YMM_OFFSET (512 + 64)
+
 /*
  * These are the features that the OS can handle currently.
  */
Index: linux-2.6.32-SLE11-SP2/arch/x86/kernel/i387.c
===================================================================
--- linux-2.6.32-SLE11-SP2.orig/arch/x86/kernel/i387.c
+++ linux-2.6.32-SLE11-SP2/arch/x86/kernel/i387.c
@@ -106,7 +106,7 @@ void __cpuinit fpu_init(void)
 }
 #endif	/* CONFIG_X86_64 */
 
-static void fpu_finit(struct fpu *fpu)
+void fpu_finit(struct fpu *fpu)
 {
 #ifdef CONFIG_X86_32
 	if (!HAVE_HWFP) {
@@ -131,6 +131,7 @@ static void fpu_finit(struct fpu *fpu)
 		fp->fos = 0xffff0000u;
 	}
 }
+EXPORT_SYMBOL_GPL(fpu_finit);
 
 /*
  * The _current_ task is using the FPU for the first time
Index: linux-2.6.32-SLE11-SP2/arch/x86/kernel/process.c
===================================================================
--- linux-2.6.32-SLE11-SP2.orig/arch/x86/kernel/process.c
+++ linux-2.6.32-SLE11-SP2/arch/x86/kernel/process.c
@@ -27,6 +27,7 @@ unsigned long idle_nomwait;
 EXPORT_SYMBOL(idle_nomwait);
 
 struct kmem_cache *task_xstate_cachep;
+EXPORT_SYMBOL_GPL(task_xstate_cachep);
 
 int arch_dup_task_struct(struct task_struct *dst, struct task_struct *src)
 {
