From aeabfb078eaa7c8bb2e2f67924c3169b487673f9 Mon Sep 17 00:00:00 2001
From: Jeff Liu <jeff.liu@oracle.com>
Date: Wed, 14 Sep 2011 14:11:21 +0800
Patch-mainline: pending
References: FATE#306586
Subject: [PATCH] btrfs: trivial fix, a potential memory leak in
 btrfs_parse_early_options()

Signed-off-by: Jie Liu <jeff.liu@oracle.com>
Signed-off-by: David Sterba <dsterba@suse.cz>
---
 fs/btrfs/super.c |   10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

Index: linux-3.0-SLE11-SP2-3.0/fs/btrfs/super.c
===================================================================
--- linux-3.0-SLE11-SP2-3.0.orig/fs/btrfs/super.c
+++ linux-3.0-SLE11-SP2-3.0/fs/btrfs/super.c
@@ -406,7 +406,7 @@ static int btrfs_parse_early_options(con
 		u64 *subvol_rootid, struct btrfs_fs_devices **fs_devices)
 {
 	substring_t args[MAX_OPT_ARGS];
-	char *opts, *orig, *p;
+	char *device_name, *opts, *orig, *p;
 	int error = 0;
 	int intarg;
 
@@ -457,8 +457,14 @@ static int btrfs_parse_early_options(con
 			}
 			break;
 		case Opt_device:
-			error = btrfs_scan_one_device(match_strdup(&args[0]),
+			device_name = match_strdup(&args[0]);
+			if (!device_name) {
+				error = -ENOMEM;
+				goto out;
+			}
+			error = btrfs_scan_one_device(device_name,
 					flags, holder, fs_devices);
+			kfree(device_name);
 			if (error)
 				goto out_free_opts;
 			break;
