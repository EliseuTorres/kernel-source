From: Miklos Szeredi <mszeredi@suse.cz>
Subject: shmem: legacy rename
Patch-mainline: Never
References: FATE#318783

Mainline requires at most one of .rename or .rename2 (7177a9c4b509 "fs:
call rename2 if exists").  But that change pulls in a few inconvenient
dependencies, so for SLE12 keep the legacy rename even if .rename2 is
implemented.

Signed-off-by: Miklos Szeredi <mszeredi@suse.cz>
---
 mm/shmem.c |    5 +++++
 1 file changed, 5 insertions(+)

--- a/mm/shmem.c
+++ b/mm/shmem.c
@@ -2144,6 +2144,10 @@ static int shmem_rename2(struct inode *o
 	inode->i_ctime = CURRENT_TIME;
 	return 0;
 }
+static int shmem_rename_legacy(struct inode *old_dir, struct dentry *old_dentry, struct inode *new_dir, struct dentry *new_dentry)
+{
+	return shmem_rename2(old_dir, old_dentry, new_dir, new_dentry, 0);
+}
 
 static int shmem_symlink(struct inode *dir, struct dentry *dentry, const char *symname)
 {
@@ -2806,6 +2810,7 @@ static const struct inode_operations shm
 	.mkdir		= shmem_mkdir,
 	.rmdir		= shmem_rmdir,
 	.mknod		= shmem_mknod,
+	.rename		= shmem_rename_legacy,
 	.rename2	= shmem_rename2,
 	.tmpfile	= shmem_tmpfile,
 #endif
