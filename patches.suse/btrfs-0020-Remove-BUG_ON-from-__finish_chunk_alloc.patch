From 5df391b9e6554b9ad4c1a1ffae85126744bdc56b Mon Sep 17 00:00:00 2001
From: Mark Fasheh <mfasheh@suse.de>
Date: Thu, 8 Sep 2011 17:40:01 -0700
Subject: [PATCH 20/20] btrfs: Remove BUG_ON from __finish_chunk_alloc()
Git-commit: 3acd395317f22b4346a139571cd4723408c5d4af
Patch-mainline: v3.4-rc3

btrfs_alloc_chunk() unconditionally BUGs on any error returned from
__finish_chunk_alloc() so there's no need for two BUG_ON lines. Remove the
one from __finish_chunk_alloc().

Signed-off-by: Mark Fasheh <mfasheh@suse.de>
---
 fs/btrfs/volumes.c |    4 +++-
 1 files changed, 3 insertions(+), 1 deletions(-)

Index: linux-3.0-SLE11-SP2-3.0/fs/btrfs/volumes.c
===================================================================
--- linux-3.0-SLE11-SP2-3.0.orig/fs/btrfs/volumes.c
+++ linux-3.0-SLE11-SP2-3.0/fs/btrfs/volumes.c
@@ -2612,7 +2612,8 @@ static int __finish_chunk_alloc(struct b
 		device = map->stripes[index].dev;
 		device->bytes_used += stripe_size;
 		ret = btrfs_update_device(trans, device);
-		BUG_ON(ret);
+		if (ret)
+			goto out_free;
 		index++;
 	}
 
@@ -2649,6 +2650,7 @@ static int __finish_chunk_alloc(struct b
 					     item_size);
 	}
 
+out_free:
 	kfree(chunk);
 	return ret;
 }

