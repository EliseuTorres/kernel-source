From: Miklos Szeredi <mszeredi@suse.cz>
Subject: ext4: legacy rename
Patch-mainline: Never
References: FATE#318783

Mainline requires at most one of .rename or .rename2 (7177a9c4b509 "fs:
call rename2 if exists").  But that change pulls in a few inconvenient
dependencies, so for SLE12 keep the legacy rename even if .rename2 is
implemented.

Signed-off-by: Miklos Szeredi <mszeredi@suse.cz>
---
 fs/ext4/namei.c |    8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

--- a/fs/ext4/namei.c
+++ b/fs/ext4/namei.c
@@ -3507,6 +3507,12 @@ static int ext4_rename2(struct inode *ol
 	return ext4_rename(old_dir, old_dentry, new_dir, new_dentry, flags);
 }
 
+static int ext4_rename_legacy(struct inode *old_dir, struct dentry *old_dentry,
+			      struct inode *new_dir, struct dentry *new_dentry)
+{
+	return ext4_rename(old_dir, old_dentry, new_dir, new_dentry, 0);
+}
+
 /*
  * directories can handle most operations...
  */
@@ -3520,7 +3526,7 @@ const struct inode_operations ext4_dir_i
 	.rmdir		= ext4_rmdir,
 	.mknod		= ext4_mknod,
 	.tmpfile	= ext4_tmpfile,
-	.rename		= ext4_rename,
+	.rename		= ext4_rename_legacy,
 	.rename2	= ext4_rename2,
 	.setattr	= ext4_setattr,
 	.setxattr	= generic_setxattr,
