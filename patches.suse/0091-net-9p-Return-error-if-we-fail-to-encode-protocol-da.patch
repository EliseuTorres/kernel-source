From: Aneesh Kumar K.V <aneesh.kumar@linux.vnet.ibm.com>
Subject: [PATCH 091/111]     net/9p: Return error if we fail to encode protocol data
Git-commit: 7b3bb3fe166702b504f1068359c9550d3b277eaf
Patch-Mainline: 2.6.37
References: FATE#311639

    We need to return error in case we fail to encode data in protocol buffer.
    This patch also return error in case of a failed copy_from_user.

	upstream commit 7b3bb3fe166702b504f1068359c9550d3b277eaf

    Signed-off-by: Aneesh Kumar K.V <aneesh.kumar@linux.vnet.ibm.com>
    Signed-off-by: Venkateswararao Jujjuri <jvrao@linux.vnet.ibm.com>
    Signed-off-by: Eric Van Hensbergen <ericvh@gmail.com>
Signed-off-by: Harsh Prateek Bora <harsh@linux.vnet.ibm.com>
Acked-by: Bruce Rogers <brogers@suse.com>
---
 net/9p/client.c   |    2 ++
 net/9p/protocol.c |    5 ++---
 2 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/net/9p/client.c b/net/9p/client.c
index 9686277..f024b2f 100644
--- a/net/9p/client.c
+++ b/net/9p/client.c
@@ -578,6 +578,8 @@ p9_client_rpc(struct p9_client *c, int8_t type, const char *fmt, ...)
 	va_start(ap, fmt);
 	err = p9pdu_vwritef(req->tc, c->proto_version, fmt, ap);
 	va_end(ap);
+	if (err)
+		goto reterr;
 	p9pdu_finalize(req->tc);
 
 	err = c->trans_mod->request(c, req);
diff --git a/net/9p/protocol.c b/net/9p/protocol.c
index 0380462..23604a2 100644
--- a/net/9p/protocol.c
+++ b/net/9p/protocol.c
@@ -121,9 +121,8 @@ static size_t
 pdu_write_u(struct p9_fcall *pdu, const char __user *udata, size_t size)
 {
 	size_t len = MIN(pdu->capacity - pdu->size, size);
-	int err = copy_from_user(&pdu->sdata[pdu->size], udata, len);
-	if (err)
-		printk(KERN_WARNING "pdu_write_u returning: %d\n", err);
+	if (copy_from_user(&pdu->sdata[pdu->size], udata, len))
+		len = 0;
 
 	pdu->size += len;
 	return size - len;
-- 
1.7.1.1

