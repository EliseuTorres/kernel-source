From: Josef Bacik <josef@redhat.com>
Date: Fri, 28 Jan 2011 18:44:44 +0000
Patch-mainline: yes
References: FATE#306586
Subject: [PATCH] Btrfs: do error checking in btrfs_del_csums

Got a report of a box panicing because we got a NULL eb in read_extent_buffer.
His fs was borked and btrfs_search_path returned EIO, but we don't check for
errors so the box paniced.  Yes I know this will just make something higher up
the stack panic, but that's a problem for future Josef.  Thanks,

Signed-off-by: Josef Bacik <josef@redhat.com>
Signed-off-by: Chris Mason <chris.mason@oracle.com>
Signed-off-by: David Sterba <dsterba@suse.cz>
---
 fs/btrfs/file-item.c |    3 +++
 1 file changed, 3 insertions(+)

--- a/fs/btrfs/file-item.c
+++ b/fs/btrfs/file-item.c
@@ -549,7 +549,10 @@ int btrfs_del_csums(struct btrfs_trans_h
 			if (path->slots[0] == 0)
 				goto out;
 			path->slots[0]--;
+		} else if (ret < 0) {
+			goto out;
 		}
+
 		leaf = path->nodes[0];
 		btrfs_item_key_to_cpu(leaf, &key, path->slots[0]);
 
