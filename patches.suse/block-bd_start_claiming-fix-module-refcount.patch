From: Nick Piggin <npiggin@suse.de>
Date: Wed, 26 May 2010 01:50:21 +1000
Subject: [PATCH] block: bd_start_claiming fix module refcount
Git-commit: cf3425707ed9ce0d5ebaba20bc3d22dd39e52f2f
References: FATE#311692
Patch-Mainline: 2.6.35

bd_start_claiming has an unbalanced module_put introduced in 6b4517a79.

Signed-off-by: Nick Piggin <npiggin@suse.de>
Acked-by: Tejun Heo <tj@kernel.org>
Signed-off-by: Jens Axboe <jaxboe@fusionio.com>
Signed-off-by: Hannes Reinecke <hare@suse.de>
---
 fs/block_dev.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

diff --git a/fs/block_dev.c b/fs/block_dev.c
index 29f8a95..98c1602 100644
--- a/fs/block_dev.c
+++ b/fs/block_dev.c
@@ -773,6 +773,7 @@ static struct block_device *bd_start_claiming(struct block_device *bdev,
 		return ERR_PTR(-ENXIO);
 
 	whole = bdget_disk(disk, 0);
+	module_put(disk->fops->owner);
 	put_disk(disk);
 	if (!whole)
 		return ERR_PTR(-ENOMEM);
-- 
1.6.0.2

