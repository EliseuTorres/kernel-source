From: Jens Axboe <jaxboe@fusionio.com>
Date: Wed, 30 Mar 2011 13:27:09 +0200
Subject: block: make the flush insertion use the tail of the dispatch list
References: FATE#312039
Patch-mainline: v2.6.39-rc2
Git-commit: 53d63e6b0dfb95882ec0219ba6bbd50cde423794

It's not a preempt type request, in fact we have to insert it
behind requests that do specify INSERT_FRONT.

Signed-off-by: Jens Axboe <jaxboe@fusionio.com>
Acked-by: Suresh Jayaraman <sjayaraman@suse.de>
---
 block/blk-flush.c |    4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

Index: linux-2.6.32-SLE11-SP2/block/blk-flush.c
===================================================================
--- linux-2.6.32-SLE11-SP2.orig/block/blk-flush.c
+++ linux-2.6.32-SLE11-SP2/block/blk-flush.c
@@ -261,7 +261,7 @@ static bool blk_kick_flush(struct reques
 	q->flush_rq.end_io = flush_end_io;
 
 	q->flush_pending_idx ^= 1;
-	elv_insert(q, &q->flush_rq, ELEVATOR_INSERT_REQUEUE);
+	list_add_tail(&q->flush_rq.queuelist, &q->queue_head);
 	return true;
 }
 
@@ -310,7 +310,7 @@ void blk_insert_flush(struct request *rq
 	 */
 	if ((policy & REQ_FSEQ_DATA) &&
 	    !(policy & (REQ_FSEQ_PREFLUSH | REQ_FSEQ_POSTFLUSH))) {
-		list_add(&rq->queuelist, &q->queue_head);
+		list_add_tail(&rq->queuelist, &q->queue_head);
 		return;
 	}
 
