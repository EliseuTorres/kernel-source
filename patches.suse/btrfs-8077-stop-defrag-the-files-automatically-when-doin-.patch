From: Miao Xie <miaox@cn.fujitsu.com>
Date: Thu, 17 May 2012 19:55:23 +0800
Patch-mainline: pending
References: FATE#306586
Subject: [PATCH] Btrfs: stop defrag the files automatically when
 doin readonly remount or umount

If we remount the fs to be readonly or umount it, we should not continue
defraging the files, it is because
- the auto defragment will introduce lots of dirty pages, it breaks the rule
  of a readonly file system.
- it make the time of remount/umount become longer.

Signed-off-by: Miao Xie <miaox@cn.fujitsu.com>
Signed-off-by: David Sterba <dsterba@suse.cz>
---
 fs/btrfs/disk-io.c |   22 +++++++++++-----------
 fs/btrfs/file.c    |    3 ++-
 fs/btrfs/super.c   |    5 +++++
 3 files changed, 18 insertions(+), 12 deletions(-)

--- a/fs/btrfs/disk-io.c
+++ b/fs/btrfs/disk-io.c
@@ -1671,17 +1671,19 @@ static int cleaner_kthread(void *arg)
 
 		vfs_check_frozen(root->fs_info->sb, SB_FREEZE_WRITE);
 
+		if (!down_read_trylock(&root->fs_info->sb->s_umount))
+			goto skip;
+
 		if (!(root->fs_info->sb->s_flags & MS_RDONLY) &&
-		    down_read_trylock(&root->fs_info->sb->s_umount)) {
-			if (mutex_trylock(&root->fs_info->cleaner_mutex)) {
-				btrfs_run_delayed_iputs(root);
-				again = btrfs_clean_one_deleted_snapshot(root);
-				mutex_unlock(&root->fs_info->cleaner_mutex);
-			}
+		    mutex_trylock(&root->fs_info->cleaner_mutex)) {
+			btrfs_run_delayed_iputs(root);
+			again = btrfs_clean_one_deleted_snapshot(root);
+			mutex_unlock(&root->fs_info->cleaner_mutex);
 			btrfs_run_defrag_inodes(root->fs_info);
-			up_read(&root->fs_info->sb->s_umount);
 		}
 
+		up_read(&root->fs_info->sb->s_umount);
+skip:
 		if (freezing(current)) {
 			refrigerator();
 		} else if (!again) {
@@ -3447,13 +3449,11 @@ int close_ctree(struct btrfs_root *root)
 
 	btrfs_scrub_cancel(fs_info);
 
-	/* wait for any defraggers to finish */
-	wait_event(fs_info->transaction_wait,
-		   (atomic_read(&fs_info->defrag_running) == 0));
-
 	/* clear out the rbtree of defraggable inodes */
 	btrfs_cleanup_defrag_inodes(fs_info);
 
+	BUG_ON(atomic_read(&fs_info->defrag_running));
+
 	if (!(fs_info->sb->s_flags & MS_RDONLY)) {
 		ret = btrfs_commit_super(root);
 		if (ret)
--- a/fs/btrfs/file.c
+++ b/fs/btrfs/file.c
@@ -136,7 +136,8 @@ static inline int __need_auto_defrag(str
 	if (!btrfs_test_opt(root, AUTO_DEFRAG))
 		return 0;
 
-	if (btrfs_fs_closing(root->fs_info))
+	if (btrfs_fs_closing(root->fs_info)
+	    || (root->fs_info->sb->s_flags & MS_RDONLY))
 		return 0;
 
 	return 1;
--- a/fs/btrfs/super.c
+++ b/fs/btrfs/super.c
@@ -1270,6 +1270,11 @@ static int btrfs_remount(struct super_bl
 		ret = btrfs_commit_super(root);
 		if (ret)
 			goto restore;
+
+		/* clear out the rbtree of defraggable inodes */
+		btrfs_run_defrag_inodes(fs_info);
+
+		BUG_ON(atomic_read(&fs_info->defrag_running));
 	} else {
 		if (fs_info->fs_devices->rw_devices == 0) {
 			ret = -EACCES;
