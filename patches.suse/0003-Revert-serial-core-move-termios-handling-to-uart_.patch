From: Jiri Slaby <jslaby@suse.cz>
Date: Wed, 7 Dec 2011 05:40:25 +0100
Subject: Revert "serial: core, move termios handling to uart_startup"
Patch-mainline: never
References: bnc#718518

This reverts commit c7d7abff40c27f82fe78b1091ab3fad69b2546f9.

The last two patch in these series introduced serial lockups on UV
machines. So revert those.

To be able to do that we need patches 1-3 to reintroduce
uart_update_termios.

Signed-off-by: Jiri Slaby <jslaby@suse.cz>
---
 drivers/tty/serial/serial_core.c |   24 +++++++++++++++---------
 1 files changed, 15 insertions(+), 9 deletions(-)

diff --git a/drivers/tty/serial/serial_core.c b/drivers/tty/serial/serial_core.c
index da0d889..3e00ebf 100644
--- a/drivers/tty/serial/serial_core.c
+++ b/drivers/tty/serial/serial_core.c
@@ -170,17 +170,13 @@ static int uart_startup(struct tty_struct *tty, struct uart_state *state, int in
 
 	retval = uport->ops->startup(uport);
 	if (retval == 0) {
-		if (uart_console(uport) && uport->cons->cflag) {
-			tty->termios->c_cflag = uport->cons->cflag;
-			uport->cons->cflag = 0;
-		}
-		/*
-		 * Initialise the hardware port settings.
-		 */
-		uart_change_speed(tty, state, NULL);
-
 		if (init_hw) {
 			/*
+			 * Initialise the hardware port settings.
+			 */
+			uart_change_speed(tty, state, NULL);
+
+			/*
 			 * Setup the RTS and DTR signals once the
 			 * port is open and ready to respond.
 			 */
@@ -1471,6 +1467,11 @@ static void uart_update_termios(struct tty_struct *tty,
 {
 	struct uart_port *port = state->uart_port;
 
+	if (uart_console(port) && port->cons->cflag) {
+		tty->termios->c_cflag = port->cons->cflag;
+		port->cons->cflag = 0;
+	}
+
 	/*
 	 * If the device failed to grab its irq resources,
 	 * or some other error occurred, don't try to talk
@@ -1478,6 +1479,11 @@ static void uart_update_termios(struct tty_struct *tty,
 	 */
 	if (!(tty->flags & (1 << TTY_IO_ERROR))) {
 		/*
+		 * Make termios settings take effect.
+		 */
+		uart_change_speed(tty, state, NULL);
+
+		/*
 		 * And finally enable the RTS and DTR signals.
 		 */
 		if (tty->termios->c_cflag & CBAUD)
-- 
1.6.0.2

