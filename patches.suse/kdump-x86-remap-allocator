From: Petr Tesarik <ptesarik@suse.cz>
Subject: Save remap allocator symbols to VMCOREINFO
References: bnc#738742
Patch-mainline: no

Export remap allocator internal symbols in VMCOREINFO for use by
makedumpfile.

Signed-off-by: Petr Tesarik <ptesarik@suse.cz>

---
 arch/x86/include/asm/numa.h        |    6 ++++++
 arch/x86/kernel/machine_kexec_32.c |    1 +
 arch/x86/mm/numa_32.c              |    8 ++++++++
 3 files changed, 15 insertions(+)

--- a/arch/x86/include/asm/numa.h
+++ b/arch/x86/include/asm/numa.h
@@ -64,12 +64,18 @@ extern void __cpuinit numa_clear_node(in
 extern void __init init_cpu_to_node(void);
 extern void __cpuinit numa_add_cpu(int cpu);
 extern void __cpuinit numa_remove_cpu(int cpu);
+# ifdef CONFIG_X86_32
+extern void alloc_remap_save_vmcoreinfo(void);
+# else
+static inline void alloc_remap_save_vmcoreinfo(void)	{ }
+# endif
 #else	/* CONFIG_NUMA */
 static inline void numa_set_node(int cpu, int node)	{ }
 static inline void numa_clear_node(int cpu)		{ }
 static inline void init_cpu_to_node(void)		{ }
 static inline void numa_add_cpu(int cpu)		{ }
 static inline void numa_remove_cpu(int cpu)		{ }
+static inline void alloc_remap_save_vmcoreinfo(void)	{ }
 #endif	/* CONFIG_NUMA */
 
 #ifdef CONFIG_DEBUG_PER_CPU_MAPS
--- a/arch/x86/kernel/machine_kexec_32.c
+++ b/arch/x86/kernel/machine_kexec_32.c
@@ -269,5 +269,6 @@ void arch_crash_save_vmcoreinfo(void)
 #ifdef CONFIG_X86_PAE
 	VMCOREINFO_CONFIG(X86_PAE);
 #endif
+	alloc_remap_save_vmcoreinfo();
 }
 
--- a/arch/x86/mm/numa_32.c
+++ b/arch/x86/mm/numa_32.c
@@ -263,3 +263,11 @@ void __init initmem_init(void)
 
 	setup_bootmem_allocator();
 }
+
+void alloc_remap_save_vmcoreinfo(void)
+{
+	VMCOREINFO_SYMBOL(node_remap_start_vaddr);
+	VMCOREINFO_SYMBOL(node_remap_end_vaddr);
+	VMCOREINFO_SYMBOL(node_remap_start_pfn);
+	VMCOREINFO_LENGTH(node_remap_start_pfn, MAX_NUMNODES);
+}
