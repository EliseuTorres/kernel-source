From: Chris Mason <chris.mason@oracle.com>
Date: Thu, 3 Nov 2011 22:23:13 -0400
Patch-mainline: v3.2-rc1
References: FATE#306586
Git-commit: c674e04e1cd6049715e7b9446790f4b441e547c0
Subject: [PATCH] Btrfs: fix extent_buffer leak in the metadata IO
 error handling

The scrub readahead branch brought in a new error handling hook,
but it was leaking extent_buffer references.

Signed-off-by: Chris Mason <chris.mason@oracle.com>
Signed-off-by: David Sterba <dsterba@suse.cz>
---
 fs/btrfs/disk-io.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

diff --git a/fs/btrfs/disk-io.c b/fs/btrfs/disk-io.c
index 0eb1f09..40a62b9 100644
--- a/fs/btrfs/disk-io.c
+++ b/fs/btrfs/disk-io.c
@@ -644,6 +644,7 @@ static int btree_io_failed_hook(struct bio *failed_bio,
 		clear_bit(EXTENT_BUFFER_READAHEAD, &eb->bflags);
 		btree_readahead_hook(root, eb, eb->start, -EIO);
 	}
+	free_extent_buffer(eb);
 
 out:
 	return -EIO;	/* we fixed nothing */
-- 
1.7.6.233.gd79bc


