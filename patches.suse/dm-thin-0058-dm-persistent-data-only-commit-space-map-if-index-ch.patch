Git-commit: f4b90369d3a9ffe0f48f373c566578c142e95bf2
From: Joe Thornber <ejt@redhat.com>
Date: Fri, 27 Jul 2012 15:08:06 +0100
Subject: [PATCH] dm persistent data: only commit space map if index changed
Patch-mainline: v3.6-rc1
Reference: FATE#313903

Introduce bitmap_index_changed to track whether or not the index changed
then only commit a space map if it did.

Signed-off-by: Joe Thornber <ejt@redhat.com>
Signed-off-by: Mike Snitzer <snitzer@redhat.com>
Signed-off-by: Alasdair G Kergon <agk@redhat.com>
Acked-by: NeilBrown <nfbrown@suse.com>

---
 drivers/md/persistent-data/dm-space-map-common.c |   12 +++++++++++-
 drivers/md/persistent-data/dm-space-map-common.h |    1 +
 2 files changed, 12 insertions(+), 1 deletion(-)

--- linux-3.0-SLE11-SP3.orig/drivers/md/persistent-data/dm-space-map-common.c
+++ linux-3.0-SLE11-SP3/drivers/md/persistent-data/dm-space-map-common.c
@@ -224,6 +224,7 @@ static int sm_ll_init(struct ll_disk *ll
 	ll->nr_blocks = 0;
 	ll->bitmap_root = 0;
 	ll->ref_count_root = 0;
+	ll->bitmap_index_changed = false;
 
 	return 0;
 }
@@ -476,7 +477,15 @@ int sm_ll_dec(struct ll_disk *ll, dm_blo
 
 int sm_ll_commit(struct ll_disk *ll)
 {
-	return ll->commit(ll);
+	int r = 0;
+
+	if (ll->bitmap_index_changed) {
+		r = ll->commit(ll);
+		if (!r)
+			ll->bitmap_index_changed = false;
+	}
+
+	return r;
 }
 
 /*----------------------------------------------------------------*/
@@ -491,6 +500,7 @@ static int metadata_ll_load_ie(struct ll
 static int metadata_ll_save_ie(struct ll_disk *ll, dm_block_t index,
 			       struct disk_index_entry *ie)
 {
+	ll->bitmap_index_changed = true;
 	memcpy(ll->mi_le.index + index, ie, sizeof(*ie));
 	return 0;
 }
--- linux-3.0-SLE11-SP3.orig/drivers/md/persistent-data/dm-space-map-common.h
+++ linux-3.0-SLE11-SP3/drivers/md/persistent-data/dm-space-map-common.h
@@ -78,6 +78,7 @@ struct ll_disk {
 	open_index_fn open_index;
 	max_index_entries_fn max_entries;
 	commit_fn commit;
+	bool bitmap_index_changed:1;
 };
 
 struct disk_sm_root {
