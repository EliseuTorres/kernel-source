From: David Sterba <dsterba@suse.cz>
Date: Fri, 1 Jun 2012 12:41:10 +0200
Patch-mainline: pending
References: FATE#306586
Subject: [PATCH] btrfs: do not update atime for RO snapshots

"if a snapshot was created with -r and thus is read only, accessing
files in it will update the atime. I would expect that atime is not
updated on ro snapshots."

This is a workaround, does not break kabi. Upcoming upstream patches
extend file operations with filesystem-specific ->update_time where
this check belongs.

Author: Alexander Block <ablock84@googlemail.com>
Signed-off-by: David Sterba <dsterba@suse.cz>
---
 fs/btrfs/ioctl.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/fs/btrfs/ioctl.c b/fs/btrfs/ioctl.c
index d76e8d6..80110d4 100644
--- a/fs/btrfs/ioctl.c
+++ b/fs/btrfs/ioctl.c
@@ -113,6 +113,9 @@ void btrfs_update_iflags(struct inode *inode)
 		inode->i_flags |= S_NOATIME;
 	if (ip->flags & BTRFS_INODE_DIRSYNC)
 		inode->i_flags |= S_DIRSYNC;
+
+	if (btrfs_root_readonly(ip->root))
+		inode->i_flags |= S_NOATIME;
 }
 
 /*
-- 
1.7.6.233.gd79bc

