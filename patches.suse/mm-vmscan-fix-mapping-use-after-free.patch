From: Nick Piggin <npiggin@suse.de>
Date: Tue, 20 Jul 2010 13:24:25 -0700
Subject: [PATCH] mm/vmscan.c: fix mapping use after free
References: Page reclaim fixes (fate#311931)
Patch-mainline: yes (2.6.36)
Commit-ID: a6aa62a0909b9ccb1f8b0d2653920ba071037972

We need lock_page_nosync() here because we have no reference to the
mapping when taking the page lock.

Signed-off-by: Nick Piggin <npiggin@suse.de>
Reviewed-by: Johannes Weiner <hannes@cmpxchg.org>
Cc: Mel Gorman <mgorman@suse.de>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Mel Gorman <mgorman@suse.de>
---
 mm/vmscan.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/mm/vmscan.c b/mm/vmscan.c
index fb161c6..b4d029f 100644
--- a/mm/vmscan.c
+++ b/mm/vmscan.c
@@ -293,7 +293,7 @@ static int may_write_to_queue(struct backing_dev_info *bdi)
 static void handle_write_error(struct address_space *mapping,
 				struct page *page, int error)
 {
-	lock_page(page);
+	lock_page_nosync(page);
 	if (page_mapping(page) == mapping)
 		mapping_set_error(mapping, error);
 	unlock_page(page);
