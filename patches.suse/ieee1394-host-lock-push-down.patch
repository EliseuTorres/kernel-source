From: Jeff Mahoney <jeffm@suse.com>
Subject: [PATCH] ieee1394 host lock push-down
Patch-mainline: Never

 From commit f281233d (SCSI host lock push-down):

 Move the mid-layer's ->queuecommand() invocation from being locked
 with the host lock to being unlocked to facilitate speeding up the
 critical path for drivers who don't need this lock taken anyway.

 The patch below presents a simple SCSI host lock push-down as an
 equivalent transformation.  No locking or other behavior should change
 with this patch.  All existing bugs and locking orders are preserved.

 Additionally, add one parameter to queuecommand,
	struct Scsi_Host *
 and remove one parameter from queuecommand,
	void (*done)(struct scsi_cmnd *)

 Scsi_Host* is a convenient pointer that most host drivers need anyway,
 and 'done' is redundant to struct scsi_cmnd->scsi_done.

 Minimal code disturbance was attempted with this change.  Most drivers
 needed only two one-line modifications for their host lock push-down.

 Signed-off-by: Jeff Garzik <jgarzik@redhat.com>
 Acked-by: James Bottomley <James.Bottomley@suse.de>
 Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
 Signed-off-by: Hannes Reinecke <hare@suse.de>


Signed-by: Jeff Mahoney <jeffm@suse.com>
---
 drivers/ieee1394/sbp2.c |   10 ++++++----
 1 file changed, 6 insertions(+), 4 deletions(-)

--- a/drivers/ieee1394/sbp2.c
+++ b/drivers/ieee1394/sbp2.c
@@ -312,8 +312,10 @@ static struct hpsb_protocol_driver sbp2_
 /*
  * Interface to SCSI core
  */
-static int sbp2scsi_queuecommand(struct scsi_cmnd *,
-				 void (*)(struct scsi_cmnd *));
+static int sbp2scsi_queuecommand_lck(struct scsi_cmnd *,
+				     void (*)(struct scsi_cmnd *));
+static DEF_SCSI_QCMD(sbp2scsi_queuecommand)
+
 static int sbp2scsi_abort(struct scsi_cmnd *);
 static int sbp2scsi_reset(struct scsi_cmnd *);
 static int sbp2scsi_slave_alloc(struct scsi_device *);
@@ -1855,8 +1857,8 @@ static int sbp2_handle_status_write(stru
  * SCSI interface related section
  **************************************/
 
-static int sbp2scsi_queuecommand(struct scsi_cmnd *SCpnt,
-				 void (*done)(struct scsi_cmnd *))
+static int sbp2scsi_queuecommand_lck(struct scsi_cmnd *SCpnt,
+				     void (*done)(struct scsi_cmnd *))
 {
 	struct sbp2_lu *lu = (struct sbp2_lu *)SCpnt->device->host->hostdata[0];
 	struct sbp2_fwhost_info *hi;
