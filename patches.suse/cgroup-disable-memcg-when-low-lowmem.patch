From: Jiri Slaby <jslaby@suse.cz>
Date: Thu, 8 Apr 2010 21:00:10 +0000
Subject: disable memory cgroup if low lowmem
Patch-mainline: never
References: bnc#586684

On some machines with much high memory and low lowmem, i.e. x86_32 with
PAE, the lowmem gets exhausted by memcg allocations. It is because of
flatmem used.

So disable memcg when one node is bigger than 8G on such machines.

Signed-off-by: Jiri Slaby <jslaby@suse.cz>
---
 mm/page_cgroup.c |   25 ++++++++++++++++++++++++-
 1 file changed, 24 insertions(+), 1 deletion(-)

--- a/mm/page_cgroup.c
+++ b/mm/page_cgroup.c
@@ -69,11 +69,35 @@ static int __init alloc_node_page_cgroup
 	return 0;
 }
 
+static void disable_cgroup_if_low_lowmem(void)
+{
+	/*
+	 * disable memcg on x86 PAE boxes with more than 8G of memory in a node
+	 * memcg structures don't fit in the lowmem there
+	 */
+#if CONFIG_X86_32 && CONFIG_X86_PAE
+	int nid;
+
+	for_each_online_node(nid) {
+		unsigned long nr_pages = NODE_DATA(nid)->node_spanned_pages;
+		if (nr_pages >= (8UL << (30 - PAGE_SHIFT))) {
+			printk(KERN_ERR "%s: node %d has more than 8G of "
+					"memory. Disabling memory cgroups.\n",
+					__func__, nid);
+			mem_cgroup_subsys.disabled = 1;
+			return;
+		}
+	}
+#endif
+}
+
 void __init page_cgroup_init_flatmem(void)
 {
 
 	int nid, fail;
 
+	disable_cgroup_if_low_lowmem();
+
 	if (mem_cgroup_disabled())
 		return;
 
