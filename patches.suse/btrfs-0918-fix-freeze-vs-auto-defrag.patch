From: Miao Xie <miaox@cn.fujitsu.com>
Date: Mon, 26 Nov 2012 09:27:29 +0000
Patch-mainline: 3.8
Git-commit: b66f00da0cfceb856c17706b77906b63437f6fda
References: FATE#312888
Subject: [PATCH] Btrfs: fix freeze vs auto defrag

If we freeze the fs, the auto defragment should not run. Fix it.

Signed-off-by: Miao Xie <miaox@cn.fujitsu.com>
Signed-off-by: Chris Mason <chris.mason@fusionio.com>
Signed-off-by: David Sterba <dsterba@suse.cz>
---
 fs/btrfs/file.c |    6 ++++++
 1 file changed, 6 insertions(+)

--- a/fs/btrfs/file.c
+++ b/fs/btrfs/file.c
@@ -41,6 +41,9 @@
 #include "compat.h"
 #include "volumes.h"
 
+static inline void sb_start_write(struct super_block *sb) { }
+static inline void sb_end_write(struct super_block *sb) { }
+
 static struct kmem_cache *btrfs_inode_defrag_cachep;
 /*
  * when auto defrag is enabled we
@@ -318,8 +321,11 @@ static int __btrfs_run_defrag_inode(stru
 	memset(&range, 0, sizeof(range));
 	range.len = (u64)-1;
 	range.start = defrag->last_offset;
+
+	sb_start_write(fs_info->sb);
 	num_defrag = btrfs_defrag_file(inode, NULL, &range, defrag->transid,
 				       BTRFS_DEFRAG_BATCH);
+	sb_end_write(fs_info->sb);
 	/*
 	 * if we filled the whole defrag batch, there
 	 * must be more work to do.  Queue this defrag
