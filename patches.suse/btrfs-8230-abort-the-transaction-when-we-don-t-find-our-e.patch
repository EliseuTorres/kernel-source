From: Josef Bacik <jbacik@fb.com>
Date: Fri, 14 Mar 2014 16:36:53 -0400
Patch-mainline: 3.15
Git-commit: c4a050bbbb5d7dab03aa720af36d8e91ed7f2ec8
Subject: [PATCH] Btrfs: abort the transaction when we don't find our
 extent ref

I'm not sure why we weren't aborting here in the first place, it is obviously a
bad time from the fact that we print the leaf and yell loudly about it.  Fix
this up, otherwise we panic because our path could be pointing into oblivion.
Thanks,

Signed-off-by: Josef Bacik <jbacik@fb.com>
Signed-off-by: Chris Mason <clm@fb.com>
Signed-off-by: David Sterba <dsterba@suse.cz>
---
 fs/btrfs/extent-tree.c |    2 ++
 1 file changed, 2 insertions(+)

--- a/fs/btrfs/extent-tree.c
+++ b/fs/btrfs/extent-tree.c
@@ -5636,6 +5636,8 @@ static int __btrfs_free_extent(struct bt
 			(unsigned long long)root_objectid,
 			(unsigned long long)owner_objectid,
 			(unsigned long long)owner_offset);
+		btrfs_abort_transaction(trans, extent_root, ret);
+		goto out;
 	} else {
 		btrfs_abort_transaction(trans, extent_root, ret);
 		goto out;
