Git-commit: f1cad2b68ed12c0f82d3f56e150691f62b6f5edf
From: Shaohua Li <shli@fusionio.com>
Date: Thu, 11 Oct 2012 13:08:44 +1100
Subject: md: linear supports TRIM
Patch-mainline: v3.7
References: FATE#313625

This makes md linear support TRIM.

Signed-off-by: Shaohua Li <shli@fusionio.com>
Signed-off-by: NeilBrown <neilb@suse.de>
Acked-by: NeilBrown <neilb@suse.de>

---
 drivers/md/linear.c |   15 +++++++++++++++
 1 file changed, 15 insertions(+)

--- linux-3.0-SLE11-SP3.orig/drivers/md/linear.c
+++ linux-3.0-SLE11-SP3/drivers/md/linear.c
@@ -128,6 +128,7 @@ static linear_conf_t *linear_conf(mddev_
 	linear_conf_t *conf;
 	mdk_rdev_t *rdev;
 	int i, cnt;
+	bool discard_supported = false;
 
 	conf = kzalloc (sizeof (*conf) + raid_disks*sizeof(dev_info_t),
 			GFP_KERNEL);
@@ -170,6 +171,8 @@ static linear_conf_t *linear_conf(mddev_
 		conf->array_sectors += rdev->sectors;
 		cnt++;
 
+		if (blk_queue_discard(bdev_get_queue(rdev->bdev)))
+			discard_supported = true;
 	}
 	if (cnt != raid_disks) {
 		printk(KERN_ERR "md/linear:%s: not enough drives present. Aborting!\n",
@@ -177,6 +180,11 @@ static linear_conf_t *linear_conf(mddev_
 		goto out;
 	}
 
+	if (!discard_supported)
+		queue_flag_clear_unlocked(QUEUE_FLAG_DISCARD, mddev->queue);
+	else
+		queue_flag_set_unlocked(QUEUE_FLAG_DISCARD, mddev->queue);
+
 	/*
 	 * Here we calculate the device offsets.
 	 */
@@ -326,6 +334,13 @@ static int linear_make_request (mddev_t
 		+ tmp_dev->rdev->data_offset;
 	rcu_read_unlock();
 
+	if (unlikely((bio->bi_rw & REQ_DISCARD) &&
+		     !blk_queue_discard(bdev_get_queue(bio->bi_bdev)))) {
+		/* Just ignore it */
+		bio_endio(bio, 0);
+		return 0;
+	}
+
 	return 1;
 }
 
