From: Thomas Renninger <trenn@suse.de>
Subject: Blacklist IBM 3850 M2 / x3950 M2 to not use radeon modesetting by default
References: bnc#744314
Patch-Mainline: never

For now it looks like the graphics card's irq is set up wrongly
(irqs show up on irq 18 (nobody cared) while the radeon driver listens
for them on irq 16).
According to Egbert user mode graphics driver poll and do not need
to set up this irq. Blacklisting seem to be the appropriate workaround
for this possibly caused by a bad BIOS regression (exposed by modesetting
usage).

---
 drivers/gpu/drm/radeon/radeon_drv.c |   33 +++++++++++++++++++++++++++++++++
 1 file changed, 33 insertions(+)

Index: linux-3.0-SLE11-SP2/drivers/gpu/drm/radeon/radeon_drv.c
===================================================================
--- linux-3.0-SLE11-SP2.orig/drivers/gpu/drm/radeon/radeon_drv.c
+++ linux-3.0-SLE11-SP2/drivers/gpu/drm/radeon/radeon_drv.c
@@ -37,6 +37,9 @@
 #include "drm_pciids.h"
 #include <linux/console.h>
 
+#ifdef CONFIG_X86
+#include <linux/dmi.h>
+#endif
 
 /*
  * KMS wrapper.
@@ -375,6 +378,27 @@ static struct pci_driver radeon_kms_pci_
 	.resume = radeon_pci_resume,
 };
 
+#ifdef CONFIG_X86
+static int __init disable_modeset(const struct dmi_system_id *id)
+{
+	printk(KERN_INFO "%s detected, force modeset off\n", id->ident);
+	radeon_modeset = 0;
+	return 0;
+}
+
+static const struct dmi_system_id x86_nomodeset_blacklist[] __initconst = {
+	{
+		.callback = disable_modeset,
+		.ident = "IBM 3850 M2 / x3950 M2",
+		.matches = {
+			DMI_MATCH(DMI_SYS_VENDOR, "IBM"),
+			DMI_MATCH(DMI_PRODUCT_NAME, "IBM 3850 M2 / x3950 M2"),
+		},
+	},
+	{}
+};
+#endif
+
 static int __init radeon_init(void)
 {
 	driver = &driver_old;
@@ -392,8 +416,17 @@ static int __init radeon_init(void)
 	/* if enabled by default */
 	if (radeon_modeset == -1) {
 #ifdef CONFIG_DRM_RADEON_KMS
+
+#ifdef CONFIG_X86
+		if (!dmi_check_system(x86_nomodeset_blacklist)) {
+			DRM_INFO("radeon defaulting to kernel modesetting.\n");
+			radeon_modeset = 1;
+		}
+#else
 		DRM_INFO("radeon defaulting to kernel modesetting.\n");
 		radeon_modeset = 1;
+#endif
+
 #else
 		DRM_INFO("radeon defaulting to userspace modesetting.\n");
 		radeon_modeset = 0;
