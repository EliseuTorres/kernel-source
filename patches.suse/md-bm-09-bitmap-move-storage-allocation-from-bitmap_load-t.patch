From: NeilBrown <neilb@suse.de>
Date: Thu, 12 Apr 2012 16:27:09 +1000
Subject: [PATCH 09/23] md/bitmap: move storage allocation from bitmap_load to bitmap_create.3.5
Patch-mainline: 3.5
References: fate#311379

We should allocate memory for the storage-bitmap at create-time, not
load time.

Signed-off-by: NeilBrown <neilb@suse.de>
Acked-by: NeilBrown <neilb@suse.de>

---
 drivers/md/bitmap.c |   11 ++++++-----
 1 file changed, 6 insertions(+), 5 deletions(-)

--- linux-3.0-SLE11-SP2-BTMU.orig/drivers/md/bitmap.c
+++ linux-3.0-SLE11-SP2-BTMU/drivers/md/bitmap.c
@@ -1105,11 +1105,6 @@ static int bitmap_init_from_disk(struct
 		goto err;
 	}
 
-	ret = bitmap_storage_alloc(&bitmap->storage, bitmap->chunks,
-				   !bitmap->mddev->bitmap_info.external);
-	if (ret)
-		goto err;
-
 	oldindex = ~0L;
 	offset = 0;
 	if (!bitmap->mddev->bitmap_info.external)
@@ -1861,6 +1856,12 @@ int bitmap_create(mddev_t *mddev)
 	if (!bitmap->bp)
 		goto error;
 
+	if (file || mddev->bitmap_info.offset) {
+		err = bitmap_storage_alloc(&bitmap->storage, bitmap->chunks,
+					   !mddev->bitmap_info.external);
+		if (err)
+			goto error;
+	}
 	printk(KERN_INFO "created bitmap (%lu pages) for device %s\n",
 		pages, bmname(bitmap));
 
