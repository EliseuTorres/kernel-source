From: Mark Fasheh <mfasheh@suse.com>
Date: Tue Dec  1 16:15:11 PST 2009
Subject: gfs2: allow spectator mounts for migration to ocfs2
Patch-mainline: never
References: FATE#307584

Lock out all writeable gfs2 mounts. This allows only spectator mounts, which
should never modify the disks. We do this to support minimal use of GFS2 for
migration of data. No performance bugs will be fixed. Any writeable mounts
are strictly prohibited.

Update jeffm: Bail out if there are transactions that need to be replayed.

Signed-off-by: Mark Fasheh <mfasheh@suse.com>

---
 fs/gfs2/ops_fstype.c |   13 +++++++++++++
 fs/gfs2/recovery.c   |   11 +++++++++++
 2 files changed, 24 insertions(+)

--- a/fs/gfs2/ops_fstype.c
+++ b/fs/gfs2/ops_fstype.c
@@ -1085,6 +1085,19 @@ static int fill_super(struct super_block
 	}
 	sdp->sd_args = *args;
 
+	if (!sdp->sd_args.ar_spectator  || !(sb->s_flags & MS_RDONLY)) {
+		printk(KERN_WARNING "Only read-only GFS2 mounts are "
+		       "supported.\nPlease mount with the \"spectator\" and "
+		       "\"ro\" mount options\n");
+		error = -EROFS;
+		goto fail;
+	}
+
+	printk(KERN_WARNING
+	       "WARNING: GFS2 mounts are ONLY supported for single-node "
+	       "migration of data!\nNo performance or write bugs will be "
+	       "considered.\n");
+
 	if (sdp->sd_args.ar_spectator) {
                 sb->s_flags |= MS_RDONLY;
 		set_bit(SDF_NORECOVERY, &sdp->sd_flags);
--- a/fs/gfs2/recovery.c
+++ b/fs/gfs2/recovery.c
@@ -528,6 +528,17 @@ void gfs2_recover_func(struct work_struc
 			}
 		}
 
+		/*
+		 * SLE-specific bailout. We don't allow writes under any
+		 * circumstances.
+		 */
+		fs_warn(sdp, "jid=%d: The file system was shut down uncleanly "
+		        "and needs journal replay, which requires write "
+			"access. Please repair before attempting migration.\n",
+			jd->jd_jid);
+		error = -EROFS;
+		goto fail_gunlock_tr;
+
 		if (ro) {
 			fs_warn(sdp, "jid=%u: Can't replay: read-only block "
 				"device\n", jd->jd_jid);
