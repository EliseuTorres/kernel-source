From: David Sterba <dsterba@suse.cz>
Date: Thu, 15 Sep 2011 22:42:12 +0200
Patch-mainline: no; probably never
References: FATE#306586
Subject: [PATCH] btrfs: ratelimit WARN_ON before iput in orphan cleanup

Prevent log flood and let machine a bit more alive. Not clear how to
reproduce it, should have been fixed already in one of previous patches.

Signed-off-by: David Sterba <dsterba@suse.cz>
Signed-off-by: David Sterba <dsterba@suse.cz>
---
 fs/btrfs/inode.c |   12 +++++++++++-
 1 files changed, 11 insertions(+), 1 deletions(-)

diff --git a/fs/btrfs/inode.c b/fs/btrfs/inode.c
index 4d14de6..8905587 100644
--- a/fs/btrfs/inode.c
+++ b/fs/btrfs/inode.c
@@ -2405,7 +2405,17 @@ int btrfs_orphan_cleanup(struct btrfs_root *root)
 		/* if we have links, this was a truncate, lets do that */
 		if (inode->i_nlink) {
 			if (!S_ISREG(inode->i_mode)) {
-				WARN_ON(1);
+				static DEFINE_RATELIMIT_STATE(_rs,
+						DEFAULT_RATELIMIT_INTERVAL,
+						/*DEFAULT_RATELIMIT_BURST*/ 2);
+				if (__ratelimit(&_rs)) {
+					printk(KERN_DEBUG "btrfs: trying to iput ino=%lld mode=%u count=%d\n",
+							(unsigned long long)btrfs_ino(inode),
+							inode->i_mode,
+							atomic_read(&inode->i_count));
+					WARN_ON(1);
+				}
+
 				iput(inode);
 				continue;
 			}
-- 
1.7.6.233.gd79bc

