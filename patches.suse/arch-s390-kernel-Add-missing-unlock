Subject: [S390] arch/s390/kernel: Add missing unlock
From: Julia Lawall <julia@diku.dk>
Date: Fri Apr 9 13:42:58 2010 +0200
Git-commit: d7015c120e0ac55d86cabbe7a14997b99f39e282
References: FATE#311860

In the default case the lock is not unlocked.  The return is
converted to a goto, to share the unlock at the end of the function.

A simplified version of the semantic patch that finds this problem is as
follows: (http://coccinelle.lip6.fr/)

// <smpl>
@r exists@
expression E1;
identifier f;
@@

f (...) { <+...
* spin_lock_irq (E1,...);
... when != E1
* return ...;
...+> }
// </smpl>

Signed-off-by: Julia Lawall <julia@diku.dk>
Signed-off-by: Heiko Carstens <heiko.carstens@de.ibm.com>
Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
Acked-by: Mike Galbraith <mgalbraith@suse.de>

---
 arch/s390/kernel/topology.c |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

Index: linux-2.6.32-SLE11-SP2/arch/s390/kernel/topology.c
===================================================================
--- linux-2.6.32-SLE11-SP2.orig/arch/s390/kernel/topology.c
+++ linux-2.6.32-SLE11-SP2/arch/s390/kernel/topology.c
@@ -165,10 +165,11 @@ static void tl_to_cores(struct tl_info *
 		default:
 			clear_cores();
 			machine_has_topology = 0;
-			return;
+			goto out;
 		}
 		tle = next_tle(tle);
 	}
+out:
 	spin_unlock_irq(&topology_lock);
 }
 
