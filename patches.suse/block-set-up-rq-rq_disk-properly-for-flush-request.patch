From: FUJITA Tomonori <fujita.tomonori@lab.ntt.co.jp>
Date: Fri, 9 Jul 2010 09:38:25 +0900
Subject: [PATCH] block: set up rq->rq_disk properly for flush requests
X-Git: 16f2319fd67b169c0b34391d3fa0870fff129891
References: FATE#311692
Patch-Mainline: 2.6.34

q->bar_rq.rq_disk is NULL. Use the rq_disk of the original request
instead.

Signed-off-by: FUJITA Tomonori <fujita.tomonori@lab.ntt.co.jp>
Signed-off-by: Jens Axboe <jaxboe@fusionio.com>
Signed-off-by: Hannes Reinecke <hare@suse.de>
---
 block/blk-barrier.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/block/blk-barrier.c b/block/blk-barrier.c
index 0bb46fe..de22952 100644
--- a/block/blk-barrier.c
+++ b/block/blk-barrier.c
@@ -135,7 +135,7 @@ static void queue_flush(struct request_queue *q, unsigned which)
 	blk_rq_init(q, rq);
 	rq->cmd_type = REQ_TYPE_FS;
 	rq->cmd_flags = REQ_HARDBARRIER | REQ_FLUSH;
-	rq->rq_disk = q->bar_rq.rq_disk;
+	rq->rq_disk = q->orig_bar_rq->rq_disk;
 	rq->end_io = end_io;
 
 	elv_insert(q, rq, ELEVATOR_INSERT_FRONT);
-- 
1.6.0.2

