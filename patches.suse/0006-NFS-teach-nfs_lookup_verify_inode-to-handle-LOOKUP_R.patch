From: NeilBrown <neilb@suse.de>
Date: Tue, 4 Mar 2014 16:34:29 +1100
Patch-mainline: submitted 2014-07-24
References: bnc#866130
Subject: [PATCH 7/8] NFS: teach nfs_lookup_verify_inode to handle LOOKUP_RCU

It fails with -ECHILD rather than make an RPC call.

This allows nfs_lookup_revalidate to call it in RCU-walk mode.

Signed-off-by: NeilBrown <neilb@suse.de>
---
 fs/nfs/dir.c |   10 ++++++----
 1 file changed, 6 insertions(+), 4 deletions(-)

--- linux-3.0-SLE11-SP3.orig/fs/nfs/dir.c
+++ linux-3.0-SLE11-SP3/fs/nfs/dir.c
@@ -1095,6 +1095,8 @@ int nfs_lookup_verify_inode(struct inode
 	}
 	return nfs_revalidate_inode(server, inode);
 out_force:
+	if (nd && (nd->flags & LOOKUP_RCU))
+		return -ECHILD;
 	return __nfs_revalidate_inode(server, inode);
 }
 
@@ -1181,9 +1183,6 @@ static int nfs_lookup_revalidate(struct
 	if (!nfs_is_exclusive_create(dir, nd) &&
 	    nfs_check_verifier(dir, dentry, nd && (nd->flags & LOOKUP_RCU))) {
 
-		if (nd && (nd->flags & LOOKUP_RCU))
-			return -ECHILD;
-
 		if (nfs_server_capable(dir, NFS_CAP_READDIRPLUS)
 		    && ((NFS_I(inode)->cache_validity & NFS_INO_INVALID_ATTR)
 			|| nfs_attribute_cache_expired(inode))
@@ -1193,8 +1192,11 @@ static int nfs_lookup_revalidate(struct
 			goto out_zap_parent;
 		}
 
-		if (nfs_lookup_verify_inode(inode, nd))
+		if (nfs_lookup_verify_inode(inode, nd)) {
+			if (nd && (nd->flags & LOOKUP_RCU))
+				return -ECHILD;
 			goto out_zap_parent;
+		}
 		goto out_valid;
 	}
 
