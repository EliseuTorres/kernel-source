Subject: fill scsi_host_template.proc_name and add runtime warning if its missing
From: <ohering@suse.de>
References: bnc#718366
Patch-mainline: obsolete

---
 drivers/scsi/3w-9xxx.c              |    1 +
 drivers/scsi/3w-sas.c               |    1 +
 drivers/scsi/3w-xxxx.c              |    1 +
 drivers/scsi/aic94xx/aic94xx_init.c |    1 +
 drivers/scsi/arcmsr/arcmsr_hba.c    |    1 +
 drivers/scsi/bfa/bfad_im.c          |    2 ++
 drivers/scsi/bnx2fc/bnx2fc_fcoe.c   |    1 +
 drivers/scsi/esp_scsi.c             |    1 +
 drivers/scsi/fnic/fnic_main.c       |    1 +
 drivers/scsi/hosts.c                |    3 +++
 drivers/scsi/lpfc/lpfc_scsi.c       |    2 ++
 drivers/scsi/mvsas/mv_init.c        |    1 +
 drivers/scsi/pm8001/pm8001_init.c   |    1 +
 drivers/scsi/qla2xxx/qla_os.c       |    1 +
 drivers/usb/storage/uas.c           |    1 +
 15 files changed, 19 insertions(+)

--- a/drivers/scsi/3w-9xxx.c
+++ b/drivers/scsi/3w-9xxx.c
@@ -2011,6 +2011,7 @@ static int twa_slave_configure(struct sc
 static struct scsi_host_template driver_template = {
 	.module			= THIS_MODULE,
 	.name			= "3ware 9000 Storage Controller",
+	.proc_name		= KBUILD_MODNAME,
 	.queuecommand		= twa_scsi_queue,
 	.eh_host_reset_handler	= twa_scsi_eh_reset,
 	.bios_param		= twa_scsi_biosparam,
--- a/drivers/scsi/3w-sas.c
+++ b/drivers/scsi/3w-sas.c
@@ -1588,6 +1588,7 @@ static int twl_slave_configure(struct sc
 static struct scsi_host_template driver_template = {
 	.module			= THIS_MODULE,
 	.name			= "3w-sas",
+	.proc_name		= KBUILD_MODNAME,
 	.queuecommand		= twl_scsi_queue,
 	.eh_host_reset_handler	= twl_scsi_eh_reset,
 	.bios_param		= twl_scsi_biosparam,
--- a/drivers/scsi/3w-xxxx.c
+++ b/drivers/scsi/3w-xxxx.c
@@ -2265,6 +2265,7 @@ static int tw_slave_configure(struct scs
 static struct scsi_host_template driver_template = {
 	.module			= THIS_MODULE,
 	.name			= "3ware Storage Controller",
+	.proc_name		= KBUILD_MODNAME,
 	.queuecommand		= tw_scsi_queue,
 	.eh_host_reset_handler	= tw_scsi_eh_reset,
 	.bios_param		= tw_scsi_biosparam,
--- a/drivers/scsi/aic94xx/aic94xx_init.c
+++ b/drivers/scsi/aic94xx/aic94xx_init.c
@@ -65,6 +65,7 @@ static struct scsi_host_template aic94xx
 	.module			= THIS_MODULE,
 	/* .name is initialized */
 	.name			= "aic94xx",
+	.proc_name		= KBUILD_MODNAME,
 	.queuecommand		= sas_queuecommand,
 	.target_alloc		= sas_target_alloc,
 	.slave_configure	= sas_slave_configure,
--- a/drivers/scsi/arcmsr/arcmsr_hba.c
+++ b/drivers/scsi/arcmsr/arcmsr_hba.c
@@ -125,6 +125,7 @@ static struct scsi_host_template arcmsr_
 	.module			= THIS_MODULE,
 	.name			= "ARCMSR ARECA SATA/SAS RAID Controller"
 				ARCMSR_DRIVER_VERSION,
+	.proc_name		= KBUILD_MODNAME,
 	.info			= arcmsr_info,
 	.queuecommand		= arcmsr_queue_command,
 	.eh_abort_handler		= arcmsr_abort,
--- a/drivers/scsi/bfa/bfad_im.c
+++ b/drivers/scsi/bfa/bfad_im.c
@@ -791,6 +791,7 @@ bfad_im_slave_configure(struct scsi_devi
 struct scsi_host_template bfad_im_scsi_host_template = {
 	.module = THIS_MODULE,
 	.name = BFAD_DRIVER_NAME,
+	.proc_name		= KBUILD_MODNAME,
 	.info = bfad_im_info,
 	.queuecommand = bfad_im_queuecommand,
 	.eh_abort_handler = bfad_im_abort_handler,
@@ -813,6 +814,7 @@ struct scsi_host_template bfad_im_scsi_h
 struct scsi_host_template bfad_im_vport_template = {
 	.module = THIS_MODULE,
 	.name = BFAD_DRIVER_NAME,
+	.proc_name		= KBUILD_MODNAME,
 	.info = bfad_im_info,
 	.queuecommand = bfad_im_queuecommand,
 	.eh_abort_handler = bfad_im_abort_handler,
--- a/drivers/scsi/bnx2fc/bnx2fc_fcoe.c
+++ b/drivers/scsi/bnx2fc/bnx2fc_fcoe.c
@@ -2426,6 +2426,7 @@ static struct fc_function_template bnx2f
 static struct scsi_host_template bnx2fc_shost_template = {
 	.module			= THIS_MODULE,
 	.name			= "Broadcom Offload FCoE Initiator",
+	.proc_name		= KBUILD_MODNAME,
 	.queuecommand		= bnx2fc_queuecommand,
 	.eh_abort_handler	= bnx2fc_eh_abort,	  /* abts */
 	.eh_device_reset_handler = bnx2fc_eh_device_reset, /* lun reset */
--- a/drivers/scsi/esp_scsi.c
+++ b/drivers/scsi/esp_scsi.c
@@ -2613,6 +2613,7 @@ static const char *esp_info(struct Scsi_
 struct scsi_host_template scsi_esp_template = {
 	.module			= THIS_MODULE,
 	.name			= "esp",
+	.proc_name		= KBUILD_MODNAME,
 	.info			= esp_info,
 	.queuecommand		= esp_queuecommand,
 	.target_alloc		= esp_target_alloc,
--- a/drivers/scsi/fnic/fnic_main.c
+++ b/drivers/scsi/fnic/fnic_main.c
@@ -93,6 +93,7 @@ static int fnic_slave_alloc(struct scsi_
 static struct scsi_host_template fnic_host_template = {
 	.module = THIS_MODULE,
 	.name = DRV_NAME,
+	.proc_name		= KBUILD_MODNAME,
 	.queuecommand = fnic_queuecommand,
 	.eh_abort_handler = fnic_abort_cmd,
 	.eh_device_reset_handler = fnic_device_reset,
--- a/drivers/scsi/hosts.c
+++ b/drivers/scsi/hosts.c
@@ -335,6 +335,9 @@ struct Scsi_Host *scsi_host_alloc(struct
 	if (sht->unchecked_isa_dma && privsize)
 		gfp_mask |= __GFP_DMA;
 
+	/* Help mkinitrd to figure out the driver name */
+	WARN_ON(sht->proc_name == NULL);
+
 	shost = kzalloc(sizeof(struct Scsi_Host) + privsize, gfp_mask);
 	if (!shost)
 		return NULL;
--- a/drivers/scsi/lpfc/lpfc_scsi.c
+++ b/drivers/scsi/lpfc/lpfc_scsi.c
@@ -3872,6 +3872,7 @@ lpfc_slave_destroy(struct scsi_device *s
 struct scsi_host_template lpfc_template = {
 	.module			= THIS_MODULE,
 	.name			= LPFC_DRIVER_NAME,
+	.proc_name		= KBUILD_MODNAME,
 	.info			= lpfc_info,
 	.queuecommand		= lpfc_queuecommand,
 	.eh_abort_handler	= lpfc_abort_handler,
@@ -3895,6 +3896,7 @@ struct scsi_host_template lpfc_template
 struct scsi_host_template lpfc_vport_template = {
 	.module			= THIS_MODULE,
 	.name			= LPFC_DRIVER_NAME,
+	.proc_name		= KBUILD_MODNAME,
 	.info			= lpfc_info,
 	.queuecommand		= lpfc_queuecommand,
 	.eh_abort_handler	= lpfc_abort_handler,
--- a/drivers/scsi/mvsas/mv_init.c
+++ b/drivers/scsi/mvsas/mv_init.c
@@ -54,6 +54,7 @@ static const struct mvs_chip_info mvs_ch
 static struct scsi_host_template mvs_sht = {
 	.module			= THIS_MODULE,
 	.name			= DRV_NAME,
+	.proc_name		= KBUILD_MODNAME,
 	.queuecommand		= sas_queuecommand,
 	.target_alloc		= sas_target_alloc,
 	.slave_configure	= sas_slave_configure,
--- a/drivers/scsi/pm8001/pm8001_init.c
+++ b/drivers/scsi/pm8001/pm8001_init.c
@@ -59,6 +59,7 @@ struct workqueue_struct *pm8001_wq;
 static struct scsi_host_template pm8001_sht = {
 	.module			= THIS_MODULE,
 	.name			= DRV_NAME,
+	.proc_name		= KBUILD_MODNAME,
 	.queuecommand		= sas_queuecommand,
 	.target_alloc		= sas_target_alloc,
 	.slave_configure	= sas_slave_configure,
--- a/drivers/scsi/qla2xxx/qla_os.c
+++ b/drivers/scsi/qla2xxx/qla_os.c
@@ -199,6 +199,7 @@ static int qla2x00_change_queue_type(str
 struct scsi_host_template qla2xxx_driver_template = {
 	.module			= THIS_MODULE,
 	.name			= QLA2XXX_DRIVER_NAME,
+	.proc_name		= KBUILD_MODNAME,
 	.queuecommand		= qla2xxx_queuecommand,
 
 	.eh_abort_handler	= qla2xxx_eh_abort,
--- a/drivers/usb/storage/uas.c
+++ b/drivers/usb/storage/uas.c
@@ -557,6 +557,7 @@ static int uas_slave_configure(struct sc
 static struct scsi_host_template uas_host_template = {
 	.module = THIS_MODULE,
 	.name = "uas",
+	.proc_name		= KBUILD_MODNAME,
 	.queuecommand = uas_queuecommand,
 	.slave_alloc = uas_slave_alloc,
 	.slave_configure = uas_slave_configure,
