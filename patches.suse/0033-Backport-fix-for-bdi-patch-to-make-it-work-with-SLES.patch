From: Harsh Prateek Bora <harsh@linux.vnet.ibm.com>
Subject: [PATCH 033/111] Backport fix for bdi patch to make it work with SLES kernel.
Patch-Mainline: no
References: FATE#311639

make bdi code use available interfaces for bdi setup

Signed-off-by: Harsh Prateek Bora <harsh@linux.vnet.ibm.com>
Acked-by: Bruce Rogers <brogers@suse.com>
---
 fs/9p/v9fs.c |   17 +++++++++++++----
 1 files changed, 13 insertions(+), 4 deletions(-)

diff --git a/fs/9p/v9fs.c b/fs/9p/v9fs.c
index 3269c55..a7196af 100644
--- a/fs/9p/v9fs.c
+++ b/fs/9p/v9fs.c
@@ -38,6 +38,7 @@
 
 static DEFINE_SPINLOCK(v9fs_sessionlist_lock);
 static LIST_HEAD(v9fs_sessionlist);
+static atomic_t bdi_9p = ATOMIC_INIT(0);
 
 /*
  * Option Parsing (code inspired by NFS code)
@@ -237,11 +238,19 @@ struct p9_fid *v9fs_session_init(struct v9fs_session_info *v9ses,
 		return ERR_PTR(-ENOMEM);
 	}
 
-	rc = bdi_setup_and_register(&v9ses->bdi, "9p", BDI_CAP_MAP_COPY);
-	if (rc) {
-		__putname(v9ses->aname);
-		__putname(v9ses->uname);
+	v9ses->bdi.name = "9p";
+	v9ses->bdi.capabilities = BDI_CAP_MAP_COPY;
+	rc = bdi_init(&v9ses->bdi);
+	if (rc)
 		return ERR_PTR(rc);
+
+	rc = bdi_register(&v9ses->bdi, NULL, "9p-%d",
+				atomic_inc_return(&bdi_9p));
+	if (rc) {
+		bdi_destroy(&v9ses->bdi);
+                __putname(v9ses->aname);
+                __putname(v9ses->uname);
+                return ERR_PTR(rc);
 	}
 
 	spin_lock(&v9fs_sessionlist_lock);
-- 
1.7.1.1

