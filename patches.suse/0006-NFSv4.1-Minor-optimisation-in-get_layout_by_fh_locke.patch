From: Trond Myklebust <trond.myklebust@primarydata.com>
Date: Wed, 12 Feb 2014 08:17:00 -0500
Subject: [PATCH] NFSv4.1: Minor optimisation in get_layout_by_fh_locked()
Git-commit: 9a7fe9e8900baad5f6643000ea48b91aee895165
Patch-mainline: v3.15
References: bnc#898675

If the filehandles match, but the igrab() fails, or the layout is
freed before we can get it, then just return NULL.

Signed-off-by: Trond Myklebust <trond.myklebust@primarydata.com>
Acked-by: NeilBrown <neilb@suse.de>

---
 fs/nfs/callback_proc.c |    4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

--- linux-3.12-SLE12.orig/fs/nfs/callback_proc.c
+++ linux-3.12-SLE12/fs/nfs/callback_proc.c
@@ -127,13 +127,13 @@ static struct pnfs_layout_hdr * get_layo
 				continue;
 			ino = igrab(lo->plh_inode);
 			if (!ino)
-				continue;
+				break;
 			spin_lock(&ino->i_lock);
 			/* Is this layout in the process of being freed? */
 			if (NFS_I(ino)->layout != lo) {
 				spin_unlock(&ino->i_lock);
 				iput(ino);
-				continue;
+				break;
 			}
 			pnfs_get_layout_hdr(lo);
 			spin_unlock(&ino->i_lock);
