From: Matthew Garrett <matthew.garrett@nebula.com>
Subject: [PATCH V3 10/11] x86: Restrict MSR access when module loading is restricted
Date: Tue,  3 Sep 2013 19:50:17 -0400

Git-commit: Not yet
Patch-mainline: Not yet, fedora 20
References: fate#314486, bnc#884333
Target: SLE-11 SP3

Writing to MSRs should not be allowed if module loading is restricted,
since it could lead to execution of arbitrary code in kernel mode. Based
on a patch by Kees Cook.

Cc: Kees Cook <keescook@chromium.org>
Signed-off-by: Matthew Garrett <matthew.garrett@nebula.com>
Acked-by: Lee, Chun-Yi <jlee@suse.com>

---
 arch/x86/kernel/msr.c | 7 +++++++
 1 file changed, 7 insertions(+)

Index: linux-3.0-SLE11-SP3/arch/x86/kernel/msr.c
===================================================================
--- linux-3.0-SLE11-SP3.orig/arch/x86/kernel/msr.c
+++ linux-3.0-SLE11-SP3/arch/x86/kernel/msr.c
@@ -104,6 +104,9 @@ static ssize_t msr_write(struct file *fi
 	int err = 0;
 	ssize_t bytes = 0;
 
+	if (secure_modules())
+		return -EPERM;
+
 	if (count % 8)
 		return -EINVAL;	/* Invalid chunk size */
 
@@ -151,6 +154,10 @@ static long msr_ioctl(struct file *file,
 			err = -EBADF;
 			break;
 		}
+		if (secure_modules()) {
+			err = -EPERM;
+			break;
+		}
 		if (copy_from_user(&regs, uregs, sizeof regs)) {
 			err = -EFAULT;
 			break;
