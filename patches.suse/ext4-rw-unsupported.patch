From: Jan Kara <jack@suse.cz>
Subject: Make ext4 mounts read-only unless proper config option is specified
References: fate#311111
Patch-mainline: never

All ext4 mounts should be read-only to allow migration. We keep possibility
of read-write mounts when CONFIG_EXT4_FS_RW is defined so that we can easily
build unsupporeted KMP with full ext4 support.

Signed-off-by: Jan Kara <jack@suse.cz>

Index: linux-3.0-tmp-jikos/fs/ext4/super.c
===================================================================
--- linux-3.0-tmp-jikos.orig/fs/ext4/super.c
+++ linux-3.0-tmp-jikos/fs/ext4/super.c
@@ -3123,6 +3123,10 @@ static int ext4_fill_super(struct super_
 		goto cantfind_ext4;
 	sbi->s_kbytes_written = le64_to_cpu(es->s_kbytes_written);
 
+#ifndef CONFIG_EXT4_FS_RW
+	sb->s_flags |= MS_RDONLY;
+	ext4_msg(sb, KERN_INFO, "ext4 is supported in read-only mode only");
+#endif
 	/* Set defaults before we parse the mount options */
 	def_mount_opts = le32_to_cpu(es->s_default_mount_opts);
 	set_opt(sb, INIT_INODE_TABLE);
@@ -4312,6 +4316,14 @@ static int ext4_remount(struct super_blo
 	if (sbi->s_journal && sbi->s_journal->j_task->io_context)
 		journal_ioprio = sbi->s_journal->j_task->io_context->ioprio;
 
+#ifndef CONFIG_EXT4_FS_RW
+	if (!(*flags & MS_RDONLY)) {
+		*flags |= MS_RDONLY;
+		ext4_msg(sb, KERN_INFO,
+			 "ext4 is supported in read-only mode only");
+	}
+#endif
+
 	/*
 	 * Allow the "check" option to be passed as a remount option.
 	 */
