From: Wang Sheng-Hui <shhuiw@gmail.com>
Date: Fri, 6 Apr 2012 14:35:31 +0800
Patch-mainline: yes
References: FATE#306586
Git-commit: 39bab87ba6f4d8cce2b70c19e60233ad8030d7b4
Subject: [PATCH] Btrfs: fix btrfs_release_extent_buffer_page with the
 right usage of num_extent_pages

num_extent_pages returns the number of pages in the specific range, not
the index of the last page in the eb range.

btrfs_release_extent_buffer_page is called with start_idx set 0 in current
codes, so it's not a problem yet. But the logic is indeed wrong.

Fix it here.

Signed-off-by: Wang Sheng-Hui <shhuiw@gmail.com>
Signed-off-by: David Sterba <dsterba@suse.cz>
---
 fs/btrfs/extent_io.c |    3 +++
 1 file changed, 3 insertions(+)

--- a/fs/btrfs/extent_io.c
+++ b/fs/btrfs/extent_io.c
@@ -3679,12 +3679,15 @@ static void btrfs_release_extent_buffer_
 						unsigned long start_idx)
 {
 	unsigned long index;
+	unsigned long num_pages;
 	struct page *page;
 
 	if (!eb->first_page)
 		return;
 
 	index = num_extent_pages(eb->start, eb->len);
+	num_pages = num_extent_pages(eb->start, eb->len);
+	index = start_idx + num_pages;
 	if (start_idx >= index)
 		return;
 
