From: Takashi Iwai <tiwai@suse.de>
Subject: tmpfs: Fix kmap_atomic leak in shmem_read_mapping_page*()
Patch-mainline: Never (upstream fixed differently)
References: bnc#744392

In our kernel, a few tmpfs patches have been backported from 3.1 kernel.
One of them, patches.suse/tmpfs-simplify-prealloc_page.patch, introduced
a new error path, but it lacks of unmapping of kmap_atomic page.  This
leads to the preempt_count unbalance, and eventually hits the "scheduling-
while-atomic" errors and crash with drm/i915 driver under high memory
pressure, as i915 driver is using tmpfs backend intensively.

Unfortunately (or fortunately), the upstream takes more patches and they
removed the problematic code already in 3.1 kernel.  So, this fix is
necessary only for SP2 kernel.

Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
 mm/shmem.c |    1 +
 1 file changed, 1 insertion(+)

--- a/mm/shmem.c
+++ b/mm/shmem.c
@@ -1484,6 +1484,7 @@
 			set_page_dirty(page);
 
 	} else {
+		shmem_swp_unmap(entry);
 		spin_unlock(&info->lock);
 		error = -ENOMEM;
 		goto out;
