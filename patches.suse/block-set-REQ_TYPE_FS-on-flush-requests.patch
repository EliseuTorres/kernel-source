From: FUJITA Tomonori <fujita.tomonori@lab.ntt.co.jp>
Date: Fri, 9 Jul 2010 09:38:24 +0900
Subject: [PATCH] block: set REQ_TYPE_FS on flush requests
X-Git: 28e18d0188b9e3ab82ebd09d9b1d1c7f8d1822aa
References: FATE#311692
Patch-Mainline: 2.6.34

the block layer doesn't set rq->cmd_type on flush requests. By
definition, it should be REQ_TYPE_FS (the lower layers build a command
and interpret the result of it, that is, the block layer doesn't know
the details).

Signed-off-by: FUJITA Tomonori <fujita.tomonori@lab.ntt.co.jp>
Signed-off-by: Jens Axboe <jaxboe@fusionio.com>
Signed-off-by: Hannes Reinecke <hare@suse.de>
---
 block/blk-barrier.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

diff --git a/block/blk-barrier.c b/block/blk-barrier.c
index 1d2f86e..0bb46fe 100644
--- a/block/blk-barrier.c
+++ b/block/blk-barrier.c
@@ -133,6 +133,7 @@ static void queue_flush(struct request_queue *q, unsigned which)
 	}
 
 	blk_rq_init(q, rq);
+	rq->cmd_type = REQ_TYPE_FS;
 	rq->cmd_flags = REQ_HARDBARRIER | REQ_FLUSH;
 	rq->rq_disk = q->bar_rq.rq_disk;
 	rq->end_io = end_io;
-- 
1.6.0.2

