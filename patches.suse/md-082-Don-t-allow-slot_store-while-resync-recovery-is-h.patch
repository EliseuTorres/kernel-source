From c6751b2bde477f56ceef67aa1d298ce44e8e2e23 Mon Sep 17 00:00:00 2001
From: NeilBrown <neilb@suse.de>
Date: Wed, 2 Feb 2011 11:57:13 +1100
Subject: [PATCH] md: Don't allow slot_store while resync/recovery is happening.
Git-commit: c6751b2bde477f56ceef67aa1d298ce44e8e2e23
Patch-mainline: v2.6.38-rc7

Activating a spare in an array while resync/recovery is already
happening can lead the that spare being marked in-sync when it isn't
really.
So don't allow the 'slot' to be set (this activating the device)
while resync/recovery is happening.

Signed-off-by: NeilBrown <neilb@suse.de>
---
 drivers/md/md.c |    3 +++
 1 file changed, 3 insertions(+)

--- linux-2.6.32-SLE11-SP1.orig/drivers/md/md.c
+++ linux-2.6.32-SLE11-SP1/drivers/md/md.c
@@ -2478,6 +2478,9 @@ slot_store(mdk_rdev_t *rdev, const char
 		if (rdev->raid_disk != -1)
 			return -EBUSY;
 
+		if (test_bit(MD_RECOVERY_RUNNING, &rdev->mddev->recovery))
+			return -EBUSY;
+
 		if (rdev->mddev->pers->hot_add_disk == NULL)
 			return -EINVAL;
 

