From: David Sterba <dsterba@suse.cz>
Patch-mainline: never
References: FATE#306586
Subject: [PATCH] Btrfs: fix DIO locking type

Btrfs locks buffered and unbuffered writes on it's own and this is done by
passing DIO_OWN_LOCKING to DIO code,

Passing 0 caused a deadlock in xfstests/133 as the __blockdev_direct_IO call
was called under i_mutex.

Signed-off-by: David Sterba <dsterba@suse.cz>
---

--- linux-2.6/fs/btrfs/inode.c	2011-06-29 16:32:53.000000000 +0200
+++ linux-2.6/fs/btrfs/inode.c	2011-06-30 14:51:25.000000000 +0200
@@ -6211,7 +6211,7 @@
 	ret = __blockdev_direct_IO(rw, iocb, inode,
 		   BTRFS_I(inode)->root->fs_info->fs_devices->latest_bdev,
 		   iov, offset, nr_segs, btrfs_get_blocks_direct, NULL,
-		   btrfs_submit_direct, 0);
+		   btrfs_submit_direct, DIO_OWN_LOCKING);
 
 	if (ret < 0 && ret != -EIOCBQUEUED) {
 		clear_extent_bit(&BTRFS_I(inode)->io_tree, offset,
