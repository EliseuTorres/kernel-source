From: Hannes Reinecke <hare@suse.de>
Subject: Tape driver gets a rewind during boot
Reference: bnc#629552
Patch-Mainline: Not yet

During reboot any attached device are being send a reset,
which causes tape drives to reboot.
This patch adds a new module parameter "ql2xtargetreset"
which allows the user to inhibit this behaviour.

Signed-off-by: Hannes Reinecke <hare@suse.de>

diff --git a/drivers/scsi/qla2xxx/qla_os.c b/drivers/scsi/qla2xxx/qla_os.c
index c16a861..a6b1bd0 100644
--- a/drivers/scsi/qla2xxx/qla_os.c
+++ b/drivers/scsi/qla2xxx/qla_os.c
@@ -121,6 +121,12 @@ MODULE_PARM_DESC(ql2xasyncenable,
 		"Enables usage of Async-login/adisc on ISP23xx."
 		"Default is 0 - use serialized mailbox commands.");
 
+int ql2xtargetreset = 1;
+module_param(ql2xtargetreset, int, S_IRUGO|S_IRUSR);
+MODULE_PARM_DESC(ql2xtargetreset,
+		 "Enable target reset."
+		 "Default is 1 - use hw defaults.");
+
 /*
  * SCSI host template entry points
  */
@@ -1131,7 +1137,7 @@ qla2x00_loop_reset(scsi_qla_host_t *vha)
 	struct fc_port *fcport;
 	struct qla_hw_data *ha = vha->hw;
 
-	if (ha->flags.enable_target_reset) {
+	if (ql2xtargetreset == 1 && ha->flags.enable_target_reset) {
 		list_for_each_entry(fcport, &vha->vp_fcports, list) {
 			if (fcport->port_type != FCT_TARGET)
 				continue;
