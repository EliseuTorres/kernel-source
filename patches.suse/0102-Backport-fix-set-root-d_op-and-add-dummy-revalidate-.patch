From: Harsh Prateek Bora <harsh@linux.vnet.ibm.com>
Subject: [PATCH 102/111] Backport fix: set root->d_op and add dummy revalidate func
Patch-Mainline: no
References: FATE#311639

Signed-off-by: Harsh Prateek Bora <harsh@linux.vnet.ibm.com>
Acked-by: Bruce Rogers <brogers@suse.com>
---
 fs/9p/vfs_dentry.c |    6 ++++++
 fs/9p/vfs_super.c  |    8 ++++++++
 2 files changed, 14 insertions(+), 0 deletions(-)

diff --git a/fs/9p/vfs_dentry.c b/fs/9p/vfs_dentry.c
index d743252..683619f 100644
--- a/fs/9p/vfs_dentry.c
+++ b/fs/9p/vfs_dentry.c
@@ -104,12 +104,18 @@ void v9fs_dentry_release(struct dentry *dentry)
 	}
 }
 
+static int v9fs_dummy_revalidate(struct dentry *dentry, struct nameidata *nd)
+{
+	return 1;
+}
+
 const struct dentry_operations v9fs_cached_dentry_operations = {
 	.d_delete = v9fs_cached_dentry_delete,
 	.d_release = v9fs_dentry_release,
 };
 
 const struct dentry_operations v9fs_dentry_operations = {
+	.d_revalidate = v9fs_dummy_revalidate,
 	.d_delete = v9fs_dentry_delete,
 	.d_release = v9fs_dentry_release,
 };
diff --git a/fs/9p/vfs_super.c b/fs/9p/vfs_super.c
index 2bf8339..1703fd1 100644
--- a/fs/9p/vfs_super.c
+++ b/fs/9p/vfs_super.c
@@ -174,6 +174,14 @@ static int v9fs_get_sb(struct file_system_type *fs_type, int flags,
 	}
 
 	v9fs_fid_add(root, fid);
+	/*
+	* root dentry doesn't have d_op set. d_op
+	* get set via lookup/create. 
+	*/
+	if (v9ses->cache)
+		root->d_op = &v9fs_cached_dentry_operations;
+	else
+		root->d_op = &v9fs_dentry_operations;
 
 	P9_DPRINTK(P9_DEBUG_VFS, " simple set mount, return 0\n");
 	simple_set_mnt(mnt, sb);
-- 
1.7.1.1

