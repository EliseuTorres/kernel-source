From 4096a6e7af44bf8f36dac35b0c0455ea79dc08e7 Mon Sep 17 00:00:00 2001
From: Waiman Long <Waiman.Long@hp.com>
Date: Wed, 14 May 2014 14:14:13 -0400
Subject: [PATCH 11/17] prepend_path() needs to reinitialize dentry/vfsmount on restarts
References: FATE#317271
Git-commit: ede4cebce16f5643c61aedd6d88d9070a1d23a68
Patch-mainline: v3.13-rc1

This patch fixes a bug in the new prepend_path() code. It is based
on the following upstream patch:

 ede4cebce16f5643c61aedd6d88d9070a1d23a68
 prepend_path() needs to reinitialize dentry/vfsmount/mnt on restarts

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Waiman Long <Waiman.Long@hp.com>
Acked-by: Jeff Mahoney <jeffm@suse.com>
---
 fs/dcache.c |    6 ++++--
 1 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/fs/dcache.c b/fs/dcache.c
index c119e60..7cdca33 100644
--- a/fs/dcache.c
+++ b/fs/dcache.c
@@ -2654,8 +2654,8 @@ static int prepend_path(const struct path *path,
 			const struct path *root,
 			char **buffer, int *buflen)
 {
-	struct dentry *dentry = path->dentry;
-	struct vfsmount *vfsmnt = path->mnt;
+	struct dentry *dentry;
+	struct vfsmount *vfsmnt;
 	int error = 0;
 	unsigned seq = 0;
 	char *bptr;
@@ -2665,6 +2665,8 @@ static int prepend_path(const struct path *path,
 restart:
 	bptr = *buffer;
 	blen = *buflen;
+	dentry = path->dentry;
+	vfsmnt = path->mnt;
 	read_seqbegin_or_lock(&rename_lock, &seq);
 	while (dentry != root->dentry || vfsmnt != root->mnt) {
 		struct dentry * parent;
-- 
1.7.1

