From: Christoph Hellwig <hch@infradead.org>
Date: Wed, 18 Aug 2010 05:29:15 -0400
Subject: [PATCH] nilfs2: replace barriers with explicit flush / FUA usage
Git-commit: f8c131f5b6ffc899a70b30e541f367d47f89691c
References: FATE#311692
Patch-Mainline: 2.6.34

Switch to the WRITE_FLUSH_FUA flag for log writes, remove the EOPNOTSUPP
detection for barriers and stop setting the barrier flag for discards.

Signed-off-by: Christoph Hellwig <hch@lst.de>
Acked-by: Ryusuke Konishi <konishi.ryusuke@lab.ntt.co.jp>
Signed-off-by: Tejun Heo <tj@kernel.org>
Signed-off-by: Jens Axboe <jaxboe@fusionio.com>
Signed-off-by: Hannes Reinecke <hare@suse.de>
---
 fs/nilfs2/super.c |   10 +---------
 1 files changed, 1 insertions(+), 9 deletions(-)

diff --git a/fs/nilfs2/super.c b/fs/nilfs2/super.c
index b099520..2954bfc 100644
--- a/fs/nilfs2/super.c
+++ b/fs/nilfs2/super.c
@@ -210,17 +210,9 @@ static int nilfs_sync_super(struct nilfs_sb_info *sbi, int dupsb)
 
  retry:
 	set_buffer_dirty(nilfs->ns_sbh[0]);
-
 	if (nilfs_test_opt(sbi, BARRIER)) {
 		err = __sync_dirty_buffer(nilfs->ns_sbh[0],
-					  WRITE_SYNC | WRITE_BARRIER);
-		if (err == -EOPNOTSUPP) {
-			nilfs_warning(sbi->s_super, __func__,
-				      "barrier-based sync failed. "
-				      "disabling barriers\n");
-			nilfs_clear_opt(sbi, BARRIER);
-			goto retry;
-		}
+					  WRITE_SYNC | WRITE_FLUSH_FUA);
 	} else {
 		err = sync_dirty_buffer(nilfs->ns_sbh[0]);
 	}
-- 
1.6.0.2

