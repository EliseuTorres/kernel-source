From: Tsutomu Itoh <t-itoh@jp.fujitsu.com>
Date: Thu, 1 Dec 2011 19:09:43 +0900
Patch-mainline: pending
References: FATE#306586
Subject: [PATCH] Btrfs: forced readonly when free_log_tree fails

The filesystem turns to readonly instead of BUG_ON() when
free_log_tree fails.

Signed-off-by: Tsutomu Itoh <t-itoh@jp.fujitsu.com>
Signed-off-by: David Sterba <dsterba@suse.cz>
---
 fs/btrfs/tree-log.c |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/fs/btrfs/tree-log.c b/fs/btrfs/tree-log.c
index e21451d..3ec8626 100644
--- a/fs/btrfs/tree-log.c
+++ b/fs/btrfs/tree-log.c
@@ -2171,7 +2171,10 @@ static void free_log_tree(struct btrfs_trans_handle *trans,
 	};
 
 	ret = walk_log_tree(trans, log, &wc);
-	BUG_ON(ret);
+	if (ret) {
+		btrfs_std_error(log->fs_info, ret);
+		return;
+	}
 
 	while (1) {
 		ret = find_first_extent_bit(&log->dirty_log_pages,
-- 
1.7.6.233.gd79bc

