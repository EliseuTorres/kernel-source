From: Mel Gorman <mgorman@suse.de>
Date: Thu, 26 Jan 2012 15:42:28 +0000
Subject: [PATCH] netvm: Propagate page->pfmemalloc from netdev_alloc_page to skb
References: Swap over NFS (fate#304949, bnc#743518)
Patch-mainline: Not yet, merging efforts ongoing

__netdev_alloc_page is not checking if a page was successfully allocated
before deferencing it.

Signed-off-by: Luciano Chavez <lnx1138@linux.vnet.ibm.com>
Signed-off-by: Mel Gorman <mgorman@suse.de>
---
 include/linux/skbuff.h |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/include/linux/skbuff.h b/include/linux/skbuff.h
index 0d8219d..a6e22b4 100644
--- a/include/linux/skbuff.h
+++ b/include/linux/skbuff.h
@@ -1617,7 +1617,7 @@ static inline struct page *__netdev_alloc_page(struct net_device *dev,
 		gfp_mask |= __GFP_MEMALLOC;
 
 	page = alloc_pages_node(NUMA_NO_NODE, gfp_mask, 0);
-	if (skb && page->pfmemalloc)
+	if (skb && page && page->pfmemalloc)
 		skb->pfmemalloc = true;
 
 	return page;
