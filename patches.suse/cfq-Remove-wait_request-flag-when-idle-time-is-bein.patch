From: Gui Jianfeng <guijianfeng@cn.fujitsu.com>
Date: Thu, 10 Dec 2009 09:38:39 +0100
Subject: [PATCH] cfq: Remove wait_request flag when idle time is being deleted
Git-commit: 554554f60ad619e1efab01897208bc320b81d9da
References: FATE#311054
Patch-Mainline: 2.6.33

Remove wait_request flag when idle time is being deleted, otherwise
it'll hit this path every time when a request is enqueued.

Signed-off-by: Gui Jianfeng <guijianfeng@cn.fujitsu.com>
Signed-off-by: Jens Axboe <jens.axboe@oracle.com>
Signed-off-by: Hannes Reinecke <hare@suse.de>
---
 block/cfq-iosched.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

diff --git a/block/cfq-iosched.c b/block/cfq-iosched.c
index 1b86d04..ce92251 100644
--- a/block/cfq-iosched.c
+++ b/block/cfq-iosched.c
@@ -3204,6 +3204,7 @@ cfq_rq_enqueued(struct cfq_data *cfqd, struct cfq_queue *cfqq,
 			if (blk_rq_bytes(rq) > PAGE_CACHE_SIZE ||
 			    cfqd->busy_queues > 1) {
 				del_timer(&cfqd->idle_slice_timer);
+				cfq_clear_cfqq_wait_request(cfqq);
 				__blk_run_queue(cfqd->queue);
 			} else
 				cfq_mark_cfqq_must_dispatch(cfqq);
-- 
1.6.0.2

