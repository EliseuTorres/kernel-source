From: Dan Williams <dan.j.williams@intel.com>
Date: Mon, 21 Dec 2009 18:18:36 -0700
Subject: [PATCH] md: make recovery started by do_md_run() visible via sync_action
X-Git: a2d79c324ac0c26ae9995a312a7731067a7f01fc
References: FATE#311054
Patch-Mainline: 2.6.33

By default md_do_sync() will perform recovery if no other actions are
specified.  However, action_show() relies on MD_RECOVERY_RECOVER to be
set otherwise it returns 'idle'.  So, add a missing set
MD_RECOVERY_RECOVER when starting recovery.

Signed-off-by: Dan Williams <dan.j.williams@intel.com>
Signed-off-by: NeilBrown <neilb@suse.de>
Signed-off-by: Hannes Reinecke <hare@suse.de>
---
 drivers/md/md.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

diff --git a/drivers/md/md.c b/drivers/md/md.c
index 0a3e04d..f7d743f 100644
--- a/drivers/md/md.c
+++ b/drivers/md/md.c
@@ -4609,6 +4609,7 @@ static int do_md_run(mddev_t * mddev)
 		if (spares && mddev->pers->sync_request) {
 			mddev->recovery = 0;
 			set_bit(MD_RECOVERY_RUNNING, &mddev->recovery);
+			set_bit(MD_RECOVERY_RECOVER, &mddev->recovery);
 			mddev->sync_thread = md_register_thread(md_do_sync,
 								mddev,
 								"resync");
-- 
1.6.0.2

