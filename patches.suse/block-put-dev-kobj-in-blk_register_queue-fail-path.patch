From: Xiaotian Feng <dfeng@redhat.com>
Date: Mon, 23 Aug 2010 12:30:29 +0200
Subject: [PATCH] block: put dev->kobj in blk_register_queue fail path
X-Git: c87ffbb812cf6150097a5095b031f4013a8f78a5
References: FATE#311692
Patch-Mainline: 2.6.34

kernel needs to kobject_put on dev->kobj if elv_register_queue fails.

Signed-off-by: Xiaotian Feng <dfeng@redhat.com>
Cc: "Martin K. Petersen" <martin.petersen@oracle.com>
Cc: Stephen Hemminger <shemminger@vyatta.com>
Cc: Nikanth Karthikesan <knikanth@suse.de>
Cc: David Teigland <teigland@redhat.com>
Signed-off-by: Jens Axboe <jaxboe@fusionio.com>
Signed-off-by: Hannes Reinecke <hare@suse.de>
---
 block/blk-sysfs.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

diff --git a/block/blk-sysfs.c b/block/blk-sysfs.c
index 051f708..e1da26c 100644
--- a/block/blk-sysfs.c
+++ b/block/blk-sysfs.c
@@ -512,6 +512,7 @@ int blk_register_queue(struct gendisk *disk)
 		kobject_uevent(&q->kobj, KOBJ_REMOVE);
 		kobject_del(&q->kobj);
 		blk_trace_remove_sysfs(disk_to_dev(disk));
+		kobject_put(&dev->kobj);
 		return ret;
 	}
 
-- 
1.6.0.2

