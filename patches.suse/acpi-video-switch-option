From: Takashi Iwai <tiwai@suse.de>
Subject: [PATCH] ACPI video: Add video_switch_key option
Patch-mainline: Submitted
References: bnc#647567

Some HP laptops send ACPI video events per lid open/close, and the
ACPI video driver translates to SWITCHVIDEOMODE input key events.
This behavior confuses the user-space daemon such as
gnome-settings-daemon since it changes the video mode per this key,
which results in a different video mode at each time you open/close
the laptop lid.  Fn-Fx keys are handled differently on such hardware,
thus this key generation is simply superfluous.

This patch adds a module parameter "video_switch_key" to either
assign a different key code for this ACPI event or disable by setting
zero there.

Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
 drivers/acpi/video.c |   11 +++++++----
 1 file changed, 7 insertions(+), 4 deletions(-)

--- a/drivers/acpi/video.c
+++ b/drivers/acpi/video.c
@@ -72,6 +72,8 @@
 
 static int brightness_switch_enabled = 1;
 module_param(brightness_switch_enabled, bool, 0644);
+static int video_switch_key = KEY_SWITCHVIDEOMODE;
+module_param(video_switch_key, int, 0644);
 
 /*
  * By default, we don't allow duplicate ACPI video bus devices
@@ -1445,7 +1447,7 @@
 	case ACPI_VIDEO_NOTIFY_SWITCH:	/* User requested a switch,
 					 * most likely via hotkey. */
 		acpi_bus_generate_proc_event(device, event, 0);
-		keycode = KEY_SWITCHVIDEOMODE;
+		keycode = video_switch_key;
 		break;
 
 	case ACPI_VIDEO_NOTIFY_PROBE:	/* User plugged in or removed a video
@@ -1453,12 +1455,12 @@
 		acpi_video_device_enumerate(video);
 		acpi_video_device_rebind(video);
 		acpi_bus_generate_proc_event(device, event, 0);
-		keycode = KEY_SWITCHVIDEOMODE;
+		keycode = video_switch_key;
 		break;
 
 	case ACPI_VIDEO_NOTIFY_CYCLE:	/* Cycle Display output hotkey pressed. */
 		acpi_bus_generate_proc_event(device, event, 0);
-		keycode = KEY_SWITCHVIDEOMODE;
+		keycode = video_switch_key;
 		break;
 	case ACPI_VIDEO_NOTIFY_NEXT_OUTPUT:	/* Next Display output hotkey pressed. */
 		acpi_bus_generate_proc_event(device, event, 0);
@@ -1670,7 +1672,8 @@
 	input->id.product = 0x06;
 	input->dev.parent = &device->dev;
 	input->evbit[0] = BIT(EV_KEY);
-	set_bit(KEY_SWITCHVIDEOMODE, input->keybit);
+	if (video_switch_key && video_switch_key < KEY_CNT)
+		set_bit(KEY_SWITCHVIDEOMODE, input->keybit);
 	set_bit(KEY_VIDEO_NEXT, input->keybit);
 	set_bit(KEY_VIDEO_PREV, input->keybit);
 	set_bit(KEY_BRIGHTNESS_CYCLE, input->keybit);
