From: Chris Mason <chris.mason@oracle.com>
Date: Thu, 26 May 2011 17:43:59 -0400
Patch-mainline: yes
References: FATE#306586
Subject: [PATCH] Btrfs: return -ENOMEM in clear_extent_bit

The btrfs releasepage function depends on ENOMEM coming
back when it is called atomic.

Signed-off-by: Chris Mason <chris.mason@oracle.com>
Signed-off-by: David Sterba <dsterba@suse.cz>
---
 fs/btrfs/extent_io.c |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

Index: linux-2.6.32-SLE11-SP2/fs/btrfs/extent_io.c
===================================================================
--- linux-2.6.32-SLE11-SP2.orig/fs/btrfs/extent_io.c
+++ linux-2.6.32-SLE11-SP2/fs/btrfs/extent_io.c
@@ -487,7 +487,8 @@ int clear_extent_bit(struct extent_io_tr
 again:
 	if (!prealloc && (mask & __GFP_WAIT)) {
 		prealloc = alloc_extent_state(mask);
-		BUG_ON(!prealloc);
+		if (!prealloc)
+			return -ENOMEM;
 	}
 
 	spin_lock(&tree->lock);
