From: Tony Jones <tonyj@suse.de>
Subject: Ignore selected taints for tracepoint modules
Git-commit: c10076c4304083af15a41f6bc5e657e781c1f9a6
Patch-mainline: v3.3-rc1
References: bnc#870450, FATE#317134

Signed-off-by: Tony Jones <tonyj@suse.de>

- Backport of mainline commit c10076c4 adjusted to the different SP3 codebase.  
- Also fold in parts of later commit 45ab2813 to centralize definitions of 
  valid taints in one location.
- Also adds local ENTERPRISE taint flags.

---
 include/linux/tracepoint.h |    4 ++++
 kernel/module.c            |    4 ++--
 kernel/tracepoint.c        |    9 +++++++++
 3 files changed, 15 insertions(+), 2 deletions(-)

--- a/kernel/module.c
+++ b/kernel/module.c
@@ -3650,7 +3650,7 @@ void module_update_tracepoints(void)
 
 	mutex_lock(&module_mutex);
 	list_for_each_entry(mod, &modules, list)
-		if (!mod->taints)
+		if (!trace_module_has_bad_taint(mod))
 			tracepoint_update_probe_range(mod->tracepoints_ptrs,
 				mod->tracepoints_ptrs + mod->num_tracepoints);
 	mutex_unlock(&module_mutex);
@@ -3667,7 +3667,7 @@ int module_get_iter_tracepoints(struct t
 
 	mutex_lock(&module_mutex);
 	list_for_each_entry(iter_mod, &modules, list) {
-		if (!iter_mod->taints) {
+		if (!trace_module_has_bad_taint(iter_mod)) {
 			/*
 			 * Sorted module list
 			 */
--- a/include/linux/tracepoint.h
+++ b/include/linux/tracepoint.h
@@ -54,6 +54,10 @@ extern int tracepoint_probe_unregister_n
 						void *data);
 extern void tracepoint_probe_update_all(void);
 
+#ifdef CONFIG_MODULES
+bool trace_module_has_bad_taint(struct module *mod);
+#endif
+
 struct tracepoint_iter {
 	struct module *module;
 	struct tracepoint * const *tracepoint;
--- a/kernel/tracepoint.c
+++ b/kernel/tracepoint.c
@@ -572,6 +572,15 @@ void tracepoint_iter_reset(struct tracep
 EXPORT_SYMBOL_GPL(tracepoint_iter_reset);
 
 #ifdef CONFIG_MODULES
+bool trace_module_has_bad_taint(struct module *mod)
+{
+	return mod->taints & ~((1 << TAINT_CRAP) | (1 << TAINT_UNSIGNED_MODULE)
+#ifdef CONFIG_ENTERPRISE_SUPPORT
+			     | (1 << TAINT_EXTERNAL_SUPPORT)
+			     | (1 << TAINT_NO_SUPPORT)
+#endif
+			     );
+}
 
 int tracepoint_module_notify(struct notifier_block *self,
 			     unsigned long val, void *data)
