From: Al Viro <viro@zeniv.linux.org.uk>
Date: Thu, 17 Nov 2011 01:40:05 -0500
Patch-mainline: 3.3
Git-commit: be7e0950def403e90b5295ff2192c39967bf2aec
Subject: [PATCH] btrfs: merge free_fs_info() calls on fill_super
 failures

... all the way up into btrfs_mount().

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: David Sterba <dsterba@suse.cz>
---
 fs/btrfs/disk-io.c |    2 --
 fs/btrfs/super.c   |    2 +-
 2 files changed, 1 insertion(+), 3 deletions(-)

--- a/fs/btrfs/disk-io.c
+++ b/fs/btrfs/disk-io.c
@@ -2445,7 +2445,6 @@ retry_root_backup:
 
 		if (err) {
 			close_ctree(tree_root);
-			free_fs_info(fs_info);
 			return err;
 		}
 	}
@@ -2496,7 +2495,6 @@ fail_srcu:
 	cleanup_srcu_struct(&fs_info->subvol_srcu);
 fail:
 	btrfs_close_devices(fs_info->fs_devices);
-	free_fs_info(fs_info);
 	return err;
 
 recovery_tree_root:
--- a/fs/btrfs/super.c
+++ b/fs/btrfs/super.c
@@ -640,7 +640,6 @@ static int btrfs_fill_super(struct super
 
 fail_close:
 	close_ctree(tree_root);
-	free_fs_info(fs_info);
 	return err;
 }
 
@@ -980,6 +979,7 @@ static struct dentry *btrfs_mount(struct
 		error = btrfs_fill_super(s, fs_devices, data,
 					 flags & MS_SILENT ? 1 : 0);
 		if (error) {
+			free_fs_info(fs_info);
 			deactivate_locked_super(s);
 			return ERR_PTR(error);
 		}
