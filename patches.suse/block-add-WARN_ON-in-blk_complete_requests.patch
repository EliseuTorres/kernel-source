From: Hannes Reinecke <hare@suse.de>
Date: Fri, 3 Feb 2012 11:03:49 +0100
Subject: block: Add WARN_ON in blk_complete_request()
References: bnc#738284
Patch-Mainline: n/a

We've had reports that a race condition exists which causes
completions to be triggered for requests which haven't been
started. So far we haven't been able to reproduce this with
the latest kernels, but we should be insert a WARN_ON()
to trigger a stack trace if this issue occurs again.

Signed-off-by: Hannes Reinecke <hare@suse.de>

diff --git a/block/blk-softirq.c b/block/blk-softirq.c
index ee9c216..89a68a3 100644
--- a/block/blk-softirq.c
+++ b/block/blk-softirq.c
@@ -156,6 +156,7 @@ void blk_complete_request(struct request *req)
 {
 	if (unlikely(blk_should_fake_timeout(req->q)))
 		return;
+	WARN_ON(!(req->cmd_flags & REQ_STARTED));
 	if (!blk_mark_rq_complete(req))
 		__blk_complete_request(req);
 }
