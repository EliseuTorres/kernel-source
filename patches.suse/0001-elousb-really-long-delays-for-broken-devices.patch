From 9786d996e92d6074d5766f6f5d287a3ffa594f94 Mon Sep 17 00:00:00 2001
From: Oliver Neukum <oneukum@suse.de>
Date: Tue, 29 Jan 2013 17:05:51 +0100
Subject: [PATCH] elousb: really long delays for broken devices
Git-Commit: 9786d996e92d6074d5766f6f5d287a3ffa594f94
Patch-Mainline: Never, this is for a driver which we don't push upstream
References: bnc#795269

A batch of those compound devices has a broken firmware that really
needs long delays. As the driver won't go upstream, we can use
a brute force approach.
As we've been promised an update of the firmware, this patch
should be dropped for SLE12.

Signed-off-by: Oliver Neukum <oneukum@suse.de>
---
 drivers/usb/core/message.c |    4 ++++
 drivers/usb/core/quirks.c  |    6 ++++++
 include/linux/usb/quirks.h |    3 +++
 3 files changed, 13 insertions(+)

--- a/drivers/usb/core/message.c
+++ b/drivers/usb/core/message.c
@@ -46,10 +46,12 @@ static int usb_start_wait_urb(struct urb
 	struct api_context ctx;
 	unsigned long expire;
 	int retval;
+	struct usb_device *udev;
 
 	init_completion(&ctx.done);
 	urb->context = &ctx;
 	urb->actual_length = 0;
+	udev = urb->dev;
 	retval = usb_submit_urb(urb, GFP_NOIO);
 	if (unlikely(retval))
 		goto out;
@@ -73,6 +75,8 @@ out:
 		*actual_length = urb->actual_length;
 
 	usb_free_urb(urb);
+	if (udev->quirks & USB_QUIRK_LONG_DELAYS)
+		mdelay(20);
 	return retval;
 }
 
--- a/drivers/usb/core/quirks.c
+++ b/drivers/usb/core/quirks.c
@@ -92,6 +92,9 @@ static const struct usb_device_id usb_qu
 	/* Philips PSC805 audio device */
 	{ USB_DEVICE(0x0471, 0x0155), .driver_info = USB_QUIRK_RESET_RESUME },
 
+	/* IBM Retail USB 4820 Liquid Crystal Display with MSR(3-trck) */
+	{ USB_DEVICE(0x04b3, 0x4871), .driver_info = USB_QUIRK_LONG_DELAYS },
+
 	/* Artisman Watchdog Dongle */
 	{ USB_DEVICE(0x04b4, 0x0526), .driver_info =
 			USB_QUIRK_CONFIG_INTF_STRINGS },
@@ -106,6 +109,9 @@ static const struct usb_device_id usb_qu
 	/* CarrolTouch 4500U */
 	{ USB_DEVICE(0x04e7, 0x0030), .driver_info = USB_QUIRK_RESET_RESUME },
 
+        /* Elo TouchSystems 4500U CarrollTouch */
+        { USB_DEVICE(0x04e7, 0x0030), .driver_info = USB_QUIRK_LONG_DELAYS },
+
 	/* Samsung Android phone modem - ID conflict with SPH-I500 */
 	{ USB_DEVICE(0x04e8, 0x6601), .driver_info =
 			USB_QUIRK_CONFIG_INTF_STRINGS },
--- a/include/linux/usb/quirks.h
+++ b/include/linux/usb/quirks.h
@@ -30,4 +30,7 @@
    descriptor */
 #define USB_QUIRK_DELAY_INIT		0x00000040
 
+/* truely broken firmware needs to be talked to really slowly */
+#define USB_QUIRK_LONG_DELAYS		0x0000800
+
 #endif /* __LINUX_USB_QUIRKS_H */
