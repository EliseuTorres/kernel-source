From: Andrea Arcangeli <aarcange@redhat.com>
Date: Thu, 13 Jan 2011 15:47:16 -0800
Subject: [PATCH] thp: compound_trans_order
References: THP + memcg (fate #311931)
Git-commit: 37c2ac7872a9387542616f658d20ac25f5bdb32e
Patch-mainline: v2.6.38-rc1

Read compound_trans_order safe. Noop for CONFIG_TRANSPARENT_HUGEPAGE=n.

Signed-off-by: Andrea Arcangeli <aarcange@redhat.com>
Cc: Daisuke Nishimura <nishimura@mxp.nes.nec.co.jp>
Cc: KAMEZAWA Hiroyuki <kamezawa.hiroyu@jp.fujitsu.com>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Mel Gorman <mgorman@suse.de>
---
 include/linux/mm.h |   14 ++++++++++++++
 mm/memcontrol.c    |   12 ++++++------
 2 files changed, 20 insertions(+), 6 deletions(-)

Index: linux-2.6.32-thp/include/linux/mm.h
===================================================================
--- linux-2.6.32-thp.orig/include/linux/mm.h
+++ linux-2.6.32-thp/include/linux/mm.h
@@ -448,6 +448,20 @@ static inline int compound_order(struct
 	return (unsigned long)page[1].lru.prev;
 }
 
+static inline int compound_trans_order(struct page *page)
+{
+	int order;
+	unsigned long flags;
+
+	if (!PageHead(page))
+		return 0;
+
+	flags = compound_lock_irqsave(page);
+	order = compound_order(page);
+	compound_unlock_irqrestore(page, flags);
+	return order;
+}
+
 static inline void set_compound_order(struct page *page, unsigned long order)
 {
 	page[1].lru.prev = (void *)order;

