Git-commit: 237074c0a30ac017faaf5c3dfab01aff0c6bb03a
From: Joe Thornber <ejt@redhat.com>
Date: Fri, 27 Jul 2012 15:08:13 +0100
Subject: [PATCH] dm thin metadata: move __superblock_all_zeroes to
 __open_or_format_metadata
Patch-mainline: v3.6-rc1
Reference: FATE#313903

Move the check for __superblock_all_zeroes from
__create_persistent_data_objects() down to __open_or_format_metadata in
dm-thin-metadata.

Signed-off-by: Joe Thornber <ejt@redhat.com>
Signed-off-by: Mike Snitzer <snitzer@redhat.com>
Signed-off-by: Alasdair G Kergon <agk@redhat.com>
Acked-by: NeilBrown <nfbrown@suse.com>

---
 drivers/md/dm-thin-metadata.c |   18 +++++++++---------
 1 file changed, 9 insertions(+), 9 deletions(-)

--- linux-3.0-SLE11-SP3.orig/drivers/md/dm-thin-metadata.c
+++ linux-3.0-SLE11-SP3/drivers/md/dm-thin-metadata.c
@@ -596,9 +596,15 @@ bad:
 }
 
 static int __open_or_format_metadata(struct dm_pool_metadata *pmd,
-				     int create)
+				     int *create)
 {
-	if (create)
+	int r;
+
+	r = __superblock_all_zeroes(pmd->bm, create);
+	if (r)
+		return r;
+
+	if (*create)
 		return __format_metadata(pmd);
 	else
 		return __open_metadata(pmd);
@@ -617,13 +623,7 @@ static int __create_persistent_data_obje
 		return PTR_ERR(pmd->bm);
 	}
 
-	r = __superblock_all_zeroes(pmd->bm, create);
-	if (r) {
-		dm_block_manager_destroy(pmd->bm);
-		return r;
-	}
-
-	r = __open_or_format_metadata(pmd, *create);
+	r = __open_or_format_metadata(pmd, create);
 	if (r)
 		dm_block_manager_destroy(pmd->bm);
 
