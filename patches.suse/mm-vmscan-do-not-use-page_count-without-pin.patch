From: Mel Gorman <mgorman@suse.de>
Date: Tue, 19 Jul 2011 10:42:13 +0100
Subject: [PATCH] mm: vmscan: do not use page_count without a page pin
Patch-mainline: yes (3.0-rc4)
References: Alloc/reclaim/compact impacting THP 2.6.38-3.0-rc3 (fate #311931)
Git-commit: f9e35b3b41f47c4e17d8132edbcab305a6aaa4b0

It is unsafe to run page_count during the physical pfn scan because
compound_head could trip on a dangling pointer when reading
page->first_page if the compound page is being freed by another CPU.

[mgorman@suse.de: split out patch]
Signed-off-by: Andrea Arcangeli <aarcange@redhat.com>
Signed-off-by: Mel Gorman <mgorman@suse.de>
Reviewed-by: Michal Hocko <mhocko@suse.cz>
Reviewed-by: Minchan Kim <minchan.kim@gmail.com>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
---
 mm/vmscan.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/mm/vmscan.c b/mm/vmscan.c
index bd7e674..1cd2e5e 100644
--- a/mm/vmscan.c
+++ b/mm/vmscan.c
@@ -1092,7 +1092,7 @@ static unsigned long isolate_lru_pages(unsigned long nr_to_scan,
 				scan++;
 			} else {
 				if (mode == ISOLATE_BOTH &&
-						page_count(cursor_page))
+						atomic_read(&cursor_page->_count))
 					nr_lumpy_failed++;
 			}
 		}
