From: Andre Przywara <andre.przywara@amd.com>
Subject: [PATCH 06/12] KVM: SVM: Add clean-bit for NPT state
References: FATE#309760
Git-commit: b2747166dc315b31281fb659a5b8938873d5f1d7
Patch-mainline: v2.6.38

This patch implements the clean-bit for all nested paging
related state in the vmcb.

Backport of b2747166dc315b31281fb659a5b8938873d5f1d7
(done by: Joerg Roedel <joerg.roedel@amd.com>)

Signed-off-by: Andre Przywara <andre.przywara@amd.com>
Acked-by: Bruce Rogers <brogers@suse.com>
---
 arch/x86/kvm/svm.c |    2 ++
 1 file changed, 2 insertions(+)

Index: b/arch/x86/kvm/svm.c
===================================================================
--- a/arch/x86/kvm/svm.c
+++ b/arch/x86/kvm/svm.c
@@ -147,6 +147,7 @@ enum {
 	VMCB_PERM_MAP,   /* IOPM Base and MSRPM Base */
 	VMCB_ASID,       /* ASID */
 	VMCB_INTR,       /* int_ctl, int_vector */
+	VMCB_NPT,        /* npt_en, nCR3, gPAT */
 	VMCB_DIRTY_MAX,
 };
 
@@ -3060,6 +3061,7 @@ static void svm_set_cr3(struct kvm_vcpu
 
 	if (npt_enabled) {
 		svm->vmcb->control.nested_cr3 = root;
+		mark_dirty(svm->vmcb, VMCB_NPT);
 		force_new_asid(vcpu);
 		return;
 	}
