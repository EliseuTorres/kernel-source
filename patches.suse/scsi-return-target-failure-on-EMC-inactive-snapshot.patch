From: Hannes Reinecke <hare@suse.de>
Date: Wed, 19 Mar 2014 09:25:13 +0100
Subject: [PATCH] scsi: return target failure on EMC inactive snapshot
Patch-Mainline: not yet
References: bnc#840524

EMC products return 0x05/0x25/0x01 for any medium access on
inactive snapshots. Return target failure here to avoid
pointless failover with multipath.

Signed-off-by: Hannes Reinecke <hare@suse.de>

diff --git a/drivers/scsi/constants.c b/drivers/scsi/constants.c
index 76e4c03..d9482b6 100644
--- a/drivers/scsi/constants.c
+++ b/drivers/scsi/constants.c
@@ -641,6 +641,7 @@ static const struct error_info additional[] =
 	{0x2408, "Invalid XCDB"},
 
 	{0x2500, "Logical unit not supported"},
+	{0x2501, "Access to inactive snapshot"},
 
 	{0x2600, "Invalid field in parameter list"},
 	{0x2601, "Parameter not supported"},
diff --git a/drivers/scsi/scsi_error.c b/drivers/scsi/scsi_error.c
index 6a9268f..d87f7ae 100644
--- a/drivers/scsi/scsi_error.c
+++ b/drivers/scsi/scsi_error.c
@@ -517,6 +517,13 @@ static int scsi_check_sense(struct scsi_cmnd *scmd)
 		    sshdr.asc == 0x26) { /* Parameter value invalid */
 			return TARGET_ERROR;
 		}
+		if (sshdr.asc == 0x25 && sshdr.ascq == 0x1) {
+			/*
+			 * Inactive Snapshot on EMC Symmetrix or Clariion.
+			 * No Access possible, and retry pointless.
+			 */
+			return TARGET_ERROR;
+		}
 		return SUCCESS;
 
 	default:
