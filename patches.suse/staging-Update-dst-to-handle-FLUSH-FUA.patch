From: Hannes Reinecke <hare@suse.de>
Date: Wed, 1 Jun 2011 13:03:35 +0200
Subject: [PATCH] staging: Update dst to handle FLUSH/FUA
References: FATE#311054
Patch-Mainline: n/a

Update dst to treat REQ_FLUSH correctly.

Signed-off-by: Hannes Reinecke <hare@suse.de>
---
 drivers/staging/dst/dcore.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/staging/dst/dcore.c b/drivers/staging/dst/dcore.c
index 7b3a4b8..a610a86 100644
--- a/drivers/staging/dst/dcore.c
+++ b/drivers/staging/dst/dcore.c
@@ -102,7 +102,7 @@ static int dst_request(struct request_queue *q, struct bio *bio)
 	struct dst_node *n = q->queuedata;
 	int err = -EIO;
 
-	if (bio_empty_barrier(bio) && !blk_queue_discard(q)) {
+	if (bio->bi_rw & REQ_FLUSH && !bio->bi_size && !blk_queue_discard(q)) {
 		/*
 		 * This is a dirty^Wnice hack, but if we complete this
 		 * operation with -EOPNOTSUPP like intended, XFS
-- 
1.6.0.2

