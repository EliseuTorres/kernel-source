From: Christoph Hellwig <hch@lst.de>
Date: Thu, 21 Aug 2014 11:09:18 -0500
Subject: [PATCH] pnfs: do not pass uninitialized lsegs to ->free_lseg
Git-commit: 1013df61150e56f775ccacdaaeee66042f1e6eb6
Patch-mainline: v3.18
References: bnc#898675

Ensure the lsegs are initialized early so that we don't pass an unitialized
one back to ->free_lseg during error processing.

Signed-off-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Trond Myklebust <trond.myklebust@primarydata.com>
Acked-by: NeilBrown <neilb@suse.de>

---
 fs/nfs/pnfs.c |    5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

--- linux-3.12-SLE12.orig/fs/nfs/pnfs.c
+++ linux-3.12-SLE12/fs/nfs/pnfs.c
@@ -1341,6 +1341,9 @@ pnfs_layout_process(struct nfs4_layoutge
 		goto out;
 	}
 
+	init_lseg(lo, lseg);
+	lseg->pls_range = res->range;
+
 	spin_lock(&ino->i_lock);
 	if (test_bit(NFS_LAYOUT_BULK_RECALL, &lo->plh_flags)) {
 		dprintk("%s forget reply due to recall\n", __func__);
@@ -1358,8 +1361,6 @@ pnfs_layout_process(struct nfs4_layoutge
 	/* Done processing layoutget. Set the layout stateid */
 	pnfs_set_layout_stateid(lo, &res->stateid, false);
 
-	init_lseg(lo, lseg);
-	lseg->pls_range = res->range;
 	pnfs_get_lseg(lseg);
 	pnfs_layout_insert_lseg(lo, lseg);
 
