From 50da08409654e036c4c964a473567a61a654cb83 Mon Sep 17 00:00:00 2001
From: NeilBrown <neilb@suse.de>
Date: Mon, 31 Jan 2011 11:57:43 +1100
Subject: [PATCH] md: don't abort checking spares as soon as one cannot be
	added.
Git-commit: 50da08409654e036c4c964a473567a61a654cb83
Patch-mainline: v2.6.38-rc7

As spares can be added manually before a reshape starts, we need to
find them all to mark some of them as in_sync.

Previously we would abort looking for spares when we found an
unallocated spare what could not be added to the array (implying there
was no room for new spares).  However already-added spares could be
later in the list, so we need to keep searching.

Signed-off-by: NeilBrown <neilb@suse.de>
---
 drivers/md/raid5.c |    3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

--- linux-2.6.32-SLE11-SP1.orig/drivers/md/raid5.c
+++ linux-2.6.32-SLE11-SP1/drivers/md/raid5.c
@@ -5575,8 +5575,7 @@ static int raid5_start_reshape(mddev_t *
 					       "raid5: failed to create "
 					       " link %s for %s\n",
 					       nm, mdname(mddev));
-				} else
-					break;
+				}
 			} else if (rdev->raid_disk >= conf->previous_raid_disks
 				   && !test_bit(Faulty, &rdev->flags)) {
 				/* This is a spare that was manually added */

