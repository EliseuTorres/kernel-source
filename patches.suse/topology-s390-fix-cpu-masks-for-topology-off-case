Subject: [S390] topology: fix cpu masks for topology=off case
From: Heiko Carstens <heiko.carstens@de.ibm.com>
Date: Fri Oct 29 16:50:38 2010 +0200
Git-commit: 0b52783d4feb14d6ff990a63512a66d6131d41f9
References: FATE#311860

Fix cpu masks for 'topology=off' case. Folding of the scheduling domains
happen in such a way that everything belongs to the MC domain instead
of the CPU doimain.
This should fix a performance regression introduced with
eafd2b6d "[S390] topology: use default MC domain initializer" and also
makes sure we have the same behavious as if CONFIG_SCHED_MC was not
selected at all.

Signed-off-by: Heiko Carstens <heiko.carstens@de.ibm.com>
Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
Acked-by: Mike Galbraith <mgalbraith@suse.de>

---
 arch/s390/kernel/topology.c |    6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

Index: linux-2.6.32-SLE11-SP2/arch/s390/kernel/topology.c
===================================================================
--- linux-2.6.32-SLE11-SP2.orig/arch/s390/kernel/topology.c
+++ linux-2.6.32-SLE11-SP2/arch/s390/kernel/topology.c
@@ -88,8 +88,10 @@ static cpumask_t cpu_group_map(struct ma
 	cpumask_t mask;
 
 	cpus_clear(mask);
-	if (!topology_enabled || !machine_has_topology)
-		return cpu_possible_map;
+	if (!topology_enabled || !machine_has_topology) {
+		cpumask_copy(&mask, cpumask_of(cpu));
+		return mask;
+	}
 	while (info) {
 		if (cpu_isset(cpu, info->mask)) {
 			mask = info->mask;
