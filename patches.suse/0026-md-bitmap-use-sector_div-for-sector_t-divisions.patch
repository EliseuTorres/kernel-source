From: Stephen Rothwell <sfr@canb.auug.org.au>
Date: Tue, 3 Mar 2015 13:35:31 +1100
Subject: [PATCH 26/57] md/bitmap: use sector_div for sector_t divisions
Git-commit: 3b0e6aacbfe04fa144c4732f269b09ce91177566
Patch-mainline: v4.1
References: fate#316335

Neilb: modified to not corrupt ->resync_max_sectors.

Signed-off-by: Stephen Rothwell <sfr@canb.auug.org.au>
Signed-off-by: NeilBrown <neilb@suse.de>
Acked-by: NeilBrown <neilb@suse.com>

---
 drivers/md/bitmap.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/drivers/md/bitmap.c b/drivers/md/bitmap.c
index a8d9450d9b6c..8dc2b31116f5 100644
--- a/drivers/md/bitmap.c
+++ b/drivers/md/bitmap.c
@@ -566,8 +566,10 @@ re_read:
 	/* If cluster_slot is set, the cluster is setup */
 	if (bitmap->cluster_slot >= 0) {
 		sector_t bm_blocks;
+		sector_t resync_sectors = bitmap->mddev->resync_max_sectors;
 
-		bm_blocks = bitmap->mddev->resync_max_sectors / (bitmap->mddev->bitmap_info.chunksize >> 9);
+		bm_blocks = sector_div(resync_sectors,
+				       bitmap->mddev->bitmap_info.chunksize >> 9);
 		bm_blocks = bm_blocks << 3;
 		bm_blocks = DIV_ROUND_UP_SECTOR_T(bm_blocks, 4096);
 		bitmap->mddev->bitmap_info.offset += bitmap->cluster_slot * (bm_blocks << 3);
-- 
2.5.0

