From: Andre Przywara <andre.przywara@amd.com>
Subject: [PATCH 04/12] KVM: SVM: Add clean-bit for the ASID
References: FATE#309760
Git-commit: d48086d1e316e0cefd69b6d2ce75a42856cfba57
Patch-mainline: v2.6.38

This patch implements the clean-bit for the asid in the vmcb.

Backport of d48086d1e316e0cefd69b6d2ce75a42856cfba57
(done by: Joerg Roedel <joerg.roedel@amd.com>)

Signed-off-by: Andre Przywara <andre.przywara@amd.com>
Acked-by: Bruce Rogers <brogers@suse.com>
---
 arch/x86/kvm/svm.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

Index: linux-2.6.32-SLE11-SP2/arch/x86/kvm/svm.c
===================================================================
--- linux-2.6.32-SLE11-SP2.orig/arch/x86/kvm/svm.c
+++ linux-2.6.32-SLE11-SP2/arch/x86/kvm/svm.c
@@ -145,6 +145,7 @@ enum {
 	VMCB_INTERCEPTS, /* Intercept vectors, TSC offset,
 	                    pause filter count */
 	VMCB_PERM_MAP,   /* IOPM Base and MSRPM Base */
+	VMCB_ASID,       /* ASID */
 	VMCB_DIRTY_MAX,
 };
 
@@ -1182,6 +1183,8 @@ static void new_asid(struct vcpu_svm *sv
 
 	svm->asid_generation = svm_data->asid_generation;
 	svm->vmcb->control.asid = svm_data->next_asid++;
+
+	mark_dirty(svm->vmcb, VMCB_ASID);
 }
 
 static unsigned long svm_get_dr(struct kvm_vcpu *vcpu, int dr)
