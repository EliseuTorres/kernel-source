From: Miklos Szeredi <mszeredi@suse.cz>
Date: Mon, 28 Apr 2014 14:19:23 +0200
Subject: fuse: fuse: add time_gran to INIT_OUT
Git-commit: e27c9d3877a0d0479711a55f5cdd7ee91442da53
Patch-mainline: v3.15-rc5
References: FATE#317677

Allow userspace fs to specify time granularity.

This is needed because with writeback_cache mode the kernel is responsible
for generating mtime and ctime, but if the underlying filesystem doesn't
support nanosecond granularity then the cache will contain a different
value from the one stored on the filesystem resulting in a change of times
after a cache flush.

Make the default granularity 1s.

Signed-off-by: Miklos Szeredi <mszeredi@suse.cz>
---
 fs/fuse/inode.c      |    5 +++++
 include/linux/fuse.h |    5 +++++
 2 files changed, 10 insertions(+)

--- a/fs/fuse/inode.c
+++ b/fs/fuse/inode.c
@@ -859,6 +859,11 @@ static void process_init_reply(struct fu
 				fc->async_dio = 1;
 			if (arg->flags & FUSE_WRITEBACK_CACHE)
 				fc->writeback_cache = 1;
+			if (arg->time_gran && arg->time_gran <= 1000000000)
+				fc->sb->s_time_gran = arg->time_gran;
+			else
+				fc->sb->s_time_gran = 1000000000;
+
 		} else {
 			ra_pages = fc->max_read / PAGE_CACHE_SIZE;
 			fc->no_lock = 1;
--- a/include/linux/fuse.h
+++ b/include/linux/fuse.h
@@ -479,6 +479,9 @@ struct fuse_init_in {
 	__u32	flags;
 };
 
+#define FUSE_COMPAT_INIT_OUT_SIZE 8
+#define FUSE_COMPAT_22_INIT_OUT_SIZE 24
+
 struct fuse_init_out {
 	__u32	major;
 	__u32	minor;
@@ -487,6 +490,8 @@ struct fuse_init_out {
 	__u16   max_background;
 	__u16   congestion_threshold;
 	__u32	max_write;
+	__u32	time_gran;
+	__u32	unused[9];
 };
 
 #define CUSE_INIT_INFO_MAX 4096
