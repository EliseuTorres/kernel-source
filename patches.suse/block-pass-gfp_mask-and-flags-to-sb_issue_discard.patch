From: Christoph Hellwig <hch@infradead.org>
Date: Wed, 18 Aug 2010 05:29:10 -0400
Subject: [PATCH] block: pass gfp_mask and flags to sb_issue_discard
X-Git: 2cf6d26a354ab6362e301b5a323832b02867df47
References: FATE#311692
Patch-Mainline: 2.6.34

We'll need to get rid of the BLKDEV_IFL_BARRIER flag, and to facilitate
that and to make the interface less confusing pass all flags explicitly.
fat already uses synchronous discards, no need to add I/O barriers.

Signed-off-by: Christoph Hellwig <hch@lst.de>
Acked-by: Mike Snitzer <snitzer@redhat.com>
Signed-off-by: Tejun Heo <tj@kernel.org>
Signed-off-by: Jens Axboe <jaxboe@fusionio.com>
Signed-off-by: Hannes Reinecke <hare@suse.de>
---
 fs/fat/fatent.c        |    8 ++++++--
 include/linux/blkdev.h |   11 +++++------
 3 files changed, 13 insertions(+), 9 deletions(-)

diff --git a/fs/fat/fatent.c b/fs/fat/fatent.c
index a810377..a9bd42a 100644
--- a/fs/fat/fatent.c
+++ b/fs/fat/fatent.c
@@ -573,8 +573,12 @@ int fat_free_clusters(struct inode *inode, int cluster)
 		if (cluster != fatent.entry + 1) {
 			int nr_clus = fatent.entry - first_cl + 1;
 
-			sb_issue_discard(sb, fat_clus_to_blknr(sbi, first_cl),
-					 nr_clus * sbi->sec_per_clus);
+			sb_issue_discard(sb,
+				 fat_clus_to_blknr(sbi, first_cl),
+				 nr_clus * sbi->sec_per_clus,
+				 GFP_NOFS,
+				 BLKDEV_IFL_WAIT);
+
 			first_cl = cluster;
 		}
 
diff --git a/include/linux/blkdev.h b/include/linux/blkdev.h
index 5a6c8ab..ec1405f 100644
--- a/include/linux/blkdev.h
+++ b/include/linux/blkdev.h
@@ -903,13 +903,12 @@ extern int blkdev_issue_discard(struct block_device *bdev, sector_t sector,
 		sector_t nr_sects, gfp_t gfp_mask, unsigned long flags);
 extern int blkdev_issue_zeroout(struct block_device *bdev, sector_t sector,
 			sector_t nr_sects, gfp_t gfp_mask, unsigned long flags);
-static inline int sb_issue_discard(struct super_block *sb,
-				   sector_t block, sector_t nr_blocks)
+static inline int sb_issue_discard(struct super_block *sb, sector_t block,
+		sector_t nr_blocks, gfp_t gfp_mask, unsigned long flags)
 {
-	block <<= (sb->s_blocksize_bits - 9);
-	nr_blocks <<= (sb->s_blocksize_bits - 9);
-	return blkdev_issue_discard(sb->s_bdev, block, nr_blocks, GFP_NOFS,
-				   BLKDEV_IFL_WAIT | BLKDEV_IFL_BARRIER);
+	return blkdev_issue_discard(sb->s_bdev, block << (sb->s_blocksize_bits - 9),
+				    nr_blocks << (sb->s_blocksize_bits - 9),
+				    gfp_mask, flags);
 }
 
 extern int blk_verify_command(unsigned char *cmd, fmode_t has_write_perm);
-- 
1.6.0.2

