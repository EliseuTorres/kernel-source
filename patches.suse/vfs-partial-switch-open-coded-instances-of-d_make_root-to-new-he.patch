From: Al Viro <viro@zeniv.linux.org.uk>
Date: Sun, 8 Jan 2012 22:15:13 -0500
Patch-mainline: 3.4
Git-commit: 48fde701aff662559b38d9a609574068f22d00fe
Subject: [PATCH] switch open-coded instances of d_make_root() to new
 helper

[Removed non-btrfs filesystems; reason: reduce conflicts in backported patches]

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: David Sterba <dsterba@suse.cz>
---
 fs/btrfs/super.c |    8 ++------
 1 file changed, 2 insertions(+), 6 deletions(-)

--- a/fs/btrfs/super.c
+++ b/fs/btrfs/super.c
@@ -630,7 +630,6 @@ static int btrfs_fill_super(struct super
 			    void *data, int silent)
 {
 	struct inode *inode;
-	struct dentry *root_dentry;
 	struct btrfs_fs_info *fs_info = btrfs_sb(sb);
 	struct btrfs_key key;
 	int err;
@@ -661,15 +660,12 @@ static int btrfs_fill_super(struct super
 		goto fail_close;
 	}
 
-	root_dentry = d_alloc_root(inode);
-	if (!root_dentry) {
-		iput(inode);
+	sb->s_root = d_make_root(inode);
+	if (!sb->s_root) {
 		err = -ENOMEM;
 		goto fail_close;
 	}
 
-	sb->s_root = root_dentry;
-
 	save_mount_options(sb, data);
 	cleancache_init_fs(sb);
 	sb->s_flags |= MS_ACTIVE;
