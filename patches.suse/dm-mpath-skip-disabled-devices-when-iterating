From: Hannes Reinecke <hare@suse.de>
Subject: kernel Oops in multipathing after chchp -v 0
References: bnc#570526
Patch-Mainline: Submitted to dm-devel

When disabling all paths simultaneously the kernel oopses in
dm_set_device_limits(). Reason being multipath_iterate_devices
is not checking for disabled devices and call the function
with invalid arguments.

Signed-off-by: Hannes Reinecke <hare@suse.de>

diff --git a/drivers/md/dm-mpath.c b/drivers/md/dm-mpath.c
index c146f63..9a1bfa0 100644
--- a/drivers/md/dm-mpath.c
+++ b/drivers/md/dm-mpath.c
@@ -1526,6 +1526,8 @@ static int multipath_iterate_devices(struct dm_target *ti,
 
 	list_for_each_entry(pg, &m->priority_groups, list) {
 		list_for_each_entry(p, &pg->pgpaths, list) {
+			if (!p->path.dev)
+				continue;
 			ret = fn(ti, p->path.dev, ti->begin, ti->len, data);
 			if (ret)
 				goto out;
