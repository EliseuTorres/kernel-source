From: Chris Mason <chris.mason@oracle.com>
Date: Mon, 18 Apr 2011 08:55:34 -0400
Patch-mainline: yes
References: FATE#306586
Subject: [PATCH] Btrfs: fix free space cache leak

The free space caching code was recently reworked to
cache all the pages it needed instead of using find_get_page everywhere.

One loop was missed though, so it ended up leaking pages.  This fixes
it to use our page array instead of find_get_page.

Signed-off-by: Chris Mason <chris.mason@oracle.com>
Signed-off-by: David Sterba <dsterba@suse.cz>
---
 fs/btrfs/free-space-cache.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

--- a/fs/btrfs/free-space-cache.c
+++ b/fs/btrfs/free-space-cache.c
@@ -731,7 +731,7 @@ int btrfs_write_out_cache(struct btrfs_r
 			out_of_space = true;
 			break;
 		}
-		page = find_get_page(inode->i_mapping, index);
+		page = pages[index];
 
 		addr = kmap(page);
 		memcpy(addr, entry->bitmap, PAGE_CACHE_SIZE);
