From: Sripathi Kodi <sripathik@in.ibm.com>
Subject: [PATCH 073/111]     9p: Pass the correct end of buffer to p9dirent_read
Git-commit: 8812a3d5f873e28cd08ec8afe328c4182b72db49
Patch-Mainline: 2.6.37
References: FATE#311639

    A patch was accepted recently for sending correct buffer size to p9stat_read
    We need a similar patch in v9fs_dir_readdir_dotl to send correct end of buff
    to p9dirent_read.

	upstream commit 8812a3d5f873e28cd08ec8afe328c4182b72db49

    Signed-off-by: Sripathi Kodi <sripathik@in.ibm.com>
    Signed-off-by: Eric Van Hensbergen <ericvh@gmail.com>
Signed-off-by: Harsh Prateek Bora <harsh@linux.vnet.ibm.com>
Acked-by: Bruce Rogers <brogers@suse.com>
---
 fs/9p/vfs_dir.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/fs/9p/vfs_dir.c b/fs/9p/vfs_dir.c
index 34480fb..33c925a 100644
--- a/fs/9p/vfs_dir.c
+++ b/fs/9p/vfs_dir.c
@@ -241,7 +241,8 @@ static int v9fs_dir_readdir_dotl(struct file *filp, void *dirent,
 		while (rdir->head < rdir->tail) {
 
 			err = p9dirent_read(rdir->buf + rdir->head,
-						buflen - rdir->head, &curdirent,
+						rdir->tail - rdir->head,
+						&curdirent,
 						fid->clnt->proto_version);
 			if (err < 0) {
 				P9_DPRINTK(P9_DEBUG_VFS, "returned %d\n", err);
-- 
1.7.1.1

