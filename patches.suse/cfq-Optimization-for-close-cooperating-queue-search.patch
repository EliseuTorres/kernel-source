From: Gui Jianfeng <guijianfeng@cn.fujitsu.com>
Date: Tue, 8 Dec 2009 08:54:17 +0100
Subject: [PATCH] cfq: Optimization for close cooperating queue searching
X-Git: b9d8f4c73b1af4cfd53f819bf84c2bce31232275
References: FATE#311054
Patch-Mainline: 2.6.33

It doesn't make any sense to try to find out a close cooperating
queue if current cfqq is the only one in the group.

Signed-off-by: Gui Jianfeng <guijianfeng@cn.fujitsu.com>
Signed-off-by: Jens Axboe <jens.axboe@oracle.com>
Signed-off-by: Hannes Reinecke <hare@suse.de>
---
 block/cfq-iosched.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/block/cfq-iosched.c b/block/cfq-iosched.c
index ae3449c..6085aab 100644
--- a/block/cfq-iosched.c
+++ b/block/cfq-iosched.c
@@ -1752,6 +1752,12 @@ static struct cfq_queue *cfq_close_cooperator(struct cfq_data *cfqd,
 		return NULL;
 
 	/*
+	 * Don't search priority tree if it's the only queue in the group.
+	 */
+	if (cur_cfqq->cfqg->nr_cfqq == 1)
+		return NULL;
+
+	/*
 	 * We should notice if some of the queues are cooperating, eg
 	 * working closely on the same area of the disk. In that case,
 	 * we can group them together and don't waste time idling.
-- 
1.6.0.2

