From: Jiri Slaby <jslaby@suse.cz>
Date: Wed, 7 Dec 2011 05:40:18 +0100
Subject: Revert "serial: core, do not set DTR/RTS twice on startup"
Patch-mainline: never
References: bnc#718518

This reverts commit 303a7a1199c20f7c9452f024a6e17bf348b6b398.

The last two patch in these series introduced serial lockups on UV
machines. So revert those.

To be able to do that we need patches 1-3 to reintroduce
uart_update_termios.

Signed-off-by: Jiri Slaby <jslaby@suse.cz>
---
 drivers/tty/serial/serial_core.c |   14 ++++++++++++++
 1 files changed, 14 insertions(+), 0 deletions(-)

diff --git a/drivers/tty/serial/serial_core.c b/drivers/tty/serial/serial_core.c
index 762b04f..da0d889 100644
--- a/drivers/tty/serial/serial_core.c
+++ b/drivers/tty/serial/serial_core.c
@@ -1469,6 +1469,20 @@ static void uart_hangup(struct tty_struct *tty)
 static void uart_update_termios(struct tty_struct *tty,
 						struct uart_state *state)
 {
+	struct uart_port *port = state->uart_port;
+
+	/*
+	 * If the device failed to grab its irq resources,
+	 * or some other error occurred, don't try to talk
+	 * to the port hardware.
+	 */
+	if (!(tty->flags & (1 << TTY_IO_ERROR))) {
+		/*
+		 * And finally enable the RTS and DTR signals.
+		 */
+		if (tty->termios->c_cflag & CBAUD)
+			uart_set_mctrl(port, TIOCM_DTR | TIOCM_RTS);
+	}
 }
 
 static int uart_carrier_raised(struct tty_port *port)
-- 
1.6.0.2

