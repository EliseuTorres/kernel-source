From: Gui Jianfeng <guijianfeng@cn.fujitsu.com>
Date: Tue, 15 Dec 2009 10:08:45 +0100
Subject: [PATCH] cfq: set workload as expired if it doesn't have any slice left
Git-commit: 66ae291978177d5c012015f12b8fbc76dc7d0965
References: FATE#311054
Patch-Mainline: 2.6.33

When a group is resumed, if it doesn't have workload slice left,
we should set workload_expires as expired. Otherwise, we might
start from where we left in previous group by error.
Thanks the idea from Corrado.

Signed-off-by: Gui Jianfeng <guijianfeng@cn.fujitsu.com>
Signed-off-by: Jens Axboe <jens.axboe@oracle.com>
Signed-off-by: Hannes Reinecke <hare@suse.de>
---
 block/cfq-iosched.c |    4 +++-
 1 files changed, 3 insertions(+), 1 deletions(-)

diff --git a/block/cfq-iosched.c b/block/cfq-iosched.c
index 0f283c5..79a2ce2 100644
--- a/block/cfq-iosched.c
+++ b/block/cfq-iosched.c
@@ -2115,7 +2115,9 @@ static void cfq_choose_cfqg(struct cfq_data *cfqd)
 		cfqd->workload_expires = jiffies + cfqg->saved_workload_slice;
 		cfqd->serving_type = cfqg->saved_workload;
 		cfqd->serving_prio = cfqg->saved_serving_prio;
-	}
+	} else
+		cfqd->workload_expires = jiffies - 1;
+
 	choose_service_tree(cfqd, cfqg);
 }
 
-- 
1.6.0.2

