From: Jan Kara <jack@suse.cz>
Subject: Fix double put in sync_filesystems()
References: bnc#706472
Patch-mainline: Never (bug introduced by patches.fixes/vfs-get-rid-of-restarts-in-sync_filesystems.patch)

Due to a merge bug we put current and not previous superblock in
sync_filesystems(). That can cause us to dereference already just freed
superblock and also results in us dropping the reference to the last superblock
in the list twice. Fix the issue by putting the proper superblock.

Signed-off-by: Jan Kara <jack@suse.cz>

diff -rupX /crypted/home/jack/.kerndiffexclude linux-2.6.32-SLE11-SP2/fs/sync.c linux-2.6.32-SLE11-SP2-synclist-fix/fs/sync.c
--- linux-2.6.32-SLE11-SP2/fs/sync.c	2011-07-18 18:54:01.001309514 +0200
+++ linux-2.6.32-SLE11-SP2-synclist-fix/fs/sync.c	2011-07-18 18:57:44.050035554 +0200
@@ -98,7 +98,7 @@ static void sync_filesystems(int wait)
 		/* restart only when sb is no longer on the list */
 		spin_lock(&sb_lock);
 		if (p)
-			__put_super(sb);
+			__put_super(p);
 		p = sb;
 	}
 	if (p)
