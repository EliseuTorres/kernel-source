From: Michal Kubecek <mkubecek@suse.cz>
Subject: [PATCH SLE11-SP1 3/6] novfs: last modification time not reliable
References: bnc#642896
Patch-mainline: no

Change the revalidation condition for verify_dentry().

Reported-by: Jeremy Meldrum <jmeldrum@novell.com>
Signed-off-by: Jitendra Sankhala <sjitendra@novell.com>
Signed-off-by: Michal Kubecek <mkubecek@suse.cz>
Acked-by: Jan Kara <jack@suse.cz>
---
 fs/novfs/inode.c |   45 +++++++++++++++++++++++++++------------------
 1 files changed, 27 insertions(+), 18 deletions(-)

diff --git a/fs/novfs/inode.c b/fs/novfs/inode.c
index 3c40c8d..d4c8f74 100644
--- a/fs/novfs/inode.c
+++ b/fs/novfs/inode.c
@@ -675,6 +675,8 @@ int novfs_d_revalidate(struct dentry *dentry, struct nameidata *nd)
 	struct inode *dir;
 	struct inode_data *id;
 	struct qstr name;
+	struct novfs_dir_cache *dc;
+	unsigned long tmp_jiffies;
 
 	__DbgPrint("%s: 0x%p %.*s\n"
 		   "   d_count: %d\n"
@@ -685,29 +687,36 @@ int novfs_d_revalidate(struct dentry *dentry, struct nameidata *nd)
 		retCode = 1;
 	} else {
 		if (dentry->d_inode && dentry->d_parent && (dir = dentry->d_parent->d_inode) && (id = dir->i_private)) {
-			/*
-			 * Check timer to see if in valid time limit
-			 */
-			if (jiffies > dentry->d_time) {
-				/*
-				 * Revalidate entry
-				 */
-				name.len = dentry->d_name.len;
-				name.name = dentry->d_name.name;
-				name.hash = novfs_internal_hash(&dentry->d_name);
-				dentry->d_time = 0;
+			
+			name.len = dentry->d_name.len;
+			name.name = dentry->d_name.name;
+			name.hash = novfs_internal_hash(&dentry->d_name);
+			
+			if (novfs_lock_inode_cache(dir)) {
+				if ((dc = novfs_lookup_inode_cache(dir, &name, 0))) {
+					/*
+					 * Check timer to see if in valid time limit
+					 */
+					tmp_jiffies = jiffies;
+					DbgPrint("tmp jiffies is: %lu ", tmp_jiffies);
+					if (time_after(tmp_jiffies, dentry->d_time) || time_before(tmp_jiffies, (unsigned long)dc->jiffies)) {
+						novfs_unlock_inode_cache(dir);
+						dentry->d_time = 0;
 
-				if (0 == verify_dentry(dentry, 0)) {
-					if (novfs_lock_inode_cache(dir)) {
-						if (novfs_lookup_inode_cache(dir, &name, 0)) {
-							dentry->d_time = jiffies + (novfs_update_timeout * HZ);
+						/*
+						 * Revalidate entry
+					 	 */
+						if (0 == verify_dentry(dentry, 0)) {
+							dentry->d_time = tmp_jiffies + (novfs_update_timeout * HZ);
 							retCode = 1;
 						}
+					} else {
 						novfs_unlock_inode_cache(dir);
+						retCode = 1;
 					}
-				}
-			} else {
-				retCode = 1;
+				} else {
+					novfs_unlock_inode_cache(dir);
+				}	
 			}
 		}
 	}
-- 
1.7.3.4

