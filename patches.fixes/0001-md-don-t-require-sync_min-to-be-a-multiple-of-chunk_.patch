From: NeilBrown <neilb@suse.de>
Date: Mon, 23 Mar 2015 17:36:38 +1100
Subject: [PATCH] md: don't require sync_min to be a multiple of chunk_size.
Git-commit: 2d92d8c7ecc268051e9b1d93bde2868b83a20a86
Patch-mainline: Submit for 4.1
References: bnc#910500

There is really no need for sync_min to be a multiple of
chunk_size, and values read from here often aren't.
That means you cannot read a value and expect to be able
to write it back later.

So remove the chunk_size check, and round down to a multiple
of 4K, to be sure everything works with 4K-sector devices.

Signed-off-by: NeilBrown <neilb@suse.de>
Acked-by: NeilBrown <neilb@suse.de>

---
 drivers/md/md.c |    9 ++-------
 1 file changed, 2 insertions(+), 7 deletions(-)

--- linux-3.16-openSUSE-13.2.orig/drivers/md/md.c
+++ linux-3.16-openSUSE-13.2/drivers/md/md.c
@@ -4423,13 +4423,8 @@ min_sync_store(struct mddev *mddev, cons
 	if (test_bit(MD_RECOVERY_RUNNING, &mddev->recovery))
 		return -EBUSY;
 
-	/* Must be a multiple of chunk_size */
-	if (mddev->chunk_sectors) {
-		sector_t temp = min;
-		if (sector_div(temp, mddev->chunk_sectors))
-			return -EINVAL;
-	}
-	mddev->resync_min = min;
+	/* Round down to multiple of 4K for safety */
+	mddev->resync_min = round_down(min, 8);
 
 	return len;
 }
