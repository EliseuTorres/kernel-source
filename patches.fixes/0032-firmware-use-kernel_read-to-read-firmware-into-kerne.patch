From ce57e981f2b996aaca2031003b3f866368307766 Mon Sep 17 00:00:00 2001
From: Linus Torvalds <torvalds@linux-foundation.org>
Date: Thu, 4 Oct 2012 09:19:02 -0700
Subject: [PATCH] firmware: use 'kernel_read()' to read firmware into kernel buffer
Git-commit: ce57e981f2b996aaca2031003b3f866368307766
Patch-mainline: v3.7-rc1
Reference: fate#314574
Target: sle11-sp3

Fengguang correctly points out that the firmware reading should not use
vfs_read(), since the buffer is in kernel space.

The vfs_read() just happened to work for kernel threads, but sparse
warns about the incorrect address spaces, and it's definitely incorrect
and could fail for other users of the firmware loading.

Reported-by: Fengguang Wu <fengguang.wu@intel.com>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Acked-by: Lee, Chun-Yi <jlee@suse.com>

---
 drivers/base/firmware_class.c |    4 +---
 1 file changed, 1 insertion(+), 3 deletions(-)

--- a/drivers/base/firmware_class.c
+++ b/drivers/base/firmware_class.c
@@ -60,7 +60,6 @@ static noinline long fw_file_size(struct
 
 static bool fw_read_file_contents(struct file *file, struct firmware *fw)
 {
-	loff_t pos;
 	long size;
 	char *buf;
 
@@ -70,8 +69,7 @@ static bool fw_read_file_contents(struct
 	buf = vmalloc(size);
 	if (!buf)
 		return false;
-	pos = 0;
-	if (vfs_read(file, buf, size, &pos) != size) {
+	if (kernel_read(file, 0, buf, size) != size) {
 		vfree(buf);
 		return false;
 	}
