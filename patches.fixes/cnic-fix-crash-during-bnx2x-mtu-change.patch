Subject: [PATCH] cnic: Fix crash during bnx2x MTU change.
From: "Michael Chan" <mchan@broadcom.com>
References: bnc#564640
Patch-mainline: http://marc.info/?l=linux-netdev&m=127051760930651&w=2 v2.6.34?

cnic_service_bnx2x() irq handler can be called during chip reset from
MTU change.  Need to check that the cnic's device state is up before
handling the irq.

Signed-off-by: Michael Chan <mchan@broadcom.com>
Signed-off-by: Brandon Philips <bphilips@suse.de>

---
 drivers/net/cnic.c |    8 +++++---
 1 file changed, 5 insertions(+), 3 deletions(-)

Index: linux-2.6.32-SLE11-SP1/drivers/net/cnic.c
===================================================================
--- linux-2.6.32-SLE11-SP1.orig/drivers/net/cnic.c
+++ linux-2.6.32-SLE11-SP1/drivers/net/cnic.c
@@ -2250,11 +2250,13 @@ static irqreturn_t cnic_irq(int irq, voi
 	if (cp->ack_int)
 		cp->ack_int(dev);
 
-	prefetch(cp->status_blk.gen);
-	prefetch(&cp->kcq[KCQ_PG(prod)][KCQ_IDX(prod)]);
+	if (likely(test_bit(CNIC_F_CNIC_UP, &dev->flags))) {
+		prefetch(cp->status_blk.bnx2x);
+		prefetch(&cp->kcq[KCQ_PG(prod)][KCQ_IDX(prod)]);
 
-	if (likely(test_bit(CNIC_F_CNIC_UP, &dev->flags)))
 		tasklet_schedule(&cp->cnic_irq_task);
+		cnic_chk_pkt_rings(cp);
+	}
 
 	return IRQ_HANDLED;
 }
