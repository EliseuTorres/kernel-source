From: Hannes Reinecke <hare@suse.de>
Date: Wed, 18 Sep 2013 08:14:11 +0200
Subject: bio-integrity: track owner of integrity payload
References: bnc#831380
Git-commit: 29ed7813ce5c4661261aeebddb1b8660e0860223
Patch-Mainline: v3.10

We only need to free up the integrity payload if the referenced
bio matches; for cloned bios we don't need to free it.

This is an alternative solution from the upstream patch to
avoid kABI breakage.

Signed-off-by: Michael Reed <mdr@sgi.com>
Signed-off-by: Hannes Reinecke <hare@suse.de>

diff --git a/fs/bio-integrity.c b/fs/bio-integrity.c
index 9c5e6b2..4c21d68 100644
--- a/fs/bio-integrity.c
+++ b/fs/bio-integrity.c
@@ -147,9 +147,7 @@ void bio_integrity_free(struct bio *bio, struct bio_set *bs)
 
 	BUG_ON(bip == NULL);
 
-	/* A cloned bio doesn't own the integrity metadata */
-	if (!bio_flagged(bio, BIO_CLONED) && !bio_flagged(bio, BIO_FS_INTEGRITY)
-	    && bip->bip_buf != NULL)
+	if (bip->bip_buf != NULL && bip->bip_bio == bio)
 		kfree(bip->bip_buf);
 
 	if (use_bip_pool(bip->bip_slab))
