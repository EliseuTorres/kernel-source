From: Michal Kubecek <mkubecek@suse.cz>
Date: Mon, 9 Dec 2013 18:30:25 +0100
Subject: ipv6: send router reachability probe if route has an unreachable gateway
Patch-mainline: v3.14-rc1
Git-commit: 7e9805696428113e34625a65a30dbc62cb78acc5
References: bnc#853162

If Router Preference (RFC 4191) is enabled and more specific route uses
an unreachable gateway, we can end up with a neighbour entry in
NUD_FAILED state which is referenced by the respective struct dst_entry
so that it is never cleaned up and prevents any probing of the gateway.

In mainline, this has been resolved as a side-effect of removal of
neighbour caching in struct dst_entry but this is too complex to be
backported into SLE11. Work around the issue by sending a probe even if
we have NUD_FAILED neighbour cached. We also need to reset the state so
that the probe is actually sent and the response isn't ignored.

Signed-off-by: Michal Kubecek <mkubecek@suse.cz>
---
 net/ipv6/route.c | 12 ++++++++++--
 1 file changed, 10 insertions(+), 2 deletions(-)

diff --git a/net/ipv6/route.c b/net/ipv6/route.c
index 635f79e..c704c5f 100644
--- a/net/ipv6/route.c
+++ b/net/ipv6/route.c
@@ -399,6 +399,11 @@ static void rt6_probe(struct rt6_info *rt)
 
 		neigh->updated = jiffies;
 		read_unlock_bh(&neigh->lock);
+		if (neigh->nud_state & NUD_FAILED) {
+			write_lock_bh(&neigh->lock);
+			neigh->nud_state = NUD_NONE;
+			write_unlock_bh(&neigh->lock);
+		}
 
 		target = (struct in6_addr *)&neigh->primary_key;
 		addrconf_addr_solict_mult(target, &mcaddr);
@@ -469,7 +474,7 @@ static int rt6_score_route(struct rt6_info *rt, int oif,
 #endif
 	n = rt6_check_neigh(rt);
 	if (!n && (strict & RT6_LOOKUP_F_REACHABLE))
-		return -1;
+		return -2;
 	return m;
 }
 
@@ -482,8 +487,11 @@ static struct rt6_info *find_match(struct rt6_info *rt, int oif, int strict,
 		goto out;
 
 	m = rt6_score_route(rt, oif, strict);
-	if (m < 0)
+	if (m < 0) {
+		if (m == -2 && (strict & RT6_LOOKUP_F_REACHABLE))
+			rt6_probe(rt);
 		goto out;
+	}
 
 	if (m > *mpri) {
 		if (strict & RT6_LOOKUP_F_REACHABLE)
-- 
1.8.1.4

