From: Hannes Reinecke <hare@suse.de>
Date: Mon, 28 Jul 2014 08:30:38 +0200
Subject: dm-mpath: fix panic on deleting sg device
References: bnc#870161
Patch-Mainline: not yet

When deleting a sg device dm-mpath will issue a kernel oops
in free_pgpaths(). Looking closer it turns out the strcmp()
does not check for NULL arguments.

Signed-off-by: Hannes Reinecke <hare@suse.de>
---
 drivers/md/dm-mpath.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/drivers/md/dm-mpath.c b/drivers/md/dm-mpath.c
index 17543a6..bd6d28f 100644
--- a/drivers/md/dm-mpath.c
+++ b/drivers/md/dm-mpath.c
@@ -183,7 +183,7 @@ static void free_pgpaths(struct list_head *pgpaths, struct dm_target *ti)
 			 * handler was already detached in parse_path()
 			 * and we can skip this step.
 			 */
-			if (m->hw_handler_name &&
+			if (m->hw_handler_name && cur_hw_handler &&
 			    !strcmp(m->hw_handler_name, cur_hw_handler))
 				scsi_dh_detach(q);
 		}
-- 
1.7.12.4

