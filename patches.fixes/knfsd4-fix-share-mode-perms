From: J. Bruce Fields <bfields@citi.umich.edu>
Subject: nfsd4: fix share mode permissions
References: bnc#566768
Patch-mainline: 2.6.32-rc8
Git-commit: 57ecb34febc4c133ca0ccc7817796605a78a01d3

    NFSv4 opens may function as locks denying other NFSv4 users the rights
    to open a file.

    We're requiring a user to have write permissions before they can deny
    write.  We're *not* requiring a user to have write permissions to deny
    read, which is if anything a more drastic denial.

    What was intended was to require write permissions for DENY_READ.

Upstream/IETF discussions:
http://www.ietf.org/mail-archive/web/nfsv4/current/msg07680.html

Signed-off-by: J. Bruce Fields <bfields@citi.umich.edu>
Signed-off-by: Suresh Jayaraman <sjayaraman@suse.de>
---
 fs/nfsd/nfs4proc.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

Index: linux-2.6.27-SLE11_BRANCH/fs/nfsd/nfs4proc.c
===================================================================
--- linux-2.6.27-SLE11_BRANCH.orig/fs/nfsd/nfs4proc.c
+++ linux-2.6.27-SLE11_BRANCH/fs/nfsd/nfs4proc.c
@@ -74,7 +74,7 @@ do_open_permission(struct svc_rqst *rqst
 		accmode |= NFSD_MAY_READ;
 	if (open->op_share_access & NFS4_SHARE_ACCESS_WRITE)
 		accmode |= (NFSD_MAY_WRITE | NFSD_MAY_TRUNC);
-	if (open->op_share_deny & NFS4_SHARE_DENY_WRITE)
+	if (open->op_share_deny & NFS4_SHARE_DENY_READ)
 		accmode |= NFSD_MAY_WRITE;
 
 	status = fh_verify(rqstp, current_fh, S_IFREG, accmode);
