From: Jan Kara <jack@suse.cz>
Subject: Correct number of credits needed for mkdir
References: bnc#668633
Patch-mainline: yes

In the rare case that INLINE_DATA feature is disabled, and both the allocation
of the directory inode and the allocation of the first directory block need
to relink allocation group, there need not be enough credits reserved in a
transaction. Fix the estimate.

Signed-off-by: Jan Kara <jack@suse.cz>

diff -rupX /crypted/home/jack/.kerndiffexclude linux-2.6.32-SLE11-SP1/fs/ocfs2/journal.h linux-2.6.32-SLE11-SP1-ocfs2_mkdir_credits/fs/ocfs2/journal.h
--- linux-2.6.32-SLE11-SP1/fs/ocfs2/journal.h	2011-02-03 13:52:05.711615165 +0100
+++ linux-2.6.32-SLE11-SP1-ocfs2_mkdir_credits/fs/ocfs2/journal.h	2011-02-03 14:03:41.438670540 +0100
@@ -405,9 +405,9 @@ static inline int ocfs2_remove_extent_cr
 	       ocfs2_quota_trans_credits(sb);
 }
 
-/* data block for new dir/symlink, 2 for bitmap updates (bitmap fe +
- * bitmap block for the new bit) dx_root update for free list */
-#define OCFS2_DIR_LINK_ADDITIONAL_CREDITS (1 + 2 + 1)
+/* data block for new dir/symlink, allocation of the data block,
+ * dx_root update for free list */
+#define OCFS2_DIR_LINK_ADDITIONAL_CREDITS (1 + OCFS2_SUBALLOC_ALLOC + 1)
 
 static inline int ocfs2_add_dir_index_credits(struct super_block *sb)
 {
