From: Anton Blanchard <anton@samba.org>
Subject: powerpc: Add System RAM to /proc/iomem
Git-commit: c40dd2f76644016ca7677545fc846ec2470d70a1
Patch-mainline: v3.2-rc2
References: bnc#827527 

    We've resisted adding System RAM to /proc/iomem because it is
    the wrong place for it. Unfortunately we continue to find tools
    that rely on this behaviour so give up and add it in.
    
Signed-off-by: Anton Blanchard <anton@samba.org>
Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
Acked-by: Torsten Duwe <duwe@suse.de>

 arch/powerpc/mm/mem.c |   30 ++++++++++++++++++++++++++++++
 1 file changed, 30 insertions(+)
Index: linux-3.0-SLE11-SP3/arch/powerpc/mm/mem.c
===================================================================
--- linux-3.0-SLE11-SP3.orig/arch/powerpc/mm/mem.c
+++ linux-3.0-SLE11-SP3/arch/powerpc/mm/mem.c
@@ -34,6 +34,7 @@
 #include <linux/suspend.h>
 #include <linux/memblock.h>
 #include <linux/hugetlb.h>
+#include <linux/slab.h>
 
 #include <asm/pgalloc.h>
 #include <asm/prom.h>
@@ -521,3 +522,32 @@ void update_mmu_cache(struct vm_area_str
 	hash_preload(vma->vm_mm, address, access, trap);
 #endif /* CONFIG_PPC_STD_MMU */
 }
+
+/*
+ * System memory should not be in /proc/iomem but various tools expect it
+ * (eg kdump).
+ */
+static int add_system_ram_resources(void)
+{
+	struct memblock_region *reg;
+
+	for_each_memblock(memory, reg) {
+		struct resource *res;
+		unsigned long base = reg->base;
+		unsigned long size = reg->size;
+
+		res = kzalloc(sizeof(struct resource), GFP_KERNEL);
+		WARN_ON(!res);
+
+		if (res) {
+			res->name = "System RAM";
+			res->start = base;
+			res->end = base + size - 1;
+			res->flags = IORESOURCE_MEM;
+			WARN_ON(request_resource(&iomem_resource, res) < 0);
+		}
+	}
+
+	return 0;
+}
+subsys_initcall(add_system_ram_resources);
