From 4ef8c2bc89ac7aae749ba9e68758d2e2ae464c9d Mon Sep 17 00:00:00 2001
From: Takashi Iwai <tiwai@suse.de>
Date: Mon, 3 Dec 2012 23:52:58 +0100
Subject: [PATCH 2/3] MODSIGN: Avoid using .incbin in C source
Patch-mainline: Submitted 2012-12-04

Using the asm .incbin statement in C sources breaks any gcc wrapper which
assumes that preprocessed C source is self-contained. Use a separate .S
file to include the siging key and certificate.

 v2: avoid GLOBAL() and put .globl explicitly

Tested-by: Michal Marek <mmarek@suse.cz>
Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
 kernel/Makefile              |    4 ++--
 kernel/modsign_certificate.S |   10 ++++++++++
 kernel/modsign_pubkey.c      |    6 ------
 3 files changed, 12 insertions(+), 8 deletions(-)
 create mode 100644 kernel/modsign_certificate.S

--- a/kernel/Makefile
+++ b/kernel/Makefile
@@ -51,7 +51,7 @@ obj-$(CONFIG_DEBUG_SPINLOCK) += spinlock
 obj-$(CONFIG_PROVE_LOCKING) += spinlock.o
 obj-$(CONFIG_UID16) += uid16.o
 obj-$(CONFIG_MODULES) += module.o
-obj-$(CONFIG_MODULE_SIG) += module_signing.o modsign_pubkey.o
+obj-$(CONFIG_MODULE_SIG) += module_signing.o modsign_pubkey.o modsign_certificate.o
 obj-$(CONFIG_KALLSYMS) += kallsyms.o
 obj-$(CONFIG_STACK_UNWIND) += unwind.o
 obj-$(CONFIG_PM) += power/
@@ -149,7 +149,7 @@ ifeq ($(CONFIG_MODULE_SIG),y)
 extra_certificates:
 	touch $@
 
-kernel/modsign_pubkey.o: signing_key.x509 extra_certificates
+kernel/modsign_certificate.o: signing_key.x509 extra_certificates
 
 ###############################################################################
 #
--- /dev/null
+++ b/kernel/modsign_certificate.S
@@ -0,0 +1,10 @@
+#include <linux/linkage.h>
+
+	.section ".init.data","aw"
+
+	.globl modsign_certificate_list
+modsign_certificate_list:
+	.incbin "signing_key.x509"
+	.incbin "extra_certificates"
+	.globl modsign_certificate_list_end
+modsign_certificate_list_end:
--- a/kernel/modsign_pubkey.c
+++ b/kernel/modsign_pubkey.c
@@ -21,12 +21,6 @@ struct key *modsign_keyring;
 
 extern __initdata const u8 modsign_certificate_list[];
 extern __initdata const u8 modsign_certificate_list_end[];
-asm(".section .init.data,\"aw\"\n"
-    "modsign_certificate_list:\n"
-    ".incbin \"signing_key.x509\"\n"
-    ".incbin \"extra_certificates\"\n"
-    "modsign_certificate_list_end:"
-    );
 
 /*
  * We need to make sure ccache doesn't cache the .o file as it doesn't notice
