From: Chris Mason <chris.mason@oracle.com>
Date: Thu, 18 Mar 2010 12:14:54 -0400
Subject: [PATCH] Btrfs: return keys for large items to the search ioctl
Git-commit: 90fdde147fd32d18a20be5b498d5f26e56cca8a3
Patch-mainline: v2.6.34-rc4

The search ioctl was skipping large items entirely (ones that are too
big for the results buffer).  This changes things to at least copy
the item header so that we can send information about the item back to
userland.

Signed-off-by: Chris Mason <chris.mason@oracle.com>
Acked-by: Jeff Mahoney <jeffm@suse.com>
---

 fs/btrfs/ioctl.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/fs/btrfs/ioctl.c b/fs/btrfs/ioctl.c
index 291aa51..fd757f5 100644
--- a/fs/btrfs/ioctl.c
+++ b/fs/btrfs/ioctl.c
@@ -997,8 +997,8 @@ static noinline int copy_to_sk(struct btrfs_root *root,
 			read_extent_buffer(leaf, p,
 					   item_off, item_len);
 			*sk_offset += item_len;
-			found++;
 		}
+		found++;
 
 		if (*num_found >= sk->nr_items)
 			break;
