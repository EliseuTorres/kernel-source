From: James Bottomley <jbottomley@parallels.com>
Date: Thu, 25 Apr 2013 11:24:13 +0200
Subject: block: fix discard merging limits
Patch-Mainline: submitted to linux-scsi
References: bnc#813643

Few drivers(e.g. mmc, mtd..) set q->limits.max_discard_sectors
more than UINT_MAX >> 9 sectors which is incorrect and it may
lead to overflow of request's __data_len field if merged discard
request's size exceeds 4GB.

Signed-off-by: James Bottomley <jbottomley@parallels.com>
Signed-off-by: Hannes Reinecke <hare@suse.de>

diff --git a/include/linux/blkdev.h b/include/linux/blkdev.h
index 9942006..b4f6c52 100644
--- a/include/linux/blkdev.h
+++ b/include/linux/blkdev.h
@@ -786,7 +786,7 @@ static inline unsigned int blk_queue_get_max_sectors(struct request_queue *q,
 						     unsigned int cmd_flags)
 {
 	if (unlikely(cmd_flags & REQ_DISCARD))
-		return q->limits.max_discard_sectors;
+		return min(q->limits.max_discard_sectors, UINT_MAX >> 9);
 
 	return q->limits.max_sectors;
 }
