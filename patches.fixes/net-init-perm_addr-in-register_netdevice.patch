From: Jiri Pirko <jiri@resnulli.us>
Date: Tue, 8 Jan 2013 01:38:25 +0000
Subject: net: init perm_addr in register_netdevice()
Patch-mainline: v3.9-rc1
Git-commit: 948b337e62ca96b6e7de06fdd5f6fe44769d7e9c
References: bug#909498 FATE#317395

Benefit from the fact that dev->addr_assign_type is set to NET_ADDR_PERM
in case the device has permanent address.

This also fixes the problem that many drivers do not set perm_addr at
all.

Signed-off-by: Jiri Pirko <jiri@resnulli.us>
Signed-off-by: David S. Miller <davem@davemloft.net>
Acked-by: Benjamin Poirier <bpoirier@suse.de>
---
 net/core/dev.c |    7 +++++++
 1 file changed, 7 insertions(+)

--- a/net/core/dev.c
+++ b/net/core/dev.c
@@ -5544,6 +5544,13 @@ int register_netdevice(struct net_device
 	list_netdevice(dev);
 	add_device_randomness(dev->dev_addr, dev->addr_len);
 
+	/* If the device has permanent device address, driver should
+	 * set dev_addr and also addr_assign_type should be set to
+	 * NET_ADDR_PERM (default value).
+	 */
+	if (dev->addr_assign_type == NET_ADDR_PERM)
+		memcpy(dev->perm_addr, dev->dev_addr, dev->addr_len);
+
 	/* Notify protocols, that a new device appeared. */
 	ret = call_netdevice_notifiers(NETDEV_REGISTER, dev);
 	ret = notifier_to_errno(ret);
