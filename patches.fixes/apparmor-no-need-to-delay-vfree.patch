From: Al Viro <viro@ZenIV.linux.org.uk>
Date: Mon, 6 May 2013 03:10:35 +0100
Subject: apparmor: no need to delay vfree()
Patch-mainline: v3.11-rc1
Git-commit: b5b3ee6c9cca8b6e1aa8c757e570f08f802c5573
References: bug#919382 FATE#317529

vfree() can be called from interrupt contexts now

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Acked-by: John Johansen <john.johansen@canonical.com>
Signed-off-by: James Morris <james.l.morris@oracle.com>
Acked-by: Benjamin Poirier <bpoirier@suse.de>
---
 security/apparmor/lib.c |   24 +++---------------------
 1 file changed, 3 insertions(+), 21 deletions(-)

--- a/security/apparmor/lib.c
+++ b/security/apparmor/lib.c
@@ -101,19 +101,6 @@ void *kvmalloc(size_t size)
 }
 
 /**
- * do_vfree - workqueue routine for freeing vmalloced memory
- * @work: data to be freed
- *
- * The work_struct is overlaid to the data being freed, as at the point
- * the work is scheduled the data is no longer valid, be its freeing
- * needs to be delayed until safe.
- */
-static void do_vfree(struct work_struct *work)
-{
-	vfree(work);
-}
-
-/**
  * kvfree - free an allocation do by kvmalloc
  * @buffer: buffer to free (MAYBE_NULL)
  *
@@ -121,13 +108,8 @@ static void do_vfree(struct work_struct
  */
 void kvfree(void *buffer)
 {
-	if (is_vmalloc_addr(buffer)) {
-		/* Data is no longer valid so just use the allocated space
-		 * as the work_struct
-		 */
-		struct work_struct *work = (struct work_struct *) buffer;
-		INIT_WORK(work, do_vfree);
-		schedule_work(work);
-	} else
+	if (is_vmalloc_addr(buffer))
+		vfree(buffer);
+	else
 		kfree(buffer);
 }
