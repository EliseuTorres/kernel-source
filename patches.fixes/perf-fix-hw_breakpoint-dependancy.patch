From:  Frederic Weisbecker <fweisbec@gmail.com>
Git-commit: 99e8c5a3b875a34d894a711c9a3669858d6adf45
Date: Thu Dec 17 01:33:54 2009 +0100
Subject: hw-breakpoints: Fix hardware breakpoints -> perf events dependency
Patch-mainline: v2.6.33-rc3
References: FATE#311653, BNC#702123
Signed-off-by: Tony Jones <tonyj@suse.de>

    hw-breakpoints: Fix hardware breakpoints -> perf events dependency
    
    The kbuild's select command doesn't propagate through the config
    dependencies.
    
    Hence the current rules of hardware breakpoint's config can't
    ensure perf can never be disabled under us.
    
    We have:
    
    config X86
    	selects HAVE_HW_BREAKPOINTS
    
    config HAVE_HW_BREAKPOINTS
    	select PERF_EVENTS
    
    config PERF_EVENTS
    	[...]
    
    x86 will select the breakpoints but that won't propagate to perf
    events. The user can still disable the latter, but it is
    necessary for the breakpoints.
    
    What we need is:
    
     - x86 selects HAVE_HW_BREAKPOINTS and PERF_EVENTS
     - HAVE_HW_BREAKPOINTS depends on PERF_EVENTS
    
    so that we ensure PERF_EVENTS is enabled and frozen for x86.
    
    This fixes the following kind of build errors:
    
     In file included from arch/x86/kernel/hw_breakpoint.c:31:
     include/linux/hw_breakpoint.h: In function 'hw_breakpoint_addr':
     include/linux/hw_breakpoint.h:39: error: 'struct perf_event' has no member named 'attr'
    
    v2: Select also ANON_INODES from x86, required for perf
    
    Reported-by: Cyrill Gorcunov <gorcunov@gmail.com>
    Reported-by: Michal Marek <mmarek@suse.cz>
    Reported-by: Andrew Randrianasulu <randrik_a@yahoo.com>
    Signed-off-by: Frederic Weisbecker <fweisbec@gmail.com>
    Cc: Peter Zijlstra <peterz@infradead.org>
    Cc: Arnaldo Carvalho de Melo <acme@redhat.com>
    Cc: Paul Mackerras <paulus@samba.org>
    Cc: Randy Dunlap <randy.dunlap@oracle.com>
    Cc: K.Prasad <prasad@linux.vnet.ibm.com>
    LKML-Reference: <1261010034-7786-1-git-send-regression-fweisbec@gmail.com>
    Signed-off-by: Ingo Molnar <mingo@elte.hu>

---
 arch/Kconfig     |    4 +---
 arch/x86/Kconfig |    2 ++
 2 files changed, 3 insertions(+), 3 deletions(-)

--- a/arch/Kconfig
+++ b/arch/Kconfig
@@ -112,9 +112,7 @@ config HAVE_DEFAULT_NO_SPIN_MUTEXES
 
 config HAVE_HW_BREAKPOINT
 	bool
-	depends on HAVE_PERF_EVENTS
-	select ANON_INODES
-	select PERF_EVENTS
+	depends on PERF_EVENTS
 
 
 config HAVE_ARCH_MUTEX_CPU_RELAX
--- a/arch/x86/Kconfig
+++ b/arch/x86/Kconfig
@@ -50,6 +50,8 @@ config X86
 	select HAVE_KERNEL_BZIP2
 	select HAVE_KERNEL_LZMA
 	select HAVE_HW_BREAKPOINT
+	select PERF_EVENTS
+	select ANON_INODES
 	select HAVE_ARCH_KMEMCHECK
 
 config OUTPUT_FORMAT
