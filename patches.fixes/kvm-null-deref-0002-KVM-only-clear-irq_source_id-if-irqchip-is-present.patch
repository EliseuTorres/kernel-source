From: Marcelo Tosatti <mtosatti@redhat.com>
Date: Thu, 29 Oct 2009 13:44:17 -0200
Subject: [PATCH 2/2] KVM: only clear irq_source_id if irqchip is present
Patch-mainline: 2.6.34
References: bnc#589654
Git-commit: e50212bb51356f0df48d6cce0aae5acf41df336d

Otherwise kvm might attempt to dereference a NULL pointer.

Signed-off-by: Marcelo Tosatti <mtosatti@redhat.com>
Signed-off-by: Avi Kivity <avi@redhat.com>
Signed-off-by: Alexander Graf <agraf@suse.de>
---
 virt/kvm/irq_comm.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/virt/kvm/irq_comm.c b/virt/kvm/irq_comm.c
index 5288885..928430c 100644
--- a/virt/kvm/irq_comm.c
+++ b/virt/kvm/irq_comm.c
@@ -237,6 +237,9 @@ void kvm_free_irq_source_id(struct kvm *kvm, int irq_source_id)
 	if (!irqchip_in_kernel(kvm))
 		goto unlock;
 
+	if (!irqchip_in_kernel(kvm))
+		goto unlock;
+
 	for (i = 0; i < KVM_IOAPIC_NUM_PINS; i++)
 		clear_bit(irq_source_id, &kvm->arch.irq_states[i]);
 unlock:
-- 
1.6.0.2

