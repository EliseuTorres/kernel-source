From: Konstantin Khlebnikov <koct9i@gmail.com>
Subject: [PATCH] mm: fix corner case in anon_vma endless growing prevention
Patch-mainline: 3.19-rc4
References: bnc#904242
Git-commit: b800c91a0517071156e772d4fb329ad33590da62

Fix for BUG_ON(anon_vma->degree) splashes in unlink_anon_vmas()
("kernel BUG at mm/rmap.c:399!").

Anon_vma_clone() is usually called for a copy of source vma in destination
argument. If source vma has anon_vma it should be already in dst->anon_vma.
NULL in dst->anon_vma is used as a sign that it's called from anon_vma_fork().
In this case anon_vma_clone() finds anon_vma for reusing.

Vma_adjust() calls it differently and this breaks anon_vma reusing logic:
anon_vma_clone() links vma to old anon_vma and updates degree counters but
vma_adjust() overrides vma->anon_vma right after that. As a result final
unlink_anon_vmas() decrements degree for wrong anon_vma.

This patch assigns ->anon_vma before calling anon_vma_clone().

Signed-off-by: Konstantin Khlebnikov <koct9i@gmail.com>
Fixes: 7a3ef208e662 ("mm: prevent endless growth of anon_vma hierarchy")
Tested-by: Chris Clayton <chris2553@googlemail.com>
Tested-by: Oded Gabbay <oded.gabbay@amd.com>
Cc: Daniel Forrest <dan.forrest@ssec.wisc.edu>
Acked-by: Michal Hocko <mhocko@suse.cz>
Cc: Rik van Riel <riel@redhat.com>

---
 mm/mmap.c |    6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

--- a/mm/mmap.c
+++ b/mm/mmap.c
@@ -574,9 +574,11 @@ again:			remove_next = 1 + (end > next->
 		 * shrinking vma had, to cover any anon pages imported.
 		 */
 		if (exporter && exporter->anon_vma && !importer->anon_vma) {
-			if (anon_vma_clone(importer, exporter))
-				return -ENOMEM;
 			importer->anon_vma = exporter->anon_vma;
+			if (anon_vma_clone(importer, exporter)) {
+				importer->anon_vma = NULL;
+				return -ENOMEM;
+			}
 		}
 	}
 
