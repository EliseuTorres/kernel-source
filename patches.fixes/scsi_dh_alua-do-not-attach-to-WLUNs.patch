From: Hannes Reinecke <hare@suse.de>
Date: Wed, 29 May 2013 14:36:50 +0200
Subject: scsi_dh_alua: Do not attach to well-known LUNs
References: bnc#821980
Patch-Mainline: not yet

Well-known LUNs might come in either as device type 0x1E or
0x1F. As the latter cannot support ALUA in either case we should
disable ALUA for the entire device type. And we need to add
a check for the WLUN number itself.

Signed-off-by: Hannes Reinecke <hare@suse.de>

diff --git a/drivers/scsi/device_handler/scsi_dh_alua.c b/drivers/scsi/device_handler/scsi_dh_alua.c
index d795ca5..9a09356 100644
--- a/drivers/scsi/device_handler/scsi_dh_alua.c
+++ b/drivers/scsi/device_handler/scsi_dh_alua.c
@@ -327,13 +327,22 @@ static int alua_check_tpgs(struct scsi_device *sdev, struct alua_dh_data *h)
 {
 	int err = SCSI_DH_OK;
 
-	if (sdev->type == TYPE_RAID || sdev->type == TYPE_ENCLOSURE) {
+	if (sdev->type == TYPE_RAID ||
+	    sdev->type == TYPE_ENCLOSURE ||
+	    sdev->type == 0x1F) {
 		h->tpgs = TPGS_MODE_NONE;
 		sdev_printk(KERN_INFO, sdev,
 			    "%s: disable for enclosure devices\n",
 			    ALUA_DH_NAME);
 		return SCSI_DH_DEV_UNSUPP;
 	}
+	if (scsi_is_wlun(sdev->lun)) {
+		h->tpgs = TPGS_MODE_NONE;
+		sdev_printk(KERN_INFO, sdev,
+			    "%s: disable for WLUN\n",
+			    ALUA_DH_NAME);
+		return SCSI_DH_DEV_UNSUPP;
+	}
 
 	h->tpgs = scsi_device_tpgs(sdev);
 	switch (h->tpgs) {
