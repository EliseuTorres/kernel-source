From: "H. Peter Anvin" <hpa@zytor.com>
Date: Fri, 20 Apr 2012 12:19:50 -0700
Subject: x86, extable: Remove open-coded exception table entries in
	arch/x86/kernel/entry_64.S
Git-commit: d7abc0fa997972ddb6d3c403e03a6eefda0c0881
Patch-mainline: v3.5-rc1
References: bsc#907818,CVE-2014-9090

Remove open-coded exception table entries in arch/x86/kernel/entry_64.S,
and replace them with _ASM_EXTABLE() macros; this will allow us to
change the format and type of the exception table entries.

Signed-off-by: H. Peter Anvin <hpa@zytor.com>
Cc: David Daney <david.daney@cavium.com>
Link: http://lkml.kernel.org/r/CA%2B55aFyijf43qSu3N9nWHEBwaGbb7T2Oq9A=9EyR=Jtyqfq_cQ@mail.gmail.com

Acked-by: Borislav Petkov <bp@suse.de>
---
 arch/x86/kernel/entry_64.S | 16 ++++------------
 1 file changed, 4 insertions(+), 12 deletions(-)

Index: kernel/arch/x86/kernel/entry_64.S
===================================================================
--- kernel.orig/arch/x86/kernel/entry_64.S
+++ kernel/arch/x86/kernel/entry_64.S
@@ -53,6 +53,7 @@
 #include <asm/paravirt.h>
 #include <asm/ftrace.h>
 #include <asm/percpu.h>
+#include <asm/asm.h>
 
 /* Avoid __ASSEMBLER__'ifying <linux/audit.h> just for this.  */
 #include <linux/elf-em.h>
@@ -867,18 +868,12 @@ restore_args:
 
 irq_return:
 	INTERRUPT_RETURN
-
-	.section __ex_table, "a"
-	.quad irq_return, bad_iret
-	.previous
+	_ASM_EXTABLE(irq_return, bad_iret)
 
 #ifdef CONFIG_PARAVIRT
 ENTRY(native_iret)
 	iretq
-
-	.section __ex_table,"a"
-	.quad native_iret, bad_iret
-	.previous
+	_ASM_EXTABLE(native_iret, bad_iret)
 #endif
 
 	.section .fixup,"ax"
@@ -1150,10 +1145,7 @@ gs_change:
 	CFI_ENDPROC
 END(native_load_gs_index)
 
-	.section __ex_table,"a"
-	.align 8
-	.quad gs_change,bad_gs
-	.previous
+	_ASM_EXTABLE(gs_change,bad_gs)
 	.section .fixup,"ax"
 	/* running with kernelgs */
 bad_gs:
