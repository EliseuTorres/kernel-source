From: Brian King <brking@linux.vnet.ibm.com>
Subject: ibmvfc: Reduce error recovery timeout
Patch-mainline: 2.6.34
References: bnc#598270

If a command times out resulting in EH getting invoked, we wait for the
aborted commands to come back after sending the abort. Shorten
the amount of time we wait for these responses, to ensure we don't
get stuck in EH for several minutes.

Signed-off-by: Brian King <brking@linux.vnet.ibm.com>
Acked-by: Torsten Duwe <duwe@suse.de>

---

 drivers/scsi/ibmvscsi/ibmvfc.c |    2 +-
 drivers/scsi/ibmvscsi/ibmvfc.h |    1 +
 2 files changed, 2 insertions(+), 1 deletion(-)

diff -puN drivers/scsi/ibmvscsi/ibmvfc.c~ibmvfc_shorter_abort_wait drivers/scsi/ibmvscsi/ibmvfc.c
--- linux-2.6.32.9-0.5/drivers/scsi/ibmvscsi/ibmvfc.c~ibmvfc_shorter_abort_wait	2010-04-20 09:56:12.000000000 -0500
+++ linux-2.6.32.9-0.5-bjking1/drivers/scsi/ibmvscsi/ibmvfc.c	2010-04-20 09:56:12.000000000 -0500
@@ -1969,7 +1969,7 @@ static int ibmvfc_wait_for_ops(struct ib
 	DECLARE_COMPLETION_ONSTACK(comp);
 	int wait;
 	unsigned long flags;
-	signed long timeout = init_timeout * HZ;
+	signed long timeout = IBMVFC_ABORT_WAIT_TIMEOUT * HZ;
 
 	ENTER;
 	do {
diff -puN drivers/scsi/ibmvscsi/ibmvfc.h~ibmvfc_shorter_abort_wait drivers/scsi/ibmvscsi/ibmvfc.h
--- linux-2.6.32.9-0.5/drivers/scsi/ibmvscsi/ibmvfc.h~ibmvfc_shorter_abort_wait	2010-04-20 09:56:12.000000000 -0500
+++ linux-2.6.32.9-0.5-bjking1/drivers/scsi/ibmvscsi/ibmvfc.h	2010-04-20 09:56:12.000000000 -0500
@@ -38,6 +38,7 @@
 #define IBMVFC_ADISC_PLUS_CANCEL_TIMEOUT	\
 		(IBMVFC_ADISC_TIMEOUT + IBMVFC_ADISC_CANCEL_TIMEOUT)
 #define IBMVFC_INIT_TIMEOUT		120
+#define IBMVFC_ABORT_WAIT_TIMEOUT	40
 #define IBMVFC_MAX_REQUESTS_DEFAULT	100
 
 #define IBMVFC_DEBUG			0
_
