From: Nan Li <nli@suse.com>
Date: Wed, 3 Dec 2014 21:29:33 +0100
Subject: virtio_net: drop dst reference before transmitting a packet
Patch-mainline: Never, upstream solution too intrusive
References: bnc#882470

In virtio_net driver, queue cleanup is only done when a packet is
transmitted. Therefore if the outgoing traffic is low, a packet can stay
in the queue for a long time. As it holds a reference to dst entry, it
can prevent removal of the network namespace it was created and routed
in.

A proper solution would be implementing Tx interrupts and cleanup
transmitted packets in response to them. Such solution is still under
discussion in upstream and would be out of scope of a maintenance
updated. Thus a simple workaround was chosen for SLE11-SP3 and SLE12:
just drop the dst reference in start_xmit().

Signed-off-by: Nan Li <nli@suse.com>
Acked-by: Michal Kubecek <mkubecek@suse.cz>
---
 drivers/net/virtio_net.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/drivers/net/virtio_net.c b/drivers/net/virtio_net.c
index 32af9f5..1481319 100644
--- a/drivers/net/virtio_net.c
+++ b/drivers/net/virtio_net.c
@@ -26,6 +26,7 @@
 #include <linux/scatterlist.h>
 #include <linux/if_vlan.h>
 #include <linux/slab.h>
+#include <net/dst.h>
 
 static int napi_weight = 128;
 module_param(napi_weight, int, 0444);
@@ -606,6 +607,7 @@ static netdev_tx_t start_xmit(struct sk_buff *skb, struct net_device *dev)
 	virtqueue_kick(vi->svq);
 
 	/* Don't wait up for transmitted skbs to be freed. */
+	skb_dst_drop(skb);
 	skb_orphan(skb);
 	nf_reset(skb);
 
-- 
1.8.4.5

