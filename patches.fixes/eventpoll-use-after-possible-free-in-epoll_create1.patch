From 3005d6bdf862fe92ab99c6876ed00ffcf9dc14be Mon Sep 17 00:00:00 2001
From: Al Viro <viro@zeniv.linux.org.uk>
Date: Thu, 16 Apr 2015 08:33:57 -0700
Subject: [PATCH] eventpoll: use-after-possible-free in epoll_create1()
Git-commit: 98022748f6c7bce85b9f123fd4d1a621219dd8d9
Patch-mainline: v3.6-rc3
References: bug#917648

As soon as we'd installed the file into descriptor table, it can
get closed by another thread.  Freeing ep in process...

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Davidlohr Bueso <dbueso@suse.de>

---
 fs/eventpoll.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/fs/eventpoll.c b/fs/eventpoll.c
index 154652b..25e9e9d 100644
--- a/fs/eventpoll.c
+++ b/fs/eventpoll.c
@@ -1594,8 +1594,8 @@ SYSCALL_DEFINE1(epoll_create1, int, flags)
 		error = PTR_ERR(file);
 		goto out_free_fd;
 	}
-	fd_install(fd, file);
 	ep->file = file;
+	fd_install(fd, file);
 	return fd;
 
 out_free_fd:
-- 
2.1.4

