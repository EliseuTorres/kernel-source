From: Jan Kara <jack@suse.cz>
Subject: writeback: pay attention to wbc->nr_to_write in write_cache_pages
Patch-mainline: 2.6.35-rc3
References: bnc#699354
Git-commit: 8d7458daea2a6809d32418bf489b949d23de99ea

If a filesystem writes more than one page in ->writepage, write_cache_pages
fails to notice this and continues to attempt writeback when wbc->nr_to_write
has gone negative - this trace was captured from XFS:

    wbc_writeback_start: towrt=1024
    wbc_writepage: towrt=1024
    wbc_writepage: towrt=0
    wbc_writepage: towrt=-1
    wbc_writepage: towrt=-5
    wbc_writepage: towrt=-21
    wbc_writepage: towrt=-85

This has adverse effects on filesystem writeback behaviour. write_cache_pages()
needs to terminate after a certain number of pages are written, not after a
certain number of calls to ->writepage are made. Fix the problem by using
wbc->nr_to_write in case no_nrwrite_index_update is not set instead of a
local variable.

This is a regression introduced by 17bc6c30cf6bfffd816bdc53682dd46fc34a2cf4
("vfs: Add no_nrwrite_index_update writeback control flag").

Signed-off-by: Jan Kara <jack@suse.cz>

Index: linux-2.6.32-SLE11-SP1/mm/page-writeback.c
===================================================================
--- linux-2.6.32-SLE11-SP1.orig/mm/page-writeback.c
+++ linux-2.6.32-SLE11-SP1/mm/page-writeback.c
@@ -939,9 +939,10 @@ continue_unlock:
 				}
  			}
 
-			if (nr_to_write > 0) {
-				nr_to_write--;
-				if (nr_to_write == 0 &&
+			if (!wbc->no_nrwrite_index_update) {
+				if (wbc->nr_to_write > 0)
+					wbc->nr_to_write--;
+				if (wbc->nr_to_write == 0 &&
 				    wbc->sync_mode == WB_SYNC_NONE) {
 					/*
 					 * We stop writing back only if we are
@@ -956,6 +957,13 @@ continue_unlock:
 					done = 1;
 					break;
 				}
+			} else if (nr_to_write > 0) {
+				nr_to_write--;
+				if (nr_to_write == 0 &&
+				    wbc->sync_mode == WB_SYNC_NONE) {
+					done = 1;
+					break;
+				}
 			}
 
 			if (wbc->nonblocking && bdi_write_congested(bdi)) {
@@ -979,9 +987,8 @@ continue_unlock:
 		goto retry;
 	}
 	if (!wbc->no_nrwrite_index_update) {
-		if (wbc->range_cyclic || (range_whole && nr_to_write > 0))
+		if (wbc->range_cyclic || (range_whole && wbc->nr_to_write > 0))
 			mapping->writeback_index = done_index;
-		wbc->nr_to_write = nr_to_write;
 	}
 
 	return ret;
