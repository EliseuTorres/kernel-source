From: Hannes Reinecke <hare@suse.de>
Date: Wed, 16 Nov 2011 14:34:00 +0100
Subject: dm-multipath: Do not call request_module for existing hw_handlers
Patch-Mainline: not yet
References: bnc#721738

We first should check if the hardware handler is already loaded
before calling out to request_module(). Otherwise the system
might stall in an all-paths-down scenario.

Signed-off-by: Hannes Reinecke <hare@suse.de>

diff --git a/drivers/md/dm-mpath.c b/drivers/md/dm-mpath.c
index c2a332b..8849c30 100644
--- a/drivers/md/dm-mpath.c
+++ b/drivers/md/dm-mpath.c
@@ -796,11 +796,13 @@ static int parse_hw_handler(struct arg_set *as, struct multipath *m)
 	}
 
 	m->hw_handler_name = kstrdup(shift(as), GFP_KERNEL);
-	request_module("scsi_dh_%s", m->hw_handler_name);
 	if (scsi_dh_handler_exist(m->hw_handler_name) == 0) {
-		ti->error = "unknown hardware handler type";
-		ret = -EINVAL;
-		goto fail;
+		request_module("scsi_dh_%s", m->hw_handler_name);
+		if (scsi_dh_handler_exist(m->hw_handler_name) == 0) {
+			ti->error = "unknown hardware handler type";
+			ret = -EINVAL;
+			goto fail;
+		}
 	}
 
 	if (hw_argc > 1) {
