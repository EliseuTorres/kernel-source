From: Stefan Weinhuber <wein@de.ibm.com>
Subject: I/O stalls when writing to a reserved DASD
References: bnc#735543
Patch-Mainline: not yet

When writing to a reserved DASD the I/O stalls.
Problem is that after exhausting all retries the DASD
driver will start ERP, but the commands are sent without
any expiry set, hence they will never timeout.

Signed-off-by: Stefan Weinhuber <wein@de.ibm.com>
Acked-by: Hannes Reinecke <hare@suse.de> 
---
 drivers/s390/block/dasd_3990_erp.c |    4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

--- a/drivers/s390/block/dasd_3990_erp.c
+++ b/drivers/s390/block/dasd_3990_erp.c
@@ -1718,7 +1718,7 @@ dasd_3990_erp_action_1B_32(struct dasd_c
 	erp->startdev = device;
 	erp->memdev = device;
 	erp->magic = default_erp->magic;
-	erp->expires = 0;
+	erp->expires = default_erp->expires;
 	erp->retries = 256;
 	erp->buildclk = get_clock();
 	erp->status = DASD_CQR_FILLED;
@@ -2363,7 +2363,7 @@ static struct dasd_ccw_req *dasd_3990_er
 	erp->memdev   = device;
 	erp->block    = cqr->block;
 	erp->magic    = cqr->magic;
-	erp->expires  = 0;
+	erp->expires  = cqr->expires;
 	erp->retries  = 256;
 	erp->buildclk = get_clock();
 	erp->status = DASD_CQR_FILLED;
