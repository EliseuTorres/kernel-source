From: Richard Lary <rlary@us.ibm.com>
Subject: Re-save PCI state after EEH recovery
References: bnc#570233
Patch-Mainline: 2.6.33

This patch was included in the ibm patch in bnc#565878
but was missed in the rollup patch in this bug.

It is required for EEH recovery to resave the pci_state after an eeh recovery
restores the previously saved pci_state.

Acked-by: David Wagner <david.wagner@qlogic.com>
Acked-by: Hannes Reinecke <hare@suse.de>

diff --git a/drivers/scsi/qla2xxx/qla_os.c b/drivers/scsi/qla2xxx/qla_os.c
index b58ccb7..c8078ec 100644
--- a/drivers/scsi/qla2xxx/qla_os.c
+++ b/drivers/scsi/qla2xxx/qla_os.c
@@ -3346,6 +3346,10 @@ qla2xxx_pci_slot_reset(struct pci_dev *pdev)
 	pdev->error_state = pci_channel_io_normal;
 
 	pci_restore_state(pdev);
+	/* pci_restore_state() clears the saved_state flag of the device
+	 * save restored state which resets saved_state flag
+	 */
+	pci_save_state(pdev);
 
 	if (ha->mem_only)
 		rc = pci_enable_device_mem(pdev);
