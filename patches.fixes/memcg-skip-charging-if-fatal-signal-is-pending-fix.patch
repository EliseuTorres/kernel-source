From: Michal Hocko <mhocko@suse.cz>
Subject: memcg: Put controller reference when bypassing charging due to fatal signal
Patch-mainline: no
References: bnc#700009

patches.suse/memcg-skip-charging-if-fatal-signal-is-pending.patch introduced
a controller reference leak because fatal_signal_pending check, which is called
after we have increased reference to controller, doesn't decrease it back.

Signed-off-by: Michal Hocko <mhocko@suse.cz>

Index: linux-2.6.32-fate312042/mm/memcontrol.c
===================================================================
--- linux-2.6.32-fate312042.orig/mm/memcontrol.c
+++ linux-2.6.32-fate312042/mm/memcontrol.c
@@ -1555,8 +1555,10 @@ static int __mem_cgroup_try_charge(struc
 			goto charged;
 
 		/* If killed, bypass charge */
-		if (fatal_signal_pending(current))
+		if (fatal_signal_pending(current)) {
+			css_put(&mem->css);
 			goto bypass;
+		}
 
 		ret = res_counter_charge(&mem->res, bytes, &fail_res);
 		if (likely(!ret)) {
