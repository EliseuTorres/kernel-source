From: Herton Ronaldo Krzesinski <herton.krzesinski@canonical.com>
Date: Wed, 6 Jul 2011 13:16:25 +0000
Subject: [PATCH] block: check for QUEUE_FLAG_DEAD in elv_put_request
References: bko#38842,bnc#714215
Patch-Mainline: Not yet

As in __elv_next_request, after blk_cleanup_queue()->elevator_exit() is
called, we can't touch the elevator too. elv_put_request can be
called after blk_cleanup_queue, as shown in one of the traces on
https://bugs.launchpad.net/bugs/793796, where scsi code ends up being
able to trigger this condition.

Signed-off-by: Herton Ronaldo Krzesinski <herton.krzesinski@canonical.com>
Signed-off-by: Hannes Reinecke <hare@suse.de>
---
 block/elevator.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/block/elevator.c b/block/elevator.c
index 4d4e04b..9155614 100644
--- a/block/elevator.c
+++ b/block/elevator.c
@@ -772,7 +772,8 @@ void elv_put_request(struct request_queue *q, struct request *rq)
 {
 	struct elevator_queue *e = q->elevator;
 
-	if (e->ops->elevator_put_req_fn)
+	if (!test_bit(QUEUE_FLAG_DEAD, &q->queue_flags) &&
+	    e->ops->elevator_put_req_fn)
 		e->ops->elevator_put_req_fn(rq);
 }
 
-- 
1.6.0.2

