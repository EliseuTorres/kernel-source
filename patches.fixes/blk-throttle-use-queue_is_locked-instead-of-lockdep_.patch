From: Jens Axboe <axboe@kernel.dk>
Date: Tue, 25 Oct 2011 15:51:48 +0200
Subject: blk-throttle: use queue_is_locked() instead of lockdep_is_held()
Git-commit: 334c2b0b8b2ab186fa198413386cba41fffcb4f2
References: bnc#778477
Patch-Mainline: v3.2

We can't use the latter if !CONFIG_LOCKDEP.

Reported-by: Sedat Dilek <sedat.dilek@googlemail.com>
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Acked-by: Hannes Reinecke <hare@suse.de>
---
 block/blk-throttle.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/block/blk-throttle.c b/block/blk-throttle.c
index d1508cb..380afb8 100644
--- a/block/blk-throttle.c
+++ b/block/blk-throttle.c
@@ -1219,7 +1219,7 @@ void blk_throtl_drain(struct request_queue *q)
 	struct bio_list bl;
 	struct bio *bio;
 
-	lockdep_is_held(q->queue_lock);
+	WARN_ON_ONCE(!queue_is_locked(q));
 
 	bio_list_init(&bl);
 
-- 
1.7.10.4

