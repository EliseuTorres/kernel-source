From: Hannes Reinecke <hare@suse.de>
Date: Fri, 1 Oct 2010 10:15:11 +0200
Subject: scsi_dh: Check for sdev state in scsi_dh_activate()
References: bnc#616080
Patch-Mainline: Submitted to linux-scsi

Calling scsi_dh_activate might race with device removal,
so we should be checking for a valid sdev state here.
Otherwise we might end up accessing invalid pointers.


Signed-off-by: Hannes Reinecke <hare@suse.de>

diff --git a/drivers/scsi/device_handler/scsi_dh.c b/drivers/scsi/device_handler/scsi_dh.c
index d06b8fe..2550a42 100644
--- a/drivers/scsi/device_handler/scsi_dh.c
+++ b/drivers/scsi/device_handler/scsi_dh.c
@@ -211,6 +211,10 @@ store_dh_state(struct device *dev, struct device_attribute *attr,
 	struct scsi_device_handler *scsi_dh;
 	int err = -EINVAL;
 
+	if (sdev->state == SDEV_CANCEL ||
+	    sdev->state == SDEV_DEL)
+	    return -EBUSY;
+
 	if (!sdev->scsi_dh_data) {
 		/*
 		 * Attach to a device handler
@@ -448,6 +452,9 @@ int scsi_dh_activate(struct request_queue *q, activate_complete fn, void *data)
 		scsi_dh = sdev->scsi_dh_data->scsi_dh;
 	if (!scsi_dh || !get_device(&sdev->sdev_gendev))
 		err = SCSI_DH_NOSYS;
+	if (sdev->state == SDEV_CANCEL ||
+	    sdev->state == SDEV_DEL)
+		err = SCSI_DH_DEV_OFFLINED;
 	spin_unlock_irqrestore(q->queue_lock, flags);
 
 	if (err)
