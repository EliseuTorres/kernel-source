From: "Paul E. McKenney" <paulmck@linux.vnet.ibm.com>
Date: Wed, 3 Aug 2011 03:34:24 -0700
Subject: rcu: Dump local stack if cannot dump all CPUs' stacks
Git-commit: 4627e240dfee4a0a46a58010b1b721b4ded1918f
Patch-mainline: v3.2-rc1
References: bnc#816586

The trigger_all_cpu_backtrace() function is a no-op in architectures that
do not define arch_trigger_all_cpu_backtrace.  On such architectures, RCU
CPU stall warning messages contain no stack trace information, which makes
debugging quite difficult.  This commit therefore substitutes dump_stack()
for architectures that do not define arch_trigger_all_cpu_backtrace,
so that at least the local CPU's stack is dumped as part of the RCU CPU
stall warning message.

Signed-off-by: Paul E. McKenney <paulmck@linux.vnet.ibm.com>
Acked-by: MIke Galbraith <mgalbraith@suse.de>

---
 kernel/rcutree.c |    6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

--- a/kernel/rcutree.c
+++ b/kernel/rcutree.c
@@ -577,7 +577,8 @@ static void print_other_cpu_stall(struct
 	}
 	printk("} (detected by %d, t=%ld jiffies)\n",
 	       smp_processor_id(), (long)(jiffies - rsp->gp_start));
-	trigger_all_cpu_backtrace();
+	if (!trigger_all_cpu_backtrace())
+		dump_stack();
 
 	/* If so configured, complain about tasks blocking the grace period. */
 
@@ -598,7 +599,8 @@ static void print_cpu_stall(struct rcu_s
 	 */
 	printk(KERN_ERR "INFO: %s detected stall on CPU %d (t=%lu jiffies)\n",
 	       rsp->name, smp_processor_id(), jiffies - rsp->gp_start);
-	trigger_all_cpu_backtrace();
+	if (!trigger_all_cpu_backtrace())
+		dump_stack();
 
 	raw_spin_lock_irqsave(&rnp->lock, flags);
 	if (ULONG_CMP_GE(jiffies, rsp->jiffies_stall))
