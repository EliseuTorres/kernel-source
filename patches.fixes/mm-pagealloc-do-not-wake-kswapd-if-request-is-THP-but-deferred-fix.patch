From: Mel Gorman <mgorman@suse.de>
Date: Tue, 30 Oct 2012 14:09:09 +0000
Subject: [PATCH] mm: page_alloc: Do not wake kswapd if the request is for THP
 but deferred

References: Compaction functionality
Patch-mainline: No (Being tested)

Fix for !CONFIG_HUGEPAGE builds

Signed-off-by: Mel Gorman <mgorman@suse.de>
---
 mm/page_alloc.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/mm/page_alloc.c b/mm/page_alloc.c
index 6fdb665..1a2ff48 100644
--- a/mm/page_alloc.c
+++ b/mm/page_alloc.c
@@ -2222,7 +2222,7 @@ bool gfp_pfmemalloc_allowed(gfp_t gfp_mask)
 /* Returns true if the allocation is likely for THP */
 static bool is_thp_alloc(gfp_t gfp_mask, unsigned int order)
 {
-	if (order == HPAGE_PMD_ORDER &&
+	if (order == pageblock_order &&
 	    (gfp_mask & (__GFP_MOVABLE|__GFP_REPEAT)) == __GFP_MOVABLE)
 		return true;
 	return false;
