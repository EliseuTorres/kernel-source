From: NeilBrown <neilb@suse.de>
Subject: md: Unplug write to external bitmap before waiting
Patch-mainline: 2.6.37
References: bnc#623307

When writing to a bitmap stored in a file (externally) we are waiting
for the write to complete without unplugging the device.  This results in
unneccessary 4ms pauses, particularly noticable on fast storage arrays.

So use BIO_RW_UNPLUG like we do when writing to internal bitmaps.

Acked-by: Neil Brown <neilb@suse.de>
Signed-off-by: Neil Brown <neilb@suse.de>

---
 drivers/md/bitmap.c |    4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

--- linux-2.6.32-SLE11-SP1.orig/drivers/md/bitmap.c
+++ linux-2.6.32-SLE11-SP1/drivers/md/bitmap.c
@@ -351,7 +351,9 @@ static void write_page(struct bitmap *bi
 			atomic_inc(&bitmap->pending_writes);
 			set_buffer_locked(bh);
 			set_buffer_mapped(bh);
-			submit_bh(WRITE, bh);
+			submit_bh(WRITE |
+				  (1<<BIO_RW_SYNCIO) |
+				  (1<<BIO_RW_UNPLUG), bh);
 			bh = bh->b_this_page;
 		}
 
