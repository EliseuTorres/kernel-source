From: Dan Carpenter <error27@gmail.com>
Date: Mon, 10 Jan 2011 04:06:58 +0000
Subject: phonet: some signedness bugs
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit
Patch-mainline: v2.6.38-rc1
Git-commit: facb4edc1e0e849ea98e147a821e60d6d6272c0a
References: bnc#662931

Dan Rosenberg pointed out that there were some signed comparison bugs
in the phonet protocol.

http://marc.info/?l=full-disclosure&m=129424528425330&w=2

The problem is that we check for array overflows but "protocol" is
signed and we don't check for array underflows.  If you have already
have CAP_SYS_ADMIN then you could use the bugs to get root, or someone
could cause an oops by mistake.

Backported-by: Jeff Mahoney <jeffm@suse.com>
Notes: This version of the patch just checks to ensure that protocol is
       positive since changing the prototypes to unsigned int would
       break the kABI (even if it's not supported for SLE).
       Since the valid values for protocol are 0, 1, and 2, this is fine.

Signed-off-by: Dan Carpenter <error27@gmail.com>
Acked-by: RÃ©mi Denis-Courmont <remi.denis-courmont@nokia.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Acked-by: Jeff Mahoney <jeffm@suse.com>
---
 net/phonet/af_phonet.c |    7 +++++++
 1 file changed, 7 insertions(+)

--- a/net/phonet/af_phonet.c
+++ b/net/phonet/af_phonet.c
@@ -44,6 +44,9 @@ static struct phonet_protocol *phonet_pr
 	if (protocol >= PHONET_NPROTO)
 		return NULL;
 
+	if (protocol < 0)
+		return NULL;
+
 	spin_lock(&proto_tab_lock);
 	pp = proto_tab[protocol];
 	if (pp && !try_module_get(pp->prot->owner))
@@ -404,6 +407,8 @@ int __init_or_module phonet_proto_regist
 
 	if (protocol >= PHONET_NPROTO)
 		return -EINVAL;
+	if (protocol < 0)
+		return -EINVAL;
 
 	err = proto_register(pp->prot, 1);
 	if (err)
@@ -422,6 +427,8 @@ EXPORT_SYMBOL(phonet_proto_register);
 
 void phonet_proto_unregister(int protocol, struct phonet_protocol *pp)
 {
+	if (protocol < 0)
+		return;
 	spin_lock(&proto_tab_lock);
 	BUG_ON(proto_tab[protocol] != pp);
 	proto_tab[protocol] = NULL;
