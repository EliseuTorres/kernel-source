From: Hannes Reinecke <hare@suse.de>
Date: Tue, 2 Apr 2013 08:38:55 +0200
Subject: [PATCH] md: cannot re-add disks after recovery
References: bnc#808647
Patch-mainline: queued for 3.11

When a blocked disk becomes on-line again 'mdadm --re-add failed'
will sometimes fail with -EBUSY.
Issue is that the recovery thread has been notified but not yet
started by the time the ioctl is issued. With this patch we're
waiting for the recovery thread to finish, which should avoid
this race.

Signed-off-by: Neil Brown <nfbrown@suse.de>
Signed-off-by: Hannes Reinecke <hare@suse.de>
Acked-by: NeilBrown <neilb@suse.de>

---
 drivers/md/md.c |    8 ++++++++
 1 file changed, 8 insertions(+)

--- linux-3.0-SLE11-SP2.orig/drivers/md/md.c
+++ linux-3.0-SLE11-SP2/drivers/md/md.c
@@ -6279,6 +6279,12 @@ static int md_ioctl(struct block_device
 		/* need to ensure md_delayed_delete() has completed */
 		flush_workqueue(md_misc_wq);
 
+	if (cmd == HOT_REMOVE_DISK)
+		/* need to ensure recovery thread has run */
+		wait_event_interruptible_timeout(mddev->sb_wait,
+						 !test_bit(MD_RECOVERY_NEEDED,
+							   &mddev->flags),
+						 msecs_to_jiffies(5000));
 	err = mddev_lock(mddev);
 	if (err) {
 		printk(KERN_INFO 
@@ -7810,6 +7816,8 @@ void md_check_recovery(mddev_t *mddev)
 			md_new_event(mddev);
 		}
 	unlock:
+		wake_up(&mddev->sb_wait);
+
 		if (!mddev->sync_thread) {
 			clear_bit(MD_RECOVERY_RUNNING, &mddev->recovery);
 			if (test_and_clear_bit(MD_RECOVERY_RECOVER,
