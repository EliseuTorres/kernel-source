From: Dan Carpenter <dan.carpenter@oracle.com>
Date: Wed, 7 Dec 2011 13:58:26 +0200
Subject: [PATCH] mpi/mpi-mpow: NULL dereference on allocation failure
Git-commit: fe0e94c5a7e5335ba0d200e7d3e26e9f80cda4b1
Patch-mainline: v3.3
References: fate#314508
Target: SLE-11 SP3

We can't call mpi_free() on the elements if the first kzalloc() fails.

Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com>
Signed-off-by: Dmitry Kasatkin <dmitry.kasatkin@intel.com>
Signed-off-by: James Morris <jmorris@namei.org>
Acked-by: Lee, Chun-Yi <jlee@suse.com>
---
 lib/mpi/mpi-mpow.c |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

--- a/lib/mpi/mpi-mpow.c
+++ b/lib/mpi/mpi-mpow.c
@@ -73,7 +73,7 @@ int mpi_mulpowm(MPI res, MPI *basearray,
 
 	G = kzalloc((1 << k) * sizeof *G, GFP_KERNEL);
 	if (!G)
-		goto nomem;
+		goto err_out;
 
 	/* and calculate */
 	tmp = mpi_alloc(mpi_get_nlimbs(m) + 1);
@@ -129,5 +129,6 @@ nomem:
 	for (i = 0; i < (1 << k); i++)
 		mpi_free(G[i]);
 	kfree(G);
+err_out:
 	return rc;
 }
