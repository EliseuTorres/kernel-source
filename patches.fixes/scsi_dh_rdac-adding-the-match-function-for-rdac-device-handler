From: "Moger, Babu" <Babu.Moger@netapp.com>
Subject: [PATCH 3/4] scsi_dh_rdac: Adding the match function for rdac device handler
Patch-mainline: v3.3-rc1~124^2~64
Git-commit: bee89eae8de143b1d9f82ab7ab6d9daef8e44760
References: bnc#726504

This patch introduces the match function for rdac device handler. Without this,
sometimes handler attach fails during the device_add. Included check for TPGS
bit before proceeding further. The match function was introduced by this patch
http://www.spinics.net/lists/linux-scsi/msg54284.html

Signed-off-by: Babu Moger <babu.moger@netapp.com>
Acked-by: Hannes Reinecke <hare@suse.de>
Acked-by: Ankit Jain <jankit@suse.de>
---
 drivers/scsi/device_handler/scsi_dh_rdac.c |   19 +++++++++++++++++++
 1 file changed, 19 insertions(+)

Index: b/drivers/scsi/device_handler/scsi_dh_rdac.c
===================================================================
--- a/drivers/scsi/device_handler/scsi_dh_rdac.c
+++ b/drivers/scsi/device_handler/scsi_dh_rdac.c
@@ -847,6 +847,24 @@ static const struct scsi_dh_devlist rdac
 	{NULL, NULL},
 };
 
+static bool rdac_match(struct scsi_device *sdev)
+{
+	int i;
+
+	if (scsi_device_tpgs(sdev))
+		return false;
+
+	for (i = 0; rdac_dev_list[i].vendor; i++) {
+		if (!strncmp(sdev->vendor, rdac_dev_list[i].vendor,
+			strlen(rdac_dev_list[i].vendor)) &&
+		    !strncmp(sdev->model, rdac_dev_list[i].model,
+			strlen(rdac_dev_list[i].model))) {
+			return true;
+		}
+	}
+	return false;
+}
+
 static int rdac_bus_attach(struct scsi_device *sdev);
 static void rdac_bus_detach(struct scsi_device *sdev);
 
@@ -859,6 +877,7 @@ static struct scsi_device_handler rdac_d
 	.attach = rdac_bus_attach,
 	.detach = rdac_bus_detach,
 	.activate = rdac_activate,
+	.match = rdac_match,
 };
 
 static int rdac_bus_attach(struct scsi_device *sdev)
