From: NeilBrown <neilb@suse.de>
Subject: Don't register NFSv2 and NFSv3 with portmap for IPv6 transports
Patch-mainline: no
References: FATE#307240

As we won't be supporting statd on IPv6, it isn't safe to advertise
support for NFSv2 or NFSv3 on IPv6.  But we will want to support NFSv4
on IPv6.  The easiest way to resolve this is to not tell
portmap/rpcbind that v2 or v3 are available on IPv6 transports.

Acked-by: Neil Brown <neilb@suse.de>
Signed-off-by: Neil Brown <neilb@suse.de>

---
 net/sunrpc/svc.c |   11 +++++++++++
 1 file changed, 11 insertions(+)

--- linux-2.6.32-SLE11-SP1.orig/net/sunrpc/svc.c
+++ linux-2.6.32-SLE11-SP1/net/sunrpc/svc.c
@@ -883,6 +883,17 @@ int svc_register(const struct svc_serv *
 			if (progp->pg_vers[i]->vs_hidden)
 				continue;
 
+			if (strcmp(progp->pg_name, "nfsd") == 0 &&
+			    i < 4 &&
+			    family == PF_INET6) {
+				/* Don't register NFSv2 or NFSv3 for IPv6
+				 * protocols as we don't support statd
+				 * on IPv6 yet
+				 */
+				dprintk("svc: ... not telling portmap\n");
+				continue;
+			}
+
 			error = __svc_register(progp->pg_name, progp->pg_prog,
 						i, family, proto, port);
 			if (error < 0)
