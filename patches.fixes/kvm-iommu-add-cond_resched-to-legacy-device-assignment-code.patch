From: Joerg Roedel <jroedel@suse.de>
Subject: kvm: iommu: Add cond_resched to legacy device assignment code
Patch-mainline: not-yet
References: bnc#910159

When assigning devices to large memory guests (>=128GB guest
memory in the failure case) the functions to create the
IOMMU page-tables for the whole guest might run for a very
long time. On non-preemptible kernels this might cause
Soft-Lockup warnings. Fix these by adding a cond_resched()
to the mapping and unmapping loops.

Signed-off-by: Joerg Roedel <jroedel@suse.de>
Acked-by: Michal Hocko <mhocko@suse.cz>

---
 virt/kvm/iommu.c |    4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

--- a/virt/kvm/iommu.c
+++ b/virt/kvm/iommu.c
@@ -120,7 +120,7 @@ int kvm_iommu_map_pages(struct kvm *kvm,
 
 		gfn += page_size >> PAGE_SHIFT;
 
-
+		cond_resched();
 	}
 
 	return 0;
@@ -304,6 +304,8 @@ static void kvm_iommu_put_pages(struct k
 		kvm_unpin_pages(kvm, pfn, unmap_pages);
 
 		gfn += unmap_pages;
+
+		cond_resched();
 	}
 }
 
