From: FUJITA Tomonori <fujita.tomonori@lab.ntt.co.jp>
Subject: [SCSI] compat_ioct: fix bsg SG_IO
Patch-mainline: 2.6.33 commit 84eb8fb42c120ff32b201c1cdd910033c888f699
References: bnc#580991

    
    bsg's SG_IO doesn't work on 32-bit userspace and 64-bit kernelspace.
    
    The problem is that both sg and bsg drivers use SG_IO
    ioctl. sg_ioctl_trans() does 32/64-bit conversion even against bsg
    header. It messes up bsg header. bsg driver gets garbage.
    
    This patch fixes sg_ioctl_trans to handle only sg header (struct
    sg_io_hdr).
    
    Reported-by: Giridhar Malavali <giridhar.malavali@qlogic.com>
    Signed-off-by: FUJITA Tomonori <fujita.tomonori@lab.ntt.co.jp>
    Signed-off-by: James Bottomley <James.Bottomley@suse.de>
Signed-off-by: Nikanth Karthikesan <knikanth@suse.de>

Index: linux-2.6.32-SLE11-SP1/fs/compat_ioctl.c
===================================================================
--- linux-2.6.32-SLE11-SP1.orig/fs/compat_ioctl.c
+++ linux-2.6.32-SLE11-SP1/fs/compat_ioctl.c
@@ -729,8 +729,15 @@ static int sg_ioctl_trans(unsigned int f
 	u32 data;
 	void __user *dxferp;
 	int err;
+	int interface_id;
 
 	sgio32 = compat_ptr(arg);
+
+	if (get_user(interface_id, &sgio32->interface_id))
+		return -EFAULT;
+	if (interface_id != 'S')
+		return sys_ioctl(fd, cmd, (unsigned long)sgio32);
+
 	if (get_user(iovec_count, &sgio32->iovec_count))
 		return -EFAULT;
 
