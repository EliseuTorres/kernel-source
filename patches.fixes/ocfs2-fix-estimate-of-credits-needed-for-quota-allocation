From jack@suse.cz  Fri Sep 24 14:30:46 2010
From: Jan Kara <jack@suse.cz>
Date: Wed, 1 Sep 2010 14:20:13 -0700
Subject: [PATCH 264/314] ocfs2: Fix estimate of credits needed for quota
 allocation
Oracle-commit: c26459225182d4050b6668f2956e288b86bd7cea
Git-commit: 832d09cf1438bd172f69478bde74f20f05ec0115
Patch-mainline: 2.6.35-rc1

Mainline commit 832d09cf1438bd172f69478bde74f20f05ec0115

We were missing reservation of a journal credit for modification of quota
file inode when creating new dquot structure in the global quota file.

Acked-by: Joel Becker <Joel.Becker@oracle.com>
Signed-off-by: Jan Kara <jack@suse.cz>
Acked-by: Jeff Mahoney <jeffm@suse.com>
Signed-off-by: Mark Fasheh <mfasheh@suse.com>
---
 fs/ocfs2/quota_global.c |    5 +++--
 1 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/fs/ocfs2/quota_global.c b/fs/ocfs2/quota_global.c
index 84f5815..c15151d 100644
--- a/fs/ocfs2/quota_global.c
+++ b/fs/ocfs2/quota_global.c
@@ -468,9 +468,10 @@ static int ocfs2_global_qinit_alloc(struct super_block *sb, int type)
 
 static int ocfs2_calc_global_qinit_credits(struct super_block *sb, int type)
 {
-	/* We modify all the allocated blocks, tree root, and info block */
+	/* We modify all the allocated blocks, tree root, info block and
+	 * the inode */
 	return (ocfs2_global_qinit_alloc(sb, type) + 2) *
-			OCFS2_QUOTA_BLOCK_UPDATE_CREDITS;
+			OCFS2_QUOTA_BLOCK_UPDATE_CREDITS + 1;
 }
 
 /* Sync local information about quota modifications with global quota file.
-- 
1.7.1

