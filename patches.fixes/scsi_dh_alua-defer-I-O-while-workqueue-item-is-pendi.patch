From: Hannes Reinecke <hare@suse.de>
Date: Thu, 14 Nov 2013 09:41:15 +0100
Subject: scsi_dh_alua: defer I/O while workqueue item is pending
References: bnc#708296
Patch-Mainline: posted to linux-scsi

When a workqueue item is scheduled we should be deferring
any I/O, as the port group status is undefined during that
time.

Signed-off-by: Hannes Reinecke <hare@suse.de>
---
 drivers/scsi/device_handler/scsi_dh_alua.c | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/drivers/scsi/device_handler/scsi_dh_alua.c b/drivers/scsi/device_handler/scsi_dh_alua.c
index 9b0fcf9..785b374 100644
--- a/drivers/scsi/device_handler/scsi_dh_alua.c
+++ b/drivers/scsi/device_handler/scsi_dh_alua.c
@@ -1201,8 +1201,12 @@ static int alua_prep_fn(struct scsi_device *sdev, struct request *req)
 
 	rcu_read_lock();
 	pg = rcu_dereference(h->pg);
-	if (pg)
+	if (pg) {
 		state = pg->state;
+		/* Defer I/O while rtpg_work is active */
+		if (pg->rtpg_sdev)
+			state = TPGS_STATE_TRANSITIONING;
+	}
 	rcu_read_unlock();
 	if (state == TPGS_STATE_TRANSITIONING)
 		ret = BLKPREP_DEFER;
-- 
1.7.12.4

