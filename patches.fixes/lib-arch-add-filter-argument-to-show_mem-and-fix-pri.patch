From b2b755b5f10eb32fbdc73a9907c07006b17f714b Mon Sep 17 00:00:00 2001
From: David Rientjes <rientjes@google.com>
Date: Thu, 24 Mar 2011 15:18:15 -0700
Subject: [PATCH] lib, arch: add filter argument to show_mem and fix private implementations
Patch-mainline: b2b755b5f10eb32fbdc73a9907c07006b17f714b
References: bnc#705433

Commit ddd588b5dd55 ("oom: suppress nodes that are not allowed from
meminfo on oom kill") moved lib/show_mem.o out of lib/lib.a, which
resulted in build warnings on all architectures that implement their own
versions of show_mem():

	lib/lib.a(show_mem.o): In function `show_mem':
	show_mem.c:(.text+0x1f4): multiple definition of `show_mem'
	arch/sparc/mm/built-in.o:(.text+0xd70): first defined here

The fix is to remove __show_mem() and add its argument to show_mem() in
all implementations to prevent this breakage.

Architectures that implement their own show_mem() actually don't do
anything with the argument yet, but they could be made to filter nodes
that aren't allowed in the current context in the future just like the
generic implementation.

Reported-by: Stephen Rothwell <sfr@canb.auug.org.au>
Reported-by: James Bottomley <James.Bottomley@hansenpartnership.com>
Suggested-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: David Rientjes <rientjes@google.com>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Acked-by: Michal Hocko <mhocko@suse.cz>

---
 arch/arm/mm/init.c       |    2 +-
 arch/ia64/mm/contig.c    |    2 +-
 arch/ia64/mm/discontig.c |    2 +-
 arch/parisc/mm/init.c    |    2 +-
 arch/powerpc/xmon/xmon.c |    2 +-
 arch/sparc/mm/init_32.c  |    2 +-
 drivers/char/keyboard.c  |    2 +-
 drivers/char/sysrq.c     |    2 +-
 include/linux/mm.h       |    5 ++---
 lib/show_mem.c           |    7 +------
 mm/oom_kill.c            |    2 +-
 mm/page_alloc.c          |    2 +-
 12 files changed, 13 insertions(+), 19 deletions(-)
Index: linux-2.6.32-bnc705433/arch/arm/mm/init.c
===================================================================
--- linux-2.6.32-bnc705433.orig/arch/arm/mm/init.c
+++ linux-2.6.32-bnc705433/arch/arm/mm/init.c
@@ -73,7 +73,7 @@ __tagtable(ATAG_INITRD2, parse_tag_initr
  */
 struct meminfo meminfo;
 
-void show_mem(void)
+void show_mem(unsigned int filter)
 {
 	int free = 0, total = 0, reserved = 0;
 	int shared = 0, cached = 0, slab = 0, node, i;
Index: linux-2.6.32-bnc705433/arch/ia64/mm/contig.c
===================================================================
--- linux-2.6.32-bnc705433.orig/arch/ia64/mm/contig.c
+++ linux-2.6.32-bnc705433/arch/ia64/mm/contig.c
@@ -36,7 +36,7 @@ static unsigned long max_gap;
  * Shows a simple page count of reserved and used pages in the system.
  * For discontig machines, it does this on a per-pgdat basis.
  */
-void show_mem(void)
+void show_mem(unsigned int filter)
 {
 	int i, total_reserved = 0;
 	int total_shared = 0, total_cached = 0;
Index: linux-2.6.32-bnc705433/arch/ia64/mm/discontig.c
===================================================================
--- linux-2.6.32-bnc705433.orig/arch/ia64/mm/discontig.c
+++ linux-2.6.32-bnc705433/arch/ia64/mm/discontig.c
@@ -514,7 +514,7 @@ void __cpuinit *per_cpu_init(void)
  * Shows a simple page count of reserved and used pages in the system.
  * For discontig machines, it does this on a per-pgdat basis.
  */
-void show_mem(void)
+void show_mem(unsigned int filter)
 {
 	int i, total_reserved = 0;
 	int total_shared = 0, total_cached = 0;
Index: linux-2.6.32-bnc705433/arch/parisc/mm/init.c
===================================================================
--- linux-2.6.32-bnc705433.orig/arch/parisc/mm/init.c
+++ linux-2.6.32-bnc705433/arch/parisc/mm/init.c
@@ -545,7 +545,7 @@ void __init mem_init(void)
 unsigned long *empty_zero_page __read_mostly;
 EXPORT_SYMBOL(empty_zero_page);
 
-void show_mem(void)
+void show_mem(unsigned int filter)
 {
 	int i,free = 0,total = 0,reserved = 0;
 	int shared = 0, cached = 0;
Index: linux-2.6.32-bnc705433/arch/powerpc/xmon/xmon.c
===================================================================
--- linux-2.6.32-bnc705433.orig/arch/powerpc/xmon/xmon.c
+++ linux-2.6.32-bnc705433/arch/powerpc/xmon/xmon.c
@@ -820,7 +820,7 @@ cmds(struct pt_regs *excp)
 				memzcan();
 				break;
 			case 'i':
-				show_mem();
+				show_mem(0);
 				break;
 			default:
 				termch = cmd;
Index: linux-2.6.32-bnc705433/arch/sparc/mm/init_32.c
===================================================================
--- linux-2.6.32-bnc705433.orig/arch/sparc/mm/init_32.c
+++ linux-2.6.32-bnc705433/arch/sparc/mm/init_32.c
@@ -74,7 +74,7 @@ void __init kmap_init(void)
 	kmap_prot = __pgprot(SRMMU_ET_PTE | SRMMU_PRIV | SRMMU_CACHE);
 }
 
-void show_mem(void)
+void show_mem(unsigned int filter)
 {
 	printk("Mem-info:\n");
 	show_free_areas();
Index: linux-2.6.32-bnc705433/include/linux/mm.h
===================================================================
--- linux-2.6.32-bnc705433.orig/include/linux/mm.h
+++ linux-2.6.32-bnc705433/include/linux/mm.h
@@ -842,7 +842,7 @@ extern void pagefault_out_of_memory(void
 #define offset_in_page(p)	((unsigned long)(p) & ~PAGE_MASK)
 
 /*
- * Flags passed to __show_mem() and __show_free_areas() to suppress output in
+ * Flags passed to show_mem() and __show_free_areas() to suppress output in
  * various contexts.
  */
 #define SHOW_MEM_FILTER_NODES	(0x0001u)	/* filter disallowed nodes */
@@ -1310,8 +1310,7 @@ extern void setup_per_zone_wmarks(void);
 extern void calculate_zone_inactive_ratio(struct zone *zone);
 extern void mem_init(void);
 extern void __init mmap_init(void);
-extern void show_mem(void);
-extern void __show_mem(unsigned int flags);
+extern void show_mem(unsigned int flags);
 extern void si_meminfo(struct sysinfo * val);
 extern void si_meminfo_node(struct sysinfo *val, int nid);
 extern int after_bootmem;
Index: linux-2.6.32-bnc705433/lib/show_mem.c
===================================================================
--- linux-2.6.32-bnc705433.orig/lib/show_mem.c
+++ linux-2.6.32-bnc705433/lib/show_mem.c
@@ -9,7 +9,7 @@
 #include <linux/nmi.h>
 #include <linux/quicklist.h>
 
-void __show_mem(unsigned int filter)
+void show_mem(unsigned int filter)
 {
 	pg_data_t *pgdat;
 	unsigned long total = 0, reserved = 0, shared = 0,
@@ -61,8 +61,3 @@ void __show_mem(unsigned int filter)
 		quicklist_total_size());
 #endif
 }
-
-void show_mem(void)
-{
-	__show_mem(0);
-}
Index: linux-2.6.32-bnc705433/mm/page_alloc.c
===================================================================
--- linux-2.6.32-bnc705433.orig/mm/page_alloc.c
+++ linux-2.6.32-bnc705433/mm/page_alloc.c
@@ -2160,7 +2160,7 @@ nopage:
 			p->comm, order, gfp_mask);
 		dump_stack();
 		if (!should_suppress_show_mem())
-			__show_mem(filter);
+			show_mem(filter);
 	}
 	return page;
 got_pg:
Index: linux-2.6.32-bnc705433/drivers/char/keyboard.c
===================================================================
--- linux-2.6.32-bnc705433.orig/drivers/char/keyboard.c
+++ linux-2.6.32-bnc705433/drivers/char/keyboard.c
@@ -578,7 +578,7 @@ static void fn_scroll_back(struct vc_dat
 
 static void fn_show_mem(struct vc_data *vc)
 {
-	show_mem();
+	show_mem(0);
 }
 
 static void fn_show_state(struct vc_data *vc)
Index: linux-2.6.32-bnc705433/drivers/char/sysrq.c
===================================================================
--- linux-2.6.32-bnc705433.orig/drivers/char/sysrq.c
+++ linux-2.6.32-bnc705433/drivers/char/sysrq.c
@@ -302,7 +302,7 @@ static struct sysrq_key_op sysrq_ftrace_
 
 static void sysrq_handle_showmem(int key, struct tty_struct *tty)
 {
-	show_mem();
+	show_mem(0);
 }
 static struct sysrq_key_op sysrq_showmem_op = {
 	.handler	= sysrq_handle_showmem,
Index: linux-2.6.32-bnc705433/mm/oom_kill.c
===================================================================
--- linux-2.6.32-bnc705433.orig/mm/oom_kill.c
+++ linux-2.6.32-bnc705433/mm/oom_kill.c
@@ -403,7 +403,7 @@ static int oom_kill_process(struct task_
 		task_unlock(current);
 		dump_stack();
 		mem_cgroup_print_oom_info(mem, p);
-		__show_mem(SHOW_MEM_FILTER_NODES);
+		show_mem(SHOW_MEM_FILTER_NODES);
 		if (sysctl_oom_dump_tasks)
 			dump_tasks(mem);
 	}
