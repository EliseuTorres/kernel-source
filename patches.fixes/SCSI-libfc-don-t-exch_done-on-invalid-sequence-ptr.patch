From: Yi Zou <yi.zou@intel.com>
Date: Fri, 6 Jul 2012 10:40:26 -0700
Subject: [SCSI] libfc: don't exch_done() on invalid sequence ptr
Patch-mainline: v3.6-rc1
Git-commit: db95fc004ea50f661a98c9f25585c0a734b5c238
References: bnc#810722

The lport_recv(), i.e., fc_lport_recv_req() may get called w/o the sequence ptr
being set in fr_seq(), particularly in the case of vn2vn mode, this may happen
if the passive fcp provider, e.g., tcm_fc, has not been registered yet.

Signed-off-by: Yi Zou <yi.zou@intel.com>
Tested-by: Ross Brattain <ross.b.brattain@intel.com>
Signed-off-by: Robert Love <robert.w.love@intel.com>
Signed-off-by: James Bottomley <JBottomley@Parallels.com>
Acked-by: Michal Kubecek <mkubecek@suse.cz>

(cherry picked from commit )
---
 drivers/scsi/libfc/fc_lport.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/drivers/scsi/libfc/fc_lport.c b/drivers/scsi/libfc/fc_lport.c
index 2cb12b9..c6c7a4c 100644
--- a/drivers/scsi/libfc/fc_lport.c
+++ b/drivers/scsi/libfc/fc_lport.c
@@ -957,7 +957,8 @@ drop:
 	rcu_read_unlock();
 	FC_LPORT_DBG(lport, "dropping unexpected frame type %x\n", fh->fh_type);
 	fc_frame_free(fp);
-	lport->tt.exch_done(sp);
+	if (sp)
+		lport->tt.exch_done(sp);
 }
 
 /**
-- 
1.8.1.4

