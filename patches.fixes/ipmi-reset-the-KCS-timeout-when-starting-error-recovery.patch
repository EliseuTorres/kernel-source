From: Corey Minyard <cminyard@mvista.com>
Date: Mon, 24 Mar 2014 10:52:45 -0500
Subject: [PATCH 2/2] ipmi: Reset the KCS timeout when starting error recovery
References: bnc#870618
Patch-mainline: Submitted, accepted by maintainer

The OBF timer in KCS was not reset in one situation when error
recovery was started, resulting in an immediate timeout.

Reported-by: Bodo Str√∂sser <bodo.stroesser@ts.fujitsu.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
Acked-by: Jean Delvare <jdelvare@suse.de>

diff --git a/drivers/char/ipmi/ipmi_kcs_sm.c b/drivers/char/ipmi/ipmi_kcs_sm.c
index 6a4bdc1..8c25f59 100644
--- a/drivers/char/ipmi/ipmi_kcs_sm.c
+++ b/drivers/char/ipmi/ipmi_kcs_sm.c
@@ -251,8 +251,9 @@ static inline int check_obf(struct si_sm_data *kcs, unsigned char status,
 	if (!GET_STATUS_OBF(status)) {
 		kcs->obf_timeout -= time;
 		if (kcs->obf_timeout < 0) {
-		    start_error_recovery(kcs, "OBF not ready in time");
-		    return 1;
+			kcs->obf_timeout = OBF_RETRY_TIMEOUT;
+			start_error_recovery(kcs, "OBF not ready in time");
+			return 1;
 		}
 		return 0;
 	}
-- 
1.8.3.1

