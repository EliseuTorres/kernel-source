From: Jeff Layton <jlayton@redhat.com>
Date: Thu, 31 Oct 2013 13:03:04 -0400
Subject: [PATCH] nfs: fix inverted test for delegation in
 nfs4_reclaim_open_state
Git-commit: 1acd1c301f4faae80f4d2c7bbd9a4553b131c0e3
Patch-mainline: v3.13
References: bnc#903331

commit 6686390bab6a0e0 (NFS: remove incorrect "Lock reclaim failed!"
warning.) added a test for a delegation before checking to see if any
reclaimed locks failed. The test however is backward and is only doing
that check when a delegation is held instead of when one isn't.

Cc: NeilBrown <neilb@suse.de>
Signed-off-by: Jeff Layton <jlayton@redhat.com>
Fixes: 6686390bab6a: NFS: remove incorrect "Lock reclaim failed!" warning.
Cc: stable@vger.kernel.org # 3.12
Signed-off-by: Trond Myklebust <Trond.Myklebust@netapp.com>
Acked-by: NeilBrown <neilb@suse.de>

---
 fs/nfs/nfs4state.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

--- linux-3.0-SLE11-SP3.orig/fs/nfs/nfs4state.c
+++ linux-3.0-SLE11-SP3/fs/nfs/nfs4state.c
@@ -1245,7 +1245,7 @@ restart:
 		if (status >= 0) {
 			status = nfs4_reclaim_locks(state, ops);
 			if (status >= 0) {
-				if (test_bit(NFS_DELEGATED_STATE, &state->flags) != 0) {
+				if (!test_bit(NFS_DELEGATED_STATE, &state->flags)) {
 					list_for_each_entry(lock, &state->lock_states, ls_locks) {
 						if (!(lock->ls_flags & NFS_LOCK_INITIALIZED))
 							printk("%s: Lock reclaim failed!\n",
