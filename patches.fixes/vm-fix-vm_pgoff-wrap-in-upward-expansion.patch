From 42c36f63ac1366ab0ecc2d5717821362c259f517 Mon Sep 17 00:00:00 2001
From: Hugh Dickins <hughd@google.com>
Date: Mon, 9 May 2011 17:44:42 -0700
Subject: [PATCH] vm: fix vm_pgoff wrap in upward expansion
Patch-mainline: 42c36f63ac1366ab0ecc2d5717821362c259f517
References: bnc#702285, CVE-2011-2496

Commit a626ca6a6564 ("vm: fix vm_pgoff wrap in stack expansion") fixed
the case of an expanding mapping causing vm_pgoff wrapping when you had
downward stack expansion.  But there was another case where IA64 and
PA-RISC expand mappings: upward expansion.

This fixes that case too.

Signed-off-by: Hugh Dickins <hughd@google.com>
Cc: stable@kernel.org
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Acked-by: Michal Hocko <mhocko@suse.cz>

---
 mm/mmap.c |    8 +++++---
 1 file changed, 5 insertions(+), 3 deletions(-)

Index: linux-2.6.32-SLE11-SP1/mm/mmap.c
===================================================================
--- linux-2.6.32-SLE11-SP1.orig/mm/mmap.c
+++ linux-2.6.32-SLE11-SP1/mm/mmap.c
@@ -1678,9 +1678,11 @@ int expand_upwards(struct vm_area_struct
 		size = address - vma->vm_start;
 		grow = (address - vma->vm_end) >> PAGE_SHIFT;
 
-		error = acct_stack_growth(vma, size, grow);
-		if (!error)
-			vma->vm_end = address;
+		error = -ENOMEM;
+		if (vma->vm_pgoff + (size >> PAGE_SHIFT) >= vma->vm_pgoff) {
+			error = acct_stack_growth(vma, size, grow);
+			if (!error)
+				vma->vm_end = address;
 	}
 out_unlock: __maybe_unused
 	anon_vma_unlock(vma);
