From: NeilBrown <neilb@suse.de>
Subject: Flush the md bitmap when switching to read-only
Patch-mainline: 2.6.39
References: bnc#701977

When we shut down we switch any active md arrays to readonly which
should make sure there are no more writes.  But if there is a bitmap
it doesn't get flushed and so could later.

So move the call to 'bitmap_flush' to be called when just switching to
read-only.

Upstream does this already, but the code has changed a lot and it is
not done in do_md_stop.

Signed-off-by: Neil Brown <neilb@suse.de>

---
 drivers/md/md.c |    5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

--- linux-2.6.32-SLE11-SP1.orig/drivers/md/md.c
+++ linux-2.6.32-SLE11-SP1/drivers/md/md.c
@@ -4360,6 +4360,9 @@ static int do_md_stop(mddev_t * mddev, i
 
 		del_timer_sync(&mddev->safemode_timer);
 
+		bitmap_flush(mddev);
+		md_super_wait(mddev);
+
 		switch(mode) {
 		case 1: /* readonly */
 			err  = -ENXIO;
@@ -4369,8 +4372,6 @@ static int do_md_stop(mddev_t * mddev, i
 			break;
 		case 0: /* disassemble */
 		case 2: /* stop */
-			bitmap_flush(mddev);
-			md_super_wait(mddev);
 			if (mddev->ro)
 				set_disk_ro(disk, 0);
 
