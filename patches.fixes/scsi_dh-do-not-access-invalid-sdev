From: Hannes Reinecke <hare@suse.de>
Date: Tue Oct 18 14:03:25 2011 +0200
Subject: scsi_dh: Do not access invalid sdev
References: bnc#721738
Patch-Mainline: Not yet

Device handler activation might race with device removal, so
we need to be extra careful on not to access invalid sdevs.

Signed-off-by: Hannes Reinecke <hare@suse.de>

diff --git a/drivers/scsi/device_handler/scsi_dh.c b/drivers/scsi/device_handler/scsi_dh.c
index 0119b81..aa49ca3 100644
--- a/drivers/scsi/device_handler/scsi_dh.c
+++ b/drivers/scsi/device_handler/scsi_dh.c
@@ -398,26 +398,31 @@ int scsi_dh_activate(struct request_queue *q, activate_complete fn, void *data)
 
 	spin_lock_irqsave(q->queue_lock, flags);
 	sdev = q->queuedata;
-	if (sdev && sdev->scsi_dh_data)
+	if (!sdev) {
+		err = SCSI_DH_NOSYS;
+		goto out_unlock;
+	}
+	if (sdev->scsi_dh_data)
 		scsi_dh = sdev->scsi_dh_data->scsi_dh;
 	dev = get_device(&sdev->sdev_gendev);
-	if (!scsi_dh || !dev ||
-	    sdev->sdev_state == SDEV_CANCEL ||
-	    sdev->sdev_state == SDEV_DEL)
+
+	if (!scsi_dh || !dev) {
 		err = SCSI_DH_NOSYS;
-	if (sdev->sdev_state == SDEV_OFFLINE)
+	} else if ( sdev->sdev_state == SDEV_CANCEL ||
+		    sdev->sdev_state == SDEV_DEL ||
+		    sdev->sdev_state == SDEV_OFFLINE) {
 		err = SCSI_DH_DEV_OFFLINED;
+	}
+
+out_unlock:
 	spin_unlock_irqrestore(q->queue_lock, flags);
 
 	if (err) {
 		if (fn)
 			fn(data, err);
-		goto out;
-	}
-
-	if (scsi_dh->activate)
+	} else if (scsi_dh->activate)
 		err = scsi_dh->activate(sdev, fn, data);
-out:
+
 	put_device(dev);
 	return err;
 }
