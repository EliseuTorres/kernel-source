From: Eric Dumazet <edumazet@google.com>
Date: Tue, 5 Mar 2013 15:57:22 +0000
Subject: [PATCH] net: introduce NAPI_POLL_WEIGHT
Patch-mainline: v3.10-rc1
Git-commit: 82dc3c63c692b1e1d59378ecee948ac88e034aad
References: bsc#909363 FATE#317549

Some drivers use a too big NAPI poll weight.

This patch adds a NAPI_POLL_WEIGHT default value
and issues an error message if a driver attempts
to use a bigger weight.

Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Eilon Greenstein <eilong@broadcom.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Acked-by: Gary Ching-Pang Lin <glin@suse.com>
---
 include/linux/netdevice.h |    5 +++++
 net/core/dev.c            |    3 +++
 2 files changed, 8 insertions(+)

--- a/include/linux/netdevice.h
+++ b/include/linux/netdevice.h
@@ -1524,6 +1524,11 @@ static inline void *netdev_priv(const st
  */
 #define SET_NETDEV_DEVTYPE(net, devtype)	((net)->dev.type = (devtype))
 
+/* Default NAPI poll() weight
+ * Device drivers are strongly advised to not use bigger value
+ */
+#define NAPI_POLL_WEIGHT 64
+
 /**
  *	netif_napi_add - initialize a napi context
  *	@dev:  network device
--- a/net/core/dev.c
+++ b/net/core/dev.c
@@ -3992,6 +3992,9 @@ void netif_napi_add(struct net_device *d
 	napi->gro_list = NULL;
 	napi->skb = NULL;
 	napi->poll = poll;
+	if (weight > NAPI_POLL_WEIGHT)
+		pr_err_once("netif_napi_add() called with weight %d on device %s\n",
+			    weight, dev->name);
 	napi->weight = weight;
 	list_add(&napi->dev_list, &dev->napi_list);
 	napi->dev = dev;
