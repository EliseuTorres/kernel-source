From: Anton Blanchard <anton@samba.org>
Subject: sched: Fix sched_getaffinity()
Patch-mainline: v2.6.34-rc3
References: bnc#596720

    commit 84fba5ec91f11c0efb27d0ed6098f7447491f0df
    Author: Anton Blanchard <anton@samba.org>
    Date:   Tue Apr 6 17:02:19 2010 +1000

    taskset on 2.6.34-rc3 fails on one of my ppc64 test boxes with
    the following error:
    
      sched_getaffinity(0, 16, 0x10029650030) = -1 EINVAL (Invalid argument)
    
    This box has 128 threads and 16 bytes is enough to cover it.
    
    Commit cd3d8031eb4311e516329aee03c79a08333141f1 (sched:
    sched_getaffinity(): Allow less than NR_CPUS length) is
    comparing this 16 bytes agains nr_cpu_ids.
    
    Fix it by comparing nr_cpu_ids to the number of bits in the
    cpumask we pass in.
    
    Signed-off-by: Anton Blanchard <anton@samba.org>
    Reviewed-by: KOSAKI Motohiro <kosaki.motohiro@jp.fujitsu.com>
    Cc: Sharyathi Nagesh <sharyath@in.ibm.com>
    Cc: Ulrich Drepper <drepper@redhat.com>
    Cc: Peter Zijlstra <peterz@infradead.org>
    Cc: Linus Torvalds <torvalds@linux-foundation.org>
    Cc: Jack Steiner <steiner@sgi.com>
    Cc: Russ Anderson <rja@sgi.com>
    Cc: Mike Travis <travis@sgi.com>
    LKML-Reference: <20100406070218.GM5594@kryten>
    Signed-off-by: Ingo Molnar <mingo@elte.hu>

Signed-off-by: Andreas Gruenbacher <agruen@suse.de>

diff --git a/kernel/sched.c b/kernel/sched.c
index 528a105..eaf5c73 100644
--- a/kernel/sched.c
+++ b/kernel/sched.c
@@ -4902,7 +4902,7 @@ SYSCALL_DEFINE3(sched_getaffinity, pid_t, pid, unsigned int, len,
 	int ret;
 	cpumask_var_t mask;
 
-	if (len < nr_cpu_ids)
+	if ((len * BITS_PER_BYTE) < nr_cpu_ids)
 		return -EINVAL;
 	if (len & (sizeof(unsigned long)-1))
 		return -EINVAL;
