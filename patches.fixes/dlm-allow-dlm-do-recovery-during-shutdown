From srinivas.eeda@oracle.com  Fri Sep 24 14:30:42 2010
From: Srinivas Eeda <srinivas.eeda@oracle.com>
Date: Mon, 19 Jul 2010 13:55:10 -0700
Subject: [PATCH 118/314] dlm: allow dlm do recovery during shutdown
Oracle-commit: 7a98aa6c0fce5feb0bf14e50795506332914b8f7
Git-commit: bc9838c4d44a1713ab1bf24aa6675bc3a02b6a88
Patch-mainline: 2.6.34-rc1

Mainline commit bc9838c4d44a1713ab1bf24aa6675bc3a02b6a88

If a node down event happens while dlm shutdown in progress, dlm recovery
should be done before dlm is shutdown.  We can't migrate unrecovered locks,
obviously.  But dlm_reco_thread only does recovery if the dlm_state is
in DLM_CTXT_JOINED.

dlm_reco_thread should do recovery if dlm_state is in DLM_CTXT_JOINED or
DLM_CTXT_IN_SHUTDOWN.

Signed-off-by: Srinivas Eeda <srinivas.eeda@oracle.com>
Signed-off-by: Joel Becker <joel.becker@oracle.com>
Acked-by: Jeff Mahoney <jeffm@suse.com>
Signed-off-by: Mark Fasheh <mfasheh@suse.com>
---
 fs/ocfs2/dlm/dlmrecovery.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/fs/ocfs2/dlm/dlmrecovery.c b/fs/ocfs2/dlm/dlmrecovery.c
index 43265a1..0cadae2 100644
--- a/fs/ocfs2/dlm/dlmrecovery.c
+++ b/fs/ocfs2/dlm/dlmrecovery.c
@@ -310,7 +310,7 @@ static int dlm_recovery_thread(void *data)
 	mlog(0, "dlm thread running for %s...\n", dlm->name);
 
 	while (!kthread_should_stop()) {
-		if (dlm_joined(dlm)) {
+		if (dlm_domain_fully_joined(dlm)) {
 			status = dlm_do_recovery(dlm);
 			if (status == -EAGAIN) {
 				/* do not sleep, recheck immediately. */
-- 
1.7.1

