From d9c744dd67236358433f8761c5256becda20b01f Mon Sep 17 00:00:00 2001
From: Mel Gorman <mgorman@suse.de>
Date: Wed, 22 May 2013 09:15:03 +0100
Subject: [PATCH] mm: link_mem_sections make sure nmi watchdog doesn't trigger
 while linking memory sections

Patch-mainline: no
References: bnc#820434

Similar to bnc#804609, a customer reported soft lockups during
link_mem_sections during boot. As memory sections are already only
searched when necessary, workaround it by touching the NMI watchdog
after every lookup.

Signed-off-by: Mel Gorman <mgorman@suse.de>
---
 drivers/base/node.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/drivers/base/node.c b/drivers/base/node.c
index 8c3e06a..e5a787f 100644
--- a/drivers/base/node.c
+++ b/drivers/base/node.c
@@ -18,6 +18,7 @@
 #include <linux/device.h>
 #include <linux/swap.h>
 #include <linux/slab.h>
+#include <linux/nmi.h>
 
 static struct sysdev_class_attribute *node_state_attrs[];
 
@@ -473,6 +474,8 @@ static int link_mem_sections(int nid)
 			err = ret;
 
 		/* discard ref obtained in find_memory_block() */
+
+		touch_nmi_watchdog();
 	}
 
 	if (mem_blk)
