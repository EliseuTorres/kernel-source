From: Vaios Papadimitriou <vaios.papadimitriou@emulex.com>
Subject: scsi mid layer passes the wrong allocation flag to netlink
Patch-mainline: N/A
References: bnc#638400


While processing a soft IRQ scsi_post_sense_event calls
netlink_broadcast with
the allocation flag GFP_KERNEL, eventually the flag is passed to
kmem_cache_alloc() and the system crashes. I believe the flag should be
GFP_ATOMIC.



Signed-off-by: Nikanth Karthikesan <knikanth@suse.de>

---

Index: linux-2.6.32-SLE11-SP1/drivers/scsi/scsi_error.c
===================================================================
--- linux-2.6.32-SLE11-SP1.orig/drivers/scsi/scsi_error.c
+++ linux-2.6.32-SLE11-SP1/drivers/scsi/scsi_error.c
@@ -277,7 +277,7 @@ static void scsi_post_sense_event(struct
 		(sshdr->asc << 8) | sshdr->ascq;
 
 	err = nlmsg_multicast(scsi_nl_sock, skb, 0, SCSI_NL_GRP_ML_EVENTS,
-			      GFP_KERNEL);
+			      GFP_ATOMIC);
 	if (err && (err != -ESRCH))
 		/* nlmsg_multicast already kfree_skb'd */
 		goto send_fail;
