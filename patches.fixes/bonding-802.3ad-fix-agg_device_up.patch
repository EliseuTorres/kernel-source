From: Jiri Bohac <jbohac@suse.cz>
References: bnc#682482
Subject: bonding: 802.3ad - fix agg_device_up

The slave member of struct aggregator does not necessarily point to a slave
which is part of the aggregator. It merely points to the slave structure
containing the aggregator, while completely different slaves (or no slaves at
all) may belong to the aggregator.

The agg_device_up() function wrongly used agg->slave to find the state of the
aggregator.  Use agg->lag_ports->slave instead.

Signed-off-by: Jiri Bohac <jbohac@suse.cz>

diff --git a/drivers/net/bonding/bond_3ad.c b/drivers/net/bonding/bond_3ad.c
index 494bf96..31912f1 100644
--- a/drivers/net/bonding/bond_3ad.c
+++ b/drivers/net/bonding/bond_3ad.c
@@ -1482,8 +1482,11 @@ static struct aggregator *ad_agg_selection_test(struct aggregator *best,
 
 static int agg_device_up(const struct aggregator *agg)
 {
-	return (netif_running(agg->slave->dev) &&
-		netif_carrier_ok(agg->slave->dev));
+	struct port *port = agg->lag_ports;
+	if (!port)
+		return 0;
+	return (netif_running(port->slave->dev) &&
+		netif_carrier_ok(port->slave->dev));
 }
 
 /**
