From: Robin Holt <holt@sgi.com>
Subject: EPOLL: fix max_user_watches overflow
References: bnc#652391
Patch-mainline: never

On a 16TB machine, max_user_watches has an integer overflow.  Convert it
to use a long and handle the associated fallout.

Fixed by 52bd19f7691b2ea6433aef0ef94c08c57efd7e79 upstream.

Signed-off-by: Robin Holt <holt@sgi.com>
Signed-off-by: Jiri Slaby <jslaby@suse.cz>

Index: linux-2.6.32/fs/eventpoll.c
===================================================================
--- linux-2.6.32.orig/fs/eventpoll.c	2009-12-02 21:51:21.000000000 -0600
+++ linux-2.6.32/fs/eventpoll.c	2010-09-23 14:46:14.635824301 -0500
@@ -1421,8 +1421,8 @@ static int __init eventpoll_init(void)
 	/*
 	 * Allows top 4% of lomem to be allocated for epoll watches (per user).
 	 */
-	max_user_watches = (((si.totalram - si.totalhigh) / 25) << PAGE_SHIFT) /
-		EP_ITEM_COST;
+	max_user_watches = min((unsigned long)INT_MAX, (((si.totalram - si.totalhigh) / 25) << PAGE_SHIFT) /
+		EP_ITEM_COST);
 
 	/* Initialize the structure used to perform safe poll wait head wake ups */
 	ep_nested_calls_init(&poll_safewake_ncalls);
