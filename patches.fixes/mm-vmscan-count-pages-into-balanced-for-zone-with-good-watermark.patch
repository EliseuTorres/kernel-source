From: Shaohua Li <shaohua.li@intel.com>
Date: Mon, 31 Oct 2011 17:08:02 -0700
Subject: [PATCH] vmscan: count pages into balanced for zone with good
 watermark

References: Page reclaim functionality
Patch-mainline: Yes (v3.2)
Git-commit: 16fb951237c2b0b28037b992ee44e7ee401c30d1

It's possible a zone watermark is ok when entering the balance_pgdat()
loop, while the zone is within the requested classzone_idx.  Count pages
from this zone into `balanced'.  In this way, we can skip shrinking zones
too much for high order allocation.

Signed-off-by: Shaohua Li <shaohua.li@intel.com>
Acked-by: Mel Gorman <mgorman@suse.de>
Reviewed-by: Minchan Kim <minchan.kim@gmail.com>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Mel Gorman <mgorman@suse.de>
---
 mm/vmscan.c |    2 ++
 1 file changed, 2 insertions(+)

diff --git a/mm/vmscan.c b/mm/vmscan.c
index 317678d..6b624ac 100644
--- a/mm/vmscan.c
+++ b/mm/vmscan.c
@@ -2973,6 +2973,8 @@ out:
 
 			/* If balanced, clear the congested flag */
 			zone_clear_flag(zone, ZONE_CONGESTED);
+			if (i <= *classzone_idx)
+				balanced += zone->present_pages;
 		}
 	}
 
