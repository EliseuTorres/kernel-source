From: Mel Gorman <mgorman@suse.de>
Date: Thu, 16 May 2013 17:56:08 +0100
Subject: [PATCH] mm: vmscan: do not stall on writeback during memory compaction

References: Cache compaction pfns for faster compaction cycles (bnc#816451)
Patch-mainline: No, unnecessary

This patch stops reclaim/compaction entering sync reclaim as this was
only intended for lumpy reclaim and an oversight.  Page migration has
its own logic for stalling on writeback pages if necessary and memory
compaction is already using it.

Upstream handles this by removing lumpy reclaim entirely and then
removing the potential stalling in commit
41ac1999c3e3563e1810b14878a869c79c9368bb.

Signed-off-by: Mel Gorman <mgorman@suse.de>
---
 mm/vmscan.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/mm/vmscan.c b/mm/vmscan.c
index 4ef10ba..fcab149 100644
--- a/mm/vmscan.c
+++ b/mm/vmscan.c
@@ -1506,7 +1506,7 @@ static inline bool should_reclaim_stall(unsigned long nr_taken,
 		return false;
 
 	/* Only stall on lumpy reclaim */
-	if (sc->reclaim_mode & RECLAIM_MODE_SINGLE)
+	if (!(sc->reclaim_mode & RECLAIM_MODE_LUMPYRECLAIM))
 		return false;
 
 	/* If we have relaimed everything on the isolated list, no stall */
