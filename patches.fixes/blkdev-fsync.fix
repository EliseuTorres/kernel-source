Git-commit: da5aa861bea09197e6ae4d7c46618616064891e4
From: Rafael J. Wysocki <rjw@sisk.pl>
Date: Tue, 2 Aug 2011 02:17:48 +0200
Subject: [PATCH] fix block device fallout from ->fsync() changes
Patch-mainline: 3.1
References: bnc#717574

blkdev_fsync() needs to write pages in pagecache...

Signed-off-by: Rafael J. Wysocki <rjw@sisk.pl>
Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>

Acked-by: NeilBrown <neilb@suse.de>

--- a/fs/block_dev.c
+++ b/fs/block_dev.c
@@ -387,6 +387,10 @@ int blkdev_fsync(struct file *filp, loff_t start, loff_t end, int datasync)
 	struct inode *bd_inode = filp->f_mapping->host;
 	struct block_device *bdev = I_BDEV(bd_inode);
 	int error;
+
+	error = filemap_write_and_wait_range(filp->f_mapping, start, end);
+	if (error)
+		return error;
 
 	/*
 	 * There is no need to serialise calls to blkdev_issue_flush with
