From 29c486df6a208432b370bd4be99ae1369ede28d8 Mon Sep 17 00:00:00 2001
From: Eric Dumazet <eric.dumazet@gmail.com>
Date: Tue, 30 Aug 2011 18:57:00 -0400
Subject: [PATCH] net: ipv4: relax AF_INET check in bind()
Git-commit: 29c486df6a208432b370bd4be99ae1369ede28d8
Patch-mainline: 3.1-rc7
References: bnc#735216

commit d0733d2e29b65 (Check for mistakenly passed in non-IPv4 address)
added regression on legacy apps that use bind() with AF_UNSPEC family.

Relax the check, but make sure the bind() is done on INADDR_ANY
addresses, as AF_UNSPEC has probably no sane meaning for other
addresses.

Bugzilla reference : https://bugzilla.kernel.org/show_bug.cgi?id=42012

Signed-off-by: Eric Dumazet <eric.dumazet@gmail.com>
Reported-and-bisected-by: Rene Meier <r_meier@freenet.de>
Cc: Marcus Meissner <meissner@suse.de>
Signed-off-by: David S. Miller <davem@davemloft.net>
Acked-by: Michal Hocko <mhocko@suse.cz>

---
 net/ipv4/af_inet.c |    7 ++++++-
 1 files changed, 6 insertions(+), 1 deletions(-)

Index: linux-3.0-SLE11-SP2/net/ipv4/af_inet.c
===================================================================
--- linux-3.0-SLE11-SP2.orig/net/ipv4/af_inet.c
+++ linux-3.0-SLE11-SP2/net/ipv4/af_inet.c
@@ -466,8 +466,13 @@ int inet_bind(struct socket *sock, struc
 		goto out;
 
 	if (addr->sin_family != AF_INET) {
+		/* Compatibility games : accept AF_UNSPEC (mapped to AF_INET)
+		 * only if s_addr is INADDR_ANY.
+		 */
 		err = -EAFNOSUPPORT;
-		goto out;
+		if (addr->sin_family != AF_UNSPEC ||
+		    addr->sin_addr.s_addr != htonl(INADDR_ANY))
+			goto out;
 	}
 
 	chk_addr_ret = inet_addr_type(sock_net(sk), addr->sin_addr.s_addr);
