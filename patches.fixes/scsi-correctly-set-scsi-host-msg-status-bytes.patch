From: "Moger, Babu" <Babu.Moger@netapp.com>
Subject: [SCSI] Correctly set the scsi host/msg/status bytes
References: bnc#933936
Git-commit: 3384db9eb8b1e4f94a02c2a0ce3c0efe6142f3ba
Patch-Mainline: v3.4-rc1

Resubmitting as my previous post had format issues and did not go
llinux-scsi.
This patch changes the function to set_msg_byte, set_host_byte and
set_driver_byte to correctly set the corresponding bytes appropriately.

It will reset the original setting and correctly set it to the new
value.  The
previous OR operation does not always set it back to new value. Look at
patch
2/2 for an example.

Signed-off-by: Babu Moger <babu.moger@netapp.com>
Signed-off-by: James Bottomley <JBottomley@Parallels.com>
Signed-off-by: Dirk Mueller <dmueller@suse.com>
---
 include/scsi/scsi_cmnd.h |    6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

--- a/include/scsi/scsi_cmnd.h
+++ b/include/scsi/scsi_cmnd.h
@@ -289,17 +289,17 @@ static inline struct scsi_data_buffer *s
 
 static inline void set_msg_byte(struct scsi_cmnd *cmd, char status)
 {
-	cmd->result |= status << 8;
+	cmd->result = (cmd->result & 0xffff00ff) | (status << 8);
 }
 
 static inline void set_host_byte(struct scsi_cmnd *cmd, char status)
 {
-	cmd->result |= status << 16;
+	cmd->result = (cmd->result & 0xff00ffff) | (status << 16);
 }
 
 static inline void set_driver_byte(struct scsi_cmnd *cmd, char status)
 {
-	cmd->result |= status << 24;
+	cmd->result = (cmd->result & 0x00ffffff) | (status << 24);
 }
 
 #endif /* _SCSI_SCSI_CMND_H */
