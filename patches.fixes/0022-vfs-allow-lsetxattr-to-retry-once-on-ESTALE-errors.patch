From: Jeff Layton <jlayton@redhat.com>
Date: Tue, 11 Dec 2012 12:10:15 -0500
Subject: [PATCH 22/28] vfs: allow lsetxattr() to retry once on ESTALE errors
Git-commit: 49e09e1cc576daa99ea22f3a3c699062c34f8c0f
Patch-mainline: v3.8
References: bnc#876463

Signed-off-by: Jeff Layton <jlayton@redhat.com>
Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Acked-by: NeilBrown <neilb@suse.de>

---
 fs/xattr.c |    9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

--- linux-3.0-SLE11-SP3.orig/fs/xattr.c
+++ linux-3.0-SLE11-SP3/fs/xattr.c
@@ -327,8 +327,9 @@ SYSCALL_DEFINE5(lsetxattr, const char __
 {
 	struct path path;
 	int error;
-
-	error = user_lpath(pathname, &path);
+	unsigned int lookup_flags = 0;
+retry:
+	error = user_path_at(AT_FDCWD, pathname, lookup_flags, &path);
 	if (error)
 		return error;
 	error = mnt_want_write(path.mnt);
@@ -337,6 +338,10 @@ SYSCALL_DEFINE5(lsetxattr, const char __
 		mnt_drop_write(path.mnt);
 	}
 	path_put(&path);
+	if (retry_estale(error, lookup_flags)) {
+		lookup_flags |= LOOKUP_REVAL;
+		goto retry;
+	}
 	return error;
 }
 
