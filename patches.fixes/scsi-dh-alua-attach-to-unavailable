From: Hannes Reinecke <hare@suse.de>
Date: Tue, 3 May 2011 14:10:06 +0200
Subject: SCSI ALUA handler fails to attach to devices reporting UNAVAILABLE AAS
References: bnc#682251
Patch-Mainline: Yes

The SCSI ALUA handler currently fails to attach to devices reporting
an UNAVAILABLE AAS. This causes dm-multipath to fail while configuring
for such devices as seen below:

kernel: sd 5:0:0:0: alua: supports implicit TPGS
kernel: sd 5:0:0:0: alua: port group 3e9 rel port 03
kernel: sd 5:0:0:0: alua: port group 3e9 state U supports TolUsNA
kernel: sd 5:0:0:0: alua: not attached
kernel: device-mapper: table: 253:2: multipath: error attaching hardware
handler

Given that an UNAVAILABLE AAS can transition to other states like AO,
ANO, etc., the current ALUA handler behavior should be rectified so
as to attach to devices which also report an UNAVAILABLE AAS.

Signed-off-by: Martin George <marting@netapp.com>
Signed-off-by: Hannes Reinecke <hare@suse.de>

diff --git a/drivers/scsi/device_handler/scsi_dh_alua.c b/drivers/scsi/device_handler/scsi_dh_alua.c
index 44b5962..d0433cf 100644
--- a/drivers/scsi/device_handler/scsi_dh_alua.c
+++ b/drivers/scsi/device_handler/scsi_dh_alua.c
@@ -703,7 +703,7 @@ static int alua_bus_attach(struct scsi_device *sdev)
 	h->sdev = sdev;
 
 	err = alua_initialize(sdev, h);
-	if (err != SCSI_DH_OK)
+	if ((err != SCSI_DH_OK) && (err != SCSI_DH_DEV_OFFLINED))
 		goto failed;
 
 	if (!try_module_get(THIS_MODULE))
