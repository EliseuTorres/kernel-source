From: Wu Fengguang <fengguang.wu@intel.com>
Subject: HWPOISON: comment the possible set_page_dirty() race
References: Requested by Intel for better MCE/MCA testing
Patch-Mainline: yes (2.6.33)
Commit-ID: db0480b3a61bd6ad86ead3b8bbad094ab0996932

Signed-off-by: Thomas Renninger <trenn@suse.de>

Signed-off-by: Wu Fengguang <fengguang.wu@intel.com>
Signed-off-by: Andi Kleen <ak@linux.intel.com>

---
 mm/memory-failure.c |    2 ++
 1 file changed, 2 insertions(+)

Index: linux-2.6.32-SLE11-SP1/mm/memory-failure.c
===================================================================
--- linux-2.6.32-SLE11-SP1.orig/mm/memory-failure.c
+++ linux-2.6.32-SLE11-SP1/mm/memory-failure.c
@@ -713,6 +713,8 @@ static int hwpoison_user_mappings(struct
 	/*
 	 * Propagate the dirty bit from PTEs to struct page first, because we
 	 * need this to decide if we should kill or just drop the page.
+	 * XXX: the dirty test could be racy: set_page_dirty() may not always
+	 * be called inside page lock (it's recommended but not enforced).
 	 */
 	mapping = page_mapping(p);
 	if (!PageDirty(p) && mapping && mapping_cap_writeback_dirty(mapping)) {
