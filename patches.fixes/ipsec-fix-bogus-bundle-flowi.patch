From: Herbert Xu <herbert@gondor.apana.org.au>
Subject: ipsec: Fix bogus bundle flowi
Patch-mainline: 2.6.34
Git-commit: 87c1e12b5eeb7b30b4b41291bef8e0b41fc3dde9
Acked-by: Jiri Bohac <jbohac@suse.cz>
References: bnc#680845
    
When I merged the bundle creation code, I introduced a bogus
flowi value in the bundle.  Instead of getting from the caller,
it was instead set to the flow in the route object, which is
totally different.

The end result is that the bundles we created never match, and
we instead end up with an ever growing bundle list.

Thanks to Jamal for find this problem.

Reported-by: Jamal Hadi Salim <hadi@cyberus.ca>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
Acked-by: Steffen Klassert <steffen.klassert@secunet.com>
Acked-by: Jamal Hadi Salim <hadi@cyberus.ca>
Signed-off-by: David S. Miller <davem@davemloft.net>


Note the KABI change workaround. Should be safe because:
- noone is going to add complete ipsec support for a new protocol family
- an extra argument passed to a function will not hurt anyway


Index: work/include/net/xfrm.h
===================================================================
--- work.orig/include/net/xfrm.h	2011-03-30 18:59:00.000000000 +0200
+++ work/include/net/xfrm.h	2011-03-30 19:06:35.000000000 +0200
@@ -273,7 +273,11 @@ struct xfrm_policy_afinfo {
 					     struct dst_entry *dst,
 					     int nfheader_len);
 	int			(*fill_dst)(struct xfrm_dst *xdst,
-					    struct net_device *dev);
+					    struct net_device *dev
+#ifndef __GENKSYMS__
+					    , struct flowi *fl
+#endif
+					);
 };
 
 extern int xfrm_policy_register_afinfo(struct xfrm_policy_afinfo *afinfo);
Index: work/net/ipv4/xfrm4_policy.c
===================================================================
--- work.orig/net/ipv4/xfrm4_policy.c	2011-03-30 18:57:37.000000000 +0200
+++ work/net/ipv4/xfrm4_policy.c	2011-03-30 19:01:44.000000000 +0200
@@ -92,11 +92,12 @@ static int xfrm4_init_path(struct xfrm_d
 	return 0;
 }
 
-static int xfrm4_fill_dst(struct xfrm_dst *xdst, struct net_device *dev)
+static int xfrm4_fill_dst(struct xfrm_dst *xdst, struct net_device *dev,
+			  struct flowi *fl)
 {
 	struct rtable *rt = (struct rtable *)xdst->route;
 
-	xdst->u.rt.fl = rt->fl;
+	xdst->u.rt.fl = *fl;
 
 	xdst->u.dst.dev = dev;
 	dev_hold(dev);
Index: work/net/ipv6/xfrm6_policy.c
===================================================================
--- work.orig/net/ipv6/xfrm6_policy.c	2009-12-03 04:51:21.000000000 +0100
+++ work/net/ipv6/xfrm6_policy.c	2011-03-30 19:01:44.000000000 +0200
@@ -117,7 +117,8 @@ static int xfrm6_init_path(struct xfrm_d
 	return 0;
 }
 
-static int xfrm6_fill_dst(struct xfrm_dst *xdst, struct net_device *dev)
+static int xfrm6_fill_dst(struct xfrm_dst *xdst, struct net_device *dev,
+			  struct flowi *fl)
 {
 	struct rt6_info *rt = (struct rt6_info*)xdst->route;
 
Index: work/net/xfrm/xfrm_policy.c
===================================================================
--- work.orig/net/xfrm/xfrm_policy.c	2009-12-03 04:51:21.000000000 +0100
+++ work/net/xfrm/xfrm_policy.c	2011-03-30 19:01:44.000000000 +0200
@@ -1341,7 +1341,8 @@ static inline int xfrm_init_path(struct
 	return err;
 }
 
-static inline int xfrm_fill_dst(struct xfrm_dst *xdst, struct net_device *dev)
+static inline int xfrm_fill_dst(struct xfrm_dst *xdst, struct net_device *dev,
+				struct flowi *fl)
 {
 	struct xfrm_policy_afinfo *afinfo =
 		xfrm_policy_get_afinfo(xdst->u.dst.ops->family);
@@ -1350,7 +1351,7 @@ static inline int xfrm_fill_dst(struct x
 	if (!afinfo)
 		return -EINVAL;
 
-	err = afinfo->fill_dst(xdst, dev);
+	err = afinfo->fill_dst(xdst, dev, fl);
 
 	xfrm_policy_put_afinfo(afinfo);
 
@@ -1454,7 +1455,7 @@ static struct dst_entry *xfrm_bundle_cre
 	for (dst_prev = dst0; dst_prev != dst; dst_prev = dst_prev->child) {
 		struct xfrm_dst *xdst = (struct xfrm_dst *)dst_prev;
 
-		err = xfrm_fill_dst(xdst, dev);
+		err = xfrm_fill_dst(xdst, dev, fl);
 		if (err)
 			goto free_dst;
 
