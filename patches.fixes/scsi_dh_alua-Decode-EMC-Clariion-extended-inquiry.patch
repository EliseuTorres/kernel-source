From: Hannes Reinecke <hare@suse.de>
Date: Mon, 8 Oct 2012 10:14:36 +0200
Subject: scsi_dh_alua: Decode EMC Clariion extended inquiry
References: bnc#708296
Patch-Mainline: submitted to linux scsi

EMC Clariion doesn't provide the array identification in VPD
page 0x83 but rather uses an 'extended' version of the standard
inquiry for that.

Signed-off-by: Hannes Reinecke <hare@suse.de>
---
 drivers/scsi/device_handler/scsi_dh_alua.c | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/drivers/scsi/device_handler/scsi_dh_alua.c b/drivers/scsi/device_handler/scsi_dh_alua.c
index 6b2ebbc..f2e0395 100644
--- a/drivers/scsi/device_handler/scsi_dh_alua.c
+++ b/drivers/scsi/device_handler/scsi_dh_alua.c
@@ -496,6 +496,16 @@ static int alua_vpd_inquiry(struct scsi_device *sdev, struct alua_dh_data *h)
 		err = SCSI_DH_DEV_UNSUPP;
 		goto out;
 	}
+	if (!target_id_size) {
+		/* Check for EMC Clariion extended inquiry */
+		if (!strncmp(sdev->vendor, "DGC     ", 8) &&
+		    sdev->inquiry_len > 160) {
+			target_id_size = sdev->inquiry[160];
+			target_id = sdev->inquiry + 161;
+			strcpy(target_id_str, "emc.");
+			memcpy(target_id_str + 4, target_id, target_id_size);
+		}
+	}
 
 	spin_lock(&port_group_lock);
 	pg = NULL;
-- 
1.7.12.4

