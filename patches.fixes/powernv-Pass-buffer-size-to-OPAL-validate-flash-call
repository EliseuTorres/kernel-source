From: Vasant Hegde <hegdevasant@linux.vnet.ibm.com>
Subject: powerpc/powernv: Pass buffer size to OPAL validate flash call
Git-commit: 8b8f7bf4c218628fd243d03fc85cdbc7039e9e35
Patch-mainline: v3.16-rc1
References: bnc#878240 

    We pass actual buffer size to opal_validate_flash() OPAL API call
    and in return it contains output buffer size.
    
    Commit cc146d1d (Fix little endian issues) missed to set the size
    param before making OPAL call. So firmware image validation fails.
    
    This patch sets size variable before making OPAL call.
    
Signed-off-by: Vasant Hegde <hegdevasant@linux.vnet.ibm.com>
    Tested-by: Thomas Falcon <tlfalcon@linux.vnet.ibm.com>
Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
Acked-by: Torsten Duwe <duwe@suse.de>

 arch/powerpc/platforms/powernv/opal-flash.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)
diff --git a/arch/powerpc/platforms/powernv/opal-flash.c b/arch/powerpc/platforms/powernv/opal-flash.c
index 145a80b..5c21d9c 100644
--- a/arch/powerpc/platforms/powernv/opal-flash.c
+++ b/arch/powerpc/platforms/powernv/opal-flash.c
@@ -131,7 +131,8 @@ static inline void opal_flash_validate(void)
 {
 	long ret;
 	void *buf = validate_flash_data.buf;
-	__be32 size, result;
+	__be32 size = cpu_to_be32(validate_flash_data.buf_size);
+	__be32 result;
 
 	ret = opal_validate_flash(__pa(buf), &size, &result);
 
