From: Andi Kleen <andi@firstfloor.org>
Subject: HWPOISON: Try to allocate migration page on the same node
References: Requested by Intel for better MCE/MCA testing
Patch-Mainline: yes (2.6.33)
Commit-ID: 12686d153abff397fa0927c620d5a3de84910b72

Signed-off-by: Thomas Renninger <trenn@suse.de>

Signed-off-by: Andi Kleen <ak@linux.intel.com>

---
 mm/memory-failure.c |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

Index: linux-2.6.32-SLE11-SP1/mm/memory-failure.c
===================================================================
--- linux-2.6.32-SLE11-SP1.orig/mm/memory-failure.c
+++ linux-2.6.32-SLE11-SP1/mm/memory-failure.c
@@ -1029,7 +1029,8 @@ void memory_failure(unsigned long pfn, i
 
 static struct page *new_page(struct page *p, unsigned long private, int **x)
 {
-	return alloc_pages(GFP_HIGHUSER_MOVABLE, 0);
+	int nid = page_to_nid(p);
+	return alloc_pages_exact_node(nid, GFP_HIGHUSER_MOVABLE, 0);
 }
 
 /*
