Subject: NFSv4.1: Don't call nfs4_schedule_state_recovery() unnecessarily
Git-commit: 03391693a95900875b0973569d2d73ff3aa8972e
From: Trond Myklebust <Trond.Myklebust@netapp.com>
Date: Tue Jan 26 15:42:38 2010 -0500
Patch-mainline: 2.6.33
References: bnc#701443

Currently, nfs4_handle_exception() will call it twice if called with an
error of -NFS4ERR_STALE_CLIENTID, -NFS4ERR_STALE_STATEID or
-NFS4ERR_EXPIRED.

Signed-off-by: Trond Myklebust <Trond.Myklebust@netapp.com>
Reviewed-by: Chuck Lever <chuck.lever@oracle.com>
Acked-by: NeilBrown <neilb@suse.de>
Signed-off-by: Neil Brown <neilb@suse.de>

Index: root/fs/nfs/nfs4proc.c
===================================================================
--- root.orig/fs/nfs/nfs4proc.c
+++ root/fs/nfs/nfs4proc.c
@@ -256,12 +256,8 @@ static int nfs4_handle_exception(const s
 			ret = nfs4_wait_clnt_recover(clp);
 			if (ret == 0)
 				exception->retry = 1;
-#if !defined(CONFIG_NFS_V4_1)
 			break;
-#else /* !defined(CONFIG_NFS_V4_1) */
-			if (!nfs4_has_session(server->nfs_client))
-				break;
-			/* FALLTHROUGH */
+#if defined(CONFIG_NFS_V4_1)
 		case -NFS4ERR_BADSESSION:
 		case -NFS4ERR_BADSLOT:
 		case -NFS4ERR_BAD_HIGH_SLOT:
@@ -274,7 +270,7 @@ static int nfs4_handle_exception(const s
 			set_bit(NFS4CLNT_SESSION_SETUP, &clp->cl_state);
 			exception->retry = 1;
 			/* FALLTHROUGH */
-#endif /* !defined(CONFIG_NFS_V4_1) */
+#endif /* defined(CONFIG_NFS_V4_1) */
 		case -NFS4ERR_FILE_OPEN:
 			if (exception->timeout > HZ) {
 				/* We have retried a decent amount, time to
