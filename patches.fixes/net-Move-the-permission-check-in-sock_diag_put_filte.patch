From: Jiri Bohac <jbohac@suse.cz>
Subject: net: add a permission check in sock_diag_put_filterinfo
References: bsc#875051, CVE-2014-0181
Patch-mainline: v3.15
Git-commit: a53b72c83a4216f2eb883ed45a0cbce014b8e62d

The permission check in sock_diag_put_filterinfo is wrong, and it is so removed
from it's sources it is not clear why it is wrong.  Move the computation
into packet_diag_dump and pass a bool of the result into sock_diag_filterinfo.

The original upstream commit moves the check.
We need to 
- preserve the KABI
- leave the check in place in case an external module calls 
  sock_diag_put_filterinfo()

Thus, we only add the check in the new place that will later be corrected to the
proper netlink_capable() variant.

--- a/net/packet/diag.c
+++ b/net/packet/diag.c
@@ -127,6 +127,7 @@ static int pdiag_put_fanout(struct packe
 
 static int sk_diag_fill(struct sock *sk, struct sk_buff *skb,
 			struct packet_diag_req *req,
+			bool may_report_filterinfo,
 			struct user_namespace *user_ns,
 			u32 portid, u32 seq, u32 flags, int sk_ino)
 {
@@ -170,9 +171,12 @@ static int sk_diag_fill(struct sock *sk,
 	    sock_diag_put_meminfo(sk, skb, PACKET_DIAG_MEMINFO))
 		goto out_nlmsg_trim;
 
-	if ((req->pdiag_show & PACKET_SHOW_FILTER) &&
-	    sock_diag_put_filterinfo(user_ns, sk, skb, PACKET_DIAG_FILTER))
-		goto out_nlmsg_trim;
+	if (req->pdiag_show & PACKET_SHOW_FILTER) {
+		if (!may_report_filterinfo)
+			nla_reserve(skb, PACKET_DIAG_FILTER, 0);
+		else if (sock_diag_put_filterinfo(user_ns, sk, skb, PACKET_DIAG_FILTER))
+			goto out_nlmsg_trim;
+ 	}
 
 	return nlmsg_end(skb, nlh);
 
@@ -187,9 +191,11 @@ static int packet_diag_dump(struct sk_bu
 	struct packet_diag_req *req;
 	struct net *net;
 	struct sock *sk;
+	bool may_report_filterinfo;
 
 	net = sock_net(skb->sk);
 	req = nlmsg_data(cb->nlh);
+	may_report_filterinfo = ns_capable(net->user_ns, CAP_NET_ADMIN);
 
 	mutex_lock(&net->packet.sklist_lock);
 	sk_for_each(sk, &net->packet.sklist) {
@@ -199,6 +205,7 @@ static int packet_diag_dump(struct sk_bu
 			goto next;
 
 		if (sk_diag_fill(sk, skb, req,
+				 may_report_filterinfo,
 				 sk_user_ns(NETLINK_CB(cb->skb).sk),
 				 NETLINK_CB(cb->skb).portid,
 				 cb->nlh->nlmsg_seq, NLM_F_MULTI,
