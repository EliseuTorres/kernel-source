From: NeilBrown <neilb@suse.de>
Subject: 9p/ocfs2/gfs2: allow file unlock on 'mandatory locking' file
Patch-mainline: submitted for 2.6.34
References: bnc#589280


As the mode of a file can be changed while it is locked, we should
always allow an unlock request on a file that is marked for mandatory
locking, even though we don't support locks on those files.

Acked-by: Neil Brown <neilb@suse.de>
Signed-off-by: Neil Brown <neilb@suse.de>

---
 fs/9p/vfs_file.c |    3 ++-
 fs/gfs2/file.c   |    3 ++-
 fs/ocfs2/locks.c |    3 ++-
 3 files changed, 6 insertions(+), 3 deletions(-)

--- linux-2.6.32-SLE11-SP1.orig/fs/9p/vfs_file.c
+++ linux-2.6.32-SLE11-SP1/fs/9p/vfs_file.c
@@ -114,7 +114,8 @@ static int v9fs_file_lock(struct file *f
 	P9_DPRINTK(P9_DEBUG_VFS, "filp: %p lock: %p\n", filp, fl);
 
 	/* No mandatory locks */
-	if (__mandatory_lock(inode))
+	if (__mandatory_lock(inode) &&
+	    fl->fl_type != F_UNLCK)
 		return -ENOLCK;
 
 	if ((IS_SETLK(cmd) || IS_SETLKW(cmd)) && fl->fl_type != F_UNLCK) {
--- linux-2.6.32-SLE11-SP1.orig/fs/gfs2/file.c
+++ linux-2.6.32-SLE11-SP1/fs/gfs2/file.c
@@ -606,7 +606,8 @@ static int gfs2_lock(struct file *file,
 
 	if (!(fl->fl_flags & FL_POSIX))
 		return -ENOLCK;
-	if (__mandatory_lock(&ip->i_inode))
+	if (__mandatory_lock(&ip->i_inode) &&
+	    fl->fl_type != F_UNLCK)
 		return -ENOLCK;
 
 	if (cmd == F_CANCELLK) {
--- linux-2.6.32-SLE11-SP1.orig/fs/ocfs2/locks.c
+++ linux-2.6.32-SLE11-SP1/fs/ocfs2/locks.c
@@ -113,7 +113,8 @@ int ocfs2_flock(struct file *file, int c
 
 	if (!(fl->fl_flags & FL_FLOCK))
 		return -ENOLCK;
-	if (__mandatory_lock(inode))
+	if (__mandatory_lock(inode) &&
+	    fl->fl_type != F_UNLCK)
 		return -ENOLCK;
 
 	if ((osb->s_mount_opt & OCFS2_MOUNT_LOCALFLOCKS) ||
