From: NeilBrown <neilb@suse.de>
Subject: 9p/ocfs2/gfs2: allow file unlock on 'mandatory locking' file
Patch-mainline: submitted for 2.6.34
References: bnc#589280


As the mode of a file can be changed while it is locked, we should
always allow an unlock request on a file that is marked for mandatory
locking, even though we don't support locks on those files.

Acked-by: Neil Brown <neilb@suse.de>
Signed-off-by: Neil Brown <neilb@suse.de>

---
 fs/ocfs2/locks.c |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

--- a/fs/ocfs2/locks.c
+++ b/fs/ocfs2/locks.c
@@ -113,7 +113,8 @@ int ocfs2_flock(struct file *file, int c
 
 	if (!(fl->fl_flags & FL_FLOCK))
 		return -ENOLCK;
-	if (__mandatory_lock(inode))
+	if (__mandatory_lock(inode) &&
+	    fl->fl_type != F_UNLCK)
 		return -ENOLCK;
 
 	if ((osb->s_mount_opt & OCFS2_MOUNT_LOCALFLOCKS) ||
