From: Jiri Bohac <jbohac@suse.cz>
Subject: bonding: Don't allow mode change via sysfs with slaves present
Patch-mainline: 3.2
Git-commit: 4a8bb7e27fbb68da888b55f26defd2855225b2d5
References: bnc#737833


[ changing the mode with slaves present may work with some modes;
  I changed the original patch to complain but still permit the operation to
  prevent breaking existing setups that happen to work.
  - Jiri Bohac 
]
    
When changing mode via bonding's sysfs, the slaves are not initialized
correctly. Forbid to change modes with slaves present to ensure that every
slave is initialized correctly via bond_enslave().

Signed-off-by: Veaceslav Falico <vfalico@redhat.com>
Signed-off-by: Andy Gospodarek <andy@greyhouse.net>
Acked-by: Nicolas de Peslo√ºan <nicolas.2p.debian@free.fr>
Signed-off-by: David S. Miller <davem@davemloft.net>

diff --git a/drivers/net/bonding/bond_sysfs.c b/drivers/net/bonding/bond_sysfs.c
index 5a20804..4ef7e2f 100644
--- a/drivers/net/bonding/bond_sysfs.c
+++ b/drivers/net/bonding/bond_sysfs.c
@@ -319,6 +319,11 @@ static ssize_t bonding_store_mode(struct device *d,
 		goto out;
 	}
 
+	if (bond->slave_cnt > 0) {
+		pr_warning("Updating mode of %s while slaves are present. This may not work correctly!\n",
+			bond->dev->name);
+	}
+
 	new_value = bond_parse_parm(buf, bond_mode_tbl);
 	if (new_value < 0)  {
 		pr_err("%s: Ignoring invalid mode value %.*s.\n",
