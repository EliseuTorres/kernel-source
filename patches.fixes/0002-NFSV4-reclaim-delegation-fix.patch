From: NeilBrown	<neilb@suse.de>
Subject: Don't use a delegation to open a file when returning that delegation.
Patch-mainline: v3.10
References: bnc#888968, bnc#892200, bnc#893596, bnc#893496

This has the same effect as:

commit cd4c9be2c61d4d974d348743fddb8183b8185abc
    NFSv4.1: Don't do a delegated open for NFS4_OPEN_CLAIM_DELEG_CUR_FH modes

Acked-by: NeilBrown <neilb@suse.de>
Signed-off-by: Neil Brown <neilb@suse.de>

---
 fs/nfs/nfs4proc.c |    1 +
 1 file changed, 1 insertion(+)

--- linux-3.0-SLE11-SP3.orig/fs/nfs/nfs4proc.c
+++ linux-3.0-SLE11-SP3/fs/nfs/nfs4proc.c
@@ -1459,6 +1459,7 @@ static void nfs4_open_prepare(struct rpc
 		rcu_read_lock();
 		delegation = rcu_dereference(NFS_I(data->state->inode)->delegation);
 		if (delegation != NULL &&
+		    test_bit(NFS_DELEGATION_RETURNING, &delegation->flags) == 0 &&
 		    test_bit(NFS_DELEGATION_NEED_RECLAIM, &delegation->flags) == 0) {
 			rcu_read_unlock();
 			goto out_no_action;
