Subject: fcoe: set FCoE controller mode as FIP for fcoe.ko
From: Vasu Dev <vasu.dev@intel.com>
References: bnc#640278
Patch-Mainline: n/a

Since sometimes current FIP_MODE_AUTO falls back to non-FIP
mode while DCB link still getting ready in fabric mode with
its peer switch, it falls back after few libfc flogi retries
and that is not we want while working with FIP enabled
switches in FABRIC mode, therefore this patch sets default
as FIP only mode for fcoe.ko.

Similar patch fixing this upstream but on top of VN-2-VN
feature not yet in distro, it
is at  http://www.open-fcoe.org/pipermail/devel/2010-September/010557.html

Signed-off-by: Vasu Dev <vasu.dev@intel.com>
Acked-by: Hannes Reinecke <hare@suse.de>
---
 drivers/scsi/fcoe/fcoe.c |    1 +
 include/scsi/libfcoe.h   |    4 ++++
 2 files changed, 5 insertions(+), 0 deletions(-)


diff --git a/drivers/scsi/fcoe/fcoe.c b/drivers/scsi/fcoe/fcoe.c
index 1fbbb0b..f4005a3 100644
--- a/drivers/scsi/fcoe/fcoe.c
+++ b/drivers/scsi/fcoe/fcoe.c
@@ -354,6 +354,7 @@ static struct fcoe_interface *fcoe_interface_create(struct net_device *netdev)
 	 * Initialize FIP.
 	 */
 	fcoe_ctlr_init(&fcoe->ctlr);
+	fcoe_ctlr_mode(&fcoe->ctlr, FIP_ST_ENABLED);
 	fcoe->ctlr.send = fcoe_fip_send;
 	fcoe->ctlr.update_mac = fcoe_update_src_mac;
 	fcoe->ctlr.get_src_addr = fcoe_get_src_mac;
diff --git a/include/scsi/libfcoe.h b/include/scsi/libfcoe.h
index 7ead324..f2b6a90 100644
--- a/include/scsi/libfcoe.h
+++ b/include/scsi/libfcoe.h
@@ -174,4 +174,8 @@ int fcoe_ctlr_recv_flogi(struct fcoe_ctlr *, struct fc_lport *,
 u64 fcoe_wwn_from_mac(unsigned char mac[], unsigned int, unsigned int);
 int fcoe_libfc_config(struct fc_lport *, struct libfc_function_template *);
 
+static inline void fcoe_ctlr_mode(struct fcoe_ctlr *fip, enum fip_state mode)
+{
+	fip->mode = mode;
+}
 #endif /* _LIBFCOE_H */
