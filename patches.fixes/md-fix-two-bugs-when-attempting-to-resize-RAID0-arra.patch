Git-commit: a64685399181780998281fe07309a94b25dd24c3
From: NeilBrown <neilb@suse.de>
Date: Thu, 21 Feb 2013 14:33:17 +1100
Subject: [PATCH 1/2] md: fix two bugs when attempting to resize RAID0 array.
Patch-mainline: v3.9-rc1
References: Useful BUG() fix

You cannot resize a RAID0 array (in terms of making the devices
bigger), but the code doesn't entirely stop you.
So: 

 disable setting of the available size on each device for
 RAID0 and Linear devices.  This must not change as doing so
 can change the effective layout of data.

 Make sure that the size that raid0_size() reports is accurate,
 but rounding devices sizes to chunk sizes.  As the device sizes
 cannot change now, this isn't so important, but it is best to be
 safe.

Without this change:
  mdadm --grow /dev/md0 -z max
  mdadm --grow /dev/md0 -Z max
  then read to the end of the array

can cause a BUG in a RAID0 array.

Signed-off-by: NeilBrown <neilb@suse.de>
Acked-by: NeilBrown <neilb@suse.de>

---
 drivers/md/md.c    |    3 +++
 drivers/md/raid0.c |    3 ++-
 2 files changed, 5 insertions(+), 1 deletion(-)

--- linux-3.0-SLE11-SP2.orig/drivers/md/md.c
+++ linux-3.0-SLE11-SP2/drivers/md/md.c
@@ -2918,6 +2918,9 @@ rdev_size_store(mdk_rdev_t *rdev, const
 		} else if (!sectors)
 			sectors = (i_size_read(rdev->bdev->bd_inode) >> 9) -
 				rdev->data_offset;
+		if (!my_mddev->pers->resize)
+			/* Cannot change size for RAID0 or Linear etc */
+			return -EINVAL;
 	}
 	if (sectors < my_mddev->dev_sectors)
 		return -EINVAL; /* component must fit device */
--- linux-3.0-SLE11-SP2.orig/drivers/md/raid0.c
+++ linux-3.0-SLE11-SP2/drivers/md/raid0.c
@@ -327,7 +327,8 @@ static sector_t raid0_size(mddev_t *mdde
 		  "%s does not support generic reshape\n", __func__);
 
 	list_for_each_entry(rdev, &mddev->disks, same_set)
-		array_sectors += rdev->sectors;
+		array_sectors += (rdev->sectors &
+				  ~(sector_t)(mddev->chunk_sectors-1));
 
 	return array_sectors;
 }
