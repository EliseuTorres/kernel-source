From: Hannes Reinecke <hare@suse.de>
Date: Thu, 10 Nov 2011 17:16:15 +0100
Subject: [PATCH] dm-mpath: Reset map pointer when requeing
Patch-Mainline: Not yet

When map_io() needs to requeue the I/O we need to reset
the map pointer to avoid accesses to invalid map pointer
values.

Signed-off-by: Hannes Reinecke <hare@suse.de>

diff --git a/drivers/md/dm-mpath.c b/drivers/md/dm-mpath.c
index a95634c..c2a332b 100644
--- a/drivers/md/dm-mpath.c
+++ b/drivers/md/dm-mpath.c
@@ -1029,8 +1029,10 @@ static int multipath_map(struct dm_target *ti, struct request *clone,
 	map_context->ptr = mpio;
 	clone->cmd_flags |= REQ_FAILFAST_TRANSPORT;
 	r = map_io(m, clone, mpio, 0);
-	if (r < 0 || r == DM_MAPIO_REQUEUE)
+	if (r < 0 || r == DM_MAPIO_REQUEUE) {
 		mempool_free(mpio, m->mpio_pool);
+		map_context->ptr = NULL;
+	}
 
 	return r;
 }
