From: Hannes Reinecke <hare@suse.de>
Date: Tue, 22 Feb 2011 08:55:35 +0100
Subject: megaraid_sas: kdump hangs on dell 2900
References: bnc#622868
Patch-Mainline: not yet

When trying kdump on dell 2900 or 2950 megaraid_sas will crash.
Problem seems to be that the driver receives a double completion
on a command.

This patch adds a sanity check if the command has already been
completed and just issues a warning if so.

Signed-off-by: Hannes Reinecke <hare@suse.de>

diff --git a/drivers/scsi/megaraid/megaraid_sas.c b/drivers/scsi/megaraid/megaraid_sas.c
index 10ad2c7..68c74c6 100644
--- a/drivers/scsi/megaraid/megaraid_sas.c
+++ b/drivers/scsi/megaraid/megaraid_sas.c
@@ -1968,6 +1968,11 @@ megasas_complete_cmd(struct megasas_instance *instance, struct megasas_cmd *cmd,
 
 	case MFI_CMD_PD_SCSI_IO:
 	case MFI_CMD_LD_SCSI_IO:
+		if (!cmd->scmd) {
+			printk(KERN_DEBUG "megasas: invalid completion on"
+			       " command %p status %x\n", cmd, hdr->cmd_status);
+			break;
+		}
 
 		/*
 		 * MFI_CMD_PD_SCSI_IO and MFI_CMD_LD_SCSI_IO could have been
