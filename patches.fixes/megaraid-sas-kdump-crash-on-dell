From: Hannes Reinecke <hare@suse.de>
Date: Tue, 22 Feb 2011 08:55:35 +0100
Subject: megaraid_sas: kdump hangs on dell 2900
References: bnc#622868
Patch-Mainline: not yet

When trying kdump on dell 2900 or 2950 megaraid_sas will crash.
Problem seems to be that the driver receives a double completion
on a command.

This patch adds a sanity check if the command has already been
completed and just issues a warning if so.

Signed-off-by: Hannes Reinecke <hare@suse.de>

diff --git a/drivers/scsi/megaraid/megaraid_sas.c b/drivers/scsi/megaraid/megaraid_sas.c
--- a/drivers/scsi/megaraid/megaraid_sas.c
+++ b/drivers/scsi/megaraid/megaraid_sas.c
index 10ad2c7..68c74c6 100644
@@ -1988,6 +1982,12 @@ megasas_complete_cmd(struct megasas_instance *instance, struct megasas_cmd *cmd,
 	case MFI_CMD_LD_READ:
 	case MFI_CMD_LD_WRITE:
 
+		if (!cmd->scmd && !cmd->sync_cmd) {
+			printk(KERN_DEBUG "megasas: invalid completion on"
+			       " command %p status %x\n", cmd, hdr->cmd_status);
+			break;
+		}
+
 		if (alt_status) {
 			cmd->scmd->result = alt_status << 16;
 			exception = 1;
