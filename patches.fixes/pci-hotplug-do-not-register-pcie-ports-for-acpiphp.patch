From: Rafael J. Wysocki <rjw@suse.de>
Subject: PCI / Hotplug: Do not register slots for PCIe ports with native HP
References: bnc#714552, bnc#732471
Patch-mainline: Yes
Git-commit: 619a5182d1f38a3d629ee48e04fa182ef9170052

Make register_slot() in drivers/pci/hotplug/acpiphp_glue.c
avoid registering hotplug slots for PCIe ports that belong to
root complexes with native PCIe hotplug enabled (which means that
the BIOS has granted the kernel control of this feature for the
given root complex).  This fixes a problem where acpiphp, when loaded
first, would prevent pciehp from registering slots it was supposed to
handle.

Signed-off-by: Rafael J. Wysocki <rjw@suse.de>
---
 drivers/pci/hotplug/acpiphp_glue.c |   12 ++++++++++++
 1 file changed, 12 insertions(+)

Index: linux-3.0-SLE11-SP2/drivers/pci/hotplug/acpiphp_glue.c
===================================================================
--- linux-3.0-SLE11-SP2.orig/drivers/pci/hotplug/acpiphp_glue.c
+++ linux-3.0-SLE11-SP2/drivers/pci/hotplug/acpiphp_glue.c
@@ -131,6 +131,18 @@ register_slot(acpi_handle handle, u32 lv
 	if (!acpi_pci_check_ejectable(pbus, handle) && !is_dock_device(handle))
 		return AE_OK;
 
+	pdev = pbus->self;
+	if (pdev && pci_is_pcie(pdev)) {
+		tmp = acpi_find_root_bridge_handle(pdev);
+		if (tmp) {
+			struct acpi_pci_root *root = acpi_pci_find_root(tmp);
+
+			if (root && (root->osc_control_set &
+					OSC_PCI_EXPRESS_NATIVE_HP_CONTROL))
+				return AE_OK;
+		}
+	}
+
 	status = acpi_evaluate_integer(handle, "_ADR", NULL, &adr);
 	if (ACPI_FAILURE(status)) {
 		warn("can't evaluate _ADR (%#x)\n", status);
