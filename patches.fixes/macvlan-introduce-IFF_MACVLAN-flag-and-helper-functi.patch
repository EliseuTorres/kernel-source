From: Michal Kubecek <mkubecek@suse.cz>
Date: Fri, 22 Nov 2013 14:39:54 +0100
Subject: macvlan: introduce IFF_MACVLAN flag and helper function
Patch-mainline: v3.13-rc1
Git-commit: a6cc0cfa72e0b6d9f2c8fd858aacc32313c4f272 (partial)
References: bnc#846984

Introduce IFF_MACVLAN private flag to distinguish macvlan
devices and netif_is_macvlan() helper function to test it.

Signed-off-by: Michal Kubecek <mkubecek@suse.cz>
---
 drivers/net/macvlan.c     | 2 ++
 include/linux/if.h        | 2 ++
 include/linux/netdevice.h | 5 +++++
 3 files changed, 9 insertions(+)

diff --git a/drivers/net/macvlan.c b/drivers/net/macvlan.c
index 4c0bdac..21d8446 100644
--- a/drivers/net/macvlan.c
+++ b/drivers/net/macvlan.c
@@ -688,6 +688,8 @@ int macvlan_common_newlink(struct net *src_net, struct net_device *dev,
 	if (err < 0)
 		goto destroy_port;
 
+	dev->priv_flags |= IFF_MACVLAN;
+
 	list_add_tail_rcu(&vlan->list, &port->vlans);
 	netif_stacked_transfer_operstate(lowerdev, dev);
 
diff --git a/include/linux/if.h b/include/linux/if.h
index 03489ca..618ca16 100644
--- a/include/linux/if.h
+++ b/include/linux/if.h
@@ -78,6 +78,8 @@
 					 * datapath port */
 #define IFF_TX_SKB_SHARING	0x10000	/* The interface supports sharing
 					 * skbs on transmit */
+#define IFF_MACVLAN 0x200000		/* Macvlan device */
+
 
 #define IF_GET_IFACE	0x0001		/* for querying only */
 #define IF_GET_PROTO	0x0002
diff --git a/include/linux/netdevice.h b/include/linux/netdevice.h
index 5f50b54..017ec72 100644
--- a/include/linux/netdevice.h
+++ b/include/linux/netdevice.h
@@ -2602,6 +2602,11 @@ static inline void netif_set_gso_max_size(struct net_device *dev,
 	dev->gso_max_size = size;
 }
 
+static inline bool netif_is_macvlan(struct net_device *dev)
+{
+	return dev->priv_flags & IFF_MACVLAN;
+}
+
 static inline int netif_is_bond_slave(struct net_device *dev)
 {
 	return dev->flags & IFF_SLAVE && dev->priv_flags & IFF_BONDING;
-- 
1.8.1.4

