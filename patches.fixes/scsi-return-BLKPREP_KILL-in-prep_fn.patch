From: Hannes Reinecke <hare@suse.de>
Date: Fri, 20 Jan 2012 16:36:17 +0100
Subject: sd,sr: Return BLKPREP_KILL in prep_fn()
References: bnc#739381
Patch-Mainline: Submitted to linux-scsi

When q->queuedata is NULL we should return BLKPREP_KILL in
(sd|sr)_prep_fn to avoid a NULL pointer dereference.

Signed-off-by: Hannes Reinecke <hare@suse.de>

diff --git a/drivers/scsi/sd.c b/drivers/scsi/sd.c
index 2be8bdc..94f4567 100644
--- a/drivers/scsi/sd.c
+++ b/drivers/scsi/sd.c
@@ -648,6 +648,9 @@ static int sd_prep_fn(struct request_queue *q, struct request *rq)
 	int ret, host_dif;
 	unsigned char protect;
 
+	if (!sdp)
+		return BLKPREP_KILL;
+
 	/*
 	 * Discard request come in as REQ_TYPE_FS but we turn them into
 	 * block PC requests to make life easier.
diff --git a/drivers/scsi/sr.c b/drivers/scsi/sr.c
index 5fc97d2..3ee0709 100644
--- a/drivers/scsi/sr.c
+++ b/drivers/scsi/sr.c
@@ -372,6 +372,9 @@ static int sr_prep_fn(struct request_queue *q, struct request *rq)
 	struct scsi_device *sdp = q->queuedata;
 	int ret;
 
+	if (!sdp)
+		return BLKPREP_KILL;
+
 	if (rq->cmd_type == REQ_TYPE_BLOCK_PC) {
 		ret = scsi_setup_blk_pc_cmnd(sdp, rq);
 		goto out;
