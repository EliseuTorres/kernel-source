From: Jens Axboe <jaxboe@fusionio.com>
Date: Mon, 30 May 2011 07:42:51 +0200
Subject: [PATCH 2/2] Revert "block: Remove extra discard_alignment from hd_struct."
Git-commit: a1706ac4c0201ea0143dc0db0659001b26ceeabb
Patch-mainline: v3.0
References: bnc #707917

It was not a good idea to start dereferencing disk->queue from
the fs sysfs strategy for displaying discard alignment. We ran
into first a NULL pointer deref, and after fixing that we sometimes
see unvalid disk->queue pointer values.

Since discard is the only one of the bunch actually looking into
the queue, just revert the change.

This reverts commit 23ceb5b7719e9276d4fa72a3ecf94dd396755276.

Note: The above commit has not been included in SP2, so the parts of
patch *reverting* it have been skipped in this patch.

Conflicts:
	fs/partitions/check.c

Signed-off-by: Ankit Jain <jankit@suse.de>

---
 fs/partitions/check.c |   10 ++++------
 include/linux/genhd.h |    1 +
 2 files changed, 5 insertions(+), 6 deletions(-)

Index: b/fs/partitions/check.c
===================================================================
--- a/fs/partitions/check.c
+++ b/fs/partitions/check.c
@@ -232,12 +232,8 @@ ssize_t part_alignment_offset_show(struc
 ssize_t part_discard_alignment_show(struct device *dev,
 				   struct device_attribute *attr, char *buf)
 {
-	struct hd_struct *p = dev_to_part(dev);
-	struct gendisk *disk = dev_to_disk(dev);
-
-	return sprintf(buf, "%u\n",
-			queue_limit_discard_alignment(&disk->queue->limits,
-							p->start_sect));
+ 	struct hd_struct *p = dev_to_part(dev);
+	return sprintf(buf, "%u\n", p->discard_alignment);
 }
 
 ssize_t part_stat_show(struct device *dev,
@@ -421,6 +417,8 @@ struct hd_struct *add_partition(struct g
 	p->start_sect = start;
 	p->alignment_offset =
 		queue_limit_alignment_offset(&disk->queue->limits, start);
+	p->discard_alignment =
+		queue_limit_discard_alignment(&disk->queue->limits, start);
 	p->nr_sects = len;
 	p->partno = partno;
 	p->policy = get_disk_ro(disk);
Index: b/include/linux/genhd.h
===================================================================
--- a/include/linux/genhd.h
+++ b/include/linux/genhd.h
@@ -91,6 +91,7 @@ struct hd_struct {
 	sector_t start_sect;
 	sector_t nr_sects;
 	sector_t alignment_offset;
+	unsigned int discard_alignment;
 	struct device __dev;
 	struct kobject *holder_dir;
 	int policy, partno;
