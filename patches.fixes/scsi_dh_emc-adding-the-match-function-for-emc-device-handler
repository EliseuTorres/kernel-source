From: "Moger, Babu" <Babu.Moger@netapp.com>
Subject: [PATCH 1/4] scsi_dh_emc: Adding the match function for emc device handler
Patch-mainline: v3.3-rc1~124^2~66
Git-commit: 4f10143f6e8cd62460920211e1b24b0915d0ab00
References: bnc#726504

This patch introduces the match function for emc device handler.
Included check for TPGS bit before proceeding further.
The match function was introduced by this patch
http://www.spinics.net/lists/linux-scsi/msg54284.html

Signed-off-by: Babu Moger <babu.moger@netapp.com>
Acked-by: Hannes Reinecke <hare@suse.de>
Acked-by: Ankit Jain <jankit@suse.de>
---

--- linux-d211858/drivers/scsi/device_handler/scsi_dh_emc.c.orig	2011-11-02 14:17:15.000000000 -0500
+++ linux-d211858/drivers/scsi/device_handler/scsi_dh_emc.c	2011-11-02 15:13:51.000000000 -0500
@@ -628,6 +628,24 @@ static const struct scsi_dh_devlist clar
 	{NULL, NULL},
 };
 
+static bool clariion_match(struct scsi_device *sdev)
+{
+	int i;
+
+	if (scsi_device_tpgs(sdev))
+		return false;
+
+	for (i = 0; clariion_dev_list[i].vendor; i++) {
+		if (!strncmp(sdev->vendor, clariion_dev_list[i].vendor,
+			strlen(clariion_dev_list[i].vendor)) &&
+		    !strncmp(sdev->model, clariion_dev_list[i].model,
+			strlen(clariion_dev_list[i].model))) {
+			return true;
+		}
+	}
+	return false;
+}
+
 static int clariion_bus_attach(struct scsi_device *sdev);
 static void clariion_bus_detach(struct scsi_device *sdev);
 
@@ -641,6 +659,7 @@ static struct scsi_device_handler clarii
 	.activate	= clariion_activate,
 	.prep_fn	= clariion_prep_fn,
 	.set_params	= clariion_set_params,
+	.match		= clariion_match,
 };
 
 static int clariion_bus_attach(struct scsi_device *sdev)
