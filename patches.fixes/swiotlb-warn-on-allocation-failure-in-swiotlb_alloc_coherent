From: Joerg Roedel <jroedel@suse.de>
Date: Fri, 28 Nov 2014 11:22:10 +0100
Subject: swiotlb: Warn on allocation failure in swiotlb_alloc_coherent
Git-commit: 587377cd9a10afccb4376ffa03a9d50b74c2b0bd
Patch-mainline: not yet
References: bsc#905783

Print a warning when all allocation tries have been failed
and the function is about to return NULL. This prepares for
calling the function with __GFP_NOWARN to suppress
allocation failure warnings before all fall-backs have
failed.

Signed-off-by: Joerg Roedel <jroedel@suse.de>
Acked-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
Acked-by: Baoquan He <bhe@redhat.com>
---
 lib/swiotlb.c | 11 +++++++++--
 1 file changed, 9 insertions(+), 2 deletions(-)

Index: linux-3.12-SLE12/lib/swiotlb.c
===================================================================
--- linux-3.12-SLE12.orig/lib/swiotlb.c
+++ linux-3.12-SLE12/lib/swiotlb.c
@@ -637,7 +637,7 @@ swiotlb_alloc_coherent(struct device *hw
 		 */
 		phys_addr_t paddr = map_single(hwdev, 0, size, DMA_FROM_DEVICE);
 		if (paddr == SWIOTLB_MAP_ERROR)
-			return NULL;
+			goto err_warn;
 
 		ret = phys_to_virt(paddr);
 		dev_addr = phys_to_dma(hwdev, paddr);
@@ -651,7 +651,7 @@ swiotlb_alloc_coherent(struct device *hw
 			/* DMA_TO_DEVICE to avoid memcpy in unmap_single */
 			swiotlb_tbl_unmap_single(hwdev, paddr,
 						 size, DMA_TO_DEVICE);
-			return NULL;
+			goto err_warn;
 		}
 	}
 
@@ -659,6 +659,13 @@ swiotlb_alloc_coherent(struct device *hw
 	memset(ret, 0, size);
 
 	return ret;
+
+err_warn:
+	pr_warn("swiotlb: coherent allocation failed for device %s size=%zu\n",
+		dev_name(hwdev), size);
+	dump_stack();
+
+	return NULL;
 }
 EXPORT_SYMBOL(swiotlb_alloc_coherent);
 
