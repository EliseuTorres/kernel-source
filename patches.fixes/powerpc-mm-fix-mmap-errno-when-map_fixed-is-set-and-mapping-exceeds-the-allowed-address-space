From: "jmarchan@redhat.com" <jmarchan@redhat.com>
Date: Wed, 15 Jan 2014 16:27:11 +0100
Subject: powerpc/mm: Fix mmap errno when MAP_FIXED is set and mapping exceeds
 the allowed address space
Git-commit: 19751c07b3728748c1253627ce94e6906fa5e273
Patch-mainline: v3.14-rc1
References: bsc#930669

According to Posix, if MAP_FIXED is specified mmap shall set ENOMEM if
the requested mapping exceeds the allowed range for address space of
the process. The generic code set it right, but the specific powerpc
slice_get_unmapped_area() function currently returns -EINVAL in that
case.
This patch corrects it.

Signed-off-by: Jerome Marchand <jmarchan@redhat.com>
Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
Acked-by: Joerg Roedel <jroedel@suse.de>
---
 arch/powerpc/mm/slice.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

--- a/arch/powerpc/mm/slice.c
+++ b/arch/powerpc/mm/slice.c
@@ -424,7 +424,7 @@
 	if (fixed && (addr & ((1ul << pshift) - 1)))
 		return -EINVAL;
 	if (fixed && addr > (mm->task_size - len))
-		return -EINVAL;
+		return -ENOMEM;
 
 	/* If hint, make sure it matches our alignment restrictions */
 	if (!fixed && addr) {
