Subject: block: add proper state guards to __elv_next_request
From: James Bottomley <James.Bottomley@suse.de>
Date: 2011-04-22 15:38:51
Patch-mainline: submitted
References: http://marc.info/?l=linux-scsi&m=130348673628282

blk_cleanup_queue() calls elevator_exit() and after this, we can't
touch the elevator without oopsing.  __elv_next_request() must check
for this state because in the refcounted queue model, we can still
call it after blk_cleanup_queue() has been called.

This was reported as causing an oops attributable to scsi.

Signed-off-by: James Bottomley <James.Bottomley@suse.de>
Acked-by: Mike Galbraith <mgalbraith@suse.de>
---
 block/blk.h |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

Index: linux-2.6.32-SLE11-SP1/block/blk.h
===================================================================
--- linux-2.6.32-SLE11-SP1.orig/block/blk.h
+++ linux-2.6.32-SLE11-SP1/block/blk.h
@@ -62,7 +62,8 @@ static inline struct request *__elv_next
 				return rq;
 		}
 
-		if (!q->elevator->ops->elevator_dispatch_fn(q, 0))
+		if (test_bit(QUEUE_FLAG_DEAD, &q->queue_flags) ||
+		    !q->elevator->ops->elevator_dispatch_fn(q, 0))
 			return NULL;
 	}
 }
