From: Goldwyn Rodrigues <rgoldwyn@suse.com>
Subject: [PATCH] Remove filesize checks for sync I/O journal commit
References: bnc#800255
Patch-mainline: next-20141121

Filesize is not a good indication that the file needs to be synced.
An example where this breaks is:
 1. Open the file in O_SYNC|O_RDWR
 2. Read a small portion of the file (say 64 bytes)
 3. Lseek to starting of the file
 4. Write 64 bytes

If the node crashes, it is not written out to disk because this
was not committed in the journal and the other node which reads
the file after recovery reads stale data (even if the write on
the other node was successful)

Index: linux-3.0-SLE11-SP3/fs/ocfs2/file.c
===================================================================
--- linux-3.0-SLE11-SP3.orig/fs/ocfs2/file.c
+++ linux-3.0-SLE11-SP3/fs/ocfs2/file.c
@@ -2391,9 +2391,7 @@ out_dio:
 		if (ret < 0)
 			written = ret;
 
-		if (!ret && ((old_size != i_size_read(inode)) ||
-			     (old_clusters != OCFS2_I(inode)->ip_clusters) ||
-			     has_refcount)) {
+		if (!ret) {
 			ret = jbd2_journal_force_commit(osb->journal->j_journal);
 			if (ret < 0)
 				written = ret;
