From 14af2e3ca52adfd8232dcf42894dac62d02130d4 Mon Sep 17 00:00:00 2001
From: Ales Novak <alnovak@suse.cz>
Date: Tue, 28 Jul 2015 09:46:23 +0200
Patch-mainline: none
References: bnc#925705
Subject: [PATCH] fix: check logbsize is integer multiple of lsunit

Logbsize should be integer multiple of log stripe unit size. If it's
not, various operations will lead to crashes, due to invalid buffer
sizes, i.e. we've seen crashes in the callpath
xlog_sync->xlog_pack_data.

However, this rule is only mentioned in the documentation, while it
could be checked during the mount.

Signed-off-by: Ales Novak <alnovak@suse.cz>
---
 fs/xfs/linux-2.6/xfs_super.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/fs/xfs/linux-2.6/xfs_super.c b/fs/xfs/linux-2.6/xfs_super.c
index 36da8b2..f613ead 100644
--- a/fs/xfs/linux-2.6/xfs_super.c
+++ b/fs/xfs/linux-2.6/xfs_super.c
@@ -1377,6 +1377,12 @@ xfs_finish_flags(
 			xfs_warn(mp,
 		"logbuf size must be greater than or equal to log stripe size");
 			return XFS_ERROR(EINVAL);
+		} else if (mp->m_logbsize > 0 && mp->m_sb.sb_logsunit > 0 &&
+			   mp->m_logbsize % mp->m_sb.sb_logsunit) {
+			xfs_warn(mp,
+		"logbuf size must be integer multiple of log stripe size");
+			return XFS_ERROR(EINVAL);
+
 		}
 	} else {
 		/* Fail a mount if the logbuf is larger than 32K */
-- 
2.4.1.168.g1ea28e1

