From: Miklos Szeredi <mszeredi@suse.cz>
Subject: audit: keep inode pinned
Date: Tue Nov 4 11:27:12 2014 +0100
References: bsc#851068
Git-commit: 799b601451b21ebe7af0e6e8f6e2ccd4683c5064
Patch-mainline: v3.19-rc2
Signed-off-by: Tony Jones <tonyj@suse.de>

    audit: keep inode pinned
    
    Audit rules disappear when an inode they watch is evicted from the cache.
    This is likely not what we want.
    
    The guilty commit is "fsnotify: allow marks to not pin inodes in core",
    which didn't take into account that audit_tree adds watches with a zero
    mask.
    
    Adding any mask should fix this.
    
    Fixes: 90b1e7a57880 ("fsnotify: allow marks to not pin inodes in core")
    Signed-off-by: Miklos Szeredi <mszeredi@suse.cz>
    Cc: stable@vger.kernel.org # 2.6.36+
    Signed-off-by: Paul Moore <pmoore@redhat.com>

diff --git a/kernel/audit_tree.c b/kernel/audit_tree.c
index e242e3a..80f29e0 100644
--- a/kernel/audit_tree.c
+++ b/kernel/audit_tree.c
@@ -154,6 +154,7 @@ static struct audit_chunk *alloc_chunk(int count)
 		chunk->owners[i].index = i;
 	}
 	fsnotify_init_mark(&chunk->mark, audit_tree_destroy_watch);
+	chunk->mark.mask = FS_IN_IGNORED;
 	return chunk;
 }
 
