From: Jeff Layton <jlayton@redhat.com>
Date: Tue, 11 Dec 2012 12:10:05 -0500
Subject: [PATCH 02/28] vfs: make fstatat retry on ESTALE errors from getattr
 call
Git-commit: 836fb7e7b978e5f3b8b52e40838ddc50264723f0
Patch-mainline: v3.8
References: bnc#876463

Signed-off-by: Jeff Layton <jlayton@redhat.com>
Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Acked-by: NeilBrown <neilb@suse.de>

---
 fs/stat.c |    8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

--- linux-3.0-SLE11-SP3.orig/fs/stat.c
+++ linux-3.0-SLE11-SP3/fs/stat.c
@@ -73,7 +73,7 @@ int vfs_fstatat(int dfd, const char __us
 {
 	struct path path;
 	int error = -EINVAL;
-	int lookup_flags = 0;
+	unsigned int lookup_flags = 0;
 
 	if ((flag & ~(AT_SYMLINK_NOFOLLOW | AT_NO_AUTOMOUNT |
 		      AT_EMPTY_PATH)) != 0)
@@ -85,13 +85,17 @@ int vfs_fstatat(int dfd, const char __us
 		lookup_flags |= LOOKUP_NO_AUTOMOUNT;
 	if (flag & AT_EMPTY_PATH)
 		lookup_flags |= LOOKUP_EMPTY;
-
+retry:
 	error = user_path_at(dfd, filename, lookup_flags, &path);
 	if (error)
 		goto out;
 
 	error = vfs_getattr(path.mnt, path.dentry, stat);
 	path_put(&path);
+	if (retry_estale(error, lookup_flags)) {
+		lookup_flags |= LOOKUP_REVAL;
+		goto retry;
+	}
 out:
 	return error;
 }
