From: Trond Myklebust <Trond.Myklebust@netapp.com>
Date: Tue, 2 Oct 2012 17:09:00 -0700
Subject: [PATCH] NFSv4: nfs4_open_done first must check that GETATTR decoded a
 file type
Git-commit: 807d66d80221920729a8d4abfa04246546a6d3fa
Patch-mainline: v3.7
References: bnc#899574

...before it can check the validity of that file type.

Signed-off-by: Trond Myklebust <Trond.Myklebust@netapp.com>
Acked-by: NeilBrown <neilb@suse.de>

---
 fs/nfs/nfs4proc.c |    4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

--- linux-3.0-SLE11-SP3.orig/fs/nfs/nfs4proc.c
+++ linux-3.0-SLE11-SP3/fs/nfs/nfs4proc.c
@@ -1504,7 +1504,8 @@ static void nfs4_open_done(struct rpc_ta
 		return;
 
 	if (task->tk_status == 0) {
-		switch (data->o_res.f_attr->mode & S_IFMT) {
+		if (data->o_res.f_attr->valid & NFS_ATTR_FATTR_TYPE) {
+			switch (data->o_res.f_attr->mode & S_IFMT) {
 			case S_IFREG:
 				break;
 			case S_IFLNK:
@@ -1515,6 +1516,7 @@ static void nfs4_open_done(struct rpc_ta
 				break;
 			default:
 				data->rpc_status = -ENOTDIR;
+			}
 		}
 		renew_lease(data->o_res.server, data->timestamp);
 		if (!(data->o_res.rflags & NFS4_OPEN_RESULT_CONFIRM))
