From: Hannes Reinecke <hare@suse.de>
Date: Thu, 31 Jul 2014 12:25:06 +0200
Subject: scsi_dh: use missing accessor 'scsi_device_from_queue'
References: bnc#889614
Patch-Mainline: n/a

We need to use accessors 'scsi_device_from_queue' to ensure we
only dereference SCSI devices.

Signed-off-by: Hannes Reinecke <hare@suse.de>
---
 drivers/scsi/device_handler/scsi_dh.c | 2 +-
 drivers/scsi/scsi_lib.c               | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/scsi/device_handler/scsi_dh.c b/drivers/scsi/device_handler/scsi_dh.c
index 783ae28..72ab874 100644
--- a/drivers/scsi/device_handler/scsi_dh.c
+++ b/drivers/scsi/device_handler/scsi_dh.c
@@ -548,7 +548,7 @@ const char *scsi_dh_attached_handler_name(struct request_queue *q, gfp_t gfp)
 	const char *handler_name = NULL;
 
 	spin_lock_irqsave(q->queue_lock, flags);
-	sdev = q->queuedata;
+	sdev = scsi_device_from_queue(q);
 	if (!sdev || !get_device(&sdev->sdev_gendev))
 		sdev = NULL;
 	spin_unlock_irqrestore(q->queue_lock, flags);
diff --git a/drivers/scsi/scsi_lib.c b/drivers/scsi/scsi_lib.c
index 9cb0af0..c61dbe4 100644
--- a/drivers/scsi/scsi_lib.c
+++ b/drivers/scsi/scsi_lib.c
@@ -1651,7 +1651,7 @@ struct scsi_device *scsi_device_from_queue(struct request_queue *q)
 {
 	struct scsi_device *sdev = NULL;
 
-	if (q->request_fn == scsi_request_fn)
+	if (q && q->request_fn == scsi_request_fn)
 		sdev = q->queuedata;
 
 	return sdev;
-- 
1.8.5.2

