From: Josef Cejka <jcejka@dhcp1.suse.cz>
Subject: [PATCH] Fix missing crypto allocation
References: bnc#937402
Patch-mainline: never, bug in our backport

Fix missing call of cifs_crypto_shash_md5_allocate() from method
cifs_calc_signature2().  It was added by patch from bsc#925729 to
cifs_calculate_signature() but not to its version with kvec argument
cifs_calc_signature2().

The problem was caused by backporting patch that moved crypto context
initialization to method cifs_calculate_signature() which was in SLE11-SP3
kernel duplicated and the second function (cifs_calc_signature2()) was not
updated.

[jkosina@suse.com: reformatted to fit SUSE patch format and added changelog
 from Jan Cejka]

Signed-off-by: Jiri Kosina <jkosina@suse.com>

---
 fs/cifs/cifsencrypt.c | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/fs/cifs/cifsencrypt.c b/fs/cifs/cifsencrypt.c
index e0f1537..566db7d 100644
--- a/fs/cifs/cifsencrypt.c
+++ b/fs/cifs/cifsencrypt.c
@@ -139,8 +139,11 @@ static int cifs_calc_signature2(const struct kvec *iov, int n_vec,
 		return -EINVAL;
 
 	if (!server->secmech.sdescmd5) {
-		cERROR(1, "%s: Can't generate signature\n", __func__);
-		return -1;
+		rc = cifs_crypto_shash_md5_allocate(server);
+		if (rc) {
+			cERROR(1, "%s: Can't alloc md5 crypto\n", __func__);
+			return -1;
+		}
 	}
 
 	rc = crypto_shash_init(&server->secmech.sdescmd5->shash);
-- 
2.1.4

