From 8c7dc2604c72f3d7ba4c89b83864c45b9eb8b9ae Mon Sep 17 00:00:00 2001
From: Mark Fasheh <mfasheh@suse.com>
Date: Wed, 4 Aug 2010 14:05:17 -0700
Subject: ocfs2: use ocfs2_alloc_dinode_update_counts() instead of open coding
References: bnc#626321
Patch-mainline: v2.6.36
Git-commit: 8c7dc2604c72f3d7ba4c89b83864c45b9eb8b9ae

ocfs2_search_chain() makes the same updates as
ocfs2_alloc_dinode_update_counts to the alloc inode. Instead of open coding
the bitmap update, use our helper function.

Signed-off-by: Mark Fasheh <mfasheh@suse.com>

Index: linux-2.6.32-ocfs2-unbreakable/fs/ocfs2/suballoc.c
===================================================================
--- linux-2.6.32-ocfs2-unbreakable.orig/fs/ocfs2/suballoc.c
+++ linux-2.6.32-ocfs2-unbreakable/fs/ocfs2/suballoc.c
@@ -1427,7 +1427,6 @@ static int ocfs2_search_chain(struct ocf
 {
 	int status;
 	u16 chain, tmp_bits;
-	u32 tmp_used;
 	u64 next_group;
 	struct inode *alloc_inode = ac->ac_inode;
 	struct buffer_head *group_bh = NULL;
@@ -1512,29 +1511,10 @@ static int ocfs2_search_chain(struct ocf
 		}
 	}
 
-	/* Ok, claim our bits now: set the info on dinode, chainlist
-	 * and then the group */
-	status = ocfs2_journal_access_di(handle,
-					 INODE_CACHE(alloc_inode),
-					 ac->ac_bh,
-					 OCFS2_JOURNAL_ACCESS_WRITE);
-	if (status < 0) {
-		mlog_errno(status);
-		goto bail;
-	}
-
-	tmp_used = le32_to_cpu(fe->id1.bitmap1.i_used);
-	fe->id1.bitmap1.i_used = cpu_to_le32(*num_bits + tmp_used);
-	le32_add_cpu(&cl->cl_recs[chain].c_free, -(*num_bits));
-	ocfs2_journal_dirty(handle, ac->ac_bh);
-
-	status = ocfs2_block_group_set_bits(handle,
-					    alloc_inode,
-					    bg,
-					    group_bh,
-					    *bit_off,
-					    *num_bits);
-	if (status < 0) {
+	status = ocfs2_alloc_dinode_update_counts(alloc_inode, handle,
+						  ac->ac_bh, *num_bits,
+						  chain);
+	if (status) {
 		mlog_errno(status);
 		goto bail;
 	}
