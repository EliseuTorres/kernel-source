From: Hannes Reinecke <hare@suse.de>
Date: Tue, 25 Jun 2013 14:55:12 +0200
Subject: dm-multipath: abort all requests when failing a path
References: bnc#798050
Patch-Mainline: not yet

When multipath needs to fail a path is should terminate all
outstanding requests; this speeds up path failover.

Signed-off-by: Hannes Reinecke <hare@suse.de>
---
 drivers/md/dm-mpath.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/drivers/md/dm-mpath.c b/drivers/md/dm-mpath.c
index 3960362..5460895 100644
--- a/drivers/md/dm-mpath.c
+++ b/drivers/md/dm-mpath.c
@@ -1034,6 +1034,9 @@ static int fail_path(struct pgpath *pgpath)
 	if (pgpath == m->current_pgpath)
 		m->current_pgpath = NULL;
 
+	if (pgpath->path.dev)
+		blk_abort_queue(bdev_get_queue(pgpath->path.dev->bdev));
+
 	dm_path_uevent(DM_UEVENT_PATH_FAILED, m->ti,
 		       pgpath->path.pdev, m->nr_valid_paths);
 
-- 
1.7.12.4

