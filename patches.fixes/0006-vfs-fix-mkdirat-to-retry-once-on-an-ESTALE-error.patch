From: Jeff Layton <jlayton@redhat.com>
Date: Thu, 20 Dec 2012 16:04:09 -0500
Subject: [PATCH 06/28] vfs: fix mkdirat to retry once on an ESTALE error
Git-commit: b76d8b82266077dc7098dd13f321a616099a1bd8
Patch-mainline: v3.8
References: bnc#876463

Signed-off-by: Jeff Layton <jlayton@redhat.com>
Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Acked-by: NeilBrown <neilb@suse.de>

---
 fs/namei.c |    8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

--- linux-3.0-SLE11-SP3.orig/fs/namei.c
+++ linux-3.0-SLE11-SP3/fs/namei.c
@@ -2629,8 +2629,10 @@ SYSCALL_DEFINE3(mkdirat, int, dfd, const
 	char * tmp;
 	struct dentry *dentry;
 	struct nameidata nd;
+	unsigned int lookup_flags = 0;
 
-	error = user_path_parent(dfd, pathname, &nd, &tmp, 0);
+retry:
+	error = user_path_parent(dfd, pathname, &nd, &tmp, lookup_flags);
 	if (error)
 		goto out_err;
 
@@ -2657,6 +2659,10 @@ out_unlock:
 	path_put(&nd.path);
 	putname(tmp);
 out_err:
+	if (retry_estale(error, lookup_flags)) {
+		lookup_flags |= LOOKUP_REVAL;
+		goto retry;
+	}
 	return error;
 }
 
