From: Miklos Szeredi <mszeredi@suse.cz>
Subject: splice: add generic_write_checks()
Patch-mainline: Never, fixed differently 
References: bnc#915322 CVE-2014-7822

It was found that there are no size checks in the splice IO path, so it's
possible to send a write past s_maxbytes to a filesystem.  For ext4, at
least, this ends badly, with a BUG_ON.

Upstream commit that fixes this as a byproduct:

  8d0207652cbe ("->splice_write() via ->write_iter()")

Signed-off-by: Miklos Szeredi <mszeredi@suse.cz>
---
 fs/splice.c |   12 ++++++++++++
 1 file changed, 12 insertions(+)

--- a/fs/splice.c
+++ b/fs/splice.c
@@ -1006,11 +1006,23 @@ generic_file_splice_write(struct pipe_in
 
 	splice_from_pipe_begin(&sd);
 	do {
+		size_t tmp_count = sd.total_len;
+		loff_t tmp_pos = sd.pos;
+
 		ret = splice_from_pipe_next(pipe, &sd);
 		if (ret <= 0)
 			break;
 
 		mutex_lock_nested(&inode->i_mutex, I_MUTEX_CHILD);
+		ret = generic_write_checks(out, &tmp_pos, &tmp_count,
+					   S_ISBLK(inode->i_mode));
+		if (ret < 0 || tmp_count == 0) {
+			mutex_unlock(&inode->i_mutex);
+			break;
+		}
+		sd.total_len = tmp_count;
+		WARN_ON(sd.pos != tmp_pos);
+
 		ret = file_remove_suid(out);
 		if (!ret) {
 			ret = file_update_time(out);
