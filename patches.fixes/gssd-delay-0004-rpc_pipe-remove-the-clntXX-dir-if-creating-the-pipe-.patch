Git-commit: 3396f92f8be606ea485b0a82d4e7749a448b013b
From: Jeff Layton <jlayton@redhat.com>
Date: Thu, 5 Dec 2013 07:33:49 -0500
Subject: [PATCH] rpc_pipe: remove the clntXX dir if creating the pipe fails
Patch-mainline: v3.14
References: bnc#864413

In the event that we create the gssd/clntXX dir, but the pipe creation
subsequently fails, then we should remove the clntXX dir before
returning.

Signed-off-by: Jeff Layton <jlayton@redhat.com>
Signed-off-by: Trond Myklebust <Trond.Myklebust@netapp.com>
Acked-by: NeilBrown <neilb@suse.de>

---
 net/sunrpc/rpc_pipe.c |    2 ++
 1 file changed, 2 insertions(+)

--- linux-3.12-SLE12.orig/net/sunrpc/rpc_pipe.c
+++ linux-3.12-SLE12/net/sunrpc/rpc_pipe.c
@@ -1322,6 +1322,8 @@ rpc_gssd_dummy_populate(struct dentry *r
 	}
 
 	pipe_dentry = rpc_mkpipe_dentry(clnt_dentry, "gssd", NULL, pipe_data);
+	if (IS_ERR(pipe_dentry))
+		__rpc_depopulate(gssd_dentry, gssd_dummy_clnt_dir, 0, 1);
 out:
 	dput(clnt_dentry);
 	dput(gssd_dentry);
