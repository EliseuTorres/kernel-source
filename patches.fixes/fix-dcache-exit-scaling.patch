From: Miklos Szeredi <mszeredi@suse.cz>
Subject: fix dcache exit scaling
Patch-mainline: no
References: bnc#876594

HP is reporting contention on the global dcache_lru_lock spinlock when many
tasks are calling proc_flush_task() on thread exit.

Add a mutex to protect against the cacheline bouncing.  HP reports an
improved performance with the patch.

Signed-off-by: Miklos Szeredi <mszeredi@suse.cz>
---
 fs/proc/base.c |    3 +++
 1 file changed, 3 insertions(+)
--- a/fs/proc/base.c
+++ b/fs/proc/base.c
@@ -2952,15 +2952,18 @@ void proc_flush_task(struct task_struct
 	int i;
 	struct pid *pid, *tgid;
 	struct upid *upid;
+	static DEFINE_MUTEX(lock);
 
 	pid = task_pid(task);
 	tgid = task_tgid(task);
 
+	mutex_lock(&lock);
 	for (i = 0; i <= pid->level; i++) {
 		upid = &pid->numbers[i];
 		proc_flush_task_mnt(upid->ns->proc_mnt, upid->nr,
 					tgid->numbers[i].nr);
 	}
+	mutex_unlock(&lock);
 
 	upid = &pid->numbers[pid->level];
 	if (upid->nr == 1)
