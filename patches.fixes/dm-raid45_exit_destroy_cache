From: Nikanth Karthikesan <knikanth@suse.de>
Subject: Free recovery stripes before destroying cache and do not destroy dirty log twice
References: bnc#565962
Patch-mainline: No

Free recovery stripes before destroying cache and do not destroy dirty log twice.

Signed-off-by: Nikanth Karthikesan <knikanth@suse.de>

---

Index: linux-2.6.32-SLE11-SP1/drivers/md/dm-raid45.c
===================================================================
--- linux-2.6.32-SLE11-SP1.orig/drivers/md/dm-raid45.c
+++ linux-2.6.32-SLE11-SP1/drivers/md/dm-raid45.c
@@ -1596,14 +1596,14 @@ static void sc_exit(struct stripe_cache
 {
 	if (sc->kc.cache) {
 		BUG_ON(sc_shrink(sc, atomic_read(&sc->stripes)));
+		ClearRSRecover(RS(sc));
+		stripe_recover_free(RS(sc));
 		kmem_cache_destroy(sc->kc.cache);
 	}
 
 	if (sc->mem_cache_client)
 		dm_mem_cache_client_destroy(sc->mem_cache_client);
 
-	ClearRSRecover(RS(sc));
-	stripe_recover_free(RS(sc));
 	if (RS(sc)->recover.mem_cache_client)
 		dm_mem_cache_client_destroy(RS(sc)->recover.mem_cache_client);
 
@@ -3511,8 +3511,7 @@ context_free(struct raid_set *rs, struct
 
 	dm_io_client_destroy(rs->sc.dm_io_client);
 	sc_exit(&rs->sc);
-	dm_region_hash_destroy(rs->recover.rh);
-	dm_dirty_log_destroy(rs->recover.dl);
+	dm_region_hash_destroy(rs->recover.rh);  /* Destroys dirty log as well. */
 	kfree(rs);
 }
 
