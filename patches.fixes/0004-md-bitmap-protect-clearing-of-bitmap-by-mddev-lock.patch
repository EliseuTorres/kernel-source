From: NeilBrown <neilb@suse.de>
Date: Mon, 15 Dec 2014 12:56:58 +1100
Subject: md/bitmap: protect clearing of ->bitmap by mddev->lock
References: bnc#912183
Patch-Mainline: v4.0-rc1
Git-commit: 978a7a47cae79ae7a7b5a1e80bfcaef6ee700312

This makes it safe to inspect the struct while holding only
the spinlock.

Signed-off-by: NeilBrown <neilb@suse.de>
Acked-by: Hannes Reinecke <hare@suse.de>
---
 drivers/md/bitmap.c |    2 ++
 1 file changed, 2 insertions(+)

--- a/drivers/md/bitmap.c
+++ b/drivers/md/bitmap.c
@@ -1637,7 +1637,9 @@ void bitmap_destroy(struct mddev *mddev)
 		return;
 
 	mutex_lock(&mddev->bitmap_info.mutex);
+	spin_lock(&mddev->write_lock);
 	mddev->bitmap = NULL; /* disconnect from the md device */
+	spin_unlock(&mddev->write_lock);
 	mutex_unlock(&mddev->bitmap_info.mutex);
 	if (mddev->thread)
 		mddev->thread->timeout = MAX_SCHEDULE_TIMEOUT;
