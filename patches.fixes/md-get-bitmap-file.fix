From: NeilBrown <neilb@suse.de>
Subject: md: Fix problem with GET_BITMAP_FILE returning wrong status.
Patch-mainline: not revelant
References: bnc#812974

The patch:
    patches.suse/md-Do-not-block-when-displaying-info.patch
change the way GET_BITMAP_FILE was handled such that it now returns
an error if the array doesn't exist.  This is a change and confused
mdadm is some cases - particularly causes an incorrect error message.

So restore non-error behaviour when array doesn't exist - just return
empty string.


Acked-by: NeilBrown <neilb@suse.de>
Signed-off-by: Neil Brown <neilb@suse.de>

---
 drivers/md/md.c |   13 +++++--------
 1 file changed, 5 insertions(+), 8 deletions(-)

--- linux-3.0-SLE11-SP2.orig/drivers/md/md.c
+++ linux-3.0-SLE11-SP2/drivers/md/md.c
@@ -5480,7 +5480,7 @@ static int get_bitmap_file(mddev_t * mdd
 	char *ptr, *buf = NULL;
 	int err = -ENOMEM;
 
-	if (md_allow_write(mddev))
+	if (mddev && md_allow_write(mddev))
 		file = kmalloc(sizeof(*file), GFP_NOIO);
 	else
 		file = kmalloc(sizeof(*file), GFP_KERNEL);
@@ -5489,7 +5489,7 @@ static int get_bitmap_file(mddev_t * mdd
 		goto out;
 
 	/* bitmap disabled, zero the first byte and copy out */
-	if (!mddev->bitmap || !mddev->bitmap->storage.file) {
+	if (!mddev || !mddev->bitmap || !mddev->bitmap->storage.file) {
 		file->pathname[0] = '\0';
 		goto copy_out;
 	}
@@ -6237,12 +6237,9 @@ static int md_ioctl(struct block_device
 
 		case GET_BITMAP_FILE:
 			mddev = mddev_get_safe(bdev->bd_disk->private_data);
-			err = -ENODEV;
-			if (!mddev)
-				goto abort;
-			if (mddev->raid_disks || mddev->external)
-				err = get_bitmap_file(mddev, argp);
-			mddev_put(mddev);
+			err = get_bitmap_file(mddev, argp);
+			if (mddev)
+				mddev_put(mddev);
 			goto abort;
 
 		case GET_DISK_INFO:
