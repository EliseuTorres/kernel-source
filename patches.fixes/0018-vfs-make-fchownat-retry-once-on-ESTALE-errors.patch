From: Jeff Layton <jlayton@redhat.com>
Date: Tue, 11 Dec 2012 12:10:13 -0500
Subject: [PATCH 18/28] vfs: make fchownat retry once on ESTALE errors
Git-commit: 99a5df37a03c99e57d0da4f847a515b658963fbb
Patch-mainline: v3.8
References: bnc#876463

Signed-off-by: Jeff Layton <jlayton@redhat.com>
Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Acked-by: NeilBrown <neilb@suse.de>

---
 fs/open.c |    5 +++++
 1 file changed, 5 insertions(+)

--- linux-3.0-SLE11-SP3.orig/fs/open.c
+++ linux-3.0-SLE11-SP3/fs/open.c
@@ -611,6 +611,7 @@ SYSCALL_DEFINE5(fchownat, int, dfd, cons
 	lookup_flags = (flag & AT_SYMLINK_NOFOLLOW) ? 0 : LOOKUP_FOLLOW;
 	if (flag & AT_EMPTY_PATH)
 		lookup_flags |= LOOKUP_EMPTY;
+retry:
 	error = user_path_at(dfd, filename, lookup_flags, &path);
 	if (error)
 		goto out;
@@ -621,6 +622,10 @@ SYSCALL_DEFINE5(fchownat, int, dfd, cons
 	mnt_drop_write(path.mnt);
 out_release:
 	path_put(&path);
+	if (retry_estale(error, lookup_flags)) {
+		lookup_flags |= LOOKUP_REVAL;
+		goto retry;
+	}
 out:
 	return error;
 }
