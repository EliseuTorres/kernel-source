From: Timo Warns <Warns@pre-sense.de>
Date: Fri, 6 May 2011 13:47:35 +0200
Subject: [PATCH] Validate size of EFI GUID partition entries.
Git-commit: fa039d5f6b126fbd65eefa05db2f67e44df8f121
References: bnc#692784, CVE-2011-1776
Patch-mainline: v2.6.39-rc7

Otherwise corrupted EFI partition tables can cause total confusion.

Signed-off-by: Timo Warns <warns@pre-sense.de>
Cc: stable@kernel.org
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Acked-by: Michal Hocko <mhocko@suse.cz>
Acked-by: Miklos Szeredi <mszeredi@suse.cz>
---
 fs/partitions/efi.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

Index: linux-2.6.16-SLES10-SP3-TD/fs/partitions/efi.c
===================================================================
--- linux-2.6.16-SLES10-SP3-TD.orig/fs/partitions/efi.c
+++ linux-2.6.16-SLES10-SP3-TD/fs/partitions/efi.c
@@ -363,6 +363,12 @@ is_gpt_valid(struct block_device *bdev,
 		goto fail;
 	}
 
+	/* Check that sizeof_partition_entry has the correct value */
+	if (le32_to_cpu((*gpt)->sizeof_partition_entry) != sizeof(gpt_entry)) {
+		pr_debug("GUID Partitition Entry Size check failed.\n");
+		goto fail;
+	}
+
 	if (!(*ptes = alloc_read_gpt_entries(bdev, *gpt)))
 		goto fail;
 

