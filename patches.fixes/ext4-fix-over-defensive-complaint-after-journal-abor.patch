From: Dmitry Monakhov <dmonakhov@openvz.org>
Date: Wed, 1 Oct 2014 22:23:15 -0400
Subject: [PATCH 1/3] ext4: fix over-defensive complaint after journal abort
Git-commit: c5d311926da483951bd5da637ed65de8614d1901
Patch-mainline: v3.18-rc2
References: bsc#935174

Reviewed-by: Jan Kara <jack@suse.cz>
Signed-off-by: Dmitry Monakhov <dmonakhov@openvz.org>
Signed-off-by: Theodore Ts'o <tytso@mit.edu>

---
 fs/ext4/ext4_jbd2.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/fs/ext4/ext4_jbd2.c b/fs/ext4/ext4_jbd2.c
index 3fe29de..0212b2f 100644
--- a/fs/ext4/ext4_jbd2.c
+++ b/fs/ext4/ext4_jbd2.c
@@ -255,8 +255,8 @@ int __ext4_handle_dirty_metadata(const char *where, unsigned int line,
 	set_buffer_prio(bh);
 	if (ext4_handle_valid(handle)) {
 		err = jbd2_journal_dirty_metadata(handle, bh);
-		/* Errors can only happen if there is a bug */
-		if (WARN_ON_ONCE(err)) {
+		/* Errors can only happen due to aborted journal or a nasty bug */
+		if (!is_handle_aborted(handle) && WARN_ON_ONCE(err)) {
 			ext4_journal_abort_handle(where, line, __func__, bh,
 						  handle, err);
 			ext4_error_inode(inode, where, line,
-- 
2.4.1.168.g1ea28e1

