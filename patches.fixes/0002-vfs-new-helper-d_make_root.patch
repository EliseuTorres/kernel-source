From: Al Viro <viro@zeniv.linux.org.uk>
Date: Sun, 8 Jan 2012 16:49:21 -0500
Subject: [PATCH] vfs: new helper - d_make_root()

Git-commit: adc0e91ab142abe93f5b0d7980ada8a7676231fe
Patch-mainline: v3.3
References: fate#314499, fate#314509
Target: SLE-11 SP3

d_alloc_root() with iput() in case of allocation failure...

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Acked-by: Lee, Chun-Yi <jlee@suse.com>
---
 fs/dcache.c            |   17 +++++++++++++++++
 include/linux/dcache.h |    1 +
 2 files changed, 18 insertions(+)

--- a/fs/dcache.c
+++ b/fs/dcache.c
@@ -1552,6 +1552,23 @@ struct dentry * d_alloc_root(struct inod
 }
 EXPORT_SYMBOL(d_alloc_root);
 
+struct dentry *d_make_root(struct inode *root_inode)
+{
+	struct dentry *res = NULL;
+
+	if (root_inode) {
+		static const struct qstr name = { .name = "/", .len = 1 };
+
+		res = __d_alloc(root_inode->i_sb, &name);
+		if (res)
+			d_instantiate(res, root_inode);
+		else
+			iput(root_inode);
+	}
+	return res;
+}
+EXPORT_SYMBOL(d_make_root);
+
 static struct dentry * __d_find_any_alias(struct inode *inode)
 {
 	struct dentry *alias;
--- a/include/linux/dcache.h
+++ b/include/linux/dcache.h
@@ -255,6 +255,7 @@ extern int d_invalidate(struct dentry *)
 
 /* only used at mount-time */
 extern struct dentry * d_alloc_root(struct inode *);
+extern struct dentry * d_make_root(struct inode *);
 
 /* <clickety>-<click> the ramfs-type tree */
 extern void d_genocide(struct dentry *);
