From: James M Leddy <james.leddy@redhat.com>
Subject: udp: Add MIB counters for rcvbuferrors
Git-commit: 3e215c8d1b6b772d107f1811b5ee8eae7a046fb4
Patch-mainline: v3.16
References: bnc#909565
Acked-by: Jiri Bohac <jbohac@suse.cz>

Add MIB counters for rcvbuferrors in UDP to help diagnose problems.

Signed-off-by: James M Leddy <james.leddy@redhat.com>
Acked-by: Eric Dumazet <edumazet@google.com>
Signed-off-by: David S. Miller <davem@davemloft.net>

diff --git a/net/ipv4/udp.c b/net/ipv4/udp.c
index 0887461..e54a31e 100644
--- a/net/ipv4/udp.c
+++ b/net/ipv4/udp.c
@@ -1462,8 +1462,11 @@ int udp_queue_rcv_skb(struct sock *sk, struct sk_buff *skb)
 	}
 
 
-	if (sk_rcvqueues_full(sk, skb))
+	if (sk_rcvqueues_full(sk, skb)) {
+		UDP_INC_STATS_BH(sock_net(sk), UDP_MIB_RCVBUFERRORS,
+				 is_udplite);
 		goto drop;
+	}
 
 	rc = 0;
 
diff --git a/net/ipv6/udp.c b/net/ipv6/udp.c
index 2a1a4f2..a521f7b 100644
--- a/net/ipv6/udp.c
+++ b/net/ipv6/udp.c
@@ -787,6 +787,8 @@ int __udp6_lib_rcv(struct sk_buff *skb, struct udp_table *udptable,
 	/* deliver */
 
 	if (sk_rcvqueues_full(sk, skb)) {
+		UDP_INC_STATS_BH(sock_net(sk), UDP_MIB_RCVBUFERRORS,
+				 IS_UDPLITE(sk));
 		sock_put(sk);
 		goto discard;
 	}
