From john.johansen@canonical.com  Tue Nov 17 11:13:50 2009
From: John Johansen <john.johansen@canonical.com>
Date: Tue, 15 Sep 2009 10:10:55 +0000 (-0700)
Subject: AppArmor: Fix profile namespace removal.
Git-commit: f63a3351411c9008147132ac7bb88b835c92fc4a
Git-Repo: git://kernel.ubuntu.com/jj/apparmor-mainline.git AppArmor-2.4

AppArmor: Fix profile namespace removal.

Reenable the removal of profile namespaces, and fix the default namespace
case so that the default namespace is not accidentally removed.

Signed-off-by: John Johansen <john.johansen@canonical.com>
Acked-by: Jeff Mahoney <jeffm@suse.com>

---
 security/apparmor/policy_interface.c |    5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

--- a/security/apparmor/policy_interface.c
+++ b/security/apparmor/policy_interface.c
@@ -822,7 +822,10 @@ ssize_t aa_interface_remove_profiles(cha
 	write_lock(&ns->base.lock);
 	if (!name) {
 		/* remove namespace */
-	  //		__aa_remove_namespace(ns);
+		if (ns == default_namespace)
+			__aa_profile_list_release(&ns->base.profiles);
+		else
+			__aa_remove_namespace(ns);
 	} else {
 		/* remove profile */
 		profile = __aa_find_profile_by_fqname(ns, name);
