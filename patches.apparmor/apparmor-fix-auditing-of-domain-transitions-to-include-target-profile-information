From john.johansen@canonical.com  Tue Nov 17 11:13:49 2009
From: John Johansen <john.johansen@canonical.com>
Date: Fri, 17 Jul 2009 15:51:23 +0000 (-0700)
Subject: AppArmor: fix auditing of domain transitions to include target profile information
Git-commit: 75da64947c8ca56439c1b9145962ce515fc178ff
Git-Repo: git://kernel.ubuntu.com/jj/apparmor-mainline.git AppArmor-2.4

AppArmor: fix auditing of domain transitions to include target profile information

Domain transitions were only reporting the target executable name.  The
target profile can differ when doing named transitions and it needs
to be reported.

Signed-off-by: John Johansen <john.johansen@canonical.com>
Signed-off-by: Andy Whitcroft <apw@canonical.com>
Acked-by: Jeff Mahoney <jeffm@suse.com>
---
 security/apparmor/domain.c |    5 +++++
 1 file changed, 5 insertions(+)

--- a/security/apparmor/domain.c
+++ b/security/apparmor/domain.c
@@ -335,6 +335,11 @@ int apparmor_bprm_set_creds(struct linux
 		bprm->unsafe |= AA_SECURE_X_NEEDED;
 
 apply:
+	sa.name2 = new_profile->fqname;
+	/* When switching namespace ensure its part of audit message */
+	if (new_profile->ns != profile->ns)
+		sa.name3 = new_profile->ns->base.name;
+
 	/* when transitioning profiles clear unsafe personality bits */
 	bprm->per_clear |= PER_CLEAR_ON_SETID;
 
