From: Jeff Mahoney <jeffm@suse.com>
Subject: apparmor: Fix NULL deref in apparmor_bprm_set_creds
References: bnc#692459
Patch-mainline: No, issue didn't exist in upstream version

 In apparmor_bprm_set_creds, we'll oops if aa_alloc_null_profile fails.

 This patch dumps out to the failure path once we encounter the error
 rather than dereferencing the NULL new_profile pointer and *then*
 going to the failure path when the code below notices that new_profile
 is NULL.

Reported-by: Dirk Mueller <dmueller@novell.com>
Signed-off-by: Jeff Mahoney <jeffm@suse.com>
---
 security/apparmor/domain.c |    4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

--- a/security/apparmor/domain.c
+++ b/security/apparmor/domain.c
@@ -299,8 +299,10 @@ int apparmor_bprm_set_creds(struct linux
 	} else if (PROFILE_COMPLAIN(profile)) {
 		new_profile = aa_alloc_null_profile(profile, 0);
 		sa.base.error = -EACCES;
-		if (!new_profile)
+		if (!new_profile) {
 			sa.base.error = -ENOMEM;
+			goto audit;
+		}
 		sa.name2 = new_profile->fqname;
 		sa.perms.xindex |= AA_X_UNSAFE;
 	} else {
