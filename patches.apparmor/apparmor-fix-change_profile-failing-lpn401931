From john.johansen@canonical.com  Tue Nov 17 11:13:49 2009
From: John Johansen <john.johansen@canonical.com>
Date: Thu, 23 Jul 2009 16:54:51 +0000 (-0700)
Subject: AppArmor: Fix change_profile failing lpn401931
Git-commit: db344220ea9cfabde6d37dbe1cf6e2f9731b84cf
Git-Repo: git://kernel.ubuntu.com/jj/apparmor-mainline.git AppArmor-2.4

AppArmor: Fix change_profile failing lpn401931

Fix change_profile so that it doesn't return -EINVAL when only fqname
is defined.  Also fix the oops, when ns_name is defined and the permission
check is done.

Signed-off-by: John Johansen <john.johansen@canonical.com>
Signed-off-by: Andy Whitcroft <apw@canonical.com>
Acked-by: Jeff Mahoney <jeffm@suse.com>
---
 security/apparmor/domain.c |   11 +++++------
 1 file changed, 5 insertions(+), 6 deletions(-)

--- a/security/apparmor/domain.c
+++ b/security/apparmor/domain.c
@@ -90,8 +90,11 @@ static struct file_perms change_profile_
 		perms.allowed = AA_MAY_CHANGE_PROFILE;
 		perms.xindex = perms.dindex = 0;
 		perms.audit = perms.quiet = perms.kill = 0;
-		*rstate = 0;
+		if (rstate)
+			*rstate = 0;
 		return perms;
+	} else if (!profile->file.dfa) {
+		return nullperms;
 	} else if ((ns == profile->ns)) {
 		/* try matching against rules with out namespace prependend */
 		perms = aa_str_perms(profile->file.dfa, DFA_START, name, &cond,
@@ -101,9 +104,6 @@ static struct file_perms change_profile_
 	}
 
 	/* try matching with namespace name and then profile */
-	if (!profile->file.dfa)
-		return nullperms;
-
 	state = aa_dfa_match(profile->file.dfa, DFA_START, ns->base.name);
 	state = aa_dfa_null_transition(profile->file.dfa, state);
 	return aa_str_perms(profile->file.dfa, state, name, &cond, rstate);
@@ -619,9 +619,8 @@ int aa_change_profile(const char *ns_nam
 	struct aa_profile *profile, *target = NULL;
 	struct aa_namespace *ns = NULL;
 	struct aa_audit_file sa;
-	char *name = NULL;
 
-	if (!name && !ns_name)
+	if (!fqname && !ns_name)
 		return -EINVAL;
 
 	memset(&sa, 0, sizeof(sa));
