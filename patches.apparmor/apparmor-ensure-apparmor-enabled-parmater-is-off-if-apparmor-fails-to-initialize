From john.johansen@canonical.com  Tue Nov 17 11:13:49 2009
From: John Johansen <john.johansen@canonical.com>
Date: Thu, 16 Jul 2009 15:36:43 +0000 (-0700)
Subject: AppArmor: ensure apparmor enabled parmater is off if AppArmor fails to initialize.
Git-commit: c68fe02f4a1a9daf53effdef1971a5ae2436d8b0
Git-Repo: git://kernel.ubuntu.com/jj/apparmor-mainline.git AppArmor-2.4

AppArmor: ensure apparmor enabled parmater is off if AppArmor fails to initialize.

The /sys/modules/apparmor/parameters/enabled parameter was wrongly reporting
that AppArmor was enabled when it had failed to initialized.  It should
report that apparmor is disabled when AppArmor fails to initialize for any
reason.

Signed-off-by: John Johansen <john.johansen@canonical.com>
Signed-off-by: Andy Whitcroft <apw@canonical.com>
Acked-by: Jeff Mahoney <jeffm@suse.com>
---
 security/apparmor/lsm.c |    2 ++
 1 file changed, 2 insertions(+)

--- a/security/apparmor/lsm.c
+++ b/security/apparmor/lsm.c
@@ -983,6 +983,7 @@ static int __init apparmor_init(void)
 
 	if (!apparmor_enabled || !security_module_enable(&apparmor_ops)) {
 		info_message("AppArmor disabled by boot time parameter\n");
+		apparmor_enabled = 0;
 		return 0;
 	}
 
@@ -1031,6 +1032,7 @@ alloc_out:
 	destroy_apparmorfs();
 
 /*createfs_out:*/
+	apparmor_enabled = 0;
 	return error;
 
 }
