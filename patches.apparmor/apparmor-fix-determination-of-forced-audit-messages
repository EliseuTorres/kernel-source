From john.johansen@canonical.com  Tue Nov 17 11:13:49 2009
From: John Johansen <john.johansen@canonical.com>
Date: Thu, 23 Jul 2009 17:24:45 +0000 (-0700)
Subject: AppArmor: Fix determination of forced AUDIT messages.
Git-commit: 8ee7a29dc712f2fc9ad477ec32324a75e2b920cf
Git-Repo: git://kernel.ubuntu.com/jj/apparmor-mainline.git AppArmor-2.4

AppArmor: Fix determination of forced AUDIT messages.

This fixes a bug where some classes of messages are being forced audited
when they shouldn't be.

Signed-off-by: John Johansen <john.johansen@canonical.com>
Signed-off-by: Andy Whitcroft <apw@canonical.com>
Acked-by: Jeff Mahoney <jeffm@suse.com>
---
 security/apparmor/audit.c      |    6 ++++--
 security/apparmor/capability.c |    1 +
 security/apparmor/file.c       |    1 +
 security/apparmor/net.c        |    1 +
 4 files changed, 7 insertions(+), 2 deletions(-)

--- a/security/apparmor/audit.c
+++ b/security/apparmor/audit.c
@@ -114,9 +114,11 @@ int aa_audit(int type, struct aa_profile
 	audit_cxt = g_apparmor_logsyscall ? current->audit_context : NULL;
 
 	if (type == AUDIT_APPARMOR_AUTO) {
-		if (likely(!sa->error))
+		if (likely(!sa->error)) {
+			if (PROFILE_AUDIT_MODE(profile) != AUDIT_ALL)
+				return 0;
 			type = AUDIT_APPARMOR_AUDIT;
-		else if (PROFILE_COMPLAIN(profile))
+		} else if (PROFILE_COMPLAIN(profile))
 			type = AUDIT_APPARMOR_ALLOWED;
 		else
 			type = AUDIT_APPARMOR_DENIED;
--- a/security/apparmor/capability.c
+++ b/security/apparmor/capability.c
@@ -58,6 +58,7 @@ static int aa_audit_caps(struct aa_profi
 		if (likely((PROFILE_AUDIT_MODE(profile) != AUDIT_ALL) &&
 			   !cap_raised(profile->caps.audit, sa->cap)))
 			return 0;
+		type = AUDIT_APPARMOR_AUDIT;
 	} else if (PROFILE_KILL(profile) ||
 		   cap_raised(profile->caps.kill, sa->cap)) {
 		type = AUDIT_APPARMOR_KILL;
--- a/security/apparmor/file.c
+++ b/security/apparmor/file.c
@@ -137,6 +137,7 @@ int aa_audit_file(struct aa_profile *pro
 
 		if (likely(!sa->request))
 			return 0;
+		type = AUDIT_APPARMOR_AUDIT;
 	} else {
 		/* quiet auditing of specific known rejects */
 		u16 mask = sa->perms.quiet;
--- a/security/apparmor/net.c
+++ b/security/apparmor/net.c
@@ -74,6 +74,7 @@ static int aa_audit_net(struct aa_profil
 		if (likely((PROFILE_AUDIT_MODE(profile) != AUDIT_ALL) &&
 			   !(1 << sa->type & audit_mask)))
 			return 0;
+		type = AUDIT_APPARMOR_AUDIT;
 	} else {
 		u16 quiet_mask = profile->net.quiet[sa->family];
 		u16 kill_mask = 0;
