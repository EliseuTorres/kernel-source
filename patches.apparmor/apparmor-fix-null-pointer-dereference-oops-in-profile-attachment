From john.johansen@canonical.com  Tue Nov 17 11:13:49 2009
From: John Johansen <john.johansen@canonical.com>
Date: Tue, 21 Jul 2009 09:52:44 +0000 (-0700)
Subject: AppArmor: Fix NULL pointer dereference oops in profile attachment.
Git-commit: a7e0ec31e0d98c3559b36f8a7eba5237cb61dc33
Git-Repo: git://kernel.ubuntu.com/jj/apparmor-mainline.git AppArmor-2.4

AppArmor: Fix NULL pointer dereference oops in profile attachment.

When doing attachment of a new_profile to an unconfined process the
filtered profile is null and should not be dereferenced to get
the namespace.

Signed-off-by: John Johansen <john.johansen@canonical.com>
Signed-off-by: Andy Whitcroft <apw@canonical.com>
Acked-by: Jeff Mahoney <jeffm@suse.com>
---
 security/apparmor/domain.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

--- a/security/apparmor/domain.c
+++ b/security/apparmor/domain.c
@@ -337,7 +337,7 @@ int apparmor_bprm_set_creds(struct linux
 apply:
 	sa.name2 = new_profile->fqname;
 	/* When switching namespace ensure its part of audit message */
-	if (new_profile->ns != profile->ns)
+	if (new_profile->ns != ns)
 		sa.name3 = new_profile->ns->base.name;
 
 	/* when transitioning profiles clear unsafe personality bits */
