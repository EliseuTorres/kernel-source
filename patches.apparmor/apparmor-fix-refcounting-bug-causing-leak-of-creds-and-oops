From john.johansen@canonical.com  Tue Nov 17 12:03:14 2009
From: John Johansen <john.johansen@canonical.com>
Date: Tue, 17 Nov 2009 07:11:59 +0000 (-0800)
Subject: AppArmor: Fix refcounting bug causing leak of creds and oops
Git-commit: ec785e5388eeb615f89cb386ad07099119050984
Git-Repo: git://kernel.ubuntu.com/jj/apparmor-mainline.git AppArmor-2.4

AppArmor: Fix refcounting bug causing leak of creds and oops

BugLink: http://bugs.launchpad.net/bugs/479115
BugLink: http://bugs.launchpad.net/bugs/480112

One true bug 480112 thats fix introduced another bug.  Both fixes are
combined here into a single patch.

1. AppArmor when doing ptrace check for domain changes, fails to drop
the ref count on the task creds when it is unconfined.

The original fix to #2 introduced this bug by returning early
instead of doing put_cred.

2. As reported by Tetsuo Handa on kernel-team mailing list:

In aa_may_change_ptraced_domain, if (!tracer) cred == NULL, and
put_cred(cred) will oops.  This will only happen on exec if the task
is marked as LSM_UNSAFE_PTRACE | LSM_UNSAFE_PTRACE_CAP, so should
only happen to ptraced tasks that are confined.

Signed-off-by: John Johansen <john.johansen@canonical.com>
Acked-by: Jeff Mahoney <jeffm@suse.com>
---

 security/apparmor/domain.c |    8 +++++---
 1 file changed, 5 insertions(+), 3 deletions(-)

diff --git a/security/apparmor/domain.c b/security/apparmor/domain.c
index b091fd9..497176f 100644
--- a/security/apparmor/domain.c
+++ b/security/apparmor/domain.c
@@ -64,11 +64,13 @@ static int aa_may_change_ptraced_domain(struct task_struct *task,
 		cred = aa_get_task_policy(tracer, &tracerp);
 	rcu_read_unlock();
 
-	if (!tracerp)
-		return error;
+	if (!tracer || !tracerp)
+		goto out;
 
 	error = aa_may_ptrace(tracer, tracerp, to_profile, PTRACE_MODE_ATTACH);
-	put_cred(cred);
+out:
+	if (cred)
+		put_cred(cred);
 
 	return error;
 }

