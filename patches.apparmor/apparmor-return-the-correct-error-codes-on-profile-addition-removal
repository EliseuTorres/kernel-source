From john.johansen@canonical.com  Tue Nov 17 11:13:50 2009
From: John Johansen <john.johansen@canonical.com>
Date: Wed, 26 Aug 2009 20:50:21 +0000 (-0700)
Subject: AppArmor: Return the correct error codes on profile addition/removal
Git-commit: 34cc2391cf122ca80627ac7f81d51a88801e3024
Git-Repo: git://kernel.ubuntu.com/jj/apparmor-mainline.git AppArmor-2.4

AppArmor: Return the correct error codes on profile addition/removal

BugLink: http://bugs.launchpad.net/bugs/408473

Part of lp #408473
A failed profile addition would alway fail with EEXIST which is incorrect
for when the parent doesn't exist and a hat is being added.  This can
result in the initscipts not correctly handling hat addition.

Failed profile removal was returning a wrong value that could result
in user space spinning trying to remove a profile that doesn't exist.
When combined with hats now being removed with their parent, an attempt
to removal a hat after its parent always fails.  Since the init script
builds up a removal list that includes hats before doing actual removal,
if the hat is "removed" after its parent the init script will die,
spinning on hat removal.

Signed-off-by: John Johansen <john.johansen@canonical.com>
Signed-off-by: Tim Gardner <tim.gardner@canonical.com>
Acked-by: Jeff Mahoney <jeffm@suse.com>

---
 security/apparmor/policy_interface.c |    4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

--- a/security/apparmor/policy_interface.c
+++ b/security/apparmor/policy_interface.c
@@ -647,6 +647,7 @@ ssize_t aa_interface_add_profiles(void *
 	if (__aa_find_profile(&common->profiles, profile->base.name)) {
 		/* A profile with this name exists already. */
 		sa.base.info = "profile already exists";
+		sa.base.error = -EEXIST;
 		goto fail2;
 	}
 	profile->sid = aa_alloc_sid(AA_ALLOC_SYS_SID);
@@ -662,7 +663,6 @@ ssize_t aa_interface_add_profiles(void *
 
 fail2:
 	write_unlock(&ns->base.lock);
-	sa.base.error = -EEXIST;
 
 fail:
 	error = aa_audit_iface(&sa);
@@ -848,5 +848,5 @@ fail_ns_lock:
 fail_ns_list_lock:
 	write_unlock(&ns_list_lock);
 	aa_audit_iface(&sa);
-	return 0; //-ENOENT;
+	return -ENOENT;
 }
