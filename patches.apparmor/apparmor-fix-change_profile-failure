From john.johansen@canonical.com  Tue Nov 17 11:13:49 2009
From: John Johansen <john.johansen@canonical.com>
Date: Wed, 26 Aug 2009 20:57:37 +0000 (-0700)
Subject: AppArmor: Fix change_profile failure
Git-commit: 0189ce8a96793ead8eb77d60e22d9166630b6c84
Git-Repo: git://kernel.ubuntu.com/jj/apparmor-mainline.git AppArmor-2.4

AppArmor: Fix change_profile failure

BugLink: http://bugs.launchpad.net/bugs/401931

Change_profile requests were failing due to the permission being
incorrectly mapped.  Further more the permission failure was not
generating audit messages.

Signed-off-by: John Johansen <john.johansen@canonical.com>
Signed-off-by: Tim Gardner <tim.gardner@canonical.com>
Acked-by: Jeff Mahoney <jeffm@suse.com>
---
 security/apparmor/domain.c |    8 ++++----
 security/apparmor/file.c   |    2 +-
 2 files changed, 5 insertions(+), 5 deletions(-)

--- a/security/apparmor/domain.c
+++ b/security/apparmor/domain.c
@@ -630,6 +630,7 @@ int aa_change_profile(const char *ns_nam
 		return -EINVAL;
 
 	memset(&sa, 0, sizeof(sa));
+	sa.request = AA_MAY_CHANGE_PROFILE;
 	sa.base.gfp_mask = GFP_KERNEL;
 	if (onexec)
 		sa.base.operation = "change_onexec";
@@ -638,11 +639,9 @@ int aa_change_profile(const char *ns_nam
 
 	cred = aa_current_policy(&profile);
 	cxt = cred->security;
-	ns = aa_get_namespace(cxt->sys.profile->ns);
 
 	if (ns_name) {
 		sa.name2 = ns_name;
-		aa_put_namespace(ns);
 		ns = aa_find_namespace(ns_name);
 		if (!ns) {
 			/* we don't create new namespace in complain mode */
@@ -650,8 +649,10 @@ int aa_change_profile(const char *ns_nam
 			sa.base.error = -ENOENT;
 			goto audit;
 		}
-	} else
+	} else {
+		ns = aa_get_namespace(cxt->sys.profile->ns);
 		sa.name2 = ns->base.name;
+	}
 
 	/* if the name was not specified, use the name of the current profile */
 	if (!fqname) {
@@ -663,7 +664,6 @@ int aa_change_profile(const char *ns_nam
 	sa.name = fqname;
 
 	sa.perms = change_profile_perms(profile, ns, fqname, NULL);
-
 	if (!(sa.perms.allowed & AA_MAY_CHANGE_PROFILE)) {
 		sa.base.error = -EACCES;
 		goto audit;
--- a/security/apparmor/file.c
+++ b/security/apparmor/file.c
@@ -192,7 +192,7 @@ struct file_perms aa_compute_perms(struc
 		perms.allowed |= AA_LINK_SUBSET;
 
 	/* change_profile wasn't determined by ownership in old mapping */
-	if (ACCEPT_TABLE2(dfa)[state] & 0x80000000)
+	if (ACCEPT_TABLE(dfa)[state] & 0x80000000)
 		perms.allowed |= AA_MAY_CHANGE_PROFILE;
 
 	return perms;
