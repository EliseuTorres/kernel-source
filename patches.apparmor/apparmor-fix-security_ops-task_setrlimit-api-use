From: Jeff Mahoney <jeffm@suse.com>
Subject: AppArmor: Fix security_ops->task_setrlimit API use

 Linux 2.6.32 changed the task_setrlimit security_operation to
 take a task_struct. This patch adds the argument to AppArmor's
 implementation and uses it to allow the call if it isn't actually
 changing anything.

Signed-off-by: Jeff Mahoney <jeffm@suse.com>
---
 security/apparmor/lsm.c |    7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

--- a/security/apparmor/lsm.c
+++ b/security/apparmor/lsm.c
@@ -547,15 +547,16 @@ static int apparmor_setprocattr(struct t
 	return error;
 }
 
-static int apparmor_task_setrlimit(unsigned int resource,
+static int apparmor_task_setrlimit(struct task_struct *task,
+				   unsigned int resource,
 				   struct rlimit *new_rlim)
 {
+	struct rlimit *old_rlim = task->signal->rlim + resource;
 	struct aa_profile *profile = aa_current_profile_wupd();
 	int error = 0;
 
-	if (profile) {
+	if (profile && old_rlim->rlim_max != new_rlim->rlim_max)
 		error = aa_task_setrlimit(profile, resource, new_rlim);
-	}
 
 	return error;
 }
