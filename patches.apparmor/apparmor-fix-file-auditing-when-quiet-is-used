From john.johansen@canonical.com  Tue Nov 17 12:03:14 2009
From: John Johansen <john.johansen@canonical.com>
Date: Mon, 2 Nov 2009 14:04:01 +0000 (-0800)
Subject: AppArmor: Fix file auditing when quiet is used
Git-commit: 0a844e068d06adf0bd62e82302c24d0bf953209f
Git-Repo: git://kernel.ubuntu.com/jj/apparmor-mainline.git AppArmor-2.4

AppArmor: Fix file auditing when quiet is used

Fix file auditing so that if a reject occurs and all denied permissions
are quieted that no logging is done.

Signed-off-by: John Johansen <john.johansen@canonical.com>
Acked-by: Jeff Mahoney <jeffm@suse.com>
---

 security/apparmor/file.c |   13 ++++++-------
 1 file changed, 6 insertions(+), 7 deletions(-)

diff --git a/security/apparmor/file.c b/security/apparmor/file.c
index 16d2f56..f27bae6 100644
--- a/security/apparmor/file.c
+++ b/security/apparmor/file.c
@@ -139,18 +139,17 @@ int aa_audit_file(struct aa_profile *profile, struct aa_audit_file *sa)
 			return 0;
 		type = AUDIT_APPARMOR_AUDIT;
 	} else {
-		/* quiet auditing of specific known rejects */
-		u16 mask = sa->perms.quiet;
-		u16 denied = sa->request & ~sa->perms.allowed;
+		/* only report permissions that were denied */
+		sa->request = sa->request & ~sa->perms.allowed;
 
-		if (denied & sa->perms.kill)
+		if (sa->request & sa->perms.kill)
 			type = AUDIT_APPARMOR_KILL;
 
-		/* assumes quiet and kill do not overlap */
-		if ((denied & mask) &&
+		/* quiet known rejects, assumes quiet and kill do not overlap */
+		if ((sa->request & sa->perms.quiet) &&
 		    PROFILE_AUDIT_MODE(profile) != AUDIT_NOQUIET &&
 		    PROFILE_AUDIT_MODE(profile) != AUDIT_ALL)
-			sa->request &= ~mask;
+			sa->request &= ~sa->perms.quiet;
 
 		if (!sa->request)
 			return PROFILE_COMPLAIN(profile) ? 0 : sa->base.error;

