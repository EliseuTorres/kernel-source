From john.johansen@canonical.com  Tue Nov 17 11:13:49 2009
From: John Johansen <john.johansen@canonical.com>
Date: Thu, 23 Jul 2009 17:58:43 +0000 (-0700)
Subject: AppArmor: Fix oops in auditing of the policy interface offset
Git-commit: d3531cf696017fb410eeacd7655a85969901faab
Git-Repo: git://kernel.ubuntu.com/jj/apparmor-mainline.git AppArmor-2.4

AppArmor: Fix oops in auditing of the policy interface offset

The audit_cb for policy_interface was unconditionally dereferencing
the interface aa_ext struct.

Signed-off-by: John Johansen <john.johansen@canonical.com>
Signed-off-by: Andy Whitcroft <apw@canonical.com>
Acked-by: Jeff Mahoney <jeffm@suse.com>
---
 security/apparmor/policy_interface.c |    5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

--- a/security/apparmor/policy_interface.c
+++ b/security/apparmor/policy_interface.c
@@ -92,14 +92,15 @@ static void aa_audit_init(struct aa_audi
 static void audit_cb(struct audit_buffer *ab, void *va)
 {
 	struct aa_audit_iface *sa = va;
-	long len = sa->e->pos - sa->e->start;
 
 	if (sa->name)
 		audit_log_format(ab, " name=%s", sa->name);
 	if (sa->name2)
 		audit_log_format(ab, " namespace=%s", sa->name2);
-	if (sa->base.error && sa->e)
+	if (sa->base.error && sa->e) {
+		long len = sa->e->pos - sa->e->start;
 		audit_log_format(ab, " offset=%ld", len);
+	}
 }
 
 static int aa_audit_iface(struct aa_audit_iface *sa)
