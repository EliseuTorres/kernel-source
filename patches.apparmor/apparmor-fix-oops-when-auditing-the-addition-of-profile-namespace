From john.johansen@canonical.com  Tue Nov 17 11:13:50 2009
From: John Johansen <john.johansen@canonical.com>
Date: Tue, 15 Sep 2009 10:12:17 +0000 (-0700)
Subject: AppArmor: Fix oops when auditing the addition of profile namespace
Git-commit: 1904739da9a248a341b90560dae94159b4b3cc94
Git-Repo: git://kernel.ubuntu.com/jj/apparmor-mainline.git AppArmor-2.4

AppArmor: Fix oops when auditing the addition of profile namespace

The name of the namespace is no longer dynamically allocated as part of
the profile unpacking, so it should not be freed.  Also the when a
new namespace is created the ref count is wrong as a ref count is needed
for the list, as well as the returned pointer.
Part of lp #408454

Signed-off-by: John Johansen <john.johansen@canonical.com>
Acked-by: Jeff Mahoney <jeffm@suse.com>
---
 security/apparmor/policy.c           |    2 +-
 security/apparmor/policy_interface.c |    4 ----
 2 files changed, 1 insertion(+), 5 deletions(-)

--- a/security/apparmor/policy.c
+++ b/security/apparmor/policy.c
@@ -292,7 +292,7 @@ struct aa_namespace *aa_prepare_namespac
 		ns = __aa_find_namespace(&ns_list, name);
 		if (!ns) {
 			list_add(&new_ns->base.list, &ns_list);
-			ns = new_ns;
+			ns = aa_get_namespace(new_ns);
 		} else {
 			/* raced so free the new one */
 			free_aa_namespace(new_ns);
--- a/security/apparmor/policy_interface.c
+++ b/security/apparmor/policy_interface.c
@@ -658,7 +658,6 @@ ssize_t aa_interface_add_profiles(void *
 
 	aa_audit_iface(&sa);
 	aa_put_namespace(ns);
-	kfree(e.ns_name);
 	return size;
 
 fail2:
@@ -668,7 +667,6 @@ fail:
 	error = aa_audit_iface(&sa);
 	aa_put_namespace(ns);
 	aa_put_profile(profile);
-	kfree(e.ns_name);
 	return error;
 }
 
@@ -771,7 +769,6 @@ ssize_t aa_interface_replace_profiles(vo
 	aa_audit_iface(&sa);
 	aa_put_namespace(ns);
 	aa_put_profile(old_profile);
-	kfree(e.ns_name);
 	return size;
 
 fail2:
@@ -781,7 +778,6 @@ fail:
 	aa_put_namespace(ns);
 	aa_put_profile(old_profile);
 	aa_put_profile(new_profile);
-	kfree(e.ns_name);
 	return error;
 }
 
