From 6805979fa9090b2c69c645cf19bba9a2849f336b Mon Sep 17 00:00:00 2001
From: Ben Skeggs <bskeggs@redhat.com>
Date: Sun, 30 Oct 2011 23:04:31 +1000
Subject: drm/nv50/pm: 0x84/0x86 can't use "1" for nvclk src, need 0x50 method
Git-commit: 6805979fa9090b2c69c645cf19bba9a2849f336b
Patch-mainline: v3.3-rc1

Signed-off-by: Ben Skeggs <bskeggs@redhat.com>
Acked-by: Michal Srb <msrb@suse.com>
---
 drivers/gpu/drm/nouveau/nv50_pm.c |    7 +++++--
 1 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/drivers/gpu/drm/nouveau/nv50_pm.c b/drivers/gpu/drm/nouveau/nv50_pm.c
index 53b6c6c..ab8cfad 100644
--- a/drivers/gpu/drm/nouveau/nv50_pm.c
+++ b/drivers/gpu/drm/nouveau/nv50_pm.c
@@ -562,8 +562,11 @@ nv50_pm_clocks_set(struct drm_device *dev, void *data)
 	}
 	nv_mask(dev, 0x00c040, 0x0c000c00, info->amast);
 
-	/* core/shader: switch core to dom6, shader to hclk */
-	if (dev_priv->chipset == 0x50)
+	/* core/shader: make sure sclk/nvclk are disconnected from their
+	 * plls (nvclk to dom6, sclk to hclk), modify the plls, and
+	 * reconnect sclk/nvclk to their new clock source
+	 */
+	if (dev_priv->chipset < 0x92)
 		nv_mask(dev, 0x00c040, 0x001000b0, 0x00100080); /* grrr! */
 	else
 		nv_mask(dev, 0x00c040, 0x000000b3, 0x00000081);

