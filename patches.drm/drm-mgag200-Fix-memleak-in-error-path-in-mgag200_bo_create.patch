From: Egbert Eich <Egbert Eich eich@suse.de>
Date: Thu May 2 11:17:39 2013 +0200
Subject: drm/mgag200: Fix memleak in error path in mgag200_bo_create()
Patch-Mainline: to be upstreamed
Git-commit: 63aba0e9bb9859591029ea6a45d60f3d2ec03393
Git-repo: git://people.freedesktop.org/~airlied/linux/
References: bnc #806990
Signed-off-by: Egbert Eich <eich@suse.com>

The allocated struct mgag200_bo was not freed in all error paths.
This patch consolidates error handling and fixes this.

Signed-off-by: Egbert Eich <eich@suse.de>
---
 drivers/gpu/drm/mgag200/mgag200_ttm.c |   11 ++++++-----
 1 file changed, 6 insertions(+), 5 deletions(-)

--- linux-3.0-SLE11-SP3.orig/drivers/gpu/drm/mgag200/mgag200_ttm.c
+++ linux-3.0-SLE11-SP3/drivers/gpu/drm/mgag200/mgag200_ttm.c
@@ -340,10 +340,8 @@ int mgag200_bo_create(struct drm_device
 		return -ENOMEM;
 
 	ret = drm_gem_object_init(dev, &mgabo->gem, size);
-	if (ret) {
-		kfree(mgabo);
-		return ret;
-	}
+	if (ret)
+		goto err;
 
 	mgabo->gem.driver_private = NULL;
 	mgabo->bo.bdev = &mdev->ttm.bdev;
@@ -358,10 +356,13 @@ int mgag200_bo_create(struct drm_device
 			  align >> PAGE_SHIFT, false, NULL, acc_size,
 			  NULL, mgag200_bo_ttm_destroy);
 	if (ret)
-		return ret;
+		goto err;
 
 	*pmgabo = mgabo;
 	return 0;
+err:
+	kfree(mgabo);
+	return ret;
 }
 
 static inline u64 mgag200_bo_gpu_offset(struct mgag200_bo *bo)
