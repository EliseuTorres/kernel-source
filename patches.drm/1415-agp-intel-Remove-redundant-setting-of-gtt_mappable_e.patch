From b067d527ad4f47d51f4c21f212e3c5eb9bca62cb Mon Sep 17 00:00:00 2001
From: Chris Wilson <chris@chris-wilson.co.uk>
Date: Tue, 14 Sep 2010 19:30:13 +0100
Patch-mainline: 2.6.37
References: fate#310916
Git-commit: b1c5b0f8cc16a1d22e2e521c4236a6ceca1b2983
Subject: [PATCH 1415/2588] agp/intel: Remove redundant setting of
 gtt_mappable_entries

Two calls enter, only one will leave.

Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
(cherry picked from commit b1c5b0f8cc16a1d22e2e521c4236a6ceca1b2983)

Signed-off-by: Takashi Iwai <tiwai@suse.de>
---
 drivers/char/agp/intel-gtt.c |   15 ++++++---------
 1 files changed, 6 insertions(+), 9 deletions(-)

diff --git a/drivers/char/agp/intel-gtt.c b/drivers/char/agp/intel-gtt.c
index dedf05d..791582c 100644
--- a/drivers/char/agp/intel-gtt.c
+++ b/drivers/char/agp/intel-gtt.c
@@ -774,18 +774,17 @@ static unsigned int intel_gtt_total_entries(void)
 static unsigned int intel_gtt_mappable_entries(void)
 {
 	unsigned int aperture_size;
-	u16 gmch_ctrl;
 
-	aperture_size = 1024 * 1024;
+	if (INTEL_GTT_GEN == 2) {
+		u16 gmch_ctrl;
 
-	pci_read_config_word(intel_private.bridge_dev,
-			     I830_GMCH_CTRL, &gmch_ctrl);
+		pci_read_config_word(intel_private.bridge_dev,
+				     I830_GMCH_CTRL, &gmch_ctrl);
 
-	if (INTEL_GTT_GEN == 2) {
 		if ((gmch_ctrl & I830_GMCH_MEM_MASK) == I830_GMCH_MEM_64M)
-			aperture_size *= 64;
+			aperture_size = MB(64);
 		else
-			aperture_size *= 128;
+			aperture_size = MB(128);
 	} else {
 		/* 9xx supports large sizes, just look at the length */
 		aperture_size = pci_resource_len(intel_private.pcidev, 2);
@@ -799,8 +798,6 @@ static int intel_gtt_init(void)
 	u32 gtt_map_size;
 	int ret;
 
-	intel_private.base.gtt_mappable_entries = intel_gtt_mappable_entries();
-
 	ret = intel_private.driver->setup();
 	if (ret != 0)
 		return ret;
-- 
1.7.6

