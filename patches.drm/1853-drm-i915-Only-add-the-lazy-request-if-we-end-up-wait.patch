From 04e09b44d289ec8107a5db12b073980fb3fb8b28 Mon Sep 17 00:00:00 2001
From: Chris Wilson <chris@chris-wilson.co.uk>
Date: Wed, 10 Nov 2010 20:40:02 +0000
Patch-mainline: 2.6.38
References: fate#310916
Git-commit: 5d97eb69bd4767ce9973360881fa6ad161510fb0
Subject: [PATCH 1853/2588] drm/i915: Only add the lazy request if we end up
 waiting for it.

Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
(cherry picked from commit 5d97eb69bd4767ce9973360881fa6ad161510fb0)

Signed-off-by: Takashi Iwai <tiwai@suse.de>
---
 drivers/gpu/drm/i915/i915_gem.c         |    9 +++------
 drivers/gpu/drm/i915/intel_ringbuffer.h |    2 +-
 2 files changed, 4 insertions(+), 7 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_gem.c b/drivers/gpu/drm/i915/i915_gem.c
index 9fd8785..7a1f678 100644
--- a/drivers/gpu/drm/i915/i915_gem.c
+++ b/drivers/gpu/drm/i915/i915_gem.c
@@ -1671,9 +1671,7 @@ i915_gem_next_request_seqno(struct drm_device *dev,
 			    struct intel_ring_buffer *ring)
 {
 	drm_i915_private_t *dev_priv = dev->dev_private;
-
-	ring->outstanding_lazy_request = true;
-	return dev_priv->next_seqno;
+	return ring->outstanding_lazy_request = dev_priv->next_seqno;
 }
 
 static void
@@ -2079,7 +2077,7 @@ i915_do_wait_request(struct drm_device *dev, uint32_t seqno,
 	if (atomic_read(&dev_priv->mm.wedged))
 		return -EAGAIN;
 
-	if (ring->outstanding_lazy_request) {
+	if (seqno == ring->outstanding_lazy_request) {
 		struct drm_i915_gem_request *request;
 
 		request = kzalloc(sizeof(*request), GFP_KERNEL);
@@ -2094,7 +2092,6 @@ i915_do_wait_request(struct drm_device *dev, uint32_t seqno,
 
 		seqno = request->seqno;
 	}
-	BUG_ON(seqno == dev_priv->next_seqno);
 
 	if (!i915_seqno_passed(ring->get_seqno(ring), seqno)) {
 		if (HAS_PCH_SPLIT(dev))
@@ -4042,7 +4039,7 @@ i915_gem_do_execbuffer(struct drm_device *dev, void *data,
 	i915_retire_commands(dev, ring);
 
 	if (i915_add_request(dev, file, request, ring))
-		ring->outstanding_lazy_request = true;
+		i915_gem_next_request_seqno(dev, ring);
 	else
 		request = NULL;
 
diff --git a/drivers/gpu/drm/i915/intel_ringbuffer.h b/drivers/gpu/drm/i915/intel_ringbuffer.h
index 40613a7..aa1682e 100644
--- a/drivers/gpu/drm/i915/intel_ringbuffer.h
+++ b/drivers/gpu/drm/i915/intel_ringbuffer.h
@@ -88,7 +88,7 @@ struct  intel_ring_buffer {
 	/**
 	 * Do we have some not yet emitted requests outstanding?
 	 */
-	bool outstanding_lazy_request;
+	u32 outstanding_lazy_request;
 
 	wait_queue_head_t irq_queue;
 	drm_local_map_t map;
-- 
1.7.6

