From 2eaf4ce4992c17580e33cef837ebb693ba9b062b Mon Sep 17 00:00:00 2001
From: Alex Deucher <alexdeucher@gmail.com>
Date: Wed, 17 Mar 2010 14:29:15 -0400
Patch-mainline: 2.6.35
References: fate#310916
Git-commit: ef6e6cf56aca91c0b0db8de6e79e0874595fd260
Subject: [PATCH 0731/2588] drm/radeon/kms: wait for gpu idle before changing
 power mode
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

set proper wait condition as noted by Rafał Miłecki.

Signed-off-by: Alex Deucher <alexdeucher@gmail.com>
Signed-off-by: Dave Airlie <airlied@redhat.com>
(cherry picked from commit ef6e6cf56aca91c0b0db8de6e79e0874595fd260)

Signed-off-by: Takashi Iwai <tiwai@suse.de>
---
 drivers/gpu/drm/radeon/radeon_pm.c |   10 ++++++++++
 1 files changed, 10 insertions(+), 0 deletions(-)

diff --git a/drivers/gpu/drm/radeon/radeon_pm.c b/drivers/gpu/drm/radeon/radeon_pm.c
index 6dfeb9c..4ece89a 100644
--- a/drivers/gpu/drm/radeon/radeon_pm.c
+++ b/drivers/gpu/drm/radeon/radeon_pm.c
@@ -378,6 +378,16 @@ static void radeon_pm_set_clocks(struct radeon_device *rdev)
 	radeon_get_power_state(rdev, rdev->pm.planned_action);
 	mutex_lock(&rdev->cp.mutex);
 
+	/* wait for GPU idle */
+	rdev->pm.gui_idle = false;
+	rdev->irq.gui_idle = true;
+	radeon_irq_set(rdev);
+	wait_event_interruptible_timeout(
+		rdev->irq.idle_queue, rdev->pm.gui_idle,
+		msecs_to_jiffies(RADEON_WAIT_IDLE_TIMEOUT));
+	rdev->irq.gui_idle = false;
+	radeon_irq_set(rdev);
+
 	if (rdev->pm.active_crtcs & (1 << 0)) {
 		rdev->pm.req_vblank |= (1 << 0);
 		drm_vblank_get(rdev->ddev, 0);
-- 
1.7.6

