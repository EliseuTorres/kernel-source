From db34d2fbbd651af39d625cc90c2962b78cde9585 Mon Sep 17 00:00:00 2001
From: Chris Wilson <chris@chris-wilson.co.uk>
Date: Tue, 23 Nov 2010 08:49:38 +0000
Patch-mainline: 2.6.38
References: fate#310916
Git-commit: 3685092b717882bb9b6801bf3e4b02a106e3b129
Subject: [PATCH 1867/2588] drm/i915: Avoid oops when capturing NULL ring for
 inactive pinned buffers

Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
(cherry picked from commit 3685092b717882bb9b6801bf3e4b02a106e3b129)

Signed-off-by: Takashi Iwai <tiwai@suse.de>
---
 drivers/gpu/drm/i915/i915_debugfs.c |    6 +++---
 drivers/gpu/drm/i915/i915_irq.c     |    2 +-
 2 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_debugfs.c b/drivers/gpu/drm/i915/i915_debugfs.c
index 1c4ae0b..bd6d92d 100644
--- a/drivers/gpu/drm/i915/i915_debugfs.c
+++ b/drivers/gpu/drm/i915/i915_debugfs.c
@@ -572,9 +572,9 @@ static int i915_ringbuffer_info(struct seq_file *m, void *data)
 static const char *ring_str(int ring)
 {
 	switch (ring) {
-	case RING_RENDER: return "render";
-	case RING_BSD: return "bsd";
-	case RING_BLT: return "blt";
+	case RING_RENDER: return " render";
+	case RING_BSD: return " bsd";
+	case RING_BLT: return " blt";
 	default: return "";
 	}
 }
diff --git a/drivers/gpu/drm/i915/i915_irq.c b/drivers/gpu/drm/i915/i915_irq.c
index 2b7b4c2..9c38ff2 100644
--- a/drivers/gpu/drm/i915/i915_irq.c
+++ b/drivers/gpu/drm/i915/i915_irq.c
@@ -576,7 +576,7 @@ static u32 capture_bo_list(struct drm_i915_error_buffer *err,
 		err->tiling = obj->tiling_mode;
 		err->dirty = obj->dirty;
 		err->purgeable = obj->madv != I915_MADV_WILLNEED;
-		err->ring = obj->ring->id;
+		err->ring = obj->ring ? obj->ring->id : 0;
 
 		if (++i == count)
 			break;
-- 
1.7.6

