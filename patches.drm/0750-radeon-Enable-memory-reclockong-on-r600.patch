From 899aeb8e715d071fcb00b22de2275d19426e541d Mon Sep 17 00:00:00 2001
From: Matthew Garrett <mjg@redhat.com>
Date: Mon, 26 Apr 2010 17:01:16 -0400
Patch-mainline: 2.6.35
References: fate#310916
Git-commit: 956ac86d9277b7142f0ad3f24f7fbd4beed0777d
Subject: [PATCH 0750/2588] radeon: Enable memory reclockong on r600

With luck, dynamic memory reclocking on r600 should be stable with
the previous patches. Enable it.

Signed-off-by: Matthew Garrett <mjg@redhat.com>
Signed-off-by: Dave Airlie <airlied@redhat.com>
(cherry picked from commit 956ac86d9277b7142f0ad3f24f7fbd4beed0777d)

Signed-off-by: Takashi Iwai <tiwai@suse.de>
---
 drivers/gpu/drm/radeon/r600.c |   16 +++++++---------
 1 files changed, 7 insertions(+), 9 deletions(-)

diff --git a/drivers/gpu/drm/radeon/r600.c b/drivers/gpu/drm/radeon/r600.c
index 4691309..1696cc2 100644
--- a/drivers/gpu/drm/radeon/r600.c
+++ b/drivers/gpu/drm/radeon/r600.c
@@ -271,26 +271,27 @@ void r600_set_power_state(struct radeon_device *rdev, bool static_switch)
 		radeon_pm_misc(rdev);
 
 		if (static_switch) {
-			radeon_pm_prepare(rdev);
+
 			/* set engine clock */
 			if (sclk != rdev->pm.current_sclk) {
 				radeon_set_engine_clock(rdev, sclk);
 				rdev->pm.current_sclk = sclk;
 				DRM_INFO("Setting: e: %d\n", sclk);
 			}
-#if 0
+
 			/* set memory clock */
 			if (rdev->asic->set_memory_clock && (mclk != rdev->pm.current_mclk)) {
+				radeon_pm_prepare(rdev);
 				radeon_set_memory_clock(rdev, mclk);
+				radeon_pm_finish(rdev);
 				rdev->pm.current_mclk = mclk;
 				DRM_INFO("Setting: m: %d\n", mclk);
 			}
-#endif
-			radeon_pm_finish(rdev);
+
 		} else {
-			/* set engine clock */
+			radeon_sync_with_vblank(rdev);
+
 			if (sclk != rdev->pm.current_sclk) {
-				radeon_sync_with_vblank(rdev);
 				radeon_pm_debug_check_in_vbl(rdev, false);
 				radeon_set_engine_clock(rdev, sclk);
 				radeon_pm_debug_check_in_vbl(rdev, true);
@@ -298,10 +299,8 @@ void r600_set_power_state(struct radeon_device *rdev, bool static_switch)
 				DRM_INFO("Setting: e: %d\n", sclk);
 			}
 
-#if 0
 			/* set memory clock */
 			if (rdev->asic->set_memory_clock && (mclk != rdev->pm.current_mclk)) {
-				radeon_sync_with_vblank(rdev);
 				radeon_pm_debug_check_in_vbl(rdev, false);
 				radeon_pm_prepare(rdev);
 				radeon_set_memory_clock(rdev, mclk);
@@ -310,7 +309,6 @@ void r600_set_power_state(struct radeon_device *rdev, bool static_switch)
 				rdev->pm.current_mclk = mclk;
 				DRM_INFO("Setting: m: %d\n", mclk);
 			}
-#endif
 		}
 
 		rdev->pm.current_power_state_index = rdev->pm.requested_power_state_index;
-- 
1.7.6

