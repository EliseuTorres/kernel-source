From a104f1e6ed993da9b139dfd7275dad6ab12bda1a Mon Sep 17 00:00:00 2001
From: Chris Wilson <chris@chris-wilson.co.uk>
Date: Thu, 28 Oct 2010 23:43:30 +0100
Patch-mainline: 2.6.38
References: fate#310916
Git-commit: 872d860c85e30cdc97e7c91723257f4fcf04d5e9
Subject: [PATCH 1820/2588] drm/i915: Remove the duplicate domain-change
 tracepoint for GPU flush

Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
(cherry picked from commit 872d860c85e30cdc97e7c91723257f4fcf04d5e9)

Signed-off-by: Takashi Iwai <tiwai@suse.de>
---
 drivers/gpu/drm/i915/i915_gem.c |    9 +++------
 1 files changed, 3 insertions(+), 6 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_gem.c b/drivers/gpu/drm/i915/i915_gem.c
index 1d14e64..17d9afc 100644
--- a/drivers/gpu/drm/i915/i915_gem.c
+++ b/drivers/gpu/drm/i915/i915_gem.c
@@ -2851,23 +2851,20 @@ static int
 i915_gem_object_flush_gpu_write_domain(struct drm_gem_object *obj)
 {
 	struct drm_device *dev = obj->dev;
-	uint32_t old_write_domain;
 
 	if ((obj->write_domain & I915_GEM_GPU_DOMAINS) == 0)
 		return 0;
 
 	/* Queue the GPU write cache flushing we need. */
-	old_write_domain = obj->write_domain;
 	i915_gem_flush_ring(dev, NULL,
 			    to_intel_bo(obj)->ring,
 			    0, obj->write_domain);
 	BUG_ON(obj->write_domain);
 
-	trace_i915_gem_object_change_domain(obj,
-					    obj->read_domains,
-					    old_write_domain);
+	if (pipelined)
+		return 0;
 
-	return 0;
+	return i915_gem_object_wait_rendering(obj, true);
 }
 
 /** Flushes the GTT write domain for the object if it's dirty. */
-- 
1.7.6

