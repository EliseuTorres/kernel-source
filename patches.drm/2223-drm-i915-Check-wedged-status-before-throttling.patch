From 78de24b06f81d76aa40cea3381a831ccdc23ed13 Mon Sep 17 00:00:00 2001
From: Chris Wilson <chris@chris-wilson.co.uk>
Date: Wed, 26 Jan 2011 15:39:14 +0000
Patch-mainline: 2.6.39
References: fate#310916
Git-commit: e110e8d672c9e6e395a5c8bfa3444899b85181ed
Subject: [PATCH 2223/2588] drm/i915: Check wedged status before throttling

Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
(cherry picked from commit e110e8d672c9e6e395a5c8bfa3444899b85181ed)

Signed-off-by: Takashi Iwai <tiwai@suse.de>
---
 drivers/gpu/drm/i915/i915_gem.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_gem.c b/drivers/gpu/drm/i915/i915_gem.c
index 76f0214..2bb7cc3 100644
--- a/drivers/gpu/drm/i915/i915_gem.c
+++ b/drivers/gpu/drm/i915/i915_gem.c
@@ -3249,6 +3249,9 @@ i915_gem_ring_throttle(struct drm_device *dev, struct drm_file *file)
 	u32 seqno = 0;
 	int ret;
 
+	if (atomic_read(&dev_priv->mm.wedged))
+		return -EIO;
+
 	spin_lock(&file_priv->mm.lock);
 	list_for_each_entry(request, &file_priv->mm.request_list, client_list) {
 		if (time_after_eq(request->emitted_jiffies, recent_enough))
-- 
1.7.6

