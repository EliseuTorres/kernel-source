From 172fbda35764a7ea8f7d89f2e66a4e6047aac208 Mon Sep 17 00:00:00 2001
From: Chris Wilson <chris@chris-wilson.co.uk>
Date: Thu, 23 Sep 2010 11:16:49 +0100
Patch-mainline: 2.6.37
References: fate#310916
Git-commit: 428d2e828c0a68206e5158a42451487601dc9194
Subject: [PATCH 1480/2588] drm/i915/lvds: Probe DDC on creation

Try to validate the panel's connection by writing to address 0xA0.

Bugzilla: https://bugzilla.kernel.org/show_bug.cgi?id=18072
Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
(cherry picked from commit 428d2e828c0a68206e5158a42451487601dc9194)

Signed-off-by: Takashi Iwai <tiwai@suse.de>
---
 drivers/gpu/drm/i915/intel_lvds.c |   21 +++++++++++++++++++++
 1 files changed, 21 insertions(+), 0 deletions(-)

diff --git a/drivers/gpu/drm/i915/intel_lvds.c b/drivers/gpu/drm/i915/intel_lvds.c
index 625fc9a..7636e94 100644
--- a/drivers/gpu/drm/i915/intel_lvds.c
+++ b/drivers/gpu/drm/i915/intel_lvds.c
@@ -826,6 +826,22 @@ static bool lvds_is_present_in_vbt(struct drm_device *dev)
 	return false;
 }
 
+static bool intel_lvds_ddc_probe(struct drm_device *dev)
+{
+	struct drm_i915_private *dev_priv = dev->dev_private;
+	u8 buf = 0;
+	struct i2c_msg msgs[] = {
+		{
+			.addr = 0xA0,
+			.flags = 0,
+			.len = 1,
+			.buf = &buf,
+		},
+	};
+	struct i2c_adapter *i2c = &dev_priv->gmbus[GMBUS_PORT_PANEL].adapter;
+	return i2c_transfer(i2c, msgs, 1) == 1;
+}
+
 /**
  * intel_lvds_init - setup LVDS connectors on this device
  * @dev: drm device
@@ -865,6 +881,11 @@ void intel_lvds_init(struct drm_device *dev)
 		gpio = PCH_GPIOC;
 	}
 
+	if (!intel_lvds_ddc_probe(dev)) {
+		DRM_DEBUG_KMS("LVDS did not respond to DDC probe\n");
+		return;
+	}
+
 	intel_lvds = kzalloc(sizeof(struct intel_lvds), GFP_KERNEL);
 	if (!intel_lvds) {
 		return;
-- 
1.7.6

