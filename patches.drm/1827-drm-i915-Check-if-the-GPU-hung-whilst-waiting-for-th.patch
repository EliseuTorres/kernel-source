From 895a45e5118263a2383a77a2195c8a8fcedd6849 Mon Sep 17 00:00:00 2001
From: Chris Wilson <chris@chris-wilson.co.uk>
Date: Fri, 29 Oct 2010 21:06:16 +0100
Patch-mainline: 2.6.38
References: fate#310916
Git-commit: f4e0b29bf23687ac16dc476bd90cd4d8b0eacd5c
Subject: [PATCH 1827/2588] drm/i915: Check if the GPU hung whilst waiting for
 the ring to clear

Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
(cherry picked from commit f4e0b29bf23687ac16dc476bd90cd4d8b0eacd5c)

Signed-off-by: Takashi Iwai <tiwai@suse.de>
---
 drivers/gpu/drm/i915/intel_ringbuffer.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/gpu/drm/i915/intel_ringbuffer.c b/drivers/gpu/drm/i915/intel_ringbuffer.c
index 5661c58..2e894b6 100644
--- a/drivers/gpu/drm/i915/intel_ringbuffer.c
+++ b/drivers/gpu/drm/i915/intel_ringbuffer.c
@@ -724,6 +724,8 @@ int intel_wait_ring_buffer(struct intel_ring_buffer *ring, int n)
 		}
 
 		msleep(1);
+		if (atomic_read(&dev_priv->mm.wedged))
+			return -EAGAIN;
 	} while (!time_after(jiffies, end));
 	trace_i915_ring_wait_end (dev);
 	return -EBUSY;
-- 
1.7.6

