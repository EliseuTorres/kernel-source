From: Takashi Iwai <tiwai@suse.de>
Patch-mainline: never
Subject: cirrus: Kms only for secure boot

Compatibility patch taken from SUSE:SLE-11-SP3:GA/drm.

Acked-by: Michal Srb <msrb@suse.com>
---
 drivers/gpu/drm/cirrus/cirrus_drv.c |    8 ++++++++
 1 file changed, 8 insertions(+)

--- a/drivers/gpu/drm/cirrus/cirrus_drv.c
+++ b/drivers/gpu/drm/cirrus/cirrus_drv.c
@@ -10,6 +10,7 @@
  */
 #include <linux/module.h>
 #include <linux/console.h>
+#include <linux/capability.h>
 #include <drm/drmP.h>
 
 #include "cirrus_drv.h"
@@ -119,6 +120,13 @@ static int __init cirrus_init(void)
 		return -EINVAL;
 #endif
 
+#ifdef CAP_COMPROMISE_KERNEL
+	if (capable(CAP_COMPROMISE_KERNEL) && cirrus_modeset == -1) {
+		printk(KERN_INFO "This driver is only used in secure boot mode as default\n");
+		return -EINVAL;
+	}
+#endif
+
 	if (cirrus_modeset == 0)
 		return -EINVAL;
 	return drm_pci_init(&driver, &cirrus_pci_driver);
