From: Takashi Iwai <tiwai@suse.de>
Patch-mainline: never
Subject: i915: lvds add standard modes

Compatibility patch taken from SUSE:SLE-11-SP3:GA/drm.

Acked-by: Michal Srb <msrb@suse.com>
---
 drivers/gpu/drm/i915/intel_lvds.c |   47 +++++++++++++++++++++++++++++++++++---
 1 file changed, 44 insertions(+), 3 deletions(-)

--- a/drivers/gpu/drm/i915/intel_lvds.c
+++ b/drivers/gpu/drm/i915/intel_lvds.c
@@ -450,6 +450,39 @@ intel_lvds_detect(struct drm_connector *
 	return connector_status_connected;
 }
 
+static struct panel_size {
+	int width, height;
+} std_panel_sizes[] = {
+	{1600, 1200}, {1920, 1080}, {1680, 1050}, {1280, 1024},
+	{1440, 900}, {1280, 800}, {1024, 768}, {1280, 720}, {800, 600},
+	{0, 0}
+};
+
+static int add_standard_modes(struct drm_connector *connector,
+			      struct drm_display_mode *mode)
+{
+	struct drm_device *dev = connector->dev;
+	struct panel_size *p = std_panel_sizes;
+	int nums = 0;
+
+	for (; p->width; p++) {
+		struct drm_display_mode *newmode;
+		if (p->width > mode->hdisplay || p->height > mode->vdisplay ||
+		    (p->width == mode->hdisplay && p->height == mode->vdisplay))
+			continue;
+		newmode = drm_mode_duplicate(dev, mode);
+		if (newmode) {
+			newmode->hdisplay = p->width;
+			newmode->vdisplay = p->height;
+			newmode->type &= ~DRM_MODE_TYPE_PREFERRED;
+			drm_mode_set_name(newmode);
+			drm_mode_probed_add(connector, newmode);
+			nums++;
+		}
+	}
+	return nums;
+}
+
 /**
  * Return the list of DDC modes if available, or the BIOS fixed mode otherwise.
  */
@@ -460,15 +493,23 @@ static int intel_lvds_get_modes(struct d
 	struct drm_display_mode *mode;
 
 	/* use cached edid if we have one */
-	if (!IS_ERR_OR_NULL(lvds_connector->base.edid))
-		return drm_add_edid_modes(connector, lvds_connector->base.edid);
+	if (!IS_ERR_OR_NULL(lvds_connector->base.edid)) {
+		int ret;
+		ret = drm_add_edid_modes(connector, lvds_connector->base.edid);
+		if (ret == 1) {
+			mode = list_first_entry(&connector->probed_modes,
+						struct drm_display_mode, head);
+			ret += add_standard_modes(connector, mode);
+		}
+		return ret;
+	}
 
 	mode = drm_mode_duplicate(dev, lvds_connector->base.panel.fixed_mode);
 	if (mode == NULL)
 		return 0;
 
 	drm_mode_probed_add(connector, mode);
-	return 1;
+	return 1 + add_standard_modes(connector, mode);
 }
 
 static int intel_no_modeset_on_lid_dmi_callback(const struct dmi_system_id *id)
