From 63aafae68501e4be184400cfef110a2f29d6d166 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Rafa=C5=82=20Mi=C5=82ecki?= <zajec5@gmail.com>
Date: Wed, 23 Dec 2009 00:42:43 +0100
Patch-mainline: 2.6.34
References: fate#310916
Git-commit: 845db70da0bd285813b25bb522a0281f28efbf89
Subject: [PATCH 0406/2588] drm/radeon/kms: don't set pcie lanes for ignored
 power_state
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Rafał Miłecki <zajec5@gmail.com>
Signed-off-by: Dave Airlie <airlied@redhat.com>
(cherry picked from commit 845db70da0bd285813b25bb522a0281f28efbf89)

Signed-off-by: Takashi Iwai <tiwai@suse.de>
---
 drivers/gpu/drm/radeon/radeon_atombios.c |    8 ++++----
 1 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/drivers/gpu/drm/radeon/radeon_atombios.c b/drivers/gpu/drm/radeon/radeon_atombios.c
index f7b0cac..da70beb 100644
--- a/drivers/gpu/drm/radeon/radeon_atombios.c
+++ b/drivers/gpu/drm/radeon/radeon_atombios.c
@@ -1627,10 +1627,6 @@ void radeon_atombios_get_power_modes(struct radeon_device *rdev)
 					 le16_to_cpu(power_info->info_4.usNonClockInfoArrayOffset) +
 					 (power_state->ucNonClockStateIndex *
 					  power_info->info_4.ucNonClockSize));
-				misc = le32_to_cpu(non_clock_info->ulCapsAndSettings);
-				rdev->pm.power_state[state_index].non_clock_info.pcie_lanes =
-					((misc & ATOM_PPLIB_PCIE_LINK_WIDTH_MASK) >>
-					 ATOM_PPLIB_PCIE_LINK_WIDTH_SHIFT) + 1;
 				for (j = 0; j < (power_info->info_4.ucStateEntrySize - 1); j++) {
 					if (rdev->flags & RADEON_IS_IGP) {
 						struct _ATOM_PPLIB_RS780_CLOCK_INFO *clock_info =
@@ -1688,7 +1684,11 @@ void radeon_atombios_get_power_modes(struct radeon_device *rdev)
 				}
 				rdev->pm.power_state[state_index].num_clock_modes = mode_index;
 				if (mode_index) {
+					misc = le32_to_cpu(non_clock_info->ulCapsAndSettings);
 					misc2 = le16_to_cpu(non_clock_info->usClassification);
+					rdev->pm.power_state[state_index].non_clock_info.pcie_lanes =
+						((misc & ATOM_PPLIB_PCIE_LINK_WIDTH_MASK) >>
+						ATOM_PPLIB_PCIE_LINK_WIDTH_SHIFT) + 1;
 					if (misc2 & ATOM_PPLIB_CLASSIFICATION_BOOT) {
 						rdev->pm.default_power_state = &rdev->pm.power_state[state_index];
 						rdev->pm.current_power_state = &rdev->pm.power_state[state_index];
-- 
1.7.6

