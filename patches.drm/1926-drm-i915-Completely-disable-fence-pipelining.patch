From 46041b6802950e1729ae5e00d22f929f26f6ee5a Mon Sep 17 00:00:00 2001
From: Chris Wilson <chris@chris-wilson.co.uk>
Date: Sun, 5 Dec 2010 21:04:18 +0000
Patch-mainline: 2.6.38
References: fate#310916
Git-commit: 6bda10d152735c22baf1dcd92937420b4b0a359a
Subject: [PATCH 1926/2588] drm/i915: Completely disable fence pipelining.

I'm still seeing tiling corruption of PutImage and CopyArea (I think)
under mutter on pnv, so obviously the pipelining logic is deeply flawed.

Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
(cherry picked from commit 6bda10d152735c22baf1dcd92937420b4b0a359a)

Signed-off-by: Takashi Iwai <tiwai@suse.de>
---
 drivers/gpu/drm/i915/i915_gem.c |    6 ++++--
 1 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_gem.c b/drivers/gpu/drm/i915/i915_gem.c
index f93709f..a847b14 100644
--- a/drivers/gpu/drm/i915/i915_gem.c
+++ b/drivers/gpu/drm/i915/i915_gem.c
@@ -2502,6 +2502,9 @@ i915_gem_object_get_fence(struct drm_i915_gem_object *obj,
 	struct drm_i915_fence_reg *reg;
 	int ret;
 
+	/* XXX disable pipelining. There are bugs. Shocking. */
+	pipelined = NULL;
+
 	/* Just update our place in the LRU if our fence is getting reused. */
 	if (obj->fence_reg != I915_FENCE_REG_NONE) {
 		reg = &dev_priv->fence_regs[obj->fence_reg];
@@ -2574,9 +2577,8 @@ i915_gem_object_get_fence(struct drm_i915_gem_object *obj,
 		if (old->tiling_mode)
 			i915_gem_release_mmap(old);
 
-		/* XXX The pipelined change over appears to be incoherent. */
 		ret = i915_gem_object_flush_fence(old,
-						  NULL, //pipelined,
+						  pipelined,
 						  interruptible);
 		if (ret) {
 			drm_gem_object_unreference(&old->base);
-- 
1.7.6

