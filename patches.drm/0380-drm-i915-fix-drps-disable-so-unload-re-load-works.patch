From 20e1cc12d09634b592c977e4b7be2b93e230983f Mon Sep 17 00:00:00 2001
From: Jesse Barnes <jbarnes@virtuousgeek.org>
Date: Thu, 4 Feb 2010 14:17:47 -0800
Patch-mainline: 2.6.34
References: fate#310916
Git-commit: 357b13c3e498bb658f511f91a9e4f09c9553be6e
Subject: [PATCH 0380/2588] drm/i915: fix drps disable so unload & re-load
 works

At unload time, we need to disable DRPS, but we need to do it correctly
or the GPU will hang and we won't be able to load the module again.  So
set the SFCAVM bit so we can properly restore the DRPS config at unload.

Signed-off-by: Jesse Barnes <jbarnes@virtuousgeek.org>
Signed-off-by: Eric Anholt <eric@anholt.net>
(cherry picked from commit 357b13c3e498bb658f511f91a9e4f09c9553be6e)

Signed-off-by: Takashi Iwai <tiwai@suse.de>
---
 drivers/gpu/drm/i915/intel_display.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/gpu/drm/i915/intel_display.c b/drivers/gpu/drm/i915/intel_display.c
index 65fda1e..558b550 100644
--- a/drivers/gpu/drm/i915/intel_display.c
+++ b/drivers/gpu/drm/i915/intel_display.c
@@ -4700,7 +4700,7 @@ void ironlake_disable_drps(struct drm_device *dev)
 	fstart = (I915_READ(MEMMODECTL) & MEMMODE_FSTART_MASK) >>
 		MEMMODE_FSTART_SHIFT;
 	rgvswctl = (MEMCTL_CMD_CHFREQ << MEMCTL_CMD_SHIFT) |
-		(fstart << MEMCTL_FREQ_SHIFT);
+		(fstart << MEMCTL_FREQ_SHIFT) | MEMCTL_SFCAVM;
 	I915_WRITE(MEMSWCTL, rgvswctl);
 	msleep(1);
 	rgvswctl |= MEMCTL_CMD_STS;
-- 
1.7.6

