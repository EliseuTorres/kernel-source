From: Egbert Eich <Egbert Eich eich@suse.de>
Date: Thu May 2 12:10:37 2013 +0200
Subject: drm/mgag200: Fix logic in mgag200_bo_pin()
Patch-Mainline: to be upstreamed
Git-commit: e849a7a6827932bc035251b8147d50baf84ae9ed
Git-repo: git://people.freedesktop.org/~airlied/linux/
References: bnc #806990
Signed-off-by: Egbert Eich <eich@suse.com>

Signed-off-by: Egbert Eich <eich@suse.de>
---
 drivers/gpu/drm/mgag200/mgag200_ttm.c |   21 ++++++++-------------
 1 file changed, 8 insertions(+), 13 deletions(-)

--- linux-3.0-SLE11-SP3.orig/drivers/gpu/drm/mgag200/mgag200_ttm.c
+++ linux-3.0-SLE11-SP3/drivers/gpu/drm/mgag200/mgag200_ttm.c
@@ -373,20 +373,15 @@ int mgag200_bo_pin(struct mgag200_bo *bo
 {
 	int i, ret;
 
-	if (bo->pin_count) {
-		bo->pin_count++;
-		if (gpu_addr)
-			*gpu_addr = mgag200_bo_gpu_offset(bo);
+	if (!bo->pin_count) {
+		mgag200_ttm_placement(bo, pl_flag);
+		for (i = 0; i < bo->placement.num_placement; i++)
+			bo->placements[i] |= TTM_PL_FLAG_NO_EVICT;
+		ret = ttm_bo_validate(&bo->bo, &bo->placement, false, false, false);
+		if (ret)
+			return ret;
 	}
-
-	mgag200_ttm_placement(bo, pl_flag);
-	for (i = 0; i < bo->placement.num_placement; i++)
-		bo->placements[i] |= TTM_PL_FLAG_NO_EVICT;
-	ret = ttm_bo_validate(&bo->bo, &bo->placement, false, false, false);
-	if (ret)
-		return ret;
-
-	bo->pin_count = 1;
+	bo->pin_count++;
 	if (gpu_addr)
 		*gpu_addr = mgag200_bo_gpu_offset(bo);
 	return 0;
