From 97e32e0aef0536eb46b464aedadd7d43ac9043a1 Mon Sep 17 00:00:00 2001
From: Chris Wilson <chris@chris-wilson.co.uk>
Date: Tue, 14 Dec 2010 12:17:15 +0000
Patch-mainline: 2.6.38
References: fate#310916
Git-commit: b5ba177d8d71f011c23b1cabec99fdaddae65c4d
Subject: [PATCH 1939/2588] drm/i915: Poll for seqno completion if IRQ is
 disabled

Bugzilla: https://bugs.freedesktop.org/show_bug.cgi?id=32288
Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
(cherry picked from commit b5ba177d8d71f011c23b1cabec99fdaddae65c4d)

Signed-off-by: Takashi Iwai <tiwai@suse.de>
---
 drivers/gpu/drm/i915/i915_gem.c |    6 ++++--
 1 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_gem.c b/drivers/gpu/drm/i915/i915_gem.c
index d1a320d..6ee145b 100644
--- a/drivers/gpu/drm/i915/i915_gem.c
+++ b/drivers/gpu/drm/i915/i915_gem.c
@@ -2018,7 +2018,6 @@ i915_do_wait_request(struct drm_device *dev, uint32_t seqno,
 		trace_i915_gem_request_wait_begin(dev, seqno);
 
 		ring->waiting_seqno = seqno;
-		ret = -ENODEV;
 		if (ring->irq_get(ring)) {
 			if (interruptible)
 				ret = wait_event_interruptible(ring->irq_queue,
@@ -2030,7 +2029,10 @@ i915_do_wait_request(struct drm_device *dev, uint32_t seqno,
 					   || atomic_read(&dev_priv->mm.wedged));
 
 			ring->irq_put(ring);
-		}
+		} else if (wait_for(i915_seqno_passed(ring->get_seqno(ring),
+						      seqno) ||
+				    atomic_read(&dev_priv->mm.wedged), 3000))
+			ret = -EBUSY;
 		ring->waiting_seqno = 0;
 
 		trace_i915_gem_request_wait_end(dev, seqno);
-- 
1.7.6

