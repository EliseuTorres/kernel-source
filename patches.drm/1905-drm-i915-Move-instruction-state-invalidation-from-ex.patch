From 730428ba13865d5278e97d79ca304f9d1bcad53b Mon Sep 17 00:00:00 2001
From: Chris Wilson <chris@chris-wilson.co.uk>
Date: Tue, 30 Nov 2010 14:07:47 +0000
Patch-mainline: 2.6.38
References: fate#310916
Git-commit: 70eac33e7ac370dc137cabff7a4ba3094ca25a8c
Subject: [PATCH 1905/2588] drm/i915: Move instruction state invalidation from
 execbuffer to flush

Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
(cherry picked from commit 70eac33e7ac370dc137cabff7a4ba3094ca25a8c)

Signed-off-by: Takashi Iwai <tiwai@suse.de>
---
 drivers/gpu/drm/i915/intel_ringbuffer.c |   15 ++++-----------
 1 files changed, 4 insertions(+), 11 deletions(-)

diff --git a/drivers/gpu/drm/i915/intel_ringbuffer.c b/drivers/gpu/drm/i915/intel_ringbuffer.c
index c08e6c1..21f09d1 100644
--- a/drivers/gpu/drm/i915/intel_ringbuffer.c
+++ b/drivers/gpu/drm/i915/intel_ringbuffer.c
@@ -109,6 +109,10 @@ render_ring_flush(struct intel_ring_buffer *ring,
 		if (invalidate_domains & I915_GEM_DOMAIN_INSTRUCTION)
 			cmd |= MI_EXE_FLUSH;
 
+		if (invalidate_domains & I915_GEM_DOMAIN_COMMAND &&
+		    (IS_G4X(dev) || IS_GEN5(dev)))
+			cmd |= MI_INVALIDATE_ISP;
+
 #if WATCH_EXEC
 		DRM_INFO("%s: queue flush %08x to ring\n", __func__, cmd);
 #endif
@@ -585,17 +589,6 @@ render_ring_dispatch_execbuffer(struct intel_ring_buffer *ring,
 		intel_ring_advance(ring);
 	}
 
-	if (IS_G4X(dev) || IS_GEN5(dev)) {
-		if (intel_ring_begin(ring, 2) == 0) {
-			intel_ring_emit(ring, MI_FLUSH |
-					MI_NO_WRITE_FLUSH |
-					MI_INVALIDATE_ISP );
-			intel_ring_emit(ring, MI_NOOP);
-			intel_ring_advance(ring);
-		}
-	}
-	/* XXX breadcrumb */
-
 	return 0;
 }
 
-- 
1.7.6

