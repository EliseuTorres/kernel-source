From: Egbert Eich <eich@suse.de>
Date: Wed Jun 11 14:59:55 2014 +0200
Subject: drm/ast: Initialized data needed to map fbdev memory
Patch-mainline: to be upstreamed
References: bnc#880007
Signed-off-by: Egbert Eich <eich@suse.com>

Due to a missing initialization there was no way to map fbdev memory.
Thus for example using the Xserver with the fbdev driver failed.
This fix adds initialization for fix.smem_start and fix.smem_len
in the fb_info structure, which fixes this problem.

Signed-off-by: Egbert Eich <eich@suse.de>
---
 drivers/gpu/drm/ast/ast_fb.c |    3 +++
 1 file changed, 3 insertions(+)

--- linux-3.0.orig/drivers/gpu/drm/ast/ast_fb.c
+++ linux-3.0/drivers/gpu/drm/ast/ast_fb.c
@@ -149,6 +149,7 @@ static int astfb_create(struct ast_fbdev
 			struct drm_fb_helper_surface_size *sizes)
 {
 	struct drm_device *dev = afbdev->helper.dev;
+	struct ast_private *ast = dev->dev_private;
 	struct drm_mode_fb_cmd2 mode_cmd;
 	struct drm_framebuffer *fb;
 	struct fb_info *info = NULL;
@@ -213,6 +214,8 @@ static int astfb_create(struct ast_fbdev
 	}
 	info->apertures->ranges[0].base = pci_resource_start(dev->pdev, 0);
 	info->apertures->ranges[0].size = pci_resource_len(dev->pdev, 0);
+	info->fix.smem_start = info->apertures->ranges[0].base;
+	info->fix.smem_len = ast->vram_size;
 
 	drm_fb_helper_fill_fix(info, fb->pitches[0], fb->depth);
 	drm_fb_helper_fill_var(info, &afbdev->helper, sizes->fb_width, sizes->fb_height);
