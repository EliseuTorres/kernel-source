From 38f5f08cd0678020ba1e37a9defe3af486f1021f Mon Sep 17 00:00:00 2001
From: Chris Wilson <chris@chris-wilson.co.uk>
Date: Sun, 12 Sep 2010 13:34:08 +0100
Patch-mainline: 2.6.37
References: fate#310916
Git-commit: ec5da01e23eec303dd313aa62b8ed4712c488437
Subject: [PATCH 1395/2588] drm/i915: Use msleep instead of mdelay during
 wait_vblank_off

Avoid a potentially long busy-wait if we not in the process of
atomically switching to the kdb console.

Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
(cherry picked from commit ec5da01e23eec303dd313aa62b8ed4712c488437)

Signed-off-by: Takashi Iwai <tiwai@suse.de>
---
 drivers/gpu/drm/i915/intel_display.c |   36 +++++++++++++--------------------
 drivers/gpu/drm/i915/intel_drv.h     |    7 ++++++
 2 files changed, 21 insertions(+), 22 deletions(-)

diff --git a/drivers/gpu/drm/i915/intel_display.c b/drivers/gpu/drm/i915/intel_display.c
index 2a8602c..e3e971e 100644
--- a/drivers/gpu/drm/i915/intel_display.c
+++ b/drivers/gpu/drm/i915/intel_display.c
@@ -1037,28 +1037,20 @@ void intel_wait_for_vblank(struct drm_device *dev, int pipe)
 static void intel_wait_for_pipe_off(struct drm_device *dev, int pipe)
 {
 	struct drm_i915_private *dev_priv = dev->dev_private;
-
-	if (INTEL_INFO(dev)->gen >= 4) {
-		int pipeconf_reg = (pipe == 0 ? PIPEACONF : PIPEBCONF);
-
-		/* Wait for the Pipe State to go off */
-		if (wait_for((I915_READ(pipeconf_reg) & I965_PIPECONF_ACTIVE) == 0,
-			     100, 0))
-			DRM_DEBUG_KMS("pipe_off wait timed out\n");
-	} else {
-		u32 last_line;
-		int pipedsl_reg = (pipe == 0 ? PIPEADSL : PIPEBDSL);
-		unsigned long timeout = jiffies + msecs_to_jiffies(100);
-
-		/* Wait for the display line to settle */
-		do {
-			last_line = I915_READ(pipedsl_reg) & DSL_LINEMASK;
-			mdelay(5);
-		} while (((I915_READ(pipedsl_reg) & DSL_LINEMASK) != last_line) &&
-			 time_after(timeout, jiffies));
-		if (time_after(jiffies, timeout))
-			DRM_DEBUG_KMS("pipe_off wait timed out\n");
-	}
+	int pipedsl_reg = (pipe == 0 ? PIPEADSL : PIPEBDSL);
+	unsigned long timeout = jiffies + msecs_to_jiffies(100);
+	u32 last_line, line;
+
+	/* Wait for the display line to settle */
+	line = I915_READ(pipedsl_reg) & DSL_LINEMASK;
+	do {
+		last_line = line;
+		MSLEEP(5);
+		line = I915_READ(pipedsl_reg) & DSL_LINEMASK;
+	} while (line != last_line && time_after(timeout, jiffies));
+
+	if (line != last_line)
+		DRM_DEBUG_KMS("vblank wait timed out\n");
 }
 
 static void i8xx_enable_fbc(struct drm_crtc *crtc, unsigned long interval)
diff --git a/drivers/gpu/drm/i915/intel_drv.h b/drivers/gpu/drm/i915/intel_drv.h
index efe4827..ccf2e52 100644
--- a/drivers/gpu/drm/i915/intel_drv.h
+++ b/drivers/gpu/drm/i915/intel_drv.h
@@ -49,6 +49,13 @@
 #define wait_for(COND, MS) _wait_for(COND, MS, 1)
 #define wait_for_atomic(COND, MS) _wait_for(COND, MS, 0)
 
+#define MSLEEP(x) do { \
+	if (in_dbg_master()) \
+	       	mdelay(x); \
+	else \
+		msleep(x); \
+} while(0)
+
 #define KHz(x) (1000*x)
 #define MHz(x) KHz(1000*x)
 
-- 
1.7.6

