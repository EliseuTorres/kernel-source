From fa2344459eaa73a5a7cb5bfa6dcf205142d05957 Mon Sep 17 00:00:00 2001
From: Bjorn Helgaas <bjorn.helgaas@hp.com>
Date: Thu, 7 Jan 2010 12:58:56 -0700
Patch-mainline: 2.6.33-rc4
References: fate#310916
Git-commit: 3d4a7882b11299104a0e74425dece2e26ac98024
Subject: [PATCH 2358/2588] agp/hp: fail gracefully if we don't find an IOC

Bail out if we don't find an enclosing IOC.  Previously, if we didn't
find one, we tried to set things up using garbage for the SBA/IOC register
address, which causes a crash.

This crash only happens if firmware supplies a defective ACPI namespace, so
it doesn't fix any problems in the field.

Signed-off-by: Bjorn Helgaas <bjorn.helgaas@hp.com>
Signed-off-by: Dave Airlie <airlied@redhat.com>
(cherry picked from commit 3d4a7882b11299104a0e74425dece2e26ac98024)

Signed-off-by: Takashi Iwai <tiwai@suse.de>
---
 drivers/char/agp/hp-agp.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/drivers/char/agp/hp-agp.c b/drivers/char/agp/hp-agp.c
index dc8a6f7..58752b7 100644
--- a/drivers/char/agp/hp-agp.c
+++ b/drivers/char/agp/hp-agp.c
@@ -508,6 +508,9 @@ zx1_gart_probe (acpi_handle obj, u32 depth, void *context, void **ret)
 		handle = parent;
 	} while (ACPI_SUCCESS(status));
 
+	if (ACPI_FAILURE(status))
+		return AE_OK;	/* found no enclosing IOC */
+
 	if (hp_zx1_setup(sba_hpa + HP_ZX1_IOC_OFFSET, lba_hpa))
 		return AE_OK;
 
-- 
1.7.6

