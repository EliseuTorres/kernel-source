From 432d5f455919e69cb40407d9971dfd5c77508f66 Mon Sep 17 00:00:00 2001
From: Matthew Garrett <mjg@redhat.com>
Date: Tue, 18 May 2010 13:53:16 -0400
Patch-mainline: 2.6.37
References: fate#310916
Git-commit: 309b1e3ab750c0ad4d77c6a6e434402e3346baf4
Subject: [PATCH 1338/2588] drm/i915: Don't disable panel for modesetting if
 pfit hasn't changed

It seems to be possible to program a new mode without disabling the panel
if the panel fitter setup doesn't change. Add support for that.

Signed-off-by: Matthew Garrett <mjg@redhat.com>
Acked-by: Jesse Barnes <jbarnes@virtuousgeek.org>
Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
(cherry picked from commit 309b1e3ab750c0ad4d77c6a6e434402e3346baf4)

Signed-off-by: Takashi Iwai <tiwai@suse.de>
---
 drivers/gpu/drm/i915/intel_lvds.c |   21 +++++++++++++++++++--
 1 files changed, 19 insertions(+), 2 deletions(-)

diff --git a/drivers/gpu/drm/i915/intel_lvds.c b/drivers/gpu/drm/i915/intel_lvds.c
index 539c9dc..04ce60f 100644
--- a/drivers/gpu/drm/i915/intel_lvds.c
+++ b/drivers/gpu/drm/i915/intel_lvds.c
@@ -53,6 +53,16 @@ static struct intel_lvds *enc_to_intel_lvds(struct drm_encoder *encoder)
 	return container_of(enc_to_intel_encoder(encoder), struct intel_lvds, base);
 }
 
+static void intel_lvds_lock_panel(struct drm_device *dev, bool lock)
+{
+	struct drm_i915_private *dev_priv = dev->dev_private;
+
+	if (lock)
+		I915_WRITE(PP_CONTROL, I915_READ(PP_CONTROL) & 0x3);
+	else
+		I915_WRITE(PP_CONTROL, I915_READ(PP_CONTROL) | PANEL_UNLOCK_REGS);
+}
+
 /**
  * Sets the power state for the panel.
  */
@@ -349,10 +359,14 @@ static void intel_lvds_prepare(struct drm_encoder *encoder)
 {
 	struct drm_device *dev = encoder->dev;
 	struct drm_i915_private *dev_priv = dev->dev_private;
+	struct intel_lvds *intel_lvds = enc_to_intel_lvds(encoder);
 
 	dev_priv->backlight_level = intel_panel_get_backlight(dev);
 
-	intel_lvds_set_power(dev, false);
+	if (intel_lvds->pfit_control == I915_READ(PFIT_CONTROL))
+		intel_lvds_lock_panel(dev, false);
+	else
+		intel_lvds_set_power(dev, false);
 }
 
 static void intel_lvds_commit( struct drm_encoder *encoder)
@@ -363,7 +377,10 @@ static void intel_lvds_commit( struct drm_encoder *encoder)
 	if (dev_priv->backlight_level == 0)
 		dev_priv->backlight_level = intel_panel_get_max_backlight(dev);
 
-	intel_lvds_set_power(dev, true);
+	if ((I915_READ(PP_CONTROL) & PANEL_UNLOCK_REGS) == PANEL_UNLOCK_REGS)
+		intel_lvds_lock_panel(dev, true);
+	else
+		intel_lvds_set_power(dev, true);
 }
 
 static void intel_lvds_mode_set(struct drm_encoder *encoder,
-- 
1.7.6

