From 8f7220eddb017c6efbadeca6a7dc9457414429a6 Mon Sep 17 00:00:00 2001
From: Alex Deucher <alexdeucher@gmail.com>
Date: Mon, 15 Mar 2010 17:09:05 -0400
Patch-mainline: 2.6.35
References: fate#310916
Git-commit: 8a56df632e524a1c444c56bb7ce9fe8d94e639e0
Subject: [PATCH 0733/2588] drm/radeon/kms/pm: interate across crtcs for
 vblank

Signed-off-by: Alex Deucher <alexdeucher@gmail.com>
Signed-off-by: Dave Airlie <airlied@redhat.com>
(cherry picked from commit 8a56df632e524a1c444c56bb7ce9fe8d94e639e0)

Signed-off-by: Takashi Iwai <tiwai@suse.de>
---
 drivers/gpu/drm/radeon/radeon_pm.c |   26 ++++++++++++--------------
 1 files changed, 12 insertions(+), 14 deletions(-)

diff --git a/drivers/gpu/drm/radeon/radeon_pm.c b/drivers/gpu/drm/radeon/radeon_pm.c
index 4ece89a..ff3abd8 100644
--- a/drivers/gpu/drm/radeon/radeon_pm.c
+++ b/drivers/gpu/drm/radeon/radeon_pm.c
@@ -375,6 +375,8 @@ static void radeon_pm_set_clocks_locked(struct radeon_device *rdev)
 
 static void radeon_pm_set_clocks(struct radeon_device *rdev)
 {
+	int i;
+
 	radeon_get_power_state(rdev, rdev->pm.planned_action);
 	mutex_lock(&rdev->cp.mutex);
 
@@ -388,22 +390,18 @@ static void radeon_pm_set_clocks(struct radeon_device *rdev)
 	rdev->irq.gui_idle = false;
 	radeon_irq_set(rdev);
 
-	if (rdev->pm.active_crtcs & (1 << 0)) {
-		rdev->pm.req_vblank |= (1 << 0);
-		drm_vblank_get(rdev->ddev, 0);
-	}
-	if (rdev->pm.active_crtcs & (1 << 1)) {
-		rdev->pm.req_vblank |= (1 << 1);
-		drm_vblank_get(rdev->ddev, 1);
+	for (i = 0; i < rdev->num_crtc; i++) {
+		if (rdev->pm.active_crtcs & (1 << i)) {
+			rdev->pm.req_vblank |= (1 << i);
+			drm_vblank_get(rdev->ddev, i);
+		}
 	}
 	radeon_pm_set_clocks_locked(rdev);
-	if (rdev->pm.req_vblank & (1 << 0)) {
-		rdev->pm.req_vblank &= ~(1 << 0);
-		drm_vblank_put(rdev->ddev, 0);
-	}
-	if (rdev->pm.req_vblank & (1 << 1)) {
-		rdev->pm.req_vblank &= ~(1 << 1);
-		drm_vblank_put(rdev->ddev, 1);
+	for (i = 0; i < rdev->num_crtc; i++) {
+		if (rdev->pm.req_vblank & (1 << i)) {
+			rdev->pm.req_vblank &= ~(1 << i);
+			drm_vblank_put(rdev->ddev, i);
+		}
 	}
 
 	mutex_unlock(&rdev->cp.mutex);
-- 
1.7.6

