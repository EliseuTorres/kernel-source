From: Takashi Iwai <tiwai@suse.de>
Patch-mainline: never
Subject: ast: Kms only for secure boot

Compatibility patch taken from SUSE:SLE-11-SP3:GA/drm.

Acked-by: Michal Srb <msrb@suse.com>
---
 drivers/gpu/drm/ast/ast_drv.c |    8 ++++++++
 1 file changed, 8 insertions(+)

--- a/drivers/gpu/drm/ast/ast_drv.c
+++ b/drivers/gpu/drm/ast/ast_drv.c
@@ -27,6 +27,7 @@
  */
 #include <linux/module.h>
 #include <linux/console.h>
+#include <linux/capability.h>
 
 #include <drm/drmP.h>
 #include <drm/drm_crtc_helper.h>
@@ -228,6 +229,13 @@ static int __init ast_init(void)
 		return -EINVAL;
 #endif
 
+#ifdef CAP_COMPROMISE_KERNEL
+	if (capable(CAP_COMPROMISE_KERNEL) && ast_modeset == -1) {
+		printk(KERN_INFO "This driver is only used in secure boot mode as default\n");
+		return -EINVAL;
+	}
+#endif
+
 	if (ast_modeset == 0)
 		return -EINVAL;
 	return drm_pci_init(&driver, &ast_pci_driver);
