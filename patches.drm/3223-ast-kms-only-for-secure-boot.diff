From: Takashi Iwai <tiwai@suse.de>
Patch-mainline: never
Subject: ast: Kms only for secure boot

Compatibility patch taken from SUSE:SLE-11-SP3:GA/drm.

Joey Lee:
Replaced CAP_COMPROMISE_KERNEL by secure_modules().

Acked-by: Michal Srb <msrb@suse.com>
Acked-by: Lee, Chun-Yi <jlee@suse.com>
---
 drivers/gpu/drm/ast/ast_drv.c |    8 ++++++++
 1 file changed, 8 insertions(+)

Index: linux-3.0-SLE11-SP3/drivers/gpu/drm/ast/ast_drv.c
===================================================================
--- linux-3.0-SLE11-SP3.orig/drivers/gpu/drm/ast/ast_drv.c
+++ linux-3.0-SLE11-SP3/drivers/gpu/drm/ast/ast_drv.c
@@ -228,6 +228,11 @@ static int __init ast_init(void)
 		return -EINVAL;
 #endif
 
+	if (!secure_modules() && ast_modeset == -1) {
+		printk(KERN_INFO "This driver is only used in secure boot mode as default\n");
+		return -EINVAL;
+	}
+
 	if (ast_modeset == 0)
 		return -EINVAL;
 	return drm_pci_init(&driver, &ast_pci_driver);
