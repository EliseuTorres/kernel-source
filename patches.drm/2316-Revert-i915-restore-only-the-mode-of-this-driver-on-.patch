From a420f4866aa4ef29886f53d576f028b8a0b6c928 Mon Sep 17 00:00:00 2001
From: Dave Airlie <airlied@redhat.com>
Date: Wed, 13 Apr 2011 09:20:24 +1000
Patch-mainline: 2.6.39
References: fate#310916
Git-commit: 2582b6efceb43dce63b4a1090d289934067a972d
Subject: [PATCH 2316/2588] Revert "i915: restore only the mode of this driver
 on lastclose"

This reverts commit 0a0883c8433c743dad0a4d9ebe2717558f2c209e.

this was in my tree by accident, I meant to rebase it out and
didn't realise in time.

Signed-off-by: Dave Airlie <airlied@redhat.com>
(cherry picked from commit 2582b6efceb43dce63b4a1090d289934067a972d)

Signed-off-by: Takashi Iwai <tiwai@suse.de>
---
 drivers/gpu/drm/i915/i915_dma.c  |    2 +-
 drivers/gpu/drm/i915/intel_drv.h |    1 -
 drivers/gpu/drm/i915/intel_fb.c  |   16 ----------------
 3 files changed, 1 insertions(+), 18 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_dma.c b/drivers/gpu/drm/i915/i915_dma.c
index df851dc..52819e0 100644
--- a/drivers/gpu/drm/i915/i915_dma.c
+++ b/drivers/gpu/drm/i915/i915_dma.c
@@ -2184,7 +2184,7 @@ void i915_driver_lastclose(struct drm_device * dev)
 	drm_i915_private_t *dev_priv = dev->dev_private;
 
 	if (!dev_priv || drm_core_check_feature(dev, DRIVER_MODESET)) {
-		intel_fb_restore_mode(dev);
+		drm_fb_helper_restore();
 		vga_switcheroo_process_delayed_switch();
 		return;
 	}
diff --git a/drivers/gpu/drm/i915/intel_drv.h b/drivers/gpu/drm/i915/intel_drv.h
index 1d20712..f5b0d83 100644
--- a/drivers/gpu/drm/i915/intel_drv.h
+++ b/drivers/gpu/drm/i915/intel_drv.h
@@ -338,5 +338,4 @@ extern int intel_overlay_attrs(struct drm_device *dev, void *data,
 			       struct drm_file *file_priv);
 
 extern void intel_fb_output_poll_changed(struct drm_device *dev);
-extern void intel_fb_restore_mode(struct drm_device *dev);
 #endif /* __INTEL_DRV_H__ */
diff --git a/drivers/gpu/drm/i915/intel_fb.c b/drivers/gpu/drm/i915/intel_fb.c
index 6048765..4164eab 100644
--- a/drivers/gpu/drm/i915/intel_fb.c
+++ b/drivers/gpu/drm/i915/intel_fb.c
@@ -264,19 +264,3 @@ void intel_fb_output_poll_changed(struct drm_device *dev)
 	drm_i915_private_t *dev_priv = dev->dev_private;
 	drm_fb_helper_hotplug_event(&dev_priv->fbdev->helper);
 }
-
-void intel_fb_restore_mode(struct drm_device *dev)
-{
-	drm_i915_private_t *dev_priv = dev->dev_private;
-	int ret, i;
-
-	if (!dev_priv->fbdev)
-		return;
-
-	for (i = 0; i < dev_priv->fbdev->helper.crtc_count; i++) {
-		struct drm_mode_set *mode_set = &dev_priv->fbdev->helper.crtc_info[i].mode_set;
-		ret = drm_crtc_helper_set_config(mode_set);
-		if (ret)
-			DRM_DEBUG("failed to restore crtc mode\n");
-	}
-}
-- 
1.7.6

