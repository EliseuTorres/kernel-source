From 22cfd530f4014da7f1c69a4cab4014e15af23792 Mon Sep 17 00:00:00 2001
From: Daniel Vetter <daniel.vetter@ffwll.ch>
Date: Thu, 11 Feb 2010 22:53:20 +0100
Patch-mainline: 2.6.37
References: fate#310916
Git-commit: 4fc6ee764620eb3a9364e736d03605d4b233ea61
Subject: [PATCH 1302/2588] drm/i915: drop i915_add_request right in front of
 i915_wait_request

... take advantage of the new implicit request issuing of
i915_wait_request.

Signed-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
(cherry picked from commit 4fc6ee764620eb3a9364e736d03605d4b233ea61)

Signed-off-by: Takashi Iwai <tiwai@suse.de>
---
 drivers/gpu/drm/i915/i915_gem.c |   16 +++++++---------
 1 files changed, 7 insertions(+), 9 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_gem.c b/drivers/gpu/drm/i915/i915_gem.c
index 120b875..a0a3c9b 100644
--- a/drivers/gpu/drm/i915/i915_gem.c
+++ b/drivers/gpu/drm/i915/i915_gem.c
@@ -2045,7 +2045,6 @@ i915_gpu_idle(struct drm_device *dev)
 {
 	drm_i915_private_t *dev_priv = dev->dev_private;
 	bool lists_empty;
-	uint32_t seqno1, seqno2;
 	int ret;
 
 	spin_lock(&dev_priv->mm.active_list_lock);
@@ -2060,18 +2059,17 @@ i915_gpu_idle(struct drm_device *dev)
 
 	/* Flush everything onto the inactive list. */
 	i915_gem_flush(dev, I915_GEM_GPU_DOMAINS, I915_GEM_GPU_DOMAINS);
-	seqno1 = i915_add_request(dev, NULL, &dev_priv->render_ring);
-	if (seqno1 == 0)
-		return -ENOMEM;
-	ret = i915_wait_request(dev, seqno1, &dev_priv->render_ring);
+
+	ret = i915_wait_request(dev,
+				i915_gem_next_request_seqno(dev, &dev_priv->render_ring),
+				&dev_priv->render_ring);
 	if (ret)
 		return ret;
 
 	if (HAS_BSD(dev)) {
-		seqno2 = i915_add_request(dev, NULL, &dev_priv->bsd_ring);
-		if (seqno2 == 0)
-			return -ENOMEM;
-		ret = i915_wait_request(dev, seqno2, &dev_priv->bsd_ring);
+		ret = i915_wait_request(dev,
+					i915_gem_next_request_seqno(dev, &dev_priv->bsd_ring),
+					&dev_priv->bsd_ring);
 		if (ret)
 			return ret;
 	}
-- 
1.7.6

