From 757833cc9f0c334ecf739836f4e052c11bf81264 Mon Sep 17 00:00:00 2001
From: Ben Skeggs <bskeggs@redhat.com>
Date: Thu, 23 Aug 2012 01:14:21 -0400
Subject: drm/nouveau/sw: trap and clear PMC_INTR_0_SOFTWARE
Git-commit: 757833cc9f0c334ecf739836f4e052c11bf81264
Patch-mainline: v3.7-rc3

Came in useful for debugging another issue earlier, so keep it around.

Signed-off-by: Ben Skeggs <bskeggs@redhat.com>
Acked-by: Michal Srb <msrb@suse.com>
---
 .../gpu/drm/nouveau/core/engine/software/nv04.c    |    7 +++++++
 .../gpu/drm/nouveau/core/engine/software/nv10.c    |    1 +
 .../gpu/drm/nouveau/core/engine/software/nv50.c    |    1 +
 .../gpu/drm/nouveau/core/engine/software/nvc0.c    |    1 +
 .../gpu/drm/nouveau/core/include/engine/software.h |    2 ++
 5 files changed, 12 insertions(+), 0 deletions(-)

diff --git a/drivers/gpu/drm/nouveau/core/engine/software/nv04.c b/drivers/gpu/drm/nouveau/core/engine/software/nv04.c
index f48da75..3ca4c3a 100644
--- a/drivers/gpu/drm/nouveau/core/engine/software/nv04.c
+++ b/drivers/gpu/drm/nouveau/core/engine/software/nv04.c
@@ -110,6 +110,12 @@ nv04_software_cclass = {
  * software engine/subdev functions
  ******************************************************************************/
 
+void
+nv04_software_intr(struct nouveau_subdev *subdev)
+{
+	nv_mask(subdev, 0x000100, 0x80000000, 0x00000000);
+}
+
 static int
 nv04_software_ctor(struct nouveau_object *parent, struct nouveau_object *engine,
 	      struct nouveau_oclass *oclass, void *data, u32 size,
@@ -125,6 +131,7 @@ nv04_software_ctor(struct nouveau_object *parent, struct nouveau_object *engine,
 
 	nv_engine(priv)->cclass = &nv04_software_cclass;
 	nv_engine(priv)->sclass = nv04_software_sclass;
+	nv_subdev(priv)->intr = nv04_software_intr;
 	return 0;
 }
 
diff --git a/drivers/gpu/drm/nouveau/core/engine/software/nv10.c b/drivers/gpu/drm/nouveau/core/engine/software/nv10.c
index 46dada5..6e699af 100644
--- a/drivers/gpu/drm/nouveau/core/engine/software/nv10.c
+++ b/drivers/gpu/drm/nouveau/core/engine/software/nv10.c
@@ -113,6 +113,7 @@ nv10_software_ctor(struct nouveau_object *parent, struct nouveau_object *engine,
 
 	nv_engine(priv)->cclass = &nv10_software_cclass;
 	nv_engine(priv)->sclass = nv10_software_sclass;
+	nv_subdev(priv)->intr = nv04_software_intr;
 	return 0;
 }
 
diff --git a/drivers/gpu/drm/nouveau/core/engine/software/nv50.c b/drivers/gpu/drm/nouveau/core/engine/software/nv50.c
index 6b88971..a2edcd3 100644
--- a/drivers/gpu/drm/nouveau/core/engine/software/nv50.c
+++ b/drivers/gpu/drm/nouveau/core/engine/software/nv50.c
@@ -183,6 +183,7 @@ nv50_software_ctor(struct nouveau_object *parent, struct nouveau_object *engine,
 
 	nv_engine(priv)->cclass = &nv50_software_cclass;
 	nv_engine(priv)->sclass = nv50_software_sclass;
+	nv_subdev(priv)->intr = nv04_software_intr;
 	return 0;
 }
 
diff --git a/drivers/gpu/drm/nouveau/core/engine/software/nvc0.c b/drivers/gpu/drm/nouveau/core/engine/software/nvc0.c
index e3be78f..b7b0d7e 100644
--- a/drivers/gpu/drm/nouveau/core/engine/software/nvc0.c
+++ b/drivers/gpu/drm/nouveau/core/engine/software/nvc0.c
@@ -165,6 +165,7 @@ nvc0_software_ctor(struct nouveau_object *parent, struct nouveau_object *engine,
 
 	nv_engine(priv)->cclass = &nvc0_software_cclass;
 	nv_engine(priv)->sclass = nvc0_software_sclass;
+	nv_subdev(priv)->intr = nv04_software_intr;
 	return 0;
 }
 
diff --git a/drivers/gpu/drm/nouveau/core/include/engine/software.h b/drivers/gpu/drm/nouveau/core/include/engine/software.h
index 8d74079..c945691 100644
--- a/drivers/gpu/drm/nouveau/core/include/engine/software.h
+++ b/drivers/gpu/drm/nouveau/core/include/engine/software.h
@@ -55,4 +55,6 @@ extern struct nouveau_oclass nv10_software_oclass;
 extern struct nouveau_oclass nv50_software_oclass;
 extern struct nouveau_oclass nvc0_software_oclass;
 
+void nv04_software_intr(struct nouveau_subdev *);
+
 #endif

