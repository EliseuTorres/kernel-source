From 78ee43b68846e1d8a201e722e626a5494422cf55 Mon Sep 17 00:00:00 2001
From: Chris Wilson <chris@chris-wilson.co.uk>
Date: Mon, 6 Dec 2010 14:36:02 +0000
Patch-mainline: 2.6.38
References: fate#310916
Git-commit: 0ac74c6b3386f0413baf48f6d61850650e0dc4ab
Subject: [PATCH 1927/2588] drm/i915: Only emit a flush if there is an
 outstanding gpu write

Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
(cherry picked from commit 0ac74c6b3386f0413baf48f6d61850650e0dc4ab)

Signed-off-by: Takashi Iwai <tiwai@suse.de>
---
 drivers/gpu/drm/i915/i915_gem.c |    5 +++--
 1 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_gem.c b/drivers/gpu/drm/i915/i915_gem.c
index a847b14..24912d5 100644
--- a/drivers/gpu/drm/i915/i915_gem.c
+++ b/drivers/gpu/drm/i915/i915_gem.c
@@ -2172,8 +2172,9 @@ static int i915_ring_idle(struct drm_device *dev,
 	if (list_empty(&ring->gpu_write_list) && list_empty(&ring->active_list))
 		return 0;
 
-	i915_gem_flush_ring(dev, ring,
-			    I915_GEM_GPU_DOMAINS, I915_GEM_GPU_DOMAINS);
+	if (!list_empty(&ring->gpu_write_list))
+		i915_gem_flush_ring(dev, ring,
+				    I915_GEM_GPU_DOMAINS, I915_GEM_GPU_DOMAINS);
 	return i915_wait_request(dev,
 				 i915_gem_next_request_seqno(dev, ring),
 				 ring);
-- 
1.7.6

