From cd8c14b407d59ac4b8d324f5f9cdf223a2079c88 Mon Sep 17 00:00:00 2001
From: Ben Skeggs <bskeggs@redhat.com>
Date: Wed, 5 Sep 2012 12:19:26 +1000
Subject: drm/nvc0/ltcg: read LTS count at startup
Git-commit: cd8c14b407d59ac4b8d324f5f9cdf223a2079c88
Patch-mainline: v3.7-rc3

Not really sure how to confirm this 100%, but, the numbers match on all the
traces I have for NVCx (2 LTS), NVD9 (1LTS) and NVEx (4LTS).

Signed-off-by: Ben Skeggs <bskeggs@redhat.com>
Acked-by: Michal Srb <msrb@suse.com>
---
 drivers/gpu/drm/nouveau/core/subdev/ltcg/nvc0.c |    4 +++-
 1 files changed, 3 insertions(+), 1 deletions(-)

diff --git a/drivers/gpu/drm/nouveau/core/subdev/ltcg/nvc0.c b/drivers/gpu/drm/nouveau/core/subdev/ltcg/nvc0.c
index 7c2840c..078a2b9 100644
--- a/drivers/gpu/drm/nouveau/core/subdev/ltcg/nvc0.c
+++ b/drivers/gpu/drm/nouveau/core/subdev/ltcg/nvc0.c
@@ -26,6 +26,7 @@
 
 struct nvc0_ltcg_priv {
 	struct nouveau_ltcg base;
+	u32 subp_nr;
 };
 
 static void
@@ -49,7 +50,7 @@ nvc0_ltcg_intr(struct nouveau_subdev *subdev)
 	units = nv_rd32(priv, 0x00017c);
 	while (units) {
 		u32 subp, unit = ffs(units) - 1;
-		for (subp = 0; subp < 2; subp++)
+		for (subp = 0; subp < priv->subp_nr; subp++)
 			nvc0_ltcg_subp_isr(priv, unit, subp);
 		units &= ~(1 << unit);
 	}
@@ -73,6 +74,7 @@ nvc0_ltcg_ctor(struct nouveau_object *parent, struct nouveau_object *engine,
 	if (ret)
 		return ret;
 
+	priv->subp_nr = nv_rd32(priv, 0x17e8dc) >> 24;
 	nv_mask(priv, 0x17e820, 0x00100000, 0x00000000); /* INTR_EN &= ~0x10 */
 
 	nv_subdev(priv)->intr = nvc0_ltcg_intr;

