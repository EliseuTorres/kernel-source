From: Takashi Iwai <tiwai@suse.de>
Patch-mainline: never
Subject: mgag200: Kms only for secure boot

Compatibility patch taken from SUSE:SLE-11-SP3:GA/drm.

Acked-by: Michal Srb <msrb@suse.com>
---
 drivers/gpu/drm/mgag200/mgag200_drv.c |    8 ++++++++
 1 file changed, 8 insertions(+)

--- a/drivers/gpu/drm/mgag200/mgag200_drv.c
+++ b/drivers/gpu/drm/mgag200/mgag200_drv.c
@@ -10,6 +10,7 @@
  */
 #include <linux/module.h>
 #include <linux/console.h>
+#include <linux/capability.h>
 #include <drm/drmP.h>
 
 #include "mgag200_drv.h"
@@ -122,6 +123,13 @@ static int __init mgag200_init(void)
 		return -EINVAL;
 #endif
 
+#ifdef CAP_COMPROMISE_KERNEL
+	if (capable(CAP_COMPROMISE_KERNEL) && mgag200_modeset == -1) {
+		printk(KERN_INFO "This driver is only used in secure boot mode as default\n");
+		return -EINVAL;
+	}
+#endif
+
 	if (mgag200_modeset == 0)
 		return -EINVAL;
 	return drm_pci_init(&driver, &mgag200_pci_driver);
