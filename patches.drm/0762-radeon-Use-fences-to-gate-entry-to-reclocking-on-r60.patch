From 9d6e21eda3a4823033c99795074d74dfc66760a8 Mon Sep 17 00:00:00 2001
From: Matthew Garrett <mjg@redhat.com>
Date: Fri, 30 Apr 2010 15:48:23 -0400
Patch-mainline: 2.6.35
References: fate#310916
Git-commit: 01434b4bfba17626fe93a602e540f0004694d9df
Subject: [PATCH 0762/2588] radeon: Use fences to gate entry to reclocking on
 <r600

GUI idle interrupts don't seem to work terribly well on r500 and earlier,
so let's use a fence instead.

Signed-off-by: Matthew Garrett <mjg@redhat.com>
Signed-off-by: Dave Airlie <airlied@redhat.com>
(cherry picked from commit 01434b4bfba17626fe93a602e540f0004694d9df)

Signed-off-by: Takashi Iwai <tiwai@suse.de>
---
 drivers/gpu/drm/radeon/radeon_pm.c |    8 ++++++++
 1 files changed, 8 insertions(+), 0 deletions(-)

diff --git a/drivers/gpu/drm/radeon/radeon_pm.c b/drivers/gpu/drm/radeon/radeon_pm.c
index bded834..1ee7fc9 100644
--- a/drivers/gpu/drm/radeon/radeon_pm.c
+++ b/drivers/gpu/drm/radeon/radeon_pm.c
@@ -76,6 +76,14 @@ static void radeon_pm_set_clocks(struct radeon_device *rdev, int static_switch)
 			msecs_to_jiffies(RADEON_WAIT_IDLE_TIMEOUT));
 		rdev->irq.gui_idle = false;
 		radeon_irq_set(rdev);
+	} else {
+		struct radeon_fence *fence;
+		radeon_ring_alloc(rdev, 64);
+		radeon_fence_create(rdev, &fence);
+		radeon_fence_emit(rdev, fence);
+		radeon_ring_commit(rdev);
+		radeon_fence_wait(fence, false);
+		radeon_fence_unref(&fence);
 	}
 	radeon_unmap_vram_bos(rdev);
 
-- 
1.7.6

