From: Takashi Iwai <tiwai@suse.de>
Subject: drm: Revert shrinker changes for 2.6.32
Patch-mainline: Never
References: fate#310916

Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
 drivers/gpu/drm/i915/i915_dma.c |    5 ++++-
 drivers/gpu/drm/i915/i915_gem.c |   15 ++++++++-------
 2 files changed, 12 insertions(+), 8 deletions(-)

--- a/drivers/gpu/drm/i915/i915_gem.c
+++ b/drivers/gpu/drm/i915/i915_gem.c
@@ -55,10 +55,7 @@
 				struct drm_file *file);
 static void i915_gem_free_object_tail(struct drm_i915_gem_object *obj);
 
-static int i915_gem_inactive_shrink(struct shrinker *shrinker,
-				    int nr_to_scan,
-				    gfp_t gfp_mask);
-
+static int i915_gem_inactive_shrink(int nr_to_scan, gfp_t gfp_mask);
 
 /* some bookkeeping */
 static void i915_gem_info_add_obj(struct drm_i915_private *dev_priv,
@@ -3825,6 +3822,8 @@
 	INIT_LIST_HEAD(&ring->gpu_write_list);
 }
 
+struct shrinker *_i915_registered_shrinker;
+
 void
 i915_gem_load(struct drm_device *dev)
 {
@@ -3877,9 +3876,12 @@
 
 	dev_priv->mm.interruptible = true;
 
+	if (WARN_ON(_i915_registered_shrinker))
+		return;
 	dev_priv->mm.inactive_shrinker.shrink = i915_gem_inactive_shrink;
 	dev_priv->mm.inactive_shrinker.seeks = DEFAULT_SEEKS;
 	register_shrinker(&dev_priv->mm.inactive_shrinker);
+	_i915_registered_shrinker = &dev_priv->mm.inactive_shrinker;
 }
 
 /*
@@ -4102,10 +4104,9 @@
 }
 
 static int
-i915_gem_inactive_shrink(struct shrinker *shrinker,
-			 int nr_to_scan,
-			 gfp_t gfp_mask)
+i915_gem_inactive_shrink(int nr_to_scan, gfp_t gfp_mask)
 {
+	struct shrinker *shrinker = _i915_registered_shrinker;
 	struct drm_i915_private *dev_priv =
 		container_of(shrinker,
 			     struct drm_i915_private,
--- a/drivers/gpu/drm/i915/i915_dma.c
+++ b/drivers/gpu/drm/i915/i915_dma.c
@@ -2085,8 +2085,11 @@
 	i915_mch_dev = NULL;
 	spin_unlock(&mchdev_lock);
 
-	if (dev_priv->mm.inactive_shrinker.shrink)
+	if (dev_priv->mm.inactive_shrinker.shrink) {
+		extern struct shrinker *_i915_registered_shrinker;
 		unregister_shrinker(&dev_priv->mm.inactive_shrinker);
+		_i915_registered_shrinker = NULL;
+	}
 
 	mutex_lock(&dev->struct_mutex);
 	ret = i915_gpu_idle(dev);
