From 28c8eb0ee1b6b88d8427a19be6052dcec865117e Mon Sep 17 00:00:00 2001
From: Chris Wilson <chris@chris-wilson.co.uk>
Date: Sun, 7 Nov 2010 11:50:02 +0000
Patch-mainline: 2.6.38
References: fate#310916
Git-commit: 629e894173c9de589913cf649deaadec4b0579bd
Subject: [PATCH 1844/2588] drm/i915/ringbuffer: Ignore failure to setup the
 ring on Sandybridge

The ring buffer registers return 0 whilst idle (for some values of idle)
on early Sandybridge hw. Persevere even when all appears hopeless...
Fortunately the head auto-reporting prevents most hangs.

Bugzilla: https://bugs.freedesktop.org/show_bug.cgi?id=31370
Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
(cherry picked from commit 629e894173c9de589913cf649deaadec4b0579bd)

Signed-off-by: Takashi Iwai <tiwai@suse.de>
---
 drivers/gpu/drm/i915/intel_ringbuffer.c |   32 +++++++++++++++++++++++-------
 1 files changed, 24 insertions(+), 8 deletions(-)

diff --git a/drivers/gpu/drm/i915/intel_ringbuffer.c b/drivers/gpu/drm/i915/intel_ringbuffer.c
index 2c6f118..fc843b9 100644
--- a/drivers/gpu/drm/i915/intel_ringbuffer.c
+++ b/drivers/gpu/drm/i915/intel_ringbuffer.c
@@ -182,14 +182,30 @@ static int init_ring_common(struct intel_ring_buffer *ring)
 	if ((I915_READ_CTL(ring) & RING_VALID) == 0 ||
 	    I915_READ_START(ring) != obj_priv->gtt_offset ||
 	    (I915_READ_HEAD(ring) & HEAD_ADDR) != 0) {
-		DRM_ERROR("%s initialization failed "
-				"ctl %08x head %08x tail %08x start %08x\n",
-				ring->name,
-				I915_READ_CTL(ring),
-				I915_READ_HEAD(ring),
-				I915_READ_TAIL(ring),
-				I915_READ_START(ring));
-		return -EIO;
+		if (IS_GEN6(ring->dev) && ring->dev->pdev->revision <= 8) {
+			/* Early revisions of Sandybridge do not like
+			 * revealing the contents of the ring buffer
+			 * registers whilst idle. Fortunately, the
+			 * auto-reporting mechanism prevents most hangs,
+			 * but this will bite us eventually...
+			 */
+			DRM_DEBUG("%s initialization failed "
+				  "ctl %08x head %08x tail %08x start %08x. Ignoring, hope for the best!\n",
+				  ring->name,
+				  I915_READ_CTL(ring),
+				  I915_READ_HEAD(ring),
+				  I915_READ_TAIL(ring),
+				  I915_READ_START(ring));
+		} else {
+			DRM_ERROR("%s initialization failed "
+				  "ctl %08x head %08x tail %08x start %08x\n",
+				  ring->name,
+				  I915_READ_CTL(ring),
+				  I915_READ_HEAD(ring),
+				  I915_READ_TAIL(ring),
+				  I915_READ_START(ring));
+			return -EIO;
+		}
 	}
 
 	if (!drm_core_check_feature(ring->dev, DRIVER_MODESET))
-- 
1.7.6

